<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>erlang学习笔记 - Welcome to Rg Home</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<meta name="author" content="Rg" /><meta name="description" content="好久没看过erlang了，趁现在博客的迁移，重温一下。" /><meta name="keywords" content="Rg, Rust, even" />






<meta name="generator" content="Hugo 0.54.0 with even 4.0.0" />


<link rel="canonical" href="https://laohanlinux.github.io/2016/04/25/erlang%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">


<link href="/dist/even.3292c2b1.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">


<meta property="og:title" content="erlang学习笔记" />
<meta property="og:description" content="好久没看过erlang了，趁现在博客的迁移，重温一下。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://laohanlinux.github.io/2016/04/25/erlang%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" />
<meta property="article:published_time" content="2016-04-25T00:15:14&#43;00:00"/>
<meta property="article:modified_time" content="2016-04-25T00:15:14&#43;00:00"/>

<meta itemprop="name" content="erlang学习笔记">
<meta itemprop="description" content="好久没看过erlang了，趁现在博客的迁移，重温一下。">


<meta itemprop="datePublished" content="2016-04-25T00:15:14&#43;00:00" />
<meta itemprop="dateModified" content="2016-04-25T00:15:14&#43;00:00" />
<meta itemprop="wordCount" content="3806">



<meta itemprop="keywords" content="Erlang," />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="erlang学习笔记"/>
<meta name="twitter:description" content="好久没看过erlang了，趁现在博客的迁移，重温一下。"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">Welcome come to Rg Home</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Go ~/</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a>
  </ul>
</nav>
  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">Welcome come to Rg Home</a>
</div>

<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Go ~/</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li>
  </ul>
</nav>
    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">erlang学习笔记</h1>

      <div class="post-meta">
        <span class="post-time"> 2016-04-25 </span>
        <div class="post-category">
            <a href="/categories/erlang/"> Erlang </a>
            </div>
          <span class="more-meta"> 3806 words </span>
          <span class="more-meta"> 8 mins read </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Contents</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
<ul>
<li>
<ul>
<li><a href="#erlang-之简单的-diction-实现"><code>erlang</code> 之简单的<code>Diction</code>实现</a></li>
<li><a href="#erlang-之简单密码加密"><code>erlang</code> 之简单密码加密</a></li>
<li><a href="#erlang-简单的树操作">erlang 简单的树操作</a></li>
<li><a href="#erlang-并发编程">erlang 并发编程</a></li>
<li><a href="#erlang-之-echo-服务器">erlang 之 echo 服务器</a></li>
<li><a href="#timeout-的简单使用">timeout 的简单使用</a></li>
<li><a href="#erlang进程生成测试">Erlang进程生成测试</a></li>
<li><a href="#erlang-之时钟"><code>erlang</code>之时钟</a></li>
<li><a href="#a-simple-erlang-process-pool-analysis">a simple erlang process pool analysis</a></li>
<li><a href="#poolboy">PoolBoy</a></li>
</ul></li>
</ul>
</nav>
  </div>
</div>
    <div class="post-content">
      

<h2 id="erlang-之简单的-diction-实现"><code>erlang</code> 之简单的<code>Diction</code>实现</h2>

<p>最近在看学erlang ，看到了字典这个demo ，把程序Copy出来和大家分享一下</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-erlang" data-lang="erlang">    <span class="p">-</span><span class="ni">module</span> <span class="p">(</span><span class="n">diction</span><span class="p">).</span>  
    <span class="p">-</span><span class="ni">export</span><span class="p">([</span><span class="n">new</span><span class="o">/</span><span class="mi">0</span><span class="p">,</span><span class="n">lookup</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span><span class="n">add</span><span class="o">/</span><span class="mi">3</span><span class="p">,</span><span class="n">delete</span><span class="o">/</span><span class="mi">2</span><span class="p">]).</span>  
    <span class="nf">new</span><span class="p">()</span>   <span class="p">-</span><span class="err">&gt;  
</span><span class="err">        [].  
</span><span class="err">      
</span><span class="err">    </span><span class="ni">lookup</span><span class="p">(</span><span class="nv">Key</span> <span class="p">,</span> <span class="p">[{</span><span class="nv">Key</span><span class="p">,</span><span class="nv">Value</span><span class="p">}|</span><span class="nv">Rest</span><span class="p">])</span>    <span class="p">-</span><span class="err">&gt;  
</span><span class="err">        {</span><span class="ni">value</span><span class="p">,</span><span class="nv">Value</span><span class="p">};</span>  
    <span class="nf">lookup</span><span class="p">(</span><span class="nv">Key</span><span class="p">,[</span><span class="nv">Pair</span><span class="p">|</span><span class="nv">Rest</span><span class="p">])</span>     <span class="p">-</span><span class="err">&gt;  
</span><span class="err">        </span><span class="ni">lookup</span><span class="p">(</span><span class="nv">Key</span><span class="p">,</span><span class="nv">Rest</span><span class="p">);</span>  
    <span class="nf">lookup</span><span class="p">(</span><span class="nv">Key</span><span class="p">,[])</span>  <span class="p">-</span><span class="err">&gt;  
</span><span class="err">        </span><span class="ni">undefined</span><span class="p">.</span>  
    <span class="nf">add</span><span class="p">(</span><span class="nv">Key</span><span class="p">,</span><span class="nv">Value</span><span class="p">,</span><span class="nv">Diction</span><span class="p">)</span>  <span class="p">-</span><span class="err">&gt;  
</span><span class="err">        N</span><span class="ni">ewDict</span> <span class="o">=</span>   <span class="nf">delete</span><span class="p">(</span><span class="nv">Key</span><span class="p">,</span><span class="nv">Diction</span><span class="p">)</span> <span class="p">,</span>  
        <span class="p">[{</span><span class="nv">Key</span><span class="p">,</span><span class="nv">Value</span><span class="p">}|</span><span class="nv">NewDict</span><span class="p">].</span>  
      
    <span class="nf">delete</span><span class="p">(</span><span class="nv">Key</span><span class="p">,[{</span><span class="nv">Key</span><span class="p">,</span><span class="nv">Value</span><span class="p">}|</span><span class="nv">Rest</span><span class="p">])</span>  <span class="p">-</span><span class="err">&gt;  
</span><span class="err">        R</span><span class="ni">est</span><span class="p">;</span>  
    <span class="nf">delete</span><span class="p">(</span><span class="nv">Key</span><span class="p">,[</span><span class="nv">Pair</span><span class="p">|</span><span class="nv">Rest</span><span class="p">])</span> <span class="p">-</span><span class="err">&gt;  
</span><span class="err">        [P</span><span class="ni">air</span><span class="p">|</span><span class="nf">delete</span><span class="p">(</span><span class="nv">Key</span><span class="p">,</span><span class="nv">Rest</span><span class="p">)];</span>  
    <span class="nf">delete</span><span class="p">(</span><span class="nv">Key</span><span class="p">,[])</span>  <span class="p">-</span><span class="err">&gt;  
</span><span class="err">        [].  </span></code></pre></td></tr></table>
</div>
</div>
<p>函数编程习惯之后，写起来也是挺爽的意见事，基本上都是递归的思想。</p>

<h2 id="erlang-之简单密码加密"><code>erlang</code> 之简单密码加密</h2>

<blockquote>
<p>这些程序主要是来之 连城 翻译的一个书里面的代码</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-erlang" data-lang="erlang">    <span class="p">-</span><span class="ni">module</span><span class="p">(</span><span class="n">encode</span><span class="p">).</span>  
    <span class="p">-</span><span class="ni">export</span><span class="p">([</span><span class="n">encode</span><span class="o">/</span><span class="mi">2</span><span class="p">]).</span>  
    <span class="nf">encode</span><span class="p">(</span><span class="nv">Pin</span><span class="p">.</span><span class="nv">Password</span><span class="p">)</span>    <span class="p">-</span><span class="err">&gt;  
</span><span class="err">        C</span><span class="ni">ode</span> <span class="o">=</span> <span class="p">{</span><span class="n">nil</span><span class="p">,</span><span class="n">nil</span><span class="p">,</span><span class="n">nil</span><span class="p">,</span><span class="n">nil</span><span class="p">,</span><span class="n">nil</span><span class="p">,</span><span class="n">nil</span><span class="p">,</span><span class="n">nil</span><span class="p">,</span><span class="n">nil</span><span class="p">,</span><span class="n">nil</span><span class="p">,</span>  
            <span class="n">nil</span><span class="p">,</span><span class="n">nil</span><span class="p">,</span><span class="n">nil</span><span class="p">,</span><span class="n">nil</span><span class="p">,</span><span class="n">nil</span><span class="p">,</span><span class="n">nil</span><span class="p">,</span><span class="n">nil</span><span class="p">,</span><span class="n">nil</span><span class="p">,</span><span class="n">nil</span><span class="p">,</span>  
            <span class="n">nil</span><span class="p">,</span><span class="n">nil</span><span class="p">,</span><span class="n">nil</span><span class="p">,</span><span class="n">nil</span><span class="p">,</span><span class="n">nil</span><span class="p">,</span><span class="n">nil</span><span class="p">,</span><span class="n">nil</span><span class="p">,</span><span class="n">nil</span><span class="p">},</span>  
        <span class="nf">encode</span><span class="p">(</span><span class="nv">Pin</span><span class="p">,</span><span class="nv">Password</span><span class="p">,</span><span class="nv">Code</span><span class="p">).</span>  
    <span class="nf">encode</span><span class="p">([],_,</span><span class="nv">Code</span><span class="p">)</span>   <span class="p">-</span><span class="err">&gt;  
</span><span class="err">        C</span><span class="ni">ode</span> <span class="p">;</span>  
    <span class="nf">encode</span><span class="p">(</span><span class="nv">Pin</span><span class="p">,[],</span><span class="n">code</span><span class="p">)</span> <span class="p">-</span><span class="err">&gt;  
</span><span class="err">        </span><span class="ni">io</span><span class="p">:</span><span class="nf">format</span><span class="p">(</span><span class="s">&#34;Out of Letters</span><span class="si">~n</span><span class="s">&#34;</span><span class="p">,[]);</span>  
      
    <span class="nf">encode</span><span class="p">(</span><span class="nv">H</span><span class="p">|</span><span class="nv">T</span><span class="p">,[</span><span class="nv">Letter</span><span class="p">|</span><span class="nv">T1</span><span class="p">],</span><span class="nv">Code</span><span class="p">)</span>    <span class="p">-</span><span class="err">&gt;  
</span><span class="err">        A</span><span class="ni">rg</span> <span class="o">=</span> <span class="nf">index</span><span class="p">(</span><span class="nv">Letter</span><span class="p">)</span> <span class="o">+</span><span class="mi">1</span> <span class="p">,</span>  
        <span class="k">case</span> <span class="nb">element</span><span class="p">(</span><span class="nv">Arg</span><span class="p">,</span><span class="nv">Code</span><span class="p">)</span> <span class="k">of</span>   
            <span class="n">nil</span> <span class="p">-</span><span class="err">&gt;  
</span><span class="err">                </span><span class="ni">encode</span> <span class="p">(</span><span class="nv">T</span><span class="p">,</span><span class="nv">T1</span><span class="p">,</span><span class="nb">setelement</span><span class="p">(</span><span class="nv">Arg</span><span class="p">,</span><span class="nv">Code</span><span class="p">,</span><span class="nf">index</span><span class="p">(</span><span class="nv">H</span><span class="p">)));</span>  
        <span class="p">_-</span><span class="err">&gt;  
</span><span class="err">            </span><span class="ni">encode</span> <span class="p">([</span><span class="nv">H</span><span class="p">|</span><span class="nv">T</span><span class="p">],</span><span class="nv">T1</span><span class="p">,</span><span class="nv">Code</span><span class="p">)</span>  
        <span class="k">end</span><span class="p">.</span>  
      
    <span class="nf">index</span><span class="p">(</span><span class="nv">X</span><span class="p">)</span>    <span class="k">when</span> <span class="nv">X</span> <span class="o">&gt;=</span> <span class="sc">$0</span> <span class="p">,</span><span class="nv">X</span> <span class="o">=&lt;</span> <span class="sc">$9</span> <span class="p">-</span><span class="err">&gt;  
</span><span class="err">            X - $0;  
</span><span class="err">    </span><span class="ni">index</span><span class="p">(</span><span class="nv">X</span><span class="p">)</span>    <span class="k">when</span> <span class="nv">X</span><span class="o">&gt;=</span><span class="sc">$A</span> <span class="p">,</span> <span class="nv">X</span> <span class="o">=&lt;</span> <span class="sc">$Z</span>  <span class="p">-</span><span class="err">&gt;  
</span><span class="err">            X - $A.  </span></code></pre></td></tr></table>
</div>
</div>
<h2 id="erlang-简单的树操作">erlang 简单的树操作</h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="p">-</span><span class="ni">module</span><span class="p">(</span><span class="n">tree</span><span class="p">).</span>  
<span class="p">-</span><span class="ni">export</span><span class="p">([</span><span class="n">test1</span><span class="o">/</span><span class="mi">0</span><span class="p">]).</span>  
<span class="nf">lookup</span><span class="p">(</span><span class="nv">Key</span><span class="p">,</span><span class="n">nil</span><span class="p">)</span> <span class="p">-</span><span class="err">&gt;  
</span><span class="err">    </span><span class="ni">not_found</span><span class="p">;</span>  
<span class="nf">lookup</span><span class="p">(</span><span class="nv">Key</span><span class="p">,{</span><span class="nv">Key</span><span class="p">,</span><span class="nv">Value</span><span class="p">,_,_})</span> <span class="p">-</span><span class="err">&gt;  
</span><span class="err">    {</span><span class="ni">found</span><span class="p">,</span><span class="nv">Value</span><span class="p">};</span>  
<span class="nf">lookup</span><span class="p">(</span><span class="nv">Key</span><span class="p">,{</span><span class="nv">Key1</span><span class="p">,_,</span><span class="nv">Smaller</span><span class="p">,_})</span> <span class="k">when</span> <span class="nv">Key</span> <span class="o">&lt;</span> <span class="nv">Key1</span>   <span class="p">-</span><span class="err">&gt;  
</span><span class="err">    </span><span class="ni">lookup</span><span class="p">(</span><span class="nv">Key</span><span class="p">,</span><span class="nv">Smaller</span><span class="p">);</span>  
<span class="nf">lookup</span><span class="p">(</span><span class="nv">Key</span><span class="p">,{</span><span class="nv">Key1</span><span class="p">,_,_,</span><span class="nv">Bigger</span><span class="p">})</span>   <span class="k">when</span> <span class="nv">Key</span> <span class="o">&gt;</span> <span class="nv">Key1</span> <span class="p">-</span><span class="err">&gt;  
</span><span class="err">    </span><span class="ni">lookup</span><span class="p">(</span><span class="nv">Key</span><span class="p">,</span><span class="nv">Bigger</span><span class="p">).</span>  
  
<span class="nf">insert</span><span class="p">(</span><span class="nv">Key</span><span class="p">,</span><span class="nv">Value</span> <span class="p">,</span><span class="n">nil</span><span class="p">)</span>  <span class="p">-</span><span class="err">&gt;  
</span><span class="err">    {K</span><span class="ni">ey</span><span class="p">,</span><span class="nv">Value</span><span class="p">,</span><span class="n">nil</span><span class="p">,</span><span class="n">nil</span><span class="p">};</span>  
<span class="nf">insert</span><span class="p">(</span><span class="nv">Key</span><span class="p">,</span><span class="nv">Value</span><span class="p">,{</span><span class="nv">Key</span><span class="p">,_,</span><span class="nv">Smaller</span><span class="p">,</span><span class="nv">Bigger</span><span class="p">})</span>    <span class="p">-</span><span class="err">&gt;  
</span><span class="err">    {K</span><span class="ni">ey</span><span class="p">,</span><span class="nv">Value</span><span class="p">,</span><span class="nv">Smaller</span><span class="p">,</span><span class="nv">Bigger</span><span class="p">}</span>  <span class="p">;</span>  
<span class="nf">insert</span><span class="p">(</span><span class="nv">Key</span><span class="p">,</span><span class="nv">Value</span><span class="p">,{</span><span class="nv">Key1</span><span class="p">,</span><span class="nv">V</span><span class="p">,</span><span class="nv">Smaller</span><span class="p">,</span><span class="nv">Bigger</span><span class="p">})</span>   <span class="k">when</span> <span class="nv">Key</span> <span class="o">&lt;</span> <span class="nv">Key1</span> <span class="p">-</span><span class="err">&gt;  
</span><span class="err">    {K</span><span class="ni">ey1</span><span class="p">,</span><span class="nv">V</span><span class="p">,</span><span class="nf">insert</span><span class="p">(</span><span class="nv">Key</span><span class="p">,</span><span class="nv">Value</span><span class="p">,</span><span class="nv">Smaller</span><span class="p">),</span><span class="nv">Bigger</span><span class="p">};</span>  
<span class="nf">insert</span><span class="p">(</span><span class="nv">Key</span><span class="p">,</span><span class="nv">Value</span><span class="p">,{</span><span class="nv">Key1</span><span class="p">,</span><span class="nv">V</span><span class="p">,</span><span class="nv">Smaller</span><span class="p">,</span><span class="nv">Bigger</span><span class="p">})</span>   <span class="k">when</span> <span class="nv">Key</span> <span class="o">&gt;</span> <span class="nv">Key1</span>  <span class="p">-</span><span class="err">&gt;  
</span><span class="err">    {K</span><span class="ni">ey1</span><span class="p">,</span><span class="nv">V</span><span class="p">,</span><span class="nv">Smaller</span><span class="p">,</span><span class="nf">insert</span><span class="p">(</span><span class="nv">Key</span><span class="p">,</span><span class="nv">Value</span><span class="p">,</span><span class="nv">Bigger</span><span class="p">)}.</span>  
<span class="nf">write_tree</span><span class="p">(</span><span class="nv">T</span><span class="p">)</span>   <span class="p">-</span><span class="err">&gt;  
</span><span class="err">    </span><span class="ni">write_tree</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nv">T</span><span class="p">).</span>  
<span class="nf">write_tree</span><span class="p">(</span><span class="nv">D</span><span class="p">,</span><span class="n">nil</span><span class="p">)</span>   <span class="p">-</span><span class="err">&gt;  
</span><span class="err">    </span><span class="ni">io</span><span class="p">:</span><span class="nf">tab</span><span class="p">(</span><span class="nv">D</span><span class="p">),</span>  
    <span class="nn">io</span><span class="p">:</span><span class="nf">format</span><span class="p">(</span><span class="n">&#39;nil&#39;</span><span class="p">,[]);</span>  
<span class="nf">write_tree</span><span class="p">(</span><span class="nv">D</span><span class="p">,{</span><span class="nv">Key</span><span class="p">,</span><span class="nv">Value</span><span class="p">,</span><span class="nv">Smaller</span><span class="p">,</span><span class="nv">Bigger</span><span class="p">})</span>    <span class="p">-</span><span class="err">&gt;  
</span><span class="err">    D1 = D +4 ,  
</span><span class="err">    </span><span class="ni">write_tree</span><span class="p">(</span><span class="nv">D1</span><span class="p">,</span><span class="nv">Bigger</span><span class="p">),</span>  
    <span class="nn">io</span><span class="p">:</span><span class="nf">format</span><span class="p">(</span><span class="n">&#39;~n&#39;</span><span class="p">,[]),</span>  
    <span class="nn">io</span><span class="p">:</span><span class="nf">tab</span><span class="p">(</span><span class="nv">D</span><span class="p">),</span>  
    <span class="nn">io</span><span class="p">:</span><span class="nf">format</span><span class="p">(</span><span class="n">&#39;~w ==&gt; ~w~n&#39;</span><span class="p">,[</span><span class="nv">Key</span><span class="p">,</span><span class="nv">Value</span><span class="p">]),</span>  
    <span class="nf">write_tree</span><span class="p">(</span><span class="nv">D1</span><span class="p">,</span><span class="nv">Smaller</span><span class="p">).</span>  
  
<span class="nf">test1</span><span class="p">()</span> <span class="p">-</span><span class="err">&gt;  
</span><span class="err">    S1=</span><span class="ni">nil</span><span class="p">,</span>  
    <span class="nv">S2</span><span class="o">=</span><span class="nf">insert</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="n">joe</span><span class="p">,</span><span class="nv">S1</span><span class="p">),</span>  
    <span class="nv">S3</span><span class="o">=</span><span class="nf">insert</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span><span class="n">fred</span><span class="p">,</span><span class="nv">S2</span><span class="p">),</span>  
    <span class="nv">S4</span><span class="o">=</span><span class="nf">insert</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="n">jane</span><span class="p">,</span><span class="nv">S3</span><span class="p">),</span>  
    <span class="nv">S5</span><span class="o">=</span><span class="nf">insert</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span><span class="n">kalle</span><span class="p">,</span><span class="nv">S4</span><span class="p">),</span>  
    <span class="nv">S6</span><span class="o">=</span><span class="nf">insert</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="n">thomes</span><span class="p">,</span><span class="nv">S5</span><span class="p">),</span>  
    <span class="nv">S7</span><span class="o">=</span><span class="nf">insert</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="n">rickard</span><span class="p">,</span><span class="nv">S6</span><span class="p">),</span>  
    <span class="nv">S8</span><span class="o">=</span><span class="nf">insert</span><span class="p">(</span><span class="mi">9</span><span class="p">,</span><span class="n">susan</span><span class="p">,</span><span class="nv">S7</span><span class="p">),</span>  
    <span class="nv">S9</span><span class="o">=</span><span class="nf">insert</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="n">tobbe</span><span class="p">,</span><span class="nv">S8</span><span class="p">),</span>  
    <span class="nv">S10</span><span class="o">=</span><span class="nf">insert</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="n">dan</span><span class="p">,</span><span class="nv">S9</span><span class="p">),</span>  
    <span class="nf">write_tree</span><span class="p">(</span><span class="nv">S10</span><span class="p">).</span>  </code></pre></td></tr></table>
</div>
</div>
<p>代码不多，<code>erlang</code>写算法&hellip;&hellip;呵呵呵呵呵呵</p>

<h2 id="erlang-并发编程">erlang 并发编程</h2>

<p>最近上班比较忙，没时间学习erlang ，实在对不起自己啊，以前一直在找erlang相关的教程，终于找到一个了，这个网站是前几天才开始运行的，以后的文章可能都是来自于那里，网站是<code>http://www.erlang-cn.com</code> ，大家忙没事多学习！大笑</p>

<ul>
<li>并发编程一</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="p">-</span><span class="ni">module</span><span class="p">(</span><span class="n">tut15</span><span class="p">).</span>  
<span class="p">-</span><span class="ni">export</span><span class="p">([</span><span class="n">start</span><span class="o">/</span><span class="mi">0</span><span class="p">,</span><span class="n">ping</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span><span class="n">pong</span><span class="o">/</span><span class="mi">0</span><span class="p">]).</span>  
<span class="nf">ping</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nv">Pong_PID</span><span class="p">)</span>    <span class="p">-</span><span class="err">&gt;  
</span><span class="err">    %%想对方发送退出信号  
</span><span class="err">    P</span><span class="ni">ong_PID</span> <span class="o">!</span> <span class="n">finished</span><span class="p">,</span>  
    <span class="nn">io</span><span class="p">:</span><span class="nf">format</span><span class="p">(</span><span class="s">&#34;ping finished</span><span class="si">~n</span><span class="s">&#34;</span><span class="p">,</span><span class="nv">Pong_PID</span><span class="p">);</span>  
<span class="nf">ping</span><span class="p">(</span><span class="nv">N</span><span class="p">,</span><span class="nv">Pong_PID</span><span class="p">)</span>    <span class="p">-</span><span class="err">&gt;  
</span><span class="err">    P</span><span class="ni">ong_PID</span> <span class="o">!</span> <span class="p">{</span><span class="n">ping</span><span class="p">,</span><span class="nf">self</span><span class="p">()},</span>  
    <span class="k">receive</span>   
        <span class="n">pong</span>    <span class="p">-</span><span class="err">&gt;  
</span><span class="err">            </span><span class="ni">io</span><span class="p">:</span><span class="nf">format</span><span class="p">(</span><span class="s">&#34;Ping receive pong </span><span class="si">~n</span><span class="s">&#34;</span><span class="p">,[])</span>  
    <span class="k">end</span><span class="p">,</span>  
    <span class="c">%%继续接受信息，直到 N == 0  
</span><span class="c"></span>    <span class="nf">ping</span><span class="p">(</span><span class="nv">N</span><span class="p">-</span><span class="err">1,P</span><span class="ni">ong_PID</span><span class="p">).</span>  
  
<span class="nf">pong</span><span class="p">()</span>  <span class="p">-</span><span class="err">&gt;  
</span><span class="err">    </span><span class="ni">receive</span>  
        <span class="n">finished</span>    <span class="p">-</span><span class="err">&gt;  
</span><span class="err">            </span><span class="ni">io</span><span class="p">:</span><span class="nf">format</span><span class="p">(</span><span class="s">&#34;Pong finished</span><span class="si">~n</span><span class="s">&#34;</span><span class="p">,[]);</span>  
        <span class="p">{</span><span class="n">ping</span><span class="p">,</span><span class="nv">Ping_PID</span><span class="p">}</span> <span class="p">-</span><span class="err">&gt;  
</span><span class="err">            </span><span class="ni">io</span><span class="p">:</span><span class="nf">format</span><span class="p">(</span><span class="s">&#34;Pong received ping </span><span class="si">~n</span><span class="s">&#34;</span><span class="p">,[]),</span>  
            <span class="nv">Ping_PID</span><span class="o">!</span><span class="n">pong</span><span class="p">,</span>  
            <span class="c">%%再次等待对方的信息，直到信息为ffinished  
</span><span class="c"></span>            <span class="nf">pong</span><span class="p">()</span>  
        <span class="k">end</span><span class="p">.</span>  
<span class="nf">start</span><span class="p">()</span> <span class="p">-</span><span class="err">&gt;  
</span><span class="err">    %% 开启一个进程，用来等待其他进程的信息  
</span><span class="err">    P</span><span class="ni">ong_PID</span> <span class="o">=</span> <span class="nb">spawn</span><span class="p">(</span><span class="n">tut15</span><span class="p">,</span><span class="n">pong</span><span class="p">,[]),</span>  
    <span class="c">%%开启一个进程，用来发送信息  
</span><span class="c"></span>    <span class="nb">spawn</span><span class="p">(</span><span class="n">tut15</span><span class="p">,</span><span class="n">ping</span><span class="p">,[</span><span class="mi">3</span><span class="p">,</span><span class="nv">Pong_PID</span><span class="p">]),</span>  
    <span class="nn">io</span><span class="p">:</span><span class="nf">format</span><span class="p">(</span><span class="s">&#34;Main Process Exit</span><span class="si">~n</span><span class="s">&#34;</span><span class="p">,[]).</span> </code></pre></td></tr></table>
</div>
</div>
<p>进程的标识 ，我们还有一种更加灵活的方法来标记她那就是使用<code>register</code>函数</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="p">-</span><span class="ni">module</span><span class="p">(</span><span class="n">tut16</span><span class="p">).</span>  
<span class="p">-</span><span class="ni">export</span><span class="p">([</span><span class="n">start</span><span class="o">/</span><span class="mi">0</span><span class="p">,</span><span class="n">ping</span><span class="o">/</span><span class="mi">1</span><span class="p">,</span><span class="n">pong</span><span class="o">/</span><span class="mi">0</span><span class="p">]).</span>  
  
<span class="nf">ping</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="p">-</span><span class="err">&gt;  
</span><span class="err">    </span><span class="ni">pong</span> <span class="o">!</span> <span class="n">finished</span><span class="p">,</span>  
    <span class="nn">io</span><span class="p">:</span><span class="nf">format</span><span class="p">(</span><span class="s">&#34;ping finished </span><span class="si">~n</span><span class="s">&#34;</span><span class="p">,[]);</span>  
<span class="nf">ping</span><span class="p">(</span><span class="nv">N</span><span class="p">)</span> <span class="p">-</span><span class="err">&gt;  
</span><span class="err">    %% </span><span class="ni">send</span> <span class="n">the</span> <span class="n">message</span> <span class="n">to</span> <span class="n">pong</span> <span class="n">proccess</span>  
    <span class="n">pong</span> <span class="o">!</span> <span class="p">{</span><span class="n">ping</span><span class="p">,</span><span class="nf">self</span><span class="p">()},</span>  
  
    <span class="k">receive</span>   
        <span class="n">pong</span> <span class="p">-</span><span class="err">&gt;  
</span><span class="err">            </span><span class="ni">io</span><span class="p">:</span><span class="nf">format</span><span class="p">(</span><span class="s">&#34;Ping received pong </span><span class="si">~n</span><span class="s">&#34;</span><span class="p">,[])</span>  
    <span class="k">end</span> <span class="p">,</span>  
    <span class="nf">ping</span><span class="p">(</span><span class="nv">N</span><span class="p">-</span><span class="err">1).  
</span><span class="err">  
</span><span class="err"></span><span class="ni">pong</span><span class="p">()</span>  <span class="p">-</span><span class="err">&gt;  
</span><span class="err">    </span><span class="ni">receive</span>   
        <span class="n">finished</span>    <span class="p">-</span><span class="err">&gt;  
</span><span class="err">            </span><span class="ni">io</span><span class="p">:</span><span class="nf">format</span><span class="p">(</span><span class="s">&#34;Pong finished</span><span class="si">~n</span><span class="s">&#34;</span><span class="p">,[]);</span>  
        <span class="p">{</span><span class="n">ping</span><span class="p">,</span><span class="nv">Ping_PID</span><span class="p">}</span> <span class="p">-</span><span class="err">&gt;  
</span><span class="err">            </span><span class="ni">io</span><span class="p">:</span><span class="nf">format</span><span class="p">(</span><span class="s">&#34;Pong received ping</span><span class="si">~n</span><span class="s">&#34;</span><span class="p">,[]),</span>  
            <span class="nv">Ping_PID</span> <span class="o">!</span> <span class="n">pong</span><span class="p">,</span>  
            <span class="nf">pong</span><span class="p">()</span>  
    <span class="k">end</span><span class="p">.</span>  
  
<span class="nf">start</span><span class="p">()</span> <span class="p">-</span><span class="err">&gt;  
</span><span class="err">    </span><span class="ni">register</span><span class="p">(</span><span class="n">pong</span><span class="p">,</span><span class="nb">spawn</span><span class="p">(</span><span class="n">tut16</span><span class="p">,</span><span class="n">pong</span><span class="p">,[])),</span>  
    <span class="nb">spawn</span><span class="p">(</span><span class="n">tut16</span><span class="p">,</span><span class="n">ping</span><span class="p">,[</span><span class="mi">3</span><span class="p">]).</span>  </code></pre></td></tr></table>
</div>
</div>
<p><code>register</code>中的<code>pong</code>就标识了<code>spawn(tut16,pong,[])</code>这个进程，这个<code>ping（）</code>函数只要一个<code>N</code>就行了，<code>pong</code>可以看作是进程之间共享的变量.</p>

<h2 id="erlang-之-echo-服务器">erlang 之 echo 服务器</h2>

<p>简单实现了一个echo 服务器</p>

<ul>
<li>echo_server1</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-erlang" data-lang="erlang">    <span class="p">-</span><span class="ni">module</span><span class="p">(</span><span class="n">echo</span><span class="p">).</span>  
    <span class="p">-</span><span class="ni">export</span><span class="p">([</span><span class="n">start</span><span class="o">/</span><span class="mi">0</span><span class="p">,</span><span class="n">loop</span><span class="o">/</span><span class="mi">0</span><span class="p">]).</span>  
      
    <span class="nf">start</span><span class="p">()</span> <span class="p">-</span><span class="err">&gt;  
</span><span class="err">        P</span><span class="ni">id</span> <span class="o">=</span> <span class="nb">spawn</span><span class="p">(</span><span class="n">echo</span><span class="p">,</span><span class="n">loop</span><span class="p">,[]),</span>  
        <span class="nv">Pid</span> <span class="o">!</span> <span class="p">{</span><span class="nf">self</span><span class="p">(),</span><span class="n">&#39;Hello Word&#39;</span><span class="p">},</span>  
        <span class="k">receive</span>   
            <span class="p">{</span><span class="nv">Pid</span><span class="p">,</span><span class="nv">Msg</span><span class="p">}</span>   <span class="p">-</span><span class="err">&gt;  
</span><span class="err">                </span><span class="ni">io</span><span class="p">:</span><span class="nf">format</span><span class="p">(</span><span class="n">&#39;~w~n&#39;</span><span class="p">,[</span><span class="nv">Msg</span><span class="p">])</span>  
        <span class="k">end</span><span class="p">,</span>  
        <span class="nv">Pid</span> <span class="o">!</span> <span class="n">stop</span><span class="p">.</span>  
      
    <span class="nf">loop</span><span class="p">()</span>  <span class="p">-</span><span class="err">&gt;  
</span><span class="err">        </span><span class="ni">receive</span>   
            <span class="p">{</span><span class="nv">FromOther</span><span class="p">,</span><span class="nv">Msg</span><span class="p">}</span> <span class="p">-</span><span class="err">&gt;  
</span><span class="err">                </span><span class="ni">io</span><span class="p">:</span><span class="nf">format</span><span class="p">(</span><span class="s">&#34;</span><span class="si">~w~n</span><span class="s">&#34;</span><span class="p">,[</span><span class="nv">Msg</span><span class="p">]),</span>  
                <span class="nv">FromOther</span><span class="o">!</span><span class="p">{</span><span class="nf">self</span><span class="p">(),</span><span class="n">&#39;Loop Proccess Send to You !&#39;</span><span class="p">},</span>  
                <span class="nf">loop</span><span class="p">();</span>  
            <span class="p">{</span><span class="n">stop</span><span class="p">}</span>  <span class="p">-</span><span class="err">&gt;  
</span><span class="err">                %%</span><span class="ni">io</span><span class="p">:</span><span class="nf">format</span><span class="p">(</span><span class="n">&#39;~w~n&#39;</span><span class="p">,[</span><span class="n">loop_stop</span><span class="p">]),</span>  
                <span class="n">true</span>  
        <span class="k">end</span><span class="p">.</span>  </code></pre></td></tr></table>
</div>
</div>
<p>Output：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="mi">29</span><span class="o">&gt;</span> <span class="nn">echo</span><span class="p">:</span><span class="nf">start</span><span class="p">().</span>  
<span class="n">&#39;Hello Word&#39;</span>  
<span class="n">&#39;Loop Proccess Send to You !&#39;</span>  
<span class="n">stop</span>  
<span class="mi">30</span><span class="o">&gt;</span> </code></pre></td></tr></table>
</div>
</div>
<p>其中 stop 是主进程的返回值</p>

<ul>
<li>echo_server2</li>
</ul>

<p>这是一个简单用于等待外部信息的echo server</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-erlang" data-lang="erlang">    <span class="p">-</span><span class="ni">module</span><span class="p">(</span><span class="n">echo_server</span><span class="p">).</span>  
    <span class="p">-</span><span class="ni">export</span><span class="p">([</span><span class="n">start</span><span class="o">/</span><span class="mi">0</span><span class="p">,</span><span class="n">print</span><span class="o">/</span><span class="mi">1</span><span class="p">,</span><span class="n">stop</span><span class="o">/</span><span class="mi">0</span><span class="p">,</span><span class="n">loop</span><span class="o">/</span><span class="mi">0</span><span class="p">]).</span>  
      
    <span class="nf">start</span><span class="p">()</span> <span class="p">-</span><span class="err">&gt;  
</span><span class="err">        P</span><span class="ni">id</span> <span class="o">=</span> <span class="nb">spawn</span><span class="p">(</span><span class="n">echo_server</span> <span class="p">,</span> <span class="n">loop</span> <span class="p">,</span> <span class="p">[]),</span>  
        <span class="nb">register</span><span class="p">(</span><span class="n">sub1</span><span class="p">,</span><span class="nv">Pid</span><span class="p">),</span>   
        <span class="p">{</span><span class="n">ok</span><span class="p">,</span><span class="nv">Pid</span><span class="p">}.</span>  
      
    <span class="nf">loop</span><span class="p">()</span>  <span class="p">-</span><span class="err">&gt;  
</span><span class="err">        </span><span class="ni">receive</span>   
            <span class="p">{</span><span class="n">print</span><span class="p">,</span><span class="nv">A</span><span class="p">}</span>   <span class="p">-</span><span class="err">&gt;  
</span><span class="err">                </span><span class="ni">io</span><span class="p">:</span><span class="nf">format</span><span class="p">(</span><span class="s">&#34;</span><span class="si">~p</span><span class="s">.</span><span class="si">~n</span><span class="s">&#34;</span><span class="p">,[</span><span class="nv">A</span><span class="p">]),</span>  
                <span class="nf">loop</span><span class="p">();</span>  
            <span class="n">stop</span>    <span class="p">-</span><span class="err">&gt;  
</span><span class="err">                </span><span class="ni">true</span><span class="p">;</span>  
            <span class="nv">Other</span> <span class="p">-</span><span class="err">&gt;  
</span><span class="err">                </span><span class="ni">io</span><span class="p">:</span><span class="nf">format</span><span class="p">(</span><span class="s">&#34;</span><span class="si">~p~n</span><span class="s">&#34;</span><span class="p">,[</span><span class="nv">Other</span><span class="p">]),</span>  
                <span class="nf">loop</span><span class="p">()</span>   
        <span class="k">end</span><span class="p">.</span>  
      
    <span class="nf">print</span><span class="p">(</span><span class="nv">A</span><span class="p">)</span>    <span class="p">-</span><span class="err">&gt;  
</span><span class="err">        </span><span class="ni">sub1</span> <span class="o">!</span> <span class="p">{</span><span class="n">print</span><span class="p">,</span><span class="nv">A</span><span class="p">},</span>  
        <span class="n">true</span> <span class="p">.</span>  
    <span class="nf">stop</span><span class="p">()</span>  <span class="p">-</span><span class="err">&gt;  
</span><span class="err">        </span><span class="ni">sub1</span> <span class="o">!</span> <span class="n">stop</span> <span class="p">,</span>  
        <span class="c">%%   
</span><span class="c"></span>        <span class="n">true</span> <span class="p">.</span>  </code></pre></td></tr></table>
</div>
</div>
<h2 id="timeout-的简单使用">timeout 的简单使用</h2>

<p><strong>今天晚上有点晚了，不过还是坚持每一天写一个程序！</strong></p>

<p>下面的时超时器 ：</p>

<p>建设<code>A</code>要想<code>db</code>进程发送一个信息，然后在规定的时间内等待消息的返回，那么<code>A</code>可以设置一个超时器，注意的是在发送消息之前，得先清空消息队列，要不然等译接到的消息可能<code>db</code>还没发送之前的了.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-erlang" data-lang="erlang">    <span class="nf">read</span><span class="p">(</span><span class="nv">Key</span><span class="p">)</span>   <span class="p">-</span><span class="err">&gt;  
</span><span class="err">        </span><span class="ni">flush</span><span class="p">(),</span>  
        <span class="n">db</span> <span class="p">|</span> <span class="p">{</span><span class="nf">self</span><span class="p">(),{</span><span class="n">read</span><span class="p">,</span><span class="nv">Key</span><span class="p">}},</span>  
        <span class="k">receive</span>   
            <span class="p">{</span><span class="n">read</span><span class="p">,</span><span class="nv">R</span><span class="p">}</span>    <span class="p">-</span><span class="err">&gt; {</span><span class="ni">ok</span><span class="p">,</span><span class="nv">R</span><span class="p">};</span>  
            <span class="p">{</span><span class="n">error</span><span class="p">,</span><span class="nv">Reason</span><span class="p">}</span>  <span class="p">-</span><span class="err">&gt; {</span><span class="ni">error</span><span class="p">,</span><span class="nv">Reason</span><span class="p">}</span>  
        <span class="k">after</span> <span class="mi">1000</span>  <span class="p">-</span><span class="err">&gt;   {</span><span class="ni">error</span><span class="p">,</span><span class="n">timeout</span><span class="p">}</span>  
        <span class="k">end</span><span class="p">.</span>  
      
    <span class="nf">flush</span><span class="p">()</span> <span class="p">-</span><span class="err">&gt;  
</span><span class="err">        </span><span class="ni">receive</span>   
            <span class="p">{</span><span class="n">read</span><span class="p">,_}</span>    <span class="p">-</span><span class="err">&gt; </span><span class="ni">flush</span><span class="p">();</span>  
            <span class="p">{</span><span class="n">error</span><span class="p">,_}</span>   <span class="p">-</span><span class="err">&gt;</span><span class="ni">flush</span><span class="p">()</span>  
        <span class="k">after</span> <span class="mi">0</span> <span class="p">-</span><span class="err">&gt;</span><span class="ni">ok</span>   
    <span class="k">end</span><span class="p">.</span>  </code></pre></td></tr></table>
</div>
</div>
<h2 id="erlang进程生成测试">Erlang进程生成测试</h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-erlang" data-lang="erlang">    <span class="p">-</span><span class="ni">module</span><span class="p">(</span><span class="n">myring</span><span class="p">).</span>  
    <span class="p">-</span><span class="ni">export</span><span class="p">([</span><span class="n">start</span><span class="o">/</span><span class="mi">1</span><span class="p">,</span><span class="n">start_proc</span><span class="o">/</span><span class="mi">2</span><span class="p">]).</span>  
    <span class="nf">start</span><span class="p">(</span><span class="nv">Num</span><span class="p">)</span>  <span class="p">-</span><span class="err">&gt;  
</span><span class="err">        </span><span class="ni">start_proc</span><span class="p">(</span><span class="nv">Num</span><span class="p">,</span><span class="nf">self</span><span class="p">()).</span>  
    <span class="nf">start_proc</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nv">Pid</span><span class="p">)</span>   <span class="p">-</span><span class="err">&gt;  
</span><span class="err">        </span><span class="ni">receive</span>   
            <span class="n">ok</span> <span class="p">-</span><span class="err">&gt; </span><span class="ni">ok</span>   
        <span class="k">end</span><span class="p">,</span>  
        <span class="nv">Pid</span> <span class="o">!</span> <span class="n">ok</span> <span class="p">;</span>  
    <span class="nf">start_proc</span><span class="p">(</span><span class="nv">Num</span><span class="p">,</span><span class="nv">Pid</span><span class="p">)</span> <span class="p">-</span><span class="err">&gt;  
</span><span class="err">        NP</span><span class="ni">id</span> <span class="o">=</span> <span class="nb">spawn</span><span class="p">(</span><span class="o">?</span><span class="nv">MODULE</span><span class="p">,</span><span class="n">start_proc</span> <span class="p">,[</span><span class="nv">Num</span><span class="p">-</span><span class="err">1,P</span><span class="ni">id</span><span class="p">]),</span>  
        <span class="nv">NPid</span> <span class="o">!</span> <span class="n">ok</span> <span class="p">,</span>  
        <span class="k">receive</span>   
            <span class="n">ok</span> <span class="p">-</span><span class="err">&gt; </span><span class="ni">ok</span> <span class="p">,</span>  
            <span class="nn">io</span><span class="p">:</span><span class="nf">format</span><span class="p">(</span><span class="s">&#34;</span><span class="si">~w~n</span><span class="s">&#34;</span><span class="p">,[</span><span class="nv">Num</span><span class="p">])</span>  
        <span class="k">end</span><span class="p">.</span>  </code></pre></td></tr></table>
</div>
</div>
<p>进程退出时会返回ok。</p>

<h2 id="erlang-之时钟"><code>erlang</code>之时钟</h2>

<p>今天来看一下<code>erlang</code>中的时钟如何实现的：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-erlang" data-lang="erlang">    <span class="p">-</span><span class="ni">module</span><span class="p">(</span><span class="n">timeout</span><span class="p">).</span>  
    <span class="p">-</span><span class="ni">export</span><span class="p">([</span><span class="n">sleep</span><span class="o">/</span><span class="mi">1</span><span class="p">,</span><span class="n">flush_buffer</span><span class="o">/</span><span class="mi">0</span><span class="p">]).</span>  
      
      
      
    <span class="c">%%%睡眠函数  
</span><span class="c"></span>    <span class="nf">sleep</span><span class="p">(</span><span class="nv">Time</span><span class="p">)</span> <span class="p">-</span><span class="err">&gt;  
</span><span class="err">        </span><span class="ni">receive</span>   
            <span class="k">after</span> <span class="nv">Time</span> <span class="p">-</span><span class="err">&gt;  
</span><span class="err">            </span><span class="ni">true</span>  
        <span class="k">end</span><span class="p">.</span>  
      
    <span class="c">%%%清空邮箱  
</span><span class="c"></span>      
    <span class="nf">flush_buffer</span><span class="p">()</span>  <span class="p">-</span><span class="err">&gt;  
</span><span class="err">        </span><span class="ni">receive</span>   
            <span class="nv">AnyMessage</span>  <span class="p">-</span><span class="err">&gt;  
</span><span class="err">                </span><span class="ni">flush_buffer</span><span class="p">()</span>  
            <span class="k">after</span>   <span class="mi">0</span>   <span class="p">-</span><span class="err">&gt;  
</span><span class="err">                </span><span class="ni">true</span>  
        <span class="k">end</span><span class="p">.</span>  
      
    <span class="c">%%% 消息优先级的实现  
</span><span class="c"></span>    <span class="c">%% 函数priority_receive会返回邮箱中第一个消息，除非有消息interrupt发送到了邮箱中，此时将返  
</span><span class="c"></span>    <span class="c">%%回interrupt。通过首先使用超时时长0来调用receive去匹配interrupt，我们可以检查邮箱中是否已经有了  
</span><span class="c"></span>    <span class="c">%%%这个消息。如果是，我们就返回它，否则，我们再通过模式AnyMessage去调用receive，这将选中邮箱中的  
</span><span class="c"></span>    <span class="c">%%第一条消息。  
</span><span class="c"></span>    <span class="nf">priority_receive</span><span class="p">()</span>  <span class="p">-</span><span class="err">&gt;  
</span><span class="err">        </span><span class="ni">receive</span>  
            <span class="n">interrupt</span>   <span class="p">-</span><span class="err">&gt;  
</span><span class="err">                </span><span class="ni">interrupt</span>  
            <span class="k">after</span>   <span class="mi">0</span>   <span class="p">-</span><span class="err">&gt;  
</span><span class="err">                </span><span class="ni">receive</span>  
                    <span class="nv">AnyMessage</span>  <span class="p">-</span><span class="err">&gt;  
</span><span class="err">                        A</span><span class="ni">nyMessage</span>  
                <span class="k">end</span>  
        <span class="k">end</span><span class="p">.</span>  </code></pre></td></tr></table>
</div>
</div>
<p>上面主要是睡眠 和清空“邮箱” ，还有就是优先级的简单实现.</p>

<p>下面再来一段吧：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-erlang" data-lang="erlang">    <span class="p">-</span><span class="ni">module</span><span class="p">(</span><span class="n">timer</span><span class="p">).</span>  
    <span class="p">-</span><span class="ni">export</span><span class="p">([</span><span class="n">timeout</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span><span class="n">cancel</span><span class="o">/</span><span class="mi">1</span><span class="p">,</span><span class="n">timer</span><span class="o">/</span><span class="mi">3</span><span class="p">]).</span>  
      
    <span class="nf">timeout</span><span class="p">(</span><span class="nv">Time</span><span class="p">,</span><span class="nv">Alarm</span><span class="p">)</span> <span class="p">-</span><span class="err">&gt;  
</span><span class="err">        </span><span class="ni">spawn</span><span class="p">(</span><span class="n">timer</span><span class="p">,</span><span class="n">timer</span><span class="p">,[</span><span class="nf">self</span><span class="p">(),</span><span class="nv">Time</span><span class="p">,</span><span class="nv">Alarm</span><span class="p">]).</span>  
      
      
    <span class="nf">cancel</span><span class="p">(</span><span class="nv">Timer</span><span class="p">)</span>   <span class="p">-</span><span class="err">&gt;  
</span><span class="err">        T</span><span class="ni">imer</span> <span class="o">!</span> <span class="p">{</span><span class="nf">self</span><span class="p">(),</span><span class="n">cancel</span><span class="p">}.</span>  
    <span class="nf">timer</span><span class="p">(</span><span class="nv">Pid</span><span class="p">,</span><span class="nv">Time</span><span class="p">,</span><span class="nv">Alarm</span><span class="p">)</span>   <span class="p">-</span><span class="err">&gt;  
</span><span class="err">        </span><span class="ni">receive</span>       
            <span class="p">{</span><span class="nv">Pid</span><span class="p">,</span><span class="n">cancel</span><span class="p">}</span>    <span class="p">-</span><span class="err">&gt;  
</span><span class="err">                </span><span class="ni">true</span>  
        <span class="k">after</span>   <span class="nv">Time</span>    <span class="p">-</span><span class="err">&gt;  
</span><span class="err">            P</span><span class="ni">id</span> <span class="o">!</span> <span class="nv">Alarm</span>  
        <span class="k">end</span><span class="p">.</span>  </code></pre></td></tr></table>
</div>
</div>
<p><code>shell</code>中演示一下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-erlang" data-lang="erlang">    <span class="mi">13</span><span class="o">&gt;</span> <span class="nv">Pid</span><span class="o">=</span><span class="nf">self</span><span class="p">(),</span>  
    <span class="mi">13</span><span class="o">&gt;</span> <span class="nn">timer</span><span class="p">:</span><span class="nf">timer</span><span class="p">(</span><span class="nv">Pid</span><span class="p">,</span><span class="mi">1000</span><span class="p">,</span><span class="n">hellword</span><span class="p">).</span>  
    <span class="n">hellword</span>  
    <span class="mi">14</span><span class="o">&gt;</span>   </code></pre></td></tr></table>
</div>
</div>
<h2 id="a-simple-erlang-process-pool-analysis">a simple erlang process pool analysis</h2>

<p><center><img src="http://laohanlinux.github.io/images/img/blog/erlang/pool/ppoll.jpg" alt="" /></center></p>

<p>这是一个简单的<code>erlang</code>进程池分析，是<code>learn you some erlang for Great Good</code>里面的一个<code>example</code>，详细的内容可到官网查看！</p>

<ul>
<li>实现原理</li>
</ul>

<p>这个的例子的实现原理官网都有比较详细的说明，主要模块在<code>ppool_serv</code>中，<code>ppool_serv</code>是一个<code>gen_server behaviour</code>, 而<code>ppool_sup</code>是一个<code>one_for_all</code>的策略,如果<code>ppool_serv</code>或者<code>worker_sup</code>出现问题，彼此也没有存在的必要了。</p>

<p>这里<code>ppool_serv</code>和<code>worker_sup</code>的实现，使用了一个简单的技巧，因为<code>worker_sup</code>不是<code>ppool_sup</code>直接调用生成的，它是由<code>ppool_serv</code>控制生成的：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="c">%% Gen server
</span><span class="c"></span><span class="nf">init</span><span class="p">({</span><span class="nv">Limit</span><span class="p">,</span> <span class="nv">MFA</span><span class="p">,</span> <span class="nv">Sup</span><span class="p">})</span> <span class="p">-</span><span class="err">&gt;
</span><span class="err">    %% W</span><span class="ni">e</span> <span class="n">need</span> <span class="n">to</span> <span class="n">find</span> <span class="n">the</span> <span class="nv">Pid</span> <span class="k">of</span> <span class="n">the</span> <span class="n">worker</span> <span class="n">supervisor</span> <span class="n">from</span> <span class="n">here</span><span class="p">,</span>
    <span class="c">%% but alas, this would be calling the supervisor while it waits for us!
</span><span class="c"></span>    <span class="nf">self</span><span class="p">()</span> <span class="o">!</span> <span class="p">{</span><span class="n">start_worker_supervisor</span><span class="p">,</span> <span class="nv">Sup</span><span class="p">,</span> <span class="nv">MFA</span><span class="p">},</span>
    <span class="p">{</span><span class="n">ok</span><span class="p">,</span> <span class="nl">#state</span><span class="p">{</span><span class="n">limit</span><span class="o">=</span><span class="nv">Limit</span><span class="p">,</span> <span class="n">refs</span><span class="o">=</span><span class="nn">gb_sets</span><span class="p">:</span><span class="nf">empty</span><span class="p">()}}.</span></code></pre></td></tr></table>
</div>
</div>
<p><code>woker_sup</code>由<code>ppool_serv</code>自己在<code>init</code>函数中，发给自己一个<code>Message</code>，然后在回调函数中才生成：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="nf">handle_info</span><span class="p">({</span><span class="n">start_worker_supervisor</span><span class="p">,</span> <span class="nv">Sup</span><span class="p">,</span> <span class="nv">MFA</span><span class="p">},</span> <span class="nv">S</span> <span class="o">=</span> <span class="nl">#state</span><span class="p">{})</span> <span class="p">-</span><span class="err">&gt;
</span><span class="err">    {</span><span class="ni">ok</span><span class="p">,</span> <span class="nv">Pid</span><span class="p">}</span> <span class="o">=</span> <span class="nn">supervisor</span><span class="p">:</span><span class="nf">start_child</span><span class="p">(</span><span class="nv">Sup</span><span class="p">,</span> <span class="o">?</span><span class="nv">SPEC</span><span class="p">(</span><span class="nv">MFA</span><span class="p">)),</span>
    <span class="nb">link</span><span class="p">(</span><span class="nv">Pid</span><span class="p">),</span>
    <span class="p">{</span><span class="n">noreply</span><span class="p">,</span> <span class="nv">S</span><span class="nl">#state</span><span class="p">{</span><span class="n">sup</span><span class="o">=</span><span class="nv">Pid</span><span class="p">}};</span></code></pre></td></tr></table>
</div>
</div>
<p>如果他们一起直接生产，那么会产生死锁，
<center><img src="http://laohanlinux.github.io/images/img/blog/erlang/pool/ppool_1.png" alt="" /></center></p>

<p>当然，他这里的生成顺序，可以自己修改一下，也不会出现死锁。</p>

<p><code>gen_serv</code>的主要数据结构</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="p">-</span><span class="ni">define</span><span class="p">(</span><span class="no">SPEC</span><span class="p">(</span><span class="nv">MFA</span><span class="p">),</span>
        <span class="p">{</span><span class="n">worker_sup</span><span class="p">,</span>
         <span class="p">{</span><span class="n">ppool_worker_sup</span><span class="p">,</span> <span class="n">start_link</span><span class="p">,</span> <span class="p">[</span><span class="nv">MFA</span><span class="p">]},</span>
          <span class="n">temporary</span><span class="p">,</span>
          <span class="mi">10000</span><span class="p">,</span>
          <span class="n">supervisor</span><span class="p">,</span>
          <span class="p">[</span><span class="n">ppool_worker_sup</span><span class="p">]}).</span>

<span class="p">-</span><span class="ni">record</span><span class="p">(</span><span class="nl">state</span><span class="p">,</span> <span class="p">{</span><span class="n">limit</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                <span class="n">sup</span><span class="p">,</span>
                <span class="n">refs</span><span class="p">,</span>
                <span class="n">queue</span><span class="o">=</span><span class="nn">queue</span><span class="p">:</span><span class="nf">new</span><span class="p">()}).</span></code></pre></td></tr></table>
</div>
</div>
<p><code>?SPEC(MFA)</code>, 这里的<code>MFA</code>指明一类<code>Task</code>，所以同一个<code>ppool_worker_sup</code>,不会有不同类型的<code>Task</code>，它的策略也是<code>simple_one_for_one</code>.</p>

<p>在这个例子中，使用了一个<code>gen_server -- nnager module</code>作为<code>Task</code>，这个<code>Task</code>的参数为：<code>{Task, Delay, Max, SendTo}</code>， <code>Task</code>标示任务名字，<code>Delay</code>作为超时时间，只是标示这个任务是有超时限制的，也是一个调试技巧，<code>Max</code>为最大超时次数，<code>SendTo</code>用来发送信息给回调进程，这个进程可以是<code>shell</code>， 如果是<code>shell</code>，<code>flush()</code>就会收到信息。</p>

<p><code>record</code>用来标识一些主要的信息，<code>Limit</code>为进程池的大小限制，<code>sup</code>开始为<code>ppool_sup</code>的<code>pid（）</code>，在生成<code>woker_sup</code>进程后，就变成<code>worker_sup</code>的进程<code>pid（）</code>，因为<code>ppool_serv</code>的主要交流对象还是<code>worker_sup</code>和<code>worker(Task)</code>； <code>refs（gb_set）</code>为<code>woker</code>的进程链接，这样可以在<code>worker</code>进程<code>down</code>掉或者<code>done</code>时，从线程池中剔除掉；<code>queue</code>为任务队列，当任务大于<code>limit</code>时，就把多余的任务放到<code>queque</code>中，等到进程池有空闲时，就从中<code>pop</code>出任务，接着处理。</p>

<p>这里有些局限的地方：
- 每次的任务都是新建的进程去处理，就是说进程的生命周期跟任务的生命周期是一样的，可以把进程跟任务分离出来，让进程不随任务的结束而结束（当然这的任务就不要是<code>gen_server</code>,<code>gen_fsm</code>这些，因为这些也是<code>spawn</code>出来的进程），这样进程开销理论上一次初始化就行了，虽然进程在<code>erlang</code>中开销比较少；
- 队列没有大小限制</p>

<h2 id="poolboy">PoolBoy</h2>

<p>source code ：</p>

<p><a href="https://github.com/devinus/poolboy">https://github.com/devinus/poolboy</a></p>

<p><img src="http://laohanlinux.github.io/images/img/blog/erlang/pool/poolboy.png" alt="" /></p>

<ul>
<li>Checkout</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="nf">ready</span><span class="p">({</span><span class="n">checkout</span><span class="p">,</span> <span class="nv">Block</span><span class="p">,</span> <span class="nv">Timeout</span><span class="p">},</span> <span class="p">{</span><span class="nv">FromPid</span><span class="p">,</span> <span class="p">_}</span><span class="o">=</span><span class="nv">From</span><span class="p">,</span> <span class="nv">State</span><span class="p">)</span> <span class="p">-</span><span class="err">&gt;
</span><span class="err">    #</span><span class="ni">state</span><span class="p">{</span><span class="n">supervisor</span> <span class="o">=</span> <span class="nv">Sup</span><span class="p">,</span>
           <span class="n">workers</span> <span class="o">=</span> <span class="nv">Workers</span><span class="p">,</span>
           <span class="n">monitors</span> <span class="o">=</span> <span class="nv">Monitors</span><span class="p">,</span>
           <span class="n">max_overflow</span> <span class="o">=</span> <span class="nv">MaxOverflow</span><span class="p">}</span> <span class="o">=</span> <span class="nv">State</span><span class="p">,</span>
    <span class="k">case</span> <span class="nn">queue</span><span class="p">:</span><span class="nf">out</span><span class="p">(</span><span class="nv">Workers</span><span class="p">)</span> <span class="k">of</span>
        <span class="p">{{</span><span class="n">value</span><span class="p">,</span> <span class="nv">Pid</span><span class="p">},</span> <span class="nv">Left</span><span class="p">}</span> <span class="p">-</span><span class="err">&gt;
</span><span class="err">            R</span><span class="ni">ef</span> <span class="o">=</span> <span class="nn">erlang</span><span class="p">:</span><span class="nb">monitor</span><span class="p">(</span><span class="n">process</span><span class="p">,</span> <span class="nv">FromPid</span><span class="p">),</span>
            <span class="n">true</span> <span class="o">=</span> <span class="nn">ets</span><span class="p">:</span><span class="nf">insert</span><span class="p">(</span><span class="nv">Monitors</span><span class="p">,</span> <span class="p">{</span><span class="nv">Pid</span><span class="p">,</span> <span class="nv">Ref</span><span class="p">}),</span>
            <span class="nv">NextState</span> <span class="o">=</span> <span class="k">case</span> <span class="nn">queue</span><span class="p">:</span><span class="nf">is_empty</span><span class="p">(</span><span class="nv">Left</span><span class="p">)</span> <span class="k">of</span>
                <span class="n">true</span> <span class="k">when</span> <span class="nv">MaxOverflow</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="p">-</span><span class="err">&gt; </span><span class="ni">full</span><span class="p">;</span>
                <span class="n">true</span> <span class="p">-</span><span class="err">&gt; </span><span class="ni">overflow</span><span class="p">;</span>
                <span class="n">false</span> <span class="p">-</span><span class="err">&gt; </span><span class="ni">ready</span>
            <span class="k">end</span><span class="p">,</span>
            <span class="p">{</span><span class="n">reply</span><span class="p">,</span> <span class="nv">Pid</span><span class="p">,</span> <span class="nv">NextState</span><span class="p">,</span> <span class="nv">State</span><span class="nl">#state</span><span class="p">{</span><span class="n">workers</span><span class="o">=</span><span class="nv">Left</span><span class="p">}};</span>
        <span class="p">{</span><span class="n">empty</span><span class="p">,</span> <span class="nv">Empty</span><span class="p">}</span> <span class="k">when</span> <span class="nv">MaxOverflow</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="p">-</span><span class="err">&gt;
</span><span class="err">            {P</span><span class="ni">id</span><span class="p">,</span> <span class="nv">Ref</span><span class="p">}</span> <span class="o">=</span> <span class="nf">new_worker</span><span class="p">(</span><span class="nv">Sup</span><span class="p">,</span> <span class="nv">FromPid</span><span class="p">),</span>
            <span class="n">true</span> <span class="o">=</span> <span class="nn">ets</span><span class="p">:</span><span class="nf">insert</span><span class="p">(</span><span class="nv">Monitors</span><span class="p">,</span> <span class="p">{</span><span class="nv">Pid</span><span class="p">,</span> <span class="nv">Ref</span><span class="p">}),</span>
            <span class="p">{</span><span class="n">reply</span><span class="p">,</span> <span class="nv">Pid</span><span class="p">,</span> <span class="n">overflow</span><span class="p">,</span> <span class="nv">State</span><span class="nl">#state</span><span class="p">{</span><span class="n">workers</span><span class="o">=</span><span class="nv">Empty</span><span class="p">,</span> <span class="n">overflow</span><span class="o">=</span><span class="mi">1</span><span class="p">}};</span>
        <span class="p">{</span><span class="n">empty</span><span class="p">,</span> <span class="nv">Empty</span><span class="p">}</span> <span class="k">when</span> <span class="nv">Block</span> <span class="o">=:=</span> <span class="n">false</span> <span class="p">-</span><span class="err">&gt;
</span><span class="err">            {</span><span class="ni">reply</span><span class="p">,</span> <span class="n">full</span><span class="p">,</span> <span class="n">full</span><span class="p">,</span> <span class="nv">State</span><span class="nl">#state</span><span class="p">{</span><span class="n">workers</span><span class="o">=</span><span class="nv">Empty</span><span class="p">}};</span>
        <span class="p">{</span><span class="n">empty</span><span class="p">,</span> <span class="nv">Empty</span><span class="p">}</span> <span class="p">-</span><span class="err">&gt;
</span><span class="err">            W</span><span class="ni">aiting</span> <span class="o">=</span> <span class="nf">add_waiting</span><span class="p">(</span><span class="nv">From</span><span class="p">,</span> <span class="nv">Timeout</span><span class="p">,</span> <span class="nv">State</span><span class="nl">#state.waiting</span><span class="p">),</span>
            <span class="p">{</span><span class="n">next_state</span><span class="p">,</span> <span class="n">full</span><span class="p">,</span> <span class="nv">State</span><span class="nl">#state</span><span class="p">{</span><span class="n">workers</span><span class="o">=</span><span class="nv">Empty</span><span class="p">,</span> <span class="n">waiting</span><span class="o">=</span><span class="nv">Waiting</span><span class="p">}}</span>
    <span class="k">end</span><span class="p">;</span></code></pre></td></tr></table>
</div>
</div>
<p><code>Checkout</code>出一个<code>worker</code>从<code>worker Queue</code>中，如果有,则<code>monitor（ets）</code>这个<code>worker</code>，然后根据队列的容量和<code>MaxOverflow</code>的值来确定下一状态为<code>full</code>，<code>overflow</code>，<code>ready</code> （<code>ready + overflow &lt;= full</code>）;如果没有，而<code>MaxOverFlow</code>的值大于<code>0</code>，则新建一个<code>worker</code>，并将其加入<code>monitor</code>，最后重置状态项<code>worker = empty, overflow = 1</code>；如果没有，并且<code>MaxOverflow</code> 小于<code>1</code>， <code>Block == false</code>，则<code>{reply, full, full, State#state{workers=Empty}}</code>;如过没有，<code>MaxOverflow &lt; 1</code>, <code>Block == true</code>,则 <code>{next_state, full, State#state{workers=Empty, waiting=Waiting}}</code>。</p>

<ul>
<li>Checkin</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="nf">ready</span><span class="p">({</span><span class="n">checkin</span><span class="p">,</span> <span class="nv">Pid</span><span class="p">},</span> <span class="nv">State</span><span class="p">)</span> <span class="p">-</span><span class="err">&gt;
</span><span class="err">    M</span><span class="ni">onitors</span> <span class="o">=</span> <span class="nv">State</span><span class="nl">#state.monitors</span><span class="p">,</span>
    <span class="k">case</span> <span class="nn">ets</span><span class="p">:</span><span class="nf">lookup</span><span class="p">(</span><span class="nv">Monitors</span><span class="p">,</span> <span class="nv">Pid</span><span class="p">)</span> <span class="k">of</span>
        <span class="p">[{</span><span class="nv">Pid</span><span class="p">,</span> <span class="nv">Ref</span><span class="p">}]</span> <span class="p">-</span><span class="err">&gt;
</span><span class="err">            </span><span class="ni">true</span> <span class="o">=</span> <span class="nn">erlang</span><span class="p">:</span><span class="nb">demonitor</span><span class="p">(</span><span class="nv">Ref</span><span class="p">),</span>
            <span class="n">true</span> <span class="o">=</span> <span class="nn">ets</span><span class="p">:</span><span class="nf">delete</span><span class="p">(</span><span class="nv">Monitors</span><span class="p">,</span> <span class="nv">Pid</span><span class="p">),</span>
            <span class="nv">Workers</span> <span class="o">=</span> <span class="nn">queue</span><span class="p">:</span><span class="nf">in</span><span class="p">(</span><span class="nv">Pid</span><span class="p">,</span> <span class="nv">State</span><span class="nl">#state.workers</span><span class="p">),</span>
            <span class="p">{</span><span class="n">next_state</span><span class="p">,</span> <span class="n">ready</span><span class="p">,</span> <span class="nv">State</span><span class="nl">#state</span><span class="p">{</span><span class="n">workers</span><span class="o">=</span><span class="nv">Workers</span><span class="p">}};</span>
        <span class="p">[]</span> <span class="p">-</span><span class="err">&gt;
</span><span class="err">            {</span><span class="ni">next_state</span><span class="p">,</span> <span class="n">ready</span><span class="p">,</span> <span class="nv">State</span><span class="p">}</span>
    <span class="k">end</span><span class="p">;</span></code></pre></td></tr></table>
</div>
</div>
<p>从<code>Monitor</code>中剔除对应的<code>worker</code>，然后回收到<code>worker queue</code>中去。
状态转变</p>

<ul>
<li>状态转变的计算：</li>
</ul>

<p><code>worker_queue_size</code>(当前<code>size</code>) + <code>maxoverflow</code> 。</p>

<p><code>ready</code>只与当前<code>worker_queque_size</code>有关，<code>overflow</code> 和<code>worker_queue_size(0)</code>和<code>maxoverflow&gt;0</code>有关，<code>full</code>和<code>work_queue_size(0)</code>, <code>overfllow = maxoverflow</code>有关。
- <code>worker</code>的来源</p>

<p>所有的<code>worker</code>要么在初始化时创建平；要么调用<code>checkout</code>时，经过<code>poolboy</code>创建，但此时创建的<code>worker</code>没有进到<code>worker queue</code>，要想进到<code>worker queue</code>，只能调用<code>checkin</code>。
<code>work pid</code> 回收到<code>worker_queue</code>中</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="n">checkin_while_full</span> <span class="p">-</span><span class="err">-》{</span><span class="ni">empty</span><span class="p">,</span> <span class="nv">Empty</span><span class="p">}</span> <span class="k">when</span> <span class="nv">MaxOverflow</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="p">-</span><span class="err">&gt;；</span></code></pre></td></tr></table>
</div>
</div>
    </div>

    <div class="post-copyright">
  <p class="copyright-item">
    <span class="item-title">Author</span>
    <span class="item-content">Rg</span>
  </p>
  <p class="copyright-item">
    <span class="item-title">LastMod</span>
    <span class="item-content">
        2016-04-25
        
    </span>
  </p>
  
  <p class="copyright-item">
    <span class="item-title">License</span>
    <span class="item-content">本文采用<a rel="license" href="http://creativecommons.org/licenses/by-nc/4.0/" target="_blank">知识共享署名-非商业性使用 4.0 国际许可协议</a>进行许可</span>
  </p>
</div>
<div class="post-reward">
  <input type="checkbox" name="reward" id="reward" hidden />
  <label class="reward-button" for="reward">Reward</label>
  <div class="qr-code">
    
    <label class="qr-code-image" for="reward">
        <img class="image" src="https://ws2.sinaimg.cn/large/006tNc79gy1g1r15n5iquj30u014qgqe.jpg">
        <span>wechat</span>
      </label>
    <label class="qr-code-image" for="reward">
        <img class="image" src="https://ws1.sinaimg.cn/large/006tNc79gy1g1sr2bajn6j30ih0wuad9.jpg">
        <span>alipay</span>
      </label>
  </div>
</div><footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/erlang/">Erlang</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/2016/04/25/%E4%BD%BF%E7%94%A8raft%E7%AE%97%E6%B3%95%E5%BF%AB%E7%86%9F%E6%9E%84%E5%BB%BA%E4%B8%80%E4%B8%AA%E5%88%86%E5%B8%83%E5%BC%8F%E7%9A%84key-value%E7%B3%BB%E7%BB%9F/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">使用raft算法快速构建一个分布式kv系统</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        <a class="next" href="/2016/03/30/paxos/">
            <span class="next-text nav-default">paxos</span>
            <span class="next-text nav-mobile">Next</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        <div id="gitalk-container"></div>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js" crossorigin="anonymous"></script>
    <script type="text/javascript">
      var gitalk = new Gitalk({
        id: '2016-04-25 00:15:14 \x2b0000 UTC',
        title: 'erlang学习笔记',
        clientID: '88e50f263d090b13460f',
        clientSecret: 'f1007eb6cff0af3b461be3a4b73d808ab7058a21',
        repo: 'blog',
        owner: 'laohanlinux',
        admin: ['laohanlinux'],
        body: decodeURI(location.href)
      });
      gitalk.render('gitalk-container');
    </script>
    <noscript>Please enable JavaScript to view the <a href="https://github.com/gitalk/gitalk">comments powered by gitalk.</a></noscript>

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
      <a href="mailto:daimaldd@email.com" class="iconfont icon-email" title="email"></a>
      <a href="https://github.com/laohanlinux" class="iconfont icon-github" title="github"></a>
  <a href="https://laohanlinux.github.io/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2013 - 
    2019
    <span class="heart">
      <i class="iconfont icon-heart"></i>
    </span>
    <span class="author">Rg</span>
  </span>
</div>
    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script>
<script type="text/javascript" src="/dist/even.26188efa.min.js"></script>








</body>
</html>
