<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>muduo net library chapter 1 - Welcome to Rg Home</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<meta name="author" content="Rg" /><meta name="description" content="muduo 是一个linux 网络库，使用poll和epoll模式。 这些内容是本人在大学的时候，通过  &lt;&lt; c&#43;&#43;教程网 &gt;&gt;  所学的知识笔记. 已经过去好几年了，版本也是比较老的了，属于入门级别的教程； 如有错误，纯属正常!!!" /><meta name="keywords" content="Rg, Rust, even" />






<meta name="generator" content="Hugo 0.54.0 with even 4.0.0" />


<link rel="canonical" href="https://laohanlinux.github.io/2015/07/01/muduo-net-library-chapter-1/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">


<link href="/dist/even.3292c2b1.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">


<meta property="og:title" content="muduo net library chapter 1" />
<meta property="og:description" content="muduo 是一个linux 网络库，使用poll和epoll模式。 这些内容是本人在大学的时候，通过  &lt;&lt; c&#43;&#43;教程网 &gt;&gt;  所学的知识笔记. 已经过去好几年了，版本也是比较老的了，属于入门级别的教程； 如有错误，纯属正常!!!" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://laohanlinux.github.io/2015/07/01/muduo-net-library-chapter-1/" />
<meta property="article:published_time" content="2015-07-01T00:04:49&#43;00:00"/>
<meta property="article:modified_time" content="2015-07-01T00:04:49&#43;00:00"/>

<meta itemprop="name" content="muduo net library chapter 1">
<meta itemprop="description" content="muduo 是一个linux 网络库，使用poll和epoll模式。 这些内容是本人在大学的时候，通过  &lt;&lt; c&#43;&#43;教程网 &gt;&gt;  所学的知识笔记. 已经过去好几年了，版本也是比较老的了，属于入门级别的教程； 如有错误，纯属正常!!!">


<meta itemprop="datePublished" content="2015-07-01T00:04:49&#43;00:00" />
<meta itemprop="dateModified" content="2015-07-01T00:04:49&#43;00:00" />
<meta itemprop="wordCount" content="16564">



<meta itemprop="keywords" content="muduo," />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="muduo net library chapter 1"/>
<meta name="twitter:description" content="muduo 是一个linux 网络库，使用poll和epoll模式。 这些内容是本人在大学的时候，通过  &lt;&lt; c&#43;&#43;教程网 &gt;&gt;  所学的知识笔记. 已经过去好几年了，版本也是比较老的了，属于入门级别的教程； 如有错误，纯属正常!!!"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">Welcome come to Rg Home</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Go ~/</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a>
  </ul>
</nav>
  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">Welcome come to Rg Home</a>
</div>

<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Go ~/</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li>
  </ul>
</nav>
    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">muduo net library chapter 1</h1>

      <div class="post-meta">
        <span class="post-time"> 2015-07-01 </span>
        <div class="post-category">
            <a href="/categories/muduo/"> muduo </a>
            <a href="/categories/network-program/"> network program </a>
            </div>
          <span class="more-meta"> 16564 words </span>
          <span class="more-meta"> 34 mins read </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Contents</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
<ul>
<li>
<ul>
<li><a href="#25-muduo-net库源码分析">[25] muduo_net库源码分析</a>
<ul>
<li><a href="#tcp网络编程本质">TCP网络编程本质</a></li>
<li><a href="#echoserver类图">EchoServer类图</a></li>
<li><a href="#eventloop-头文件">EventLoop 头文件</a></li>
<li><a href="#eventloop-的测试程序1">EventLoop 的测试程序1</a></li>
<li><a href="#程序输出">程序输出</a></li>
<li><a href="#测试程序2">测试程序2</a></li>
</ul></li>
<li><a href="#27-epollpoller">[27] EpollPoller</a>
<ul>
<li><a href="#epollpoller的头文件">EpollPoller的头文件</a></li>
<li><a href="#epollpoller的源文件">EpollPoller的源文件</a></li>
<li><a href="#测试程序">测试程序</a></li>
</ul></li>
<li><a href="#28-muduo的定时器由三个类实现-timerid-定时器-timer-最上层的抽象-timerqueue-定时器的列表">[28] muduo的定时器由三个类实现，TimerId（定时器）、Timer(最上层的抽象)、TimerQueue（定时器的列表）</a>
<ul>
<li><a href="#时序图">时序图</a></li>
<li><a href="#timer头文件">Timer头文件</a></li>
<li><a href="#timer源文件">Timer源文件</a></li>
<li><a href="#timerid头文件">TimerId头文件</a></li>
<li><a href="#timerqueue头文件">TimerQueue头文件</a></li>
<li><a href="#timerqueue源文件">TimerQueue源文件</a></li>
</ul></li>
<li><a href="#29-eventloop再分析之io线程-29">[29] EventLoop再分析之IO线程（29）</a>
<ul>
<li><a href="#eventloop-io-线程的简单描述">EventLoop IO 线程的简单描述</a></li>
<li><a href="#进程-线程-wait-notify">进程(线程)wait/notify</a></li>
<li><a href="#eventloop头文件">EventLoop头文件</a></li>
<li><a href="#eventloop源文件">EventLoop源文件</a></li>
<li><a href="#测试程序源代码">测试程序源代码</a></li>
<li><a href="#测试输出">测试输出</a></li>
</ul></li>
<li><a href="#30-eventloopthread">[30] EventLoopThread</a>
<ul>
<li><a href="#eventloopthread头文件">EventLoopThread头文件</a></li>
<li><a href="#eventloopthread源文件">EventLoopThread源文件</a></li>
<li><a href="#测试程序-1">测试程序</a></li>
<li><a href="#程序输出-1">程序输出</a></li>
</ul></li>
<li><a href="#31-socket封装">[31] Socket封装</a>
<ul>
<li><a href="#endian头文件">Endian头文件</a></li>
<li><a href="#inetaddress头文件">InetAddress头文件</a></li>
<li><a href="#inetaddress源文件">InetAddress源文件</a></li>
<li><a href="#sokcet头文件">Sokcet头文件</a></li>
<li><a href="#socket源文件">Socket源文件</a></li>
<li><a href="#程序程序">程序程序</a></li>
</ul></li>
<li><a href="#32-acceptor">[32] Acceptor</a>
<ul>
<li><a href="#acceptor的头文件">Acceptor的头文件</a></li>
<li><a href="#acceptor源文件">Acceptor源文件</a></li>
<li><a href="#测试程序-2">测试程序</a></li>
<li><a href="#程序输出-2">程序输出</a></li>
</ul></li>
</ul></li>
</ul>
</nav>
  </div>
</div>
    <div class="post-content">
      

<h2 id="25-muduo-net库源码分析">[25] muduo_net库源码分析</h2>

<h3 id="tcp网络编程本质">TCP网络编程本质</h3>

<p>TCP网络编程最本质是的处理三个半事件</p>

<ul>
<li>连接建立：服务器accept（被动）接受连接，客户端connect（主动）发起连接</li>
<li>连接断开：主动断开（close、shutdown），被动断开（read返回0）</li>
<li>消息到达：文件描述符可读</li>
<li>消息发送完毕：这算半个。对于低流量的服务，可不必关心这个事件;这里的发送完毕是指数据写入操作系统缓冲区，将由TCP协议栈负责数据的发送与重传，不代表对方已经接收到数据。</li>
</ul>

<h3 id="echoserver类图">EchoServer类图</h3>

<p><center><img src="http://laohanlinux.github.io/images/img/blog/muduo-net-library-chapter-1/EchoServer.png" alt="" /></center></p>

<p><em>什么都不做的EventLoop</em></p>

<ul>
<li>one loop   per thread</li>
</ul>

<p>意思是说每个线程最多只能有一个EventLoop对象。</p>

<ul>
<li>EventLoop对象构造的时候，会检查当前线程是否已经创建了其他EventLoop对象，如果已创建，终止程序（LOG_FATAL）EventLoop构造函数会记住本对象所属线程（threadId_）。</li>
<li>创建了EventLoop对象的线程称为IO线程，其功能是运行事件循环（EventLoop::loop）</li>
</ul>

<h3 id="eventloop-头文件">EventLoop 头文件</h3>

<p>EventLoop.h</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-c++" data-lang="c++"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c++" data-lang="c++">  <span class="c1">// Copyright 2010, Shuo Chen.  All rights reserved.
</span><span class="c1"></span>  <span class="c1">// http://code.google.com/p/muduo/
</span><span class="c1"></span>  <span class="c1">//
</span><span class="c1"></span>  <span class="c1">// Use of this source code is governed by a BSD-style license
</span><span class="c1"></span>  <span class="c1">// that can be found in the License file.
</span><span class="c1"></span>  
  <span class="c1">// Author: Shuo Chen (chenshuo at chenshuo dot com)
</span><span class="c1"></span>  <span class="c1">//
</span><span class="c1"></span>  <span class="c1">// This is a public header file, it must only include public header files.
</span><span class="c1"></span>  
  <span class="cp">#ifndef MUDUO_NET_EVENTLOOP_H
</span><span class="cp"></span>  <span class="cp">#define MUDUO_NET_EVENTLOOP_H
</span><span class="cp"></span>  
  <span class="cp">#include</span> <span class="cpf">&lt;boost/noncopyable.hpp&gt;</span><span class="cp">
</span><span class="cp"></span>  
  <span class="cp">#include</span> <span class="cpf">&lt;muduo/base/CurrentThread.h&gt;</span><span class="cp">
</span><span class="cp"></span>  <span class="cp">#include</span> <span class="cpf">&lt;muduo/base/Thread.h&gt;</span><span class="cp">
</span><span class="cp"></span>  
  <span class="k">namespace</span> <span class="n">muduo</span>
  <span class="p">{</span>
  <span class="k">namespace</span> <span class="n">net</span>
  <span class="p">{</span>
  
  <span class="c1">///
</span><span class="c1"></span>  <span class="c1">/// Reactor, at most one per thread.
</span><span class="c1"></span>  <span class="c1">///
</span><span class="c1"></span>  <span class="c1">/// This is an interface class, so don&#39;t expose too much details.
</span><span class="c1"></span>  <span class="k">class</span><span class="err"> </span><span class="nc">EventLoop</span> <span class="o">:</span> <span class="n">boost</span><span class="o">::</span><span class="n">noncopyable</span>
  <span class="p">{</span>
  <span class="k">public</span><span class="o">:</span>
    <span class="n">EventLoop</span><span class="p">();</span>
    <span class="o">~</span><span class="n">EventLoop</span><span class="p">();</span>  <span class="c1">// force out-line dtor, for scoped_ptr members.
</span><span class="c1"></span>  
    <span class="c1">///
</span><span class="c1"></span>    <span class="c1">/// Loops forever.
</span><span class="c1"></span>    <span class="c1">///
</span><span class="c1"></span>    <span class="c1">/// Must be called in the same thread as creation of the object.
</span><span class="c1"></span>    <span class="c1">///
</span><span class="c1"></span>    <span class="kt">void</span> <span class="nf">loop</span><span class="p">();</span>
  
    <span class="c1">//断言是否是当前的线程
</span><span class="c1"></span>  
    <span class="kt">void</span> <span class="nf">assertInLoopThread</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="c1">//过是当前线程，直接跳过，否则调用abortNotInLoopThread
</span><span class="c1"></span>      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">isInLoopThread</span><span class="p">())</span>
      <span class="p">{</span>
        <span class="n">abortNotInLoopThread</span><span class="p">();</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="c1">//测试是否为当前线程
</span><span class="c1"></span>    <span class="kt">bool</span> <span class="nf">isInLoopThread</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span> <span class="k">return</span> <span class="n">threadId_</span> <span class="o">==</span> <span class="n">CurrentThread</span><span class="o">::</span><span class="n">tid</span><span class="p">();</span> <span class="p">}</span>
  
    <span class="k">static</span> <span class="n">EventLoop</span><span class="o">*</span> <span class="nf">getEventLoopOfCurrentThread</span><span class="p">();</span>
  
  <span class="k">private</span><span class="o">:</span>
    <span class="kt">void</span> <span class="n">abortNotInLoopThread</span><span class="p">();</span>
  
    <span class="kt">bool</span> <span class="n">looping_</span><span class="p">;</span> <span class="cm">/* atomic , 是否处于事件循环*/</span>
    <span class="k">const</span> <span class="n">pid_t</span> <span class="n">threadId_</span><span class="p">;</span>        <span class="c1">// 当前对象所属线程ID
</span><span class="c1"></span>  <span class="p">};</span>
  
  <span class="p">}</span>
  <span class="p">}</span>
  <span class="cp">#endif  </span><span class="c1">// MUDUO_NET_EVENTLOOP_H
</span></code></pre></td></tr></table>
</div>
</div>
<p>### EventLoop 源文件</p>

<p>EventLoop.cpp</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-c++" data-lang="c++"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c++" data-lang="c++">  <span class="c1">// Copyright 2010, Shuo Chen.  All rights reserved.
</span><span class="c1"></span>  <span class="c1">// http://code.google.com/p/muduo/
</span><span class="c1"></span>  <span class="c1">//
</span><span class="c1"></span>  <span class="c1">// Use of this source code is governed by a BSD-style license
</span><span class="c1"></span>  <span class="c1">// that can be found in the License file.
</span><span class="c1"></span>  
  <span class="c1">// Author: Shuo Chen (chenshuo at chenshuo dot com)
</span><span class="c1"></span>  
  <span class="cp">#include</span> <span class="cpf">&lt;muduo/net/EventLoop.h&gt;</span><span class="cp">
</span><span class="cp"></span>  
  <span class="cp">#include</span> <span class="cpf">&lt;muduo/base/Logging.h&gt;</span><span class="cp">
</span><span class="cp"></span>  
  <span class="cp">#include</span> <span class="cpf">&lt;poll.h&gt;</span><span class="cp">
</span><span class="cp"></span>  
  <span class="k">using</span> <span class="k">namespace</span> <span class="n">muduo</span><span class="p">;</span>
  <span class="k">using</span> <span class="k">namespace</span> <span class="n">muduo</span><span class="o">::</span><span class="n">net</span><span class="p">;</span>
  
  <span class="k">namespace</span>
  <span class="p">{</span>
  <span class="c1">// 当前线程EventLoop对象指针
</span><span class="c1"></span>  <span class="c1">// 线程局部存储 ，如果不用__thread修饰的话，那么就是线程共共享的了
</span><span class="c1"></span>  <span class="c1">//这样达不到目标，。。
</span><span class="c1"></span>  <span class="c1">//初始化时，设为0就OK了
</span><span class="c1"></span>  <span class="n">__thread</span> <span class="n">EventLoop</span><span class="o">*</span> <span class="n">t_loopInThisThread</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="p">}</span>
  
  <span class="n">EventLoop</span><span class="o">*</span> <span class="n">EventLoop</span><span class="o">::</span><span class="n">getEventLoopOfCurrentThread</span><span class="p">()</span>
  <span class="p">{</span>
    <span class="k">return</span> <span class="n">t_loopInThisThread</span><span class="p">;</span>
  <span class="p">}</span>
  
  <span class="n">EventLoop</span><span class="o">::</span><span class="n">EventLoop</span><span class="p">()</span>
    <span class="o">:</span> <span class="n">looping_</span><span class="p">(</span><span class="nb">false</span><span class="p">),</span> <span class="c1">//初始化为false ，表示当前还没有处于事件循环状态
</span><span class="c1"></span>      <span class="n">threadId_</span><span class="p">(</span><span class="n">CurrentThread</span><span class="o">::</span><span class="n">tid</span><span class="p">())</span> <span class="c1">//当前的线程Id ，用于标识
</span><span class="c1"></span>  <span class="p">{</span>
    <span class="n">LOG_TRACE</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;EventLoop created &#34;</span> <span class="o">&lt;&lt;</span> <span class="k">this</span> <span class="o">&lt;&lt;</span> <span class="s">&#34; in thread &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">threadId_</span><span class="p">;</span>
    <span class="c1">// 如果当前线程已经创建了EventLoop对象，终止(LOG_FATAL),否者的话，设为当前线程this
</span><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">t_loopInThisThread</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">LOG_FATAL</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;Another EventLoop &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">t_loopInThisThread</span>
                <span class="o">&lt;&lt;</span> <span class="s">&#34; exists in this thread &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">threadId_</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">else</span>
    <span class="p">{</span>
      <span class="n">t_loopInThisThread</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
  
  <span class="n">EventLoop</span><span class="o">::~</span><span class="n">EventLoop</span><span class="p">()</span>
  <span class="p">{</span>
    <span class="n">t_loopInThisThread</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
  <span class="p">}</span>
  
  <span class="c1">// 事件循环，该函数不能跨线程调用
</span><span class="c1"></span>  <span class="c1">// 只能在创建该对象的线程中调用
</span><span class="c1"></span>  <span class="kt">void</span> <span class="n">EventLoop</span><span class="o">::</span><span class="n">loop</span><span class="p">()</span>
  <span class="p">{</span>
  <span class="c1">//断言还没有事件循环
</span><span class="c1"></span>    <span class="n">assert</span><span class="p">(</span><span class="o">!</span><span class="n">looping_</span><span class="p">);</span>
    <span class="c1">// 断言当前处于创建该对象的线程中
</span><span class="c1"></span>    <span class="n">assertInLoopThread</span><span class="p">();</span>
    <span class="c1">//把事件循环标识设为true
</span><span class="c1"></span>    <span class="n">looping_</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
    <span class="n">LOG_TRACE</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;EventLoop &#34;</span> <span class="o">&lt;&lt;</span> <span class="k">this</span> <span class="o">&lt;&lt;</span> <span class="s">&#34; start looping&#34;</span><span class="p">;</span>
    <span class="c1">//关注事件为NULL，个数为0，延时5000
</span><span class="c1"></span>    <span class="o">::</span><span class="n">poll</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">5</span><span class="o">*</span><span class="mi">1000</span><span class="p">);</span>
  
    <span class="n">LOG_TRACE</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;EventLoop &#34;</span> <span class="o">&lt;&lt;</span> <span class="k">this</span> <span class="o">&lt;&lt;</span> <span class="s">&#34; stop looping&#34;</span><span class="p">;</span>
    <span class="c1">//事件循环标识设为false ，这只是测试程序
</span><span class="c1"></span>    <span class="n">looping_</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
  <span class="p">}</span>
  
  <span class="c1">//终止程序
</span><span class="c1"></span>  <span class="kt">void</span> <span class="n">EventLoop</span><span class="o">::</span><span class="n">abortNotInLoopThread</span><span class="p">()</span>
  <span class="p">{</span>
    <span class="n">LOG_FATAL</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;EventLoop::abortNotInLoopThread - EventLoop &#34;</span> <span class="o">&lt;&lt;</span> <span class="k">this</span>
              <span class="o">&lt;&lt;</span> <span class="s">&#34; was created in threadId_ = &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">threadId_</span>
              <span class="o">&lt;&lt;</span> <span class="s">&#34;, current thread id = &#34;</span> <span class="o">&lt;&lt;</span>  <span class="n">CurrentThread</span><span class="o">::</span><span class="n">tid</span><span class="p">();</span>
  <span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div>
<h3 id="eventloop-的测试程序1">EventLoop 的测试程序1</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-c++" data-lang="c++"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c++" data-lang="c++"><span class="cp">#include</span> <span class="cpf">&lt;muduo/net/EventLoop.h&gt;</span><span class="cp">
</span><span class="cp"></span> 
<span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
</span><span class="cp"></span> 
<span class="k">using</span> <span class="k">namespace</span> <span class="n">muduo</span><span class="p">;</span>
<span class="k">using</span> <span class="k">namespace</span> <span class="n">muduo</span><span class="o">::</span><span class="n">net</span><span class="p">;</span>
 
<span class="cm">/*
</span><span class="cm">该程序 主要是用来测试EventLoop 是否是 一个Thread一个EventLoop
</span><span class="cm">**/</span>
<span class="kt">void</span> <span class="nf">threadFunc</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;threadFunc(): pid = %d, tid = %d</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span>
        <span class="n">getpid</span><span class="p">(),</span> <span class="n">CurrentThread</span><span class="o">::</span><span class="n">tid</span><span class="p">());</span>
 
    <span class="n">EventLoop</span> <span class="n">loop</span><span class="p">;</span>
    <span class="n">loop</span><span class="p">.</span><span class="n">loop</span><span class="p">();</span>
<span class="p">}</span>
 
<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;main(): pid = %d, tid = %d</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span>
        <span class="n">getpid</span><span class="p">(),</span> <span class="n">CurrentThread</span><span class="o">::</span><span class="n">tid</span><span class="p">());</span>
 
    <span class="n">EventLoop</span> <span class="n">loop</span><span class="p">;</span>
 
    <span class="n">Thread</span> <span class="n">t</span><span class="p">(</span><span class="n">threadFunc</span><span class="p">);</span>
    <span class="n">t</span><span class="p">.</span><span class="n">start</span><span class="p">();</span>
 
    <span class="n">loop</span><span class="p">.</span><span class="n">loop</span><span class="p">();</span>
    <span class="n">t</span><span class="p">.</span><span class="n">join</span><span class="p">();</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div>
<h3 id="程序输出">程序输出</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-c++" data-lang="c++"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c++" data-lang="c++"><span class="p">[</span><span class="n">root</span><span class="err">@</span><span class="n">localhost</span> <span class="n">bin</span><span class="p">]</span><span class="cp"># ./reactor_test01
</span><span class="cp"></span><span class="n">main</span><span class="p">()</span><span class="o">:</span> <span class="n">pid</span> <span class="o">=</span> <span class="mi">2724</span><span class="p">,</span> <span class="n">tid</span> <span class="o">=</span> <span class="mi">2724</span>
<span class="mi">20131018</span> <span class="mo">04</span><span class="o">:</span><span class="mi">12</span><span class="o">:</span><span class="mf">55.305234</span><span class="n">Z</span>  <span class="mi">2724</span> <span class="n">TRACE</span> <span class="n">EventLoop</span> <span class="n">EventLoop</span> <span class="n">created</span> <span class="mh">0xBFA6B2C0</span> <span class="n">in</span> <span class="kr">thread</span> <span class="mi">2724</span> <span class="o">-</span> <span class="n">EventLoop</span><span class="p">.</span><span class="nl">cc</span><span class="p">:</span><span class="mi">36</span>
<span class="mi">20131018</span> <span class="mo">04</span><span class="o">:</span><span class="mi">12</span><span class="o">:</span><span class="mf">55.305599</span><span class="n">Z</span>  <span class="mi">2724</span> <span class="n">TRACE</span> <span class="n">loop</span> <span class="n">EventLoop</span> <span class="mh">0xBFA6B2C0</span> <span class="n">start</span> <span class="n">looping</span> <span class="o">-</span> <span class="n">EventLoop</span><span class="p">.</span><span class="nl">cc</span><span class="p">:</span><span class="mi">62</span>
<span class="n">threadFunc</span><span class="p">()</span><span class="o">:</span> <span class="n">pid</span> <span class="o">=</span> <span class="mi">2724</span><span class="p">,</span> <span class="n">tid</span> <span class="o">=</span> <span class="mi">2725</span>
<span class="mi">20131018</span> <span class="mo">04</span><span class="o">:</span><span class="mi">12</span><span class="o">:</span><span class="mf">55.305792</span><span class="n">Z</span>  <span class="mi">2725</span> <span class="n">TRACE</span> <span class="n">EventLoop</span> <span class="n">EventLoop</span> <span class="n">created</span> <span class="mh">0xB77E0068</span> <span class="n">in</span> <span class="kr">thread</span> <span class="mi">2725</span> <span class="o">-</span> <span class="n">EventLoop</span><span class="p">.</span><span class="nl">cc</span><span class="p">:</span><span class="mi">36</span>
<span class="mi">20131018</span> <span class="mo">04</span><span class="o">:</span><span class="mi">12</span><span class="o">:</span><span class="mf">55.305809</span><span class="n">Z</span>  <span class="mi">2725</span> <span class="n">TRACE</span> <span class="n">loop</span> <span class="n">EventLoop</span> <span class="mh">0xB77E0068</span> <span class="n">start</span> <span class="n">looping</span> <span class="o">-</span> <span class="n">EventLoop</span><span class="p">.</span><span class="nl">cc</span><span class="p">:</span><span class="mi">62</span>
<span class="mi">20131018</span> <span class="mo">04</span><span class="o">:</span><span class="mi">13</span><span class="o">:</span><span class="mf">00.321713</span><span class="n">Z</span>  <span class="mi">2724</span> <span class="n">TRACE</span> <span class="n">loop</span> <span class="n">EventLoop</span> <span class="mh">0xBFA6B2C0</span> <span class="n">stop</span> <span class="n">looping</span> <span class="o">-</span> <span class="n">EventLoop</span><span class="p">.</span><span class="nl">cc</span><span class="p">:</span><span class="mi">66</span>
<span class="mi">20131018</span> <span class="mo">04</span><span class="o">:</span><span class="mi">13</span><span class="o">:</span><span class="mf">00.321779</span><span class="n">Z</span>  <span class="mi">2725</span> <span class="n">TRACE</span> <span class="n">loop</span> <span class="n">EventLoop</span> <span class="mh">0xB77E0068</span> <span class="n">stop</span> <span class="n">looping</span> <span class="o">-</span> <span class="n">EventLoop</span><span class="p">.</span><span class="nl">cc</span><span class="p">:</span><span class="mi">66</span>
<span class="p">[</span><span class="n">root</span><span class="err">@</span><span class="n">localhost</span> <span class="n">bin</span><span class="p">]</span><span class="cp">#
</span></code></pre></td></tr></table>
</div>
</div>
<h3 id="测试程序2">测试程序2</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-c++" data-lang="c++"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c++" data-lang="c++"><span class="cp">#include</span> <span class="cpf">&lt;muduo/net/EventLoop.h&gt;</span><span class="cp">
</span><span class="cp"></span> 
<span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
</span><span class="cp"></span><span class="cm">/**
</span><span class="cm">该程序主要用来测试，多个线程使用同一个eventloop时，程序将会错误终止！！
</span><span class="cm">**/</span>
<span class="k">using</span> <span class="k">namespace</span> <span class="n">muduo</span><span class="p">;</span>
<span class="k">using</span> <span class="k">namespace</span> <span class="n">muduo</span><span class="o">::</span><span class="n">net</span><span class="p">;</span>
 
<span class="n">EventLoop</span><span class="o">*</span> <span class="n">g_loop</span><span class="p">;</span>
 
<span class="kt">void</span> <span class="nf">threadFunc</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">g_loop</span><span class="o">-&gt;</span><span class="n">loop</span><span class="p">();</span>
<span class="p">}</span>
 
<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">EventLoop</span> <span class="n">loop</span><span class="p">;</span>
    <span class="n">g_loop</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">loop</span><span class="p">;</span>
    <span class="n">Thread</span> <span class="n">t</span><span class="p">(</span><span class="n">threadFunc</span><span class="p">);</span>
    <span class="n">t</span><span class="p">.</span><span class="n">start</span><span class="p">();</span>
    <span class="n">t</span><span class="p">.</span><span class="n">join</span><span class="p">();</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div>
<p>程序输出</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></pre></td>
<td class="lntd">
<pre class="chroma">[root@localhost bin]# ./reactor_test02
20131018 04:15:09.010234Z  2730 TRACE EventLoop EventLoop created 0xBFD53730 in thread 2730 - EventLoop.cc:36
20131018 04:15:09.010768Z  2731 FATAL EventLoop::abortNotInLoopThread - EventLoop 0xBFD53730 was created in threadId_ = 2730, current thread id = 2731 - EventLoop.cc:72
Aborted
[root@localhost bin]#</pre></td></tr></table>
</div>
</div>
<h2 id="27-epollpoller">[27] EpollPoller</h2>

<p><center><img src="http://laohanlinux.github.io/images/img/blog/muduo-net-library-chapter-1/Untitled.png" alt="" /></center></p>

<h3 id="epollpoller的头文件">EpollPoller的头文件</h3>

<p>epollpller.h</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-c++" data-lang="c++"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c++" data-lang="c++"><span class="c1">// Copyright 2010, Shuo Chen.  All rights reserved.
</span><span class="c1">// http://code.google.com/p/muduo/
</span><span class="c1">//
</span><span class="c1">// Use of this source code is governed by a BSD-style license
</span><span class="c1">// that can be found in the License file.
</span><span class="c1"></span> 
<span class="c1">// Author: Shuo Chen (chenshuo at chenshuo dot com)
</span><span class="c1">//
</span><span class="c1">// This is an internal header file, you should not include this.
</span><span class="c1"></span> 
<span class="cp">#ifndef MUDUO_NET_POLLER_EPOLLPOLLER_H
</span><span class="cp">#define MUDUO_NET_POLLER_EPOLLPOLLER_H
</span><span class="cp"></span> 
<span class="cp">#include</span> <span class="cpf">&lt;muduo/net/Poller.h&gt;</span><span class="cp">
</span><span class="cp"></span> 
<span class="cp">#include</span> <span class="cpf">&lt;map&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;vector&gt;</span><span class="cp">
</span><span class="cp"></span> 
<span class="k">struct</span> <span class="n">epoll_event</span><span class="p">;</span>
 
<span class="k">namespace</span> <span class="n">muduo</span>
<span class="p">{</span>
<span class="k">namespace</span> <span class="n">net</span>
<span class="p">{</span>
 
<span class="c1">///
</span><span class="c1">/// IO Multiplexing with epoll(4).
</span><span class="c1">///
</span><span class="c1"></span><span class="k">class</span><span class="err"> </span><span class="nc">EPollPoller</span> <span class="o">:</span> <span class="k">public</span> <span class="n">Poller</span>
<span class="p">{</span>
 <span class="k">public</span><span class="o">:</span>
  <span class="n">EPollPoller</span><span class="p">(</span><span class="n">EventLoop</span><span class="o">*</span> <span class="n">loop</span><span class="p">);</span>
  <span class="k">virtual</span> <span class="o">~</span><span class="n">EPollPoller</span><span class="p">();</span>
  <span class="c1">// timeoutMs 超时事件
</span><span class="c1"></span>  <span class="c1">// activeChannels活动通道
</span><span class="c1"></span>  <span class="k">virtual</span> <span class="n">Timestamp</span> <span class="nf">poll</span><span class="p">(</span><span class="kt">int</span> <span class="n">timeoutMs</span><span class="p">,</span> <span class="n">ChannelList</span><span class="o">*</span> <span class="n">activeChannels</span><span class="p">);</span>
  <span class="c1">//更新通道
</span><span class="c1"></span>  <span class="k">virtual</span> <span class="kt">void</span> <span class="nf">updateChannel</span><span class="p">(</span><span class="n">Channel</span><span class="o">*</span> <span class="n">channel</span><span class="p">);</span>
  <span class="c1">//移除通道
</span><span class="c1"></span>  <span class="k">virtual</span> <span class="kt">void</span> <span class="nf">removeChannel</span><span class="p">(</span><span class="n">Channel</span><span class="o">*</span> <span class="n">channel</span><span class="p">);</span>
 
 <span class="k">private</span><span class="o">:</span>
  <span class="c1">// EventListd的初始值
</span><span class="c1"></span>  <span class="k">static</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">kInitEventListSize</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
 
  <span class="kt">void</span> <span class="nf">fillActiveChannels</span><span class="p">(</span><span class="kt">int</span> <span class="n">numEvents</span><span class="p">,</span>
                          <span class="n">ChannelList</span><span class="o">*</span> <span class="n">activeChannels</span><span class="p">)</span> <span class="k">const</span><span class="p">;</span>
  <span class="c1">//更新
</span><span class="c1"></span>  <span class="kt">void</span> <span class="nf">update</span><span class="p">(</span><span class="kt">int</span> <span class="n">operation</span><span class="p">,</span> <span class="n">Channel</span><span class="o">*</span> <span class="n">channel</span><span class="p">);</span>
 
  <span class="k">typedef</span> <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="k">struct</span> <span class="n">epoll_event</span><span class="o">&gt;</span> <span class="n">EventList</span><span class="p">;</span>
 
  <span class="k">typedef</span> <span class="n">std</span><span class="o">::</span><span class="n">map</span><span class="o">&lt;</span><span class="kt">int</span><span class="p">,</span> <span class="n">Channel</span><span class="o">*&gt;</span> <span class="n">ChannelMap</span><span class="p">;</span>
 
  <span class="c1">//文件描述符 = epoll_create1(EPOLL_CLOEXEC)，用来表示要关注事件的fd的集合的描述符
</span><span class="c1"></span>  <span class="kt">int</span> <span class="n">epollfd_</span><span class="p">;</span>
  <span class="c1">// epoll_wait返回的活动的通道channelList
</span><span class="c1"></span>  <span class="n">EventList</span> <span class="n">events_</span><span class="p">;</span>
  <span class="c1">//通道map
</span><span class="c1"></span>  <span class="n">ChannelMap</span> <span class="n">channels_</span><span class="p">;</span>
<span class="p">};</span>
 
<span class="p">}</span>
<span class="p">}</span>
<span class="cp">#endif  </span><span class="c1">// MUDUO_NET_POLLER_EPOLLPOLLER_H
</span></code></pre></td></tr></table>
</div>
</div>
<h3 id="epollpoller的源文件">EpollPoller的源文件</h3>

<p>epollpoller.cc</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-c++" data-lang="c++"><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span><span class="lnt">177
</span><span class="lnt">178
</span><span class="lnt">179
</span><span class="lnt">180
</span><span class="lnt">181
</span><span class="lnt">182
</span><span class="lnt">183
</span><span class="lnt">184
</span><span class="lnt">185
</span><span class="lnt">186
</span><span class="lnt">187
</span><span class="lnt">188
</span><span class="lnt">189
</span><span class="lnt">190
</span><span class="lnt">191
</span><span class="lnt">192
</span><span class="lnt">193
</span><span class="lnt">194
</span><span class="lnt">195
</span><span class="lnt">196
</span><span class="lnt">197
</span><span class="lnt">198
</span><span class="lnt">199
</span><span class="lnt">200
</span><span class="lnt">201
</span><span class="lnt">202
</span><span class="lnt">203
</span><span class="lnt">204
</span><span class="lnt">205
</span><span class="lnt">206
</span><span class="lnt">207
</span><span class="lnt">208
</span><span class="lnt">209
</span><span class="lnt">210
</span><span class="lnt">211
</span><span class="lnt">212
</span><span class="lnt">213
</span><span class="lnt">214
</span><span class="lnt">215
</span><span class="lnt">216
</span><span class="lnt">217
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c++" data-lang="c++"><span class="c1">// Copyright 2010, Shuo Chen.  All rights reserved.
</span><span class="c1">// http://code.google.com/p/muduo/
</span><span class="c1">//
</span><span class="c1">// Use of this source code is governed by a BSD-style license
</span><span class="c1">// that can be found in the License file.
</span><span class="c1"></span> 
<span class="c1">// Author: Shuo Chen (chenshuo at chenshuo dot com)
</span><span class="c1"></span> 
<span class="cp">#include</span> <span class="cpf">&lt;muduo/net/poller/EPollPoller.h&gt;</span><span class="cp">
</span><span class="cp"></span> 
<span class="cp">#include</span> <span class="cpf">&lt;muduo/base/Logging.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;muduo/net/Channel.h&gt;</span><span class="cp">
</span><span class="cp"></span> 
<span class="cp">#include</span> <span class="cpf">&lt;boost/static_assert.hpp&gt;</span><span class="cp">
</span><span class="cp"></span> 
<span class="cp">#include</span> <span class="cpf">&lt;assert.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;errno.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;poll.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;sys/epoll.h&gt;</span><span class="cp">
</span><span class="cp"></span> 
<span class="k">using</span> <span class="k">namespace</span> <span class="n">muduo</span><span class="p">;</span>
<span class="k">using</span> <span class="k">namespace</span> <span class="n">muduo</span><span class="o">::</span><span class="n">net</span><span class="p">;</span>
 
<span class="c1">// On Linux, the constants of poll(2) and epoll(4)
</span><span class="c1">// are expected to be the same.
</span><span class="c1"></span><span class="n">BOOST_STATIC_ASSERT</span><span class="p">(</span><span class="n">EPOLLIN</span> <span class="o">==</span> <span class="n">POLLIN</span><span class="p">);</span>
<span class="n">BOOST_STATIC_ASSERT</span><span class="p">(</span><span class="n">EPOLLPRI</span> <span class="o">==</span> <span class="n">POLLPRI</span><span class="p">);</span>
<span class="n">BOOST_STATIC_ASSERT</span><span class="p">(</span><span class="n">EPOLLOUT</span> <span class="o">==</span> <span class="n">POLLOUT</span><span class="p">);</span>
<span class="n">BOOST_STATIC_ASSERT</span><span class="p">(</span><span class="n">EPOLLRDHUP</span> <span class="o">==</span> <span class="n">POLLRDHUP</span><span class="p">);</span>
<span class="n">BOOST_STATIC_ASSERT</span><span class="p">(</span><span class="n">EPOLLERR</span> <span class="o">==</span> <span class="n">POLLERR</span><span class="p">);</span>
<span class="n">BOOST_STATIC_ASSERT</span><span class="p">(</span><span class="n">EPOLLHUP</span> <span class="o">==</span> <span class="n">POLLHUP</span><span class="p">);</span>
 
<span class="k">namespace</span>
<span class="p">{</span>
<span class="k">const</span> <span class="kt">int</span> <span class="n">kNew</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span> <span class="c1">//新通道
</span><span class="c1"></span><span class="k">const</span> <span class="kt">int</span> <span class="n">kAdded</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="c1">//要关注的通道
</span><span class="c1"></span><span class="k">const</span> <span class="kt">int</span> <span class="n">kDeleted</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span> <span class="c1">//要删除的通道
</span><span class="c1"></span><span class="p">}</span>
 
<span class="n">EPollPoller</span><span class="o">::</span><span class="n">EPollPoller</span><span class="p">(</span><span class="n">EventLoop</span><span class="o">*</span> <span class="n">loop</span><span class="p">)</span>
  <span class="o">:</span> <span class="n">Poller</span><span class="p">(</span><span class="n">loop</span><span class="p">),</span>
    <span class="n">epollfd_</span><span class="p">(</span><span class="o">::</span><span class="n">epoll_create1</span><span class="p">(</span><span class="n">EPOLL_CLOEXEC</span><span class="p">)),</span>
    <span class="n">events_</span><span class="p">(</span><span class="n">kInitEventListSize</span><span class="p">)</span>
<span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">epollfd_</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">LOG_SYSFATAL</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;EPollPoller::EPollPoller&#34;</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>
 
<span class="n">EPollPoller</span><span class="o">::~</span><span class="n">EPollPoller</span><span class="p">()</span>
<span class="p">{</span>
  <span class="o">::</span><span class="n">close</span><span class="p">(</span><span class="n">epollfd_</span><span class="p">);</span>
<span class="p">}</span>
 
<span class="c1">// IO 线程
</span><span class="c1"></span><span class="n">Timestamp</span> <span class="n">EPollPoller</span><span class="o">::</span><span class="n">poll</span><span class="p">(</span><span class="kt">int</span> <span class="n">timeoutMs</span><span class="p">,</span> <span class="n">ChannelList</span><span class="o">*</span> <span class="n">activeChannels</span><span class="p">)</span>
<span class="p">{</span>
  <span class="c1">//监听事件的到来
</span><span class="c1"></span>  <span class="kt">int</span> <span class="n">numEvents</span> <span class="o">=</span> <span class="o">::</span><span class="n">epoll_wait</span><span class="p">(</span><span class="n">epollfd_</span><span class="p">,</span>
                               <span class="o">&amp;*</span><span class="n">events_</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span>
                               <span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="p">(</span><span class="n">events_</span><span class="p">.</span><span class="n">size</span><span class="p">()),</span>
                               <span class="n">timeoutMs</span><span class="p">);</span>
 
  <span class="n">Timestamp</span> <span class="nf">now</span><span class="p">(</span><span class="n">Timestamp</span><span class="o">::</span><span class="n">now</span><span class="p">());</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">numEvents</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">LOG_TRACE</span> <span class="o">&lt;&lt;</span> <span class="n">numEvents</span> <span class="o">&lt;&lt;</span> <span class="s">&#34; events happended&#34;</span><span class="p">;</span>
    <span class="cm">/*添加活动通道channel*/</span>
    <span class="n">fillActiveChannels</span><span class="p">(</span><span class="n">numEvents</span><span class="p">,</span> <span class="n">activeChannels</span><span class="p">);</span>
    <span class="c1">//如果活动通道的容器已满，则增加活动通道容器的容量
</span><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">implicit_cast</span><span class="o">&lt;</span><span class="n">size_t</span><span class="o">&gt;</span><span class="p">(</span><span class="n">numEvents</span><span class="p">)</span> <span class="o">==</span> <span class="n">events_</span><span class="p">.</span><span class="n">size</span><span class="p">())</span>
    <span class="p">{</span>
      <span class="n">events_</span><span class="p">.</span><span class="n">resize</span><span class="p">(</span><span class="n">events_</span><span class="p">.</span><span class="n">size</span><span class="p">()</span><span class="o">*</span><span class="mi">2</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">numEvents</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">LOG_TRACE</span> <span class="o">&lt;&lt;</span> <span class="s">&#34; nothing happended&#34;</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">else</span>
  <span class="p">{</span>
    <span class="n">LOG_SYSERR</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;EPollPoller::poll()&#34;</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="n">now</span><span class="p">;</span>
<span class="p">}</span>
 
<span class="cm">/*添加活动通道channel*/</span>
<span class="kt">void</span> <span class="n">EPollPoller</span><span class="o">::</span><span class="n">fillActiveChannels</span><span class="p">(</span><span class="kt">int</span> <span class="n">numEvents</span><span class="p">,</span>
                                     <span class="n">ChannelList</span><span class="o">*</span> <span class="n">activeChannels</span><span class="p">)</span> <span class="k">const</span>
<span class="p">{</span>
  <span class="n">assert</span><span class="p">(</span><span class="n">implicit_cast</span><span class="o">&lt;</span><span class="n">size_t</span><span class="o">&gt;</span><span class="p">(</span><span class="n">numEvents</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">events_</span><span class="p">.</span><span class="n">size</span><span class="p">());</span>
  <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">numEvents</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">Channel</span><span class="o">*</span> <span class="n">channel</span> <span class="o">=</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="n">Channel</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">events_</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">data</span><span class="p">.</span><span class="n">ptr</span><span class="p">);</span>
    <span class="c1">//如果是调试状态，则
</span><span class="c1"></span><span class="cp">#ifndef NDEBUG
</span><span class="cp"></span>    <span class="kt">int</span> <span class="n">fd</span> <span class="o">=</span> <span class="n">channel</span><span class="o">-&gt;</span><span class="n">fd</span><span class="p">();</span>
    <span class="n">ChannelMap</span><span class="o">::</span><span class="n">const_iterator</span> <span class="n">it</span> <span class="o">=</span> <span class="n">channels_</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="n">fd</span><span class="p">);</span>
    <span class="n">assert</span><span class="p">(</span><span class="n">it</span> <span class="o">!=</span> <span class="n">channels_</span><span class="p">.</span><span class="n">end</span><span class="p">());</span>
    <span class="n">assert</span><span class="p">(</span><span class="n">it</span><span class="o">-&gt;</span><span class="n">second</span> <span class="o">==</span> <span class="n">channel</span><span class="p">);</span>
<span class="cp">#endif
</span><span class="cp"></span>    <span class="c1">//否则直接跳到这里
</span><span class="c1"></span>    <span class="c1">// 设置channel的“可用事件”
</span><span class="c1"></span>    <span class="n">channel</span><span class="o">-&gt;</span><span class="n">set_revents</span><span class="p">(</span><span class="n">events_</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">events</span><span class="p">);</span>
    <span class="c1">// 加入活动通道容器
</span><span class="c1"></span>    <span class="n">activeChannels</span><span class="o">-&gt;</span><span class="n">push_back</span><span class="p">(</span><span class="n">channel</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>
 
<span class="c1">//更新某个通道 channel
</span><span class="c1"></span><span class="kt">void</span> <span class="n">EPollPoller</span><span class="o">::</span><span class="n">updateChannel</span><span class="p">(</span><span class="n">Channel</span><span class="o">*</span> <span class="n">channel</span><span class="p">)</span>
<span class="p">{</span>
  <span class="c1">//断言 在IO线程中
</span><span class="c1"></span>  <span class="n">Poller</span><span class="o">::</span><span class="n">assertInLoopThread</span><span class="p">();</span>
  <span class="n">LOG_TRACE</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;fd = &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">channel</span><span class="o">-&gt;</span><span class="n">fd</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="s">&#34; events = &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">channel</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">();</span>
 
  <span class="c1">//channel 的默认值是 -1 ， ----&gt;&gt;channel class
</span><span class="c1"></span>  <span class="k">const</span> <span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="n">channel</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">();</span>
  <span class="c1">// kNew 表示有新的通道要增加，kDeleted表示将已不关注事件的fd重新关注事件，及时重新加到epollfd_中去
</span><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="n">index</span> <span class="o">==</span> <span class="n">kNew</span> <span class="o">||</span> <span class="n">index</span> <span class="o">==</span> <span class="n">kDeleted</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="c1">// a new one, add with EPOLL_CTL_ADD
</span><span class="c1"></span>    <span class="kt">int</span> <span class="n">fd</span> <span class="o">=</span> <span class="n">channel</span><span class="o">-&gt;</span><span class="n">fd</span><span class="p">();</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">index</span> <span class="o">==</span> <span class="n">kNew</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="c1">//如果是新的channel，那么在channels_里面是找不到的
</span><span class="c1"></span>      <span class="n">assert</span><span class="p">(</span><span class="n">channels_</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="n">fd</span><span class="p">)</span> <span class="o">==</span> <span class="n">channels_</span><span class="p">.</span><span class="n">end</span><span class="p">());</span>
      <span class="c1">//添加到channels_中
</span><span class="c1"></span>      <span class="n">channels_</span><span class="p">[</span><span class="n">fd</span><span class="p">]</span> <span class="o">=</span> <span class="n">channel</span><span class="p">;</span>
    <span class="p">}</span>
 
    <span class="k">else</span> <span class="c1">// index == kDeleted
</span><span class="c1"></span>    <span class="p">{</span>
      <span class="n">assert</span><span class="p">(</span><span class="n">channels_</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="n">fd</span><span class="p">)</span> <span class="o">!=</span> <span class="n">channels_</span><span class="p">.</span><span class="n">end</span><span class="p">());</span>
      <span class="n">assert</span><span class="p">(</span><span class="n">channels_</span><span class="p">[</span><span class="n">fd</span><span class="p">]</span> <span class="o">==</span> <span class="n">channel</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="c1">//
</span><span class="c1"></span>    <span class="n">channel</span><span class="o">-&gt;</span><span class="n">set_index</span><span class="p">(</span><span class="n">kAdded</span><span class="p">);</span>
    <span class="n">update</span><span class="p">(</span><span class="n">EPOLL_CTL_ADD</span><span class="p">,</span> <span class="n">channel</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">else</span>
  <span class="p">{</span>
    <span class="c1">// update existing one with EPOLL_CTL_MOD/DEL
</span><span class="c1"></span>    <span class="kt">int</span> <span class="n">fd</span> <span class="o">=</span> <span class="n">channel</span><span class="o">-&gt;</span><span class="n">fd</span><span class="p">();</span>
    <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">fd</span><span class="p">;</span>
    <span class="n">assert</span><span class="p">(</span><span class="n">channels_</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="n">fd</span><span class="p">)</span> <span class="o">!=</span> <span class="n">channels_</span><span class="p">.</span><span class="n">end</span><span class="p">());</span>
    <span class="n">assert</span><span class="p">(</span><span class="n">channels_</span><span class="p">[</span><span class="n">fd</span><span class="p">]</span> <span class="o">==</span> <span class="n">channel</span><span class="p">);</span>
    <span class="c1">//断言已经在channels_里面了，并且已在epollfd_中
</span><span class="c1"></span>    <span class="n">assert</span><span class="p">(</span><span class="n">index</span> <span class="o">==</span> <span class="n">kAdded</span><span class="p">);</span>
 
    <span class="c1">//剔除channel的关注事件
</span><span class="c1"></span>    <span class="c1">//如果channel没有事件关注了，就把他从epollfd_中剔除掉
</span><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">isNoneEvent</span><span class="p">())</span>
    <span class="p">{</span>
      <span class="n">update</span><span class="p">(</span><span class="n">EPOLL_CTL_DEL</span><span class="p">,</span> <span class="n">channel</span><span class="p">);</span>
      <span class="c1">//更新index = kDeleted
</span><span class="c1"></span>      <span class="n">channel</span><span class="o">-&gt;</span><span class="n">set_index</span><span class="p">(</span><span class="n">kDeleted</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">else</span>
    <span class="p">{</span>
      <span class="n">update</span><span class="p">(</span><span class="n">EPOLL_CTL_MOD</span><span class="p">,</span> <span class="n">channel</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
 
<span class="c1">// 移除channel
</span><span class="c1"></span><span class="kt">void</span> <span class="n">EPollPoller</span><span class="o">::</span><span class="n">removeChannel</span><span class="p">(</span><span class="n">Channel</span><span class="o">*</span> <span class="n">channel</span><span class="p">)</span>
<span class="p">{</span>
  <span class="c1">//断言实在IO线程中
</span><span class="c1"></span>  <span class="n">Poller</span><span class="o">::</span><span class="n">assertInLoopThread</span><span class="p">();</span>
  <span class="kt">int</span> <span class="n">fd</span> <span class="o">=</span> <span class="n">channel</span><span class="o">-&gt;</span><span class="n">fd</span><span class="p">();</span>
  <span class="n">LOG_TRACE</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;fd = &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">fd</span><span class="p">;</span>
  <span class="c1">//断言能在channels_里面找到channel
</span><span class="c1"></span>  <span class="n">assert</span><span class="p">(</span><span class="n">channels_</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="n">fd</span><span class="p">)</span> <span class="o">!=</span> <span class="n">channels_</span><span class="p">.</span><span class="n">end</span><span class="p">());</span>
  <span class="n">assert</span><span class="p">(</span><span class="n">channels_</span><span class="p">[</span><span class="n">fd</span><span class="p">]</span> <span class="o">==</span> <span class="n">channel</span><span class="p">);</span>
  <span class="c1">//断言所要移除的channel已经没有事件关注了，但是此时在event_里面可能还有他的记录
</span><span class="c1"></span>  <span class="n">assert</span><span class="p">(</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">isNoneEvent</span><span class="p">());</span>
  <span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="n">channel</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">();</span>
  <span class="c1">//断言
</span><span class="c1"></span>  <span class="n">assert</span><span class="p">(</span><span class="n">index</span> <span class="o">==</span> <span class="n">kAdded</span> <span class="o">||</span> <span class="n">index</span> <span class="o">==</span> <span class="n">kDeleted</span><span class="p">);</span>
  <span class="c1">//真正从channels_里面删除掉channel
</span><span class="c1"></span>  <span class="n">size_t</span> <span class="n">n</span> <span class="o">=</span> <span class="n">channels_</span><span class="p">.</span><span class="n">erase</span><span class="p">(</span><span class="n">fd</span><span class="p">);</span>
  <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">n</span><span class="p">;</span>
  <span class="n">assert</span><span class="p">(</span><span class="n">n</span> <span class="o">==</span> <span class="mi">1</span><span class="p">);</span>
 
  <span class="c1">//从event_中剔除channel
</span><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="n">index</span> <span class="o">==</span> <span class="n">kAdded</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">update</span><span class="p">(</span><span class="n">EPOLL_CTL_DEL</span><span class="p">,</span> <span class="n">channel</span><span class="p">);</span>
  <span class="p">}</span>
 
  <span class="c1">// channel现在变成新的channel了
</span><span class="c1"></span>  <span class="n">channel</span><span class="o">-&gt;</span><span class="n">set_index</span><span class="p">(</span><span class="n">kNew</span><span class="p">);</span>
<span class="p">}</span>
 
<span class="kt">void</span> <span class="n">EPollPoller</span><span class="o">::</span><span class="n">update</span><span class="p">(</span><span class="kt">int</span> <span class="n">operation</span><span class="p">,</span> <span class="n">Channel</span><span class="o">*</span> <span class="n">channel</span><span class="p">)</span>
<span class="p">{</span>
  <span class="k">struct</span> <span class="n">epoll_event</span> <span class="n">event</span><span class="p">;</span>
  <span class="n">bzero</span><span class="p">(</span><span class="o">&amp;</span><span class="n">event</span><span class="p">,</span> <span class="k">sizeof</span> <span class="n">event</span><span class="p">);</span>
  <span class="n">event</span><span class="p">.</span><span class="n">events</span> <span class="o">=</span> <span class="n">channel</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">();</span>
  <span class="n">event</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">ptr</span> <span class="o">=</span> <span class="n">channel</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">fd</span> <span class="o">=</span> <span class="n">channel</span><span class="o">-&gt;</span><span class="n">fd</span><span class="p">();</span>
  <span class="c1">//更新操作
</span><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="o">::</span><span class="n">epoll_ctl</span><span class="p">(</span><span class="n">epollfd_</span><span class="p">,</span> <span class="n">operation</span><span class="p">,</span> <span class="n">fd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">event</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="c1">//写入日志
</span><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">operation</span> <span class="o">==</span> <span class="n">EPOLL_CTL_DEL</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">LOG_SYSERR</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;epoll_ctl op=&#34;</span> <span class="o">&lt;&lt;</span> <span class="n">operation</span> <span class="o">&lt;&lt;</span> <span class="s">&#34; fd=&#34;</span> <span class="o">&lt;&lt;</span> <span class="n">fd</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">else</span>
    <span class="p">{</span>
      <span class="n">LOG_SYSFATAL</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;epoll_ctl op=&#34;</span> <span class="o">&lt;&lt;</span> <span class="n">operation</span> <span class="o">&lt;&lt;</span> <span class="s">&#34; fd=&#34;</span> <span class="o">&lt;&lt;</span> <span class="n">fd</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div>
<h3 id="测试程序">测试程序</h3>

<p>Reactor_test03.cc</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-c++" data-lang="c++"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c++" data-lang="c++"><span class="cp">#include</span> <span class="cpf">&lt;muduo/net/Channel.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;muduo/net/EventLoop.h&gt;</span><span class="cp">
</span><span class="cp"></span> 
<span class="cp">#include</span> <span class="cpf">&lt;boost/bind.hpp&gt;</span><span class="cp">
</span><span class="cp"></span> 
<span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;sys/timerfd.h&gt;</span><span class="cp">
</span><span class="cp"></span> 
<span class="k">using</span> <span class="k">namespace</span> <span class="n">muduo</span><span class="p">;</span>
<span class="k">using</span> <span class="k">namespace</span> <span class="n">muduo</span><span class="o">::</span><span class="n">net</span><span class="p">;</span>
 
<span class="n">EventLoop</span><span class="o">*</span> <span class="n">g_loop</span><span class="p">;</span>
<span class="kt">int</span> <span class="n">timerfd</span><span class="p">;</span>
 
<span class="kt">void</span> <span class="nf">timeout</span><span class="p">(</span><span class="n">Timestamp</span> <span class="n">receiveTime</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;Timeout!</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
    <span class="n">uint64_t</span> <span class="n">howmany</span><span class="p">;</span>
    <span class="o">::</span><span class="n">read</span><span class="p">(</span><span class="n">timerfd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">howmany</span><span class="p">,</span> <span class="k">sizeof</span> <span class="n">howmany</span><span class="p">);</span>
    <span class="n">g_loop</span><span class="o">-&gt;</span><span class="n">quit</span><span class="p">();</span>
<span class="p">}</span>
 
<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">EventLoop</span> <span class="n">loop</span><span class="p">;</span>
    <span class="n">g_loop</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">loop</span><span class="p">;</span>
 
    <span class="n">timerfd</span> <span class="o">=</span> <span class="o">::</span><span class="n">timerfd_create</span><span class="p">(</span><span class="n">CLOCK_MONOTONIC</span><span class="p">,</span> <span class="n">TFD_NONBLOCK</span> <span class="o">|</span> <span class="n">TFD_CLOEXEC</span><span class="p">);</span>
    <span class="n">Channel</span> <span class="n">channel</span><span class="p">(</span><span class="o">&amp;</span><span class="n">loop</span><span class="p">,</span> <span class="n">timerfd</span><span class="p">);</span>
    <span class="n">channel</span><span class="p">.</span><span class="n">setReadCallback</span><span class="p">(</span><span class="n">boost</span><span class="o">::</span><span class="n">bind</span><span class="p">(</span><span class="n">timeout</span><span class="p">,</span> <span class="n">_1</span><span class="p">));</span>
    <span class="n">channel</span><span class="p">.</span><span class="n">enableReading</span><span class="p">();</span>
 
    <span class="k">struct</span> <span class="n">itimerspec</span> <span class="n">howlong</span><span class="p">;</span>
    <span class="n">bzero</span><span class="p">(</span><span class="o">&amp;</span><span class="n">howlong</span><span class="p">,</span> <span class="k">sizeof</span> <span class="n">howlong</span><span class="p">);</span>
    <span class="n">howlong</span><span class="p">.</span><span class="n">it_value</span><span class="p">.</span><span class="n">tv_sec</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="o">::</span><span class="n">timerfd_settime</span><span class="p">(</span><span class="n">timerfd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">howlong</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
 
    <span class="n">loop</span><span class="p">.</span><span class="n">loop</span><span class="p">();</span>
 
    <span class="o">::</span><span class="n">close</span><span class="p">(</span><span class="n">timerfd</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div>
<p>程序输出</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-sh" data-lang="sh"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-sh" data-lang="sh"><span class="o">[</span>root@localhost bin<span class="o">]</span><span class="c1"># ./reactor_test03</span>
<span class="m">20131020</span> <span class="m">02</span>:24:05.657327Z  <span class="m">4009</span> TRACE EventLoop EventLoop created 0xBFD2AAD4 in thread <span class="m">4009</span> - EventLoop.cc:42
<span class="m">20131020</span> <span class="m">02</span>:24:05.657513Z  <span class="m">4009</span> TRACE updateChannel <span class="nv">fd</span> <span class="o">=</span> <span class="m">4</span> <span class="nv">events</span> <span class="o">=</span> <span class="m">3</span> - EPollPoller.cc:104
<span class="m">20131020</span> <span class="m">02</span>:24:05.657554Z  <span class="m">4009</span> TRACE loop EventLoop 0xBFD2AAD4 start looping - EventLoop.cc:68
<span class="m">20131020</span> <span class="m">02</span>:24:06.658756Z  <span class="m">4009</span> TRACE poll <span class="m">1</span> events happended - EPollPoller.cc:65
<span class="m">20131020</span> <span class="m">02</span>:24:06.658972Z  <span class="m">4009</span> TRACE printActiveChannels <span class="o">{</span><span class="m">4</span>: IN <span class="o">}</span>  - EventLoop.cc:139
Timeout!
<span class="m">20131020</span> <span class="m">02</span>:24:06.659008Z  <span class="m">4009</span> TRACE loop EventLoop 0xBFD2AAD4 stop looping - EventLoop.cc:93
<span class="o">[</span>root@localhost bin<span class="o">]</span>#</code></pre></td></tr></table>
</div>
</div>
<h2 id="28-muduo的定时器由三个类实现-timerid-定时器-timer-最上层的抽象-timerqueue-定时器的列表">[28] muduo的定时器由三个类实现，TimerId（定时器）、Timer(最上层的抽象)、TimerQueue（定时器的列表）</h2>

<ul>
<li>muduo的定时器由三个类实现，TimerId（定时器）、Timer(最上层的抽象,并没有调用定时器的相关函数)、TimerQueue（定时器的列表），用户只能看到第一个类，其它两个都是内部实现细节</li>
<li>TimerQueue的接口很简单，只有两个函数addTimer和cancel。实际上这两个函数也没有向外部开发，访问它要通过EventLoop的相关方法</li>

<li><p>EventLoop</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></pre></td>
<td class="lntd">
<pre class="chroma">   runAt    在某个时刻运行定时器------&gt;TimerQueue.addTimer

   runAfter    过一段时间运行定时器----&gt;TimeQueue.addTimer

   runEvery    每隔一段时间运行定时器-&gt;TimerQueue.addTimer

   cancel    取消定时器 ----》TimeQueue.cancal</pre></td></tr></table>
</div>
</div></li>

<li><p>TimerQueue数据结构的选择，能快速根据当前时间找到已到期的定时器，也要高效的添加和删除Timer，因而可以用二叉搜索树，用map或者set;如果选择map的话，是有问题的，可能TimeQueue里面有时间戳是一样的，但定时器timer*是不一样的，可以考虑multimap，不过最后还是不要使用</p></li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-c++" data-lang="c++"><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c++" data-lang="c++"> <span class="k">typedef</span> <span class="n">std</span><span class="o">::</span><span class="n">pair</span><span class="o">&lt;</span><span class="n">Timestamp</span><span class="p">,</span> <span class="n">Timer</span><span class="o">*&gt;</span> <span class="n">Entry</span><span class="p">;</span>
 <span class="k">typedef</span> <span class="n">std</span><span class="o">::</span><span class="n">set</span><span class="o">&lt;</span><span class="n">Entry</span><span class="o">&gt;</span> <span class="n">TimerList</span><span class="p">;</span>
</code></pre></td></tr></table>
</div>
</div>
<p><center><img src="http://laohanlinux.github.io/images/img/blog/muduo-net-library-chapter-1/%E5%AE%9A%E6%97%B6%E5%99%A828-2.png" alt="" /></center></p>

<h3 id="时序图">时序图</h3>

<p><center><img src="http://laohanlinux.github.io/images/img/blog/muduo-net-library-chapter-1/%E5%AE%9A%E6%97%B6%E5%99%A828-1.png" alt="" /></center></p>

<h3 id="timer头文件">Timer头文件</h3>

<p>timer.h</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-c++" data-lang="c++"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c++" data-lang="c++"><span class="c1">// Copyright 2010, Shuo Chen.  All rights reserved.
</span><span class="c1">// http://code.google.com/p/muduo/
</span><span class="c1">//
</span><span class="c1">// Use of this source code is governed by a BSD-style license
</span><span class="c1">// that can be found in the License file.
</span><span class="c1"></span> 
<span class="c1">// Author: Shuo Chen (chenshuo at chenshuo dot com)
</span><span class="c1">//
</span><span class="c1">// This is an internal header file, you should not include this.
</span><span class="c1"></span> 
<span class="cp">#ifndef MUDUO_NET_TIMER_H
</span><span class="cp">#define MUDUO_NET_TIMER_H
</span><span class="cp"></span> 
<span class="cp">#include</span> <span class="cpf">&lt;boost/noncopyable.hpp&gt;</span><span class="cp">
</span><span class="cp"></span> 
<span class="cp">#include</span> <span class="cpf">&lt;muduo/base/Atomic.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;muduo/base/Timestamp.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;muduo/net/Callbacks.h&gt;</span><span class="cp">
</span><span class="cp"></span> 
<span class="k">namespace</span> <span class="n">muduo</span>
<span class="p">{</span>
<span class="k">namespace</span> <span class="n">net</span>
<span class="p">{</span>
<span class="c1">///
</span><span class="c1">/// Internal class for timer event.
</span><span class="c1">///
</span><span class="c1"></span><span class="k">class</span><span class="err"> </span><span class="nc">Timer</span> <span class="o">:</span> <span class="n">boost</span><span class="o">::</span><span class="n">noncopyable</span>
<span class="p">{</span>
 <span class="k">public</span><span class="o">:</span>
  <span class="n">Timer</span><span class="p">(</span><span class="k">const</span> <span class="n">TimerCallback</span><span class="o">&amp;</span> <span class="n">cb</span><span class="p">,</span> <span class="n">Timestamp</span> <span class="n">when</span><span class="p">,</span> <span class="kt">double</span> <span class="n">interval</span><span class="p">)</span>
    <span class="o">:</span> <span class="n">callback_</span><span class="p">(</span><span class="n">cb</span><span class="p">),</span>
      <span class="n">expiration_</span><span class="p">(</span><span class="n">when</span><span class="p">),</span>
      <span class="n">interval_</span><span class="p">(</span><span class="n">interval</span><span class="p">),</span>
      <span class="n">repeat_</span><span class="p">(</span><span class="n">interval</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">),</span>
      <span class="n">sequence_</span><span class="p">(</span><span class="n">s_numCreated_</span><span class="p">.</span><span class="n">incrementAndGet</span><span class="p">())</span>
  <span class="p">{</span> <span class="p">}</span>
 
  <span class="kt">void</span> <span class="n">run</span><span class="p">()</span> <span class="k">const</span>
  <span class="p">{</span>
    <span class="n">callback_</span><span class="p">();</span>
  <span class="p">}</span>
 
  <span class="n">Timestamp</span> <span class="n">expiration</span><span class="p">()</span> <span class="k">const</span>  <span class="p">{</span> <span class="k">return</span> <span class="n">expiration_</span><span class="p">;</span> <span class="p">}</span>
  <span class="kt">bool</span> <span class="n">repeat</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span> <span class="k">return</span> <span class="n">repeat_</span><span class="p">;</span> <span class="p">}</span>
  <span class="n">int64_t</span> <span class="n">sequence</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span> <span class="k">return</span> <span class="n">sequence_</span><span class="p">;</span> <span class="p">}</span>
 
  <span class="kt">void</span> <span class="n">restart</span><span class="p">(</span><span class="n">Timestamp</span> <span class="n">now</span><span class="p">);</span>
 
  <span class="k">static</span> <span class="n">int64_t</span> <span class="nf">numCreated</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="n">s_numCreated_</span><span class="p">.</span><span class="n">get</span><span class="p">();</span> <span class="p">}</span>
 
 <span class="k">private</span><span class="o">:</span>
  <span class="k">const</span> <span class="n">TimerCallback</span> <span class="n">callback_</span><span class="p">;</span>        <span class="c1">// 定时器回调函数
</span><span class="c1"></span>  <span class="n">Timestamp</span> <span class="n">expiration_</span><span class="p">;</span>                <span class="c1">// 下一次的超时时刻
</span><span class="c1"></span>  <span class="k">const</span> <span class="kt">double</span> <span class="n">interval_</span><span class="p">;</span>               <span class="c1">// 超时时间间隔，如果是一次性定时器，该值为0
</span><span class="c1"></span>  <span class="k">const</span> <span class="kt">bool</span> <span class="n">repeat_</span><span class="p">;</span>                   <span class="c1">// 是否重复
</span><span class="c1"></span>  <span class="k">const</span> <span class="n">int64_t</span> <span class="n">sequence_</span><span class="p">;</span>              <span class="c1">// 定时器序号
</span><span class="c1"></span> 
  <span class="k">static</span> <span class="n">AtomicInt64</span> <span class="n">s_numCreated_</span><span class="p">;</span>     <span class="c1">// 定时器计数，当前已经创建的定时器数量
</span><span class="c1"></span><span class="p">};</span>
<span class="p">}</span>
<span class="p">}</span>
<span class="cp">#endif  </span><span class="c1">// MUDUO_NET_TIMER_H
</span></code></pre></td></tr></table>
</div>
</div>
<h3 id="timer源文件">Timer源文件</h3>

<p>timer.cc</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-c++" data-lang="c++"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c++" data-lang="c++"><span class="c1">// Copyright 2010, Shuo Chen.  All rights reserved.
</span><span class="c1">// http://code.google.com/p/muduo/
</span><span class="c1">//
</span><span class="c1">// Use of this source code is governed by a BSD-style license
</span><span class="c1">// that can be found in the License file.
</span><span class="c1"></span> 
<span class="c1">// Author: Shuo Chen (chenshuo at chenshuo dot com)
</span><span class="c1"></span> 
<span class="cp">#include</span> <span class="cpf">&lt;muduo/net/Timer.h&gt;</span><span class="cp">
</span><span class="cp"></span> 
<span class="k">using</span> <span class="k">namespace</span> <span class="n">muduo</span><span class="p">;</span>
<span class="k">using</span> <span class="k">namespace</span> <span class="n">muduo</span><span class="o">::</span><span class="n">net</span><span class="p">;</span>
 
<span class="n">AtomicInt64</span> <span class="n">Timer</span><span class="o">::</span><span class="n">s_numCreated_</span><span class="p">;</span>
 
<span class="kt">void</span> <span class="n">Timer</span><span class="o">::</span><span class="n">restart</span><span class="p">(</span><span class="n">Timestamp</span> <span class="n">now</span><span class="p">)</span>
<span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">repeat_</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="c1">// 重新计算下一个超时时刻
</span><span class="c1"></span>    <span class="n">expiration_</span> <span class="o">=</span> <span class="n">addTime</span><span class="p">(</span><span class="n">now</span><span class="p">,</span> <span class="n">interval_</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">else</span>
  <span class="p">{</span>
    <span class="n">expiration_</span> <span class="o">=</span> <span class="n">Timestamp</span><span class="o">::</span><span class="n">invalid</span><span class="p">();</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div>
<h3 id="timerid头文件">TimerId头文件</h3>

<p>timerid.h</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-c++" data-lang="c++"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c++" data-lang="c++"><span class="c1">// Copyright 2010, Shuo Chen.  All rights reserved.
</span><span class="c1">// http://code.google.com/p/muduo/
</span><span class="c1">//
</span><span class="c1">// Use of this source code is governed by a BSD-style license
</span><span class="c1">// that can be found in the License file.
</span><span class="c1"></span> 
<span class="c1">// Author: Shuo Chen (chenshuo at chenshuo dot com)
</span><span class="c1">//
</span><span class="c1">// This is a public header file, it must only include public header files.
</span><span class="c1"></span> 
<span class="cp">#ifndef MUDUO_NET_TIMERID_H
</span><span class="cp">#define MUDUO_NET_TIMERID_H
</span><span class="cp"></span> 
<span class="cp">#include</span> <span class="cpf">&lt;muduo/base/copyable.h&gt;</span><span class="cp">
</span><span class="cp"></span> 
<span class="k">namespace</span> <span class="n">muduo</span>
<span class="p">{</span>
<span class="k">namespace</span> <span class="n">net</span>
<span class="p">{</span>
 
<span class="k">class</span><span class="err"> </span><span class="nc">Timer</span><span class="p">;</span>
 
<span class="c1">///是一个不透明的ID ，是外部可见的一个类
</span><span class="c1">/// An opaque identifier, for canceling Timer.
</span><span class="c1">///
</span><span class="c1"></span><span class="k">class</span><span class="err"> </span><span class="nc">TimerId</span> <span class="o">:</span> <span class="k">public</span> <span class="n">muduo</span><span class="o">::</span><span class="n">copyable</span>
<span class="p">{</span>
 <span class="k">public</span><span class="o">:</span>
  <span class="n">TimerId</span><span class="p">()</span>
    <span class="o">:</span> <span class="n">timer_</span><span class="p">(</span><span class="nb">NULL</span><span class="p">),</span>
      <span class="n">sequence_</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
  <span class="p">{</span>
  <span class="p">}</span>
 
  <span class="n">TimerId</span><span class="p">(</span><span class="n">Timer</span><span class="o">*</span> <span class="n">timer</span><span class="p">,</span> <span class="n">int64_t</span> <span class="n">seq</span><span class="p">)</span>
    <span class="o">:</span> <span class="n">timer_</span><span class="p">(</span><span class="n">timer</span><span class="p">),</span>
      <span class="n">sequence_</span><span class="p">(</span><span class="n">seq</span><span class="p">)</span>
  <span class="p">{</span>
  <span class="p">}</span>
 
  <span class="c1">// default copy-ctor, dtor and assignment are okay
</span><span class="c1"></span> 
  <span class="k">friend</span> <span class="k">class</span><span class="err"> </span><span class="nc">TimerQueue</span><span class="p">;</span>
 
 <span class="k">private</span><span class="o">:</span>
  <span class="n">Timer</span><span class="o">*</span> <span class="n">timer_</span><span class="p">;</span> <span class="c1">//定时器的地址 ，timer里面也包含了timer的序号
</span><span class="c1"></span>  <span class="n">int64_t</span> <span class="n">sequence_</span><span class="p">;</span> <span class="c1">//定时器的序号
</span><span class="c1"></span><span class="p">};</span>
 
<span class="p">}</span>
<span class="p">}</span>
 
<span class="cp">#endif  </span><span class="c1">// MUDUO_NET_TIMERID_H
</span></code></pre></td></tr></table>
</div>
</div>
<h3 id="timerqueue头文件">TimerQueue头文件</h3>

<p>timerqueue.h</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-c++" data-lang="c++"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c++" data-lang="c++"><span class="c1">// Copyright 2010, Shuo Chen.  All rights reserved.
</span><span class="c1">// http://code.google.com/p/muduo/
</span><span class="c1">//
</span><span class="c1">// Use of this source code is governed by a BSD-style license
</span><span class="c1">// that can be found in the License file.
</span><span class="c1"></span> 
<span class="c1">// Author: Shuo Chen (chenshuo at chenshuo dot com)
</span><span class="c1">//
</span><span class="c1">// This is an internal header file, you should not include this.
</span><span class="c1"></span> 
<span class="cp">#ifndef MUDUO_NET_TIMER_H
</span><span class="cp">#define MUDUO_NET_TIMER_H
</span><span class="cp"></span> 
<span class="cp">#include</span> <span class="cpf">&lt;boost/noncopyable.hpp&gt;</span><span class="cp">
</span><span class="cp"></span> 
<span class="cp">#include</span> <span class="cpf">&lt;muduo/base/Atomic.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;muduo/base/Timestamp.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;muduo/net/Callbacks.h&gt;</span><span class="cp">
</span><span class="cp"></span> 
<span class="k">namespace</span> <span class="n">muduo</span>
<span class="p">{</span>
<span class="k">namespace</span> <span class="n">net</span>
<span class="p">{</span>
<span class="c1">///
</span><span class="c1">/// Internal class for timer event.
</span><span class="c1">///
</span><span class="c1"></span><span class="k">class</span><span class="err"> </span><span class="nc">Timer</span> <span class="o">:</span> <span class="n">boost</span><span class="o">::</span><span class="n">noncopyable</span>
<span class="p">{</span>
 <span class="k">public</span><span class="o">:</span>
  <span class="n">Timer</span><span class="p">(</span><span class="k">const</span> <span class="n">TimerCallback</span><span class="o">&amp;</span> <span class="n">cb</span><span class="p">,</span> <span class="n">Timestamp</span> <span class="n">when</span><span class="p">,</span> <span class="kt">double</span> <span class="n">interval</span><span class="p">)</span>
    <span class="o">:</span> <span class="n">callback_</span><span class="p">(</span><span class="n">cb</span><span class="p">),</span>
      <span class="n">expiration_</span><span class="p">(</span><span class="n">when</span><span class="p">),</span>
      <span class="n">interval_</span><span class="p">(</span><span class="n">interval</span><span class="p">),</span>
      <span class="n">repeat_</span><span class="p">(</span><span class="n">interval</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">),</span>
      <span class="n">sequence_</span><span class="p">(</span><span class="n">s_numCreated_</span><span class="p">.</span><span class="n">incrementAndGet</span><span class="p">())</span>
  <span class="p">{</span> <span class="p">}</span>
 
  <span class="kt">void</span> <span class="n">run</span><span class="p">()</span> <span class="k">const</span>
  <span class="p">{</span>
    <span class="n">callback_</span><span class="p">();</span>
  <span class="p">}</span>
 
  <span class="n">Timestamp</span> <span class="n">expiration</span><span class="p">()</span> <span class="k">const</span>  <span class="p">{</span> <span class="k">return</span> <span class="n">expiration_</span><span class="p">;</span> <span class="p">}</span>
  <span class="kt">bool</span> <span class="n">repeat</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span> <span class="k">return</span> <span class="n">repeat_</span><span class="p">;</span> <span class="p">}</span>
  <span class="n">int64_t</span> <span class="n">sequence</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span> <span class="k">return</span> <span class="n">sequence_</span><span class="p">;</span> <span class="p">}</span>
 
  <span class="kt">void</span> <span class="n">restart</span><span class="p">(</span><span class="n">Timestamp</span> <span class="n">now</span><span class="p">);</span>
 
  <span class="k">static</span> <span class="n">int64_t</span> <span class="nf">numCreated</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="n">s_numCreated_</span><span class="p">.</span><span class="n">get</span><span class="p">();</span> <span class="p">}</span>
 
 <span class="k">private</span><span class="o">:</span>
  <span class="k">const</span> <span class="n">TimerCallback</span> <span class="n">callback_</span><span class="p">;</span>        <span class="c1">// 定时器回调函数
</span><span class="c1"></span>  <span class="n">Timestamp</span> <span class="n">expiration_</span><span class="p">;</span>                <span class="c1">// 下一次的超时时刻
</span><span class="c1"></span>  <span class="k">const</span> <span class="kt">double</span> <span class="n">interval_</span><span class="p">;</span>               <span class="c1">// 超时时间间隔，如果是一次性定时器，该值为0
</span><span class="c1"></span>  <span class="k">const</span> <span class="kt">bool</span> <span class="n">repeat_</span><span class="p">;</span>                   <span class="c1">// 是否重复
</span><span class="c1"></span>  <span class="k">const</span> <span class="n">int64_t</span> <span class="n">sequence_</span><span class="p">;</span>              <span class="c1">// 定时器序号
</span><span class="c1"></span> 
  <span class="k">static</span> <span class="n">AtomicInt64</span> <span class="n">s_numCreated_</span><span class="p">;</span>     <span class="c1">// 定时器计数，当前已经创建的定时器数量
</span><span class="c1"></span><span class="p">};</span>
<span class="p">}</span>
<span class="p">}</span>
<span class="cp">#endif  </span><span class="c1">// MUDUO_NET_TIMER_H
</span></code></pre></td></tr></table>
</div>
</div>
<h3 id="timerqueue源文件">TimerQueue源文件</h3>

<p>timerqueue.cc</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-rust" data-lang="rust"><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span><span class="lnt">177
</span><span class="lnt">178
</span><span class="lnt">179
</span><span class="lnt">180
</span><span class="lnt">181
</span><span class="lnt">182
</span><span class="lnt">183
</span><span class="lnt">184
</span><span class="lnt">185
</span><span class="lnt">186
</span><span class="lnt">187
</span><span class="lnt">188
</span><span class="lnt">189
</span><span class="lnt">190
</span><span class="lnt">191
</span><span class="lnt">192
</span><span class="lnt">193
</span><span class="lnt">194
</span><span class="lnt">195
</span><span class="lnt">196
</span><span class="lnt">197
</span><span class="lnt">198
</span><span class="lnt">199
</span><span class="lnt">200
</span><span class="lnt">201
</span><span class="lnt">202
</span><span class="lnt">203
</span><span class="lnt">204
</span><span class="lnt">205
</span><span class="lnt">206
</span><span class="lnt">207
</span><span class="lnt">208
</span><span class="lnt">209
</span><span class="lnt">210
</span><span class="lnt">211
</span><span class="lnt">212
</span><span class="lnt">213
</span><span class="lnt">214
</span><span class="lnt">215
</span><span class="lnt">216
</span><span class="lnt">217
</span><span class="lnt">218
</span><span class="lnt">219
</span><span class="lnt">220
</span><span class="lnt">221
</span><span class="lnt">222
</span><span class="lnt">223
</span><span class="lnt">224
</span><span class="lnt">225
</span><span class="lnt">226
</span><span class="lnt">227
</span><span class="lnt">228
</span><span class="lnt">229
</span><span class="lnt">230
</span><span class="lnt">231
</span><span class="lnt">232
</span><span class="lnt">233
</span><span class="lnt">234
</span><span class="lnt">235
</span><span class="lnt">236
</span><span class="lnt">237
</span><span class="lnt">238
</span><span class="lnt">239
</span><span class="lnt">240
</span><span class="lnt">241
</span><span class="lnt">242
</span><span class="lnt">243
</span><span class="lnt">244
</span><span class="lnt">245
</span><span class="lnt">246
</span><span class="lnt">247
</span><span class="lnt">248
</span><span class="lnt">249
</span><span class="lnt">250
</span><span class="lnt">251
</span><span class="lnt">252
</span><span class="lnt">253
</span><span class="lnt">254
</span><span class="lnt">255
</span><span class="lnt">256
</span><span class="lnt">257
</span><span class="lnt">258
</span><span class="lnt">259
</span><span class="lnt">260
</span><span class="lnt">261
</span><span class="lnt">262
</span><span class="lnt">263
</span><span class="lnt">264
</span><span class="lnt">265
</span><span class="lnt">266
</span><span class="lnt">267
</span><span class="lnt">268
</span><span class="lnt">269
</span><span class="lnt">270
</span><span class="lnt">271
</span><span class="lnt">272
</span><span class="lnt">273
</span><span class="lnt">274
</span><span class="lnt">275
</span><span class="lnt">276
</span><span class="lnt">277
</span><span class="lnt">278
</span><span class="lnt">279
</span><span class="lnt">280
</span><span class="lnt">281
</span><span class="lnt">282
</span><span class="lnt">283
</span><span class="lnt">284
</span><span class="lnt">285
</span><span class="lnt">286
</span><span class="lnt">287
</span><span class="lnt">288
</span><span class="lnt">289
</span><span class="lnt">290
</span><span class="lnt">291
</span><span class="lnt">292
</span><span class="lnt">293
</span><span class="lnt">294
</span><span class="lnt">295
</span><span class="lnt">296
</span><span class="lnt">297
</span><span class="lnt">298
</span><span class="lnt">299
</span><span class="lnt">300
</span><span class="lnt">301
</span><span class="lnt">302
</span><span class="lnt">303
</span><span class="lnt">304
</span><span class="lnt">305
</span><span class="lnt">306
</span><span class="lnt">307
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-rust" data-lang="rust"><span class="c1">// Copyright 2010, Shuo Chen.  All rights reserved.
</span><span class="c1">// http://code.google.com/p/muduo/
</span><span class="c1">//
</span><span class="c1">// Use of this source code is governed by a BSD-style license
</span><span class="c1">// that can be found in the License file.
</span><span class="c1"></span><span class="w"> 
</span><span class="w"></span><span class="c1">// Author: Shuo Chen (chenshuo at chenshuo dot com)
</span><span class="c1"></span><span class="w"> 
</span><span class="w"></span><span class="err">#</span><span class="n">define</span><span class="w"> </span><span class="n">__STDC_LIMIT_MACROS</span><span class="w">
</span><span class="w"></span><span class="err">#</span><span class="n">include</span><span class="w"> </span><span class="o">&lt;</span><span class="n">muduo</span><span class="o">/</span><span class="n">net</span><span class="o">/</span><span class="n">TimerQueue</span><span class="p">.</span><span class="n">h</span><span class="o">&gt;</span><span class="w">
</span><span class="w"> 
</span><span class="w"></span><span class="err">#</span><span class="n">include</span><span class="w"> </span><span class="o">&lt;</span><span class="n">muduo</span><span class="o">/</span><span class="n">base</span><span class="o">/</span><span class="n">Logging</span><span class="p">.</span><span class="n">h</span><span class="o">&gt;</span><span class="w">
</span><span class="w"></span><span class="err">#</span><span class="n">include</span><span class="w"> </span><span class="o">&lt;</span><span class="n">muduo</span><span class="o">/</span><span class="n">net</span><span class="o">/</span><span class="n">EventLoop</span><span class="p">.</span><span class="n">h</span><span class="o">&gt;</span><span class="w">
</span><span class="w"></span><span class="err">#</span><span class="n">include</span><span class="w"> </span><span class="o">&lt;</span><span class="n">muduo</span><span class="o">/</span><span class="n">net</span><span class="o">/</span><span class="n">Timer</span><span class="p">.</span><span class="n">h</span><span class="o">&gt;</span><span class="w">
</span><span class="w"></span><span class="err">#</span><span class="n">include</span><span class="w"> </span><span class="o">&lt;</span><span class="n">muduo</span><span class="o">/</span><span class="n">net</span><span class="o">/</span><span class="n">TimerId</span><span class="p">.</span><span class="n">h</span><span class="o">&gt;</span><span class="w">
</span><span class="w"> 
</span><span class="w"></span><span class="err">#</span><span class="n">include</span><span class="w"> </span><span class="o">&lt;</span><span class="n">boost</span><span class="o">/</span><span class="n">bind</span><span class="p">.</span><span class="n">hpp</span><span class="o">&gt;</span><span class="w">
</span><span class="w"> 
</span><span class="w"></span><span class="err">#</span><span class="n">include</span><span class="w"> </span><span class="o">&lt;</span><span class="n">sys</span><span class="o">/</span><span class="n">timerfd</span><span class="p">.</span><span class="n">h</span><span class="o">&gt;</span><span class="w">
</span><span class="w"> 
</span><span class="w"></span><span class="n">namespace</span><span class="w"> </span><span class="n">muduo</span><span class="w">
</span><span class="w"></span><span class="p">{</span><span class="w">
</span><span class="w"></span><span class="n">namespace</span><span class="w"> </span><span class="n">net</span><span class="w">
</span><span class="w"></span><span class="p">{</span><span class="w">
</span><span class="w"></span><span class="n">namespace</span><span class="w"> </span><span class="n">detail</span><span class="w">
</span><span class="w"></span><span class="p">{</span><span class="w">
</span><span class="w"> 
</span><span class="w"></span><span class="c1">// 创建定时器
</span><span class="c1"></span><span class="n">int</span><span class="w"> </span><span class="n">createTimerfd</span><span class="p">()</span><span class="w">
</span><span class="w"></span><span class="p">{</span><span class="w">
</span><span class="w">  </span><span class="n">int</span><span class="w"> </span><span class="n">timerfd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>::<span class="n">timerfd_create</span><span class="p">(</span><span class="n">CLOCK_MONOTONIC</span><span class="p">,</span><span class="w">
</span><span class="w">                                 </span><span class="n">TFD_NONBLOCK</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">TFD_CLOEXEC</span><span class="p">);</span><span class="w">
</span><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">timerfd</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w">
</span><span class="w">  </span><span class="p">{</span><span class="w">
</span><span class="w">    </span><span class="n">LOG_SYSFATAL</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&#34;Failed in timerfd_create&#34;</span><span class="p">;</span><span class="w">
</span><span class="w">  </span><span class="p">}</span><span class="w">
</span><span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">timerfd</span><span class="p">;</span><span class="w">
</span><span class="w"></span><span class="p">}</span><span class="w">
</span><span class="w"> 
</span><span class="w"></span><span class="c1">// 计算超时时刻与当前时间的时间差
</span><span class="c1"></span><span class="k">struct</span> <span class="nc">timespec</span><span class="w"> </span><span class="n">howMuchTimeFromNow</span><span class="p">(</span><span class="n">Timestamp</span><span class="w"> </span><span class="n">when</span><span class="p">)</span><span class="w">
</span><span class="w"></span><span class="p">{</span><span class="w">
</span><span class="w">  </span><span class="n">int64_t</span><span class="w"> </span><span class="n">microseconds</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">when</span><span class="p">.</span><span class="n">microSecondsSinceEpoch</span><span class="p">()</span><span class="w">
</span><span class="w">                         </span><span class="o">-</span><span class="w"> </span><span class="n">Timestamp</span>::<span class="n">now</span><span class="p">().</span><span class="n">microSecondsSinceEpoch</span><span class="p">();</span><span class="w">
</span><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">microseconds</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">100</span><span class="p">)</span><span class="w">
</span><span class="w">  </span><span class="p">{</span><span class="w">
</span><span class="w">    </span><span class="n">microseconds</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">100</span><span class="p">;</span><span class="w">
</span><span class="w">  </span><span class="p">}</span><span class="w">
</span><span class="w">  </span><span class="k">struct</span> <span class="nc">timespec</span><span class="w"> </span><span class="n">ts</span><span class="p">;</span><span class="w">
</span><span class="w">  </span><span class="n">ts</span><span class="p">.</span><span class="n">tv_sec</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">static_cast</span><span class="o">&lt;</span><span class="n">time_t</span><span class="o">&gt;</span><span class="p">(</span><span class="w">
</span><span class="w">      </span><span class="n">microseconds</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">Timestamp</span>::<span class="n">kMicroSecondsPerSecond</span><span class="p">);</span><span class="w">
</span><span class="w">  </span><span class="n">ts</span><span class="p">.</span><span class="n">tv_nsec</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">static_cast</span><span class="o">&lt;</span><span class="n">long</span><span class="o">&gt;</span><span class="p">(</span><span class="w">
</span><span class="w">      </span><span class="p">(</span><span class="n">microseconds</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="n">Timestamp</span>::<span class="n">kMicroSecondsPerSecond</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">1000</span><span class="p">);</span><span class="w">
</span><span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">ts</span><span class="p">;</span><span class="w">
</span><span class="w"></span><span class="p">}</span><span class="w">
</span><span class="w"> 
</span><span class="w"></span><span class="c1">// 清除定时器，避免一直触发
</span><span class="c1"></span><span class="n">void</span><span class="w"> </span><span class="n">readTimerfd</span><span class="p">(</span><span class="n">int</span><span class="w"> </span><span class="n">timerfd</span><span class="p">,</span><span class="w"> </span><span class="n">Timestamp</span><span class="w"> </span><span class="n">now</span><span class="p">)</span><span class="w">
</span><span class="w"></span><span class="p">{</span><span class="w">
</span><span class="w">  </span><span class="n">uint64_t</span><span class="w"> </span><span class="n">howmany</span><span class="p">;</span><span class="w">
</span><span class="w">  </span><span class="n">ssize_t</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>::<span class="n">read</span><span class="p">(</span><span class="n">timerfd</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">howmany</span><span class="p">,</span><span class="w"> </span><span class="kr">sizeof</span><span class="w"> </span><span class="n">howmany</span><span class="p">);</span><span class="w">
</span><span class="w">  </span><span class="n">LOG_TRACE</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&#34;TimerQueue::handleRead() &#34;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">howmany</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&#34; at &#34;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">now</span><span class="p">.</span><span class="n">toString</span><span class="p">();</span><span class="w">
</span><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">n</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kr">sizeof</span><span class="w"> </span><span class="n">howmany</span><span class="p">)</span><span class="w">
</span><span class="w">  </span><span class="p">{</span><span class="w">
</span><span class="w">    </span><span class="n">LOG_ERROR</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&#34;TimerQueue::handleRead() reads &#34;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&#34; bytes instead of 8&#34;</span><span class="p">;</span><span class="w">
</span><span class="w">  </span><span class="p">}</span><span class="w">
</span><span class="w"></span><span class="p">}</span><span class="w">
</span><span class="w"> 
</span><span class="w"></span><span class="c1">// 重置定时器的超时时间
</span><span class="c1"></span><span class="n">void</span><span class="w"> </span><span class="n">resetTimerfd</span><span class="p">(</span><span class="n">int</span><span class="w"> </span><span class="n">timerfd</span><span class="p">,</span><span class="w"> </span><span class="n">Timestamp</span><span class="w"> </span><span class="n">expiration</span><span class="p">)</span><span class="w">
</span><span class="w"></span><span class="p">{</span><span class="w">
</span><span class="w">  </span><span class="c1">// wake up loop by timerfd_settime()
</span><span class="c1"></span><span class="w">  </span><span class="k">struct</span> <span class="nc">itimerspec</span><span class="w"> </span><span class="n">newValue</span><span class="p">;</span><span class="w">
</span><span class="w">  </span><span class="k">struct</span> <span class="nc">itimerspec</span><span class="w"> </span><span class="n">oldValue</span><span class="p">;</span><span class="w">
</span><span class="w">  </span><span class="n">bzero</span><span class="p">(</span><span class="o">&amp;</span><span class="n">newValue</span><span class="p">,</span><span class="w"> </span><span class="kr">sizeof</span><span class="w"> </span><span class="n">newValue</span><span class="p">);</span><span class="w">
</span><span class="w">  </span><span class="n">bzero</span><span class="p">(</span><span class="o">&amp;</span><span class="n">oldValue</span><span class="p">,</span><span class="w"> </span><span class="kr">sizeof</span><span class="w"> </span><span class="n">oldValue</span><span class="p">);</span><span class="w">
</span><span class="w">  </span><span class="n">newValue</span><span class="p">.</span><span class="n">it_value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">howMuchTimeFromNow</span><span class="p">(</span><span class="n">expiration</span><span class="p">);</span><span class="w">
</span><span class="w">  </span><span class="n">int</span><span class="w"> </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>::<span class="n">timerfd_settime</span><span class="p">(</span><span class="n">timerfd</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">newValue</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">oldValue</span><span class="p">);</span><span class="w">
</span><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ret</span><span class="p">)</span><span class="w">
</span><span class="w">  </span><span class="p">{</span><span class="w">
</span><span class="w">    </span><span class="n">LOG_SYSERR</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&#34;timerfd_settime()&#34;</span><span class="p">;</span><span class="w">
</span><span class="w">  </span><span class="p">}</span><span class="w">
</span><span class="w"></span><span class="p">}</span><span class="w">
</span><span class="w"> 
</span><span class="w"></span><span class="p">}</span><span class="w">
</span><span class="w"></span><span class="p">}</span><span class="w">
</span><span class="w"></span><span class="p">}</span><span class="w">
</span><span class="w"> 
</span><span class="w"></span><span class="n">using</span><span class="w"> </span><span class="n">namespace</span><span class="w"> </span><span class="n">muduo</span><span class="p">;</span><span class="w">
</span><span class="w"></span><span class="n">using</span><span class="w"> </span><span class="n">namespace</span><span class="w"> </span><span class="n">muduo</span>::<span class="n">net</span><span class="p">;</span><span class="w">
</span><span class="w"></span><span class="n">using</span><span class="w"> </span><span class="n">namespace</span><span class="w"> </span><span class="n">muduo</span>::<span class="n">net</span>::<span class="n">detail</span><span class="p">;</span><span class="w">
</span><span class="w"> 
</span><span class="w"></span><span class="n">TimerQueue</span>::<span class="n">TimerQueue</span><span class="p">(</span><span class="n">EventLoop</span><span class="o">*</span><span class="w"> </span><span class="k">loop</span><span class="p">)</span><span class="w">
</span><span class="w">  </span>: <span class="nc">loop_</span><span class="p">(</span><span class="k">loop</span><span class="p">),</span><span class="w">
</span><span class="w">    </span><span class="n">timerfd_</span><span class="p">(</span><span class="n">createTimerfd</span><span class="p">()),</span><span class="w">
</span><span class="w">    </span><span class="n">timerfdChannel_</span><span class="p">(</span><span class="k">loop</span><span class="p">,</span><span class="w"> </span><span class="n">timerfd_</span><span class="p">),</span><span class="w">
</span><span class="w">    </span><span class="n">timers_</span><span class="p">(),</span><span class="w">
</span><span class="w">    </span><span class="n">callingExpiredTimers_</span><span class="p">(</span><span class="kc">false</span><span class="p">)</span><span class="w">
</span><span class="w"></span><span class="p">{</span><span class="w">
</span><span class="w">  </span><span class="n">timerfdChannel_</span><span class="p">.</span><span class="n">setReadCallback</span><span class="p">(</span><span class="w">
</span><span class="w">      </span><span class="n">boost</span>::<span class="n">bind</span><span class="p">(</span><span class="o">&amp;</span><span class="n">TimerQueue</span>::<span class="n">handleRead</span><span class="p">,</span><span class="w"> </span><span class="n">this</span><span class="p">));</span><span class="w">
</span><span class="w">  </span><span class="c1">// we are always reading the timerfd, we disarm it with timerfd_settime.
</span><span class="c1"></span><span class="w">  </span><span class="cm">/*把timerfd 加入到poller来关注*/</span><span class="w">
</span><span class="w">  </span><span class="n">timerfdChannel_</span><span class="p">.</span><span class="n">enableReading</span><span class="p">();</span><span class="w">
</span><span class="w"></span><span class="p">}</span><span class="w">
</span><span class="w"> 
</span><span class="w"></span><span class="n">TimerQueue</span>::<span class="o">~</span><span class="n">TimerQueue</span><span class="p">()</span><span class="w">
</span><span class="w"></span><span class="p">{</span><span class="w">
</span><span class="w">  </span>::<span class="n">close</span><span class="p">(</span><span class="n">timerfd_</span><span class="p">);</span><span class="w">
</span><span class="w">  </span><span class="c1">// do not remove channel, since we&#39;re in EventLoop::dtor();
</span><span class="c1"></span><span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">TimerList</span>::<span class="n">iterator</span><span class="w"> </span><span class="n">it</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">timers_</span><span class="p">.</span><span class="n">begin</span><span class="p">();</span><span class="w">
</span><span class="w">      </span><span class="n">it</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">timers_</span><span class="p">.</span><span class="n">end</span><span class="p">();</span><span class="w"> </span><span class="o">++</span><span class="n">it</span><span class="p">)</span><span class="w">
</span><span class="w">  </span><span class="p">{</span><span class="w">
</span><span class="w">    </span><span class="n">delete</span><span class="w"> </span><span class="n">it</span>-&gt;<span class="nc">second</span><span class="p">;</span><span class="w">
</span><span class="w">  </span><span class="p">}</span><span class="w">
</span><span class="w"></span><span class="p">}</span><span class="w">
</span><span class="w"></span><span class="cm">/*增加一个定时器addTimer()-----&gt;addTimerInLoop()*/</span><span class="w">
</span><span class="w"></span><span class="n">TimerId</span><span class="w"> </span><span class="n">TimerQueue</span>::<span class="n">addTimer</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">TimerCallback</span><span class="o">&amp;</span><span class="w"> </span><span class="n">cb</span><span class="p">,</span><span class="w">
</span><span class="w">                             </span><span class="n">Timestamp</span><span class="w"> </span><span class="n">when</span><span class="p">,</span><span class="w">
</span><span class="w">                             </span><span class="n">double</span><span class="w"> </span><span class="n">interval</span><span class="p">)</span><span class="w">
</span><span class="w"></span><span class="p">{</span><span class="w">
</span><span class="w"> 
</span><span class="w">  </span><span class="sd">/**
</span><span class="sd">注意：addTimer虽然是线程安全的，但是这里把安全实现的代码给注释掉了，所以以下的代码必须在所属
</span><span class="sd">的EventLoop IO线程中调用
</span><span class="sd">  */</span><span class="w">
</span><span class="w">  </span><span class="n">Timer</span><span class="o">*</span><span class="w"> </span><span class="n">timer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="n">Timer</span><span class="p">(</span><span class="n">cb</span><span class="p">,</span><span class="w"> </span><span class="n">when</span><span class="p">,</span><span class="w"> </span><span class="n">interval</span><span class="p">);</span><span class="w">
</span><span class="w">  </span><span class="cm">/*
</span><span class="cm">  loop_-&gt;runInLoop(
</span><span class="cm">      boost::bind(&amp;TimerQueue::addTimerInLoop, this, timer));
</span><span class="cm">      */</span><span class="w">
</span><span class="w">  </span><span class="n">addTimerInLoop</span><span class="p">(</span><span class="n">timer</span><span class="p">);</span><span class="w">
</span><span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">TimerId</span><span class="p">(</span><span class="n">timer</span><span class="p">,</span><span class="w"> </span><span class="n">timer</span>-&gt;<span class="nc">sequence</span><span class="p">());</span><span class="w">
</span><span class="w"></span><span class="p">}</span><span class="w">
</span><span class="w"> 
</span><span class="w"></span><span class="n">void</span><span class="w"> </span><span class="n">TimerQueue</span>::<span class="n">cancel</span><span class="p">(</span><span class="n">TimerId</span><span class="w"> </span><span class="n">timerId</span><span class="p">)</span><span class="w">
</span><span class="w"></span><span class="p">{</span><span class="w">
</span><span class="w">  </span><span class="cm">/*
</span><span class="cm">  loop_-&gt;runInLoop(
</span><span class="cm">      boost::bind(&amp;TimerQueue::cancelInLoop, this, timerId));
</span><span class="cm">      */</span><span class="w">
</span><span class="w">  </span><span class="n">cancelInLoop</span><span class="p">(</span><span class="n">timerId</span><span class="p">);</span><span class="w">
</span><span class="w"></span><span class="p">}</span><span class="w">
</span><span class="w"></span><span class="cm">/*添加定时器到所属eventloop IO线程中*/</span><span class="w">
</span><span class="w"></span><span class="n">void</span><span class="w"> </span><span class="n">TimerQueue</span>::<span class="n">addTimerInLoop</span><span class="p">(</span><span class="n">Timer</span><span class="o">*</span><span class="w"> </span><span class="n">timer</span><span class="p">)</span><span class="w">
</span><span class="w"></span><span class="p">{</span><span class="w">
</span><span class="w">  </span><span class="n">loop_</span>-&gt;<span class="nc">assertInLoopThread</span><span class="p">();</span><span class="w">
</span><span class="w">  </span><span class="c1">// 插入一个定时器，有可能会使得最早到期的定时器发生改变
</span><span class="c1"></span><span class="w">  </span><span class="kt">bool</span><span class="w"> </span><span class="n">earliestChanged</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">insert</span><span class="p">(</span><span class="n">timer</span><span class="p">);</span><span class="w">
</span><span class="w"> 
</span><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">earliestChanged</span><span class="p">)</span><span class="w">
</span><span class="w">  </span><span class="p">{</span><span class="w">
</span><span class="w">    </span><span class="c1">// 重置定时器的超时时刻(timerfd_settime)
</span><span class="c1"></span><span class="w">    </span><span class="n">resetTimerfd</span><span class="p">(</span><span class="n">timerfd_</span><span class="p">,</span><span class="w"> </span><span class="n">timer</span>-&gt;<span class="nc">expiration</span><span class="p">());</span><span class="w">
</span><span class="w">  </span><span class="p">}</span><span class="w">
</span><span class="w"></span><span class="p">}</span><span class="w">
</span><span class="w"> 
</span><span class="w"></span><span class="cm">/*取消某个timer*/</span><span class="w">
</span><span class="w"></span><span class="n">void</span><span class="w"> </span><span class="n">TimerQueue</span>::<span class="n">cancelInLoop</span><span class="p">(</span><span class="n">TimerId</span><span class="w"> </span><span class="n">timerId</span><span class="p">)</span><span class="w">
</span><span class="w"></span><span class="p">{</span><span class="w">
</span><span class="w">  </span><span class="n">loop_</span>-&gt;<span class="nc">assertInLoopThread</span><span class="p">();</span><span class="w">
</span><span class="w">  </span><span class="n">assert</span><span class="p">(</span><span class="n">timers_</span><span class="p">.</span><span class="n">size</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">activeTimers_</span><span class="p">.</span><span class="n">size</span><span class="p">());</span><span class="w">
</span><span class="w">  </span><span class="n">ActiveTimer</span><span class="w"> </span><span class="n">timer</span><span class="p">(</span><span class="n">timerId</span><span class="p">.</span><span class="n">timer_</span><span class="p">,</span><span class="w"> </span><span class="n">timerId</span><span class="p">.</span><span class="n">sequence_</span><span class="p">);</span><span class="w">
</span><span class="w">  </span><span class="c1">// 查找该定时器
</span><span class="c1"></span><span class="w">  </span><span class="n">ActiveTimerSet</span>::<span class="n">iterator</span><span class="w"> </span><span class="n">it</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">activeTimers_</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="n">timer</span><span class="p">);</span><span class="w">
</span><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">it</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">activeTimers_</span><span class="p">.</span><span class="n">end</span><span class="p">())</span><span class="w">
</span><span class="w">  </span><span class="p">{</span><span class="w">
</span><span class="w">    </span><span class="n">size_t</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">timers_</span><span class="p">.</span><span class="n">erase</span><span class="p">(</span><span class="n">Entry</span><span class="p">(</span><span class="n">it</span>-&gt;<span class="nc">first</span>-&gt;<span class="nc">expiration</span><span class="p">(),</span><span class="w"> </span><span class="n">it</span>-&gt;<span class="nc">first</span><span class="p">));</span><span class="w">
</span><span class="w">    </span><span class="n">assert</span><span class="p">(</span><span class="n">n</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span><span class="w"> </span><span class="p">(</span><span class="n">void</span><span class="p">)</span><span class="n">n</span><span class="p">;</span><span class="w">
</span><span class="w">    </span><span class="n">delete</span><span class="w"> </span><span class="n">it</span>-&gt;<span class="nc">first</span><span class="p">;</span><span class="w"> </span><span class="c1">// FIXME: no delete please,如果用了unique_ptr,这里就不需要手动删除了
</span><span class="c1"></span><span class="w">    </span><span class="n">activeTimers_</span><span class="p">.</span><span class="n">erase</span><span class="p">(</span><span class="n">it</span><span class="p">);</span><span class="w">
</span><span class="w">  </span><span class="p">}</span><span class="w">
</span><span class="w">  </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">callingExpiredTimers_</span><span class="p">)</span><span class="w">
</span><span class="w">  </span><span class="p">{</span><span class="w">
</span><span class="w">    </span><span class="c1">// 已经到期，并且正在调用回调函数的定时器 ， 那么将其加到cancelingtimers中，
</span><span class="c1"></span><span class="w">    </span><span class="c1">// 以便在其回调处理完后， 在reset(expired, now)里时无效，不需要重置
</span><span class="c1"></span><span class="w">    </span><span class="n">cancelingTimers_</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="n">timer</span><span class="p">);</span><span class="w">
</span><span class="w">  </span><span class="p">}</span><span class="w">
</span><span class="w">  </span><span class="n">assert</span><span class="p">(</span><span class="n">timers_</span><span class="p">.</span><span class="n">size</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">activeTimers_</span><span class="p">.</span><span class="n">size</span><span class="p">());</span><span class="w">
</span><span class="w"></span><span class="p">}</span><span class="w">
</span><span class="w"> 
</span><span class="w"></span><span class="cm">/*定时器触发的回调函数*/</span><span class="w">
</span><span class="w"></span><span class="n">void</span><span class="w"> </span><span class="n">TimerQueue</span>::<span class="n">handleRead</span><span class="p">()</span><span class="w">
</span><span class="w"></span><span class="p">{</span><span class="w">
</span><span class="w">  </span><span class="n">loop_</span>-&gt;<span class="nc">assertInLoopThread</span><span class="p">();</span><span class="w">
</span><span class="w">  </span><span class="n">Timestamp</span><span class="w"> </span><span class="n">now</span><span class="p">(</span><span class="n">Timestamp</span>::<span class="n">now</span><span class="p">());</span><span class="w">
</span><span class="w">  </span><span class="n">readTimerfd</span><span class="p">(</span><span class="n">timerfd_</span><span class="p">,</span><span class="w"> </span><span class="n">now</span><span class="p">);</span><span class="w">       </span><span class="c1">// 清除该事件，避免一直触发
</span><span class="c1"></span><span class="w"> 
</span><span class="w">  </span><span class="c1">// 获取该时刻之前所有的定时器列表(即超时定时器列表)
</span><span class="c1"></span><span class="w">  </span><span class="n">std</span>::<span class="n">vector</span><span class="o">&lt;</span><span class="n">Entry</span><span class="o">&gt;</span><span class="w"> </span><span class="n">expired</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getExpired</span><span class="p">(</span><span class="n">now</span><span class="p">);</span><span class="w">
</span><span class="w">  </span><span class="c1">//已经处于处理到期定时器当中
</span><span class="c1"></span><span class="w">  </span><span class="n">callingExpiredTimers_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span><span class="w">
</span><span class="w">  </span><span class="c1">//清除上一次的超时定时器队列
</span><span class="c1"></span><span class="w">  </span><span class="n">cancelingTimers_</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span><span class="w">
</span><span class="w">  </span><span class="c1">// safe to callback outside critical section
</span><span class="c1"></span><span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">std</span>::<span class="n">vector</span><span class="o">&lt;</span><span class="n">Entry</span><span class="o">&gt;</span>::<span class="n">iterator</span><span class="w"> </span><span class="n">it</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">expired</span><span class="p">.</span><span class="n">begin</span><span class="p">();</span><span class="w">
</span><span class="w">      </span><span class="n">it</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">expired</span><span class="p">.</span><span class="n">end</span><span class="p">();</span><span class="w"> </span><span class="o">++</span><span class="n">it</span><span class="p">)</span><span class="w">
</span><span class="w">  </span><span class="p">{</span><span class="w">
</span><span class="w">    </span><span class="c1">// 这里回调定时器处理函数
</span><span class="c1"></span><span class="w">    </span><span class="n">it</span>-&gt;<span class="nc">second</span>-&gt;<span class="nc">run</span><span class="p">();</span><span class="w">
</span><span class="w">  </span><span class="p">}</span><span class="w">
</span><span class="w">  </span><span class="n">callingExpiredTimers_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span><span class="w">
</span><span class="w"> 
</span><span class="w">  </span><span class="c1">// 不是一次性定时器，需要重启
</span><span class="c1"></span><span class="w">  </span><span class="n">reset</span><span class="p">(</span><span class="n">expired</span><span class="p">,</span><span class="w"> </span><span class="n">now</span><span class="p">);</span><span class="w">
</span><span class="w"></span><span class="p">}</span><span class="w">
</span><span class="w"> 
</span><span class="w"></span><span class="c1">// rvo 优化
</span><span class="c1">//返回已经超时的timers
</span><span class="c1">// TimerQueue = 1,1,1,3,4,5,7,9
</span><span class="c1">// 那么触发第一个1时，其实后面的2个1也被触发了
</span><span class="c1">// timerQueue 只管队列中的第一个定时器
</span><span class="c1"></span><span class="n">std</span>::<span class="n">vector</span><span class="o">&lt;</span><span class="n">TimerQueue</span>::<span class="n">Entry</span><span class="o">&gt;</span><span class="w"> </span><span class="n">TimerQueue</span>::<span class="n">getExpired</span><span class="p">(</span><span class="n">Timestamp</span><span class="w"> </span><span class="n">now</span><span class="p">)</span><span class="w">
</span><span class="w"></span><span class="p">{</span><span class="w">
</span><span class="w">  </span><span class="n">assert</span><span class="p">(</span><span class="n">timers_</span><span class="p">.</span><span class="n">size</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">activeTimers_</span><span class="p">.</span><span class="n">size</span><span class="p">());</span><span class="w">
</span><span class="w">  </span><span class="n">std</span>::<span class="n">vector</span><span class="o">&lt;</span><span class="n">Entry</span><span class="o">&gt;</span><span class="w"> </span><span class="n">expired</span><span class="p">;</span><span class="w">
</span><span class="w">  </span><span class="n">Entry</span><span class="w"> </span><span class="n">sentry</span><span class="p">(</span><span class="n">now</span><span class="p">,</span><span class="w"> </span><span class="n">reinterpret_cast</span><span class="o">&lt;</span><span class="n">Timer</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">UINTPTR_MAX</span><span class="p">));</span><span class="w">
</span><span class="w">  </span><span class="c1">// 返回第一个未到期的Timer的迭代器
</span><span class="c1"></span><span class="w">  </span><span class="c1">// lower_bound的含义是返回第一个值&gt;=sentry的元素的iterator
</span><span class="c1"></span><span class="w">  </span><span class="c1">// 即*end &gt;= sentry，从而end-&gt;first &gt; now
</span><span class="c1"></span><span class="w">  </span><span class="n">TimerList</span>::<span class="n">iterator</span><span class="w"> </span><span class="n">end</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">timers_</span><span class="p">.</span><span class="n">lower_bound</span><span class="p">(</span><span class="n">sentry</span><span class="p">);</span><span class="w">
</span><span class="w">  </span><span class="n">assert</span><span class="p">(</span><span class="n">end</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">timers_</span><span class="p">.</span><span class="n">end</span><span class="p">()</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">now</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">end</span>-&gt;<span class="nc">first</span><span class="p">);</span><span class="w">
</span><span class="w">  </span><span class="c1">// 将到期的定时器插入到expired中
</span><span class="c1"></span><span class="w">  </span><span class="n">std</span>::<span class="n">copy</span><span class="p">(</span><span class="n">timers_</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span><span class="w"> </span><span class="n">end</span><span class="p">,</span><span class="w"> </span><span class="n">back_inserter</span><span class="p">(</span><span class="n">expired</span><span class="p">));</span><span class="w">
</span><span class="w">  </span><span class="c1">// 从timers_中移除到期的定时器
</span><span class="c1"></span><span class="w">  </span><span class="n">timers_</span><span class="p">.</span><span class="n">erase</span><span class="p">(</span><span class="n">timers_</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span><span class="w"> </span><span class="n">end</span><span class="p">);</span><span class="w">
</span><span class="w"> 
</span><span class="w">  </span><span class="c1">// 从activeTimers_中移除到期的定时器
</span><span class="c1"></span><span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">std</span>::<span class="n">vector</span><span class="o">&lt;</span><span class="n">Entry</span><span class="o">&gt;</span>::<span class="n">iterator</span><span class="w"> </span><span class="n">it</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">expired</span><span class="p">.</span><span class="n">begin</span><span class="p">();</span><span class="n">it</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">expired</span><span class="p">.</span><span class="n">end</span><span class="p">();</span><span class="w"> </span><span class="o">++</span><span class="n">it</span><span class="p">)</span><span class="w">
</span><span class="w">  </span><span class="p">{</span><span class="w">
</span><span class="w">    </span><span class="n">ActiveTimer</span><span class="w"> </span><span class="n">timer</span><span class="p">(</span><span class="n">it</span>-&gt;<span class="nc">second</span><span class="p">,</span><span class="w"> </span><span class="n">it</span>-&gt;<span class="nc">second</span>-&gt;<span class="nc">sequence</span><span class="p">());</span><span class="w">
</span><span class="w">    </span><span class="n">size_t</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">activeTimers_</span><span class="p">.</span><span class="n">erase</span><span class="p">(</span><span class="n">timer</span><span class="p">);</span><span class="w">
</span><span class="w">    </span><span class="n">assert</span><span class="p">(</span><span class="n">n</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span><span class="w"> </span><span class="p">(</span><span class="n">void</span><span class="p">)</span><span class="n">n</span><span class="p">;</span><span class="w">
</span><span class="w">  </span><span class="p">}</span><span class="w">
</span><span class="w"> 
</span><span class="w">  </span><span class="n">assert</span><span class="p">(</span><span class="n">timers_</span><span class="p">.</span><span class="n">size</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">activeTimers_</span><span class="p">.</span><span class="n">size</span><span class="p">());</span><span class="w">
</span><span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">expired</span><span class="p">;</span><span class="w">
</span><span class="w"></span><span class="p">}</span><span class="w">
</span><span class="w"> 
</span><span class="w"></span><span class="n">void</span><span class="w"> </span><span class="n">TimerQueue</span>::<span class="n">reset</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">std</span>::<span class="n">vector</span><span class="o">&lt;</span><span class="n">Entry</span><span class="o">&gt;&amp;</span><span class="w"> </span><span class="n">expired</span><span class="p">,</span><span class="w"> </span><span class="n">Timestamp</span><span class="w"> </span><span class="n">now</span><span class="p">)</span><span class="w">
</span><span class="w"></span><span class="p">{</span><span class="w">
</span><span class="w">  </span><span class="n">Timestamp</span><span class="w"> </span><span class="n">nextExpire</span><span class="p">;</span><span class="w">
</span><span class="w"> 
</span><span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">std</span>::<span class="n">vector</span><span class="o">&lt;</span><span class="n">Entry</span><span class="o">&gt;</span>::<span class="n">const_iterator</span><span class="w"> </span><span class="n">it</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">expired</span><span class="p">.</span><span class="n">begin</span><span class="p">();</span><span class="w">
</span><span class="w">      </span><span class="n">it</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">expired</span><span class="p">.</span><span class="n">end</span><span class="p">();</span><span class="w"> </span><span class="o">++</span><span class="n">it</span><span class="p">)</span><span class="w">
</span><span class="w">  </span><span class="p">{</span><span class="w">
</span><span class="w">    </span><span class="n">ActiveTimer</span><span class="w"> </span><span class="n">timer</span><span class="p">(</span><span class="n">it</span>-&gt;<span class="nc">second</span><span class="p">,</span><span class="w"> </span><span class="n">it</span>-&gt;<span class="nc">second</span>-&gt;<span class="nc">sequence</span><span class="p">());</span><span class="w">
</span><span class="w">    </span><span class="c1">// 如果是重复的定时器并且是未取消定时器（未被其他线程取消掉），则重启该定时器
</span><span class="c1"></span><span class="w">    </span><span class="c1">// cancelingTimers_.find(timer) == cancelingTimers_.end()  在取消的队列中找到不到timer
</span><span class="c1"></span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">it</span>-&gt;<span class="nc">second</span>-&gt;<span class="nc">repeat</span><span class="p">()</span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">cancelingTimers_</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="n">timer</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">cancelingTimers_</span><span class="p">.</span><span class="n">end</span><span class="p">())</span><span class="w">
</span><span class="w">    </span><span class="p">{</span><span class="w">
</span><span class="w">      </span><span class="n">it</span>-&gt;<span class="nc">second</span>-&gt;<span class="nc">restart</span><span class="p">(</span><span class="n">now</span><span class="p">);</span><span class="w">
</span><span class="w">      </span><span class="n">insert</span><span class="p">(</span><span class="n">it</span>-&gt;<span class="nc">second</span><span class="p">);</span><span class="w">
</span><span class="w">    </span><span class="p">}</span><span class="w">
</span><span class="w">    </span><span class="k">else</span><span class="w">
</span><span class="w">    </span><span class="p">{</span><span class="w">
</span><span class="w">      </span><span class="c1">// 一次性定时器或者已被取消的定时器是不能重置的，因此删除该定时器
</span><span class="c1"></span><span class="w">      </span><span class="c1">// FIXME move to a free list
</span><span class="c1"></span><span class="w">      </span><span class="n">delete</span><span class="w"> </span><span class="n">it</span>-&gt;<span class="nc">second</span><span class="p">;</span><span class="w"> </span><span class="c1">// FIXME: no delete please
</span><span class="c1"></span><span class="w">    </span><span class="p">}</span><span class="w">
</span><span class="w">  </span><span class="p">}</span><span class="w">
</span><span class="w"> 
</span><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">timers_</span><span class="p">.</span><span class="n">empty</span><span class="p">())</span><span class="w">
</span><span class="w">  </span><span class="p">{</span><span class="w">
</span><span class="w">    </span><span class="c1">// 获取最早到期的定时器超时时间
</span><span class="c1"></span><span class="w">    </span><span class="n">nextExpire</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">timers_</span><span class="p">.</span><span class="n">begin</span><span class="p">()</span>-&gt;<span class="nc">second</span>-&gt;<span class="nc">expiration</span><span class="p">();</span><span class="w">
</span><span class="w">  </span><span class="p">}</span><span class="w">
</span><span class="w"> 
</span><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">nextExpire</span><span class="p">.</span><span class="n">valid</span><span class="p">())</span><span class="w">
</span><span class="w">  </span><span class="p">{</span><span class="w">
</span><span class="w">    </span><span class="c1">// 重置定时器的超时时刻(timerfd_settime)
</span><span class="c1"></span><span class="w">    </span><span class="n">resetTimerfd</span><span class="p">(</span><span class="n">timerfd_</span><span class="p">,</span><span class="w"> </span><span class="n">nextExpire</span><span class="p">);</span><span class="w">
</span><span class="w">  </span><span class="p">}</span><span class="w">
</span><span class="w"></span><span class="p">}</span><span class="w">
</span><span class="w"> 
</span><span class="w"></span><span class="kt">bool</span><span class="w"> </span><span class="n">TimerQueue</span>::<span class="n">insert</span><span class="p">(</span><span class="n">Timer</span><span class="o">*</span><span class="w"> </span><span class="n">timer</span><span class="p">)</span><span class="w">
</span><span class="w"></span><span class="p">{</span><span class="w">
</span><span class="w">  </span><span class="n">loop_</span>-&gt;<span class="nc">assertInLoopThread</span><span class="p">();</span><span class="w">
</span><span class="w">  </span><span class="n">assert</span><span class="p">(</span><span class="n">timers_</span><span class="p">.</span><span class="n">size</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">activeTimers_</span><span class="p">.</span><span class="n">size</span><span class="p">());</span><span class="w">
</span><span class="w">  </span><span class="c1">// 最早到期时间是否改变
</span><span class="c1"></span><span class="w">  </span><span class="kt">bool</span><span class="w"> </span><span class="n">earliestChanged</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span><span class="w">
</span><span class="w">  </span><span class="c1">//获取传进来的定时器的超时时间
</span><span class="c1"></span><span class="w">  </span><span class="n">Timestamp</span><span class="w"> </span><span class="n">when</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">timer</span>-&gt;<span class="nc">expiration</span><span class="p">();</span><span class="w">
</span><span class="w">  </span><span class="n">TimerList</span>::<span class="n">iterator</span><span class="w"> </span><span class="n">it</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">timers_</span><span class="p">.</span><span class="n">begin</span><span class="p">();</span><span class="w">
</span><span class="w">  </span><span class="c1">// 如果timers_为空或者when小于timers_中的最早到期时间
</span><span class="c1"></span><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">it</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">timers_</span><span class="p">.</span><span class="n">end</span><span class="p">()</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">when</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">it</span>-&gt;<span class="nc">first</span><span class="p">)</span><span class="w">
</span><span class="w">  </span><span class="p">{</span><span class="w">
</span><span class="w"> 
</span><span class="w">    </span><span class="n">earliestChanged</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span><span class="w">
</span><span class="w">  </span><span class="p">}</span><span class="w">
</span><span class="w">  </span><span class="p">{</span><span class="w">
</span><span class="w">    </span><span class="c1">// 插入到timers_中
</span><span class="c1"></span><span class="w">    </span><span class="n">std</span>::<span class="n">pair</span><span class="o">&lt;</span><span class="n">TimerList</span>::<span class="n">iterator</span><span class="p">,</span><span class="w"> </span><span class="kt">bool</span><span class="o">&gt;</span><span class="w"> </span><span class="n">result</span><span class="w">
</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="n">timers_</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="n">Entry</span><span class="p">(</span><span class="n">when</span><span class="p">,</span><span class="w"> </span><span class="n">timer</span><span class="p">));</span><span class="w">
</span><span class="w">    </span><span class="cm">/*断言插入操作是否成功*/</span><span class="w"> 
</span><span class="w">    </span><span class="n">assert</span><span class="p">(</span><span class="n">result</span><span class="p">.</span><span class="n">second</span><span class="p">);</span><span class="w"> </span><span class="p">(</span><span class="n">void</span><span class="p">)</span><span class="n">result</span><span class="p">;</span><span class="w">
</span><span class="w">  </span><span class="p">}</span><span class="w">
</span><span class="w">  </span><span class="p">{</span><span class="w">
</span><span class="w">    </span><span class="c1">// 插入到activeTimers_中
</span><span class="c1"></span><span class="w">    </span><span class="n">std</span>::<span class="n">pair</span><span class="o">&lt;</span><span class="n">ActiveTimerSet</span>::<span class="n">iterator</span><span class="p">,</span><span class="w"> </span><span class="kt">bool</span><span class="o">&gt;</span><span class="w"> </span><span class="n">result</span><span class="w">
</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="n">activeTimers_</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="n">ActiveTimer</span><span class="p">(</span><span class="n">timer</span><span class="p">,</span><span class="w"> </span><span class="n">timer</span>-&gt;<span class="nc">sequence</span><span class="p">()));</span><span class="w">
</span><span class="w">    </span><span class="n">assert</span><span class="p">(</span><span class="n">result</span><span class="p">.</span><span class="n">second</span><span class="p">);</span><span class="w"> </span><span class="p">(</span><span class="n">void</span><span class="p">)</span><span class="n">result</span><span class="p">;</span><span class="w">
</span><span class="w">  </span><span class="p">}</span><span class="w">
</span><span class="w">  </span><span class="c1">//断言是否成功操作了
</span><span class="c1"></span><span class="w">  </span><span class="n">assert</span><span class="p">(</span><span class="n">timers_</span><span class="p">.</span><span class="n">size</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">activeTimers_</span><span class="p">.</span><span class="n">size</span><span class="p">());</span><span class="w">
</span><span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">earliestChanged</span><span class="p">;</span><span class="w">
</span><span class="w"></span><span class="p">}</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div>
<h2 id="29-eventloop再分析之io线程-29">[29] EventLoop再分析之IO线程（29）</h2>

<h3 id="eventloop-io-线程的简单描述">EventLoop IO 线程的简单描述</h3>

<p><center><img src="http://laohanlinux.github.io/images/img/blog/muduo-net-library-chapter-1/eventloop.runInloop.png" alt="" /></center></p>

<p>eventloopThread 分析：</p>

<p>eventloop现成循环调用loop()函数：</p>

<ul>
<li>获取活跃的通道</li>
<li>执行活跃通道的回调函数</li>
<li>调用<code>doPending Functors</code>，获取<code>queueLoop</code>的任务，依次执行(这些任务会阻塞IO线程，即IO线程也做了计算任务，所以这些任务不应该是耗时的任务)</li>
</ul>

<blockquote>
<p>注意</p>

<p>eventFd在这里用于唤醒eventloop的事件，试想一下，加入当前只有IO线程的计算任务，那么eventloop会阻塞在poll()函数里面，直到超时，这是不可取的策略。</p>
</blockquote>

<h3 id="进程-线程-wait-notify">进程(线程)wait/notify</h3>

<ul>
<li>pipe</li>
<li>socketpair</li>
<li>eventfd</li>
</ul>

<p><code>eventfd</code> 是一个比<code>pipe</code>更高效的线程间事件通知机制，一方面它比<code>pipe</code>少用一个<code>file descripor</code>，节省了资源；另一方面,<code>eventfd</code>的缓冲区管理也简单得多，全部<code>buffer</code>只有定长<code>8</code> <code>bytes</code>，不像<code>pipe</code>那样可能有不定长的真正<code>buffer</code>。</p>

<p><center><img src="http://laohanlinux.github.io/images/img/blog/muduo-net-library-chapter-1/eventloop.runInloop1.png" alt="" /></center>
<center><img src="http://laohanlinux.github.io/images/img/blog/muduo-net-library-chapter-1/eventloop.runInloop2.png" alt="" /></center></p>

<h3 id="eventloop头文件">EventLoop头文件</h3>

<p>eventloop.h</p>

<blockquote>
<p>NOTIFY:</p>

<p>这里的<code>eventloop</code> 和 <em>muduo_net库源码分析（26-1)</em> 里面的内容有些不一样，这里的<code>eventloop</code>加了一些内容, 在阅读<code>eventloop</code>时，要注意<code>runInLoop</code>和<code>queueInloop</code>这两个函数，<code>wakeup（）</code>也得注意.</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-c++" data-lang="c++"><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c++" data-lang="c++"><span class="c1">// Copyright 2010, Shuo Chen.  All rights reserved.
</span><span class="c1">// http://code.google.com/p/muduo/
</span><span class="c1">//
</span><span class="c1">// Use of this source code is governed by a BSD-style license
</span><span class="c1">// that can be found in the License file.
</span><span class="c1"></span> 
<span class="c1">// Author: Shuo Chen (chenshuo at chenshuo dot com)
</span><span class="c1">//
</span><span class="c1">// This is a public header file, it must only include public header files.
</span><span class="c1"></span> 
<span class="cp">#ifndef MUDUO_NET_EVENTLOOP_H
</span><span class="cp">#define MUDUO_NET_EVENTLOOP_H
</span><span class="cp"></span> 
<span class="cp">#include</span> <span class="cpf">&lt;vector&gt;</span><span class="cp">
</span><span class="cp"></span> 
<span class="cp">#include</span> <span class="cpf">&lt;boost/noncopyable.hpp&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;boost/scoped_ptr.hpp&gt;</span><span class="cp">
</span><span class="cp"></span> 
<span class="cp">#include</span> <span class="cpf">&lt;muduo/base/Mutex.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;muduo/base/Thread.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;muduo/base/Timestamp.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;muduo/net/Callbacks.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;muduo/net/TimerId.h&gt;</span><span class="cp">
</span><span class="cp"></span> 
<span class="k">namespace</span> <span class="n">muduo</span>
<span class="p">{</span>
<span class="k">namespace</span> <span class="n">net</span>
<span class="p">{</span>
 
<span class="k">class</span><span class="err"> </span><span class="nc">Channel</span><span class="p">;</span>
<span class="k">class</span><span class="err"> </span><span class="nc">Poller</span><span class="p">;</span>
<span class="k">class</span><span class="err"> </span><span class="nc">TimerQueue</span><span class="p">;</span>
<span class="c1">///
</span><span class="c1">/// Reactor, at most one per thread.
</span><span class="c1">///
</span><span class="c1">/// This is an interface class, so don&#39;t expose too much details.
</span><span class="c1"></span><span class="k">class</span><span class="err"> </span><span class="nc">EventLoop</span> <span class="o">:</span> <span class="n">boost</span><span class="o">::</span><span class="n">noncopyable</span>
<span class="p">{</span>
 <span class="k">public</span><span class="o">:</span>
  <span class="cm">/* IO事件回调函数，就像“监听socketfd” ，我们可以把 监听socketfd 的处理函数 做成一个回调函数，
</span><span class="cm">  把这个函数放到pendingFunctors_中，然后由IO线程自己回调处理*/</span>
  <span class="k">typedef</span> <span class="n">boost</span><span class="o">::</span><span class="n">function</span><span class="o">&lt;</span><span class="kt">void</span><span class="p">()</span><span class="o">&gt;</span> <span class="n">Functor</span><span class="p">;</span>
 
  <span class="n">EventLoop</span><span class="p">();</span>
  <span class="o">~</span><span class="n">EventLoop</span><span class="p">();</span>  <span class="c1">// force out-line dtor, for scoped_ptr members.
</span><span class="c1"></span> 
  <span class="c1">///
</span><span class="c1"></span>  <span class="c1">/// Loops forever.
</span><span class="c1"></span>  <span class="c1">///
</span><span class="c1"></span>  <span class="c1">/// Must be called in the same thread as creation of the object.
</span><span class="c1"></span>  <span class="c1">///
</span><span class="c1"></span>  <span class="kt">void</span> <span class="nf">loop</span><span class="p">();</span>
 
  <span class="kt">void</span> <span class="nf">quit</span><span class="p">();</span>
 
  <span class="c1">///
</span><span class="c1"></span>  <span class="c1">/// Time when poll returns, usually means data arrivial.
</span><span class="c1"></span>  <span class="c1">///
</span><span class="c1"></span>  <span class="n">Timestamp</span> <span class="nf">pollReturnTime</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span> <span class="k">return</span> <span class="n">pollReturnTime_</span><span class="p">;</span> <span class="p">}</span>
 
  <span class="c1">/// Runs callback immediately in the loop thread.
</span><span class="c1"></span>  <span class="c1">/// It wakes up the loop, and run the cb.
</span><span class="c1"></span>  <span class="c1">/// If in the same loop thread, cb is run within the function.
</span><span class="c1"></span>  <span class="c1">/// Safe to call from other threads.
</span><span class="c1"></span>  <span class="kt">void</span> <span class="nf">runInLoop</span><span class="p">(</span><span class="k">const</span> <span class="n">Functor</span><span class="o">&amp;</span> <span class="n">cb</span><span class="p">);</span>
  <span class="c1">/// Queues callback in the loop thread.
</span><span class="c1"></span>  <span class="c1">/// Runs after finish pooling.
</span><span class="c1"></span>  <span class="c1">/// Safe to call from other threads.
</span><span class="c1"></span>  <span class="kt">void</span> <span class="nf">queueInLoop</span><span class="p">(</span><span class="k">const</span> <span class="n">Functor</span><span class="o">&amp;</span> <span class="n">cb</span><span class="p">);</span>
 
  <span class="c1">// timers
</span><span class="c1"></span> 
  <span class="c1">///
</span><span class="c1"></span>  <span class="c1">/// Runs callback at &#39;time&#39;.
</span><span class="c1"></span>  <span class="c1">/// Safe to call from other threads.
</span><span class="c1"></span>  <span class="c1">///
</span><span class="c1"></span>  <span class="n">TimerId</span> <span class="nf">runAt</span><span class="p">(</span><span class="k">const</span> <span class="n">Timestamp</span><span class="o">&amp;</span> <span class="n">time</span><span class="p">,</span> <span class="k">const</span> <span class="n">TimerCallback</span><span class="o">&amp;</span> <span class="n">cb</span><span class="p">);</span>
  <span class="c1">///
</span><span class="c1"></span>  <span class="c1">/// Runs callback after @c delay seconds.
</span><span class="c1"></span>  <span class="c1">/// Safe to call from other threads.
</span><span class="c1"></span>  <span class="c1">///
</span><span class="c1"></span>  <span class="n">TimerId</span> <span class="nf">runAfter</span><span class="p">(</span><span class="kt">double</span> <span class="n">delay</span><span class="p">,</span> <span class="k">const</span> <span class="n">TimerCallback</span><span class="o">&amp;</span> <span class="n">cb</span><span class="p">);</span>
  <span class="c1">///
</span><span class="c1"></span>  <span class="c1">/// Runs callback every @c interval seconds.
</span><span class="c1"></span>  <span class="c1">/// Safe to call from other threads.
</span><span class="c1"></span>  <span class="c1">///
</span><span class="c1"></span>  <span class="n">TimerId</span> <span class="nf">runEvery</span><span class="p">(</span><span class="kt">double</span> <span class="n">interval</span><span class="p">,</span> <span class="k">const</span> <span class="n">TimerCallback</span><span class="o">&amp;</span> <span class="n">cb</span><span class="p">);</span>
  <span class="c1">///
</span><span class="c1"></span>  <span class="c1">/// Cancels the timer.
</span><span class="c1"></span>  <span class="c1">/// Safe to call from other threads.
</span><span class="c1"></span>  <span class="c1">///
</span><span class="c1"></span>  <span class="kt">void</span> <span class="nf">cancel</span><span class="p">(</span><span class="n">TimerId</span> <span class="n">timerId</span><span class="p">);</span>
 
  <span class="c1">// internal usage
</span><span class="c1"></span>  <span class="kt">void</span> <span class="nf">wakeup</span><span class="p">();</span>
  <span class="kt">void</span> <span class="nf">updateChannel</span><span class="p">(</span><span class="n">Channel</span><span class="o">*</span> <span class="n">channel</span><span class="p">);</span>     <span class="c1">// 在Poller中添加或者更新通道
</span><span class="c1"></span>  <span class="kt">void</span> <span class="nf">removeChannel</span><span class="p">(</span><span class="n">Channel</span><span class="o">*</span> <span class="n">channel</span><span class="p">);</span>     <span class="c1">// 从Poller中移除通道
</span><span class="c1"></span> 
  <span class="kt">void</span> <span class="nf">assertInLoopThread</span><span class="p">()</span>
  <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">isInLoopThread</span><span class="p">())</span>
    <span class="p">{</span>
      <span class="n">abortNotInLoopThread</span><span class="p">();</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="kt">bool</span> <span class="nf">isInLoopThread</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span> <span class="k">return</span> <span class="n">threadId_</span> <span class="o">==</span> <span class="n">CurrentThread</span><span class="o">::</span><span class="n">tid</span><span class="p">();</span> <span class="p">}</span>
 
  <span class="kt">bool</span> <span class="nf">eventHandling</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span> <span class="k">return</span> <span class="n">eventHandling_</span><span class="p">;</span> <span class="p">}</span>
 
  <span class="k">static</span> <span class="n">EventLoop</span><span class="o">*</span> <span class="nf">getEventLoopOfCurrentThread</span><span class="p">();</span>
 
 <span class="k">private</span><span class="o">:</span>
  <span class="kt">void</span> <span class="n">abortNotInLoopThread</span><span class="p">();</span>
  <span class="kt">void</span> <span class="nf">handleRead</span><span class="p">();</span>  <span class="c1">// waked up
</span><span class="c1"></span>  <span class="kt">void</span> <span class="nf">doPendingFunctors</span><span class="p">();</span>
 
  <span class="kt">void</span> <span class="nf">printActiveChannels</span><span class="p">()</span> <span class="k">const</span><span class="p">;</span> <span class="c1">// DEBUG
</span><span class="c1"></span> 
  <span class="k">typedef</span> <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">Channel</span><span class="o">*&gt;</span> <span class="n">ChannelList</span><span class="p">;</span>
 
  <span class="kt">bool</span> <span class="n">looping_</span><span class="p">;</span> <span class="cm">/* atomic */</span>
  <span class="kt">bool</span> <span class="n">quit_</span><span class="p">;</span> <span class="cm">/* atomic */</span>
  <span class="kt">bool</span> <span class="n">eventHandling_</span><span class="p">;</span> <span class="cm">/*事件处理函数状态 atomic */</span>
  <span class="kt">bool</span> <span class="n">callingPendingFunctors_</span><span class="p">;</span> <span class="cm">/*是否处于IO回调函数的处理状态中 atomic */</span>
  <span class="k">const</span> <span class="n">pid_t</span> <span class="n">threadId_</span><span class="p">;</span>        <span class="c1">// 当前对象所属线程ID
</span><span class="c1"></span>  <span class="n">Timestamp</span> <span class="n">pollReturnTime_</span><span class="p">;</span>
  <span class="n">boost</span><span class="o">::</span><span class="n">scoped_ptr</span><span class="o">&lt;</span><span class="n">Poller</span><span class="o">&gt;</span> <span class="n">poller_</span><span class="p">;</span>
  <span class="n">boost</span><span class="o">::</span><span class="n">scoped_ptr</span><span class="o">&lt;</span><span class="n">TimerQueue</span><span class="o">&gt;</span> <span class="n">timerQueue_</span><span class="p">;</span>
 
<span class="cm">/*****
</span><span class="cm"> 
</span><span class="cm">wakeupFd_ : 这个描述符主要是未了
</span><span class="cm"> 
</span><span class="cm">****/</span>
  <span class="kt">int</span> <span class="n">wakeupFd_</span><span class="p">;</span>                <span class="c1">// 用于eventfd所创建的文件描述符
</span><span class="c1"></span>  <span class="c1">// unlike in TimerQueue, which is an internal class,
</span><span class="c1"></span>  <span class="c1">// we don&#39;t expose Channel to client.
</span><span class="c1"></span>  <span class="cm">/*
</span><span class="cm">  wakeupChannel 和EventLoop 是组合的关系，生命周期由EventLoop管理
</span><span class="cm">  一定要看下面的内容，如果不明白下面的内容的话，代码是很难懂的（个人观点，高手勿喷！！^V^）
</span><span class="cm">  当其他线程跟IO线程通信时， 他们使用的是同一个通道(wakeupChannel_) ， 当其他线程wakeup（write）时，
</span><span class="cm">poll会返回。然后IO执行handleRead，但是主要的回调函数不是handleRead ，而是pendingFunctors_里面的函数，
</span><span class="cm">hadnleRead只是为了不被多次触发而已，也就是说其他线程要想IO线程执行他们所需的函调函数，只要把回调函数
</span><span class="cm">注入到pendingFunctors_，然后wakeup（write）唤醒一下。
</span><span class="cm">  当然IO线程也可以和IO线程进行通信，但是情况有些不一样，具体哪些不同，大家自己看着办吧！
</span><span class="cm"> 
</span><span class="cm">  注： IO线程就是EventLoop所属的线程
</span><span class="cm">  */</span>
  <span class="n">boost</span><span class="o">::</span><span class="n">scoped_ptr</span><span class="o">&lt;</span><span class="n">Channel</span><span class="o">&gt;</span> <span class="n">wakeupChannel_</span><span class="p">;</span>  <span class="c1">//wakeupFd_所对应的通道 该通道将会纳入poller_来管理
</span><span class="c1"></span>  <span class="n">ChannelList</span> <span class="n">activeChannels_</span><span class="p">;</span>      <span class="c1">// Poller返回的活动通道
</span><span class="c1"></span>  <span class="n">Channel</span><span class="o">*</span> <span class="n">currentActiveChannel_</span><span class="p">;</span>   <span class="c1">// 当前正在处理的活动通道
</span><span class="c1"></span>  <span class="n">MutexLock</span> <span class="n">mutex_</span><span class="p">;</span>
  <span class="c1">// IO线程 回调函数容器
</span><span class="c1"></span>  <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">Functor</span><span class="o">&gt;</span> <span class="n">pendingFunctors_</span><span class="p">;</span> <span class="c1">// @BuardedBy mutex_
</span><span class="c1"></span><span class="p">};</span>
 
<span class="p">}</span>
<span class="p">}</span>
<span class="cp">#endif  </span><span class="c1">// MUDUO_NET_EVENTLOOP_H
</span></code></pre></td></tr></table>
</div>
</div>
<h3 id="eventloop源文件">EventLoop源文件</h3>

<p>这里的<code>eventloop</code>和 *muduo_net库源码分析（26-1）*里面的内容有些不一样，这里的<code>eventloop</code>加了一些内容，具体情况可以回去看一看.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-c++" data-lang="c++"><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span><span class="lnt">177
</span><span class="lnt">178
</span><span class="lnt">179
</span><span class="lnt">180
</span><span class="lnt">181
</span><span class="lnt">182
</span><span class="lnt">183
</span><span class="lnt">184
</span><span class="lnt">185
</span><span class="lnt">186
</span><span class="lnt">187
</span><span class="lnt">188
</span><span class="lnt">189
</span><span class="lnt">190
</span><span class="lnt">191
</span><span class="lnt">192
</span><span class="lnt">193
</span><span class="lnt">194
</span><span class="lnt">195
</span><span class="lnt">196
</span><span class="lnt">197
</span><span class="lnt">198
</span><span class="lnt">199
</span><span class="lnt">200
</span><span class="lnt">201
</span><span class="lnt">202
</span><span class="lnt">203
</span><span class="lnt">204
</span><span class="lnt">205
</span><span class="lnt">206
</span><span class="lnt">207
</span><span class="lnt">208
</span><span class="lnt">209
</span><span class="lnt">210
</span><span class="lnt">211
</span><span class="lnt">212
</span><span class="lnt">213
</span><span class="lnt">214
</span><span class="lnt">215
</span><span class="lnt">216
</span><span class="lnt">217
</span><span class="lnt">218
</span><span class="lnt">219
</span><span class="lnt">220
</span><span class="lnt">221
</span><span class="lnt">222
</span><span class="lnt">223
</span><span class="lnt">224
</span><span class="lnt">225
</span><span class="lnt">226
</span><span class="lnt">227
</span><span class="lnt">228
</span><span class="lnt">229
</span><span class="lnt">230
</span><span class="lnt">231
</span><span class="lnt">232
</span><span class="lnt">233
</span><span class="lnt">234
</span><span class="lnt">235
</span><span class="lnt">236
</span><span class="lnt">237
</span><span class="lnt">238
</span><span class="lnt">239
</span><span class="lnt">240
</span><span class="lnt">241
</span><span class="lnt">242
</span><span class="lnt">243
</span><span class="lnt">244
</span><span class="lnt">245
</span><span class="lnt">246
</span><span class="lnt">247
</span><span class="lnt">248
</span><span class="lnt">249
</span><span class="lnt">250
</span><span class="lnt">251
</span><span class="lnt">252
</span><span class="lnt">253
</span><span class="lnt">254
</span><span class="lnt">255
</span><span class="lnt">256
</span><span class="lnt">257
</span><span class="lnt">258
</span><span class="lnt">259
</span><span class="lnt">260
</span><span class="lnt">261
</span><span class="lnt">262
</span><span class="lnt">263
</span><span class="lnt">264
</span><span class="lnt">265
</span><span class="lnt">266
</span><span class="lnt">267
</span><span class="lnt">268
</span><span class="lnt">269
</span><span class="lnt">270
</span><span class="lnt">271
</span><span class="lnt">272
</span><span class="lnt">273
</span><span class="lnt">274
</span><span class="lnt">275
</span><span class="lnt">276
</span><span class="lnt">277
</span><span class="lnt">278
</span><span class="lnt">279
</span><span class="lnt">280
</span><span class="lnt">281
</span><span class="lnt">282
</span><span class="lnt">283
</span><span class="lnt">284
</span><span class="lnt">285
</span><span class="lnt">286
</span><span class="lnt">287
</span><span class="lnt">288
</span><span class="lnt">289
</span><span class="lnt">290
</span><span class="lnt">291
</span><span class="lnt">292
</span><span class="lnt">293
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c++" data-lang="c++"><span class="c1">// Copyright 2010, Shuo Chen.  All rights reserved.
</span><span class="c1">// http://code.google.com/p/muduo/
</span><span class="c1">//
</span><span class="c1">// Use of this source code is governed by a BSD-style license
</span><span class="c1">// that can be found in the License file.
</span><span class="c1"></span> 
<span class="c1">// Author: Shuo Chen (chenshuo at chenshuo dot com)
</span><span class="c1"></span> 
<span class="cp">#include</span> <span class="cpf">&lt;muduo/net/EventLoop.h&gt;</span><span class="cp">
</span><span class="cp"></span> 
<span class="cp">#include</span> <span class="cpf">&lt;muduo/base/Logging.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;muduo/net/Channel.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;muduo/net/Poller.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;muduo/net/TimerQueue.h&gt;</span><span class="cp">
</span><span class="cp"></span> 
<span class="c1">//#include &lt;poll.h&gt;
</span><span class="c1"></span><span class="cp">#include</span> <span class="cpf">&lt;boost/bind.hpp&gt;</span><span class="cp">
</span><span class="cp"></span> 
<span class="cp">#include</span> <span class="cpf">&lt;sys/eventfd.h&gt;</span><span class="cp">
</span><span class="cp"></span> 
<span class="k">using</span> <span class="k">namespace</span> <span class="n">muduo</span><span class="p">;</span>
<span class="k">using</span> <span class="k">namespace</span> <span class="n">muduo</span><span class="o">::</span><span class="n">net</span><span class="p">;</span>
 
<span class="k">namespace</span>
<span class="p">{</span>
<span class="c1">// 当前线程EventLoop对象指针
</span><span class="c1">// 线程局部存储
</span><span class="c1"></span><span class="n">__thread</span> <span class="n">EventLoop</span><span class="o">*</span> <span class="n">t_loopInThisThread</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
 
<span class="k">const</span> <span class="kt">int</span> <span class="n">kPollTimeMs</span> <span class="o">=</span> <span class="mi">10000</span><span class="p">;</span>
 
<span class="kt">int</span> <span class="nf">createEventfd</span><span class="p">()</span>
<span class="p">{</span>
  <span class="kt">int</span> <span class="n">evtfd</span> <span class="o">=</span> <span class="o">::</span><span class="n">eventfd</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">EFD_NONBLOCK</span> <span class="o">|</span> <span class="n">EFD_CLOEXEC</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">evtfd</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">LOG_SYSERR</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;Failed in eventfd&#34;</span><span class="p">;</span>
    <span class="n">abort</span><span class="p">();</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="n">evtfd</span><span class="p">;</span>
<span class="p">}</span>
 
<span class="p">}</span>
 
<span class="n">EventLoop</span><span class="o">*</span> <span class="n">EventLoop</span><span class="o">::</span><span class="n">getEventLoopOfCurrentThread</span><span class="p">()</span>
<span class="p">{</span>
  <span class="k">return</span> <span class="n">t_loopInThisThread</span><span class="p">;</span>
<span class="p">}</span>
 
<span class="n">EventLoop</span><span class="o">::</span><span class="n">EventLoop</span><span class="p">()</span>
  <span class="o">:</span> <span class="n">looping_</span><span class="p">(</span><span class="nb">false</span><span class="p">),</span>
    <span class="n">quit_</span><span class="p">(</span><span class="nb">false</span><span class="p">),</span>
    <span class="n">eventHandling_</span><span class="p">(</span><span class="nb">false</span><span class="p">),</span>
    <span class="n">callingPendingFunctors_</span><span class="p">(</span><span class="nb">false</span><span class="p">),</span>
    <span class="n">threadId_</span><span class="p">(</span><span class="n">CurrentThread</span><span class="o">::</span><span class="n">tid</span><span class="p">()),</span>
    <span class="n">poller_</span><span class="p">(</span><span class="n">Poller</span><span class="o">::</span><span class="n">newDefaultPoller</span><span class="p">(</span><span class="k">this</span><span class="p">)),</span>
    <span class="n">timerQueue_</span><span class="p">(</span><span class="k">new</span> <span class="n">TimerQueue</span><span class="p">(</span><span class="k">this</span><span class="p">)),</span>
    <span class="n">wakeupFd_</span><span class="p">(</span><span class="n">createEventfd</span><span class="p">()),</span> <span class="c1">//创建 wakeupFd_
</span><span class="c1"></span>    <span class="n">wakeupChannel_</span><span class="p">(</span><span class="k">new</span> <span class="n">Channel</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="n">wakeupFd_</span><span class="p">)),</span> <span class="c1">//创建wakeupFd_对应的channel
</span><span class="c1"></span>    <span class="n">currentActiveChannel_</span><span class="p">(</span><span class="nb">NULL</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">LOG_TRACE</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;EventLoop created &#34;</span> <span class="o">&lt;&lt;</span> <span class="k">this</span> <span class="o">&lt;&lt;</span> <span class="s">&#34; in thread &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">threadId_</span><span class="p">;</span>
  <span class="c1">// 如果当前线程已经创建了EventLoop对象，终止(LOG_FATAL)
</span><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="n">t_loopInThisThread</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">LOG_FATAL</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;Another EventLoop &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">t_loopInThisThread</span>
              <span class="o">&lt;&lt;</span> <span class="s">&#34; exists in this thread &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">threadId_</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">else</span>
  <span class="p">{</span>
    <span class="n">t_loopInThisThread</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
  <span class="p">}</span>
 
  <span class="c1">// 设定wakeupChannel的回调函数
</span><span class="c1"></span>  <span class="n">wakeupChannel_</span><span class="o">-&gt;</span><span class="n">setReadCallback</span><span class="p">(</span>
      <span class="n">boost</span><span class="o">::</span><span class="n">bind</span><span class="p">(</span><span class="o">&amp;</span><span class="n">EventLoop</span><span class="o">::</span><span class="n">handleRead</span><span class="p">,</span> <span class="k">this</span><span class="p">));</span>
  <span class="c1">// we are always reading the wakeupfd
</span><span class="c1"></span>  <span class="c1">//纳入poller来管理
</span><span class="c1"></span>  <span class="n">wakeupChannel_</span><span class="o">-&gt;</span><span class="n">enableReading</span><span class="p">();</span>
<span class="p">}</span>
 
<span class="n">EventLoop</span><span class="o">::~</span><span class="n">EventLoop</span><span class="p">()</span>
<span class="p">{</span>
  <span class="o">::</span><span class="n">close</span><span class="p">(</span><span class="n">wakeupFd_</span><span class="p">);</span>
  <span class="n">t_loopInThisThread</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>
 
<span class="c1">// 事件循环，该函数不能跨线程调用
</span><span class="c1">// 只能在创建该对象的线程中调用
</span><span class="c1"></span><span class="kt">void</span> <span class="n">EventLoop</span><span class="o">::</span><span class="n">loop</span><span class="p">()</span>
<span class="p">{</span>
  <span class="n">assert</span><span class="p">(</span><span class="o">!</span><span class="n">looping_</span><span class="p">);</span>
  <span class="c1">// 断言当前处于创建该对象的线程中
</span><span class="c1"></span>  <span class="n">assertInLoopThread</span><span class="p">();</span>
  <span class="n">looping_</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
  <span class="n">quit_</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
  <span class="n">LOG_TRACE</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;EventLoop &#34;</span> <span class="o">&lt;&lt;</span> <span class="k">this</span> <span class="o">&lt;&lt;</span> <span class="s">&#34; start looping&#34;</span><span class="p">;</span>
 
  <span class="c1">//::poll(NULL, 0, 5*1000);
</span><span class="c1"></span>  <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">quit_</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">activeChannels_</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span>
    <span class="n">pollReturnTime_</span> <span class="o">=</span> <span class="n">poller_</span><span class="o">-&gt;</span><span class="n">poll</span><span class="p">(</span><span class="n">kPollTimeMs</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">activeChannels_</span><span class="p">);</span>
    <span class="c1">//++iteration_;
</span><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">Logger</span><span class="o">::</span><span class="n">logLevel</span><span class="p">()</span> <span class="o">&lt;=</span> <span class="n">Logger</span><span class="o">::</span><span class="n">TRACE</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">printActiveChannels</span><span class="p">();</span>
    <span class="p">}</span>
    <span class="c1">// TODO sort channel by priority
</span><span class="c1"></span>    <span class="n">eventHandling_</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">ChannelList</span><span class="o">::</span><span class="n">iterator</span> <span class="n">it</span> <span class="o">=</span> <span class="n">activeChannels_</span><span class="p">.</span><span class="n">begin</span><span class="p">();</span>
        <span class="n">it</span> <span class="o">!=</span> <span class="n">activeChannels_</span><span class="p">.</span><span class="n">end</span><span class="p">();</span> <span class="o">++</span><span class="n">it</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">currentActiveChannel_</span> <span class="o">=</span> <span class="o">*</span><span class="n">it</span><span class="p">;</span>
      <span class="n">currentActiveChannel_</span><span class="o">-&gt;</span><span class="n">handleEvent</span><span class="p">(</span><span class="n">pollReturnTime_</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">currentActiveChannel_</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="n">eventHandling_</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
    <span class="c1">// 让IO线程也能执行一些计算任务
</span><span class="c1"></span>    <span class="n">doPendingFunctors</span><span class="p">();</span>
  <span class="p">}</span>
 
  <span class="n">LOG_TRACE</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;EventLoop &#34;</span> <span class="o">&lt;&lt;</span> <span class="k">this</span> <span class="o">&lt;&lt;</span> <span class="s">&#34; stop looping&#34;</span><span class="p">;</span>
  <span class="n">looping_</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>
 
<span class="c1">// 该函数可以跨线程调用
</span><span class="c1"></span><span class="kt">void</span> <span class="n">EventLoop</span><span class="o">::</span><span class="n">quit</span><span class="p">()</span>
<span class="p">{</span>
  <span class="n">quit_</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
  <span class="c1">//如果不是由当前IO线程调用的，那么我们还要唤醒IO线程
</span><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">isInLoopThread</span><span class="p">())</span>
  <span class="p">{</span>
    <span class="n">wakeup</span><span class="p">();</span>
  <span class="p">}</span>
<span class="p">}</span>
<span class="cm">/*
</span><span class="cm">sublime 注释的好方法，都是苦力活
</span><span class="cm">===========         ===================               ======         ===================
</span><span class="cm">||        |||      |||=================             =                         {}
</span><span class="cm">||        ****      ||                             =                          {}
</span><span class="cm">||       ****       ||                            =                           {}
</span><span class="cm">|||||||||           ||=================              =  = = =                 {}
</span><span class="cm">||      \\\         ||==================                      ///             {}
</span><span class="cm">||        \\        ||                                      = //              {}
</span><span class="cm">                    //                                        //              {}
</span><span class="cm">||        \\\       || ==================                    //               {}
</span><span class="cm">||          \\      ||===================           =========                 {}
</span><span class="cm">*/</span>
<span class="c1">// 在I/O线程中注册某个回调函数，该函数可以跨线程调用
</span><span class="c1"></span><span class="kt">void</span> <span class="n">EventLoop</span><span class="o">::</span><span class="n">runInLoop</span><span class="p">(</span><span class="k">const</span> <span class="n">Functor</span><span class="o">&amp;</span> <span class="n">cb</span><span class="p">)</span>
<span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">isInLoopThread</span><span class="p">())</span>
  <span class="p">{</span>
    <span class="c1">// 如果是当前IO线程调用runInLoop，则同步调用cb
</span><span class="c1"></span>    <span class="n">cb</span><span class="p">();</span>
  <span class="p">}</span>
  <span class="k">else</span>
  <span class="p">{</span>
    <span class="c1">// 如果是其它线程调用runInLoop，则异步地将cb添加到队列，让EventLoop线程来执行这个cb（）函数
</span><span class="c1"></span>    <span class="n">queueInLoop</span><span class="p">(</span><span class="n">cb</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>
 
<span class="c1">// 把IO回调函数注册到pendingFunctors_中
</span><span class="c1"></span><span class="kt">void</span> <span class="n">EventLoop</span><span class="o">::</span><span class="n">queueInLoop</span><span class="p">(</span><span class="k">const</span> <span class="n">Functor</span><span class="o">&amp;</span> <span class="n">cb</span><span class="p">)</span>
<span class="p">{</span>
  <span class="p">{</span>
    <span class="c1">// 保护临界区
</span><span class="c1"></span>  <span class="n">MutexLockGuard</span> <span class="n">lock</span><span class="p">(</span><span class="n">mutex_</span><span class="p">);</span>
    <span class="c1">// 将任务添加到任务队列中
</span><span class="c1"></span>  <span class="n">pendingFunctors_</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">cb</span><span class="p">);</span>
  <span class="p">}</span>
 
  <span class="c1">// 1.---&gt;调用queueInLoop的线程不是IO线程需要唤醒，以便IO线程及时处理任务
</span><span class="c1"></span>  <span class="c1">// 2.---&gt;或者调用queueInLoop的线程是IO线程，并且此时正在调用pending functor，需要唤醒
</span><span class="c1"></span>   <span class="cm">/*   如果我们不唤醒，那么下一次poll就没法获取该cb的触发事件，这样就会使事件处理延迟了 ，请参照loop函数 */</span>
  <span class="c1">// 3----&gt;只有IO线程的事件回调中调用queueInLoop才不需要唤醒 ，因为handleEvent执行后，
</span><span class="c1"></span>  <span class="c1">//下面接着执行doPendingFunctors
</span><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">isInLoopThread</span><span class="p">()</span> <span class="o">||</span> <span class="n">callingPendingFunctors_</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">wakeup</span><span class="p">();</span>
  <span class="p">}</span>
<span class="p">}</span>
 
<span class="n">TimerId</span> <span class="n">EventLoop</span><span class="o">::</span><span class="n">runAt</span><span class="p">(</span><span class="k">const</span> <span class="n">Timestamp</span><span class="o">&amp;</span> <span class="n">time</span><span class="p">,</span> <span class="k">const</span> <span class="n">TimerCallback</span><span class="o">&amp;</span> <span class="n">cb</span><span class="p">)</span>
<span class="p">{</span>
  <span class="k">return</span> <span class="n">timerQueue_</span><span class="o">-&gt;</span><span class="n">addTimer</span><span class="p">(</span><span class="n">cb</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">);</span>
<span class="p">}</span>
 
<span class="n">TimerId</span> <span class="n">EventLoop</span><span class="o">::</span><span class="n">runAfter</span><span class="p">(</span><span class="kt">double</span> <span class="n">delay</span><span class="p">,</span> <span class="k">const</span> <span class="n">TimerCallback</span><span class="o">&amp;</span> <span class="n">cb</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">Timestamp</span> <span class="n">time</span><span class="p">(</span><span class="n">addTime</span><span class="p">(</span><span class="n">Timestamp</span><span class="o">::</span><span class="n">now</span><span class="p">(),</span> <span class="n">delay</span><span class="p">));</span>
  <span class="k">return</span> <span class="nf">runAt</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="n">cb</span><span class="p">);</span>
<span class="p">}</span>
 
<span class="n">TimerId</span> <span class="n">EventLoop</span><span class="o">::</span><span class="n">runEvery</span><span class="p">(</span><span class="kt">double</span> <span class="n">interval</span><span class="p">,</span> <span class="k">const</span> <span class="n">TimerCallback</span><span class="o">&amp;</span> <span class="n">cb</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">Timestamp</span> <span class="n">time</span><span class="p">(</span><span class="n">addTime</span><span class="p">(</span><span class="n">Timestamp</span><span class="o">::</span><span class="n">now</span><span class="p">(),</span> <span class="n">interval</span><span class="p">));</span>
  <span class="k">return</span> <span class="n">timerQueue_</span><span class="o">-&gt;</span><span class="n">addTimer</span><span class="p">(</span><span class="n">cb</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">interval</span><span class="p">);</span>
<span class="p">}</span>
 
<span class="kt">void</span> <span class="n">EventLoop</span><span class="o">::</span><span class="n">cancel</span><span class="p">(</span><span class="n">TimerId</span> <span class="n">timerId</span><span class="p">)</span>
<span class="p">{</span>
  <span class="k">return</span> <span class="n">timerQueue_</span><span class="o">-&gt;</span><span class="n">cancel</span><span class="p">(</span><span class="n">timerId</span><span class="p">);</span>
<span class="p">}</span>
 
<span class="kt">void</span> <span class="n">EventLoop</span><span class="o">::</span><span class="n">updateChannel</span><span class="p">(</span><span class="n">Channel</span><span class="o">*</span> <span class="n">channel</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">assert</span><span class="p">(</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">ownerLoop</span><span class="p">()</span> <span class="o">==</span> <span class="k">this</span><span class="p">);</span>
  <span class="n">assertInLoopThread</span><span class="p">();</span>
  <span class="n">poller_</span><span class="o">-&gt;</span><span class="n">updateChannel</span><span class="p">(</span><span class="n">channel</span><span class="p">);</span>
<span class="p">}</span>
 
<span class="kt">void</span> <span class="n">EventLoop</span><span class="o">::</span><span class="n">removeChannel</span><span class="p">(</span><span class="n">Channel</span><span class="o">*</span> <span class="n">channel</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">assert</span><span class="p">(</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">ownerLoop</span><span class="p">()</span> <span class="o">==</span> <span class="k">this</span><span class="p">);</span>
  <span class="n">assertInLoopThread</span><span class="p">();</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">eventHandling_</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">assert</span><span class="p">(</span><span class="n">currentActiveChannel_</span> <span class="o">==</span> <span class="n">channel</span> <span class="o">||</span>
        <span class="n">std</span><span class="o">::</span><span class="n">find</span><span class="p">(</span><span class="n">activeChannels_</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span> <span class="n">activeChannels_</span><span class="p">.</span><span class="n">end</span><span class="p">(),</span> <span class="n">channel</span><span class="p">)</span> <span class="o">==</span> <span class="n">activeChannels_</span><span class="p">.</span><span class="n">end</span><span class="p">());</span>
  <span class="p">}</span>
  <span class="n">poller_</span><span class="o">-&gt;</span><span class="n">removeChannel</span><span class="p">(</span><span class="n">channel</span><span class="p">);</span>
<span class="p">}</span>
 
<span class="kt">void</span> <span class="n">EventLoop</span><span class="o">::</span><span class="n">abortNotInLoopThread</span><span class="p">()</span>
<span class="p">{</span>
  <span class="n">LOG_FATAL</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;EventLoop::abortNotInLoopThread - EventLoop &#34;</span> <span class="o">&lt;&lt;</span> <span class="k">this</span>
            <span class="o">&lt;&lt;</span> <span class="s">&#34; was created in threadId_ = &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">threadId_</span>
            <span class="o">&lt;&lt;</span> <span class="s">&#34;, current thread id = &#34;</span> <span class="o">&lt;&lt;</span>  <span class="n">CurrentThread</span><span class="o">::</span><span class="n">tid</span><span class="p">();</span>
<span class="p">}</span>
 
<span class="cm">/*
</span><span class="cm"> 
</span><span class="cm"> 
</span><span class="cm">唤醒等待的线程
</span><span class="cm">*/</span>
<span class="kt">void</span> <span class="n">EventLoop</span><span class="o">::</span><span class="n">wakeup</span><span class="p">()</span>
<span class="p">{</span>
  <span class="n">uint64_t</span> <span class="n">one</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
  <span class="c1">//ssize_t n = sockets::write(wakeupFd_, &amp;one, sizeof one);
</span><span class="c1"></span>  <span class="cm">/*向wakeupFd_中写入数据*/</span>
  <span class="n">ssize_t</span> <span class="n">n</span> <span class="o">=</span> <span class="o">::</span><span class="n">write</span><span class="p">(</span><span class="n">wakeupFd_</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">one</span><span class="p">,</span> <span class="k">sizeof</span> <span class="n">one</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">!=</span> <span class="k">sizeof</span> <span class="n">one</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">LOG_ERROR</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;EventLoop::wakeup() writes &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">n</span> <span class="o">&lt;&lt;</span> <span class="s">&#34; bytes instead of 8&#34;</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>
 
<span class="c1">// IO事件回调函数
</span><span class="c1"></span><span class="kt">void</span> <span class="n">EventLoop</span><span class="o">::</span><span class="n">handleRead</span><span class="p">()</span>
<span class="p">{</span>
  <span class="n">uint64_t</span> <span class="n">one</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
  <span class="c1">//ssize_t n = sockets::read(wakeupFd_, &amp;one, sizeof one);---&gt;&gt;muduolib
</span><span class="c1"></span>  <span class="n">ssize_t</span> <span class="n">n</span> <span class="o">=</span> <span class="o">::</span><span class="n">read</span><span class="p">(</span><span class="n">wakeupFd_</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">one</span><span class="p">,</span> <span class="k">sizeof</span> <span class="n">one</span><span class="p">);</span> <span class="c1">// 这是先这样设定
</span><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">!=</span> <span class="k">sizeof</span> <span class="n">one</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">LOG_ERROR</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;EventLoop::handleRead() reads &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">n</span> <span class="o">&lt;&lt;</span> <span class="s">&#34; bytes instead of 8&#34;</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>
 
<span class="cm">/*IO线程的回调函数集 处理函数*/</span>
<span class="kt">void</span> <span class="n">EventLoop</span><span class="o">::</span><span class="n">doPendingFunctors</span><span class="p">()</span>
<span class="p">{</span>
  <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">Functor</span><span class="o">&gt;</span> <span class="n">functors</span><span class="p">;</span>
  <span class="cm">/*正在处于IO线程处理函数中*/</span>
  <span class="n">callingPendingFunctors_</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
 
  <span class="p">{</span>
    <span class="c1">// 加锁
</span><span class="c1"></span>  <span class="n">MutexLockGuard</span> <span class="n">lock</span><span class="p">(</span><span class="n">mutex_</span><span class="p">);</span>
  <span class="c1">//交换，顺带将pendingFunctors清空
</span><span class="c1"></span>  <span class="n">functors</span><span class="p">.</span><span class="n">swap</span><span class="p">(</span><span class="n">pendingFunctors_</span><span class="p">);</span>
  <span class="p">}</span>
 
  <span class="k">for</span> <span class="p">(</span><span class="n">size_t</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">functors</span><span class="p">.</span><span class="n">size</span><span class="p">();</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">functors</span><span class="p">[</span><span class="n">i</span><span class="p">]();</span>
  <span class="p">}</span>
  <span class="cm">/*清空IO线程回调处理函数中 的状态*/</span>
  <span class="n">callingPendingFunctors_</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>
 
<span class="kt">void</span> <span class="n">EventLoop</span><span class="o">::</span><span class="n">printActiveChannels</span><span class="p">()</span> <span class="k">const</span>
<span class="p">{</span>
  <span class="k">for</span> <span class="p">(</span><span class="n">ChannelList</span><span class="o">::</span><span class="n">const_iterator</span> <span class="n">it</span> <span class="o">=</span> <span class="n">activeChannels_</span><span class="p">.</span><span class="n">begin</span><span class="p">();</span>
      <span class="n">it</span> <span class="o">!=</span> <span class="n">activeChannels_</span><span class="p">.</span><span class="n">end</span><span class="p">();</span> <span class="o">++</span><span class="n">it</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="k">const</span> <span class="n">Channel</span><span class="o">*</span> <span class="n">ch</span> <span class="o">=</span> <span class="o">*</span><span class="n">it</span><span class="p">;</span>
    <span class="n">LOG_TRACE</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;{&#34;</span> <span class="o">&lt;&lt;</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">reventsToString</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;} &#34;</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div>
<h3 id="测试程序源代码">测试程序源代码</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-c++" data-lang="c++"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c++" data-lang="c++"><span class="cp">#include</span> <span class="cpf">&lt;muduo/net/EventLoop.h&gt;</span><span class="cp">
</span><span class="cp"></span><span class="c1">//#include &lt;muduo/net/EventLoopThread.h&gt;
</span><span class="c1">//#include &lt;muduo/base/Thread.h&gt;
</span><span class="c1"></span> 
<span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
</span><span class="cp"></span> 
<span class="k">using</span> <span class="k">namespace</span> <span class="n">muduo</span><span class="p">;</span>
<span class="k">using</span> <span class="k">namespace</span> <span class="n">muduo</span><span class="o">::</span><span class="n">net</span><span class="p">;</span>
 
<span class="n">EventLoop</span><span class="o">*</span> <span class="n">g_loop</span><span class="p">;</span>
<span class="kt">int</span> <span class="n">g_flag</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
 
<span class="kt">void</span> <span class="nf">run4</span><span class="p">()</span>
<span class="p">{</span>
  <span class="n">printf</span><span class="p">(</span><span class="s">&#34;run4(): pid = %d, flag = %d</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">getpid</span><span class="p">(),</span> <span class="n">g_flag</span><span class="p">);</span>
  <span class="n">g_loop</span><span class="o">-&gt;</span><span class="n">quit</span><span class="p">();</span>
<span class="p">}</span>
 
<span class="kt">void</span> <span class="nf">run3</span><span class="p">()</span>
<span class="p">{</span>
  <span class="n">printf</span><span class="p">(</span><span class="s">&#34;run3(): pid = %d, flag = %d</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">getpid</span><span class="p">(),</span> <span class="n">g_flag</span><span class="p">);</span>
 
  <span class="n">g_loop</span><span class="o">-&gt;</span><span class="n">runAfter</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">run4</span><span class="p">);</span>
  <span class="n">g_flag</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
<span class="p">}</span>
 
<span class="kt">void</span> <span class="nf">run2</span><span class="p">()</span>
<span class="p">{</span>
  <span class="n">printf</span><span class="p">(</span><span class="s">&#34;run2(): pid = %d, flag = %d</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">getpid</span><span class="p">(),</span> <span class="n">g_flag</span><span class="p">);</span>
    <span class="cm">/*在IO线程中直接调用queueInLoop，并且if (!isInLoopThread() || callingPendingFunctors_)时，
</span><span class="cm">  不用唤醒（wakeup()）
</span><span class="cm">    */</span>
  <span class="n">g_loop</span><span class="o">-&gt;</span><span class="n">queueInLoop</span><span class="p">(</span><span class="n">run3</span><span class="p">);</span>
<span class="p">}</span>
 
<span class="kt">void</span> <span class="nf">run1</span><span class="p">()</span>
<span class="p">{</span>
  <span class="n">g_flag</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
  <span class="n">printf</span><span class="p">(</span><span class="s">&#34;run1(): pid = %d, flag = %d</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">getpid</span><span class="p">(),</span> <span class="n">g_flag</span><span class="p">);</span>
  <span class="cm">/*在IO线程中，调用runInLoop时，不用经过queueInLoop（）就可以直接调用Functors*/</span>
  <span class="n">g_loop</span><span class="o">-&gt;</span><span class="n">runInLoop</span><span class="p">(</span><span class="n">run2</span><span class="p">);</span>
  <span class="n">g_flag</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
<span class="p">}</span>
 
<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>
<span class="p">{</span>
  <span class="n">printf</span><span class="p">(</span><span class="s">&#34;main(): pid = %d, flag = %d</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">getpid</span><span class="p">(),</span> <span class="n">g_flag</span><span class="p">);</span>
 
  <span class="n">EventLoop</span> <span class="n">loop</span><span class="p">;</span>
  <span class="n">g_loop</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">loop</span><span class="p">;</span>
 
  <span class="n">loop</span><span class="p">.</span><span class="n">runAfter</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">run1</span><span class="p">);</span>
  <span class="n">loop</span><span class="p">.</span><span class="n">loop</span><span class="p">();</span>
  <span class="n">printf</span><span class="p">(</span><span class="s">&#34;main(): pid = %d, flag = %d</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">getpid</span><span class="p">(),</span> <span class="n">g_flag</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div>
<h3 id="测试输出">测试输出</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-sh" data-lang="sh"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-sh" data-lang="sh">ubuntu@ubuntu-virtual-machine:~/29/jmuduo$ ../build/debug/bin/reactor_test05
main<span class="o">()</span>: <span class="nv">pid</span> <span class="o">=</span> <span class="m">28193</span>, <span class="nv">flag</span> <span class="o">=</span> <span class="m">0</span>
<span class="m">20131022</span> <span class="m">01</span>:36:15.466526Z <span class="m">28193</span> TRACE updateChannel <span class="nv">fd</span> <span class="o">=</span> <span class="m">4</span> <span class="nv">events</span> <span class="o">=</span> <span class="m">3</span> - EPollPoller.cc:104
<span class="m">20131022</span> <span class="m">01</span>:36:15.467517Z <span class="m">28193</span> TRACE EventLoop EventLoop created 0xBFEDB874 in thread <span class="m">28193</span> - EventLoop.cc:62
<span class="m">20131022</span> <span class="m">01</span>:36:15.467586Z <span class="m">28193</span> TRACE updateChannel <span class="nv">fd</span> <span class="o">=</span> <span class="m">5</span> <span class="nv">events</span> <span class="o">=</span> <span class="m">3</span> - EPollPoller.cc:104
<span class="m">20131022</span> <span class="m">01</span>:36:15.467898Z <span class="m">28193</span> TRACE loop EventLoop 0xBFEDB874 start looping - EventLoop.cc:94
<span class="m">20131022</span> <span class="m">01</span>:36:17.469365Z <span class="m">28193</span> TRACE poll <span class="m">1</span> events happended - EPollPoller.cc:65
<span class="m">20131022</span> <span class="m">01</span>:36:17.482824Z <span class="m">28193</span> TRACE printActiveChannels <span class="o">{</span><span class="m">4</span>: IN <span class="o">}</span>  - EventLoop.cc:257
<span class="m">20131022</span> <span class="m">01</span>:36:17.483170Z <span class="m">28193</span> TRACE readTimerfd TimerQueue::handleRead<span class="o">()</span> <span class="m">1</span> at <span class="m">1382405777</span>.482909 - TimerQueue.cc:62
run1<span class="o">()</span>: <span class="nv">pid</span> <span class="o">=</span> <span class="m">28193</span>, <span class="nv">flag</span> <span class="o">=</span> <span class="m">1</span>
run2<span class="o">()</span>: <span class="nv">pid</span> <span class="o">=</span> <span class="m">28193</span>, <span class="nv">flag</span> <span class="o">=</span> <span class="m">1</span>
run3<span class="o">()</span>: <span class="nv">pid</span> <span class="o">=</span> <span class="m">28193</span>, <span class="nv">flag</span> <span class="o">=</span> <span class="m">2</span>
<span class="m">20131022</span> <span class="m">01</span>:36:20.483953Z <span class="m">28193</span> TRACE poll <span class="m">1</span> events happended - EPollPoller.cc:65
<span class="m">20131022</span> <span class="m">01</span>:36:20.484074Z <span class="m">28193</span> TRACE printActiveChannels <span class="o">{</span><span class="m">4</span>: IN <span class="o">}</span>  - EventLoop.cc:257
<span class="m">20131022</span> <span class="m">01</span>:36:20.484119Z <span class="m">28193</span> TRACE readTimerfd TimerQueue::handleRead<span class="o">()</span> <span class="m">1</span> at <span class="m">1382405780</span>.484109 - TimerQueue.cc:62
run4<span class="o">()</span>: <span class="nv">pid</span> <span class="o">=</span> <span class="m">28193</span>, <span class="nv">flag</span> <span class="o">=</span> <span class="m">3</span>
<span class="m">20131022</span> <span class="m">01</span>:36:20.484229Z <span class="m">28193</span> TRACE loop EventLoop 0xBFEDB874 stop looping - EventLoop.cc:119
main<span class="o">()</span>: <span class="nv">pid</span> <span class="o">=</span> <span class="m">28193</span>, <span class="nv">flag</span> <span class="o">=</span> <span class="m">3</span>
ubuntu@ubuntu-virtual-machine:~/29/jmuduo$</code></pre></td></tr></table>
</div>
</div>
<h2 id="30-eventloopthread">[30] EventLoopThread</h2>

<p>任何一个线程，只要创建并运行了EventLoop，都称之为IO线程</p>

<p>IO线程不一定是主线程</p>

<p>muduo并发模型one loop per thread + threadpool</p>

<p>为了方便今后使用，定义了EventLoopThread类，该类封装了IO线程EventLoopThread创建了一个线程</p>

<p>在线程函数中创建了一个EvenLoop对象并调用EventLoop::loop</p>

<h3 id="eventloopthread头文件">EventLoopThread头文件</h3>

<p>eventloopthread.h</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-c++" data-lang="c++"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c++" data-lang="c++"><span class="c1">// Copyright 2010, Shuo Chen.  All rights reserved.
</span><span class="c1">// http://code.google.com/p/muduo/
</span><span class="c1">//
</span><span class="c1">// Use of this source code is governed by a BSD-style license
</span><span class="c1">// that can be found in the License file.
</span><span class="c1"></span> 
<span class="c1">// Author: Shuo Chen (chenshuo at chenshuo dot com)
</span><span class="c1">//
</span><span class="c1">// This is a public header file, it must only include public header files.
</span><span class="c1"></span> 
<span class="cp">#ifndef MUDUO_NET_EVENTLOOPTHREAD_H
</span><span class="cp">#define MUDUO_NET_EVENTLOOPTHREAD_H
</span><span class="cp"></span> 
<span class="cp">#include</span> <span class="cpf">&lt;muduo/base/Condition.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;muduo/base/Mutex.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;muduo/base/Thread.h&gt;</span><span class="cp">
</span><span class="cp"></span> 
<span class="cp">#include</span> <span class="cpf">&lt;boost/noncopyable.hpp&gt;</span><span class="cp">
</span><span class="cp"></span> 
<span class="k">namespace</span> <span class="n">muduo</span>
<span class="p">{</span>
<span class="k">namespace</span> <span class="n">net</span>
<span class="p">{</span>
 
<span class="k">class</span><span class="err"> </span><span class="nc">EventLoop</span><span class="p">;</span>
 
<span class="k">class</span><span class="err"> </span><span class="nc">EventLoopThread</span> <span class="o">:</span> <span class="n">boost</span><span class="o">::</span><span class="n">noncopyable</span>
<span class="p">{</span>
 <span class="k">public</span><span class="o">:</span>
  <span class="k">typedef</span> <span class="n">boost</span><span class="o">::</span><span class="n">function</span><span class="o">&lt;</span><span class="kt">void</span><span class="p">(</span><span class="n">EventLoop</span><span class="o">*</span><span class="p">)</span><span class="o">&gt;</span> <span class="n">ThreadInitCallback</span><span class="p">;</span>
 
  <span class="n">EventLoopThread</span><span class="p">(</span><span class="k">const</span> <span class="n">ThreadInitCallback</span><span class="o">&amp;</span> <span class="n">cb</span> <span class="o">=</span><span class="n">ThreadInitCallback</span><span class="p">());</span>
  <span class="o">~</span><span class="n">EventLoopThread</span><span class="p">();</span>
  <span class="n">EventLoop</span><span class="o">*</span> <span class="nf">startLoop</span><span class="p">();</span>   <span class="c1">// 启动线程，该线程就成为了IO线程
</span><span class="c1"></span> 
 <span class="k">private</span><span class="o">:</span>
  <span class="kt">void</span> <span class="n">threadFunc</span><span class="p">();</span>        <span class="c1">// 线程函数 ，这个线程函数启动起来之后，会创建一个eventloop对象，loop_指针会指向这个对象
</span><span class="c1"></span> 
  <span class="n">EventLoop</span><span class="o">*</span> <span class="n">loop_</span><span class="p">;</span>         <span class="c1">// loop_指针指向一个EventLoop对象，一个IO线程有且只有一个eventloop对象
</span><span class="c1"></span>  <span class="kt">bool</span> <span class="n">exiting_</span><span class="p">;</span>
  <span class="n">Thread</span> <span class="n">thread_</span><span class="p">;</span>       <span class="c1">//线程对象
</span><span class="c1"></span>  <span class="n">MutexLock</span> <span class="n">mutex_</span><span class="p">;</span>
  <span class="n">Condition</span> <span class="n">cond_</span><span class="p">;</span>
  <span class="n">ThreadInitCallback</span> <span class="n">callback_</span><span class="p">;</span>     <span class="c1">// 回调函数在EventLoop::loop IO线程的事件循环之前被调用
</span><span class="c1"></span><span class="p">};</span>
 
<span class="p">}</span>
<span class="p">}</span>
 
<span class="cp">#endif  </span><span class="c1">// MUDUO_NET_EVENTLOOPTHREAD_H
</span></code></pre></td></tr></table>
</div>
</div>
<h3 id="eventloopthread源文件">EventLoopThread源文件</h3>

<p>eventloopthread.cc</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-c++" data-lang="c++"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c++" data-lang="c++"><span class="c1">// Copyright 2010, Shuo Chen.  All rights reserved.
</span><span class="c1">// http://code.google.com/p/muduo/
</span><span class="c1">//
</span><span class="c1">// Use of this source code is governed by a BSD-style license
</span><span class="c1">// that can be found in the License file.
</span><span class="c1"></span> 
<span class="c1">// Author: Shuo Chen (chenshuo at chenshuo dot com)
</span><span class="c1"></span> 
<span class="cp">#include</span> <span class="cpf">&lt;muduo/net/EventLoopThread.h&gt;</span><span class="cp">
</span><span class="cp"></span> 
<span class="cp">#include</span> <span class="cpf">&lt;muduo/net/EventLoop.h&gt;</span><span class="cp">
</span><span class="cp"></span> 
<span class="cp">#include</span> <span class="cpf">&lt;boost/bind.hpp&gt;</span><span class="cp">
</span><span class="cp"></span> 
<span class="k">using</span> <span class="k">namespace</span> <span class="n">muduo</span><span class="p">;</span>
<span class="k">using</span> <span class="k">namespace</span> <span class="n">muduo</span><span class="o">::</span><span class="n">net</span><span class="p">;</span>
<span class="c1">// typedef boost::function&lt;void(EventLoop*)&gt; ThreadInitCallback;
</span><span class="c1"></span> 
<span class="n">EventLoopThread</span><span class="o">::</span><span class="n">EventLoopThread</span><span class="p">(</span><span class="k">const</span> <span class="n">ThreadInitCallback</span><span class="o">&amp;</span> <span class="n">cb</span><span class="p">)</span>
  <span class="o">:</span> <span class="n">loop_</span><span class="p">(</span><span class="nb">NULL</span><span class="p">),</span>
    <span class="n">exiting_</span><span class="p">(</span><span class="nb">false</span><span class="p">),</span>
    <span class="n">thread_</span><span class="p">(</span><span class="n">boost</span><span class="o">::</span><span class="n">bind</span><span class="p">(</span><span class="o">&amp;</span><span class="n">EventLoopThread</span><span class="o">::</span><span class="n">threadFunc</span><span class="p">,</span> <span class="k">this</span><span class="p">)),</span>
    <span class="n">mutex_</span><span class="p">(),</span>
    <span class="n">cond_</span><span class="p">(</span><span class="n">mutex_</span><span class="p">),</span>
    <span class="n">callback_</span><span class="p">(</span><span class="n">cb</span><span class="p">)</span>  <span class="c1">//cb 默认为空
</span><span class="c1"></span><span class="p">{</span>
<span class="p">}</span>
 
<span class="n">EventLoopThread</span><span class="o">::~</span><span class="n">EventLoopThread</span><span class="p">()</span>
<span class="p">{</span>
  <span class="n">exiting_</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
  <span class="n">loop_</span><span class="o">-&gt;</span><span class="n">quit</span><span class="p">();</span>     <span class="c1">// 退出IO线程，让IO线程的loop循环退出，从而退出了IO线程
</span><span class="c1"></span>  <span class="n">thread_</span><span class="p">.</span><span class="n">join</span><span class="p">();</span>
<span class="p">}</span>
 
<span class="cm">/*启动线程，也就是启动loop函数EventLoopThread::threadFunc这个函数*/</span>
<span class="n">EventLoop</span><span class="o">*</span> <span class="n">EventLoopThread</span><span class="o">::</span><span class="n">startLoop</span><span class="p">()</span>
<span class="p">{</span>
  <span class="n">assert</span><span class="p">(</span><span class="o">!</span><span class="n">thread_</span><span class="p">.</span><span class="n">started</span><span class="p">());</span>
  <span class="cm">/*线程启动时会调用*/</span>
  <span class="n">thread_</span><span class="p">.</span><span class="n">start</span><span class="p">();</span>
 
  <span class="p">{</span>
    <span class="n">MutexLockGuard</span> <span class="n">lock</span><span class="p">(</span><span class="n">mutex_</span><span class="p">);</span>
    <span class="cm">/*eventloop对象创建完成*/</span>
    <span class="k">while</span> <span class="p">(</span><span class="n">loop_</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">cond_</span><span class="p">.</span><span class="n">wait</span><span class="p">();</span>
    <span class="p">}</span>
  <span class="p">}</span>
 
  <span class="k">return</span> <span class="n">loop_</span><span class="p">;</span>
<span class="p">}</span>
 
<span class="cm">/*loop 的初始化函数*/</span>
<span class="kt">void</span> <span class="n">EventLoopThread</span><span class="o">::</span><span class="n">threadFunc</span><span class="p">()</span>
<span class="p">{</span>
  <span class="n">EventLoop</span> <span class="n">loop</span><span class="p">;</span>
  <span class="cm">/*创建eventloop对象*/</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">callback_</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">callback_</span><span class="p">(</span><span class="o">&amp;</span><span class="n">loop</span><span class="p">);</span>
  <span class="p">}</span>
 
  <span class="p">{</span>
    <span class="n">MutexLockGuard</span> <span class="n">lock</span><span class="p">(</span><span class="n">mutex_</span><span class="p">);</span>
    <span class="c1">// loop_指针指向了一个栈上的对象，threadFunc函数退出之后，这个指针就失效了
</span><span class="c1"></span>    <span class="c1">// threadFunc函数退出，就意味着线程退出了，EventLoopThread对象也就没有存在的价值了。
</span><span class="c1"></span>    <span class="c1">// 因而不会有什么大的问题
</span><span class="c1"></span>    <span class="n">loop_</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">loop</span><span class="p">;</span>
    <span class="n">cond_</span><span class="p">.</span><span class="n">notify</span><span class="p">();</span>
  <span class="p">}</span>
  <span class="cm">/*启动loop（）函数*/</span>
  <span class="n">loop</span><span class="p">.</span><span class="n">loop</span><span class="p">();</span>
  <span class="c1">//assert(exiting_);
</span><span class="c1"></span><span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div>
<h3 id="测试程序-1">测试程序</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-c++" data-lang="c++"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span><span class="lnt">84
</span><span class="lnt">85
</span><span class="lnt">86
</span><span class="lnt">87
</span><span class="lnt">88
</span><span class="lnt">89
</span><span class="lnt">90
</span><span class="lnt">91
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c++" data-lang="c++"><span class="cp">#include</span> <span class="cpf">&lt;muduo/net/EventLoop.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;muduo/net/EventLoopThread.h&gt;</span><span class="cp">
</span><span class="cp"></span> 
<span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
</span><span class="cp"></span> 
<span class="k">using</span> <span class="k">namespace</span> <span class="n">muduo</span><span class="p">;</span>
<span class="k">using</span> <span class="k">namespace</span> <span class="n">muduo</span><span class="o">::</span><span class="n">net</span><span class="p">;</span>
 
<span class="kt">void</span> <span class="nf">runInThread</span><span class="p">()</span>
<span class="p">{</span>
  <span class="n">printf</span><span class="p">(</span><span class="s">&#34;runInThread(): pid = %d, tid = %d</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span>
         <span class="n">getpid</span><span class="p">(),</span> <span class="n">CurrentThread</span><span class="o">::</span><span class="n">tid</span><span class="p">());</span>
<span class="p">}</span>
 
<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>
<span class="p">{</span>
  <span class="n">printf</span><span class="p">(</span><span class="s">&#34;main(): pid = %d, tid = %d</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span>
         <span class="n">getpid</span><span class="p">(),</span> <span class="n">CurrentThread</span><span class="o">::</span><span class="n">tid</span><span class="p">());</span>
 
  <span class="n">EventLoopThread</span> <span class="n">loopThread</span><span class="p">;</span>
  <span class="n">EventLoop</span><span class="o">*</span> <span class="n">loop</span> <span class="o">=</span> <span class="n">loopThread</span><span class="p">.</span><span class="n">startLoop</span><span class="p">();</span>
  <span class="c1">// 异步调用runInThread，即将runInThread添加到loop对象所在IO线程，让该IO线程执行
</span><span class="c1"></span>  <span class="n">loop</span><span class="o">-&gt;</span><span class="n">runInLoop</span><span class="p">(</span><span class="n">runInThread</span><span class="p">);</span>
  <span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
  <span class="c1">// runAfter内部也调用了runInLoop，所以这里也是异步调用
</span><span class="c1"></span>  <span class="n">loop</span><span class="o">-&gt;</span><span class="n">runAfter</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">runInThread</span><span class="p">);</span>
  <span class="n">sleep</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span>
  <span class="n">loop</span><span class="o">-&gt;</span><span class="n">quit</span><span class="p">();</span>
 
  <span class="n">printf</span><span class="p">(</span><span class="s">&#34;exit main().</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
<span class="p">}</span>
 
<span class="cm">/*
</span><span class="cm">TimerId TimerQueue::addTimer(const TimerCallback&amp; cb,
</span><span class="cm">                             Timestamp when,
</span><span class="cm">                             double interval)
</span><span class="cm">{
</span><span class="cm">  Timer* timer = new Timer(cb, when, interval);
</span><span class="cm"> 
</span><span class="cm">  loop_-&gt;runInLoop(
</span><span class="cm">      boost::bind(&amp;TimerQueue::addTimerInLoop, this, timer));
</span><span class="cm"> 
</span><span class="cm">  //addTimerInLoop(timer); 不能用这个，如果直接调用，那么addTimerInLoop断言失败
</span><span class="cm">  return TimerId(timer, timer-&gt;sequence());
</span><span class="cm">}
</span><span class="cm"> 
</span><span class="cm">void TimerQueue::addTimerInLoop(Timer* timer)
</span><span class="cm">{
</span><span class="cm">  loop_-&gt;assertInLoopThread();
</span><span class="cm">  // 插入一个定时器，有可能会使得最早到期的定时器发生改变
</span><span class="cm">  bool earliestChanged = insert(timer);
</span><span class="cm"> 
</span><span class="cm">  if (earliestChanged)
</span><span class="cm">  {
</span><span class="cm">    // 重置定时器的超时时刻(timerfd_settime)
</span><span class="cm">    resetTimerfd(timerfd_, timer-&gt;expiration());
</span><span class="cm">  }
</span><span class="cm">}
</span><span class="cm"> 
</span><span class="cm">bool TimerQueue::insert(Timer* timer)
</span><span class="cm">{
</span><span class="cm">  loop_-&gt;assertInLoopThread();
</span><span class="cm">  assert(timers_.size() == activeTimers_.size());
</span><span class="cm">  // 最早到期时间是否改变
</span><span class="cm">  bool earliestChanged = false;
</span><span class="cm">  Timestamp when = timer-&gt;expiration();
</span><span class="cm">  TimerList::iterator it = timers_.begin();
</span><span class="cm">  // 如果timers_为空或者when小于timers_中的最早到期时间
</span><span class="cm">  if (it == timers_.end() || when &lt; it-&gt;first)
</span><span class="cm">  {
</span><span class="cm">    earliestChanged = true;
</span><span class="cm">  }
</span><span class="cm">  {
</span><span class="cm">    // 插入到timers_中
</span><span class="cm">    std::pair&lt;TimerList::iterator, bool&gt; result
</span><span class="cm">      = timers_.insert(Entry(when, timer));
</span><span class="cm">    assert(result.second); (void)result;
</span><span class="cm">  }
</span><span class="cm">  {
</span><span class="cm">    // 插入到activeTimers_中
</span><span class="cm">    std::pair&lt;ActiveTimerSet::iterator, bool&gt; result
</span><span class="cm">      = activeTimers_.insert(ActiveTimer(timer, timer-&gt;sequence()));
</span><span class="cm">    assert(result.second); (void)result;
</span><span class="cm">  }
</span><span class="cm"> 
</span><span class="cm">  assert(timers_.size() == activeTimers_.size());
</span><span class="cm">  return earliestChanged;
</span><span class="cm">}
</span><span class="cm"> 
</span><span class="cm"> 
</span><span class="cm">*/</span>
</code></pre></td></tr></table>
</div>
</div>
<h3 id="程序输出-1">程序输出</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-sh" data-lang="sh"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-sh" data-lang="sh">ubuntu@ubuntu-virtual-machine:~/pro/30$ ./build/debug/bin/reactor_test06
main<span class="o">()</span>: <span class="nv">pid</span> <span class="o">=</span> <span class="m">29731</span>, <span class="nv">tid</span> <span class="o">=</span> <span class="m">29731</span>
<span class="m">20131022</span> <span class="m">03</span>:03:50.315042Z <span class="m">29732</span> TRACE updateChannel <span class="nv">fd</span> <span class="o">=</span> <span class="m">4</span> <span class="nv">events</span> <span class="o">=</span> <span class="m">3</span> - EPollPoller.cc:104
<span class="m">20131022</span> <span class="m">03</span>:03:50.315588Z <span class="m">29732</span> TRACE EventLoop EventLoop created 0xB786BF94 in thread <span class="m">29732</span> - EventLoop.cc:62
<span class="m">20131022</span> <span class="m">03</span>:03:50.315643Z <span class="m">29732</span> TRACE updateChannel <span class="nv">fd</span> <span class="o">=</span> <span class="m">5</span> <span class="nv">events</span> <span class="o">=</span> <span class="m">3</span> - EPollPoller.cc:104
<span class="m">20131022</span> <span class="m">03</span>:03:50.315708Z <span class="m">29732</span> TRACE loop EventLoop 0xB786BF94 start looping - EventLoop.cc:94
<span class="m">20131022</span> <span class="m">03</span>:03:50.315976Z <span class="m">29732</span> TRACE poll <span class="m">1</span> events happended - EPollPoller.cc:65
<span class="m">20131022</span> <span class="m">03</span>:03:50.316472Z <span class="m">29732</span> TRACE printActiveChannels <span class="o">{</span><span class="m">5</span>: IN <span class="o">}</span>  - EventLoop.cc:257
runInThread<span class="o">()</span>: <span class="nv">pid</span> <span class="o">=</span> <span class="m">29731</span>, <span class="nv">tid</span> <span class="o">=</span> <span class="m">29732</span>
<span class="m">20131022</span> <span class="m">03</span>:03:51.316968Z <span class="m">29732</span> TRACE poll <span class="m">1</span> events happended - EPollPoller.cc:65
<span class="m">20131022</span> <span class="m">03</span>:03:51.317092Z <span class="m">29732</span> TRACE printActiveChannels <span class="o">{</span><span class="m">5</span>: IN <span class="o">}</span>  - EventLoop.cc:257
<span class="m">20131022</span> <span class="m">03</span>:03:53.317414Z <span class="m">29732</span> TRACE poll <span class="m">1</span> events happended - EPollPoller.cc:65
<span class="m">20131022</span> <span class="m">03</span>:03:53.317539Z <span class="m">29732</span> TRACE printActiveChannels <span class="o">{</span><span class="m">4</span>: IN <span class="o">}</span>  - EventLoop.cc:257
<span class="m">20131022</span> <span class="m">03</span>:03:53.317639Z <span class="m">29732</span> TRACE readTimerfd TimerQueue::handleRead<span class="o">()</span> <span class="m">1</span> at <span class="m">1382411033</span>.317576 - TimerQueue.cc:62
runInThread<span class="o">()</span>: <span class="nv">pid</span> <span class="o">=</span> <span class="m">29731</span>, <span class="nv">tid</span> <span class="o">=</span> <span class="m">29732</span>
<span class="nb">exit</span> main<span class="o">()</span>.
<span class="m">20131022</span> <span class="m">03</span>:03:54.317901Z <span class="m">29732</span> TRACE poll <span class="m">1</span> events happended - EPollPoller.cc:65
<span class="m">20131022</span> <span class="m">03</span>:03:54.317966Z <span class="m">29732</span> TRACE printActiveChannels <span class="o">{</span><span class="m">5</span>: IN <span class="o">}</span>  - EventLoop.cc:257
<span class="m">20131022</span> <span class="m">03</span>:03:54.317990Z <span class="m">29732</span> TRACE loop EventLoop 0xB786BF94 stop looping - EventLoop.cc:119
ubuntu@ubuntu-virtual-machine:~/pro/30$</code></pre></td></tr></table>
</div>
</div>
<h2 id="31-socket封装">[31] Socket封装</h2>

<ul>
<li>Endian.h
封装了字节序转换函数（全局函数，位于muduo::net::sockets名称空间中）。</li>
<li>SocketsOps.h/ SocketsOps.cc
封装了socket相关系统调用（全局函数，位于muduo::net::sockets名称空间中）。</li>
<li>Socket.h/Socket.cc（Socket类）
用RAII方法封装socket file descriptor</li>
<li>InetAddress.h/InetAddress.cc（InetAddress类）
网际地址sockaddr_in封装</li>
</ul>

<h3 id="endian头文件">Endian头文件</h3>

<p>endian.h</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-c++" data-lang="c++"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c++" data-lang="c++"><span class="c1">// Copyright 2010, Shuo Chen.  All rights reserved.
</span><span class="c1">// http://code.google.com/p/muduo/
</span><span class="c1">//
</span><span class="c1">// Use of this source code is governed by a BSD-style license
</span><span class="c1">// that can be found in the License file.
</span><span class="c1"></span> 
<span class="c1">// Author: Shuo Chen (chenshuo at chenshuo dot com)
</span><span class="c1">//
</span><span class="c1">// This is a public header file, it must only include public header files.
</span><span class="c1"></span> 
<span class="cp">#ifndef MUDUO_NET_ENDIAN_H
</span><span class="cp">#define MUDUO_NET_ENDIAN_H
</span><span class="cp"></span> 
<span class="cp">#include</span> <span class="cpf">&lt;stdint.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;endian.h&gt;</span><span class="cp">
</span><span class="cp"></span> 
<span class="k">namespace</span> <span class="n">muduo</span>
<span class="p">{</span>
<span class="k">namespace</span> <span class="n">net</span>
<span class="p">{</span>
<span class="k">namespace</span> <span class="n">sockets</span>
<span class="p">{</span>
 
<span class="c1">// the inline assembler code makes type blur,
</span><span class="c1">// so we disable warnings for a while.
</span><span class="c1"></span><span class="cp">#if __GNUC_MINOR__ &gt;= 6
</span><span class="cp">#pragma GCC diagnostic push
</span><span class="cp">#endif
</span><span class="cp">#pragma GCC diagnostic ignored &#34;-Wconversion&#34;
</span><span class="cp">#pragma GCC diagnostic ignored &#34;-Wold-style-cast&#34;
</span><span class="cp"></span><span class="kr">inline</span> <span class="n">uint64_t</span> <span class="n">hostToNetwork64</span><span class="p">(</span><span class="n">uint64_t</span> <span class="n">host64</span><span class="p">)</span>
<span class="p">{</span>
  <span class="k">return</span> <span class="n">htobe64</span><span class="p">(</span><span class="n">host64</span><span class="p">);</span>
<span class="p">}</span>
 
<span class="kr">inline</span> <span class="n">uint32_t</span> <span class="n">hostToNetwork32</span><span class="p">(</span><span class="n">uint32_t</span> <span class="n">host32</span><span class="p">)</span>
<span class="p">{</span>
  <span class="k">return</span> <span class="n">htobe32</span><span class="p">(</span><span class="n">host32</span><span class="p">);</span>
<span class="p">}</span>
 
<span class="kr">inline</span> <span class="n">uint16_t</span> <span class="n">hostToNetwork16</span><span class="p">(</span><span class="n">uint16_t</span> <span class="n">host16</span><span class="p">)</span>
<span class="p">{</span>
  <span class="k">return</span> <span class="n">htobe16</span><span class="p">(</span><span class="n">host16</span><span class="p">);</span>
<span class="p">}</span>
 
<span class="kr">inline</span> <span class="n">uint64_t</span> <span class="n">networkToHost64</span><span class="p">(</span><span class="n">uint64_t</span> <span class="n">net64</span><span class="p">)</span>
<span class="p">{</span>
  <span class="k">return</span> <span class="n">be64toh</span><span class="p">(</span><span class="n">net64</span><span class="p">);</span>
<span class="p">}</span>
 
<span class="kr">inline</span> <span class="n">uint32_t</span> <span class="n">networkToHost32</span><span class="p">(</span><span class="n">uint32_t</span> <span class="n">net32</span><span class="p">)</span>
<span class="p">{</span>
  <span class="k">return</span> <span class="n">be32toh</span><span class="p">(</span><span class="n">net32</span><span class="p">);</span>
<span class="p">}</span>
 
<span class="kr">inline</span> <span class="n">uint16_t</span> <span class="n">networkToHost16</span><span class="p">(</span><span class="n">uint16_t</span> <span class="n">net16</span><span class="p">)</span>
<span class="p">{</span>
  <span class="k">return</span> <span class="n">be16toh</span><span class="p">(</span><span class="n">net16</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#if __GNUC_MINOR__ &gt;= 6
</span><span class="cp">#pragma GCC diagnostic pop
</span><span class="cp">#else
</span><span class="cp">#pragma GCC diagnostic error &#34;-Wconversion&#34;
</span><span class="cp">#pragma GCC diagnostic error &#34;-Wold-style-cast&#34;
</span><span class="cp">#endif
</span><span class="cp"></span> 
 
<span class="p">}</span>
<span class="p">}</span>
<span class="p">}</span>
 
<span class="cp">#endif  </span><span class="c1">// MUDUO_NET_ENDIAN_H
</span></code></pre></td></tr></table>
</div>
</div>
<h3 id="inetaddress头文件">InetAddress头文件</h3>

<p>inetaddress.h</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-c++" data-lang="c++"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c++" data-lang="c++"><span class="c1">// Copyright 2010, Shuo Chen.  All rights reserved.
</span><span class="c1">// http://code.google.com/p/muduo/
</span><span class="c1">//
</span><span class="c1">// Use of this source code is governed by a BSD-style license
</span><span class="c1">// that can be found in the License file.
</span><span class="c1"></span> 
<span class="c1">// Author: Shuo Chen (chenshuo at chenshuo dot com)
</span><span class="c1">//
</span><span class="c1">// This is a public header file, it must only include public header files.
</span><span class="c1"></span> 
<span class="cp">#ifndef MUDUO_NET_INETADDRESS_H
</span><span class="cp">#define MUDUO_NET_INETADDRESS_H
</span><span class="cp"></span> 
<span class="cp">#include</span> <span class="cpf">&lt;muduo/base/copyable.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;muduo/base/StringPiece.h&gt;</span><span class="cp">
</span><span class="cp"></span> 
<span class="cp">#include</span> <span class="cpf">&lt;netinet/in.h&gt;</span><span class="cp">
</span><span class="cp"></span> 
<span class="k">namespace</span> <span class="n">muduo</span>
<span class="p">{</span>
<span class="k">namespace</span> <span class="n">net</span>
<span class="p">{</span>
 
<span class="c1">///
</span><span class="c1">/// Wrapper of sockaddr_in.
</span><span class="c1">///
</span><span class="c1">/// This is an POD interface class.
</span><span class="c1"></span><span class="k">class</span><span class="err"> </span><span class="nc">InetAddress</span> <span class="o">:</span> <span class="k">public</span> <span class="n">muduo</span><span class="o">::</span><span class="n">copyable</span>
<span class="p">{</span>
 <span class="k">public</span><span class="o">:</span>
  <span class="c1">/// Constructs an endpoint with given port number.
</span><span class="c1"></span>  <span class="c1">/// Mostly used in TcpServer listening.
</span><span class="c1"></span>  <span class="c1">// 仅仅指定port，不指定ip，则ip为INADDR_ANY（即0.0.0.0）
</span><span class="c1"></span>  <span class="k">explicit</span> <span class="n">InetAddress</span><span class="p">(</span><span class="n">uint16_t</span> <span class="n">port</span><span class="p">);</span>
 
  <span class="c1">/// Constructs an endpoint with given ip and port.
</span><span class="c1"></span>  <span class="c1">/// @c ip should be &#34;1.2.3.4&#34;
</span><span class="c1"></span>  <span class="n">InetAddress</span><span class="p">(</span><span class="k">const</span> <span class="n">StringPiece</span><span class="o">&amp;</span> <span class="n">ip</span><span class="p">,</span> <span class="n">uint16_t</span> <span class="n">port</span><span class="p">);</span>
 
  <span class="c1">/// Constructs an endpoint with given struct @c sockaddr_in
</span><span class="c1"></span>  <span class="c1">/// Mostly used when accepting new connections
</span><span class="c1"></span>  <span class="n">InetAddress</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">sockaddr_in</span><span class="o">&amp;</span> <span class="n">addr</span><span class="p">)</span>
    <span class="o">:</span> <span class="n">addr_</span><span class="p">(</span><span class="n">addr</span><span class="p">)</span>
  <span class="p">{</span> <span class="p">}</span>
 
  <span class="n">string</span> <span class="n">toIp</span><span class="p">()</span> <span class="k">const</span><span class="p">;</span>
  <span class="n">string</span> <span class="nf">toIpPort</span><span class="p">()</span> <span class="k">const</span><span class="p">;</span>
 
  <span class="c1">// __attribute__ ((deprecated)) 表示该函数是过时的，被淘汰的
</span><span class="c1"></span>  <span class="c1">// 这样使用该函数，在编译的时候，会发出警告
</span><span class="c1"></span>  <span class="cm">/* 保留这个函数的原因是 为了 软件升级使用，最后不要调用这个函数，直接调用toIpPort就行了*/</span>
  <span class="n">string</span> <span class="nf">toHostPort</span><span class="p">()</span> <span class="k">const</span> <span class="n">__attribute__</span> <span class="p">((</span><span class="n">deprecated</span><span class="p">))</span>
  <span class="p">{</span> <span class="k">return</span> <span class="n">toIpPort</span><span class="p">();</span> <span class="p">}</span>
 
  <span class="c1">// default copy/assignment are Okay
</span><span class="c1"></span> 
  <span class="k">const</span> <span class="k">struct</span> <span class="n">sockaddr_in</span><span class="o">&amp;</span> <span class="n">getSockAddrInet</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span> <span class="k">return</span> <span class="n">addr_</span><span class="p">;</span> <span class="p">}</span>
  <span class="kt">void</span> <span class="n">setSockAddrInet</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">sockaddr_in</span><span class="o">&amp;</span> <span class="n">addr</span><span class="p">)</span> <span class="p">{</span> <span class="n">addr_</span> <span class="o">=</span> <span class="n">addr</span><span class="p">;</span> <span class="p">}</span>
 
  <span class="n">uint32_t</span> <span class="n">ipNetEndian</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span> <span class="k">return</span> <span class="n">addr_</span><span class="p">.</span><span class="n">sin_addr</span><span class="p">.</span><span class="n">s_addr</span><span class="p">;</span> <span class="p">}</span>
  <span class="n">uint16_t</span> <span class="n">portNetEndian</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span> <span class="k">return</span> <span class="n">addr_</span><span class="p">.</span><span class="n">sin_port</span><span class="p">;</span> <span class="p">}</span>
 
 <span class="k">private</span><span class="o">:</span>
  <span class="k">struct</span> <span class="n">sockaddr_in</span> <span class="n">addr_</span><span class="p">;</span>
<span class="p">};</span>
 
<span class="p">}</span>
<span class="p">}</span>
 
<span class="cp">#endif  </span><span class="c1">// MUDUO_NET_INETADDRESS_H
</span></code></pre></td></tr></table>
</div>
</div>
<h3 id="inetaddress源文件">InetAddress源文件</h3>

<p>inetaddress.cc</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-c" data-lang="c"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c" data-lang="c"><span class="c1">// Copyright 2010, Shuo Chen.  All rights reserved.
</span><span class="c1">// http://code.google.com/p/muduo/
</span><span class="c1">//
</span><span class="c1">// Use of this source code is governed by a BSD-style license
</span><span class="c1">// that can be found in the License file.
</span><span class="c1"></span> 
<span class="c1">// Author: Shuo Chen (chenshuo at chenshuo dot com)
</span><span class="c1"></span> 
<span class="cp">#include</span> <span class="cpf">&lt;muduo/net/InetAddress.h&gt;</span><span class="cp">
</span><span class="cp"></span> 
<span class="cp">#include</span> <span class="cpf">&lt;muduo/net/Endian.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;muduo/net/SocketsOps.h&gt;</span><span class="cp">
</span><span class="cp"></span> 
<span class="cp">#include</span> <span class="cpf">&lt;strings.h&gt;  // bzero</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;netinet/in.h&gt;</span><span class="cp">
</span><span class="cp"></span> 
<span class="cp">#include</span> <span class="cpf">&lt;boost/static_assert.hpp&gt;</span><span class="cp">
</span><span class="cp"></span> 
<span class="c1">// INADDR_ANY use (type)value casting.
</span><span class="c1"></span><span class="cp">#pragma GCC diagnostic ignored &#34;-Wold-style-cast&#34;
</span><span class="cp"></span><span class="k">static</span> <span class="k">const</span> <span class="n">in_addr_t</span> <span class="n">kInaddrAny</span> <span class="o">=</span> <span class="n">INADDR_ANY</span><span class="p">;</span>
<span class="cp">#pragma GCC diagnostic error &#34;-Wold-style-cast&#34;
</span><span class="cp"></span> 
<span class="c1">//     /* Structure describing an Internet socket address.  */
</span><span class="c1">//     struct sockaddr_in {
</span><span class="c1">//         sa_family_t    sin_family; /* address family: AF_INET */
</span><span class="c1">//         uint16_t       sin_port;   /* port in network byte order */
</span><span class="c1">//         struct in_addr sin_addr;   /* internet address */
</span><span class="c1">//     };
</span><span class="c1"></span> 
<span class="c1">//     /* Internet address. */
</span><span class="c1">//     typedef uint32_t in_addr_t;
</span><span class="c1">//     struct in_addr {
</span><span class="c1">//         in_addr_t       s_addr;     /* address in network byte order */
</span><span class="c1">//     };
</span><span class="c1"></span> 
<span class="n">using</span> <span class="n">namespace</span> <span class="n">muduo</span><span class="p">;</span>
<span class="n">using</span> <span class="n">namespace</span> <span class="n">muduo</span><span class="o">::</span><span class="n">net</span><span class="p">;</span>
 
<span class="n">BOOST_STATIC_ASSERT</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">InetAddress</span><span class="p">)</span> <span class="o">==</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr_in</span><span class="p">));</span>
 
<span class="n">InetAddress</span><span class="o">::</span><span class="n">InetAddress</span><span class="p">(</span><span class="n">uint16_t</span> <span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">bzero</span><span class="p">(</span><span class="o">&amp;</span><span class="n">addr_</span><span class="p">,</span> <span class="k">sizeof</span> <span class="n">addr_</span><span class="p">);</span>
  <span class="n">addr_</span><span class="p">.</span><span class="n">sin_family</span> <span class="o">=</span> <span class="n">AF_INET</span><span class="p">;</span>
  <span class="n">addr_</span><span class="p">.</span><span class="n">sin_addr</span><span class="p">.</span><span class="n">s_addr</span> <span class="o">=</span> <span class="n">sockets</span><span class="o">::</span><span class="n">hostToNetwork32</span><span class="p">(</span><span class="n">kInaddrAny</span><span class="p">);</span>
  <span class="n">addr_</span><span class="p">.</span><span class="n">sin_port</span> <span class="o">=</span> <span class="n">sockets</span><span class="o">::</span><span class="n">hostToNetwork16</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
<span class="p">}</span>
 
<span class="n">InetAddress</span><span class="o">::</span><span class="n">InetAddress</span><span class="p">(</span><span class="k">const</span> <span class="n">StringPiece</span><span class="o">&amp;</span> <span class="n">ip</span><span class="p">,</span> <span class="n">uint16_t</span> <span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">bzero</span><span class="p">(</span><span class="o">&amp;</span><span class="n">addr_</span><span class="p">,</span> <span class="k">sizeof</span> <span class="n">addr_</span><span class="p">);</span>
  <span class="n">sockets</span><span class="o">::</span><span class="n">fromIpPort</span><span class="p">(</span><span class="n">ip</span><span class="p">.</span><span class="n">data</span><span class="p">(),</span> <span class="n">port</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">addr_</span><span class="p">);</span>
<span class="p">}</span>
 
<span class="n">string</span> <span class="n">InetAddress</span><span class="o">::</span><span class="n">toIpPort</span><span class="p">()</span> <span class="k">const</span>
<span class="p">{</span>
  <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>
  <span class="n">sockets</span><span class="o">::</span><span class="n">toIpPort</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span> <span class="n">buf</span><span class="p">,</span> <span class="n">addr_</span><span class="p">);</span>
  <span class="k">return</span> <span class="n">buf</span><span class="p">;</span>
<span class="p">}</span>
 
<span class="n">string</span> <span class="n">InetAddress</span><span class="o">::</span><span class="n">toIp</span><span class="p">()</span> <span class="k">const</span>
<span class="p">{</span>
  <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>
  <span class="n">sockets</span><span class="o">::</span><span class="n">toIp</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span> <span class="n">buf</span><span class="p">,</span> <span class="n">addr_</span><span class="p">);</span>
  <span class="k">return</span> <span class="n">buf</span><span class="p">;</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<h3 id="sokcet头文件">Sokcet头文件</h3>

<p>Socket.h</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-c++" data-lang="c++"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c++" data-lang="c++"><span class="c1">// Copyright 2010, Shuo Chen.  All rights reserved.
</span><span class="c1">// http://code.google.com/p/muduo/
</span><span class="c1">//
</span><span class="c1">// Use of this source code is governed by a BSD-style license
</span><span class="c1">// that can be found in the License file.
</span><span class="c1"></span> 
<span class="c1">// Author: Shuo Chen (chenshuo at chenshuo dot com)
</span><span class="c1">//
</span><span class="c1">// This is an internal header file, you should not include this.
</span><span class="c1"></span> 
<span class="cp">#ifndef MUDUO_NET_SOCKET_H
</span><span class="cp">#define MUDUO_NET_SOCKET_H
</span><span class="cp"></span> 
<span class="cp">#include</span> <span class="cpf">&lt;boost/noncopyable.hpp&gt;</span><span class="cp">
</span><span class="cp"></span> 
<span class="k">namespace</span> <span class="n">muduo</span>
<span class="p">{</span>
<span class="c1">///
</span><span class="c1">/// TCP networking.
</span><span class="c1">///
</span><span class="c1"></span><span class="k">namespace</span> <span class="n">net</span>
<span class="p">{</span>
 
<span class="k">class</span><span class="err"> </span><span class="nc">InetAddress</span><span class="p">;</span>
 
<span class="c1">///
</span><span class="c1">/// Wrapper of socket file descriptor.
</span><span class="c1">///
</span><span class="c1">/// It closes the sockfd when desctructs.
</span><span class="c1">/// It&#39;s thread safe, all operations are delagated to OS.
</span><span class="c1"></span><span class="k">class</span><span class="err"> </span><span class="nc">Socket</span> <span class="o">:</span> <span class="n">boost</span><span class="o">::</span><span class="n">noncopyable</span>
<span class="p">{</span>
 <span class="k">public</span><span class="o">:</span>
  <span class="k">explicit</span> <span class="n">Socket</span><span class="p">(</span><span class="kt">int</span> <span class="n">sockfd</span><span class="p">)</span>
    <span class="o">:</span> <span class="n">sockfd_</span><span class="p">(</span><span class="n">sockfd</span><span class="p">)</span> <span class="c1">//已已经初始化的sockfd
</span><span class="c1"></span>  <span class="p">{</span> <span class="p">}</span>
 
  <span class="c1">// Socket(Socket&amp;&amp;) // move constructor in C++11
</span><span class="c1"></span>  <span class="o">~</span><span class="n">Socket</span><span class="p">();</span>
 
  <span class="kt">int</span> <span class="nf">fd</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span> <span class="k">return</span> <span class="n">sockfd_</span><span class="p">;</span> <span class="p">}</span>
 
  <span class="c1">/// abort if address in use
</span><span class="c1"></span>  <span class="kt">void</span> <span class="nf">bindAddress</span><span class="p">(</span><span class="k">const</span> <span class="n">InetAddress</span><span class="o">&amp;</span> <span class="n">localaddr</span><span class="p">);</span>
  <span class="c1">/// abort if address in use
</span><span class="c1"></span>  <span class="kt">void</span> <span class="nf">listen</span><span class="p">();</span>
 
  <span class="c1">/// On success, returns a non-negative integer that is
</span><span class="c1"></span>  <span class="c1">/// a descriptor for the accepted socket, which has been
</span><span class="c1"></span>  <span class="c1">/// set to non-blocking and close-on-exec. *peeraddr is assigned.
</span><span class="c1"></span>  <span class="c1">/// On error, -1 is returned, and *peeraddr is untouched.
</span><span class="c1"></span>  <span class="kt">int</span> <span class="nf">accept</span><span class="p">(</span><span class="n">InetAddress</span><span class="o">*</span> <span class="n">peeraddr</span><span class="p">);</span>
 
  <span class="kt">void</span> <span class="nf">shutdownWrite</span><span class="p">();</span>
 
  <span class="c1">///
</span><span class="c1"></span>  <span class="c1">/// Enable/disable TCP_NODELAY (disable/enable Nagle&#39;s algorithm).
</span><span class="c1"></span>  <span class="c1">///
</span><span class="c1"></span>  <span class="c1">// Nagle算法可以一定程度上避免网络拥塞
</span><span class="c1"></span>  <span class="c1">// TCP_NODELAY选项可以禁用Nagle算法
</span><span class="c1"></span>  <span class="c1">// 禁用Nagle算法，可以避免连续发包出现延迟，这对于编写低延迟的网络服务很重要
</span><span class="c1"></span>  <span class="kt">void</span> <span class="nf">setTcpNoDelay</span><span class="p">(</span><span class="kt">bool</span> <span class="n">on</span><span class="p">);</span>
 
  <span class="c1">///
</span><span class="c1"></span>  <span class="c1">/// Enable/disable SO_REUSEADDR
</span><span class="c1"></span>  <span class="c1">///
</span><span class="c1"></span>  <span class="kt">void</span> <span class="nf">setReuseAddr</span><span class="p">(</span><span class="kt">bool</span> <span class="n">on</span><span class="p">);</span>
 
  <span class="c1">///
</span><span class="c1"></span>  <span class="c1">/// Enable/disable SO_KEEPALIVE
</span><span class="c1"></span>  <span class="c1">///
</span><span class="c1"></span>  <span class="c1">// TCP keepalive是指定期探测连接是否存在，如果应用层有心跳的话，这个选项不是必需要设置的
</span><span class="c1"></span>  <span class="kt">void</span> <span class="nf">setKeepAlive</span><span class="p">(</span><span class="kt">bool</span> <span class="n">on</span><span class="p">);</span>
 
 <span class="k">private</span><span class="o">:</span>
  <span class="k">const</span> <span class="kt">int</span> <span class="n">sockfd_</span><span class="p">;</span>
<span class="p">};</span>
 
<span class="p">}</span>
<span class="p">}</span>
<span class="cp">#endif  </span><span class="c1">// MUDUO_NET_SOCKET_H
</span></code></pre></td></tr></table>
</div>
</div>
<h3 id="socket源文件">Socket源文件</h3>

<p>Socket.cc</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-c++" data-lang="c++"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c++" data-lang="c++"><span class="c1">// Copyright 2010, Shuo Chen.  All rights reserved.
</span><span class="c1">// http://code.google.com/p/muduo/
</span><span class="c1">//
</span><span class="c1">// Use of this source code is governed by a BSD-style license
</span><span class="c1">// that can be found in the License file.
</span><span class="c1"></span> 
<span class="c1">// Author: Shuo Chen (chenshuo at chenshuo dot com)
</span><span class="c1"></span> 
<span class="cp">#include</span> <span class="cpf">&lt;muduo/net/Socket.h&gt;</span><span class="cp">
</span><span class="cp"></span> 
<span class="cp">#include</span> <span class="cpf">&lt;muduo/net/InetAddress.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;muduo/net/SocketsOps.h&gt;</span><span class="cp">
</span><span class="cp"></span> 
<span class="cp">#include</span> <span class="cpf">&lt;netinet/in.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;netinet/tcp.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;strings.h&gt;  // bzero</span><span class="cp">
</span><span class="cp"></span> 
<span class="k">using</span> <span class="k">namespace</span> <span class="n">muduo</span><span class="p">;</span>
<span class="k">using</span> <span class="k">namespace</span> <span class="n">muduo</span><span class="o">::</span><span class="n">net</span><span class="p">;</span>
 
<span class="n">Socket</span><span class="o">::~</span><span class="n">Socket</span><span class="p">()</span>
<span class="p">{</span>
  <span class="n">sockets</span><span class="o">::</span><span class="n">close</span><span class="p">(</span><span class="n">sockfd_</span><span class="p">);</span>
<span class="p">}</span>
 
<span class="kt">void</span> <span class="n">Socket</span><span class="o">::</span><span class="n">bindAddress</span><span class="p">(</span><span class="k">const</span> <span class="n">InetAddress</span><span class="o">&amp;</span> <span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">sockets</span><span class="o">::</span><span class="n">bindOrDie</span><span class="p">(</span><span class="n">sockfd_</span><span class="p">,</span> <span class="n">addr</span><span class="p">.</span><span class="n">getSockAddrInet</span><span class="p">());</span>
<span class="p">}</span>
 
<span class="kt">void</span> <span class="n">Socket</span><span class="o">::</span><span class="n">listen</span><span class="p">()</span>
<span class="p">{</span>
  <span class="n">sockets</span><span class="o">::</span><span class="n">listenOrDie</span><span class="p">(</span><span class="n">sockfd_</span><span class="p">);</span>
<span class="p">}</span>
 
<span class="kt">int</span> <span class="n">Socket</span><span class="o">::</span><span class="n">accept</span><span class="p">(</span><span class="n">InetAddress</span><span class="o">*</span> <span class="n">peeraddr</span><span class="p">)</span>
<span class="p">{</span>
  <span class="k">struct</span> <span class="n">sockaddr_in</span> <span class="n">addr</span><span class="p">;</span>
  <span class="n">bzero</span><span class="p">(</span><span class="o">&amp;</span><span class="n">addr</span><span class="p">,</span> <span class="k">sizeof</span> <span class="n">addr</span><span class="p">);</span>
  <span class="kt">int</span> <span class="n">connfd</span> <span class="o">=</span> <span class="n">sockets</span><span class="o">::</span><span class="n">accept</span><span class="p">(</span><span class="n">sockfd_</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">addr</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">connfd</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">peeraddr</span><span class="o">-&gt;</span><span class="n">setSockAddrInet</span><span class="p">(</span><span class="n">addr</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="n">connfd</span><span class="p">;</span>
<span class="p">}</span>
 
<span class="kt">void</span> <span class="n">Socket</span><span class="o">::</span><span class="n">shutdownWrite</span><span class="p">()</span>
<span class="p">{</span>
  <span class="n">sockets</span><span class="o">::</span><span class="n">shutdownWrite</span><span class="p">(</span><span class="n">sockfd_</span><span class="p">);</span>
<span class="p">}</span>
 
<span class="kt">void</span> <span class="n">Socket</span><span class="o">::</span><span class="n">setTcpNoDelay</span><span class="p">(</span><span class="kt">bool</span> <span class="n">on</span><span class="p">)</span>
<span class="p">{</span>
  <span class="kt">int</span> <span class="n">optval</span> <span class="o">=</span> <span class="n">on</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
  <span class="o">::</span><span class="n">setsockopt</span><span class="p">(</span><span class="n">sockfd_</span><span class="p">,</span> <span class="n">IPPROTO_TCP</span><span class="p">,</span> <span class="n">TCP_NODELAY</span><span class="p">,</span>
               <span class="o">&amp;</span><span class="n">optval</span><span class="p">,</span> <span class="k">sizeof</span> <span class="n">optval</span><span class="p">);</span>
  <span class="c1">// FIXME CHECK
</span><span class="c1"></span><span class="p">}</span>
 
<span class="kt">void</span> <span class="n">Socket</span><span class="o">::</span><span class="n">setReuseAddr</span><span class="p">(</span><span class="kt">bool</span> <span class="n">on</span><span class="p">)</span>
<span class="p">{</span>
  <span class="kt">int</span> <span class="n">optval</span> <span class="o">=</span> <span class="n">on</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
  <span class="o">::</span><span class="n">setsockopt</span><span class="p">(</span><span class="n">sockfd_</span><span class="p">,</span> <span class="n">SOL_SOCKET</span><span class="p">,</span> <span class="n">SO_REUSEADDR</span><span class="p">,</span>
               <span class="o">&amp;</span><span class="n">optval</span><span class="p">,</span> <span class="k">sizeof</span> <span class="n">optval</span><span class="p">);</span>
  <span class="c1">// FIXME CHECK
</span><span class="c1"></span><span class="p">}</span>
 
<span class="kt">void</span> <span class="n">Socket</span><span class="o">::</span><span class="n">setKeepAlive</span><span class="p">(</span><span class="kt">bool</span> <span class="n">on</span><span class="p">)</span>
<span class="p">{</span>
  <span class="kt">int</span> <span class="n">optval</span> <span class="o">=</span> <span class="n">on</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
  <span class="o">::</span><span class="n">setsockopt</span><span class="p">(</span><span class="n">sockfd_</span><span class="p">,</span> <span class="n">SOL_SOCKET</span><span class="p">,</span> <span class="n">SO_KEEPALIVE</span><span class="p">,</span>
               <span class="o">&amp;</span><span class="n">optval</span><span class="p">,</span> <span class="k">sizeof</span> <span class="n">optval</span><span class="p">);</span>
  <span class="c1">// FIXME CHECK
</span><span class="c1"></span><span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div>
<h3 id="程序程序">程序程序</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-c++" data-lang="c++"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c++" data-lang="c++"><span class="cp">#include</span> <span class="cpf">&lt;muduo/net/InetAddress.h&gt;</span><span class="cp">
</span><span class="cp"></span> 
<span class="c1">//#define BOOST_TEST_MODULE InetAddressTest
</span><span class="c1"></span><span class="cp">#define BOOST_TEST_MAIN
</span><span class="cp">#define BOOST_TEST_DYN_LINK
</span><span class="cp">#include</span> <span class="cpf">&lt;boost/test/unit_test.hpp&gt;</span><span class="cp">
</span><span class="cp"></span> 
<span class="k">using</span> <span class="n">muduo</span><span class="o">::</span><span class="n">string</span><span class="p">;</span>
<span class="k">using</span> <span class="n">muduo</span><span class="o">::</span><span class="n">net</span><span class="o">::</span><span class="n">InetAddress</span><span class="p">;</span>
 
<span class="n">BOOST_AUTO_TEST_CASE</span><span class="p">(</span><span class="n">testInetAddress</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">InetAddress</span> <span class="n">addr1</span><span class="p">(</span><span class="mi">1234</span><span class="p">);</span>
  <span class="n">BOOST_CHECK_EQUAL</span><span class="p">(</span><span class="n">addr1</span><span class="p">.</span><span class="n">toIp</span><span class="p">(),</span> <span class="n">string</span><span class="p">(</span><span class="s">&#34;0.0.0.0&#34;</span><span class="p">));</span>
  <span class="n">BOOST_CHECK_EQUAL</span><span class="p">(</span><span class="n">addr1</span><span class="p">.</span><span class="n">toIpPort</span><span class="p">(),</span> <span class="n">string</span><span class="p">(</span><span class="s">&#34;0.0.0.0:1234&#34;</span><span class="p">));</span>
 
  <span class="n">InetAddress</span> <span class="nf">addr2</span><span class="p">(</span><span class="s">&#34;1.2.3.4&#34;</span><span class="p">,</span> <span class="mi">8888</span><span class="p">);</span>
  <span class="n">BOOST_CHECK_EQUAL</span><span class="p">(</span><span class="n">addr2</span><span class="p">.</span><span class="n">toIp</span><span class="p">(),</span> <span class="n">string</span><span class="p">(</span><span class="s">&#34;1.2.3.4&#34;</span><span class="p">));</span>
  <span class="n">BOOST_CHECK_EQUAL</span><span class="p">(</span><span class="n">addr2</span><span class="p">.</span><span class="n">toIpPort</span><span class="p">(),</span> <span class="n">string</span><span class="p">(</span><span class="s">&#34;1.2.3.4:8888&#34;</span><span class="p">));</span>
 
  <span class="n">InetAddress</span> <span class="nf">addr3</span><span class="p">(</span><span class="s">&#34;255.255.255.255&#34;</span><span class="p">,</span> <span class="mi">65535</span><span class="p">);</span>
  <span class="n">BOOST_CHECK_EQUAL</span><span class="p">(</span><span class="n">addr3</span><span class="p">.</span><span class="n">toIp</span><span class="p">(),</span> <span class="n">string</span><span class="p">(</span><span class="s">&#34;255.255.255.255&#34;</span><span class="p">));</span>
  <span class="n">BOOST_CHECK_EQUAL</span><span class="p">(</span><span class="n">addr3</span><span class="p">.</span><span class="n">toIpPort</span><span class="p">(),</span> <span class="n">string</span><span class="p">(</span><span class="s">&#34;255.255.255.255:65535&#34;</span><span class="p">));</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div>
<h2 id="32-acceptor">[32] Acceptor</h2>

<ul>
<li>Acceptor用于accept(2)接受TCP连接</li>
<li>Acceptor的数据成员包括<code>Socket</code>、<code>Channel</code>，<code>Acceptor</code>的<code>socket</code>是<code>listening socket</code>（即<code>server socket</code>）。<code>Channel</code>用于观察此<code>socket</code>的<code>readable</code>事件，并回调<code>Accptor::handleRead()</code>，后者调用<code>accept(2)</code>来接受新连接，并回调用户<code>callback</code>。</li>
</ul>

<h3 id="acceptor的头文件">Acceptor的头文件</h3>

<p>Acceptor.h</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-c++" data-lang="c++"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c++" data-lang="c++"><span class="c1">// Copyright 2010, Shuo Chen.  All rights reserved.
</span><span class="c1">// http://code.google.com/p/muduo/
</span><span class="c1">//
</span><span class="c1">// Use of this source code is governed by a BSD-style license
</span><span class="c1">// that can be found in the License file.
</span><span class="c1"></span> 
<span class="c1">// Author: Shuo Chen (chenshuo at chenshuo dot com)
</span><span class="c1">//
</span><span class="c1">// This is an internal header file, you should not include this.
</span><span class="c1"></span> 
<span class="cp">#ifndef MUDUO_NET_ACCEPTOR_H
</span><span class="cp">#define MUDUO_NET_ACCEPTOR_H
</span><span class="cp"></span> 
<span class="cp">#include</span> <span class="cpf">&lt;boost/function.hpp&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;boost/noncopyable.hpp&gt;</span><span class="cp">
</span><span class="cp"></span> 
<span class="cp">#include</span> <span class="cpf">&lt;muduo/net/Channel.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;muduo/net/Socket.h&gt;</span><span class="cp">
</span><span class="cp"></span> 
<span class="k">namespace</span> <span class="n">muduo</span>
<span class="p">{</span>
<span class="k">namespace</span> <span class="n">net</span>
<span class="p">{</span>
 
<span class="k">class</span><span class="err"> </span><span class="nc">EventLoop</span><span class="p">;</span>
<span class="k">class</span><span class="err"> </span><span class="nc">InetAddress</span><span class="p">;</span>
 
<span class="c1">///
</span><span class="c1">/// Acceptor of incoming TCP connections.
</span><span class="c1">///
</span><span class="c1"></span><span class="k">class</span><span class="err"> </span><span class="nc">Acceptor</span> <span class="o">:</span> <span class="n">boost</span><span class="o">::</span><span class="n">noncopyable</span>
<span class="p">{</span>
 <span class="k">public</span><span class="o">:</span>
  <span class="k">typedef</span> <span class="n">boost</span><span class="o">::</span><span class="n">function</span><span class="o">&lt;</span><span class="kt">void</span> <span class="p">(</span><span class="kt">int</span> <span class="n">sockfd</span><span class="p">,</span>
                                <span class="k">const</span> <span class="n">InetAddress</span><span class="o">&amp;</span><span class="p">)</span><span class="o">&gt;</span> <span class="n">NewConnectionCallback</span><span class="p">;</span>
 
  <span class="n">Acceptor</span><span class="p">(</span><span class="n">EventLoop</span><span class="o">*</span> <span class="n">loop</span><span class="p">,</span> <span class="k">const</span> <span class="n">InetAddress</span><span class="o">&amp;</span> <span class="n">listenAddr</span><span class="p">);</span>
  <span class="o">~</span><span class="n">Acceptor</span><span class="p">();</span>
 
  <span class="kt">void</span> <span class="nf">setNewConnectionCallback</span><span class="p">(</span><span class="k">const</span> <span class="n">NewConnectionCallback</span><span class="o">&amp;</span> <span class="n">cb</span><span class="p">)</span>
  <span class="p">{</span> <span class="n">newConnectionCallback_</span> <span class="o">=</span> <span class="n">cb</span><span class="p">;</span> <span class="p">}</span>
 
  <span class="kt">bool</span> <span class="nf">listenning</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span> <span class="k">return</span> <span class="n">listenning_</span><span class="p">;</span> <span class="p">}</span>
  <span class="kt">void</span> <span class="nf">listen</span><span class="p">();</span>
 
 <span class="k">private</span><span class="o">:</span>
  <span class="cm">/*这是监听套接字的可读事件的套接字*/</span>
  <span class="kt">void</span> <span class="n">handleRead</span><span class="p">();</span>
 
  <span class="n">EventLoop</span><span class="o">*</span> <span class="n">loop_</span><span class="p">;</span>
  <span class="n">Socket</span> <span class="n">acceptSocket_</span><span class="p">;</span> <span class="cm">/*监听套接字*/</span>
  <span class="p">;</span><span class="cm">/*通道 会观察acceptSocket_监听套接字的可读事件，这个channel所属的eventloop是loop_*/</span>
  <span class="n">Channel</span> <span class="n">acceptChannel_</span><span class="p">;</span>
  <span class="n">NewConnectionCallback</span> <span class="n">newConnectionCallback_</span><span class="p">;</span>
  <span class="cm">/*是否处于监听的状态*/</span>
  <span class="kt">bool</span> <span class="n">listenning_</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">idleFd_</span><span class="p">;</span>
<span class="p">};</span>
 
<span class="p">}</span>
<span class="p">}</span>
 
<span class="cp">#endif  </span><span class="c1">// MUDUO_NET_ACCEPTOR_H
</span></code></pre></td></tr></table>
</div>
</div>
<h3 id="acceptor源文件">Acceptor源文件</h3>

<p>Acceptor.cc</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-c++" data-lang="c++"><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c++" data-lang="c++"><span class="c1">// Copyright 2010, Shuo Chen.  All rights reserved.
</span><span class="c1">// http://code.google.com/p/muduo/
</span><span class="c1">//
</span><span class="c1">// Use of this source code is governed by a BSD-style license
</span><span class="c1">// that can be found in the License file.
</span><span class="c1">// Author: Shuo Chen (chenshuo at chenshuo dot com)
</span><span class="c1"></span><span class="cp">#include</span> <span class="cpf">&lt;muduo/net/Acceptor.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;muduo/net/EventLoop.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;muduo/net/InetAddress.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;muduo/net/SocketsOps.h&gt;</span><span class="cp">
</span><span class="cp"></span> 
<span class="cp">#include</span> <span class="cpf">&lt;boost/bind.hpp&gt;</span><span class="cp">
</span><span class="cp"></span> 
<span class="cp">#include</span> <span class="cpf">&lt;errno.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;fcntl.h&gt;</span><span class="cp">
</span><span class="cp"></span><span class="c1">//#include &lt;sys/types.h&gt;
</span><span class="c1">//#include &lt;sys/stat.h&gt;
</span><span class="c1"></span> 
<span class="k">using</span> <span class="k">namespace</span> <span class="n">muduo</span><span class="p">;</span>
<span class="k">using</span> <span class="k">namespace</span> <span class="n">muduo</span><span class="o">::</span><span class="n">net</span><span class="p">;</span>
 
<span class="n">Acceptor</span><span class="o">::</span><span class="n">Acceptor</span><span class="p">(</span><span class="n">EventLoop</span><span class="o">*</span> <span class="n">loop</span><span class="p">,</span> <span class="k">const</span> <span class="n">InetAddress</span><span class="o">&amp;</span> <span class="n">listenAddr</span><span class="p">)</span>
  <span class="o">:</span> <span class="n">loop_</span><span class="p">(</span><span class="n">loop</span><span class="p">),</span>
  <span class="cm">/*创建一个监听套接字*/</span>
    <span class="n">acceptSocket_</span><span class="p">(</span><span class="n">sockets</span><span class="o">::</span><span class="n">createNonblockingOrDie</span><span class="p">()),</span>
  <span class="cm">/*acceptchannel 关注acceptSocket_套接字的事件 */</span>
    <span class="n">acceptChannel_</span><span class="p">(</span><span class="n">loop</span><span class="p">,</span> <span class="n">acceptSocket_</span><span class="p">.</span><span class="n">fd</span><span class="p">()),</span>
    <span class="n">listenning_</span><span class="p">(</span><span class="nb">false</span><span class="p">),</span>
    <span class="cm">/*预先准备一个文件描述符*/</span>
    <span class="n">idleFd_</span><span class="p">(</span><span class="o">::</span><span class="n">open</span><span class="p">(</span><span class="s">&#34;/dev/null&#34;</span><span class="p">,</span> <span class="n">O_RDONLY</span> <span class="o">|</span> <span class="n">O_CLOEXEC</span><span class="p">))</span>
<span class="p">{</span>
  <span class="n">assert</span><span class="p">(</span><span class="n">idleFd_</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">);</span>
  <span class="cm">/*设置地址重复利用*/</span>
  <span class="n">acceptSocket_</span><span class="p">.</span><span class="n">setReuseAddr</span><span class="p">(</span><span class="nb">true</span><span class="p">);</span>
  <span class="cm">/*绑定地址*/</span>
  <span class="n">acceptSocket_</span><span class="p">.</span><span class="n">bindAddress</span><span class="p">(</span><span class="n">listenAddr</span><span class="p">);</span>
  <span class="cm">/*设置监听套接字“读”的套接字*/</span>
  <span class="n">acceptChannel_</span><span class="p">.</span><span class="n">setReadCallback</span><span class="p">(</span>
      <span class="n">boost</span><span class="o">::</span><span class="n">bind</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Acceptor</span><span class="o">::</span><span class="n">handleRead</span><span class="p">,</span> <span class="k">this</span><span class="p">));</span>
<span class="p">}</span>
 
<span class="cm">/*虚构函数*/</span>
<span class="n">Acceptor</span><span class="o">::~</span><span class="n">Acceptor</span><span class="p">()</span>
<span class="p">{</span>
  <span class="cm">/*先取消 acceptSocket_的所有事件，然后才移除*/</span>
  <span class="n">acceptChannel_</span><span class="p">.</span><span class="n">disableAll</span><span class="p">();</span>
  <span class="n">acceptChannel_</span><span class="p">.</span><span class="n">remove</span><span class="p">();</span>
  <span class="o">::</span><span class="n">close</span><span class="p">(</span><span class="n">idleFd_</span><span class="p">);</span>
<span class="p">}</span>
<span class="cm">/*监听 监听套接字*/</span>
<span class="kt">void</span> <span class="n">Acceptor</span><span class="o">::</span><span class="n">listen</span><span class="p">()</span>
<span class="p">{</span><span class="cm">/*断言在IO线程中*/</span>
  <span class="n">loop_</span><span class="o">-&gt;</span><span class="n">assertInLoopThread</span><span class="p">();</span>
 
  <span class="n">listenning_</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
  <span class="n">acceptSocket_</span><span class="p">.</span><span class="n">listen</span><span class="p">();</span>
  <span class="cm">/*关注acceptSocket_的可读事件*/</span>
  <span class="n">acceptChannel_</span><span class="p">.</span><span class="n">enableReading</span><span class="p">();</span>
<span class="p">}</span>
 
<span class="cm">/*监听套接字的可读事件的回调函数*/</span>
<span class="kt">void</span> <span class="n">Acceptor</span><span class="o">::</span><span class="n">handleRead</span><span class="p">()</span>
<span class="p">{</span>
  <span class="cm">/*断言在IO线程中*/</span>
  <span class="n">loop_</span><span class="o">-&gt;</span><span class="n">assertInLoopThread</span><span class="p">();</span>
  <span class="cm">/*创建一个对等方的地址，这是客户端的地址*/</span>
  <span class="n">InetAddress</span> <span class="nf">peerAddr</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
  <span class="c1">//FIXME loop until no more
</span><span class="c1"></span>  <span class="cm">/*对等连接套接字*/</span>
  <span class="kt">int</span> <span class="n">connfd</span> <span class="o">=</span> <span class="n">acceptSocket_</span><span class="p">.</span><span class="n">accept</span><span class="p">(</span><span class="o">&amp;</span><span class="n">peerAddr</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">connfd</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="c1">// string hostport = peerAddr.toIpPort();
</span><span class="c1"></span>    <span class="c1">// LOG_TRACE &lt;&lt; &#34;Accepts of &#34; &lt;&lt; hostport;
</span><span class="c1"></span>    <span class="cm">/*回调上层（应用层）的回调函数*/</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">newConnectionCallback_</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">newConnectionCallback_</span><span class="p">(</span><span class="n">connfd</span><span class="p">,</span> <span class="n">peerAddr</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="cm">/*如果应用层没有回调函数，则直接关闭此连接套接字*/</span>
    <span class="k">else</span>
    <span class="p">{</span>
      <span class="n">sockets</span><span class="o">::</span><span class="n">close</span><span class="p">(</span><span class="n">connfd</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="k">else</span>
  <span class="p">{</span>
    <span class="c1">// Read the section named &#34;The special problem of
</span><span class="c1"></span>    <span class="c1">// accept()ing when you can&#39;t&#34; in libev&#39;s doc.
</span><span class="c1"></span>    <span class="c1">// By Marc Lehmann, author of livev.
</span><span class="c1"></span>    <span class="cm">/*如果是文件符超出限制*/</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">errno</span> <span class="o">==</span> <span class="n">EMFILE</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="cm">/**/</span>
      <span class="o">::</span><span class="n">close</span><span class="p">(</span><span class="n">idleFd_</span><span class="p">);</span>
      <span class="cm">/*因为这是电平触发，所以为了防止一直触发，可以先接受，然后关闭掉*/</span>
      <span class="n">idleFd_</span> <span class="o">=</span> <span class="o">::</span><span class="n">accept</span><span class="p">(</span><span class="n">acceptSocket_</span><span class="p">.</span><span class="n">fd</span><span class="p">(),</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
      <span class="o">::</span><span class="n">close</span><span class="p">(</span><span class="n">idleFd_</span><span class="p">);</span>
      <span class="n">idleFd_</span> <span class="o">=</span> <span class="o">::</span><span class="n">open</span><span class="p">(</span><span class="s">&#34;/dev/null&#34;</span><span class="p">,</span> <span class="n">O_RDONLY</span> <span class="o">|</span> <span class="n">O_CLOEXEC</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div>
<h3 id="测试程序-2">测试程序</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-c++" data-lang="c++"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c++" data-lang="c++"><span class="cp">#include</span> <span class="cpf">&lt;muduo/net/Acceptor.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;muduo/net/EventLoop.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;muduo/net/InetAddress.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;muduo/net/SocketsOps.h&gt;</span><span class="cp">
</span><span class="cp"></span> 
<span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
</span><span class="cp"></span> 
<span class="k">using</span> <span class="k">namespace</span> <span class="n">muduo</span><span class="p">;</span>
<span class="k">using</span> <span class="k">namespace</span> <span class="n">muduo</span><span class="o">::</span><span class="n">net</span><span class="p">;</span>
 
<span class="kt">void</span> <span class="nf">newConnection</span><span class="p">(</span><span class="kt">int</span> <span class="n">sockfd</span><span class="p">,</span> <span class="k">const</span> <span class="n">InetAddress</span><span class="o">&amp;</span> <span class="n">peerAddr</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">printf</span><span class="p">(</span><span class="s">&#34;newConnection(): accepted a new connection from %s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span>
         <span class="n">peerAddr</span><span class="p">.</span><span class="n">toIpPort</span><span class="p">().</span><span class="n">c_str</span><span class="p">());</span>
  <span class="o">::</span><span class="n">write</span><span class="p">(</span><span class="n">sockfd</span><span class="p">,</span> <span class="s">&#34;How are you?</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="mi">13</span><span class="p">);</span>
  <span class="n">sockets</span><span class="o">::</span><span class="n">close</span><span class="p">(</span><span class="n">sockfd</span><span class="p">);</span>
<span class="p">}</span>
 
<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>
<span class="p">{</span>
  <span class="n">printf</span><span class="p">(</span><span class="s">&#34;main(): pid = %d</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">getpid</span><span class="p">());</span>
 
  <span class="n">InetAddress</span> <span class="n">listenAddr</span><span class="p">(</span><span class="mi">8888</span><span class="p">);</span>
  <span class="n">EventLoop</span> <span class="n">loop</span><span class="p">;</span>
 
  <span class="n">Acceptor</span> <span class="n">acceptor</span><span class="p">(</span><span class="o">&amp;</span><span class="n">loop</span><span class="p">,</span> <span class="n">listenAddr</span><span class="p">);</span>
  <span class="n">acceptor</span><span class="p">.</span><span class="n">setNewConnectionCallback</span><span class="p">(</span><span class="n">newConnection</span><span class="p">);</span>
  <span class="n">acceptor</span><span class="p">.</span><span class="n">listen</span><span class="p">();</span>
 
  <span class="n">loop</span><span class="p">.</span><span class="n">loop</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div>
<h3 id="程序输出-2">程序输出</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-c" data-lang="c"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c" data-lang="c"><span class="n">ubuntu</span><span class="err">@</span><span class="n">ubuntu</span><span class="o">-</span><span class="n">virtual</span><span class="o">-</span><span class="nl">machine</span><span class="p">:</span><span class="o">~</span><span class="err">$</span> <span class="n">telnet</span> <span class="mf">127.0.0.1</span> <span class="mi">8888</span>
<span class="n">Trying</span> <span class="mf">127.0.0.1</span><span class="p">...</span>
<span class="n">Connected</span> <span class="n">to</span> <span class="mf">127.0.0.1</span><span class="p">.</span>
<span class="n">Escape</span> <span class="n">character</span> <span class="n">is</span> <span class="err">&#39;</span><span class="o">^</span><span class="p">]</span><span class="err">&#39;</span><span class="p">.</span>
<span class="n">How</span> <span class="n">Are</span> <span class="n">You</span> <span class="o">?</span>
<span class="n">Connection</span> <span class="n">closed</span> <span class="n">by</span> <span class="n">foreign</span> <span class="n">host</span><span class="p">.</span>
<span class="n">ubuntu</span><span class="err">@</span><span class="n">ubuntu</span><span class="o">-</span><span class="n">virtual</span><span class="o">-</span><span class="nl">machine</span><span class="p">:</span><span class="o">~</span><span class="err">$</span> <span class="n">telnet</span> <span class="mf">127.0.0.1</span> <span class="mi">8888</span>
<span class="n">Trying</span> <span class="mf">127.0.0.1</span><span class="p">...</span>
<span class="n">Connected</span> <span class="n">to</span> <span class="mf">127.0.0.1</span><span class="p">.</span>
<span class="n">Escape</span> <span class="n">character</span> <span class="n">is</span> <span class="err">&#39;</span><span class="o">^</span><span class="p">]</span><span class="err">&#39;</span><span class="p">.</span>
<span class="n">How</span> <span class="n">Are</span> <span class="n">You</span> <span class="o">?</span>
<span class="n">Connection</span> <span class="n">closed</span> <span class="n">by</span> <span class="n">foreign</span> <span class="n">host</span><span class="p">.</span>
<span class="n">ubuntu</span><span class="err">@</span><span class="n">ubuntu</span><span class="o">-</span><span class="n">virtual</span><span class="o">-</span><span class="nl">machine</span><span class="p">:</span><span class="o">~</span><span class="err">$</span></code></pre></td></tr></table>
</div>
</div>
    </div>

    <div class="post-copyright">
  <p class="copyright-item">
    <span class="item-title">Author</span>
    <span class="item-content">Rg</span>
  </p>
  <p class="copyright-item">
    <span class="item-title">LastMod</span>
    <span class="item-content">
        2015-07-01
        
    </span>
  </p>
  
  <p class="copyright-item">
    <span class="item-title">License</span>
    <span class="item-content">本文采用<a rel="license" href="http://creativecommons.org/licenses/by-nc/4.0/" target="_blank">知识共享署名-非商业性使用 4.0 国际许可协议</a>进行许可</span>
  </p>
</div>
<div class="post-reward">
  <input type="checkbox" name="reward" id="reward" hidden />
  <label class="reward-button" for="reward">Reward</label>
  <div class="qr-code">
    
    <label class="qr-code-image" for="reward">
        <img class="image" src="https://ws2.sinaimg.cn/large/006tNc79gy1g1r15n5iquj30u014qgqe.jpg">
        <span>wechat</span>
      </label>
    
  </div>
</div><footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/muduo/">muduo</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/2015/07/01/muduo-net-library-chapter-2/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">muduo net library chapter 2</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        <a class="next" href="/2015/04/25/cowboy/">
            <span class="next-text nav-default">cowboy</span>
            <span class="next-text nav-mobile">Next</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        <div id="gitalk-container"></div>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js" crossorigin="anonymous"></script>
    <script type="text/javascript">
      var gitalk = new Gitalk({
        id: '2015-07-01 00:04:49 \x2b0000 UTC',
        title: 'muduo net library chapter 1',
        clientID: '88e50f263d090b13460f',
        clientSecret: 'f1007eb6cff0af3b461be3a4b73d808ab7058a21',
        repo: 'blog',
        owner: 'laohanlinux',
        admin: ['laohanlinux'],
        body: decodeURI(location.href)
      });
      gitalk.render('gitalk-container');
    </script>
    <noscript>Please enable JavaScript to view the <a href="https://github.com/gitalk/gitalk">comments powered by gitalk.</a></noscript>

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
      <a href="mailto:daimaldd@email.com" class="iconfont icon-email" title="email"></a>
      <a href="https://github.com/laohanlinux" class="iconfont icon-github" title="github"></a>
  <a href="https://laohanlinux.github.io/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2014 - 
    2019
    <span class="heart">
      <i class="iconfont icon-heart"></i>
    </span>
    <span class="author">Rg</span>
  </span>
</div>
    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script>
<script type="text/javascript" src="/dist/even.26188efa.min.js"></script>








</body>
</html>
