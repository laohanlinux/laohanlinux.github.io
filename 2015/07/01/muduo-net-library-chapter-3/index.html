<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>muduo net library chapter 3 - Welcome to Rg Home</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<meta name="author" content="Rg" /><meta name="description" content="muduo 是一个linux 网络库，使用poll和epoll模式。 这些内容是本人在大学的时候，通过  &lt;&lt; c&#43;&#43;教程网 &gt;&gt;  所学的知识笔记. 已经过去好几年了，版本也是比较老的了，属于入门级别的教程； 如有错误，纯属正常!!!" /><meta name="keywords" content="Rg, Rust, even" />






<meta name="generator" content="Hugo 0.54.0 with even 4.0.0" />


<link rel="canonical" href="https://laohanlinux.github.io/2015/07/01/muduo-net-library-chapter-3/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">


<link href="/dist/even.3292c2b1.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">


<meta property="og:title" content="muduo net library chapter 3" />
<meta property="og:description" content="muduo 是一个linux 网络库，使用poll和epoll模式。 这些内容是本人在大学的时候，通过  &lt;&lt; c&#43;&#43;教程网 &gt;&gt;  所学的知识笔记. 已经过去好几年了，版本也是比较老的了，属于入门级别的教程； 如有错误，纯属正常!!!" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://laohanlinux.github.io/2015/07/01/muduo-net-library-chapter-3/" />
<meta property="article:published_time" content="2015-07-01T00:24:59&#43;00:00"/>
<meta property="article:modified_time" content="2015-07-01T00:24:59&#43;00:00"/>

<meta itemprop="name" content="muduo net library chapter 3">
<meta itemprop="description" content="muduo 是一个linux 网络库，使用poll和epoll模式。 这些内容是本人在大学的时候，通过  &lt;&lt; c&#43;&#43;教程网 &gt;&gt;  所学的知识笔记. 已经过去好几年了，版本也是比较老的了，属于入门级别的教程； 如有错误，纯属正常!!!">


<meta itemprop="datePublished" content="2015-07-01T00:24:59&#43;00:00" />
<meta itemprop="dateModified" content="2015-07-01T00:24:59&#43;00:00" />
<meta itemprop="wordCount" content="25022">



<meta itemprop="keywords" content="muduo," />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="muduo net library chapter 3"/>
<meta name="twitter:description" content="muduo 是一个linux 网络库，使用poll和epoll模式。 这些内容是本人在大学的时候，通过  &lt;&lt; c&#43;&#43;教程网 &gt;&gt;  所学的知识笔记. 已经过去好几年了，版本也是比较老的了，属于入门级别的教程； 如有错误，纯属正常!!!"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">Welcome come to Rg Home</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Go ~/</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a>
  </ul>
</nav>
  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">Welcome come to Rg Home</a>
</div>

<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Go ~/</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li>
  </ul>
</nav>
    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">muduo net library chapter 3</h1>

      <div class="post-meta">
        <span class="post-time"> 2015-07-01 </span>
        <div class="post-category">
            <a href="/categories/muduo/"> muduo </a>
            <a href="/categories/network-program/"> network program </a>
            </div>
          <span class="more-meta"> 25022 words </span>
          <span class="more-meta"> 50 mins read </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Contents</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
<ul>
<li>
<ul>
<li><a href="#34-tcpserver-tcpconnection">[34] TcpServer/TcpConnection</a>
<ul>
<li><a href="#时序图">时序图</a></li>
<li><a href="#tcpserver头文件">TcpServer头文件</a></li>
<li><a href="#tcpserver源文件">TcpServer源文件</a></li>
<li><a href="#tcpconnection头文件">TcpConnection头文件</a></li>
<li><a href="#tcpconnection源文件">TcpConnection源文件</a></li>
<li><a href="#callback源文件">CallBack源文件</a></li>
<li><a href="#测试程序1">测试程序1</a></li>
<li><a href="#程序输出">程序输出:</a></li>
<li><a href="#服务器端">服务器端</a></li>
<li><a href="#测试程序2">测试程序2</a></li>
</ul></li>
<li><a href="#35-1-multiple-reactors">[35-1] multiple reactors</a>
<ul>
<li><a href="#eventloopthreadpool-头文件"><code>EventLoopThreadPool</code>头文件</a></li>
<li><a href="#eventloopthreadpool源文件">EventLoopThreadPool源文件</a></li>
<li><a href="#tcpserver头文件-1">TcpServer头文件</a></li>
<li><a href="#tcpserver源文件-1">TcpServer源文件</a></li>
<li><a href="#测试程序">测试程序</a></li>
</ul></li>
<li><a href="#35-2-文件描述符的分析">[35-2] 文件描述符的分析</a>
<ul>
<li><a href="#code">code</a></li>
<li><a href="#分析结果">分析结果</a></li>
</ul></li>
<li><a href="#36-1-buffer">[36-1] BUFFER</a>
<ul>
<li><a href="#buffer头文件">BUFFER头文件</a></li>
<li><a href="#buffer源文件">BUFFER源文件</a></li>
</ul></li>
<li><a href="#37-buffer">[37] BUFFER</a>
<ul>
<li><a href="#测试程序-1">测试程序</a></li>
<li><a href="#客户端">客户端</a></li>
<li><a href="#程序输出-1">程序输出</a></li>
</ul></li>
<li><a href="#38-完善tcpconnection">[38] 完善TcpConnection</a>
<ul>
<li><a href="#tcpconnection-完整的源文件">TcpConnection 完整的源文件</a></li>
<li><a href="#测试程序-2">测试程序</a></li>
</ul></li>
<li><a href="#39-tcpclient和connector">[39] TcpClient和connector</a>
<ul>
<li><a href="#测试程序-3">测试程序</a></li>
<li><a href="#tcpclient-头文件">TcpClient 头文件</a></li>
<li><a href="#tcpclient-源文件">TcpClient 源文件</a></li>
<li><a href="#connector-头文件">Connector 头文件</a></li>
<li><a href="#connector-源文件">Connector 源文件</a></li>
<li><a href="#测试程序-4">测试程序</a></li>
</ul></li>
<li><a href="#40-http-简单描述">[40] http 简单描述</a>
<ul>
<li><a href="#http-request">http request</a>
<ul>
<li><a href="#请求方法有">请求方法有</a></li>
<li><a href="#常用请求头">常用请求头</a></li>
</ul></li>
<li><a href="#http-response">http response</a></li>
<li><a href="#一个典型的http请求">一个典型的http请求</a></li>
<li><a href="#一个典型的http应答">一个典型的http应答</a></li>
<li><a href="#muduo-http库涉及到的类">muduo_http库涉及到的类</a></li>
</ul></li>
<li><a href="#40-1-http实现源码">[40-1] http实现源码</a>
<ul>
<li><a href="#httprequest头文件-包含实现">HttpRequest头文件(包含实现)</a></li>
<li><a href="#httpresponse头文件">HttpResponse头文件</a></li>
<li><a href="#httpresponse源文件">HttpResponse源文件</a></li>
<li><a href="#httpcontext文件">HttpContext文件</a></li>
<li><a href="#httpserver头文件">HttpServer头文件</a></li>
<li><a href="#测试程序-5">测试程序</a></li>
</ul></li>
<li><a href="#41-muduo-inspect库源码分析">[41] muduo_inspect库源码分析</a>
<ul>
<li><a href="#processinspectort头文件">ProcessInspectort头文件</a></li>
<li><a href="#processinspectort源文件">ProcessInspectort源文件</a></li>
<li><a href="#inspector头文件">Inspector头文件</a></li>
<li><a href="#inspector源文件">Inspector源文件</a></li>
</ul></li>
</ul></li>
</ul>
</nav>
  </div>
</div>
    <div class="post-content">
      

<h2 id="34-tcpserver-tcpconnection">[34] TcpServer/TcpConnection</h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-c++" data-lang="c++"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c++" data-lang="c++"><span class="n">Acceptor类的主要功能是socket</span><span class="err">、</span><span class="n">bind</span><span class="err">、</span><span class="n">listen</span>
<span class="err">般来说，在上层应用程序中，我们不直接使用</span><span class="n">Acceptor</span><span class="err">，而是把它作为</span><span class="n">TcpServer的成员</span>
<span class="n">TcpServer还包含了一个TcpConnection列表</span>
<span class="n">TcpConnection与Acceptor类似</span><span class="err">，有两个重要的数据成员，</span><span class="n">Socket与Channel</span> 
</code></pre></td></tr></table>
</div>
</div>
<h3 id="时序图">时序图</h3>

<p><center> <img src="http://laohanlinux.github.io/images/img/blog/muduo-net-library-chapter-3/tcpserver_tcpconnection.png" alt="" /> </center></p>

<h3 id="tcpserver头文件">TcpServer头文件</h3>

<p>TcpServer.h</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-c++" data-lang="c++"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span><span class="lnt">84
</span><span class="lnt">85
</span><span class="lnt">86
</span><span class="lnt">87
</span><span class="lnt">88
</span><span class="lnt">89
</span><span class="lnt">90
</span><span class="lnt">91
</span><span class="lnt">92
</span><span class="lnt">93
</span><span class="lnt">94
</span><span class="lnt">95
</span><span class="lnt">96
</span><span class="lnt">97
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c++" data-lang="c++"><span class="c1">// Copyright 2010, Shuo Chen.  All rights reserved.
</span><span class="c1">// http://code.google.com/p/muduo/
</span><span class="c1">//
</span><span class="c1">// Use of this source code is governed by a BSD-style license
</span><span class="c1">// that can be found in the License file.
</span><span class="c1"></span> 
<span class="c1">// Author: Shuo Chen (chenshuo at chenshuo dot com)
</span><span class="c1">//
</span><span class="c1">// This is a public header file, it must only include public header files.
</span><span class="c1"></span> 
<span class="cp">#ifndef MUDUO_NET_TCPSERVER_H
</span><span class="cp">#define MUDUO_NET_TCPSERVER_H
</span><span class="cp"></span> 
<span class="cp">#include</span> <span class="cpf">&lt;muduo/base/Types.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;muduo/net/TcpConnection.h&gt;</span><span class="cp">
</span><span class="cp"></span> 
<span class="cp">#include</span> <span class="cpf">&lt;map&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;boost/noncopyable.hpp&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;boost/scoped_ptr.hpp&gt;</span><span class="cp">
</span><span class="cp"></span> 
<span class="k">namespace</span> <span class="n">muduo</span>
<span class="p">{</span>
<span class="k">namespace</span> <span class="n">net</span>
<span class="p">{</span>
 
<span class="k">class</span><span class="err"> </span><span class="nc">Acceptor</span><span class="p">;</span>
<span class="k">class</span><span class="err"> </span><span class="nc">EventLoop</span><span class="p">;</span>
 
<span class="c1">///
</span><span class="c1">/// TCP server, supports single-threaded and thread-pool models.
</span><span class="c1">///
</span><span class="c1">/// This is an interface class, so don&#39;t expose too much details.
</span><span class="c1"></span><span class="k">class</span><span class="err"> </span><span class="nc">TcpServer</span> <span class="o">:</span> <span class="n">boost</span><span class="o">::</span><span class="n">noncopyable</span>
<span class="p">{</span>
 <span class="k">public</span><span class="o">:</span>
  <span class="c1">//typedef boost::function&lt;void(EventLoop*)&gt; ThreadInitCallback;
</span><span class="c1"></span> 
  <span class="c1">//TcpServer(EventLoop* loop, const InetAddress&amp; listenAddr);
</span><span class="c1"></span>  <span class="n">TcpServer</span><span class="p">(</span><span class="n">EventLoop</span><span class="o">*</span> <span class="n">loop</span><span class="p">,</span>
            <span class="k">const</span> <span class="n">InetAddress</span><span class="o">&amp;</span> <span class="n">listenAddr</span><span class="p">,</span>
            <span class="k">const</span> <span class="n">string</span><span class="o">&amp;</span> <span class="n">nameArg</span><span class="p">);</span>
  <span class="o">~</span><span class="n">TcpServer</span><span class="p">();</span>  <span class="c1">// force out-line dtor, for scoped_ptr members.
</span><span class="c1"></span> 
  <span class="cm">/*返回服务器的名称*/</span>
  <span class="k">const</span> <span class="n">string</span><span class="o">&amp;</span> <span class="n">hostport</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span> <span class="k">return</span> <span class="n">hostport_</span><span class="p">;</span> <span class="p">}</span>
  <span class="cm">/*返回服务器的监听端口*/</span>
  <span class="k">const</span> <span class="n">string</span><span class="o">&amp;</span> <span class="n">name</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span> <span class="k">return</span> <span class="n">name_</span><span class="p">;</span> <span class="p">}</span>
 
  <span class="c1">/// Starts the server if it&#39;s not listenning.
</span><span class="c1"></span>  <span class="c1">///
</span><span class="c1"></span>  <span class="c1">/// It&#39;s harmless to call it multiple times.
</span><span class="c1"></span>  <span class="c1">/// Thread safe.
</span><span class="c1"></span>  <span class="kt">void</span> <span class="n">start</span><span class="p">();</span>
 
  <span class="c1">/// Set connection callback.
</span><span class="c1"></span>  <span class="c1">/// Not thread safe.
</span><span class="c1"></span>  <span class="c1">// 设置连接到来或者连接关闭回调函数
</span><span class="c1"></span>  <span class="kt">void</span> <span class="nf">setConnectionCallback</span><span class="p">(</span><span class="k">const</span> <span class="n">ConnectionCallback</span><span class="o">&amp;</span> <span class="n">cb</span><span class="p">)</span>
  <span class="p">{</span> <span class="n">connectionCallback_</span> <span class="o">=</span> <span class="n">cb</span><span class="p">;</span> <span class="p">}</span>
 
  <span class="c1">/// Set message callback.
</span><span class="c1"></span>  <span class="c1">/// Not thread safe.
</span><span class="c1"></span>  <span class="c1">// 设置消息到来回调函数
</span><span class="c1"></span>  <span class="kt">void</span> <span class="nf">setMessageCallback</span><span class="p">(</span><span class="k">const</span> <span class="n">MessageCallback</span><span class="o">&amp;</span> <span class="n">cb</span><span class="p">)</span>
  <span class="p">{</span> <span class="n">messageCallback_</span> <span class="o">=</span> <span class="n">cb</span><span class="p">;</span> <span class="p">}</span>
 
 
 <span class="k">private</span><span class="o">:</span>
  <span class="c1">/// Not thread safe, but in loop
</span><span class="c1"></span>  <span class="c1">// Acceptor::handleRead函数中会回调用TcpServer::newConnection
</span><span class="c1"></span>  <span class="c1">// _1对应的是socket文件描述符，_2对应的是对等方的地址(InetAddress)
</span><span class="c1"></span>  <span class="c1">//应该还在IO线程里面
</span><span class="c1"></span>  <span class="c1">// newConnection和connectionCallback_都是连接回调函数，但是connectionCallback_
</span><span class="c1"></span>  <span class="c1">// 是给应用程序使用的，newConnection是库函数，不会暴露给用户。
</span><span class="c1"></span>  <span class="c1">// 其实就是newConnection函数主要负责注册connectionCallback_ 函数
</span><span class="c1"></span>  <span class="kt">void</span> <span class="n">newConnection</span><span class="p">(</span><span class="kt">int</span> <span class="n">sockfd</span><span class="p">,</span> <span class="k">const</span> <span class="n">InetAddress</span><span class="o">&amp;</span> <span class="n">peerAddr</span><span class="p">);</span>
 
  <span class="k">typedef</span> <span class="n">std</span><span class="o">::</span><span class="n">map</span><span class="o">&lt;</span><span class="n">string</span><span class="p">,</span> <span class="n">TcpConnectionPtr</span><span class="o">&gt;</span> <span class="n">ConnectionMap</span><span class="p">;</span>
 
  <span class="n">EventLoop</span><span class="o">*</span> <span class="n">loop_</span><span class="p">;</span>  <span class="c1">// the acceptor&#39;s loop，不一定是连接所属的eventloop
</span><span class="c1"></span>  <span class="k">const</span> <span class="n">string</span> <span class="n">hostport_</span><span class="p">;</span>       <span class="c1">// 服务端口
</span><span class="c1"></span>  <span class="k">const</span> <span class="n">string</span> <span class="n">name_</span><span class="p">;</span>           <span class="c1">// 服务名
</span><span class="c1"></span>  <span class="n">boost</span><span class="o">::</span><span class="n">scoped_ptr</span><span class="o">&lt;</span><span class="n">Acceptor</span><span class="o">&gt;</span> <span class="n">acceptor_</span><span class="p">;</span> <span class="c1">// avoid revealing Acceptor
</span><span class="c1"></span>  <span class="cm">/*连接到来的回调函数*/</span>
  <span class="n">ConnectionCallback</span> <span class="n">connectionCallback_</span><span class="p">;</span>
  <span class="cm">/*消息到来的回调函数*/</span>
  <span class="n">MessageCallback</span> <span class="n">messageCallback_</span><span class="p">;</span>
  <span class="kt">bool</span> <span class="n">started_</span><span class="p">;</span> <span class="cm">/*连接是否启动*/</span>
  <span class="c1">// always in loop thread
</span><span class="c1"></span>  <span class="kt">int</span> <span class="n">nextConnId_</span><span class="p">;</span>              <span class="c1">// 下一个连接ID
</span><span class="c1"></span>  <span class="n">ConnectionMap</span> <span class="n">connections_</span><span class="p">;</span>   <span class="c1">// 连接列表
</span><span class="c1"></span><span class="p">};</span>
 
<span class="p">}</span>
<span class="p">}</span>
 
<span class="cp">#endif  </span><span class="c1">// MUDUO_NET_TCPSERVER_H
</span></code></pre></td></tr></table>
</div>
</div>
<h3 id="tcpserver源文件">TcpServer源文件</h3>

<p>TcpServer.cc</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-c++" data-lang="c++"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span><span class="lnt">84
</span><span class="lnt">85
</span><span class="lnt">86
</span><span class="lnt">87
</span><span class="lnt">88
</span><span class="lnt">89
</span><span class="lnt">90
</span><span class="lnt">91
</span><span class="lnt">92
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c++" data-lang="c++"><span class="c1">// Copyright 2010, Shuo Chen.  All rights reserved.
</span><span class="c1">// http://code.google.com/p/muduo/
</span><span class="c1">//
</span><span class="c1">// Use of this source code is governed by a BSD-style license
</span><span class="c1">// that can be found in the License file.
</span><span class="c1"></span> 
<span class="c1">// Author: Shuo Chen (chenshuo at chenshuo dot com)
</span><span class="c1"></span> 
<span class="cp">#include</span> <span class="cpf">&lt;muduo/net/TcpServer.h&gt;</span><span class="cp">
</span><span class="cp"></span> 
<span class="cp">#include</span> <span class="cpf">&lt;muduo/base/Logging.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;muduo/net/Acceptor.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;muduo/net/EventLoop.h&gt;</span><span class="cp">
</span><span class="cp"></span><span class="c1">//#include &lt;muduo/net/EventLoopThreadPool.h&gt;
</span><span class="c1"></span><span class="cp">#include</span> <span class="cpf">&lt;muduo/net/SocketsOps.h&gt;</span><span class="cp">
</span><span class="cp"></span> 
<span class="cp">#include</span> <span class="cpf">&lt;boost/bind.hpp&gt;</span><span class="cp">
</span><span class="cp"></span> 
<span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;  // snprintf</span><span class="cp">
</span><span class="cp"></span> 
<span class="k">using</span> <span class="k">namespace</span> <span class="n">muduo</span><span class="p">;</span>
<span class="k">using</span> <span class="k">namespace</span> <span class="n">muduo</span><span class="o">::</span><span class="n">net</span><span class="p">;</span>
 
<span class="n">TcpServer</span><span class="o">::</span><span class="n">TcpServer</span><span class="p">(</span><span class="n">EventLoop</span><span class="o">*</span> <span class="n">loop</span><span class="p">,</span>
                     <span class="k">const</span> <span class="n">InetAddress</span><span class="o">&amp;</span> <span class="n">listenAddr</span><span class="p">,</span>
                     <span class="k">const</span> <span class="n">string</span><span class="o">&amp;</span> <span class="n">nameArg</span><span class="p">)</span>
  <span class="o">:</span> <span class="n">loop_</span><span class="p">(</span><span class="n">CHECK_NOTNULL</span><span class="p">(</span><span class="n">loop</span><span class="p">)),</span>
    <span class="n">hostport_</span><span class="p">(</span><span class="n">listenAddr</span><span class="p">.</span><span class="n">toIpPort</span><span class="p">()),</span>
    <span class="n">name_</span><span class="p">(</span><span class="n">nameArg</span><span class="p">),</span>
    <span class="n">acceptor_</span><span class="p">(</span><span class="k">new</span> <span class="n">Acceptor</span><span class="p">(</span><span class="n">loop</span><span class="p">,</span> <span class="n">listenAddr</span><span class="p">)),</span>
    <span class="cm">/*threadPool_(new EventLoopThreadPool(loop)),
</span><span class="cm">    connectionCallback_(defaultConnectionCallback),
</span><span class="cm">    messageCallback_(defaultMessageCallback),*/</span>
    <span class="n">started_</span><span class="p">(</span><span class="nb">false</span><span class="p">),</span>
    <span class="n">nextConnId_</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="p">{</span>
  <span class="c1">// Acceptor::handleRead函数中会回调用TcpServer::newConnection
</span><span class="c1"></span>  <span class="c1">// _1对应的是socket文件描述符，_2对应的是对等方的地址(InetAddress)
</span><span class="c1"></span>  <span class="n">acceptor_</span><span class="o">-&gt;</span><span class="n">setNewConnectionCallback</span><span class="p">(</span>
      <span class="n">boost</span><span class="o">::</span><span class="n">bind</span><span class="p">(</span><span class="o">&amp;</span><span class="n">TcpServer</span><span class="o">::</span><span class="n">newConnection</span><span class="p">,</span> <span class="k">this</span><span class="p">,</span> <span class="n">_1</span><span class="p">,</span> <span class="n">_2</span><span class="p">));</span>
<span class="p">}</span>
 
<span class="n">TcpServer</span><span class="o">::~</span><span class="n">TcpServer</span><span class="p">()</span>
<span class="p">{</span>
  <span class="n">loop_</span><span class="o">-&gt;</span><span class="n">assertInLoopThread</span><span class="p">();</span>
  <span class="n">LOG_TRACE</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;TcpServer::~TcpServer [&#34;</span> <span class="o">&lt;&lt;</span> <span class="n">name_</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;] destructing&#34;</span><span class="p">;</span>
<span class="p">}</span>
 
<span class="c1">// 该函数多次调用是无害的
</span><span class="c1">// 该函数可以跨线程调用
</span><span class="c1"></span><span class="kt">void</span> <span class="n">TcpServer</span><span class="o">::</span><span class="n">start</span><span class="p">()</span>
<span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">started_</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">started_</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
  <span class="p">}</span>
 
  <span class="cm">/*如果还没有被执行，那么让他在IO线程中执行listen函数*/</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">acceptor_</span><span class="o">-&gt;</span><span class="n">listenning</span><span class="p">())</span>
  <span class="p">{</span>
    <span class="c1">// get_pointer返回原生指针
</span><span class="c1"></span>    <span class="n">loop_</span><span class="o">-&gt;</span><span class="n">runInLoop</span><span class="p">(</span>
        <span class="n">boost</span><span class="o">::</span><span class="n">bind</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Acceptor</span><span class="o">::</span><span class="n">listen</span><span class="p">,</span> <span class="n">get_pointer</span><span class="p">(</span><span class="n">acceptor_</span><span class="p">)));</span>
  <span class="p">}</span>
<span class="p">}</span>
 
<span class="kt">void</span> <span class="n">TcpServer</span><span class="o">::</span><span class="n">newConnection</span><span class="p">(</span><span class="kt">int</span> <span class="n">sockfd</span><span class="p">,</span> <span class="k">const</span> <span class="n">InetAddress</span><span class="o">&amp;</span> <span class="n">peerAddr</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">loop_</span><span class="o">-&gt;</span><span class="n">assertInLoopThread</span><span class="p">();</span>
  <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>
  <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span> <span class="n">buf</span><span class="p">,</span> <span class="s">&#34;:%s#%d&#34;</span><span class="p">,</span> <span class="n">hostport_</span><span class="p">.</span><span class="n">c_str</span><span class="p">(),</span> <span class="n">nextConnId_</span><span class="p">);</span>
  <span class="o">++</span><span class="n">nextConnId_</span><span class="p">;</span>
  <span class="n">string</span> <span class="n">connName</span> <span class="o">=</span> <span class="n">name_</span> <span class="o">+</span> <span class="n">buf</span><span class="p">;</span>
 
  <span class="n">LOG_INFO</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;TcpServer::newConnection [&#34;</span> <span class="o">&lt;&lt;</span> <span class="n">name_</span>
           <span class="o">&lt;&lt;</span> <span class="s">&#34;] - new connection [&#34;</span> <span class="o">&lt;&lt;</span> <span class="n">connName</span>
           <span class="o">&lt;&lt;</span> <span class="s">&#34;] from &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">peerAddr</span><span class="p">.</span><span class="n">toIpPort</span><span class="p">();</span>
  <span class="n">InetAddress</span> <span class="nf">localAddr</span><span class="p">(</span><span class="n">sockets</span><span class="o">::</span><span class="n">getLocalAddr</span><span class="p">(</span><span class="n">sockfd</span><span class="p">));</span>
  <span class="c1">// FIXME poll with zero timeout to double confirm the new connection
</span><span class="c1"></span>  <span class="c1">// FIXME use make_shared if necessary
</span><span class="c1"></span>  <span class="cm">/*构建一个连接对象*/</span>
  <span class="n">TcpConnectionPtr</span> <span class="nf">conn</span><span class="p">(</span><span class="k">new</span> <span class="n">TcpConnection</span><span class="p">(</span><span class="n">loop_</span><span class="p">,</span>
                                          <span class="n">connName</span><span class="p">,</span>
                                          <span class="n">sockfd</span><span class="p">,</span>
                                          <span class="n">localAddr</span><span class="p">,</span>
                                          <span class="n">peerAddr</span><span class="p">));</span>
  <span class="n">connections_</span><span class="p">[</span><span class="n">connName</span><span class="p">]</span> <span class="o">=</span> <span class="n">conn</span><span class="p">;</span>
  <span class="n">conn</span><span class="o">-&gt;</span><span class="n">setConnectionCallback</span><span class="p">(</span><span class="n">connectionCallback_</span><span class="p">);</span>
  <span class="n">conn</span><span class="o">-&gt;</span><span class="n">setMessageCallback</span><span class="p">(</span><span class="n">messageCallback_</span><span class="p">);</span>
 
  <span class="n">conn</span><span class="o">-&gt;</span><span class="n">connectEstablished</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div>
<h3 id="tcpconnection头文件">TcpConnection头文件</h3>

<p>TcpConnection.h</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-c++" data-lang="c++"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span><span class="lnt">84
</span><span class="lnt">85
</span><span class="lnt">86
</span><span class="lnt">87
</span><span class="lnt">88
</span><span class="lnt">89
</span><span class="lnt">90
</span><span class="lnt">91
</span><span class="lnt">92
</span><span class="lnt">93
</span><span class="lnt">94
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c++" data-lang="c++"><span class="c1">// Copyright 2010, Shuo Chen.  All rights reserved.
</span><span class="c1">// http://code.google.com/p/muduo/
</span><span class="c1">//
</span><span class="c1">// Use of this source code is governed by a BSD-style license
</span><span class="c1">// that can be found in the License file.
</span><span class="c1"></span> 
<span class="c1">// Author: Shuo Chen (chenshuo at chenshuo dot com)
</span><span class="c1">//
</span><span class="c1">// This is a public header file, it must only include public header files.
</span><span class="c1"></span> 
<span class="cp">#ifndef MUDUO_NET_TCPCONNECTION_H
</span><span class="cp">#define MUDUO_NET_TCPCONNECTION_H
</span><span class="cp"></span> 
<span class="cp">#include</span> <span class="cpf">&lt;muduo/base/Mutex.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;muduo/base/StringPiece.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;muduo/base/Types.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;muduo/net/Callbacks.h&gt;</span><span class="cp">
</span><span class="cp"></span><span class="c1">//#include &lt;muduo/net/Buffer.h&gt;
</span><span class="c1"></span><span class="cp">#include</span> <span class="cpf">&lt;muduo/net/InetAddress.h&gt;</span><span class="cp">
</span><span class="cp"></span> 
<span class="c1">//#include &lt;boost/any.hpp&gt;
</span><span class="c1"></span><span class="cp">#include</span> <span class="cpf">&lt;boost/enable_shared_from_this.hpp&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;boost/noncopyable.hpp&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;boost/scoped_ptr.hpp&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;boost/shared_ptr.hpp&gt;</span><span class="cp">
</span><span class="cp"></span> 
<span class="k">namespace</span> <span class="n">muduo</span>
<span class="p">{</span>
<span class="k">namespace</span> <span class="n">net</span>
<span class="p">{</span>
 
<span class="k">class</span><span class="err"> </span><span class="nc">Channel</span><span class="p">;</span>
<span class="k">class</span><span class="err"> </span><span class="nc">EventLoop</span><span class="p">;</span>
<span class="k">class</span><span class="err"> </span><span class="nc">Socket</span><span class="p">;</span>
 
<span class="c1">///
</span><span class="c1">/// TCP connection, for both client and server usage.
</span><span class="c1">///
</span><span class="c1">/// This is an interface class, so don&#39;t expose too much details.
</span><span class="c1"></span><span class="k">class</span><span class="err"> </span><span class="nc">TcpConnection</span> <span class="o">:</span> <span class="n">boost</span><span class="o">::</span><span class="n">noncopyable</span><span class="p">,</span>
                      <span class="k">public</span> <span class="n">boost</span><span class="o">::</span><span class="n">enable_shared_from_this</span><span class="o">&lt;</span><span class="n">TcpConnection</span><span class="o">&gt;</span>
<span class="p">{</span>
 <span class="k">public</span><span class="o">:</span>
  <span class="c1">/// Constructs a TcpConnection with a connected sockfd
</span><span class="c1"></span>  <span class="c1">///
</span><span class="c1"></span>  <span class="c1">/// User should not create this object.
</span><span class="c1"></span>  <span class="n">TcpConnection</span><span class="p">(</span><span class="n">EventLoop</span><span class="o">*</span> <span class="n">loop</span><span class="p">,</span>
                <span class="k">const</span> <span class="n">string</span><span class="o">&amp;</span> <span class="n">name</span><span class="p">,</span>
                <span class="kt">int</span> <span class="n">sockfd</span><span class="p">,</span>
                <span class="k">const</span> <span class="n">InetAddress</span><span class="o">&amp;</span> <span class="n">localAddr</span><span class="p">,</span>
                <span class="k">const</span> <span class="n">InetAddress</span><span class="o">&amp;</span> <span class="n">peerAddr</span><span class="p">);</span>
  <span class="o">~</span><span class="n">TcpConnection</span><span class="p">();</span>
 
  <span class="n">EventLoop</span><span class="o">*</span> <span class="nf">getLoop</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span> <span class="k">return</span> <span class="n">loop_</span><span class="p">;</span> <span class="p">}</span>
  <span class="k">const</span> <span class="n">string</span><span class="o">&amp;</span> <span class="n">name</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span> <span class="k">return</span> <span class="n">name_</span><span class="p">;</span> <span class="p">}</span>
  <span class="k">const</span> <span class="n">InetAddress</span><span class="o">&amp;</span> <span class="n">localAddress</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="n">localAddr_</span><span class="p">;</span> <span class="p">}</span>
  <span class="k">const</span> <span class="n">InetAddress</span><span class="o">&amp;</span> <span class="n">peerAddress</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="n">peerAddr_</span><span class="p">;</span> <span class="p">}</span>
  <span class="kt">bool</span> <span class="n">connected</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span> <span class="k">return</span> <span class="n">state_</span> <span class="o">==</span> <span class="n">kConnected</span><span class="p">;</span> <span class="p">}</span>
 
  <span class="kt">void</span> <span class="n">setConnectionCallback</span><span class="p">(</span><span class="k">const</span> <span class="n">ConnectionCallback</span><span class="o">&amp;</span> <span class="n">cb</span><span class="p">)</span>
  <span class="p">{</span> <span class="n">connectionCallback_</span> <span class="o">=</span> <span class="n">cb</span><span class="p">;</span> <span class="p">}</span>
 
  <span class="kt">void</span> <span class="n">setMessageCallback</span><span class="p">(</span><span class="k">const</span> <span class="n">MessageCallback</span><span class="o">&amp;</span> <span class="n">cb</span><span class="p">)</span>
  <span class="p">{</span> <span class="n">messageCallback_</span> <span class="o">=</span> <span class="n">cb</span><span class="p">;</span> <span class="p">}</span>
 
  <span class="c1">// called when TcpServer accepts a new connection
</span><span class="c1"></span>  <span class="kt">void</span> <span class="n">connectEstablished</span><span class="p">();</span>   <span class="c1">// should be called only once
</span><span class="c1"></span> 
 <span class="k">private</span><span class="o">:</span>
  <span class="k">enum</span> <span class="n">StateE</span> <span class="p">{</span> <span class="cm">/*kDisconnected, */</span><span class="n">kConnecting</span><span class="p">,</span> <span class="n">kConnected</span><span class="cm">/*, kDisconnecting*/</span> <span class="p">};</span>
  <span class="kt">void</span> <span class="nf">handleRead</span><span class="p">(</span><span class="n">Timestamp</span> <span class="n">receiveTime</span><span class="p">);</span>
  <span class="kt">void</span> <span class="nf">setState</span><span class="p">(</span><span class="n">StateE</span> <span class="n">s</span><span class="p">)</span> <span class="p">{</span> <span class="n">state_</span> <span class="o">=</span> <span class="n">s</span><span class="p">;</span> <span class="p">}</span>
 
  <span class="n">EventLoop</span><span class="o">*</span> <span class="n">loop_</span><span class="p">;</span>         <span class="c1">// 所属EventLoop
</span><span class="c1"></span>  <span class="n">string</span> <span class="n">name_</span><span class="p">;</span>             <span class="c1">// 连接名
</span><span class="c1"></span>  <span class="cm">/*连接状态*/</span>
  <span class="n">StateE</span> <span class="n">state_</span><span class="p">;</span>  <span class="c1">// FIXME: use atomic variable
</span><span class="c1"></span>  <span class="c1">// we don&#39;t expose those classes to client.
</span><span class="c1"></span>  <span class="n">boost</span><span class="o">::</span><span class="n">scoped_ptr</span><span class="o">&lt;</span><span class="n">Socket</span><span class="o">&gt;</span> <span class="n">socket_</span><span class="p">;</span>
  <span class="n">boost</span><span class="o">::</span><span class="n">scoped_ptr</span><span class="o">&lt;</span><span class="n">Channel</span><span class="o">&gt;</span> <span class="n">channel_</span><span class="p">;</span>
  <span class="n">InetAddress</span> <span class="n">localAddr_</span><span class="p">;</span>
  <span class="n">InetAddress</span> <span class="n">peerAddr_</span><span class="p">;</span>
  <span class="cm">/*连接套接字的回调函数*/</span>
  <span class="n">ConnectionCallback</span> <span class="n">connectionCallback_</span><span class="p">;</span>
  <span class="cm">/*消息被读到应用层后的回调函数*/</span>
  <span class="n">MessageCallback</span> <span class="n">messageCallback_</span><span class="p">;</span>
<span class="p">};</span>
 
<span class="k">typedef</span> <span class="n">boost</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">TcpConnection</span><span class="o">&gt;</span> <span class="n">TcpConnectionPtr</span><span class="p">;</span>
 
<span class="p">}</span>
<span class="p">}</span>
 
<span class="cp">#endif  </span><span class="c1">// MUDUO_NET_TCPCONNECTION_H
</span></code></pre></td></tr></table>
</div>
</div>
<h3 id="tcpconnection源文件">TcpConnection源文件</h3>

<p>TcpConnection.cc</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-c++" data-lang="c++"><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c++" data-lang="c++"><span class="c1">// Copyright 2010, Shuo Chen.  All rights reserved.
</span><span class="c1">// http://code.google.com/p/muduo/
</span><span class="c1">//
</span><span class="c1">// Use of this source code is governed by a BSD-style license
</span><span class="c1">// that can be found in the License file.
</span><span class="c1"></span> 
<span class="c1">// Author: Shuo Chen (chenshuo at chenshuo dot com)
</span><span class="c1"></span> 
<span class="cp">#include</span> <span class="cpf">&lt;muduo/net/TcpConnection.h&gt;</span><span class="cp">
</span><span class="cp"></span> 
<span class="cp">#include</span> <span class="cpf">&lt;muduo/base/Logging.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;muduo/net/Channel.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;muduo/net/EventLoop.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;muduo/net/Socket.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;muduo/net/SocketsOps.h&gt;</span><span class="cp">
</span><span class="cp"></span> 
<span class="cp">#include</span> <span class="cpf">&lt;boost/bind.hpp&gt;</span><span class="cp">
</span><span class="cp"></span> 
<span class="cp">#include</span> <span class="cpf">&lt;errno.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
</span><span class="cp"></span> 
<span class="k">using</span> <span class="k">namespace</span> <span class="n">muduo</span><span class="p">;</span>
<span class="k">using</span> <span class="k">namespace</span> <span class="n">muduo</span><span class="o">::</span><span class="n">net</span><span class="p">;</span>
<span class="cm">/*
</span><span class="cm">void muduo::net::defaultConnectionCallback(const TcpConnectionPtr&amp; conn)
</span><span class="cm">{
</span><span class="cm">  LOG_TRACE &lt;&lt; conn-&gt;localAddress().toIpPort() &lt;&lt; &#34; -&gt; &#34;
</span><span class="cm">            &lt;&lt; conn-&gt;peerAddress().toIpPort() &lt;&lt; &#34; is &#34;
</span><span class="cm">            &lt;&lt; (conn-&gt;connected() ? &#34;UP&#34; : &#34;DOWN&#34;);
</span><span class="cm">}
</span><span class="cm"> 
</span><span class="cm">void muduo::net::defaultMessageCallback(const TcpConnectionPtr&amp;,
</span><span class="cm">                                        Buffer* buf,
</span><span class="cm">                                        Timestamp)
</span><span class="cm">{
</span><span class="cm">  buf-&gt;retrieveAll();
</span><span class="cm">}
</span><span class="cm">*/</span>
<span class="n">TcpConnection</span><span class="o">::</span><span class="n">TcpConnection</span><span class="p">(</span><span class="n">EventLoop</span><span class="o">*</span> <span class="n">loop</span><span class="p">,</span>
                             <span class="k">const</span> <span class="n">string</span><span class="o">&amp;</span> <span class="n">nameArg</span><span class="p">,</span>
                             <span class="kt">int</span> <span class="n">sockfd</span><span class="p">,</span>
                             <span class="k">const</span> <span class="n">InetAddress</span><span class="o">&amp;</span> <span class="n">localAddr</span><span class="p">,</span>
                             <span class="k">const</span> <span class="n">InetAddress</span><span class="o">&amp;</span> <span class="n">peerAddr</span><span class="p">)</span>
  <span class="o">:</span> <span class="n">loop_</span><span class="p">(</span><span class="n">CHECK_NOTNULL</span><span class="p">(</span><span class="n">loop</span><span class="p">)),</span>
    <span class="n">name_</span><span class="p">(</span><span class="n">nameArg</span><span class="p">),</span>
    <span class="n">state_</span><span class="p">(</span><span class="n">kConnecting</span><span class="p">),</span>
    <span class="n">socket_</span><span class="p">(</span><span class="k">new</span> <span class="n">Socket</span><span class="p">(</span><span class="n">sockfd</span><span class="p">)),</span>
    <span class="n">channel_</span><span class="p">(</span><span class="k">new</span> <span class="n">Channel</span><span class="p">(</span><span class="n">loop</span><span class="p">,</span> <span class="n">sockfd</span><span class="p">)),</span>
    <span class="n">localAddr_</span><span class="p">(</span><span class="n">localAddr</span><span class="p">),</span>
    <span class="n">peerAddr_</span><span class="p">(</span><span class="n">peerAddr</span><span class="p">)</span><span class="cm">/*,
</span><span class="cm">    highWaterMark_(64*1024*1024)*/</span>
<span class="p">{</span>
  <span class="c1">// 通道可读事件到来的时候，回调TcpConnection::handleRead，_1是事件发生时间
</span><span class="c1"></span>  <span class="n">channel_</span><span class="o">-&gt;</span><span class="n">setReadCallback</span><span class="p">(</span>
      <span class="n">boost</span><span class="o">::</span><span class="n">bind</span><span class="p">(</span><span class="o">&amp;</span><span class="n">TcpConnection</span><span class="o">::</span><span class="n">handleRead</span><span class="p">,</span> <span class="k">this</span><span class="p">,</span> <span class="n">_1</span><span class="p">));</span>
  <span class="n">LOG_DEBUG</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;TcpConnection::ctor[&#34;</span> <span class="o">&lt;&lt;</span>  <span class="n">name_</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;] at &#34;</span> <span class="o">&lt;&lt;</span> <span class="k">this</span>
            <span class="o">&lt;&lt;</span> <span class="s">&#34; fd=&#34;</span> <span class="o">&lt;&lt;</span> <span class="n">sockfd</span><span class="p">;</span>
  <span class="n">socket_</span><span class="o">-&gt;</span><span class="n">setKeepAlive</span><span class="p">(</span><span class="nb">true</span><span class="p">);</span>
<span class="p">}</span>
 
<span class="n">TcpConnection</span><span class="o">::~</span><span class="n">TcpConnection</span><span class="p">()</span>
<span class="p">{</span>
  <span class="n">LOG_DEBUG</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;TcpConnection::dtor[&#34;</span> <span class="o">&lt;&lt;</span>  <span class="n">name_</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;] at &#34;</span> <span class="o">&lt;&lt;</span> <span class="k">this</span>
            <span class="o">&lt;&lt;</span> <span class="s">&#34; fd=&#34;</span> <span class="o">&lt;&lt;</span> <span class="n">channel_</span><span class="o">-&gt;</span><span class="n">fd</span><span class="p">();</span>
<span class="p">}</span>
 
<span class="kt">void</span> <span class="n">TcpConnection</span><span class="o">::</span><span class="n">connectEstablished</span><span class="p">()</span>
<span class="p">{</span>
  <span class="c1">//断言在eventloop IO线程中
</span><span class="c1"></span>  <span class="n">loop_</span><span class="o">-&gt;</span><span class="n">assertInLoopThread</span><span class="p">();</span>
  <span class="c1">//断言还没有连接
</span><span class="c1"></span>  <span class="n">assert</span><span class="p">(</span><span class="n">state_</span> <span class="o">==</span> <span class="n">kConnecting</span><span class="p">);</span>
  <span class="n">setState</span><span class="p">(</span><span class="n">kConnected</span><span class="p">);</span>
  <span class="n">channel_</span><span class="o">-&gt;</span><span class="n">tie</span><span class="p">(</span><span class="n">shared_from_this</span><span class="p">());</span>
  <span class="cm">/*如果连接成功，则关注可读事件*/</span>
  <span class="n">channel_</span><span class="o">-&gt;</span><span class="n">enableReading</span><span class="p">();</span> <span class="c1">// TcpConnection所对应的通道加入到Poller关注
</span><span class="c1"></span> 
  <span class="n">connectionCallback_</span><span class="p">(</span><span class="n">shared_from_this</span><span class="p">());</span>
<span class="p">}</span>
 
<span class="kt">void</span> <span class="n">TcpConnection</span><span class="o">::</span><span class="n">handleRead</span><span class="p">(</span><span class="n">Timestamp</span> <span class="n">receiveTime</span><span class="p">)</span>
<span class="p">{</span>
  <span class="cm">/*
</span><span class="cm">  loop_-&gt;assertInLoopThread();
</span><span class="cm">  int savedErrno = 0;
</span><span class="cm">  ssize_t n = inputBuffer_.readFd(channel_-&gt;fd(), &amp;savedErrno);
</span><span class="cm">  if (n &gt; 0)
</span><span class="cm">  {
</span><span class="cm">    messageCallback_(shared_from_this(), &amp;inputBuffer_, receiveTime);
</span><span class="cm">  }
</span><span class="cm">  else if (n == 0)
</span><span class="cm">  {
</span><span class="cm">    handleClose();
</span><span class="cm">  }
</span><span class="cm">  else
</span><span class="cm">  {
</span><span class="cm">    errno = savedErrno;
</span><span class="cm">    LOG_SYSERR &lt;&lt; &#34;TcpConnection::handleRead&#34;;
</span><span class="cm">    handleError();
</span><span class="cm">  }
</span><span class="cm">  */</span>
  <span class="n">loop_</span><span class="o">-&gt;</span><span class="n">assertInLoopThread</span><span class="p">();</span>
  <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">65536</span><span class="p">];</span>
  <span class="n">ssize_t</span> <span class="n">n</span> <span class="o">=</span> <span class="o">::</span><span class="n">read</span><span class="p">(</span><span class="n">channel_</span><span class="o">-&gt;</span><span class="n">fd</span><span class="p">(),</span> <span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span> <span class="n">buf</span><span class="p">);</span>
  <span class="n">messageCallback_</span><span class="p">(</span><span class="n">shared_from_this</span><span class="p">(),</span> <span class="n">buf</span><span class="p">,</span> <span class="n">n</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div>
<h3 id="callback源文件">CallBack源文件</h3>

<p>CallBack.cc</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-c++" data-lang="c++"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c++" data-lang="c++"><span class="c1">// Copyright 2010, Shuo Chen.  All rights reserved.
</span><span class="c1">// http://code.google.com/p/muduo/
</span><span class="c1">//
</span><span class="c1">// Use of this source code is governed by a BSD-style license
</span><span class="c1">// that can be found in the License file.
</span><span class="c1"></span> 
<span class="c1">// Author: Shuo Chen (chenshuo at chenshuo dot com)
</span><span class="c1">//
</span><span class="c1">// This is a public header file, it must only include public header files.
</span><span class="c1"></span> 
<span class="cp">#ifndef MUDUO_NET_CALLBACKS_H
</span><span class="cp">#define MUDUO_NET_CALLBACKS_H
</span><span class="cp"></span> 
<span class="cp">#include</span> <span class="cpf">&lt;boost/function.hpp&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;boost/shared_ptr.hpp&gt;</span><span class="cp">
</span><span class="cp"></span> 
<span class="cp">#include</span> <span class="cpf">&lt;muduo/base/Timestamp.h&gt;</span><span class="cp">
</span><span class="cp"></span> 
<span class="k">namespace</span> <span class="n">muduo</span>
<span class="p">{</span>
<span class="cm">/*
</span><span class="cm">// Adapted from google-protobuf stubs/common.h
</span><span class="cm">// see License in muduo/base/Types.h
</span><span class="cm">template&lt;typename To, typename From&gt;
</span><span class="cm">inline ::boost::shared_ptr&lt;To&gt; down_pointer_cast(const ::boost::shared_ptr&lt;From&gt;&amp; f) {
</span><span class="cm">  if (false) {
</span><span class="cm">    implicit_cast&lt;From*, To*&gt;(0);
</span><span class="cm">  }
</span><span class="cm"> 
</span><span class="cm">#ifndef NDEBUG
</span><span class="cm">  assert(f == NULL || dynamic_cast&lt;To*&gt;(get_pointer(f)) != NULL);
</span><span class="cm">#endif
</span><span class="cm">  return ::boost::static_pointer_cast&lt;To&gt;(f);
</span><span class="cm">}*/</span>
 
<span class="k">namespace</span> <span class="n">net</span>
<span class="p">{</span>
 
<span class="c1">// All client visible callbacks go here.
</span><span class="c1"></span><span class="cm">/*
</span><span class="cm">class Buffer;
</span><span class="cm">*/</span>
<span class="k">class</span><span class="err"> </span><span class="nc">TcpConnection</span><span class="p">;</span>
<span class="k">typedef</span> <span class="n">boost</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">TcpConnection</span><span class="o">&gt;</span> <span class="n">TcpConnectionPtr</span><span class="p">;</span>
 
<span class="k">typedef</span> <span class="n">boost</span><span class="o">::</span><span class="n">function</span><span class="o">&lt;</span><span class="kt">void</span><span class="p">()</span><span class="o">&gt;</span> <span class="n">TimerCallback</span><span class="p">;</span>
 
<span class="k">typedef</span> <span class="n">boost</span><span class="o">::</span><span class="n">function</span><span class="o">&lt;</span><span class="kt">void</span> <span class="p">(</span><span class="k">const</span> <span class="n">TcpConnectionPtr</span><span class="o">&amp;</span><span class="p">)</span><span class="o">&gt;</span> <span class="n">ConnectionCallback</span><span class="p">;</span>
<span class="cm">/*typedef boost::function&lt;void (const TcpConnectionPtr&amp;)&gt; CloseCallback;
</span><span class="cm">typedef boost::function&lt;void (const TcpConnectionPtr&amp;)&gt; WriteCompleteCallback;
</span><span class="cm">typedef boost::function&lt;void (const TcpConnectionPtr&amp;, size_t)&gt; HighWaterMarkCallback;
</span><span class="cm"> 
</span><span class="cm">// the data has been read to (buf, len)
</span><span class="cm">typedef boost::function&lt;void (const TcpConnectionPtr&amp;,
</span><span class="cm">                              Buffer*,
</span><span class="cm">                              Timestamp)&gt; MessageCallback;
</span><span class="cm"> 
</span><span class="cm">void defaultConnectionCallback(const TcpConnectionPtr&amp; conn);
</span><span class="cm">void defaultMessageCallback(const TcpConnectionPtr&amp; conn,
</span><span class="cm">                            Buffer* buffer,
</span><span class="cm">                            Timestamp receiveTime);
</span><span class="cm">                            */</span>
<span class="k">typedef</span> <span class="n">boost</span><span class="o">::</span><span class="n">function</span><span class="o">&lt;</span><span class="kt">void</span> <span class="p">(</span><span class="k">const</span> <span class="n">TcpConnectionPtr</span><span class="o">&amp;</span><span class="p">,</span>
                              <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">data</span><span class="p">,</span>
                              <span class="n">ssize_t</span> <span class="n">len</span><span class="p">)</span><span class="o">&gt;</span> <span class="n">MessageCallback</span><span class="p">;</span>
 
<span class="p">}</span>
<span class="p">}</span>
 
<span class="cp">#endif  </span><span class="c1">// MUDUO_NET_CALLBACKS_H
</span></code></pre></td></tr></table>
</div>
</div>
<h3 id="测试程序1">测试程序1</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-c++" data-lang="c++"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c++" data-lang="c++"><span class="cp">#include</span> <span class="cpf">&lt;muduo/net/TcpServer.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;muduo/net/EventLoop.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;muduo/net/InetAddress.h&gt;</span><span class="cp">
</span><span class="cp"></span> 
<span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
</span><span class="cp"></span> 
<span class="cm">/*
</span><span class="cm"> 
</span><span class="cm">这个程序主要用来测试TcpServer、TcpConnection
</span><span class="cm">由于这里的TcpServer还没有实现关闭的事件处理，所以当对等放关闭时，服务器会一直处于高电平状态，
</span><span class="cm">也就是说会一直触发
</span><span class="cm">**/</span>
<span class="k">using</span> <span class="k">namespace</span> <span class="n">muduo</span><span class="p">;</span>
<span class="k">using</span> <span class="k">namespace</span> <span class="n">muduo</span><span class="o">::</span><span class="n">net</span><span class="p">;</span>
 
<span class="kt">void</span> <span class="nf">onConnection</span><span class="p">(</span><span class="k">const</span> <span class="n">TcpConnectionPtr</span><span class="o">&amp;</span> <span class="n">conn</span><span class="p">)</span>
<span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">connected</span><span class="p">())</span>
  <span class="p">{</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;onConnection(): new connection [%s] from %s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span>
           <span class="n">conn</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">().</span><span class="n">c_str</span><span class="p">(),</span>
           <span class="n">conn</span><span class="o">-&gt;</span><span class="n">peerAddress</span><span class="p">().</span><span class="n">toIpPort</span><span class="p">().</span><span class="n">c_str</span><span class="p">());</span>
  <span class="p">}</span>
  <span class="k">else</span>
  <span class="p">{</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;onConnection(): connection [%s] is down</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span>
           <span class="n">conn</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">().</span><span class="n">c_str</span><span class="p">());</span>
  <span class="p">}</span>
<span class="p">}</span>
 
<span class="kt">void</span> <span class="nf">onMessage</span><span class="p">(</span><span class="k">const</span> <span class="n">TcpConnectionPtr</span><span class="o">&amp;</span> <span class="n">conn</span><span class="p">,</span>
               <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">data</span><span class="p">,</span>
               <span class="n">ssize_t</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">printf</span><span class="p">(</span><span class="s">&#34;onMessage(): received %zd bytes from connection [%s]</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span>
         <span class="n">len</span><span class="p">,</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">().</span><span class="n">c_str</span><span class="p">());</span>
<span class="p">}</span>
 
<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>
<span class="p">{</span>
  <span class="n">printf</span><span class="p">(</span><span class="s">&#34;main(): pid = %d</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">getpid</span><span class="p">());</span>
 
  <span class="n">InetAddress</span> <span class="n">listenAddr</span><span class="p">(</span><span class="mi">8888</span><span class="p">);</span>
  <span class="n">EventLoop</span> <span class="n">loop</span><span class="p">;</span>
 
  <span class="n">TcpServer</span> <span class="n">server</span><span class="p">(</span><span class="o">&amp;</span><span class="n">loop</span><span class="p">,</span> <span class="n">listenAddr</span><span class="p">,</span> <span class="s">&#34;TestServer&#34;</span><span class="p">);</span>
  <span class="n">server</span><span class="p">.</span><span class="n">setConnectionCallback</span><span class="p">(</span><span class="n">onConnection</span><span class="p">);</span>
  <span class="n">server</span><span class="p">.</span><span class="n">setMessageCallback</span><span class="p">(</span><span class="n">onMessage</span><span class="p">);</span>
  <span class="n">server</span><span class="p">.</span><span class="n">start</span><span class="p">();</span>
 
  <span class="n">loop</span><span class="p">.</span><span class="n">loop</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div>
<h3 id="程序输出">程序输出:</h3>

<p>客户端</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-c++" data-lang="c++"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c++" data-lang="c++"><span class="n">aaahuiahsdui</span> <span class="n">crosoft</span> <span class="n">Telnet</span> <span class="n">Client</span>
 
<span class="o">????????</span><span class="n">haracter</span> <span class="n">is</span> <span class="err">&#39;</span><span class="n">CTRL</span><span class="o">+</span><span class="p">]</span><span class="err">&#39;</span>
<span class="n">sadasd</span>
 
<span class="n">asduhasuidhuiahsdiahsdjksdjfhsdiohahsoidoasudguagsdhjgashjdgajhksd</span>
<span class="n">as</span>
<span class="n">d</span>
<span class="n">a</span>
<span class="n">s</span>
<span class="n">d</span>
<span class="n">sad</span>
 
<span class="n">Microsoft</span> <span class="n">Telnet</span><span class="o">&gt;</span> <span class="n">quit</span>
 
<span class="nl">C</span><span class="p">:</span><span class="err">\</span><span class="n">Users</span><span class="err">\</span><span class="n">LaoHan</span><span class="o">&gt;</span>
</code></pre></td></tr></table>
</div>
</div>
<h3 id="服务器端">服务器端</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-c++" data-lang="c++"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c++" data-lang="c++"><span class="o">^</span><span class="n">Cubuntu</span><span class="err">@</span><span class="n">ubuntu</span><span class="o">-</span><span class="k">virtual</span><span class="o">-</span><span class="nl">machine</span><span class="p">:</span><span class="o">~/</span><span class="n">pro</span><span class="o">/</span><span class="mi">33</span><span class="o">/</span><span class="n">jmuduo</span><span class="err">$</span> <span class="p">..</span><span class="o">/</span><span class="n">build</span><span class="o">/</span><span class="n">debug</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">reactor_test08</span>
<span class="n">main</span><span class="p">()</span><span class="o">:</span> <span class="n">pid</span> <span class="o">=</span> <span class="mi">6066</span>
<span class="mi">20131023</span> <span class="mo">01</span><span class="o">:</span><span class="mi">08</span><span class="o">:</span><span class="mf">39.593827</span><span class="n">Z</span>  <span class="mi">6066</span> <span class="n">TRACE</span> <span class="n">updateChannel</span> <span class="n">fd</span> <span class="o">=</span> <span class="mi">4</span> <span class="n">events</span> <span class="o">=</span> <span class="mi">3</span> <span class="o">-</span> <span class="n">EPollPoller</span><span class="p">.</span><span class="nl">cc</span><span class="p">:</span><span class="mi">104</span>
<span class="mi">20131023</span> <span class="mo">01</span><span class="o">:</span><span class="mi">08</span><span class="o">:</span><span class="mf">39.594123</span><span class="n">Z</span>  <span class="mi">6066</span> <span class="n">TRACE</span> <span class="n">EventLoop</span> <span class="n">EventLoop</span> <span class="n">created</span> <span class="mh">0xBFBEBEDC</span> <span class="n">in</span> <span class="kr">thread</span> <span class="mi">6066</span> <span class="o">-</span> <span class="n">EventLoop</span><span class="p">.</span><span class="nl">cc</span><span class="p">:</span><span class="mi">62</span>
<span class="mi">20131023</span> <span class="mo">01</span><span class="o">:</span><span class="mi">08</span><span class="o">:</span><span class="mf">39.594172</span><span class="n">Z</span>  <span class="mi">6066</span> <span class="n">TRACE</span> <span class="n">updateChannel</span> <span class="n">fd</span> <span class="o">=</span> <span class="mi">5</span> <span class="n">events</span> <span class="o">=</span> <span class="mi">3</span> <span class="o">-</span> <span class="n">EPollPoller</span><span class="p">.</span><span class="nl">cc</span><span class="p">:</span><span class="mi">104</span>
<span class="mi">20131023</span> <span class="mo">01</span><span class="o">:</span><span class="mi">08</span><span class="o">:</span><span class="mf">39.594331</span><span class="n">Z</span>  <span class="mi">6066</span> <span class="n">TRACE</span> <span class="n">updateChannel</span> <span class="n">fd</span> <span class="o">=</span> <span class="mi">6</span> <span class="n">events</span> <span class="o">=</span> <span class="mi">3</span> <span class="o">-</span> <span class="n">EPollPoller</span><span class="p">.</span><span class="nl">cc</span><span class="p">:</span><span class="mi">104</span>
<span class="mi">20131023</span> <span class="mo">01</span><span class="o">:</span><span class="mi">08</span><span class="o">:</span><span class="mf">39.594387</span><span class="n">Z</span>  <span class="mi">6066</span> <span class="n">TRACE</span> <span class="n">loop</span> <span class="n">EventLoop</span> <span class="mh">0xBFBEBEDC</span> <span class="n">start</span> <span class="n">looping</span> <span class="o">-</span> <span class="n">EventLoop</span><span class="p">.</span><span class="nl">cc</span><span class="p">:</span><span class="mi">94</span>
<span class="mi">20131023</span> <span class="mo">01</span><span class="o">:</span><span class="mi">08</span><span class="o">:</span><span class="mf">43.065719</span><span class="n">Z</span>  <span class="mi">6066</span> <span class="n">TRACE</span> <span class="n">poll</span> <span class="mi">1</span> <span class="n">events</span> <span class="n">happended</span> <span class="o">-</span> <span class="n">EPollPoller</span><span class="p">.</span><span class="nl">cc</span><span class="p">:</span><span class="mi">65</span>
<span class="mi">20131023</span> <span class="mo">01</span><span class="o">:</span><span class="mi">08</span><span class="o">:</span><span class="mf">43.066560</span><span class="n">Z</span>  <span class="mi">6066</span> <span class="n">TRACE</span> <span class="n">printActiveChannels</span> <span class="p">{</span><span class="mi">6</span><span class="o">:</span> <span class="n">IN</span> <span class="p">}</span>  <span class="o">-</span> <span class="n">EventLoop</span><span class="p">.</span><span class="nl">cc</span><span class="p">:</span><span class="mi">257</span>
<span class="mi">20131023</span> <span class="mo">01</span><span class="o">:</span><span class="mi">08</span><span class="o">:</span><span class="mf">43.066665</span><span class="n">Z</span>  <span class="mi">6066</span> <span class="n">INFO</span>  <span class="n">TcpServer</span><span class="o">::</span><span class="n">newConnection</span> <span class="p">[</span><span class="n">TestServer</span><span class="p">]</span> <span class="o">-</span> <span class="k">new</span> <span class="n">connection</span> <span class="p">[</span><span class="nl">TestServer</span><span class="p">:</span><span class="mf">0.0.0.0</span><span class="o">:</span><span class="mi">8888</span><span class="cp">#1] from 172.21.95.221:50007 - TcpServer.cc:74
</span><span class="cp"></span><span class="mi">20131023</span> <span class="mo">01</span><span class="o">:</span><span class="mi">08</span><span class="o">:</span><span class="mf">43.066762</span><span class="n">Z</span>  <span class="mi">6066</span> <span class="n">DEBUG</span> <span class="n">TcpConnection</span> <span class="n">TcpConnection</span><span class="o">::</span><span class="n">ctor</span><span class="p">[</span><span class="nl">TestServer</span><span class="p">:</span><span class="mf">0.0.0.0</span><span class="o">:</span><span class="mi">8888</span><span class="cp">#1] at 0x9D80468 fd=8 - TcpConnection.cc:56
</span><span class="cp"></span><span class="mi">20131023</span> <span class="mo">01</span><span class="o">:</span><span class="mi">08</span><span class="o">:</span><span class="mf">43.066802</span><span class="n">Z</span>  <span class="mi">6066</span> <span class="n">TRACE</span> <span class="n">updateChannel</span> <span class="n">fd</span> <span class="o">=</span> <span class="mi">8</span> <span class="n">events</span> <span class="o">=</span> <span class="mi">3</span> <span class="o">-</span> <span class="n">EPollPoller</span><span class="p">.</span><span class="nl">cc</span><span class="p">:</span><span class="mi">104</span>
<span class="n">onConnection</span><span class="p">()</span><span class="o">:</span> <span class="k">new</span> <span class="n">connection</span> <span class="p">[</span><span class="nl">TestServer</span><span class="p">:</span><span class="mf">0.0.0.0</span><span class="o">:</span><span class="mi">8888</span><span class="cp">#1] from 172.21.95.221:50007
</span><span class="cp"></span><span class="mi">20131023</span> <span class="mo">01</span><span class="o">:</span><span class="mi">08</span><span class="o">:</span><span class="mf">43.845782</span><span class="n">Z</span>  <span class="mi">6066</span> <span class="n">TRACE</span> <span class="n">poll</span> <span class="mi">1</span> <span class="n">events</span> <span class="n">happended</span> <span class="o">-</span> <span class="n">EPollPoller</span><span class="p">.</span><span class="nl">cc</span><span class="p">:</span><span class="mi">65</span>
<span class="mi">20131023</span> <span class="mo">01</span><span class="o">:</span><span class="mi">08</span><span class="o">:</span><span class="mf">43.845853</span><span class="n">Z</span>  <span class="mi">6066</span> <span class="n">TRACE</span> <span class="n">printActiveChannels</span> <span class="p">{</span><span class="mi">8</span><span class="o">:</span> <span class="n">IN</span> <span class="p">}</span>  <span class="o">-</span> <span class="n">EventLoop</span><span class="p">.</span><span class="nl">cc</span><span class="p">:</span><span class="mi">257</span>
<span class="n">onMessage</span><span class="p">()</span><span class="o">:</span> <span class="n">received</span> <span class="mi">1</span> <span class="n">bytes</span> <span class="n">from</span> <span class="n">connection</span> <span class="p">[</span><span class="nl">TestServer</span><span class="p">:</span><span class="mf">0.0.0.0</span><span class="o">:</span><span class="mi">8888</span><span class="cp">#1]
</span><span class="cp"></span><span class="mi">20131023</span> <span class="mo">01</span><span class="o">:</span><span class="mi">08</span><span class="o">:</span><span class="mf">44.122627</span><span class="n">Z</span>  <span class="mi">6066</span> <span class="n">TRACE</span> <span class="n">poll</span> <span class="mi">1</span> <span class="n">events</span> <span class="n">happended</span> <span class="o">-</span> <span class="n">EPollPoller</span><span class="p">.</span><span class="nl">cc</span><span class="p">:</span><span class="mi">65</span>
<span class="mi">20131023</span> <span class="mo">01</span><span class="o">:</span><span class="mi">08</span><span class="o">:</span><span class="mf">44.122695</span><span class="n">Z</span>  <span class="mi">6066</span> <span class="n">TRACE</span> <span class="n">printActiveChannels</span> <span class="p">{</span><span class="mi">8</span><span class="o">:</span> <span class="n">IN</span> <span class="p">}</span>  <span class="o">-</span> <span class="n">EventLoop</span><span class="p">.</span><span class="nl">cc</span><span class="p">:</span><span class="mi">257</span>
<span class="n">onMessage</span><span class="p">()</span><span class="o">:</span> <span class="n">received</span> <span class="mi">1</span> <span class="n">bytes</span> <span class="n">from</span> <span class="n">connection</span> <span class="p">[</span><span class="nl">TestServer</span><span class="p">:</span><span class="mf">0.0.0.0</span><span class="o">:</span><span class="mi">8888</span><span class="cp">#1]
</span><span class="cp"></span><span class="mi">20131023</span> <span class="mo">01</span><span class="o">:</span><span class="mi">08</span><span class="o">:</span><span class="mf">44.306479</span><span class="n">Z</span>  <span class="mi">6066</span> <span class="n">TRACE</span> <span class="n">poll</span> <span class="mi">1</span> <span class="n">events</span> <span class="n">happended</span> <span class="o">-</span> <span class="n">EPollPoller</span><span class="p">.</span><span class="nl">cc</span><span class="p">:</span><span class="mi">65</span>
<span class="mi">20131023</span> <span class="mo">01</span><span class="o">:</span><span class="mi">08</span><span class="o">:</span><span class="mf">44.306545</span><span class="n">Z</span>  <span class="mi">6066</span> <span class="n">TRACE</span> <span class="n">printActiveChannels</span> <span class="p">{</span><span class="mi">8</span><span class="o">:</span> <span class="n">IN</span> <span class="p">}</span>  <span class="o">-</span> <span class="n">EventLoop</span><span class="p">.</span><span class="nl">cc</span><span class="p">:</span><span class="mi">257</span>
<span class="n">onMessage</span><span class="p">()</span><span class="o">:</span> <span class="n">received</span> <span class="mi">1</span> <span class="n">bytes</span> <span class="n">from</span> <span class="n">connection</span> <span class="p">[</span><span class="nl">TestServer</span><span class="p">:</span><span class="mf">0.0.0.0</span><span class="o">:</span><span class="mi">8888</span><span class="cp">#1]
</span><span class="cp"></span><span class="n">onMessage</span><span class="p">()</span><span class="o">:</span> <span class="n">received</span> <span class="mi">0</span> <span class="n">bytes</span> <span class="n">from</span> <span class="n">connection</span> <span class="p">[</span><span class="nl">TestServer</span><span class="p">:</span><span class="mf">0.0.0.0</span><span class="o">:</span><span class="mi">8888</span><span class="cp">#1]
</span><span class="cp"></span><span class="mi">20131023</span> <span class="mo">01</span><span class="o">:</span><span class="mi">08</span><span class="o">:</span><span class="mf">23.429136</span><span class="n">Z</span>  <span class="mi">6063</span> <span class="n">TRACE</span> <span class="n">poll</span> <span class="mi">1</span> <span class="n">events</span> <span class="n">happended</span> <span class="o">-</span> <span class="n">EPollPoller</span><span class="p">.</span><span class="nl">cc</span><span class="p">:</span><span class="mi">65</span>
<span class="mi">20131023</span> <span class="mo">01</span><span class="o">:</span><span class="mi">08</span><span class="o">:</span><span class="mf">23.429156</span><span class="n">Z</span>  <span class="mi">6063</span> <span class="n">TRACE</span> <span class="n">printActiveChannels</span> <span class="p">{</span><span class="mi">8</span><span class="o">:</span> <span class="n">IN</span> <span class="p">}</span>  <span class="o">-</span> <span class="n">EventLoop</span><span class="p">.</span><span class="nl">cc</span><span class="p">:</span><span class="mi">257</span>
<span class="n">onMessage</span><span class="p">()</span><span class="o">:</span> <span class="n">received</span> <span class="mi">0</span> <span class="n">bytes</span> <span class="n">from</span> <span class="n">connection</span> <span class="p">[</span><span class="nl">TestServer</span><span class="p">:</span><span class="mf">0.0.0.0</span><span class="o">:</span><span class="mi">8888</span><span class="cp">#1]
</span><span class="cp"></span><span class="mi">20131023</span> <span class="mo">01</span><span class="o">:</span><span class="mi">08</span><span class="o">:</span><span class="mf">23.429186</span><span class="n">Z</span>  <span class="mi">6063</span> <span class="n">TRACE</span> <span class="n">poll</span> <span class="mi">1</span> <span class="n">events</span> <span class="n">happended</span> <span class="o">-</span> <span class="n">EPollPoller</span><span class="p">.</span><span class="nl">cc</span><span class="p">:</span><span class="mi">65</span>
<span class="mi">20131023</span> <span class="mo">01</span><span class="o">:</span><span class="mi">08</span><span class="o">:</span><span class="mf">23.429205</span><span class="n">Z</span>  <span class="mi">6063</span> <span class="n">TRACE</span> <span class="n">printActiveChannels</span> <span class="p">{</span><span class="mi">8</span><span class="o">:</span> <span class="n">IN</span> <span class="p">}</span>  <span class="o">-</span> <span class="n">EventLoop</span><span class="p">.</span><span class="nl">cc</span><span class="p">:</span><span class="mi">257</span>
<span class="n">onMessage</span><span class="p">()</span><span class="o">:</span> <span class="n">received</span> <span class="mi">0</span> <span class="n">bytes</span> <span class="n">from</span> <span class="n">connection</span> <span class="p">[</span><span class="nl">TestServer</span><span class="p">:</span><span class="mf">0.0.0.0</span><span class="o">:</span><span class="mi">8888</span><span class="cp">#1]
</span><span class="cp"></span><span class="mi">20131023</span> <span class="mo">01</span><span class="o">:</span><span class="mi">08</span><span class="o">:</span><span class="mf">23.429235</span><span class="n">Z</span>  <span class="mi">6063</span> <span class="n">TRACE</span> <span class="n">poll</span> <span class="mi">1</span> <span class="n">events</span> <span class="n">happended</span> <span class="o">-</span> <span class="n">EPollPoller</span><span class="p">.</span><span class="nl">cc</span><span class="p">:</span><span class="mi">65</span>
<span class="mi">20131023</span> <span class="mo">01</span><span class="o">:</span><span class="mi">08</span><span class="o">:</span><span class="mf">23.429253</span><span class="n">Z</span>  <span class="mi">6063</span> <span class="n">TRACE</span> <span class="n">printActiveChannels</span> <span class="p">{</span><span class="mi">8</span><span class="o">:</span> <span class="n">IN</span> <span class="p">}</span>  <span class="o">-</span> <span class="n">EventLoop</span><span class="p">.</span><span class="nl">cc</span><span class="p">:</span><span class="mi">257</span>
<span class="n">onMessage</span><span class="p">()</span><span class="o">:</span> <span class="n">received</span> <span class="mi">0</span> <span class="n">bytes</span> <span class="n">from</span> <span class="n">connection</span> <span class="p">[</span><span class="nl">TestServer</span><span class="p">:</span><span class="mf">0.0.0.0</span><span class="o">:</span><span class="mi">8888</span><span class="cp">#1]
</span><span class="cp"></span><span class="mi">20131023</span> <span class="mo">01</span><span class="o">:</span><span class="mi">08</span><span class="o">:</span><span class="mf">23.429283</span><span class="n">Z</span>  <span class="mi">6063</span> <span class="n">TRACE</span> <span class="n">poll</span> <span class="mi">1</span> <span class="n">events</span> <span class="n">happended</span> <span class="o">-</span> <span class="n">EPollPoller</span><span class="p">.</span><span class="nl">cc</span><span class="p">:</span><span class="mi">65</span>
<span class="mi">20131023</span> <span class="mo">01</span><span class="o">:</span><span class="mi">08</span><span class="o">:</span><span class="mf">23.429302</span><span class="n">Z</span>  <span class="mi">6063</span> <span class="n">TRACE</span> <span class="n">printActiveChannels</span> <span class="p">{</span><span class="mi">8</span><span class="o">:</span> <span class="n">IN</span> <span class="p">}</span>  <span class="o">-</span> <span class="n">EventLoop</span><span class="p">.</span><span class="nl">cc</span><span class="p">:</span><span class="mi">257</span>
<span class="n">onMessage</span><span class="p">()</span><span class="o">:</span> <span class="n">received</span> <span class="mi">0</span> <span class="n">bytes</span> <span class="n">from</span> <span class="n">connection</span> <span class="p">[</span><span class="nl">TestServer</span><span class="p">:</span><span class="mf">0.0.0.0</span><span class="o">:</span><span class="mi">8888</span><span class="cp">#1]
</span><span class="cp"></span><span class="mi">20131023</span> <span class="mo">01</span><span class="o">:</span><span class="mi">08</span><span class="o">:</span><span class="mf">23.429332</span><span class="n">Z</span>  <span class="mi">6063</span> <span class="n">TRACE</span> <span class="n">poll</span> <span class="mi">1</span> <span class="n">events</span> <span class="n">happended</span> <span class="o">-</span> <span class="n">EPollPoller</span><span class="p">.</span><span class="nl">cc</span><span class="p">:</span><span class="mi">65</span>
<span class="mi">20131023</span> <span class="mo">01</span><span class="o">:</span><span class="mi">08</span><span class="o">:</span><span class="mf">23.429351</span><span class="n">Z</span>  <span class="mi">6063</span> <span class="n">TRACE</span> <span class="n">printActiveChannels</span> <span class="p">{</span><span class="mi">8</span><span class="o">:</span> <span class="n">IN</span> <span class="p">}</span>  <span class="o">-</span> <span class="n">EventLoop</span><span class="p">.</span><span class="nl">cc</span><span class="p">:</span><span class="mi">257</span>
<span class="n">onMessage</span><span class="p">()</span><span class="o">:</span> <span class="n">received</span> <span class="mi">0</span> <span class="n">bytes</span> <span class="n">from</span> <span class="n">connection</span> <span class="p">[</span><span class="nl">TestServer</span><span class="p">:</span><span class="mf">0.0.0.0</span><span class="o">:</span><span class="mi">8888</span><span class="cp">#1]
</span><span class="cp"></span><span class="mi">20131023</span> <span class="mo">01</span><span class="o">:</span><span class="mi">08</span><span class="o">:</span><span class="mf">23.429381</span><span class="n">Z</span>  <span class="mi">6063</span> <span class="n">TRACE</span> <span class="n">poll</span> <span class="mi">1</span> <span class="n">events</span> <span class="n">happended</span> <span class="o">-</span> <span class="n">EPollPoller</span><span class="p">.</span><span class="nl">cc</span><span class="p">:</span><span class="mi">65</span>
<span class="mi">20131023</span> <span class="mo">01</span><span class="o">:</span><span class="mi">08</span><span class="o">:</span><span class="mf">23.429399</span><span class="n">Z</span>  <span class="mi">6063</span> <span class="n">TRACE</span> <span class="n">printActiveChannels</span> <span class="p">{</span><span class="mi">8</span><span class="o">:</span> <span class="n">IN</span> <span class="p">}</span>  <span class="o">-</span> <span class="n">EventLoop</span><span class="p">.</span><span class="nl">cc</span><span class="p">:</span><span class="mi">257</span>
<span class="n">onMessage</span><span class="p">()</span><span class="o">:</span> <span class="n">received</span> <span class="mi">0</span> <span class="n">bytes</span> <span class="n">from</span> <span class="n">connection</span> <span class="p">[</span><span class="nl">TestServer</span><span class="p">:</span><span class="mf">0.0.0.0</span><span class="o">:</span><span class="mi">8888</span><span class="cp">#1]
</span><span class="cp"></span><span class="mi">20131023</span> <span class="mo">01</span><span class="o">:</span><span class="mi">08</span><span class="o">:</span><span class="mf">23.429447</span><span class="n">Z</span>  <span class="mi">6063</span> <span class="n">TRACE</span> <span class="n">poll</span> <span class="mi">1</span> <span class="n">events</span> <span class="n">happended</span> <span class="o">-</span> <span class="n">EPollPoller</span><span class="p">.</span><span class="nl">cc</span><span class="p">:</span><span class="mi">65</span>
<span class="mi">20131023</span> <span class="mo">01</span><span class="o">:</span><span class="mi">08</span><span class="o">:</span><span class="mf">23.429466</span><span class="n">Z</span>  <span class="mi">6063</span> <span class="n">TRACE</span> <span class="n">printActiveChannels</span> <span class="p">{</span><span class="mi">8</span><span class="o">:</span> <span class="n">IN</span> <span class="p">}</span>  <span class="o">-</span> <span class="n">EventLoop</span><span class="p">.</span><span class="nl">cc</span><span class="p">:</span><span class="mi">257</span>
<span class="n">onMessage</span><span class="p">()</span><span class="o">:</span> <span class="n">received</span> <span class="mi">0</span> <span class="n">bytes</span> <span class="n">from</span> <span class="n">connection</span> <span class="p">[</span><span class="nl">TestServer</span><span class="p">:</span><span class="mf">0.0.0.0</span><span class="o">:</span><span class="mi">8888</span><span class="cp">#1]
</span><span class="cp"></span><span class="mi">20131023</span> <span class="mo">01</span><span class="o">:</span><span class="mi">08</span><span class="o">:</span><span class="mf">23.429497</span><span class="n">Z</span>  <span class="mi">6063</span> <span class="n">TRACE</span> <span class="n">poll</span> <span class="mi">1</span> <span class="n">events</span> <span class="n">happended</span> <span class="o">-</span> <span class="n">EPollPoller</span><span class="p">.</span><span class="nl">cc</span><span class="p">:</span><span class="mi">65</span>
<span class="mi">20131023</span> <span class="mo">01</span><span class="o">:</span><span class="mi">08</span><span class="o">:</span><span class="mf">23.429515</span><span class="n">Z</span>  <span class="mi">6063</span> <span class="n">TRACE</span> <span class="n">printActiveChannels</span> <span class="p">{</span><span class="mi">8</span><span class="o">:</span> <span class="n">IN</span> <span class="p">}</span>  <span class="o">-</span> <span class="n">EventLoop</span><span class="p">.</span><span class="nl">cc</span><span class="p">:</span><span class="mi">257</span>
<span class="n">onMessage</span><span class="p">()</span><span class="o">:</span> <span class="n">received</span> <span class="mi">0</span> <span class="n">bytes</span> <span class="n">from</span> <span class="n">connection</span> <span class="p">[</span><span class="nl">TestServer</span><span class="p">:</span><span class="mf">0.0.0.0</span><span class="o">:</span><span class="mi">8888</span><span class="cp">#1]
</span><span class="cp"></span><span class="mi">20131023</span> <span class="mo">01</span><span class="o">:</span><span class="mi">08</span><span class="o">:</span><span class="mf">23.429545</span><span class="n">Z</span>  <span class="mi">6063</span> <span class="n">TRACE</span> <span class="n">poll</span> <span class="mi">1</span> <span class="n">events</span> <span class="n">happended</span> <span class="o">-</span> <span class="n">EPollPoller</span><span class="p">.</span><span class="nl">cc</span><span class="p">:</span><span class="mi">65</span>
</code></pre></td></tr></table>
</div>
</div>
<h3 id="测试程序2">测试程序2</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-c++" data-lang="c++"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c++" data-lang="c++"><span class="cp">#include</span> <span class="cpf">&lt;muduo/net/TcpServer.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;muduo/net/EventLoop.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;muduo/net/InetAddress.h&gt;</span><span class="cp">
</span><span class="cp"></span> 
<span class="cp">#include</span> <span class="cpf">&lt;boost/bind.hpp&gt;</span><span class="cp">
</span><span class="cp"></span> 
<span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
</span><span class="cp"></span> 
<span class="k">using</span> <span class="k">namespace</span> <span class="n">muduo</span><span class="p">;</span>
<span class="k">using</span> <span class="k">namespace</span> <span class="n">muduo</span><span class="o">::</span><span class="n">net</span><span class="p">;</span>
 
<span class="k">class</span><span class="err"> </span><span class="nc">TestServer</span>
<span class="p">{</span>
 <span class="k">public</span><span class="o">:</span>
  <span class="n">TestServer</span><span class="p">(</span><span class="n">EventLoop</span><span class="o">*</span> <span class="n">loop</span><span class="p">,</span>
             <span class="k">const</span> <span class="n">InetAddress</span><span class="o">&amp;</span> <span class="n">listenAddr</span><span class="p">)</span>
    <span class="o">:</span> <span class="n">loop_</span><span class="p">(</span><span class="n">loop</span><span class="p">),</span>
      <span class="n">server_</span><span class="p">(</span><span class="n">loop</span><span class="p">,</span> <span class="n">listenAddr</span><span class="p">,</span> <span class="s">&#34;TestServer&#34;</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">server_</span><span class="p">.</span><span class="n">setConnectionCallback</span><span class="p">(</span>
        <span class="n">boost</span><span class="o">::</span><span class="n">bind</span><span class="p">(</span><span class="o">&amp;</span><span class="n">TestServer</span><span class="o">::</span><span class="n">onConnection</span><span class="p">,</span> <span class="k">this</span><span class="p">,</span> <span class="n">_1</span><span class="p">));</span>
    <span class="n">server_</span><span class="p">.</span><span class="n">setMessageCallback</span><span class="p">(</span>
        <span class="n">boost</span><span class="o">::</span><span class="n">bind</span><span class="p">(</span><span class="o">&amp;</span><span class="n">TestServer</span><span class="o">::</span><span class="n">onMessage</span><span class="p">,</span> <span class="k">this</span><span class="p">,</span> <span class="n">_1</span><span class="p">,</span> <span class="n">_2</span><span class="p">,</span> <span class="n">_3</span><span class="p">));</span>
  <span class="p">}</span>
 
  <span class="kt">void</span> <span class="n">start</span><span class="p">()</span>
  <span class="p">{</span>
      <span class="n">server_</span><span class="p">.</span><span class="n">start</span><span class="p">();</span>
  <span class="p">}</span>
 
 <span class="k">private</span><span class="o">:</span>
  <span class="kt">void</span> <span class="n">onConnection</span><span class="p">(</span><span class="k">const</span> <span class="n">TcpConnectionPtr</span><span class="o">&amp;</span> <span class="n">conn</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">connected</span><span class="p">())</span>
    <span class="p">{</span>
      <span class="n">printf</span><span class="p">(</span><span class="s">&#34;onConnection(): new connection [%s] from %s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span>
             <span class="n">conn</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">().</span><span class="n">c_str</span><span class="p">(),</span>
             <span class="n">conn</span><span class="o">-&gt;</span><span class="n">peerAddress</span><span class="p">().</span><span class="n">toIpPort</span><span class="p">().</span><span class="n">c_str</span><span class="p">());</span>
    <span class="p">}</span>
    <span class="k">else</span>
    <span class="p">{</span>
      <span class="n">printf</span><span class="p">(</span><span class="s">&#34;onConnection(): connection [%s] is down</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span>
             <span class="n">conn</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">().</span><span class="n">c_str</span><span class="p">());</span>
    <span class="p">}</span>
  <span class="p">}</span>
 
  <span class="kt">void</span> <span class="n">onMessage</span><span class="p">(</span><span class="k">const</span> <span class="n">TcpConnectionPtr</span><span class="o">&amp;</span> <span class="n">conn</span><span class="p">,</span>
                   <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">data</span><span class="p">,</span>
                   <span class="n">ssize_t</span> <span class="n">len</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;onMessage(): received %zd bytes from connection [%s]</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span>
           <span class="n">len</span><span class="p">,</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">().</span><span class="n">c_str</span><span class="p">());</span>
  <span class="p">}</span>
 
  <span class="n">EventLoop</span><span class="o">*</span> <span class="n">loop_</span><span class="p">;</span>
  <span class="n">TcpServer</span> <span class="n">server_</span><span class="p">;</span>
<span class="p">};</span>
<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>
<span class="p">{</span>
  <span class="n">printf</span><span class="p">(</span><span class="s">&#34;main(): pid = %d</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">getpid</span><span class="p">());</span>
 
  <span class="n">InetAddress</span> <span class="n">listenAddr</span><span class="p">(</span><span class="mi">8888</span><span class="p">);</span>
  <span class="n">EventLoop</span> <span class="n">loop</span><span class="p">;</span>
 
  <span class="n">TestServer</span> <span class="n">server</span><span class="p">(</span><span class="o">&amp;</span><span class="n">loop</span><span class="p">,</span> <span class="n">listenAddr</span><span class="p">);</span>
  <span class="n">server</span><span class="p">.</span><span class="n">start</span><span class="p">();</span>
 
  <span class="n">loop</span><span class="p">.</span><span class="n">loop</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div>
<h2 id="35-1-multiple-reactors">[35-1] multiple reactors</h2>

<p><center> <img src="http://laohanlinux.github.io/images/img/blog/muduo-base-library-2/multipilereactors.png" alt="" /> </center></p>

<ul>
<li><code>muduo</code>库如何支持多线程</li>
<li><code>EventLoopThread</code>（<code>IO</code>线程类）</li>
<li><code>EventLoopThreadPool</code>（<code>IO</code>线程池类）</li>
<li><code>IO</code>线程池的功能是开启若干个<code>IO</code>线程，并让这些<code>IO</code>线程处于事件循环的状态</li>
</ul>

<p>下面的这些代码可能和前面给出的源代码有些不一样，阅读的同学请注意了</p>

<h3 id="eventloopthreadpool-头文件"><code>EventLoopThreadPool</code>头文件</h3>

<p>eventloopthreadpool.h</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-c++" data-lang="c++"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c++" data-lang="c++"><span class="c1">// Copyright 2010, Shuo Chen.  All rights reserved.
</span><span class="c1">// http://code.google.com/p/muduo/
</span><span class="c1">//
</span><span class="c1">// Use of this source code is governed by a BSD-style license
</span><span class="c1">// that can be found in the License file.
</span><span class="c1"></span> 
<span class="c1">// Author: Shuo Chen (chenshuo at chenshuo dot com)
</span><span class="c1">//
</span><span class="c1">// This is an internal header file, you should not include this.
</span><span class="c1"></span> 
<span class="cp">#ifndef MUDUO_NET_EVENTLOOPTHREADPOOL_H
</span><span class="cp">#define MUDUO_NET_EVENTLOOPTHREADPOOL_H
</span><span class="cp"></span> 
<span class="cp">#include</span> <span class="cpf">&lt;muduo/base/Condition.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;muduo/base/Mutex.h&gt;</span><span class="cp">
</span><span class="cp"></span> 
<span class="cp">#include</span> <span class="cpf">&lt;vector&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;boost/function.hpp&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;boost/noncopyable.hpp&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;boost/ptr_container/ptr_vector.hpp&gt;</span><span class="cp">
</span><span class="cp"></span> 
<span class="k">namespace</span> <span class="n">muduo</span>
<span class="p">{</span>
 
<span class="k">namespace</span> <span class="n">net</span>
<span class="p">{</span>
 
<span class="k">class</span><span class="err"> </span><span class="nc">EventLoop</span><span class="p">;</span>
<span class="k">class</span><span class="err"> </span><span class="nc">EventLoopThread</span><span class="p">;</span>
 
<span class="k">class</span><span class="err"> </span><span class="nc">EventLoopThreadPool</span> <span class="o">:</span> <span class="n">boost</span><span class="o">::</span><span class="n">noncopyable</span>
<span class="p">{</span>
 <span class="k">public</span><span class="o">:</span>
  <span class="k">typedef</span> <span class="n">boost</span><span class="o">::</span><span class="n">function</span><span class="o">&lt;</span><span class="kt">void</span><span class="p">(</span><span class="n">EventLoop</span><span class="o">*</span><span class="p">)</span><span class="o">&gt;</span> <span class="n">ThreadInitCallback</span><span class="p">;</span>
 
  <span class="n">EventLoopThreadPool</span><span class="p">(</span><span class="n">EventLoop</span><span class="o">*</span> <span class="n">baseLoop</span><span class="p">);</span>
  <span class="o">~</span><span class="n">EventLoopThreadPool</span><span class="p">();</span>
  <span class="kt">void</span> <span class="nf">setThreadNum</span><span class="p">(</span><span class="kt">int</span> <span class="n">numThreads</span><span class="p">)</span> <span class="p">{</span> <span class="n">numThreads_</span> <span class="o">=</span> <span class="n">numThreads</span><span class="p">;</span> <span class="p">}</span>
  <span class="kt">void</span> <span class="nf">start</span><span class="p">(</span><span class="k">const</span> <span class="n">ThreadInitCallback</span><span class="o">&amp;</span> <span class="n">cb</span> <span class="o">=</span> <span class="n">ThreadInitCallback</span><span class="p">());</span>
  <span class="n">EventLoop</span><span class="o">*</span> <span class="nf">getNextLoop</span><span class="p">();</span>
 
 <span class="k">private</span><span class="o">:</span>
 
  <span class="n">EventLoop</span><span class="o">*</span> <span class="n">baseLoop_</span><span class="p">;</span> <span class="c1">// 与Acceptor所属EventLoop相同
</span><span class="c1"></span>  <span class="kt">bool</span> <span class="n">started_</span><span class="p">;</span>        <span class="cm">/*是否启动*/</span>
  <span class="kt">int</span> <span class="n">numThreads_</span><span class="p">;</span>      <span class="c1">// 线程数
</span><span class="c1"></span>  <span class="kt">int</span> <span class="n">next_</span><span class="p">;</span>            <span class="c1">// 新连接到来，所选择的EventLoop对象下标
</span><span class="c1"></span>  <span class="n">boost</span><span class="o">::</span><span class="n">ptr_vector</span><span class="o">&lt;</span><span class="n">EventLoopThread</span><span class="o">&gt;</span> <span class="n">threads_</span><span class="p">;</span>        <span class="c1">// IO线程列表
</span><span class="c1"></span>  <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">EventLoop</span><span class="o">*&gt;</span> <span class="n">loops_</span><span class="p">;</span>                 <span class="c1">// EventLoop列表
</span><span class="c1"></span><span class="p">};</span>
 
<span class="p">}</span>
<span class="p">}</span>
 
<span class="cp">#endif  </span><span class="c1">// MUDUO_NET_EVENTLOOPTHREADPOOL_H
</span></code></pre></td></tr></table>
</div>
</div>
<h3 id="eventloopthreadpool源文件">EventLoopThreadPool源文件</h3>

<p>eventloopthreadpool.cc</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-c++" data-lang="c++"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c++" data-lang="c++"><span class="c1">// Copyright 2010, Shuo Chen.  All rights reserved.
</span><span class="c1">// http://code.google.com/p/muduo/
</span><span class="c1">//
</span><span class="c1">// Use of this source code is governed by a BSD-style license
</span><span class="c1">// that can be found in the License file.
</span><span class="c1"></span> 
<span class="c1">// Author: Shuo Chen (chenshuo at chenshuo dot com)
</span><span class="c1"></span> 
<span class="cp">#include</span> <span class="cpf">&lt;muduo/net/EventLoopThreadPool.h&gt;</span><span class="cp">
</span><span class="cp"></span> 
<span class="cp">#include</span> <span class="cpf">&lt;muduo/net/EventLoop.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;muduo/net/EventLoopThread.h&gt;</span><span class="cp">
</span><span class="cp"></span> 
<span class="cp">#include</span> <span class="cpf">&lt;boost/bind.hpp&gt;</span><span class="cp">
</span><span class="cp"></span> 
<span class="k">using</span> <span class="k">namespace</span> <span class="n">muduo</span><span class="p">;</span>
<span class="k">using</span> <span class="k">namespace</span> <span class="n">muduo</span><span class="o">::</span><span class="n">net</span><span class="p">;</span>
 
 
<span class="n">EventLoopThreadPool</span><span class="o">::</span><span class="n">EventLoopThreadPool</span><span class="p">(</span><span class="n">EventLoop</span><span class="o">*</span> <span class="n">baseLoop</span><span class="p">)</span>
  <span class="o">:</span> <span class="n">baseLoop_</span><span class="p">(</span><span class="n">baseLoop</span><span class="p">),</span>  <span class="c1">// 与Acceptor所属EventLoop相同
</span><span class="c1"></span>    <span class="n">started_</span><span class="p">(</span><span class="nb">false</span><span class="p">),</span>
    <span class="n">numThreads_</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
    <span class="n">next_</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>
 
<span class="n">EventLoopThreadPool</span><span class="o">::~</span><span class="n">EventLoopThreadPool</span><span class="p">()</span>
<span class="p">{</span>
  <span class="c1">// Don&#39;t delete loop, it&#39;s stack variable
</span><span class="c1"></span><span class="p">}</span>
<span class="cm">/*每个线程初始化时的回调函数cb*/</span>
<span class="kt">void</span> <span class="n">EventLoopThreadPool</span><span class="o">::</span><span class="n">start</span><span class="p">(</span><span class="k">const</span> <span class="n">ThreadInitCallback</span><span class="o">&amp;</span> <span class="n">cb</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">assert</span><span class="p">(</span><span class="o">!</span><span class="n">started_</span><span class="p">);</span>
  <span class="n">baseLoop_</span><span class="o">-&gt;</span><span class="n">assertInLoopThread</span><span class="p">();</span>
 
  <span class="n">started_</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
 
  <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">numThreads_</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">EventLoopThread</span><span class="o">*</span> <span class="n">t</span> <span class="o">=</span> <span class="k">new</span> <span class="n">EventLoopThread</span><span class="p">(</span><span class="n">cb</span><span class="p">);</span>
    <span class="n">threads_</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">t</span><span class="p">);</span>
    <span class="n">loops_</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">startLoop</span><span class="p">());</span>    <span class="c1">// 启动EventLoopThread线程，在进入事件循环之前，会调用cb
</span><span class="c1"></span>  <span class="p">}</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">numThreads_</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">cb</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="c1">// 只有一个EventLoop，在这个EventLoop进入事件循环之前，调用cb
</span><span class="c1"></span>    <span class="n">cb</span><span class="p">(</span><span class="n">baseLoop_</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>
 
<span class="n">EventLoop</span><span class="o">*</span> <span class="n">EventLoopThreadPool</span><span class="o">::</span><span class="n">getNextLoop</span><span class="p">()</span>
<span class="p">{</span>
  <span class="n">baseLoop_</span><span class="o">-&gt;</span><span class="n">assertInLoopThread</span><span class="p">();</span>
  <span class="n">EventLoop</span><span class="o">*</span> <span class="n">loop</span> <span class="o">=</span> <span class="n">baseLoop_</span><span class="p">;</span>
 
  <span class="c1">// 如果loops_为空，则loop指向baseLoop_
</span><span class="c1"></span>  <span class="c1">// 如果不为空，按照round-robin（RR，轮叫）的调度方式选择一个EventLoop
</span><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">loops_</span><span class="p">.</span><span class="n">empty</span><span class="p">())</span>
  <span class="p">{</span>
    <span class="c1">// round-robin
</span><span class="c1"></span>    <span class="n">loop</span> <span class="o">=</span> <span class="n">loops_</span><span class="p">[</span><span class="n">next_</span><span class="p">];</span>
    <span class="o">++</span><span class="n">next_</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">implicit_cast</span><span class="o">&lt;</span><span class="n">size_t</span><span class="o">&gt;</span><span class="p">(</span><span class="n">next_</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">loops_</span><span class="p">.</span><span class="n">size</span><span class="p">())</span>
    <span class="p">{</span>
      <span class="n">next_</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="n">loop</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div>
<h3 id="tcpserver头文件-1">TcpServer头文件</h3>

<p>TcpServer.h</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-c++" data-lang="c++"><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c++" data-lang="c++"><span class="c1">// Copyright 2010, Shuo Chen.  All rights reserved.
</span><span class="c1">// http://code.google.com/p/muduo/
</span><span class="c1">//
</span><span class="c1">// Use of this source code is governed by a BSD-style license
</span><span class="c1">// that can be found in the License file.
</span><span class="c1"></span> 
<span class="c1">// Author: Shuo Chen (chenshuo at chenshuo dot com)
</span><span class="c1">//
</span><span class="c1">// This is a public header file, it must only include public header files.
</span><span class="c1"></span> 
<span class="cp">#ifndef MUDUO_NET_TCPSERVER_H
</span><span class="cp">#define MUDUO_NET_TCPSERVER_H
</span><span class="cp"></span> 
<span class="cp">#include</span> <span class="cpf">&lt;muduo/base/Types.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;muduo/net/TcpConnection.h&gt;</span><span class="cp">
</span><span class="cp"></span> 
<span class="cp">#include</span> <span class="cpf">&lt;map&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;boost/noncopyable.hpp&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;boost/scoped_ptr.hpp&gt;</span><span class="cp">
</span><span class="cp"></span> 
<span class="k">namespace</span> <span class="n">muduo</span>
<span class="p">{</span>
<span class="k">namespace</span> <span class="n">net</span>
<span class="p">{</span>
 
<span class="k">class</span><span class="err"> </span><span class="nc">Acceptor</span><span class="p">;</span>
<span class="k">class</span><span class="err"> </span><span class="nc">EventLoop</span><span class="p">;</span>
<span class="k">class</span><span class="err"> </span><span class="nc">EventLoopThreadPool</span><span class="p">;</span>
 
<span class="c1">///
</span><span class="c1">/// TCP server, supports single-threaded and thread-pool models.
</span><span class="c1">///
</span><span class="c1">/// This is an interface class, so don&#39;t expose too much details.
</span><span class="c1"></span><span class="k">class</span><span class="err"> </span><span class="nc">TcpServer</span> <span class="o">:</span> <span class="n">boost</span><span class="o">::</span><span class="n">noncopyable</span>
<span class="p">{</span>
 <span class="k">public</span><span class="o">:</span>
  <span class="k">typedef</span> <span class="n">boost</span><span class="o">::</span><span class="n">function</span><span class="o">&lt;</span><span class="kt">void</span><span class="p">(</span><span class="n">EventLoop</span><span class="o">*</span><span class="p">)</span><span class="o">&gt;</span> <span class="n">ThreadInitCallback</span><span class="p">;</span>
 
  <span class="c1">//TcpServer(EventLoop* loop, const InetAddress&amp; listenAddr);
</span><span class="c1"></span>  <span class="n">TcpServer</span><span class="p">(</span><span class="n">EventLoop</span><span class="o">*</span> <span class="n">loop</span><span class="p">,</span>
            <span class="k">const</span> <span class="n">InetAddress</span><span class="o">&amp;</span> <span class="n">listenAddr</span><span class="p">,</span>
            <span class="k">const</span> <span class="n">string</span><span class="o">&amp;</span> <span class="n">nameArg</span><span class="p">);</span>
  <span class="o">~</span><span class="n">TcpServer</span><span class="p">();</span>  <span class="c1">// force out-line dtor, for scoped_ptr members.
</span><span class="c1"></span> 
  <span class="k">const</span> <span class="n">string</span><span class="o">&amp;</span> <span class="n">hostport</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span> <span class="k">return</span> <span class="n">hostport_</span><span class="p">;</span> <span class="p">}</span>
  <span class="k">const</span> <span class="n">string</span><span class="o">&amp;</span> <span class="n">name</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span> <span class="k">return</span> <span class="n">name_</span><span class="p">;</span> <span class="p">}</span>
 
  <span class="c1">/// Set the number of threads for handling input.
</span><span class="c1"></span>  <span class="c1">///
</span><span class="c1"></span>  <span class="c1">/// Always accepts new connection in loop&#39;s thread.
</span><span class="c1"></span>  <span class="c1">/// Must be called before @c start
</span><span class="c1"></span>  <span class="c1">/// @param numThreads
</span><span class="c1"></span>  <span class="c1">/// - 0 means all I/O in loop&#39;s thread, no thread will created.
</span><span class="c1"></span>  <span class="c1">///   this is the default value.
</span><span class="c1"></span>  <span class="c1">/// - 1 means all I/O in another thread.
</span><span class="c1"></span>  <span class="c1">/// - N means a thread pool with N threads, new connections
</span><span class="c1"></span>  <span class="c1">///   are assigned on a round-robin basis.
</span><span class="c1"></span>  <span class="kt">void</span> <span class="n">setThreadNum</span><span class="p">(</span><span class="kt">int</span> <span class="n">numThreads</span><span class="p">);</span>
  <span class="kt">void</span> <span class="nf">setThreadInitCallback</span><span class="p">(</span><span class="k">const</span> <span class="n">ThreadInitCallback</span><span class="o">&amp;</span> <span class="n">cb</span><span class="p">)</span>
  <span class="p">{</span> <span class="n">threadInitCallback_</span> <span class="o">=</span> <span class="n">cb</span><span class="p">;</span> <span class="p">}</span>
 
  <span class="c1">/// Starts the server if it&#39;s not listenning.
</span><span class="c1"></span>  <span class="c1">///
</span><span class="c1"></span>  <span class="c1">/// It&#39;s harmless to call it multiple times.
</span><span class="c1"></span>  <span class="c1">/// Thread safe.
</span><span class="c1"></span>  <span class="kt">void</span> <span class="nf">start</span><span class="p">();</span>
 
  <span class="c1">/// Set connection callback.
</span><span class="c1"></span>  <span class="c1">/// Not thread safe.
</span><span class="c1"></span>  <span class="c1">// 设置连接到来或者连接关闭回调函数
</span><span class="c1"></span>  <span class="kt">void</span> <span class="nf">setConnectionCallback</span><span class="p">(</span><span class="k">const</span> <span class="n">ConnectionCallback</span><span class="o">&amp;</span> <span class="n">cb</span><span class="p">)</span>
  <span class="p">{</span> <span class="n">connectionCallback_</span> <span class="o">=</span> <span class="n">cb</span><span class="p">;</span> <span class="p">}</span>
 
  <span class="c1">/// Set message callback.
</span><span class="c1"></span>  <span class="c1">/// Not thread safe.
</span><span class="c1"></span>  <span class="c1">// 设置消息到来回调函数
</span><span class="c1"></span>  <span class="kt">void</span> <span class="nf">setMessageCallback</span><span class="p">(</span><span class="k">const</span> <span class="n">MessageCallback</span><span class="o">&amp;</span> <span class="n">cb</span><span class="p">)</span>
  <span class="p">{</span> <span class="n">messageCallback_</span> <span class="o">=</span> <span class="n">cb</span><span class="p">;</span> <span class="p">}</span>
 
 
 <span class="k">private</span><span class="o">:</span>
  <span class="c1">/// Not thread safe, but in loop
</span><span class="c1"></span>  <span class="kt">void</span> <span class="n">newConnection</span><span class="p">(</span><span class="kt">int</span> <span class="n">sockfd</span><span class="p">,</span> <span class="k">const</span> <span class="n">InetAddress</span><span class="o">&amp;</span> <span class="n">peerAddr</span><span class="p">);</span>
  <span class="c1">/// Thread safe.
</span><span class="c1"></span>  <span class="kt">void</span> <span class="nf">removeConnection</span><span class="p">(</span><span class="k">const</span> <span class="n">TcpConnectionPtr</span><span class="o">&amp;</span> <span class="n">conn</span><span class="p">);</span>
  <span class="c1">/// Not thread safe, but in loop
</span><span class="c1"></span>  <span class="kt">void</span> <span class="nf">removeConnectionInLoop</span><span class="p">(</span><span class="k">const</span> <span class="n">TcpConnectionPtr</span><span class="o">&amp;</span> <span class="n">conn</span><span class="p">);</span>
 
  <span class="k">typedef</span> <span class="n">std</span><span class="o">::</span><span class="n">map</span><span class="o">&lt;</span><span class="n">string</span><span class="p">,</span> <span class="n">TcpConnectionPtr</span><span class="o">&gt;</span> <span class="n">ConnectionMap</span><span class="p">;</span>
 
  <span class="n">EventLoop</span><span class="o">*</span> <span class="n">loop_</span><span class="p">;</span>  <span class="c1">// the acceptor loop
</span><span class="c1"></span>  <span class="k">const</span> <span class="n">string</span> <span class="n">hostport_</span><span class="p">;</span>       <span class="c1">// 服务端口
</span><span class="c1"></span>  <span class="k">const</span> <span class="n">string</span> <span class="n">name_</span><span class="p">;</span>           <span class="c1">// 服务名
</span><span class="c1"></span>  <span class="n">boost</span><span class="o">::</span><span class="n">scoped_ptr</span><span class="o">&lt;</span><span class="n">Acceptor</span><span class="o">&gt;</span> <span class="n">acceptor_</span><span class="p">;</span> <span class="c1">// avoid revealing Acceptor
</span><span class="c1"></span>  <span class="n">boost</span><span class="o">::</span><span class="n">scoped_ptr</span><span class="o">&lt;</span><span class="n">EventLoopThreadPool</span><span class="o">&gt;</span> <span class="n">threadPool_</span><span class="p">;</span> <span class="c1">//线程池
</span><span class="c1"></span>  <span class="n">ConnectionCallback</span> <span class="n">connectionCallback_</span><span class="p">;</span>
  <span class="n">MessageCallback</span> <span class="n">messageCallback_</span><span class="p">;</span>
  <span class="n">ThreadInitCallback</span> <span class="n">threadInitCallback_</span><span class="p">;</span>   <span class="c1">// IO线程池中的线程在进入事件循环前，会回调用此函数
</span><span class="c1"></span>  <span class="kt">bool</span> <span class="n">started_</span><span class="p">;</span>
  <span class="c1">// always in loop thread
</span><span class="c1"></span>  <span class="kt">int</span> <span class="n">nextConnId_</span><span class="p">;</span>              <span class="c1">// 下一个连接ID
</span><span class="c1"></span>  <span class="n">ConnectionMap</span> <span class="n">connections_</span><span class="p">;</span>   <span class="c1">// 连接列表
</span><span class="c1"></span><span class="p">};</span>
 
<span class="p">}</span>
<span class="p">}</span>
 
<span class="cp">#endif  </span><span class="c1">// MUDUO_NET_TCPSERVER_H
</span></code></pre></td></tr></table>
</div>
</div>
<h3 id="tcpserver源文件-1">TcpServer源文件</h3>

<p>TcpServer.cc</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-c++" data-lang="c++"><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c++" data-lang="c++"><span class="c1">// Copyright 2010, Shuo Chen.  All rights reserved.
</span><span class="c1">// http://code.google.com/p/muduo/
</span><span class="c1">//
</span><span class="c1">// Use of this source code is governed by a BSD-style license
</span><span class="c1">// that can be found in the License file.
</span><span class="c1"></span> 
<span class="c1">// Author: Shuo Chen (chenshuo at chenshuo dot com)
</span><span class="c1"></span> 
<span class="cp">#include</span> <span class="cpf">&lt;muduo/net/TcpServer.h&gt;</span><span class="cp">
</span><span class="cp"></span> 
<span class="cp">#include</span> <span class="cpf">&lt;muduo/base/Logging.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;muduo/net/Acceptor.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;muduo/net/EventLoop.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;muduo/net/EventLoopThreadPool.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;muduo/net/SocketsOps.h&gt;</span><span class="cp">
</span><span class="cp"></span> 
<span class="cp">#include</span> <span class="cpf">&lt;boost/bind.hpp&gt;</span><span class="cp">
</span><span class="cp"></span> 
<span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;  // snprintf</span><span class="cp">
</span><span class="cp"></span> 
<span class="k">using</span> <span class="k">namespace</span> <span class="n">muduo</span><span class="p">;</span>
<span class="k">using</span> <span class="k">namespace</span> <span class="n">muduo</span><span class="o">::</span><span class="n">net</span><span class="p">;</span>
 
<span class="n">TcpServer</span><span class="o">::</span><span class="n">TcpServer</span><span class="p">(</span><span class="n">EventLoop</span><span class="o">*</span> <span class="n">loop</span><span class="p">,</span> <span class="cm">/*这是main reactor*/</span>
                     <span class="k">const</span> <span class="n">InetAddress</span><span class="o">&amp;</span> <span class="n">listenAddr</span><span class="p">,</span>
                     <span class="k">const</span> <span class="n">string</span><span class="o">&amp;</span> <span class="n">nameArg</span><span class="p">)</span>
  <span class="o">:</span> <span class="n">loop_</span><span class="p">(</span><span class="n">CHECK_NOTNULL</span><span class="p">(</span><span class="n">loop</span><span class="p">)),</span>
    <span class="n">hostport_</span><span class="p">(</span><span class="n">listenAddr</span><span class="p">.</span><span class="n">toIpPort</span><span class="p">()),</span>
    <span class="n">name_</span><span class="p">(</span><span class="n">nameArg</span><span class="p">),</span>
    <span class="n">acceptor_</span><span class="p">(</span><span class="k">new</span> <span class="n">Acceptor</span><span class="p">(</span><span class="n">loop</span><span class="p">,</span> <span class="n">listenAddr</span><span class="p">)),</span>
    <span class="n">threadPool_</span><span class="p">(</span><span class="k">new</span> <span class="n">EventLoopThreadPool</span><span class="p">(</span><span class="n">loop</span><span class="p">)),</span>
    <span class="cm">/*connectionCallback_(defaultConnectionCallback),
</span><span class="cm">    messageCallback_(defaultMessageCallback),*/</span>
    <span class="n">started_</span><span class="p">(</span><span class="nb">false</span><span class="p">),</span>
    <span class="n">nextConnId_</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="p">{</span>
  <span class="c1">// Acceptor::handleRead函数中会回调用TcpServer::newConnection
</span><span class="c1"></span>  <span class="c1">// _1对应的是socket文件描述符，_2对应的是对等方的地址(InetAddress)
</span><span class="c1"></span>  <span class="n">acceptor_</span><span class="o">-&gt;</span><span class="n">setNewConnectionCallback</span><span class="p">(</span>
      <span class="n">boost</span><span class="o">::</span><span class="n">bind</span><span class="p">(</span><span class="o">&amp;</span><span class="n">TcpServer</span><span class="o">::</span><span class="n">newConnection</span><span class="p">,</span> <span class="k">this</span><span class="p">,</span> <span class="n">_1</span><span class="p">,</span> <span class="n">_2</span><span class="p">));</span>
<span class="p">}</span>
 
<span class="n">TcpServer</span><span class="o">::~</span><span class="n">TcpServer</span><span class="p">()</span>
<span class="p">{</span>
  <span class="n">loop_</span><span class="o">-&gt;</span><span class="n">assertInLoopThread</span><span class="p">();</span>
  <span class="n">LOG_TRACE</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;TcpServer::~TcpServer [&#34;</span> <span class="o">&lt;&lt;</span> <span class="n">name_</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;] destructing&#34;</span><span class="p">;</span>
 
  <span class="k">for</span> <span class="p">(</span><span class="n">ConnectionMap</span><span class="o">::</span><span class="n">iterator</span> <span class="n">it</span><span class="p">(</span><span class="n">connections_</span><span class="p">.</span><span class="n">begin</span><span class="p">());</span>
      <span class="n">it</span> <span class="o">!=</span> <span class="n">connections_</span><span class="p">.</span><span class="n">end</span><span class="p">();</span> <span class="o">++</span><span class="n">it</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">TcpConnectionPtr</span> <span class="n">conn</span> <span class="o">=</span> <span class="n">it</span><span class="o">-&gt;</span><span class="n">second</span><span class="p">;</span>
    <span class="n">it</span><span class="o">-&gt;</span><span class="n">second</span><span class="p">.</span><span class="n">reset</span><span class="p">();</span>      <span class="c1">// 释放当前所控制的对象，引用计数减一
</span><span class="c1"></span>    <span class="n">conn</span><span class="o">-&gt;</span><span class="n">getLoop</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">runInLoop</span><span class="p">(</span>
      <span class="n">boost</span><span class="o">::</span><span class="n">bind</span><span class="p">(</span><span class="o">&amp;</span><span class="n">TcpConnection</span><span class="o">::</span><span class="n">connectDestroyed</span><span class="p">,</span> <span class="n">conn</span><span class="p">));</span>
    <span class="n">conn</span><span class="p">.</span><span class="n">reset</span><span class="p">();</span>           <span class="c1">// 释放当前所控制的对象，引用计数减一
</span><span class="c1"></span>  <span class="p">}</span>
<span class="p">}</span>
 
<span class="kt">void</span> <span class="n">TcpServer</span><span class="o">::</span><span class="n">setThreadNum</span><span class="p">(</span><span class="kt">int</span> <span class="n">numThreads</span><span class="p">)</span>
<span class="p">{</span>
  <span class="cm">/*numThreads不包含main reactor thread*/</span>
  <span class="n">assert</span><span class="p">(</span><span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">numThreads</span><span class="p">);</span>
  <span class="n">threadPool_</span><span class="o">-&gt;</span><span class="n">setThreadNum</span><span class="p">(</span><span class="n">numThreads</span><span class="p">);</span>
<span class="p">}</span>
 
<span class="c1">// 该函数多次调用是无害的
</span><span class="c1">// 该函数可以跨线程调用
</span><span class="c1"></span><span class="kt">void</span> <span class="n">TcpServer</span><span class="o">::</span><span class="n">start</span><span class="p">()</span>
<span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">started_</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">started_</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
    <span class="cm">/*启动线程池*/</span>
    <span class="n">threadPool_</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">(</span><span class="n">threadInitCallback_</span><span class="p">);</span>
  <span class="p">}</span>
 
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">acceptor_</span><span class="o">-&gt;</span><span class="n">listenning</span><span class="p">())</span>
  <span class="p">{</span>
    <span class="c1">// get_pointer返回原生指针
</span><span class="c1"></span>    <span class="n">loop_</span><span class="o">-&gt;</span><span class="n">runInLoop</span><span class="p">(</span>
        <span class="n">boost</span><span class="o">::</span><span class="n">bind</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Acceptor</span><span class="o">::</span><span class="n">listen</span><span class="p">,</span> <span class="n">get_pointer</span><span class="p">(</span><span class="n">acceptor_</span><span class="p">)));</span>
  <span class="p">}</span>
<span class="p">}</span>
 
<span class="kt">void</span> <span class="n">TcpServer</span><span class="o">::</span><span class="n">newConnection</span><span class="p">(</span><span class="kt">int</span> <span class="n">sockfd</span><span class="p">,</span> <span class="k">const</span> <span class="n">InetAddress</span><span class="o">&amp;</span> <span class="n">peerAddr</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">loop_</span><span class="o">-&gt;</span><span class="n">assertInLoopThread</span><span class="p">();</span>
  <span class="c1">// 按照轮叫的方式选择一个EventLoop
</span><span class="c1"></span>  <span class="n">EventLoop</span><span class="o">*</span> <span class="n">ioLoop</span> <span class="o">=</span> <span class="n">threadPool_</span><span class="o">-&gt;</span><span class="n">getNextLoop</span><span class="p">();</span>
  <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>
  <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span> <span class="n">buf</span><span class="p">,</span> <span class="s">&#34;:%s#%d&#34;</span><span class="p">,</span> <span class="n">hostport_</span><span class="p">.</span><span class="n">c_str</span><span class="p">(),</span> <span class="n">nextConnId_</span><span class="p">);</span>
  <span class="o">++</span><span class="n">nextConnId_</span><span class="p">;</span>
  <span class="n">string</span> <span class="n">connName</span> <span class="o">=</span> <span class="n">name_</span> <span class="o">+</span> <span class="n">buf</span><span class="p">;</span>
 
  <span class="n">LOG_INFO</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;TcpServer::newConnection [&#34;</span> <span class="o">&lt;&lt;</span> <span class="n">name_</span>
           <span class="o">&lt;&lt;</span> <span class="s">&#34;] - new connection [&#34;</span> <span class="o">&lt;&lt;</span> <span class="n">connName</span>
           <span class="o">&lt;&lt;</span> <span class="s">&#34;] from &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">peerAddr</span><span class="p">.</span><span class="n">toIpPort</span><span class="p">();</span>
  <span class="n">InetAddress</span> <span class="nf">localAddr</span><span class="p">(</span><span class="n">sockets</span><span class="o">::</span><span class="n">getLocalAddr</span><span class="p">(</span><span class="n">sockfd</span><span class="p">));</span>
  <span class="c1">// FIXME poll with zero timeout to double confirm the new connection
</span><span class="c1"></span>  <span class="c1">// FIXME use make_shared if necessary
</span><span class="c1"></span>  <span class="cm">/*TcpConnectionPtr conn(new TcpConnection(loop_,
</span><span class="cm">                                          connName,
</span><span class="cm">                                          sockfd,
</span><span class="cm">                                          localAddr,
</span><span class="cm">                                          peerAddr));*/</span>
 
  <span class="n">TcpConnectionPtr</span> <span class="nf">conn</span><span class="p">(</span><span class="k">new</span> <span class="n">TcpConnection</span><span class="p">(</span><span class="n">ioLoop</span><span class="p">,</span>
                                          <span class="n">connName</span><span class="p">,</span>
                                          <span class="n">sockfd</span><span class="p">,</span>
                                          <span class="n">localAddr</span><span class="p">,</span>
                                          <span class="n">peerAddr</span><span class="p">));</span>
 
  <span class="n">LOG_TRACE</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;[1] usecount=&#34;</span> <span class="o">&lt;&lt;</span> <span class="n">conn</span><span class="p">.</span><span class="n">use_count</span><span class="p">();</span>
  <span class="n">connections_</span><span class="p">[</span><span class="n">connName</span><span class="p">]</span> <span class="o">=</span> <span class="n">conn</span><span class="p">;</span>
  <span class="n">LOG_TRACE</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;[2] usecount=&#34;</span> <span class="o">&lt;&lt;</span> <span class="n">conn</span><span class="p">.</span><span class="n">use_count</span><span class="p">();</span>
  <span class="n">conn</span><span class="o">-&gt;</span><span class="n">setConnectionCallback</span><span class="p">(</span><span class="n">connectionCallback_</span><span class="p">);</span>
  <span class="n">conn</span><span class="o">-&gt;</span><span class="n">setMessageCallback</span><span class="p">(</span><span class="n">messageCallback_</span><span class="p">);</span>
 
  <span class="n">conn</span><span class="o">-&gt;</span><span class="n">setCloseCallback</span><span class="p">(</span>
      <span class="n">boost</span><span class="o">::</span><span class="n">bind</span><span class="p">(</span><span class="o">&amp;</span><span class="n">TcpServer</span><span class="o">::</span><span class="n">removeConnection</span><span class="p">,</span> <span class="k">this</span><span class="p">,</span> <span class="n">_1</span><span class="p">));</span>
 
  <span class="c1">// conn-&gt;connectEstablished(); 这个表示直接在当前线程中调用
</span><span class="c1"></span>  <span class="n">ioLoop</span><span class="o">-&gt;</span><span class="n">runInLoop</span><span class="p">(</span><span class="n">boost</span><span class="o">::</span><span class="n">bind</span><span class="p">(</span><span class="o">&amp;</span><span class="n">TcpConnection</span><span class="o">::</span><span class="n">connectEstablished</span><span class="p">,</span> <span class="n">conn</span><span class="p">));</span>
  <span class="n">LOG_TRACE</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;[5] usecount=&#34;</span> <span class="o">&lt;&lt;</span> <span class="n">conn</span><span class="p">.</span><span class="n">use_count</span><span class="p">();</span>
 
<span class="p">}</span>
 
<span class="kt">void</span> <span class="n">TcpServer</span><span class="o">::</span><span class="n">removeConnection</span><span class="p">(</span><span class="k">const</span> <span class="n">TcpConnectionPtr</span><span class="o">&amp;</span> <span class="n">conn</span><span class="p">)</span>
<span class="p">{</span>
    <span class="cm">/*
</span><span class="cm">  loop_-&gt;assertInLoopThread();
</span><span class="cm">  LOG_INFO &lt;&lt; &#34;TcpServer::removeConnectionInLoop [&#34; &lt;&lt; name_
</span><span class="cm">           &lt;&lt; &#34;] - connection &#34; &lt;&lt; conn-&gt;name();
</span><span class="cm"> 
</span><span class="cm"> 
</span><span class="cm">  LOG_TRACE &lt;&lt; &#34;[8] usecount=&#34; &lt;&lt; conn.use_count();
</span><span class="cm">  size_t n = connections_.erase(conn-&gt;name());
</span><span class="cm">  LOG_TRACE &lt;&lt; &#34;[9] usecount=&#34; &lt;&lt; conn.use_count();
</span><span class="cm"> 
</span><span class="cm">  (void)n;
</span><span class="cm">  assert(n == 1);
</span><span class="cm"> 
</span><span class="cm">  loop_-&gt;queueInLoop(
</span><span class="cm">      boost::bind(&amp;TcpConnection::connectDestroyed, conn));
</span><span class="cm">  LOG_TRACE &lt;&lt; &#34;[10] usecount=&#34; &lt;&lt; conn.use_count();
</span><span class="cm">  */</span>
 
  <span class="n">loop_</span><span class="o">-&gt;</span><span class="n">runInLoop</span><span class="p">(</span><span class="n">boost</span><span class="o">::</span><span class="n">bind</span><span class="p">(</span><span class="o">&amp;</span><span class="n">TcpServer</span><span class="o">::</span><span class="n">removeConnectionInLoop</span><span class="p">,</span> <span class="k">this</span><span class="p">,</span> <span class="n">conn</span><span class="p">));</span>
 
<span class="p">}</span>
 
<span class="kt">void</span> <span class="n">TcpServer</span><span class="o">::</span><span class="n">removeConnectionInLoop</span><span class="p">(</span><span class="k">const</span> <span class="n">TcpConnectionPtr</span><span class="o">&amp;</span> <span class="n">conn</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">loop_</span><span class="o">-&gt;</span><span class="n">assertInLoopThread</span><span class="p">();</span>
  <span class="n">LOG_INFO</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;TcpServer::removeConnectionInLoop [&#34;</span> <span class="o">&lt;&lt;</span> <span class="n">name_</span>
           <span class="o">&lt;&lt;</span> <span class="s">&#34;] - connection &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">();</span>
 
 
  <span class="n">LOG_TRACE</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;[8] usecount=&#34;</span> <span class="o">&lt;&lt;</span> <span class="n">conn</span><span class="p">.</span><span class="n">use_count</span><span class="p">();</span>
  <span class="n">size_t</span> <span class="n">n</span> <span class="o">=</span> <span class="n">connections_</span><span class="p">.</span><span class="n">erase</span><span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">());</span>
  <span class="n">LOG_TRACE</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;[9] usecount=&#34;</span> <span class="o">&lt;&lt;</span> <span class="n">conn</span><span class="p">.</span><span class="n">use_count</span><span class="p">();</span>
 
  <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">n</span><span class="p">;</span>
  <span class="n">assert</span><span class="p">(</span><span class="n">n</span> <span class="o">==</span> <span class="mi">1</span><span class="p">);</span>
 
  <span class="n">EventLoop</span><span class="o">*</span> <span class="n">ioLoop</span> <span class="o">=</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">getLoop</span><span class="p">();</span>
  <span class="n">ioLoop</span><span class="o">-&gt;</span><span class="n">queueInLoop</span><span class="p">(</span>
      <span class="n">boost</span><span class="o">::</span><span class="n">bind</span><span class="p">(</span><span class="o">&amp;</span><span class="n">TcpConnection</span><span class="o">::</span><span class="n">connectDestroyed</span><span class="p">,</span> <span class="n">conn</span><span class="p">));</span>
 
  <span class="c1">//loop_-&gt;queueInLoop(
</span><span class="c1"></span>  <span class="c1">//    boost::bind(&amp;TcpConnection::connectDestroyed, conn));
</span><span class="c1"></span>  <span class="n">LOG_TRACE</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;[10] usecount=&#34;</span> <span class="o">&lt;&lt;</span> <span class="n">conn</span><span class="p">.</span><span class="n">use_count</span><span class="p">();</span> 
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div>
<h3 id="测试程序">测试程序</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-c++" data-lang="c++"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c++" data-lang="c++"><span class="cp">#include</span> <span class="cpf">&lt;muduo/net/TcpServer.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;muduo/net/EventLoop.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;muduo/net/InetAddress.h&gt;</span><span class="cp">
</span><span class="cp"></span> 
<span class="cp">#include</span> <span class="cpf">&lt;boost/bind.hpp&gt;</span><span class="cp">
</span><span class="cp"></span> 
<span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
</span><span class="cp"></span> 
<span class="k">using</span> <span class="k">namespace</span> <span class="n">muduo</span><span class="p">;</span>
<span class="k">using</span> <span class="k">namespace</span> <span class="n">muduo</span><span class="o">::</span><span class="n">net</span><span class="p">;</span>
 
<span class="k">class</span><span class="err"> </span><span class="nc">TestServer</span>
<span class="p">{</span>
 <span class="k">public</span><span class="o">:</span>
  <span class="n">TestServer</span><span class="p">(</span><span class="n">EventLoop</span><span class="o">*</span> <span class="n">loop</span><span class="p">,</span>
             <span class="k">const</span> <span class="n">InetAddress</span><span class="o">&amp;</span> <span class="n">listenAddr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">numThreads</span><span class="p">)</span>
    <span class="o">:</span> <span class="n">loop_</span><span class="p">(</span><span class="n">loop</span><span class="p">),</span>
      <span class="n">server_</span><span class="p">(</span><span class="n">loop</span><span class="p">,</span> <span class="n">listenAddr</span><span class="p">,</span> <span class="s">&#34;TestServer&#34;</span><span class="p">),</span>
      <span class="n">numThreads_</span><span class="p">(</span><span class="n">numThreads</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">server_</span><span class="p">.</span><span class="n">setConnectionCallback</span><span class="p">(</span>
        <span class="n">boost</span><span class="o">::</span><span class="n">bind</span><span class="p">(</span><span class="o">&amp;</span><span class="n">TestServer</span><span class="o">::</span><span class="n">onConnection</span><span class="p">,</span> <span class="k">this</span><span class="p">,</span> <span class="n">_1</span><span class="p">));</span>
    <span class="n">server_</span><span class="p">.</span><span class="n">setMessageCallback</span><span class="p">(</span>
        <span class="n">boost</span><span class="o">::</span><span class="n">bind</span><span class="p">(</span><span class="o">&amp;</span><span class="n">TestServer</span><span class="o">::</span><span class="n">onMessage</span><span class="p">,</span> <span class="k">this</span><span class="p">,</span> <span class="n">_1</span><span class="p">,</span> <span class="n">_2</span><span class="p">,</span> <span class="n">_3</span><span class="p">));</span>
    <span class="n">server_</span><span class="p">.</span><span class="n">setThreadNum</span><span class="p">(</span><span class="n">numThreads</span><span class="p">);</span>
  <span class="p">}</span>
 
  <span class="kt">void</span> <span class="n">start</span><span class="p">()</span>
  <span class="p">{</span>
      <span class="n">server_</span><span class="p">.</span><span class="n">start</span><span class="p">();</span>
  <span class="p">}</span>
 
 <span class="k">private</span><span class="o">:</span>
  <span class="kt">void</span> <span class="n">onConnection</span><span class="p">(</span><span class="k">const</span> <span class="n">TcpConnectionPtr</span><span class="o">&amp;</span> <span class="n">conn</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">connected</span><span class="p">())</span>
    <span class="p">{</span>
      <span class="n">printf</span><span class="p">(</span><span class="s">&#34;onConnection(): new connection [%s] from %s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span>
             <span class="n">conn</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">().</span><span class="n">c_str</span><span class="p">(),</span>
             <span class="n">conn</span><span class="o">-&gt;</span><span class="n">peerAddress</span><span class="p">().</span><span class="n">toIpPort</span><span class="p">().</span><span class="n">c_str</span><span class="p">());</span>
    <span class="p">}</span>
    <span class="k">else</span>
    <span class="p">{</span>
      <span class="n">printf</span><span class="p">(</span><span class="s">&#34;onConnection(): connection [%s] is down</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span>
             <span class="n">conn</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">().</span><span class="n">c_str</span><span class="p">());</span>
    <span class="p">}</span>
  <span class="p">}</span>
 
  <span class="kt">void</span> <span class="n">onMessage</span><span class="p">(</span><span class="k">const</span> <span class="n">TcpConnectionPtr</span><span class="o">&amp;</span> <span class="n">conn</span><span class="p">,</span>
                   <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">data</span><span class="p">,</span>
                   <span class="n">ssize_t</span> <span class="n">len</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;onMessage(): received %zd bytes from connection [%s]</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span>
           <span class="n">len</span><span class="p">,</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">().</span><span class="n">c_str</span><span class="p">());</span>
  <span class="p">}</span>
 
  <span class="n">EventLoop</span><span class="o">*</span> <span class="n">loop_</span><span class="p">;</span>
  <span class="n">TcpServer</span> <span class="n">server_</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">numThreads_</span><span class="p">;</span>
<span class="p">};</span>
 
 
<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>
<span class="p">{</span>
  <span class="n">printf</span><span class="p">(</span><span class="s">&#34;main(): pid = %d</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">getpid</span><span class="p">());</span>
 
  <span class="n">InetAddress</span> <span class="n">listenAddr</span><span class="p">(</span><span class="mi">8888</span><span class="p">);</span>
  <span class="n">EventLoop</span> <span class="n">loop</span><span class="p">;</span>
 
  <span class="n">TestServer</span> <span class="n">server</span><span class="p">(</span><span class="o">&amp;</span><span class="n">loop</span><span class="p">,</span> <span class="n">listenAddr</span><span class="p">,</span><span class="mi">4</span><span class="p">);</span>
  <span class="n">server</span><span class="p">.</span><span class="n">start</span><span class="p">();</span>
 
  <span class="n">loop</span><span class="p">.</span><span class="n">loop</span><span class="p">();</span>
<span class="p">}</span>

   <span class="k">return</span> <span class="n">n</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div>
<h2 id="35-2-文件描述符的分析">[35-2] 文件描述符的分析</h2>

<h3 id="code">code</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-c++" data-lang="c++"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c++" data-lang="c++"><span class="cp">#include</span> <span class="cpf">&lt;muduo/net/TcpServer.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;muduo/net/EventLoop.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;muduo/net/InetAddress.h&gt;</span><span class="cp">
</span><span class="cp"></span> 
<span class="cp">#include</span> <span class="cpf">&lt;boost/bind.hpp&gt;</span><span class="cp">
</span><span class="cp"></span> 
<span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
</span><span class="cp"></span> 
<span class="k">using</span> <span class="k">namespace</span> <span class="n">muduo</span><span class="p">;</span>
<span class="k">using</span> <span class="k">namespace</span> <span class="n">muduo</span><span class="o">::</span><span class="n">net</span><span class="p">;</span>
 
<span class="k">class</span><span class="err"> </span><span class="nc">TestServer</span>
<span class="p">{</span>
 <span class="k">public</span><span class="o">:</span>
  <span class="n">TestServer</span><span class="p">(</span><span class="n">EventLoop</span><span class="o">*</span> <span class="n">loop</span><span class="p">,</span>
             <span class="k">const</span> <span class="n">InetAddress</span><span class="o">&amp;</span> <span class="n">listenAddr</span><span class="p">)</span>
    <span class="o">:</span> <span class="n">loop_</span><span class="p">(</span><span class="n">loop</span><span class="p">),</span>
      <span class="n">server_</span><span class="p">(</span><span class="n">loop</span><span class="p">,</span> <span class="n">listenAddr</span><span class="p">,</span> <span class="s">&#34;TestServer&#34;</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">server_</span><span class="p">.</span><span class="n">setConnectionCallback</span><span class="p">(</span>
        <span class="n">boost</span><span class="o">::</span><span class="n">bind</span><span class="p">(</span><span class="o">&amp;</span><span class="n">TestServer</span><span class="o">::</span><span class="n">onConnection</span><span class="p">,</span> <span class="k">this</span><span class="p">,</span> <span class="n">_1</span><span class="p">));</span>
    <span class="n">server_</span><span class="p">.</span><span class="n">setMessageCallback</span><span class="p">(</span>
        <span class="n">boost</span><span class="o">::</span><span class="n">bind</span><span class="p">(</span><span class="o">&amp;</span><span class="n">TestServer</span><span class="o">::</span><span class="n">onMessage</span><span class="p">,</span> <span class="k">this</span><span class="p">,</span> <span class="n">_1</span><span class="p">,</span> <span class="n">_2</span><span class="p">,</span> <span class="n">_3</span><span class="p">));</span>
  <span class="p">}</span>
 
  <span class="kt">void</span> <span class="n">start</span><span class="p">()</span>
  <span class="p">{</span>
      <span class="n">server_</span><span class="p">.</span><span class="n">start</span><span class="p">();</span>
  <span class="p">}</span>
 
 <span class="k">private</span><span class="o">:</span>
  <span class="kt">void</span> <span class="n">onConnection</span><span class="p">(</span><span class="k">const</span> <span class="n">TcpConnectionPtr</span><span class="o">&amp;</span> <span class="n">conn</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">connected</span><span class="p">())</span>
    <span class="p">{</span>
      <span class="n">printf</span><span class="p">(</span><span class="s">&#34;onConnection(): new connection [%s] from %s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span>
             <span class="n">conn</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">().</span><span class="n">c_str</span><span class="p">(),</span>
             <span class="n">conn</span><span class="o">-&gt;</span><span class="n">peerAddress</span><span class="p">().</span><span class="n">toIpPort</span><span class="p">().</span><span class="n">c_str</span><span class="p">());</span>
    <span class="p">}</span>
    <span class="k">else</span>
    <span class="p">{</span>
      <span class="n">printf</span><span class="p">(</span><span class="s">&#34;onConnection(): connection [%s] is down</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span>
             <span class="n">conn</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">().</span><span class="n">c_str</span><span class="p">());</span>
    <span class="p">}</span>
  <span class="p">}</span>
 
  <span class="kt">void</span> <span class="n">onMessage</span><span class="p">(</span><span class="k">const</span> <span class="n">TcpConnectionPtr</span><span class="o">&amp;</span> <span class="n">conn</span><span class="p">,</span>
                   <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">data</span><span class="p">,</span>
                   <span class="n">ssize_t</span> <span class="n">len</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;onMessage(): received %zd bytes from connection [%s]</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span>
           <span class="n">len</span><span class="p">,</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">().</span><span class="n">c_str</span><span class="p">());</span>
  <span class="p">}</span>
 
  <span class="n">EventLoop</span><span class="o">*</span> <span class="n">loop_</span><span class="p">;</span>
  <span class="n">TcpServer</span> <span class="n">server_</span><span class="p">;</span>
<span class="p">};</span>
 
 
<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>
<span class="p">{</span>
  <span class="n">printf</span><span class="p">(</span><span class="s">&#34;main(): pid = %d</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">getpid</span><span class="p">());</span>
 
  <span class="n">InetAddress</span> <span class="n">listenAddr</span><span class="p">(</span><span class="mi">8888</span><span class="p">);</span>
  <span class="n">EventLoop</span> <span class="n">loop</span><span class="p">;</span>
 
  <span class="n">TestServer</span> <span class="n">server</span><span class="p">(</span><span class="o">&amp;</span><span class="n">loop</span><span class="p">,</span> <span class="n">listenAddr</span><span class="p">);</span>
  <span class="n">server</span><span class="p">.</span><span class="n">start</span><span class="p">();</span>
 
  <span class="n">loop</span><span class="p">.</span><span class="n">loop</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div>
<h3 id="分析结果">分析结果</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-c++" data-lang="c++"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c++" data-lang="c++"><span class="mi">0</span> <span class="err">，</span> <span class="mi">1</span>  <span class="err">，</span><span class="mi">2</span> <span class="err">进程默认打开</span>
<span class="mi">3</span> <span class="n">EpollerFd</span>
<span class="mi">4</span> <span class="n">timerFd</span>
<span class="mi">5</span> <span class="n">wakeupFd</span>
<span class="mi">6</span> <span class="n">listenFd</span>
<span class="mi">7</span> <span class="n">idleFd</span>
 
<span class="n">ubuntu</span><span class="err">@</span><span class="n">ubuntu</span><span class="o">-</span><span class="k">virtual</span><span class="o">-</span><span class="nl">machine</span><span class="p">:</span><span class="o">~/</span><span class="n">pro</span><span class="o">/</span><span class="mi">35</span><span class="err">$</span> <span class="p">.</span><span class="o">/</span><span class="n">build</span><span class="o">/</span><span class="n">debug</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">reactor_test09</span>
<span class="n">main</span><span class="p">()</span><span class="o">:</span> <span class="n">pid</span> <span class="o">=</span> <span class="mi">10797</span>
<span class="mi">20131023</span> <span class="mi">08</span><span class="o">:</span><span class="mo">05</span><span class="o">:</span><span class="mf">04.423104</span><span class="n">Z</span> <span class="mi">10797</span> <span class="n">TRACE</span> <span class="n">updateChannel</span> <span class="n">fd</span> <span class="o">=</span> <span class="mi">4</span> <span class="n">events</span> <span class="o">=</span> <span class="mi">3</span> <span class="o">-</span> <span class="n">EPollPoller</span><span class="p">.</span><span class="nl">cc</span><span class="p">:</span><span class="mi">104</span>
<span class="mi">20131023</span> <span class="mi">08</span><span class="o">:</span><span class="mo">05</span><span class="o">:</span><span class="mf">04.423413</span><span class="n">Z</span> <span class="mi">10797</span> <span class="n">TRACE</span> <span class="n">EventLoop</span> <span class="n">EventLoop</span> <span class="n">created</span> <span class="mh">0xBF97AAB4</span> <span class="n">in</span> <span class="kr">thread</span> <span class="mi">10797</span> <span class="o">-</span> <span class="n">EventLoop</span><span class="p">.</span><span class="nl">cc</span><span class="p">:</span><span class="mi">62</span>
<span class="mi">20131023</span> <span class="mi">08</span><span class="o">:</span><span class="mo">05</span><span class="o">:</span><span class="mf">04.423489</span><span class="n">Z</span> <span class="mi">10797</span> <span class="n">TRACE</span> <span class="n">updateChannel</span> <span class="n">fd</span> <span class="o">=</span> <span class="mi">5</span> <span class="n">events</span> <span class="o">=</span> <span class="mi">3</span> <span class="o">-</span> <span class="n">EPollPoller</span><span class="p">.</span><span class="nl">cc</span><span class="p">:</span><span class="mi">104</span>
<span class="mi">20131023</span> <span class="mi">08</span><span class="o">:</span><span class="mo">05</span><span class="o">:</span><span class="mf">04.423883</span><span class="n">Z</span> <span class="mi">10797</span> <span class="n">TRACE</span> <span class="n">updateChannel</span> <span class="n">fd</span> <span class="o">=</span> <span class="mi">6</span> <span class="n">events</span> <span class="o">=</span> <span class="mi">3</span> <span class="o">-</span> <span class="n">EPollPoller</span><span class="p">.</span><span class="nl">cc</span><span class="p">:</span><span class="mi">104</span>
<span class="mi">20131023</span> <span class="mi">08</span><span class="o">:</span><span class="mo">05</span><span class="o">:</span><span class="mf">04.423968</span><span class="n">Z</span> <span class="mi">10797</span> <span class="n">TRACE</span> <span class="n">loop</span> <span class="n">EventLoop</span> <span class="mh">0xBF97AAB4</span> <span class="n">start</span> <span class="n">looping</span> <span class="o">-</span> <span class="n">EventLoop</span><span class="p">.</span><span class="nl">cc</span><span class="p">:</span><span class="mi">94</span>
<span class="mi">20131023</span> <span class="mi">08</span><span class="o">:</span><span class="mo">05</span><span class="o">:</span><span class="mf">13.376959</span><span class="n">Z</span> <span class="mi">10797</span> <span class="n">TRACE</span> <span class="n">poll</span> <span class="mi">1</span> <span class="n">events</span> <span class="n">happended</span> <span class="o">-</span> <span class="n">EPollPoller</span><span class="p">.</span><span class="nl">cc</span><span class="p">:</span><span class="mi">65</span>
<span class="mi">20131023</span> <span class="mi">08</span><span class="o">:</span><span class="mo">05</span><span class="o">:</span><span class="mf">13.377558</span><span class="n">Z</span> <span class="mi">10797</span> <span class="n">TRACE</span> <span class="n">printActiveChannels</span> <span class="p">{</span><span class="mi">6</span><span class="o">:</span> <span class="n">IN</span> <span class="p">}</span>  <span class="o">-</span> <span class="n">EventLoop</span><span class="p">.</span><span class="nl">cc</span><span class="p">:</span><span class="mi">257</span><span class="o">-----</span><span class="err">》》有连接到来</span>
<span class="mi">20131023</span> <span class="mi">08</span><span class="o">:</span><span class="mo">05</span><span class="o">:</span><span class="mf">13.377681</span><span class="n">Z</span> <span class="mi">10797</span> <span class="n">INFO</span>  <span class="n">TcpServer</span><span class="o">::</span><span class="n">newConnection</span> <span class="p">[</span><span class="n">TestServer</span><span class="p">]</span> <span class="o">-</span> <span class="k">new</span> <span class="n">connection</span> <span class="p">[</span><span class="nl">TestServer</span><span class="p">:</span><span class="mf">0.0.0.0</span><span class="o">:</span><span class="mi">8888</span><span class="cp">#1] from 127.0.0.1:57756 - TcpServer.cc:93
</span><span class="cp"></span><span class="mi">20131023</span> <span class="mi">08</span><span class="o">:</span><span class="mo">05</span><span class="o">:</span><span class="mf">13.377719</span><span class="n">Z</span> <span class="mi">10797</span> <span class="n">DEBUG</span> <span class="n">TcpConnection</span> <span class="n">TcpConnection</span><span class="o">::</span><span class="n">ctor</span><span class="p">[</span><span class="nl">TestServer</span><span class="p">:</span><span class="mf">0.0.0.0</span><span class="o">:</span><span class="mi">8888</span><span class="cp">#1] at 0x8BB3490 fd=8 - TcpConnection.cc:62-------》》已连接的套接字
</span><span class="cp"></span><span class="mi">20131023</span> <span class="mi">08</span><span class="o">:</span><span class="mo">05</span><span class="o">:</span><span class="mf">13.377746</span><span class="n">Z</span> <span class="mi">10797</span> <span class="n">TRACE</span> <span class="n">newConnection</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="n">usecount</span><span class="o">=</span><span class="mi">1</span> <span class="o">-</span> <span class="n">TcpServer</span><span class="p">.</span><span class="nl">cc</span><span class="p">:</span><span class="mi">111</span>
<span class="mi">20131023</span> <span class="mi">08</span><span class="o">:</span><span class="mo">05</span><span class="o">:</span><span class="mf">13.377772</span><span class="n">Z</span> <span class="mi">10797</span> <span class="n">TRACE</span> <span class="n">newConnection</span> <span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="n">usecount</span><span class="o">=</span><span class="mi">2</span> <span class="o">-</span> <span class="n">TcpServer</span><span class="p">.</span><span class="nl">cc</span><span class="p">:</span><span class="mi">113</span>
<span class="mi">20131023</span> <span class="mi">08</span><span class="o">:</span><span class="mo">05</span><span class="o">:</span><span class="mf">13.377819</span><span class="n">Z</span> <span class="mi">10797</span> <span class="n">TRACE</span> <span class="n">connectEstablished</span> <span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="n">usecount</span><span class="o">=</span><span class="mi">6</span> <span class="o">-</span> <span class="n">TcpConnection</span><span class="p">.</span><span class="nl">cc</span><span class="p">:</span><span class="mi">78</span>
<span class="mi">20131023</span> <span class="mi">08</span><span class="o">:</span><span class="mo">05</span><span class="o">:</span><span class="mf">13.377846</span><span class="n">Z</span> <span class="mi">10797</span> <span class="n">TRACE</span> <span class="n">updateChannel</span> <span class="n">fd</span> <span class="o">=</span> <span class="mi">8</span> <span class="n">events</span> <span class="o">=</span> <span class="mi">3</span> <span class="o">-</span> <span class="n">EPollPoller</span><span class="p">.</span><span class="nl">cc</span><span class="p">:</span><span class="mi">104</span>
<span class="n">onConnection</span><span class="p">()</span><span class="o">:</span> <span class="k">new</span> <span class="n">connection</span> <span class="p">[</span><span class="nl">TestServer</span><span class="p">:</span><span class="mf">0.0.0.0</span><span class="o">:</span><span class="mi">8888</span><span class="cp">#1] from 127.0.0.1:57756
</span><span class="cp"></span><span class="mi">20131023</span> <span class="mi">08</span><span class="o">:</span><span class="mo">05</span><span class="o">:</span><span class="mf">13.377902</span><span class="n">Z</span> <span class="mi">10797</span> <span class="n">TRACE</span> <span class="n">connectEstablished</span> <span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="n">usecount</span><span class="o">=</span><span class="mi">6</span> <span class="o">-</span> <span class="n">TcpConnection</span><span class="p">.</span><span class="nl">cc</span><span class="p">:</span><span class="mi">83</span>
<span class="mi">20131023</span> <span class="mi">08</span><span class="o">:</span><span class="mo">05</span><span class="o">:</span><span class="mf">13.377915</span><span class="n">Z</span> <span class="mi">10797</span> <span class="n">TRACE</span> <span class="n">newConnection</span> <span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="n">usecount</span><span class="o">=</span><span class="mi">2</span> <span class="o">-</span> <span class="n">TcpServer</span><span class="p">.</span><span class="nl">cc</span><span class="p">:</span><span class="mi">122</span>
<span class="mi">20131023</span> <span class="mi">08</span><span class="o">:</span><span class="mo">05</span><span class="o">:</span><span class="mf">23.388224</span><span class="n">Z</span> <span class="mi">10797</span> <span class="n">TRACE</span> <span class="n">poll</span>  <span class="n">nothing</span> <span class="n">happended</span> <span class="o">-</span> <span class="n">EPollPoller</span><span class="p">.</span><span class="nl">cc</span><span class="p">:</span><span class="mi">74</span>
<span class="mi">20131023</span> <span class="mi">08</span><span class="o">:</span><span class="mo">05</span><span class="o">:</span><span class="mf">32.910851</span><span class="n">Z</span> <span class="mi">10797</span> <span class="n">TRACE</span> <span class="n">poll</span> <span class="mi">1</span> <span class="n">events</span> <span class="n">happended</span> <span class="o">-</span> <span class="n">EPollPoller</span><span class="p">.</span><span class="nl">cc</span><span class="p">:</span><span class="mi">65</span>
<span class="mi">20131023</span> <span class="mi">08</span><span class="o">:</span><span class="mo">05</span><span class="o">:</span><span class="mf">32.910969</span><span class="n">Z</span> <span class="mi">10797</span> <span class="n">TRACE</span> <span class="n">printActiveChannels</span> <span class="p">{</span><span class="mi">8</span><span class="o">:</span> <span class="n">IN</span> <span class="p">}</span>  <span class="o">-</span> <span class="n">EventLoop</span><span class="p">.</span><span class="nl">cc</span><span class="p">:</span><span class="mi">257</span><span class="o">-----&gt;&gt;</span><span class="err">已连接的套接字有可读事件</span>
<span class="mi">20131023</span> <span class="mi">08</span><span class="o">:</span><span class="mo">05</span><span class="o">:</span><span class="mf">32.910990</span><span class="n">Z</span> <span class="mi">10797</span> <span class="n">TRACE</span> <span class="n">handleEvent</span> <span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="n">usecount</span><span class="o">=</span><span class="mi">2</span> <span class="o">-</span> <span class="n">Channel</span><span class="p">.</span><span class="nl">cc</span><span class="p">:</span><span class="mi">67</span>
<span class="n">onMessage</span><span class="p">()</span><span class="o">:</span> <span class="n">received</span> <span class="mi">5</span> <span class="n">bytes</span> <span class="n">from</span> <span class="n">connection</span> <span class="p">[</span><span class="nl">TestServer</span><span class="p">:</span><span class="mf">0.0.0.0</span><span class="o">:</span><span class="mi">8888</span><span class="cp">#1]
</span><span class="cp"></span><span class="mi">20131023</span> <span class="mi">08</span><span class="o">:</span><span class="mo">05</span><span class="o">:</span><span class="mf">32.911066</span><span class="n">Z</span> <span class="mi">10797</span> <span class="n">TRACE</span> <span class="n">handleEvent</span> <span class="p">[</span><span class="mi">12</span><span class="p">]</span> <span class="n">usecount</span><span class="o">=</span><span class="mi">2</span> <span class="o">-</span> <span class="n">Channel</span><span class="p">.</span><span class="nl">cc</span><span class="p">:</span><span class="mi">69</span>
</code></pre></td></tr></table>
</div>
</div>
<h2 id="36-1-buffer">[36-1] BUFFER</h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-c++" data-lang="c++"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c++" data-lang="c++"><span class="mf">1.</span> <span class="err">应用层缓冲区`</span><span class="n">Buffer</span><span class="err">`设计</span>
<span class="mf">2.</span> <span class="err">为什么需要有应用层缓冲区（详见`</span><span class="n">MuduoManual</span><span class="p">.</span><span class="n">pdf</span>  <span class="n">P76</span><span class="err">`）</span>
<span class="mf">3.</span> <span class="err">`</span><span class="n">Buffer</span><span class="err">`结构</span>
<span class="mf">4.</span> <span class="err">`</span><span class="n">epoll</span><span class="err">`使用`</span><span class="n">LT</span><span class="err">`模式的原因</span>
<span class="mf">5.</span> <span class="err">与`</span><span class="n">poll</span><span class="err">`兼容</span>
<span class="mf">6.</span> <span class="err">`</span><span class="n">LT</span><span class="err">`模式不会发生漏掉事件的`</span><span class="n">BUG</span><span class="err">`，但`</span><span class="n">POLLOUT</span><span class="err">`事件不能一开始就关注，否则会出现`</span><span class="n">busy</span> <span class="n">loop</span><span class="err">`，而应该在`</span><span class="n">write</span><span class="err">`无法完全写入内核缓冲区的时候才关注，将未写入内核缓冲区的数据添加到应用层`</span><span class="n">output</span> <span class="n">buffer</span><span class="err">`，直到应用层`</span><span class="n">output</span> <span class="n">buffer</span><span class="err">`写完，停止关注`</span><span class="n">POLLOUT</span><span class="err">`事件。读写的时候不必等候`</span><span class="n">EAGAIN</span><span class="err">`，可以节省系统调用次数，降低延迟。（注：如果用`</span><span class="n">ET</span><span class="err">`模式，读的时候读到`</span><span class="n">EAGAIN</span><span class="err">`</span><span class="p">,</span><span class="err">写的时候直到`</span><span class="n">output</span> <span class="n">buffer</span><span class="err">`写完或者`</span><span class="n">EAGAIN</span><span class="err">`）</span>
</code></pre></td></tr></table>
</div>
</div>
<h3 id="buffer头文件">BUFFER头文件</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-c++" data-lang="c++"><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span><span class="lnt">177
</span><span class="lnt">178
</span><span class="lnt">179
</span><span class="lnt">180
</span><span class="lnt">181
</span><span class="lnt">182
</span><span class="lnt">183
</span><span class="lnt">184
</span><span class="lnt">185
</span><span class="lnt">186
</span><span class="lnt">187
</span><span class="lnt">188
</span><span class="lnt">189
</span><span class="lnt">190
</span><span class="lnt">191
</span><span class="lnt">192
</span><span class="lnt">193
</span><span class="lnt">194
</span><span class="lnt">195
</span><span class="lnt">196
</span><span class="lnt">197
</span><span class="lnt">198
</span><span class="lnt">199
</span><span class="lnt">200
</span><span class="lnt">201
</span><span class="lnt">202
</span><span class="lnt">203
</span><span class="lnt">204
</span><span class="lnt">205
</span><span class="lnt">206
</span><span class="lnt">207
</span><span class="lnt">208
</span><span class="lnt">209
</span><span class="lnt">210
</span><span class="lnt">211
</span><span class="lnt">212
</span><span class="lnt">213
</span><span class="lnt">214
</span><span class="lnt">215
</span><span class="lnt">216
</span><span class="lnt">217
</span><span class="lnt">218
</span><span class="lnt">219
</span><span class="lnt">220
</span><span class="lnt">221
</span><span class="lnt">222
</span><span class="lnt">223
</span><span class="lnt">224
</span><span class="lnt">225
</span><span class="lnt">226
</span><span class="lnt">227
</span><span class="lnt">228
</span><span class="lnt">229
</span><span class="lnt">230
</span><span class="lnt">231
</span><span class="lnt">232
</span><span class="lnt">233
</span><span class="lnt">234
</span><span class="lnt">235
</span><span class="lnt">236
</span><span class="lnt">237
</span><span class="lnt">238
</span><span class="lnt">239
</span><span class="lnt">240
</span><span class="lnt">241
</span><span class="lnt">242
</span><span class="lnt">243
</span><span class="lnt">244
</span><span class="lnt">245
</span><span class="lnt">246
</span><span class="lnt">247
</span><span class="lnt">248
</span><span class="lnt">249
</span><span class="lnt">250
</span><span class="lnt">251
</span><span class="lnt">252
</span><span class="lnt">253
</span><span class="lnt">254
</span><span class="lnt">255
</span><span class="lnt">256
</span><span class="lnt">257
</span><span class="lnt">258
</span><span class="lnt">259
</span><span class="lnt">260
</span><span class="lnt">261
</span><span class="lnt">262
</span><span class="lnt">263
</span><span class="lnt">264
</span><span class="lnt">265
</span><span class="lnt">266
</span><span class="lnt">267
</span><span class="lnt">268
</span><span class="lnt">269
</span><span class="lnt">270
</span><span class="lnt">271
</span><span class="lnt">272
</span><span class="lnt">273
</span><span class="lnt">274
</span><span class="lnt">275
</span><span class="lnt">276
</span><span class="lnt">277
</span><span class="lnt">278
</span><span class="lnt">279
</span><span class="lnt">280
</span><span class="lnt">281
</span><span class="lnt">282
</span><span class="lnt">283
</span><span class="lnt">284
</span><span class="lnt">285
</span><span class="lnt">286
</span><span class="lnt">287
</span><span class="lnt">288
</span><span class="lnt">289
</span><span class="lnt">290
</span><span class="lnt">291
</span><span class="lnt">292
</span><span class="lnt">293
</span><span class="lnt">294
</span><span class="lnt">295
</span><span class="lnt">296
</span><span class="lnt">297
</span><span class="lnt">298
</span><span class="lnt">299
</span><span class="lnt">300
</span><span class="lnt">301
</span><span class="lnt">302
</span><span class="lnt">303
</span><span class="lnt">304
</span><span class="lnt">305
</span><span class="lnt">306
</span><span class="lnt">307
</span><span class="lnt">308
</span><span class="lnt">309
</span><span class="lnt">310
</span><span class="lnt">311
</span><span class="lnt">312
</span><span class="lnt">313
</span><span class="lnt">314
</span><span class="lnt">315
</span><span class="lnt">316
</span><span class="lnt">317
</span><span class="lnt">318
</span><span class="lnt">319
</span><span class="lnt">320
</span><span class="lnt">321
</span><span class="lnt">322
</span><span class="lnt">323
</span><span class="lnt">324
</span><span class="lnt">325
</span><span class="lnt">326
</span><span class="lnt">327
</span><span class="lnt">328
</span><span class="lnt">329
</span><span class="lnt">330
</span><span class="lnt">331
</span><span class="lnt">332
</span><span class="lnt">333
</span><span class="lnt">334
</span><span class="lnt">335
</span><span class="lnt">336
</span><span class="lnt">337
</span><span class="lnt">338
</span><span class="lnt">339
</span><span class="lnt">340
</span><span class="lnt">341
</span><span class="lnt">342
</span><span class="lnt">343
</span><span class="lnt">344
</span><span class="lnt">345
</span><span class="lnt">346
</span><span class="lnt">347
</span><span class="lnt">348
</span><span class="lnt">349
</span><span class="lnt">350
</span><span class="lnt">351
</span><span class="lnt">352
</span><span class="lnt">353
</span><span class="lnt">354
</span><span class="lnt">355
</span><span class="lnt">356
</span><span class="lnt">357
</span><span class="lnt">358
</span><span class="lnt">359
</span><span class="lnt">360
</span><span class="lnt">361
</span><span class="lnt">362
</span><span class="lnt">363
</span><span class="lnt">364
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c++" data-lang="c++"><span class="c1">// Copyright 2010, Shuo Chen.  All rights reserved.
</span><span class="c1">// http://code.google.com/p/muduo/
</span><span class="c1">//
</span><span class="c1">// Use of this source code is governed by a BSD-style license
</span><span class="c1">// that can be found in the License file.
</span><span class="c1"></span> 
<span class="c1">// Author: Shuo Chen (chenshuo at chenshuo dot com)
</span><span class="c1">//
</span><span class="c1">// This is a public header file, it must only include public header files.
</span><span class="c1"></span><span class="cm">/*
</span><span class="cm">接收到数据，存至input buffer，通知上层的应用程序，OnMessage(Buffer *buf)回调，根据应用层协议
</span><span class="cm">判断是否一个完整的包，codec，如果不是一条完整的消息，不会取走数据，也不会进行相应的处理，
</span><span class="cm">如果是一条完整的信息，将取走这条信息，并进行相应的处理
</span><span class="cm"> 
</span><span class="cm">对方发送了两条消息，50,350
</span><span class="cm">接收方第一次接收了200，第二次接收了200
</span><span class="cm"> 
</span><span class="cm">从socket读了 200 个字节，写到buffer中
</span><span class="cm">从buffer中取回50 个字节
</span><span class="cm">又从socket读了200个字节，写到buffer中
</span><span class="cm">从buffer中取回350个字节，写到buffer中
</span><span class="cm">从buffer中取回350个字节
</span><span class="cm"> 
</span><span class="cm">*/</span>
<span class="cp">#ifndef MUDUO_NET_BUFFER_H
</span><span class="cp">#define MUDUO_NET_BUFFER_H
</span><span class="cp"></span> 
<span class="cp">#include</span> <span class="cpf">&lt;muduo/base/copyable.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;muduo/base/StringPiece.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;muduo/base/Types.h&gt;</span><span class="cp">
</span><span class="cp"></span> 
<span class="cp">#include</span> <span class="cpf">&lt;muduo/net/Endian.h&gt;</span><span class="cp">
</span><span class="cp"></span> 
<span class="cp">#include</span> <span class="cpf">&lt;algorithm&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;vector&gt;</span><span class="cp">
</span><span class="cp"></span> 
<span class="cp">#include</span> <span class="cpf">&lt;assert.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;string.h&gt;</span><span class="cp">
</span><span class="cp"></span><span class="c1">//#include &lt;unistd.h&gt;  // ssize_t
</span><span class="c1"></span> 
<span class="k">namespace</span> <span class="n">muduo</span>
<span class="p">{</span>
<span class="k">namespace</span> <span class="n">net</span>
<span class="p">{</span>
 
<span class="c1">/// A buffer class modeled after org.jboss.netty.buffer.ChannelBuffer
</span><span class="c1">///
</span><span class="c1">/// @code
</span><span class="c1">/// +-------------------+------------------+------------------+
</span><span class="c1">/// | prependable bytes |  readable bytes  |  writable bytes  |
</span><span class="c1">/// |                   |     (CONTENT)    |                  |
</span><span class="c1">/// +-------------------+------------------+------------------+
</span><span class="c1">/// |                   |                  |                  |
</span><span class="c1">/// 0      &lt;=      readerIndex   &lt;=   writerIndex    &lt;=     size
</span><span class="c1">/// @endcode
</span><span class="c1"></span><span class="k">class</span><span class="err"> </span><span class="nc">Buffer</span> <span class="o">:</span> <span class="k">public</span> <span class="n">muduo</span><span class="o">::</span><span class="n">copyable</span>
<span class="p">{</span>
 <span class="k">public</span><span class="o">:</span>
  <span class="k">static</span> <span class="k">const</span> <span class="n">size_t</span> <span class="n">kCheapPrepend</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
  <span class="k">static</span> <span class="k">const</span> <span class="n">size_t</span> <span class="n">kInitialSize</span> <span class="o">=</span> <span class="mi">1024</span><span class="p">;</span>
 
  <span class="n">Buffer</span><span class="p">()</span>
  <span class="cm">/*缓冲区的大小*/</span>
    <span class="o">:</span> <span class="n">buffer_</span><span class="p">(</span><span class="n">kCheapPrepend</span> <span class="o">+</span> <span class="n">kInitialSize</span><span class="p">),</span>
    <span class="cm">/*可读的开始位置*/</span>
      <span class="n">readerIndex_</span><span class="p">(</span><span class="n">kCheapPrepend</span><span class="p">),</span>
    <span class="cm">/*可写的开始位置*/</span>
      <span class="n">writerIndex_</span><span class="p">(</span><span class="n">kCheapPrepend</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">assert</span><span class="p">(</span><span class="n">readableBytes</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>
    <span class="n">assert</span><span class="p">(</span><span class="n">writableBytes</span><span class="p">()</span> <span class="o">==</span> <span class="n">kInitialSize</span><span class="p">);</span>
    <span class="n">assert</span><span class="p">(</span><span class="n">prependableBytes</span><span class="p">()</span> <span class="o">==</span> <span class="n">kCheapPrepend</span><span class="p">);</span>
  <span class="p">}</span>
 
  <span class="c1">// default copy-ctor(拷贝构造函数), dtor and assignment are fine
</span><span class="c1"></span> 
  <span class="kt">void</span> <span class="n">swap</span><span class="p">(</span><span class="n">Buffer</span><span class="o">&amp;</span> <span class="n">rhs</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">buffer_</span><span class="p">.</span><span class="n">swap</span><span class="p">(</span><span class="n">rhs</span><span class="p">.</span><span class="n">buffer_</span><span class="p">);</span>
    <span class="n">std</span><span class="o">::</span><span class="n">swap</span><span class="p">(</span><span class="n">readerIndex_</span><span class="p">,</span> <span class="n">rhs</span><span class="p">.</span><span class="n">readerIndex_</span><span class="p">);</span>
    <span class="n">std</span><span class="o">::</span><span class="n">swap</span><span class="p">(</span><span class="n">writerIndex_</span><span class="p">,</span> <span class="n">rhs</span><span class="p">.</span><span class="n">writerIndex_</span><span class="p">);</span>
  <span class="p">}</span>
    <span class="cm">/*可读的字节数*/</span>
  <span class="n">size_t</span> <span class="n">readableBytes</span><span class="p">()</span> <span class="k">const</span>
  <span class="p">{</span> <span class="k">return</span> <span class="n">writerIndex_</span> <span class="o">-</span> <span class="n">readerIndex_</span><span class="p">;</span> <span class="p">}</span>
    <span class="cm">/*可写的字节数*/</span>
  <span class="n">size_t</span> <span class="n">writableBytes</span><span class="p">()</span> <span class="k">const</span>
  <span class="p">{</span> <span class="k">return</span> <span class="n">buffer_</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">-</span> <span class="n">writerIndex_</span><span class="p">;</span> <span class="p">}</span>
    <span class="cm">/*可预留的空间*/</span>
  <span class="n">size_t</span> <span class="n">prependableBytes</span><span class="p">()</span> <span class="k">const</span>
  <span class="p">{</span> <span class="k">return</span> <span class="n">readerIndex_</span><span class="p">;</span> <span class="p">}</span>
    <span class="cm">/*可读位置指针*/</span>
  <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">peek</span><span class="p">()</span> <span class="k">const</span>
  <span class="p">{</span> <span class="k">return</span> <span class="n">begin</span><span class="p">()</span> <span class="o">+</span> <span class="n">readerIndex_</span><span class="p">;</span> <span class="p">}</span>
 
  <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">findCRLF</span><span class="p">()</span> <span class="k">const</span>
  <span class="p">{</span>
    <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">crlf</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">search</span><span class="p">(</span><span class="n">peek</span><span class="p">(),</span> <span class="n">beginWrite</span><span class="p">(),</span> <span class="n">kCRLF</span><span class="p">,</span> <span class="n">kCRLF</span><span class="o">+</span><span class="mi">2</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">crlf</span> <span class="o">==</span> <span class="n">beginWrite</span><span class="p">()</span> <span class="o">?</span> <span class="nb">NULL</span> <span class="o">:</span> <span class="n">crlf</span><span class="p">;</span>
  <span class="p">}</span>
 
  <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">findCRLF</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">start</span><span class="p">)</span> <span class="k">const</span>
  <span class="p">{</span>
    <span class="n">assert</span><span class="p">(</span><span class="n">peek</span><span class="p">()</span> <span class="o">&lt;=</span> <span class="n">start</span><span class="p">);</span>
    <span class="n">assert</span><span class="p">(</span><span class="n">start</span> <span class="o">&lt;=</span> <span class="n">beginWrite</span><span class="p">());</span>
    <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">crlf</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">search</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">beginWrite</span><span class="p">(),</span> <span class="n">kCRLF</span><span class="p">,</span> <span class="n">kCRLF</span><span class="o">+</span><span class="mi">2</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">crlf</span> <span class="o">==</span> <span class="n">beginWrite</span><span class="p">()</span> <span class="o">?</span> <span class="nb">NULL</span> <span class="o">:</span> <span class="n">crlf</span><span class="p">;</span>
  <span class="p">}</span>
 
  <span class="c1">// retrieve returns void, to prevent
</span><span class="c1"></span>  <span class="c1">// string str(retrieve(readableBytes()), readableBytes());
</span><span class="c1"></span>  <span class="c1">// the evaluation of two functions are unspecified
</span><span class="c1"></span>  <span class="cm">/*取回数据*/</span>
  <span class="kt">void</span> <span class="n">retrieve</span><span class="p">(</span><span class="n">size_t</span> <span class="n">len</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">assert</span><span class="p">(</span><span class="n">len</span> <span class="o">&lt;=</span> <span class="n">readableBytes</span><span class="p">());</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="n">readableBytes</span><span class="p">())</span>
    <span class="p">{</span>
      <span class="n">readerIndex_</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">else</span>
    <span class="p">{</span>
      <span class="n">retrieveAll</span><span class="p">();</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="cm">/*取回到指定位置的数据*/</span>
  <span class="kt">void</span> <span class="n">retrieveUntil</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">end</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">assert</span><span class="p">(</span><span class="n">peek</span><span class="p">()</span> <span class="o">&lt;=</span> <span class="n">end</span><span class="p">);</span>
    <span class="n">assert</span><span class="p">(</span><span class="n">end</span> <span class="o">&lt;=</span> <span class="n">beginWrite</span><span class="p">());</span>
    <span class="n">retrieve</span><span class="p">(</span><span class="n">end</span> <span class="o">-</span> <span class="n">peek</span><span class="p">());</span>
  <span class="p">}</span>
  <span class="cm">/*取回一个整数*/</span>
  <span class="kt">void</span> <span class="n">retrieveInt32</span><span class="p">()</span>
  <span class="p">{</span>
    <span class="n">retrieve</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">int32_t</span><span class="p">));</span>
  <span class="p">}</span>
  <span class="cm">/*取回两个字节*/</span>
  <span class="kt">void</span> <span class="n">retrieveInt16</span><span class="p">()</span>
  <span class="p">{</span>
    <span class="n">retrieve</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">int16_t</span><span class="p">));</span>
  <span class="p">}</span>
  <span class="cm">/*取回一个字节*/</span>
  <span class="kt">void</span> <span class="n">retrieveInt8</span><span class="p">()</span>
  <span class="p">{</span>
    <span class="n">retrieve</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">int8_t</span><span class="p">));</span>
  <span class="p">}</span>
  <span class="cm">/*取回全部数据*/</span>
  <span class="kt">void</span> <span class="n">retrieveAll</span><span class="p">()</span>
  <span class="p">{</span>
    <span class="n">readerIndex_</span> <span class="o">=</span> <span class="n">kCheapPrepend</span><span class="p">;</span>
    <span class="n">writerIndex_</span> <span class="o">=</span> <span class="n">kCheapPrepend</span><span class="p">;</span>
  <span class="p">}</span>
 
  <span class="n">string</span> <span class="n">retrieveAllAsString</span><span class="p">()</span>
  <span class="p">{</span>
    <span class="k">return</span> <span class="n">retrieveAsString</span><span class="p">(</span><span class="n">readableBytes</span><span class="p">());;</span>
  <span class="p">}</span>
 
  <span class="n">string</span> <span class="n">retrieveAsString</span><span class="p">(</span><span class="n">size_t</span> <span class="n">len</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">assert</span><span class="p">(</span><span class="n">len</span> <span class="o">&lt;=</span> <span class="n">readableBytes</span><span class="p">());</span>
    <span class="n">string</span> <span class="nf">result</span><span class="p">(</span><span class="n">peek</span><span class="p">(),</span> <span class="n">len</span><span class="p">);</span>
    <span class="n">retrieve</span><span class="p">(</span><span class="n">len</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
  <span class="p">}</span>
 
  <span class="n">StringPiece</span> <span class="n">toStringPiece</span><span class="p">()</span> <span class="k">const</span>
  <span class="p">{</span>
    <span class="k">return</span> <span class="n">StringPiece</span><span class="p">(</span><span class="n">peek</span><span class="p">(),</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="p">(</span><span class="n">readableBytes</span><span class="p">()));</span>
  <span class="p">}</span>
  <span class="cm">/*追加数据*/</span>
  <span class="kt">void</span> <span class="n">append</span><span class="p">(</span><span class="k">const</span> <span class="n">StringPiece</span><span class="o">&amp;</span> <span class="n">str</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">append</span><span class="p">(</span><span class="n">str</span><span class="p">.</span><span class="n">data</span><span class="p">(),</span> <span class="n">str</span><span class="p">.</span><span class="n">size</span><span class="p">());</span>
  <span class="p">}</span>
 
  <span class="kt">void</span> <span class="n">append</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="cm">/*restrict*/</span> <span class="n">data</span><span class="p">,</span> <span class="n">size_t</span> <span class="n">len</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">ensureWritableBytes</span><span class="p">(</span><span class="n">len</span><span class="p">);</span>
    <span class="n">std</span><span class="o">::</span><span class="n">copy</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">data</span><span class="o">+</span><span class="n">len</span><span class="p">,</span> <span class="n">beginWrite</span><span class="p">());</span>
    <span class="n">hasWritten</span><span class="p">(</span><span class="n">len</span><span class="p">);</span>
  <span class="p">}</span>
 
  <span class="kt">void</span> <span class="n">append</span><span class="p">(</span><span class="k">const</span> <span class="kt">void</span><span class="o">*</span> <span class="cm">/*restrict*/</span> <span class="n">data</span><span class="p">,</span> <span class="n">size_t</span> <span class="n">len</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">append</span><span class="p">(</span><span class="k">static_cast</span><span class="o">&lt;</span><span class="k">const</span> <span class="kt">char</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">data</span><span class="p">),</span> <span class="n">len</span><span class="p">);</span>
  <span class="p">}</span>
 
  <span class="c1">// 确保缓冲区可写空间&gt;=len，如果不足则扩充
</span><span class="c1"></span>  <span class="kt">void</span> <span class="n">ensureWritableBytes</span><span class="p">(</span><span class="n">size_t</span> <span class="n">len</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">writableBytes</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">makeSpace</span><span class="p">(</span><span class="n">len</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">assert</span><span class="p">(</span><span class="n">writableBytes</span><span class="p">()</span> <span class="o">&gt;=</span> <span class="n">len</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="cm">/*可写位置的指针*/</span>
  <span class="kt">char</span><span class="o">*</span> <span class="n">beginWrite</span><span class="p">()</span>
  <span class="p">{</span> <span class="k">return</span> <span class="n">begin</span><span class="p">()</span> <span class="o">+</span> <span class="n">writerIndex_</span><span class="p">;</span> <span class="p">}</span>
 
  <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">beginWrite</span><span class="p">()</span> <span class="k">const</span>
  <span class="p">{</span> <span class="k">return</span> <span class="n">begin</span><span class="p">()</span> <span class="o">+</span> <span class="n">writerIndex_</span><span class="p">;</span> <span class="p">}</span>
 
  <span class="kt">void</span> <span class="n">hasWritten</span><span class="p">(</span><span class="n">size_t</span> <span class="n">len</span><span class="p">)</span>
  <span class="p">{</span> <span class="n">writerIndex_</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span> <span class="p">}</span>
 
  <span class="c1">///
</span><span class="c1"></span>  <span class="c1">/// Append int32_t using network endian
</span><span class="c1"></span>  <span class="c1">/// 使用网络字节序追加到buffer
</span><span class="c1"></span>  <span class="kt">void</span> <span class="n">appendInt32</span><span class="p">(</span><span class="n">int32_t</span> <span class="n">x</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">int32_t</span> <span class="n">be32</span> <span class="o">=</span> <span class="n">sockets</span><span class="o">::</span><span class="n">hostToNetwork32</span><span class="p">(</span><span class="n">x</span><span class="p">);</span>
    <span class="n">append</span><span class="p">(</span><span class="o">&amp;</span><span class="n">be32</span><span class="p">,</span> <span class="k">sizeof</span> <span class="n">be32</span><span class="p">);</span>
  <span class="p">}</span>
 
  <span class="kt">void</span> <span class="n">appendInt16</span><span class="p">(</span><span class="n">int16_t</span> <span class="n">x</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">int16_t</span> <span class="n">be16</span> <span class="o">=</span> <span class="n">sockets</span><span class="o">::</span><span class="n">hostToNetwork16</span><span class="p">(</span><span class="n">x</span><span class="p">);</span>
    <span class="n">append</span><span class="p">(</span><span class="o">&amp;</span><span class="n">be16</span><span class="p">,</span> <span class="k">sizeof</span> <span class="n">be16</span><span class="p">);</span>
  <span class="p">}</span>
 
  <span class="kt">void</span> <span class="n">appendInt8</span><span class="p">(</span><span class="n">int8_t</span> <span class="n">x</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">append</span><span class="p">(</span><span class="o">&amp;</span><span class="n">x</span><span class="p">,</span> <span class="k">sizeof</span> <span class="n">x</span><span class="p">);</span>
  <span class="p">}</span>
 
  <span class="c1">///
</span><span class="c1"></span>  <span class="c1">/// Read int32_t from network endian
</span><span class="c1"></span>  <span class="c1">///
</span><span class="c1"></span>  <span class="c1">/// Require: buf-&gt;readableBytes() &gt;= sizeof(int32_t)
</span><span class="c1"></span>  <span class="n">int32_t</span> <span class="n">readInt32</span><span class="p">()</span>
  <span class="p">{</span>
    <span class="n">int32_t</span> <span class="n">result</span> <span class="o">=</span> <span class="n">peekInt32</span><span class="p">();</span>
    <span class="n">retrieveInt32</span><span class="p">();</span>
    <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
  <span class="p">}</span>
 
  <span class="n">int16_t</span> <span class="n">readInt16</span><span class="p">()</span>
  <span class="p">{</span>
    <span class="n">int16_t</span> <span class="n">result</span> <span class="o">=</span> <span class="n">peekInt16</span><span class="p">();</span>
    <span class="n">retrieveInt16</span><span class="p">();</span>
    <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
  <span class="p">}</span>
 
  <span class="n">int8_t</span> <span class="n">readInt8</span><span class="p">()</span>
  <span class="p">{</span>
    <span class="n">int8_t</span> <span class="n">result</span> <span class="o">=</span> <span class="n">peekInt8</span><span class="p">();</span>
    <span class="n">retrieveInt8</span><span class="p">();</span>
    <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
  <span class="p">}</span>
 
  <span class="c1">///
</span><span class="c1"></span>  <span class="c1">/// Peek int32_t from network endian
</span><span class="c1"></span>  <span class="c1">///
</span><span class="c1"></span>  <span class="c1">/// Require: buf-&gt;readableBytes() &gt;= sizeof(int32_t)
</span><span class="c1"></span>  <span class="n">int32_t</span> <span class="n">peekInt32</span><span class="p">()</span> <span class="k">const</span>
  <span class="p">{</span>
    <span class="n">assert</span><span class="p">(</span><span class="n">readableBytes</span><span class="p">()</span> <span class="o">&gt;=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">int32_t</span><span class="p">));</span>
    <span class="n">int32_t</span> <span class="n">be32</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="o">::</span><span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">be32</span><span class="p">,</span> <span class="n">peek</span><span class="p">(),</span> <span class="k">sizeof</span> <span class="n">be32</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">sockets</span><span class="o">::</span><span class="n">networkToHost32</span><span class="p">(</span><span class="n">be32</span><span class="p">);</span>
  <span class="p">}</span>
 
  <span class="n">int16_t</span> <span class="n">peekInt16</span><span class="p">()</span> <span class="k">const</span>
  <span class="p">{</span>
    <span class="n">assert</span><span class="p">(</span><span class="n">readableBytes</span><span class="p">()</span> <span class="o">&gt;=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">int16_t</span><span class="p">));</span>
    <span class="n">int16_t</span> <span class="n">be16</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="o">::</span><span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">be16</span><span class="p">,</span> <span class="n">peek</span><span class="p">(),</span> <span class="k">sizeof</span> <span class="n">be16</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">sockets</span><span class="o">::</span><span class="n">networkToHost16</span><span class="p">(</span><span class="n">be16</span><span class="p">);</span>
  <span class="p">}</span>
 
  <span class="n">int8_t</span> <span class="n">peekInt8</span><span class="p">()</span> <span class="k">const</span>
  <span class="p">{</span>
    <span class="n">assert</span><span class="p">(</span><span class="n">readableBytes</span><span class="p">()</span> <span class="o">&gt;=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">int8_t</span><span class="p">));</span>
    <span class="n">int8_t</span> <span class="n">x</span> <span class="o">=</span> <span class="o">*</span><span class="n">peek</span><span class="p">();</span>
    <span class="k">return</span> <span class="n">x</span><span class="p">;</span>
  <span class="p">}</span>
 
  <span class="c1">///
</span><span class="c1"></span>  <span class="c1">/// Prepend int32_t using network endian
</span><span class="c1"></span>  <span class="c1">///
</span><span class="c1"></span>  <span class="kt">void</span> <span class="n">prependInt32</span><span class="p">(</span><span class="n">int32_t</span> <span class="n">x</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">int32_t</span> <span class="n">be32</span> <span class="o">=</span> <span class="n">sockets</span><span class="o">::</span><span class="n">hostToNetwork32</span><span class="p">(</span><span class="n">x</span><span class="p">);</span>
    <span class="n">prepend</span><span class="p">(</span><span class="o">&amp;</span><span class="n">be32</span><span class="p">,</span> <span class="k">sizeof</span> <span class="n">be32</span><span class="p">);</span>
  <span class="p">}</span>
 
  <span class="kt">void</span> <span class="n">prependInt16</span><span class="p">(</span><span class="n">int16_t</span> <span class="n">x</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">int16_t</span> <span class="n">be16</span> <span class="o">=</span> <span class="n">sockets</span><span class="o">::</span><span class="n">hostToNetwork16</span><span class="p">(</span><span class="n">x</span><span class="p">);</span>
    <span class="n">prepend</span><span class="p">(</span><span class="o">&amp;</span><span class="n">be16</span><span class="p">,</span> <span class="k">sizeof</span> <span class="n">be16</span><span class="p">);</span>
  <span class="p">}</span>
 
  <span class="kt">void</span> <span class="n">prependInt8</span><span class="p">(</span><span class="n">int8_t</span> <span class="n">x</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">prepend</span><span class="p">(</span><span class="o">&amp;</span><span class="n">x</span><span class="p">,</span> <span class="k">sizeof</span> <span class="n">x</span><span class="p">);</span>
  <span class="p">}</span>
 
  <span class="kt">void</span> <span class="n">prepend</span><span class="p">(</span><span class="k">const</span> <span class="kt">void</span><span class="o">*</span> <span class="cm">/*restrict*/</span> <span class="n">data</span><span class="p">,</span> <span class="n">size_t</span> <span class="n">len</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">assert</span><span class="p">(</span><span class="n">len</span> <span class="o">&lt;=</span> <span class="n">prependableBytes</span><span class="p">());</span>
    <span class="n">readerIndex_</span> <span class="o">-=</span> <span class="n">len</span><span class="p">;</span>
    <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">d</span> <span class="o">=</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="k">const</span> <span class="kt">char</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
    <span class="n">std</span><span class="o">::</span><span class="n">copy</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">d</span><span class="o">+</span><span class="n">len</span><span class="p">,</span> <span class="n">begin</span><span class="p">()</span><span class="o">+</span><span class="n">readerIndex_</span><span class="p">);</span>
  <span class="p">}</span>
 
  <span class="c1">// 收缩，保留reserve个字节
</span><span class="c1"></span>  <span class="kt">void</span> <span class="n">shrink</span><span class="p">(</span><span class="n">size_t</span> <span class="n">reserve</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="c1">// FIXME: use vector::shrink_to_fit() in C++ 11 if possible.
</span><span class="c1"></span>    <span class="n">Buffer</span> <span class="n">other</span><span class="p">;</span>
    <span class="n">other</span><span class="p">.</span><span class="n">ensureWritableBytes</span><span class="p">(</span><span class="n">readableBytes</span><span class="p">()</span><span class="o">+</span><span class="n">reserve</span><span class="p">);</span>
    <span class="n">other</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">toStringPiece</span><span class="p">());</span>
    <span class="n">swap</span><span class="p">(</span><span class="n">other</span><span class="p">);</span>
  <span class="p">}</span>
 
  <span class="c1">/// Read data directly into buffer.
</span><span class="c1"></span>  <span class="c1">///
</span><span class="c1"></span>  <span class="c1">/// It may implement with readv(2)
</span><span class="c1"></span>  <span class="c1">/// @return result of read(2), @c errno is saved
</span><span class="c1"></span>  <span class="n">ssize_t</span> <span class="n">readFd</span><span class="p">(</span><span class="kt">int</span> <span class="n">fd</span><span class="p">,</span> <span class="kt">int</span><span class="o">*</span> <span class="n">savedErrno</span><span class="p">);</span>
 
 <span class="k">private</span><span class="o">:</span>
 
  <span class="kt">char</span><span class="o">*</span> <span class="n">begin</span><span class="p">()</span>
  <span class="p">{</span> <span class="k">return</span> <span class="o">&amp;*</span><span class="n">buffer_</span><span class="p">.</span><span class="n">begin</span><span class="p">();</span> <span class="p">}</span>
 
  <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">begin</span><span class="p">()</span> <span class="k">const</span>
  <span class="p">{</span> <span class="k">return</span> <span class="o">&amp;*</span><span class="n">buffer_</span><span class="p">.</span><span class="n">begin</span><span class="p">();</span> <span class="p">}</span>
 
  <span class="kt">void</span> <span class="n">makeSpace</span><span class="p">(</span><span class="n">size_t</span> <span class="n">len</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">writableBytes</span><span class="p">()</span> <span class="o">+</span> <span class="n">prependableBytes</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">len</span> <span class="o">+</span> <span class="n">kCheapPrepend</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="c1">// FIXME: move readable data
</span><span class="c1"></span>      <span class="n">buffer_</span><span class="p">.</span><span class="n">resize</span><span class="p">(</span><span class="n">writerIndex_</span><span class="o">+</span><span class="n">len</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">else</span>
    <span class="p">{</span>
      <span class="c1">// move readable data to the front, make space inside buffer
</span><span class="c1"></span>      <span class="n">assert</span><span class="p">(</span><span class="n">kCheapPrepend</span> <span class="o">&lt;</span> <span class="n">readerIndex_</span><span class="p">);</span>
      <span class="n">size_t</span> <span class="n">readable</span> <span class="o">=</span> <span class="n">readableBytes</span><span class="p">();</span>
      <span class="n">std</span><span class="o">::</span><span class="n">copy</span><span class="p">(</span><span class="n">begin</span><span class="p">()</span><span class="o">+</span><span class="n">readerIndex_</span><span class="p">,</span>
                <span class="n">begin</span><span class="p">()</span><span class="o">+</span><span class="n">writerIndex_</span><span class="p">,</span>
                <span class="n">begin</span><span class="p">()</span><span class="o">+</span><span class="n">kCheapPrepend</span><span class="p">);</span>
      <span class="n">readerIndex_</span> <span class="o">=</span> <span class="n">kCheapPrepend</span><span class="p">;</span>
      <span class="n">writerIndex_</span> <span class="o">=</span> <span class="n">readerIndex_</span> <span class="o">+</span> <span class="n">readable</span><span class="p">;</span>
      <span class="n">assert</span><span class="p">(</span><span class="n">readable</span> <span class="o">==</span> <span class="n">readableBytes</span><span class="p">());</span>
    <span class="p">}</span>
  <span class="p">}</span>
 
 <span class="k">private</span><span class="o">:</span>
  <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">char</span><span class="o">&gt;</span> <span class="n">buffer_</span><span class="p">;</span>  <span class="c1">// vector用于替代固定大小数组
</span><span class="c1"></span>  <span class="n">size_t</span> <span class="n">readerIndex_</span><span class="p">;</span>          <span class="c1">// 读位置
</span><span class="c1"></span>  <span class="n">size_t</span> <span class="n">writerIndex_</span><span class="p">;</span>          <span class="c1">// 写位置
</span><span class="c1"></span> 
  <span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">kCRLF</span><span class="p">[];</span>    <span class="c1">// &#34;\r\n&#34;
</span><span class="c1"></span><span class="p">};</span>
 
<span class="p">}</span>
<span class="p">}</span>
<span class="cp">#endif  </span><span class="c1">// MUDUO_NET_BUFFER_H
</span></code></pre></td></tr></table>
</div>
</div>
<h3 id="buffer源文件">BUFFER源文件</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-c++" data-lang="c++"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c++" data-lang="c++"><span class="c1">// Copyright 2010, Shuo Chen.  All rights reserved.
</span><span class="c1">// http://code.google.com/p/muduo/
</span><span class="c1">//
</span><span class="c1">// Use of this source code is governed by a BSD-style license
</span><span class="c1">// that can be found in the License file.
</span><span class="c1"></span> 
<span class="c1">// Author: Shuo Chen (chenshuo at chenshuo dot com)
</span><span class="c1">//
</span><span class="c1"></span><span class="cp">#include</span> <span class="cpf">&lt;muduo/net/Buffer.h&gt;</span><span class="cp">
</span><span class="cp"></span> 
<span class="cp">#include</span> <span class="cpf">&lt;muduo/net/SocketsOps.h&gt;</span><span class="cp">
</span><span class="cp"></span> 
<span class="cp">#include</span> <span class="cpf">&lt;errno.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;sys/uio.h&gt;</span><span class="cp">
</span><span class="cp"></span> 
<span class="k">using</span> <span class="k">namespace</span> <span class="n">muduo</span><span class="p">;</span>
<span class="k">using</span> <span class="k">namespace</span> <span class="n">muduo</span><span class="o">::</span><span class="n">net</span><span class="p">;</span>
 
<span class="k">const</span> <span class="kt">char</span> <span class="n">Buffer</span><span class="o">::</span><span class="n">kCRLF</span><span class="p">[]</span> <span class="o">=</span> <span class="s">&#34;</span><span class="se">\r\n</span><span class="s">&#34;</span><span class="p">;</span>
 
<span class="k">const</span> <span class="n">size_t</span> <span class="n">Buffer</span><span class="o">::</span><span class="n">kCheapPrepend</span><span class="p">;</span>
<span class="k">const</span> <span class="n">size_t</span> <span class="n">Buffer</span><span class="o">::</span><span class="n">kInitialSize</span><span class="p">;</span>
 
<span class="c1">// 结合栈上的空间，避免内存使用过大，提高内存使用率
</span><span class="c1">// 如果有5K个连接，每个连接就分配64K+64K的缓冲区的话，将占用640M内存，
</span><span class="c1">// 而大多数时候，这些缓冲区的使用率很低
</span><span class="c1"></span><span class="n">ssize_t</span> <span class="n">Buffer</span><span class="o">::</span><span class="n">readFd</span><span class="p">(</span><span class="kt">int</span> <span class="n">fd</span><span class="p">,</span> <span class="kt">int</span><span class="o">*</span> <span class="n">savedErrno</span><span class="p">)</span>
<span class="p">{</span>
  <span class="c1">// saved an ioctl()/FIONREAD call to tell how much to read
</span><span class="c1"></span>  <span class="c1">// 节省一次ioctl系统调用（获取有多少可读数据）
</span><span class="c1"></span>  <span class="kt">char</span> <span class="n">extrabuf</span><span class="p">[</span><span class="mi">65536</span><span class="p">];</span>
  <span class="k">struct</span> <span class="n">iovec</span> <span class="n">vec</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
  <span class="k">const</span> <span class="n">size_t</span> <span class="n">writable</span> <span class="o">=</span> <span class="n">writableBytes</span><span class="p">();</span>
  <span class="c1">// 第一块缓冲区
</span><span class="c1"></span>  <span class="n">vec</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">iov_base</span> <span class="o">=</span> <span class="n">begin</span><span class="p">()</span><span class="o">+</span><span class="n">writerIndex_</span><span class="p">;</span>
  <span class="n">vec</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">iov_len</span> <span class="o">=</span> <span class="n">writable</span><span class="p">;</span>
  <span class="c1">// 第二块缓冲区
</span><span class="c1"></span>  <span class="n">vec</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">iov_base</span> <span class="o">=</span> <span class="n">extrabuf</span><span class="p">;</span>
  <span class="n">vec</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">iov_len</span> <span class="o">=</span> <span class="k">sizeof</span> <span class="n">extrabuf</span><span class="p">;</span>
  <span class="k">const</span> <span class="n">ssize_t</span> <span class="n">n</span> <span class="o">=</span> <span class="n">sockets</span><span class="o">::</span><span class="n">readv</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">vec</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="o">*</span><span class="n">savedErrno</span> <span class="o">=</span> <span class="n">errno</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">implicit_cast</span><span class="o">&lt;</span><span class="n">size_t</span><span class="o">&gt;</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">writable</span><span class="p">)</span>   <span class="c1">//第一块缓冲区足够容纳
</span><span class="c1"></span>  <span class="p">{</span>
    <span class="n">writerIndex_</span> <span class="o">+=</span> <span class="n">n</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">else</span>      <span class="c1">// 当前缓冲区，不够容纳，因而数据被接收到了第二块缓冲区extrabuf，将其append至buffer
</span><span class="c1"></span>  <span class="p">{</span>
    <span class="n">writerIndex_</span> <span class="o">=</span> <span class="n">buffer_</span><span class="p">.</span><span class="n">size</span><span class="p">();</span>
    <span class="n">append</span><span class="p">(</span><span class="n">extrabuf</span><span class="p">,</span> <span class="n">n</span> <span class="o">-</span> <span class="n">writable</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="c1">// if (n == writable + sizeof extrabuf)
</span><span class="c1"></span>  <span class="c1">// {
</span><span class="c1"></span>  <span class="c1">//   goto line_30;
</span><span class="c1"></span>  <span class="c1">// }
</span><span class="c1"></span>  <span class="k">return</span> <span class="n">n</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div>
<h2 id="37-buffer">[37] BUFFER</h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-c++" data-lang="c++"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c++" data-lang="c++"><span class="err">应用程序想关闭连接，但是可能正处于发送数据的过程中，</span><span class="n">output</span> <span class="n">buffer中有数据还没有发送完</span><span class="p">,</span><span class="err">不能直接调用`</span><span class="n">close</span><span class="err">`</span><span class="p">,</span> <span class="err">`</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">send</span><span class="p">(</span><span class="n">buff</span><span class="p">)</span><span class="err">`</span><span class="o">==&gt;</span><span class="err">`</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">shutdown</span><span class="p">()</span><span class="err">`</span><span class="o">==&gt;</span><span class="err">`</span><span class="n">POLLOUT</span><span class="err">`事件</span><span class="p">.</span>
<span class="err">关闭写的这一半</span><span class="o">:</span> <span class="err">连接状态更改为`</span><span class="n">kDisconnection</span><span class="err">`，并没有关闭连接</span>
<span class="err">服务器主动断开与客户端的连接</span><span class="p">,</span> <span class="err">这意味着</span> <span class="err">客户端</span> <span class="err">`</span><span class="n">read</span><span class="err">`返回`</span><span class="mi">0</span><span class="err">`</span><span class="p">,</span> <span class="err">`</span><span class="n">close</span><span class="p">(</span><span class="n">conn</span><span class="p">)</span><span class="err">`</span> <span class="o">==&gt;</span> <span class="err">`</span><span class="n">POLLHUP</span><span class="o">|</span><span class="n">POLLIN</span><span class="err">`</span>
<span class="err">如果是客户端主动关闭连接，那么服务器端只返回`</span><span class="n">POLLIN</span><span class="err">`</span><span class="p">,</span><span class="err">如果是服务器端主动关闭，然后客户端再关闭，那么服务器端返回`</span><span class="n">POLLIN</span><span class="err">`和`</span><span class="n">POLLHUP</span><span class="err">`事件</span>
</code></pre></td></tr></table>
</div>
</div>
<h3 id="测试程序-1">测试程序</h3>

<p>服务器</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-c++" data-lang="c++"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span><span class="lnt">84
</span><span class="lnt">85
</span><span class="lnt">86
</span><span class="lnt">87
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c++" data-lang="c++"><span class="cp">#include</span> <span class="cpf">&lt;muduo/net/TcpServer.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;muduo/net/EventLoop.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;muduo/net/InetAddress.h&gt;</span><span class="cp">
</span><span class="cp"></span> 
<span class="cp">#include</span> <span class="cpf">&lt;boost/bind.hpp&gt;</span><span class="cp">
</span><span class="cp"></span> 
<span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
</span><span class="cp"></span> 
<span class="k">using</span> <span class="k">namespace</span> <span class="n">muduo</span><span class="p">;</span>
<span class="k">using</span> <span class="k">namespace</span> <span class="n">muduo</span><span class="o">::</span><span class="n">net</span><span class="p">;</span>
 
<span class="k">class</span><span class="err"> </span><span class="nc">TestServer</span>
<span class="p">{</span>
 <span class="k">public</span><span class="o">:</span>
  <span class="n">TestServer</span><span class="p">(</span><span class="n">EventLoop</span><span class="o">*</span> <span class="n">loop</span><span class="p">,</span>
             <span class="k">const</span> <span class="n">InetAddress</span><span class="o">&amp;</span> <span class="n">listenAddr</span><span class="p">)</span>
    <span class="o">:</span> <span class="n">loop_</span><span class="p">(</span><span class="n">loop</span><span class="p">),</span>
      <span class="n">server_</span><span class="p">(</span><span class="n">loop</span><span class="p">,</span> <span class="n">listenAddr</span><span class="p">,</span> <span class="s">&#34;TestServer&#34;</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">server_</span><span class="p">.</span><span class="n">setConnectionCallback</span><span class="p">(</span>
        <span class="n">boost</span><span class="o">::</span><span class="n">bind</span><span class="p">(</span><span class="o">&amp;</span><span class="n">TestServer</span><span class="o">::</span><span class="n">onConnection</span><span class="p">,</span> <span class="k">this</span><span class="p">,</span> <span class="n">_1</span><span class="p">));</span>
    <span class="n">server_</span><span class="p">.</span><span class="n">setMessageCallback</span><span class="p">(</span>
        <span class="n">boost</span><span class="o">::</span><span class="n">bind</span><span class="p">(</span><span class="o">&amp;</span><span class="n">TestServer</span><span class="o">::</span><span class="n">onMessage</span><span class="p">,</span> <span class="k">this</span><span class="p">,</span> <span class="n">_1</span><span class="p">,</span> <span class="n">_2</span><span class="p">,</span> <span class="n">_3</span><span class="p">));</span>
 
    <span class="n">message1_</span><span class="p">.</span><span class="n">resize</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
    <span class="n">message2_</span><span class="p">.</span><span class="n">resize</span><span class="p">(</span><span class="mi">200</span><span class="p">);</span>
    <span class="n">std</span><span class="o">::</span><span class="n">fill</span><span class="p">(</span><span class="n">message1_</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span> <span class="n">message1_</span><span class="p">.</span><span class="n">end</span><span class="p">(),</span> <span class="sc">&#39;A&#39;</span><span class="p">);</span>
    <span class="n">std</span><span class="o">::</span><span class="n">fill</span><span class="p">(</span><span class="n">message2_</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span> <span class="n">message2_</span><span class="p">.</span><span class="n">end</span><span class="p">(),</span> <span class="sc">&#39;B&#39;</span><span class="p">);</span>
  <span class="p">}</span>
 
  <span class="kt">void</span> <span class="n">start</span><span class="p">()</span>
  <span class="p">{</span>
      <span class="n">server_</span><span class="p">.</span><span class="n">start</span><span class="p">();</span>
  <span class="p">}</span>
 
 <span class="k">private</span><span class="o">:</span>
  <span class="kt">void</span> <span class="n">onConnection</span><span class="p">(</span><span class="k">const</span> <span class="n">TcpConnectionPtr</span><span class="o">&amp;</span> <span class="n">conn</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">connected</span><span class="p">())</span>
    <span class="p">{</span>
      <span class="n">printf</span><span class="p">(</span><span class="s">&#34;onConnection(): new connection [%s] from %s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span>
             <span class="n">conn</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">().</span><span class="n">c_str</span><span class="p">(),</span>
             <span class="n">conn</span><span class="o">-&gt;</span><span class="n">peerAddress</span><span class="p">().</span><span class="n">toIpPort</span><span class="p">().</span><span class="n">c_str</span><span class="p">());</span>
      <span class="n">conn</span><span class="o">-&gt;</span><span class="n">send</span><span class="p">(</span><span class="n">message1_</span><span class="p">);</span>
      <span class="n">conn</span><span class="o">-&gt;</span><span class="n">send</span><span class="p">(</span><span class="n">message2_</span><span class="p">);</span>
      <span class="n">conn</span><span class="o">-&gt;</span><span class="n">shutdown</span><span class="p">();</span>
    <span class="p">}</span>
    <span class="k">else</span>
    <span class="p">{</span>
      <span class="n">printf</span><span class="p">(</span><span class="s">&#34;onConnection(): connection [%s] is down</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span>
             <span class="n">conn</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">().</span><span class="n">c_str</span><span class="p">());</span>
    <span class="p">}</span>
  <span class="p">}</span>
 
  <span class="kt">void</span> <span class="n">onMessage</span><span class="p">(</span><span class="k">const</span> <span class="n">TcpConnectionPtr</span><span class="o">&amp;</span> <span class="n">conn</span><span class="p">,</span>
                 <span class="n">Buffer</span><span class="o">*</span> <span class="n">buf</span><span class="p">,</span>
                 <span class="n">Timestamp</span> <span class="n">receiveTime</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">muduo</span><span class="o">::</span><span class="n">string</span> <span class="n">msg</span><span class="p">(</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">retrieveAllAsString</span><span class="p">());</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;onMessage(): received %zd bytes from connection [%s] at %s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span>
           <span class="n">msg</span><span class="p">.</span><span class="n">size</span><span class="p">(),</span>
           <span class="n">conn</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">().</span><span class="n">c_str</span><span class="p">(),</span>
           <span class="n">receiveTime</span><span class="p">.</span><span class="n">toFormattedString</span><span class="p">().</span><span class="n">c_str</span><span class="p">());</span>
 
    <span class="n">conn</span><span class="o">-&gt;</span><span class="n">send</span><span class="p">(</span><span class="n">msg</span><span class="p">);</span>
  <span class="p">}</span>
 
  <span class="n">EventLoop</span><span class="o">*</span> <span class="n">loop_</span><span class="p">;</span>
  <span class="n">TcpServer</span> <span class="n">server_</span><span class="p">;</span>
 
  <span class="n">muduo</span><span class="o">::</span><span class="n">string</span> <span class="n">message1_</span><span class="p">;</span>
  <span class="n">muduo</span><span class="o">::</span><span class="n">string</span> <span class="n">message2_</span><span class="p">;</span>
<span class="p">};</span>
 
 
<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>
<span class="p">{</span>
  <span class="n">printf</span><span class="p">(</span><span class="s">&#34;main(): pid = %d</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">getpid</span><span class="p">());</span>
 
  <span class="n">InetAddress</span> <span class="n">listenAddr</span><span class="p">(</span><span class="mi">8888</span><span class="p">);</span>
  <span class="n">EventLoop</span> <span class="n">loop</span><span class="p">;</span>
 
  <span class="n">TestServer</span> <span class="n">server</span><span class="p">(</span><span class="o">&amp;</span><span class="n">loop</span><span class="p">,</span> <span class="n">listenAddr</span><span class="p">);</span>
  <span class="n">server</span><span class="p">.</span><span class="n">start</span><span class="p">();</span>
 
  <span class="n">loop</span><span class="p">.</span><span class="n">loop</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div>
<h3 id="客户端">客户端</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-c++" data-lang="c++"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c++" data-lang="c++"><span class="cp">#include</span> <span class="cpf">&lt;unistd.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;sys/types.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;sys/socket.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;netinet/in.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;arpa/inet.h&gt;</span><span class="cp">
</span><span class="cp"></span> 
<span class="cp">#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;errno.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;string.h&gt;</span><span class="cp">
</span><span class="cp"></span> <span class="c1">//该程序可能出现粘包问题
</span><span class="c1"></span><span class="cp">#define ERR_EXIT(m) \
</span><span class="cp"></span>        <span class="k">do</span> \
        <span class="p">{</span> \
                <span class="n">perror</span><span class="p">(</span><span class="n">m</span><span class="p">);</span> \
                <span class="n">exit</span><span class="p">(</span><span class="n">EXIT_FAILURE</span><span class="p">);</span> \
        <span class="p">}</span> <span class="k">while</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
 
<span class="kt">int</span> <span class="n">main</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">int</span> <span class="n">sock</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">((</span><span class="n">sock</span> <span class="o">=</span> <span class="n">socket</span><span class="p">(</span><span class="n">PF_INET</span><span class="p">,</span> <span class="n">SOCK_STREAM</span><span class="p">,</span> <span class="n">IPPROTO_TCP</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">ERR_EXIT</span><span class="p">(</span><span class="s">&#34;socket&#34;</span><span class="p">);</span>
 
    <span class="k">struct</span> <span class="n">sockaddr_in</span> <span class="n">servaddr</span><span class="p">;</span>
    <span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">servaddr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">servaddr</span><span class="p">));</span>
    <span class="n">servaddr</span><span class="p">.</span><span class="n">sin_family</span> <span class="o">=</span> <span class="n">AF_INET</span><span class="p">;</span>
    <span class="n">servaddr</span><span class="p">.</span><span class="n">sin_port</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="mi">8888</span><span class="p">);</span>
    <span class="n">servaddr</span><span class="p">.</span><span class="n">sin_addr</span><span class="p">.</span><span class="n">s_addr</span> <span class="o">=</span> <span class="n">inet_addr</span><span class="p">(</span><span class="s">&#34;127.0.0.1&#34;</span><span class="p">);</span>
 
    <span class="k">if</span> <span class="p">(</span><span class="n">connect</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr</span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">servaddr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">servaddr</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">ERR_EXIT</span><span class="p">(</span><span class="s">&#34;connect&#34;</span><span class="p">);</span>
 
    <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">1024</span><span class="p">]</span> <span class="o">=</span><span class="p">{</span><span class="mi">0</span><span class="p">};</span>
    <span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">read</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">));</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">&#34;ret=%d</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
            <span class="k">break</span><span class="p">;</span>
 
        <span class="n">fputs</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">stdout</span><span class="p">);</span>
        <span class="n">fflush</span><span class="p">(</span><span class="n">stdout</span><span class="p">);</span>
        <span class="n">memset</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">));</span>
    <span class="p">}</span>
 
    <span class="n">sleep</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
    <span class="n">close</span><span class="p">(</span><span class="n">sock</span><span class="p">);</span>
 
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div>
<h3 id="程序输出-1">程序输出</h3>

<p>服务器：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-c++" data-lang="c++"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c++" data-lang="c++"><span class="n">ubuntu</span><span class="err">@</span><span class="n">ubuntu</span><span class="o">-</span><span class="k">virtual</span><span class="o">-</span><span class="nl">machine</span><span class="p">:</span><span class="o">~/</span><span class="n">pro</span><span class="o">/</span><span class="mi">37</span><span class="err">$</span> <span class="p">.</span><span class="o">/</span><span class="n">build</span><span class="o">/</span><span class="n">debug</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">reactor_test12</span>
<span class="n">main</span><span class="p">()</span><span class="o">:</span> <span class="n">pid</span> <span class="o">=</span> <span class="mi">8683</span>
<span class="mi">20131024</span> <span class="mo">07</span><span class="o">:</span><span class="mi">19</span><span class="o">:</span><span class="mf">37.457271</span><span class="n">Z</span>  <span class="mi">8683</span> <span class="n">TRACE</span> <span class="n">updateChannel</span> <span class="n">fd</span> <span class="o">=</span> <span class="mi">4</span> <span class="n">events</span> <span class="o">=</span> <span class="mi">3</span> <span class="o">-</span> <span class="n">EPollPoller</span><span class="p">.</span><span class="nl">cc</span><span class="p">:</span><span class="mi">104</span>
<span class="mi">20131024</span> <span class="mo">07</span><span class="o">:</span><span class="mi">19</span><span class="o">:</span><span class="mf">37.457470</span><span class="n">Z</span>  <span class="mi">8683</span> <span class="n">TRACE</span> <span class="n">EventLoop</span> <span class="n">EventLoop</span> <span class="n">created</span> <span class="mh">0xBFDDAB44</span> <span class="n">in</span> <span class="kr">thread</span> <span class="mi">8683</span> <span class="o">-</span> <span class="n">EventLoop</span><span class="p">.</span><span class="nl">cc</span><span class="p">:</span><span class="mi">62</span>
<span class="mi">20131024</span> <span class="mo">07</span><span class="o">:</span><span class="mi">19</span><span class="o">:</span><span class="mf">37.457485</span><span class="n">Z</span>  <span class="mi">8683</span> <span class="n">TRACE</span> <span class="n">updateChannel</span> <span class="n">fd</span> <span class="o">=</span> <span class="mi">5</span> <span class="n">events</span> <span class="o">=</span> <span class="mi">3</span> <span class="o">-</span> <span class="n">EPollPoller</span><span class="p">.</span><span class="nl">cc</span><span class="p">:</span><span class="mi">104</span>
<span class="mi">20131024</span> <span class="mo">07</span><span class="o">:</span><span class="mi">19</span><span class="o">:</span><span class="mf">37.457645</span><span class="n">Z</span>  <span class="mi">8683</span> <span class="n">TRACE</span> <span class="n">updateChannel</span> <span class="n">fd</span> <span class="o">=</span> <span class="mi">6</span> <span class="n">events</span> <span class="o">=</span> <span class="mi">3</span> <span class="o">-</span> <span class="n">EPollPoller</span><span class="p">.</span><span class="nl">cc</span><span class="p">:</span><span class="mi">104</span>
<span class="mi">20131024</span> <span class="mo">07</span><span class="o">:</span><span class="mi">19</span><span class="o">:</span><span class="mf">37.457661</span><span class="n">Z</span>  <span class="mi">8683</span> <span class="n">TRACE</span> <span class="n">loop</span> <span class="n">EventLoop</span> <span class="mh">0xBFDDAB44</span> <span class="n">start</span> <span class="n">looping</span> <span class="o">-</span> <span class="n">EventLoop</span><span class="p">.</span><span class="nl">cc</span><span class="p">:</span><span class="mi">94</span>
<span class="mi">20131024</span> <span class="mo">07</span><span class="o">:</span><span class="mi">19</span><span class="o">:</span><span class="mf">47.468016</span><span class="n">Z</span>  <span class="mi">8683</span> <span class="n">TRACE</span> <span class="n">poll</span>  <span class="n">nothing</span> <span class="n">happended</span> <span class="o">-</span> <span class="n">EPollPoller</span><span class="p">.</span><span class="nl">cc</span><span class="p">:</span><span class="mi">74</span>
<span class="mi">20131024</span> <span class="mo">07</span><span class="o">:</span><span class="mi">19</span><span class="o">:</span><span class="mf">57.478500</span><span class="n">Z</span>  <span class="mi">8683</span> <span class="n">TRACE</span> <span class="n">poll</span>  <span class="n">nothing</span> <span class="n">happended</span> <span class="o">-</span> <span class="n">EPollPoller</span><span class="p">.</span><span class="nl">cc</span><span class="p">:</span><span class="mi">74</span>
<span class="mi">20131024</span> <span class="mo">07</span><span class="o">:</span><span class="mi">20</span><span class="o">:</span><span class="mf">07.488977</span><span class="n">Z</span>  <span class="mi">8683</span> <span class="n">TRACE</span> <span class="n">poll</span>  <span class="n">nothing</span> <span class="n">happended</span> <span class="o">-</span> <span class="n">EPollPoller</span><span class="p">.</span><span class="nl">cc</span><span class="p">:</span><span class="mi">74</span>
<span class="mi">20131024</span> <span class="mo">07</span><span class="o">:</span><span class="mi">20</span><span class="o">:</span><span class="mf">17.499503</span><span class="n">Z</span>  <span class="mi">8683</span> <span class="n">TRACE</span> <span class="n">poll</span>  <span class="n">nothing</span> <span class="n">happended</span> <span class="o">-</span> <span class="n">EPollPoller</span><span class="p">.</span><span class="nl">cc</span><span class="p">:</span><span class="mi">74</span>
<span class="mi">20131024</span> <span class="mo">07</span><span class="o">:</span><span class="mi">20</span><span class="o">:</span><span class="mf">27.509985</span><span class="n">Z</span>  <span class="mi">8683</span> <span class="n">TRACE</span> <span class="n">poll</span>  <span class="n">nothing</span> <span class="n">happended</span> <span class="o">-</span> <span class="n">EPollPoller</span><span class="p">.</span><span class="nl">cc</span><span class="p">:</span><span class="mi">74</span>
<span class="mi">20131024</span> <span class="mo">07</span><span class="o">:</span><span class="mi">20</span><span class="o">:</span><span class="mf">37.520451</span><span class="n">Z</span>  <span class="mi">8683</span> <span class="n">TRACE</span> <span class="n">poll</span>  <span class="n">nothing</span> <span class="n">happended</span> <span class="o">-</span> <span class="n">EPollPoller</span><span class="p">.</span><span class="nl">cc</span><span class="p">:</span><span class="mi">74</span>
<span class="mi">20131024</span> <span class="mo">07</span><span class="o">:</span><span class="mi">20</span><span class="o">:</span><span class="mf">47.528439</span><span class="n">Z</span>  <span class="mi">8683</span> <span class="n">TRACE</span> <span class="n">poll</span>  <span class="n">nothing</span> <span class="n">happended</span> <span class="o">-</span> <span class="n">EPollPoller</span><span class="p">.</span><span class="nl">cc</span><span class="p">:</span><span class="mi">74</span>
<span class="mi">20131024</span> <span class="mo">07</span><span class="o">:</span><span class="mi">20</span><span class="o">:</span><span class="mf">57.538942</span><span class="n">Z</span>  <span class="mi">8683</span> <span class="n">TRACE</span> <span class="n">poll</span>  <span class="n">nothing</span> <span class="n">happended</span> <span class="o">-</span> <span class="n">EPollPoller</span><span class="p">.</span><span class="nl">cc</span><span class="p">:</span><span class="mi">74</span>
<span class="mi">20131024</span> <span class="mo">07</span><span class="o">:</span><span class="mi">21</span><span class="o">:</span><span class="mf">01.262358</span><span class="n">Z</span>  <span class="mi">8683</span> <span class="n">TRACE</span> <span class="n">poll</span> <span class="mi">1</span> <span class="n">events</span> <span class="n">happended</span> <span class="o">-</span> <span class="n">EPollPoller</span><span class="p">.</span><span class="nl">cc</span><span class="p">:</span><span class="mi">65</span>
<span class="mi">20131024</span> <span class="mo">07</span><span class="o">:</span><span class="mi">21</span><span class="o">:</span><span class="mf">01.262792</span><span class="n">Z</span>  <span class="mi">8683</span> <span class="n">TRACE</span> <span class="n">printActiveChannels</span> <span class="p">{</span><span class="mi">6</span><span class="o">:</span> <span class="n">IN</span> <span class="p">}</span>  <span class="o">-</span> <span class="n">EventLoop</span><span class="p">.</span><span class="nl">cc</span><span class="p">:</span><span class="mi">257</span>
<span class="mi">20131024</span> <span class="mo">07</span><span class="o">:</span><span class="mi">21</span><span class="o">:</span><span class="mf">01.262820</span><span class="n">Z</span>  <span class="mi">8683</span> <span class="n">TRACE</span> <span class="n">handleEventWithGuard</span> <span class="mi">2222222222222222</span><span class="n">POLLIN22222222222222222222</span> <span class="o">-</span> <span class="n">Channel</span><span class="p">.</span><span class="nl">cc</span><span class="p">:</span><span class="mi">89</span>
<span class="mi">20131024</span> <span class="mo">07</span><span class="o">:</span><span class="mi">21</span><span class="o">:</span><span class="mf">01.262881</span><span class="n">Z</span>  <span class="mi">8683</span> <span class="n">INFO</span>  <span class="n">TcpServer</span><span class="o">::</span><span class="n">newConnection</span> <span class="p">[</span><span class="n">TestServer</span><span class="p">]</span> <span class="o">-</span> <span class="k">new</span> <span class="n">connection</span> <span class="p">[</span><span class="nl">TestServer</span><span class="p">:</span><span class="mf">0.0.0.0</span><span class="o">:</span><span class="mi">8888</span><span class="cp">#1] from 127.0.0.1:56659 - TcpServer.cc:93
</span><span class="cp"></span><span class="mi">20131024</span> <span class="mo">07</span><span class="o">:</span><span class="mi">21</span><span class="o">:</span><span class="mf">01.262916</span><span class="n">Z</span>  <span class="mi">8683</span> <span class="n">DEBUG</span> <span class="n">TcpConnection</span> <span class="n">TcpConnection</span><span class="o">::</span><span class="n">ctor</span><span class="p">[</span><span class="nl">TestServer</span><span class="p">:</span><span class="mf">0.0.0.0</span><span class="o">:</span><span class="mi">8888</span><span class="cp">#1] at 0x96C65D0 fd=8 - TcpConnection.cc:62
</span><span class="cp"></span><span class="mi">20131024</span> <span class="mo">07</span><span class="o">:</span><span class="mi">21</span><span class="o">:</span><span class="mf">01.262934</span><span class="n">Z</span>  <span class="mi">8683</span> <span class="n">TRACE</span> <span class="n">newConnection</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="n">usecount</span><span class="o">=</span><span class="mi">1</span> <span class="o">-</span> <span class="n">TcpServer</span><span class="p">.</span><span class="nl">cc</span><span class="p">:</span><span class="mi">111</span>
<span class="mi">20131024</span> <span class="mo">07</span><span class="o">:</span><span class="mi">21</span><span class="o">:</span><span class="mf">01.262961</span><span class="n">Z</span>  <span class="mi">8683</span> <span class="n">TRACE</span> <span class="n">newConnection</span> <span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="n">usecount</span><span class="o">=</span><span class="mi">2</span> <span class="o">-</span> <span class="n">TcpServer</span><span class="p">.</span><span class="nl">cc</span><span class="p">:</span><span class="mi">113</span>
<span class="mi">20131024</span> <span class="mo">07</span><span class="o">:</span><span class="mi">21</span><span class="o">:</span><span class="mf">01.262981</span><span class="n">Z</span>  <span class="mi">8683</span> <span class="n">TRACE</span> <span class="n">connectEstablished</span> <span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="n">usecount</span><span class="o">=</span><span class="mi">6</span> <span class="o">-</span> <span class="n">TcpConnection</span><span class="p">.</span><span class="nl">cc</span><span class="p">:</span><span class="mi">231</span>
<span class="mi">20131024</span> <span class="mo">07</span><span class="o">:</span><span class="mi">21</span><span class="o">:</span><span class="mf">01.262998</span><span class="n">Z</span>  <span class="mi">8683</span> <span class="n">TRACE</span> <span class="n">updateChannel</span> <span class="n">fd</span> <span class="o">=</span> <span class="mi">8</span> <span class="n">events</span> <span class="o">=</span> <span class="mi">3</span> <span class="o">-</span> <span class="n">EPollPoller</span><span class="p">.</span><span class="nl">cc</span><span class="p">:</span><span class="mi">104</span>
<span class="n">onConnection</span><span class="p">()</span><span class="o">:</span> <span class="k">new</span> <span class="n">connection</span> <span class="p">[</span><span class="nl">TestServer</span><span class="p">:</span><span class="mf">0.0.0.0</span><span class="o">:</span><span class="mi">8888</span><span class="cp">#1] from 127.0.0.1:56659
</span><span class="cp"></span><span class="mi">20131024</span> <span class="mo">07</span><span class="o">:</span><span class="mi">21</span><span class="o">:</span><span class="mf">01.263363</span><span class="n">Z</span>  <span class="mi">8683</span> <span class="n">TRACE</span> <span class="n">connectEstablished</span> <span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="n">usecount</span><span class="o">=</span><span class="mi">6</span> <span class="o">-</span> <span class="n">TcpConnection</span><span class="p">.</span><span class="nl">cc</span><span class="p">:</span><span class="mi">236</span>
<span class="mi">20131024</span> <span class="mo">07</span><span class="o">:</span><span class="mi">21</span><span class="o">:</span><span class="mf">01.263378</span><span class="n">Z</span>  <span class="mi">8683</span> <span class="n">TRACE</span> <span class="n">newConnection</span> <span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="n">usecount</span><span class="o">=</span><span class="mi">2</span> <span class="o">-</span> <span class="n">TcpServer</span><span class="p">.</span><span class="nl">cc</span><span class="p">:</span><span class="mi">122</span>
<span class="mi">20131024</span> <span class="mo">07</span><span class="o">:</span><span class="mi">21</span><span class="o">:</span><span class="mf">11.265287</span><span class="n">Z</span>  <span class="mi">8683</span> <span class="n">TRACE</span> <span class="n">poll</span> <span class="mi">1</span> <span class="n">events</span> <span class="n">happended</span> <span class="o">-</span> <span class="n">EPollPoller</span><span class="p">.</span><span class="nl">cc</span><span class="p">:</span><span class="mi">65</span>
<span class="mi">20131024</span> <span class="mo">07</span><span class="o">:</span><span class="mi">21</span><span class="o">:</span><span class="mf">11.265469</span><span class="n">Z</span>  <span class="mi">8683</span> <span class="n">TRACE</span> <span class="n">printActiveChannels</span> <span class="p">{</span><span class="mi">8</span><span class="o">:</span> <span class="n">IN</span> <span class="n">HUP</span> <span class="p">}</span>  <span class="o">-</span> <span class="n">EventLoop</span><span class="p">.</span><span class="nl">cc</span><span class="p">:</span><span class="mi">257</span>
<span class="mi">20131024</span> <span class="mo">07</span><span class="o">:</span><span class="mi">21</span><span class="o">:</span><span class="mf">11.265483</span><span class="n">Z</span>  <span class="mi">8683</span> <span class="n">TRACE</span> <span class="n">handleEvent</span> <span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="n">usecount</span><span class="o">=</span><span class="mi">2</span> <span class="o">-</span> <span class="n">Channel</span><span class="p">.</span><span class="nl">cc</span><span class="p">:</span><span class="mi">67</span>
<span class="mi">20131024</span> <span class="mo">07</span><span class="o">:</span><span class="mi">21</span><span class="o">:</span><span class="mf">11.265491</span><span class="n">Z</span>  <span class="mi">8683</span> <span class="n">TRACE</span> <span class="n">handleEventWithGuard</span> <span class="mi">1111111111111111</span><span class="n">POLLHUP1111111111111111111</span> <span class="o">-</span> <span class="n">Channel</span><span class="p">.</span><span class="nl">cc</span><span class="p">:</span><span class="mi">85</span>
<span class="mi">20131024</span> <span class="mo">07</span><span class="o">:</span><span class="mi">21</span><span class="o">:</span><span class="mf">11.265498</span><span class="n">Z</span>  <span class="mi">8683</span> <span class="n">TRACE</span> <span class="n">handleEventWithGuard</span> <span class="mi">2222222222222222</span><span class="n">POLLIN22222222222222222222</span> <span class="o">-</span> <span class="n">Channel</span><span class="p">.</span><span class="nl">cc</span><span class="p">:</span><span class="mi">89</span>
<span class="mi">20131024</span> <span class="mo">07</span><span class="o">:</span><span class="mi">21</span><span class="o">:</span><span class="mf">11.265556</span><span class="n">Z</span>  <span class="mi">8683</span> <span class="n">TRACE</span> <span class="n">handleClose</span> <span class="n">fd</span> <span class="o">=</span> <span class="mi">8</span> <span class="n">state</span> <span class="o">=</span> <span class="mi">3</span> <span class="o">-</span> <span class="n">TcpConnection</span><span class="p">.</span><span class="nl">cc</span><span class="p">:</span><span class="mi">297</span>
<span class="mi">20131024</span> <span class="mo">07</span><span class="o">:</span><span class="mi">21</span><span class="o">:</span><span class="mf">11.265567</span><span class="n">Z</span>  <span class="mi">8683</span> <span class="n">TRACE</span> <span class="n">updateChannel</span> <span class="n">fd</span> <span class="o">=</span> <span class="mi">8</span> <span class="n">events</span> <span class="o">=</span> <span class="mi">0</span> <span class="o">-</span> <span class="n">EPollPoller</span><span class="p">.</span><span class="nl">cc</span><span class="p">:</span><span class="mi">104</span>
<span class="n">onConnection</span><span class="p">()</span><span class="o">:</span> <span class="n">connection</span> <span class="p">[</span><span class="nl">TestServer</span><span class="p">:</span><span class="mf">0.0.0.0</span><span class="o">:</span><span class="mi">8888</span><span class="cp">#1] is down
</span><span class="cp"></span><span class="mi">20131024</span> <span class="mo">07</span><span class="o">:</span><span class="mi">21</span><span class="o">:</span><span class="mf">11.265588</span><span class="n">Z</span>  <span class="mi">8683</span> <span class="n">TRACE</span> <span class="n">handleClose</span> <span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="n">usecount</span><span class="o">=</span><span class="mi">3</span> <span class="o">-</span> <span class="n">TcpConnection</span><span class="p">.</span><span class="nl">cc</span><span class="p">:</span><span class="mi">305</span>
<span class="mi">20131024</span> <span class="mo">07</span><span class="o">:</span><span class="mi">21</span><span class="o">:</span><span class="mf">11.265604</span><span class="n">Z</span>  <span class="mi">8683</span> <span class="n">INFO</span>  <span class="n">TcpServer</span><span class="o">::</span><span class="n">removeConnectionInLoop</span> <span class="p">[</span><span class="n">TestServer</span><span class="p">]</span> <span class="o">-</span> <span class="n">connection</span> <span class="nl">TestServer</span><span class="p">:</span><span class="mf">0.0.0.0</span><span class="o">:</span><span class="mi">8888</span><span class="cp">#1 - TcpServer.cc:153
</span><span class="cp"></span><span class="mi">20131024</span> <span class="mo">07</span><span class="o">:</span><span class="mi">21</span><span class="o">:</span><span class="mf">11.265611</span><span class="n">Z</span>  <span class="mi">8683</span> <span class="n">TRACE</span> <span class="n">removeConnectionInLoop</span> <span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="n">usecount</span><span class="o">=</span><span class="mi">6</span> <span class="o">-</span> <span class="n">TcpServer</span><span class="p">.</span><span class="nl">cc</span><span class="p">:</span><span class="mi">157</span>
<span class="mi">20131024</span> <span class="mo">07</span><span class="o">:</span><span class="mi">21</span><span class="o">:</span><span class="mf">11.265626</span><span class="n">Z</span>  <span class="mi">8683</span> <span class="n">TRACE</span> <span class="n">removeConnectionInLoop</span> <span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="n">usecount</span><span class="o">=</span><span class="mi">5</span> <span class="o">-</span> <span class="n">TcpServer</span><span class="p">.</span><span class="nl">cc</span><span class="p">:</span><span class="mi">159</span>
<span class="mi">20131024</span> <span class="mo">07</span><span class="o">:</span><span class="mi">21</span><span class="o">:</span><span class="mf">11.265639</span><span class="n">Z</span>  <span class="mi">8683</span> <span class="n">TRACE</span> <span class="n">removeConnectionInLoop</span> <span class="p">[</span><span class="mi">10</span><span class="p">]</span> <span class="n">usecount</span><span class="o">=</span><span class="mi">6</span> <span class="o">-</span> <span class="n">TcpServer</span><span class="p">.</span><span class="nl">cc</span><span class="p">:</span><span class="mi">170</span>
<span class="mi">20131024</span> <span class="mo">07</span><span class="o">:</span><span class="mi">21</span><span class="o">:</span><span class="mf">11.265646</span><span class="n">Z</span>  <span class="mi">8683</span> <span class="n">TRACE</span> <span class="n">handleClose</span> <span class="p">[</span><span class="mi">11</span><span class="p">]</span> <span class="n">usecount</span><span class="o">=</span><span class="mi">3</span> <span class="o">-</span> <span class="n">TcpConnection</span><span class="p">.</span><span class="nl">cc</span><span class="p">:</span><span class="mi">308</span>
<span class="mi">20131024</span> <span class="mo">07</span><span class="o">:</span><span class="mi">21</span><span class="o">:</span><span class="mf">11.265652</span><span class="n">Z</span>  <span class="mi">8683</span> <span class="n">TRACE</span> <span class="n">handleEvent</span> <span class="p">[</span><span class="mi">12</span><span class="p">]</span> <span class="n">usecount</span><span class="o">=</span><span class="mi">2</span> <span class="o">-</span> <span class="n">Channel</span><span class="p">.</span><span class="nl">cc</span><span class="p">:</span><span class="mi">69</span>
<span class="mi">20131024</span> <span class="mo">07</span><span class="o">:</span><span class="mi">21</span><span class="o">:</span><span class="mf">11.265659</span><span class="n">Z</span>  <span class="mi">8683</span> <span class="n">TRACE</span> <span class="n">removeChannel</span> <span class="n">fd</span> <span class="o">=</span> <span class="mi">8</span> <span class="o">-</span> <span class="n">EPollPoller</span><span class="p">.</span><span class="nl">cc</span><span class="p">:</span><span class="mi">147</span>
<span class="mi">20131024</span> <span class="mo">07</span><span class="o">:</span><span class="mi">21</span><span class="o">:</span><span class="mf">11.265682</span><span class="n">Z</span>  <span class="mi">8683</span> <span class="n">DEBUG</span> <span class="o">~</span><span class="n">TcpConnection</span> <span class="n">TcpConnection</span><span class="o">::</span><span class="n">dtor</span><span class="p">[</span><span class="nl">TestServer</span><span class="p">:</span><span class="mf">0.0.0.0</span><span class="o">:</span><span class="mi">8888</span><span class="cp">#1] at 0x96C65D0 fd=8 - TcpConnection.cc:69
</span><span class="cp"></span><span class="mi">20131024</span> <span class="mo">07</span><span class="o">:</span><span class="mi">21</span><span class="o">:</span><span class="mf">21.275816</span><span class="n">Z</span>  <span class="mi">8683</span> <span class="n">TRACE</span> <span class="n">poll</span>  <span class="n">nothing</span> <span class="n">happended</span> <span class="o">-</span> <span class="n">EPollPoller</span><span class="p">.</span><span class="nl">cc</span><span class="p">:</span><span class="mi">74</span>
<span class="mi">20131024</span> <span class="mo">07</span><span class="o">:</span><span class="mi">21</span><span class="o">:</span><span class="mf">31.285830</span><span class="n">Z</span>  <span class="mi">8683</span> <span class="n">TRACE</span> <span class="n">poll</span>  <span class="n">nothing</span> <span class="n">happended</span> <span class="o">-</span> <span class="n">EPollPoller</span><span class="p">.</span><span class="nl">cc</span><span class="p">:</span><span class="mi">74</span>
<span class="mi">20131024</span> <span class="mo">07</span><span class="o">:</span><span class="mi">21</span><span class="o">:</span><span class="mf">41.296314</span><span class="n">Z</span>  <span class="mi">8683</span> <span class="n">TRACE</span> <span class="n">poll</span>  <span class="n">nothing</span> <span class="n">happended</span> <span class="o">-</span> <span class="n">EPollPoller</span><span class="p">.</span><span class="nl">cc</span><span class="p">:</span><span class="mi">74</span>
<span class="o">^</span><span class="n">C</span>
<span class="n">ubuntu</span><span class="err">@</span><span class="n">ubuntu</span><span class="o">-</span><span class="k">virtual</span><span class="o">-</span><span class="nl">machine</span><span class="p">:</span><span class="o">~/</span><span class="n">pro</span><span class="o">/</span><span class="mi">37</span><span class="err">$</span>
</code></pre></td></tr></table>
</div>
</div>
<p>客户端：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-c++" data-lang="c++"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c++" data-lang="c++"><span class="n">ubuntu</span><span class="err">@</span><span class="n">ubuntu</span><span class="o">-</span><span class="k">virtual</span><span class="o">-</span><span class="nl">machine</span><span class="p">:</span><span class="o">~/</span><span class="n">pro</span><span class="o">/</span><span class="mi">37</span><span class="err">$</span> <span class="p">.</span><span class="o">/</span><span class="n">a</span><span class="p">.</span><span class="n">out</span>
<span class="n">ret</span><span class="o">=</span><span class="mi">300</span>
<span class="n">AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBret</span><span class="o">=</span><span class="mi">0</span>
</code></pre></td></tr></table>
</div>
</div>
<h2 id="38-完善tcpconnection">[38] 完善TcpConnection</h2>

<p>完善<code>TcpConnection</code>
<code>WriteCompleteCallback</code>含义
<code>HighWaterMarkCallback</code>含义
<code>boost::any context_</code>
<code>signal(SIGPIPE, SIG_IGN)</code> // 请看<code>channel class</code>
可变类型解决方案
<code>void*.</code> 这种方法不是类型安全的
<code>boost::any</code>
<code>boost::any</code>
任意类型的类型安全存储以及安全的取回
在标准库容器中存放不同类型的方法，比如说<code>vector&lt;boost::any&gt;</code>
<code>TcpConnection</code> 完整的头文件</p>

<p>TcpConnection.h</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-c++" data-lang="c++"><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c++" data-lang="c++"><span class="c1">// Copyright 2010, Shuo Chen.  All rights reserved.
</span><span class="c1">// http://code.google.com/p/muduo/
</span><span class="c1">//
</span><span class="c1">// Use of this source code is governed by a BSD-style license
</span><span class="c1">// that can be found in the License file.
</span><span class="c1"></span> 
<span class="c1">// Author: Shuo Chen (chenshuo at chenshuo dot com)
</span><span class="c1">//
</span><span class="c1">// This is a public header file, it must only include public header files.
</span><span class="c1"></span> 
<span class="cp">#ifndef MUDUO_NET_TCPCONNECTION_H
</span><span class="cp">#define MUDUO_NET_TCPCONNECTION_H
</span><span class="cp"></span> 
<span class="cp">#include</span> <span class="cpf">&lt;muduo/base/Mutex.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;muduo/base/StringPiece.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;muduo/base/Types.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;muduo/net/Callbacks.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;muduo/net/Buffer.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;muduo/net/InetAddress.h&gt;</span><span class="cp">
</span><span class="cp"></span> 
<span class="cp">#include</span> <span class="cpf">&lt;boost/any.hpp&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;boost/enable_shared_from_this.hpp&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;boost/noncopyable.hpp&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;boost/scoped_ptr.hpp&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;boost/shared_ptr.hpp&gt;</span><span class="cp">
</span><span class="cp"></span> 
<span class="k">namespace</span> <span class="n">muduo</span>
<span class="p">{</span>
<span class="k">namespace</span> <span class="n">net</span>
<span class="p">{</span>
 
<span class="k">class</span><span class="err"> </span><span class="nc">Channel</span><span class="p">;</span>
<span class="k">class</span><span class="err"> </span><span class="nc">EventLoop</span><span class="p">;</span>
<span class="k">class</span><span class="err"> </span><span class="nc">Socket</span><span class="p">;</span>
 
<span class="c1">///
</span><span class="c1">/// TCP connection, for both client and server usage.
</span><span class="c1">///
</span><span class="c1">/// This is an interface class, so don&#39;t expose too much details.
</span><span class="c1"></span><span class="k">class</span><span class="err"> </span><span class="nc">TcpConnection</span> <span class="o">:</span> <span class="n">boost</span><span class="o">::</span><span class="n">noncopyable</span><span class="p">,</span>
                      <span class="k">public</span> <span class="n">boost</span><span class="o">::</span><span class="n">enable_shared_from_this</span><span class="o">&lt;</span><span class="n">TcpConnection</span><span class="o">&gt;</span>
<span class="p">{</span>
 <span class="k">public</span><span class="o">:</span>
  <span class="c1">/// Constructs a TcpConnection with a connected sockfd
</span><span class="c1"></span>  <span class="c1">///
</span><span class="c1"></span>  <span class="c1">/// User should not create this object.
</span><span class="c1"></span>  <span class="n">TcpConnection</span><span class="p">(</span><span class="n">EventLoop</span><span class="o">*</span> <span class="n">loop</span><span class="p">,</span>
                <span class="k">const</span> <span class="n">string</span><span class="o">&amp;</span> <span class="n">name</span><span class="p">,</span>
                <span class="kt">int</span> <span class="n">sockfd</span><span class="p">,</span>
                <span class="k">const</span> <span class="n">InetAddress</span><span class="o">&amp;</span> <span class="n">localAddr</span><span class="p">,</span>
                <span class="k">const</span> <span class="n">InetAddress</span><span class="o">&amp;</span> <span class="n">peerAddr</span><span class="p">);</span>
  <span class="o">~</span><span class="n">TcpConnection</span><span class="p">();</span>
 
  <span class="n">EventLoop</span><span class="o">*</span> <span class="nf">getLoop</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span> <span class="k">return</span> <span class="n">loop_</span><span class="p">;</span> <span class="p">}</span>
  <span class="k">const</span> <span class="n">string</span><span class="o">&amp;</span> <span class="n">name</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span> <span class="k">return</span> <span class="n">name_</span><span class="p">;</span> <span class="p">}</span>
  <span class="k">const</span> <span class="n">InetAddress</span><span class="o">&amp;</span> <span class="n">localAddress</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="n">localAddr_</span><span class="p">;</span> <span class="p">}</span>
  <span class="k">const</span> <span class="n">InetAddress</span><span class="o">&amp;</span> <span class="n">peerAddress</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="n">peerAddr_</span><span class="p">;</span> <span class="p">}</span>
  <span class="kt">bool</span> <span class="n">connected</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span> <span class="k">return</span> <span class="n">state_</span> <span class="o">==</span> <span class="n">kConnected</span><span class="p">;</span> <span class="p">}</span>
 
  <span class="c1">// void send(string&amp;&amp; message); // C++11
</span><span class="c1"></span>  <span class="kt">void</span> <span class="n">send</span><span class="p">(</span><span class="k">const</span> <span class="kt">void</span><span class="o">*</span> <span class="n">message</span><span class="p">,</span> <span class="n">size_t</span> <span class="n">len</span><span class="p">);</span>
  <span class="kt">void</span> <span class="nf">send</span><span class="p">(</span><span class="k">const</span> <span class="n">StringPiece</span><span class="o">&amp;</span> <span class="n">message</span><span class="p">);</span>
  <span class="c1">// void send(Buffer&amp;&amp; message); // C++11
</span><span class="c1"></span>  <span class="kt">void</span> <span class="nf">send</span><span class="p">(</span><span class="n">Buffer</span><span class="o">*</span> <span class="n">message</span><span class="p">);</span>  <span class="c1">// this one will swap data
</span><span class="c1"></span>  <span class="kt">void</span> <span class="nf">shutdown</span><span class="p">();</span> <span class="c1">// NOT thread safe, no simultaneous calling
</span><span class="c1"></span>  <span class="kt">void</span> <span class="nf">setTcpNoDelay</span><span class="p">(</span><span class="kt">bool</span> <span class="n">on</span><span class="p">);</span>
 
  <span class="kt">void</span> <span class="nf">setContext</span><span class="p">(</span><span class="k">const</span> <span class="n">boost</span><span class="o">::</span><span class="n">any</span><span class="o">&amp;</span> <span class="n">context</span><span class="p">)</span>
  <span class="p">{</span> <span class="n">context_</span> <span class="o">=</span> <span class="n">context</span><span class="p">;</span> <span class="p">}</span>
 
  <span class="k">const</span> <span class="n">boost</span><span class="o">::</span><span class="n">any</span><span class="o">&amp;</span> <span class="n">getContext</span><span class="p">()</span> <span class="k">const</span>
  <span class="p">{</span> <span class="k">return</span> <span class="n">context_</span><span class="p">;</span> <span class="p">}</span>
 
  <span class="n">boost</span><span class="o">::</span><span class="n">any</span><span class="o">*</span> <span class="n">getMutableContext</span><span class="p">()</span>
  <span class="p">{</span> <span class="k">return</span> <span class="o">&amp;</span><span class="n">context_</span><span class="p">;</span> <span class="p">}</span>
 
  <span class="kt">void</span> <span class="n">setConnectionCallback</span><span class="p">(</span><span class="k">const</span> <span class="n">ConnectionCallback</span><span class="o">&amp;</span> <span class="n">cb</span><span class="p">)</span>
  <span class="p">{</span> <span class="n">connectionCallback_</span> <span class="o">=</span> <span class="n">cb</span><span class="p">;</span> <span class="p">}</span>
 
  <span class="kt">void</span> <span class="n">setMessageCallback</span><span class="p">(</span><span class="k">const</span> <span class="n">MessageCallback</span><span class="o">&amp;</span> <span class="n">cb</span><span class="p">)</span>
  <span class="p">{</span> <span class="n">messageCallback_</span> <span class="o">=</span> <span class="n">cb</span><span class="p">;</span> <span class="p">}</span>
 
  <span class="kt">void</span> <span class="n">setWriteCompleteCallback</span><span class="p">(</span><span class="k">const</span> <span class="n">WriteCompleteCallback</span><span class="o">&amp;</span> <span class="n">cb</span><span class="p">)</span>
  <span class="p">{</span> <span class="n">writeCompleteCallback_</span> <span class="o">=</span> <span class="n">cb</span><span class="p">;</span> <span class="p">}</span>
 
  <span class="kt">void</span> <span class="n">setHighWaterMarkCallback</span><span class="p">(</span><span class="k">const</span> <span class="n">HighWaterMarkCallback</span><span class="o">&amp;</span> <span class="n">cb</span><span class="p">,</span> <span class="n">size_t</span> <span class="n">highWaterMark</span><span class="p">)</span>
  <span class="p">{</span> <span class="n">highWaterMarkCallback_</span> <span class="o">=</span> <span class="n">cb</span><span class="p">;</span> <span class="n">highWaterMark_</span> <span class="o">=</span> <span class="n">highWaterMark</span><span class="p">;</span> <span class="p">}</span>
 
  <span class="n">Buffer</span><span class="o">*</span> <span class="n">inputBuffer</span><span class="p">()</span>
  <span class="p">{</span> <span class="k">return</span> <span class="o">&amp;</span><span class="n">inputBuffer_</span><span class="p">;</span> <span class="p">}</span>
 
  <span class="c1">/// Internal use only.
</span><span class="c1"></span>  <span class="kt">void</span> <span class="n">setCloseCallback</span><span class="p">(</span><span class="k">const</span> <span class="n">CloseCallback</span><span class="o">&amp;</span> <span class="n">cb</span><span class="p">)</span>
  <span class="p">{</span> <span class="n">closeCallback_</span> <span class="o">=</span> <span class="n">cb</span><span class="p">;</span> <span class="p">}</span>
 
  <span class="c1">// called when TcpServer accepts a new connection
</span><span class="c1"></span>  <span class="kt">void</span> <span class="n">connectEstablished</span><span class="p">();</span>   <span class="c1">// should be called only once
</span><span class="c1"></span>  <span class="c1">// called when TcpServer has removed me from its map
</span><span class="c1"></span>  <span class="kt">void</span> <span class="nf">connectDestroyed</span><span class="p">();</span>  <span class="c1">// should be called only once
</span><span class="c1"></span> 
 <span class="k">private</span><span class="o">:</span>
  <span class="k">enum</span> <span class="n">StateE</span> <span class="p">{</span> <span class="n">kDisconnected</span><span class="p">,</span> <span class="n">kConnecting</span><span class="p">,</span> <span class="n">kConnected</span><span class="p">,</span> <span class="n">kDisconnecting</span> <span class="p">};</span>
  <span class="kt">void</span> <span class="nf">handleRead</span><span class="p">(</span><span class="n">Timestamp</span> <span class="n">receiveTime</span><span class="p">);</span>
  <span class="kt">void</span> <span class="nf">handleWrite</span><span class="p">();</span>
  <span class="kt">void</span> <span class="nf">handleClose</span><span class="p">();</span>
  <span class="kt">void</span> <span class="nf">handleError</span><span class="p">();</span>
  <span class="kt">void</span> <span class="nf">sendInLoop</span><span class="p">(</span><span class="k">const</span> <span class="n">StringPiece</span><span class="o">&amp;</span> <span class="n">message</span><span class="p">);</span>
  <span class="kt">void</span> <span class="nf">sendInLoop</span><span class="p">(</span><span class="k">const</span> <span class="kt">void</span><span class="o">*</span> <span class="n">message</span><span class="p">,</span> <span class="n">size_t</span> <span class="n">len</span><span class="p">);</span>
  <span class="kt">void</span> <span class="nf">shutdownInLoop</span><span class="p">();</span>
  <span class="kt">void</span> <span class="nf">setState</span><span class="p">(</span><span class="n">StateE</span> <span class="n">s</span><span class="p">)</span> <span class="p">{</span> <span class="n">state_</span> <span class="o">=</span> <span class="n">s</span><span class="p">;</span> <span class="p">}</span>
 
  <span class="n">EventLoop</span><span class="o">*</span> <span class="n">loop_</span><span class="p">;</span>         <span class="c1">// 所属EventLoop
</span><span class="c1"></span>  <span class="n">string</span> <span class="n">name_</span><span class="p">;</span>             <span class="c1">// 连接名
</span><span class="c1"></span>  <span class="n">StateE</span> <span class="n">state_</span><span class="p">;</span>  <span class="c1">// FIXME: use atomic variable
</span><span class="c1"></span>  <span class="c1">// we don&#39;t expose those classes to client.
</span><span class="c1"></span>  <span class="n">boost</span><span class="o">::</span><span class="n">scoped_ptr</span><span class="o">&lt;</span><span class="n">Socket</span><span class="o">&gt;</span> <span class="n">socket_</span><span class="p">;</span>
  <span class="n">boost</span><span class="o">::</span><span class="n">scoped_ptr</span><span class="o">&lt;</span><span class="n">Channel</span><span class="o">&gt;</span> <span class="n">channel_</span><span class="p">;</span>
  <span class="n">InetAddress</span> <span class="n">localAddr_</span><span class="p">;</span>
  <span class="n">InetAddress</span> <span class="n">peerAddr_</span><span class="p">;</span>
  <span class="n">ConnectionCallback</span> <span class="n">connectionCallback_</span><span class="p">;</span>
  <span class="n">MessageCallback</span> <span class="n">messageCallback_</span><span class="p">;</span>
  <span class="n">WriteCompleteCallback</span> <span class="n">writeCompleteCallback_</span><span class="p">;</span>     <span class="c1">// 数据发送完毕回调函数，即所有的用户数据都已拷贝到内核缓冲区时回调该函数
</span><span class="c1"></span>                                                    <span class="c1">// outputBuffer_被清空也会回调该函数，可以理解为低水位标回调函数
</span><span class="c1"></span>  <span class="n">HighWaterMarkCallback</span> <span class="n">highWaterMarkCallback_</span><span class="p">;</span>     <span class="c1">// 高水位标回调函数
</span><span class="c1"></span>  <span class="n">CloseCallback</span> <span class="n">closeCallback_</span><span class="p">;</span>
  <span class="n">size_t</span> <span class="n">highWaterMark_</span><span class="p">;</span>        <span class="c1">// 高水位标
</span><span class="c1"></span>  <span class="n">Buffer</span> <span class="n">inputBuffer_</span><span class="p">;</span>          <span class="c1">// 应用层接收缓冲区
</span><span class="c1"></span>  <span class="n">Buffer</span> <span class="n">outputBuffer_</span><span class="p">;</span>         <span class="c1">// 应用层发送缓冲区
</span><span class="c1"></span>  <span class="n">boost</span><span class="o">::</span><span class="n">any</span> <span class="n">context_</span><span class="p">;</span>          <span class="c1">// 绑定一个未知类型的上下文对象
</span><span class="c1"></span><span class="p">};</span>
 
<span class="k">typedef</span> <span class="n">boost</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">TcpConnection</span><span class="o">&gt;</span> <span class="n">TcpConnectionPtr</span><span class="p">;</span>
 
<span class="p">}</span>
<span class="p">}</span>
 
<span class="cp">#endif  </span><span class="c1">// MUDUO_NET_TCPCONNECTION_H
</span></code></pre></td></tr></table>
</div>
</div>
<h3 id="tcpconnection-完整的源文件">TcpConnection 完整的源文件</h3>

<p>TcpConnection.cc</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-c++" data-lang="c++"><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span><span class="lnt">177
</span><span class="lnt">178
</span><span class="lnt">179
</span><span class="lnt">180
</span><span class="lnt">181
</span><span class="lnt">182
</span><span class="lnt">183
</span><span class="lnt">184
</span><span class="lnt">185
</span><span class="lnt">186
</span><span class="lnt">187
</span><span class="lnt">188
</span><span class="lnt">189
</span><span class="lnt">190
</span><span class="lnt">191
</span><span class="lnt">192
</span><span class="lnt">193
</span><span class="lnt">194
</span><span class="lnt">195
</span><span class="lnt">196
</span><span class="lnt">197
</span><span class="lnt">198
</span><span class="lnt">199
</span><span class="lnt">200
</span><span class="lnt">201
</span><span class="lnt">202
</span><span class="lnt">203
</span><span class="lnt">204
</span><span class="lnt">205
</span><span class="lnt">206
</span><span class="lnt">207
</span><span class="lnt">208
</span><span class="lnt">209
</span><span class="lnt">210
</span><span class="lnt">211
</span><span class="lnt">212
</span><span class="lnt">213
</span><span class="lnt">214
</span><span class="lnt">215
</span><span class="lnt">216
</span><span class="lnt">217
</span><span class="lnt">218
</span><span class="lnt">219
</span><span class="lnt">220
</span><span class="lnt">221
</span><span class="lnt">222
</span><span class="lnt">223
</span><span class="lnt">224
</span><span class="lnt">225
</span><span class="lnt">226
</span><span class="lnt">227
</span><span class="lnt">228
</span><span class="lnt">229
</span><span class="lnt">230
</span><span class="lnt">231
</span><span class="lnt">232
</span><span class="lnt">233
</span><span class="lnt">234
</span><span class="lnt">235
</span><span class="lnt">236
</span><span class="lnt">237
</span><span class="lnt">238
</span><span class="lnt">239
</span><span class="lnt">240
</span><span class="lnt">241
</span><span class="lnt">242
</span><span class="lnt">243
</span><span class="lnt">244
</span><span class="lnt">245
</span><span class="lnt">246
</span><span class="lnt">247
</span><span class="lnt">248
</span><span class="lnt">249
</span><span class="lnt">250
</span><span class="lnt">251
</span><span class="lnt">252
</span><span class="lnt">253
</span><span class="lnt">254
</span><span class="lnt">255
</span><span class="lnt">256
</span><span class="lnt">257
</span><span class="lnt">258
</span><span class="lnt">259
</span><span class="lnt">260
</span><span class="lnt">261
</span><span class="lnt">262
</span><span class="lnt">263
</span><span class="lnt">264
</span><span class="lnt">265
</span><span class="lnt">266
</span><span class="lnt">267
</span><span class="lnt">268
</span><span class="lnt">269
</span><span class="lnt">270
</span><span class="lnt">271
</span><span class="lnt">272
</span><span class="lnt">273
</span><span class="lnt">274
</span><span class="lnt">275
</span><span class="lnt">276
</span><span class="lnt">277
</span><span class="lnt">278
</span><span class="lnt">279
</span><span class="lnt">280
</span><span class="lnt">281
</span><span class="lnt">282
</span><span class="lnt">283
</span><span class="lnt">284
</span><span class="lnt">285
</span><span class="lnt">286
</span><span class="lnt">287
</span><span class="lnt">288
</span><span class="lnt">289
</span><span class="lnt">290
</span><span class="lnt">291
</span><span class="lnt">292
</span><span class="lnt">293
</span><span class="lnt">294
</span><span class="lnt">295
</span><span class="lnt">296
</span><span class="lnt">297
</span><span class="lnt">298
</span><span class="lnt">299
</span><span class="lnt">300
</span><span class="lnt">301
</span><span class="lnt">302
</span><span class="lnt">303
</span><span class="lnt">304
</span><span class="lnt">305
</span><span class="lnt">306
</span><span class="lnt">307
</span><span class="lnt">308
</span><span class="lnt">309
</span><span class="lnt">310
</span><span class="lnt">311
</span><span class="lnt">312
</span><span class="lnt">313
</span><span class="lnt">314
</span><span class="lnt">315
</span><span class="lnt">316
</span><span class="lnt">317
</span><span class="lnt">318
</span><span class="lnt">319
</span><span class="lnt">320
</span><span class="lnt">321
</span><span class="lnt">322
</span><span class="lnt">323
</span><span class="lnt">324
</span><span class="lnt">325
</span><span class="lnt">326
</span><span class="lnt">327
</span><span class="lnt">328
</span><span class="lnt">329
</span><span class="lnt">330
</span><span class="lnt">331
</span><span class="lnt">332
</span><span class="lnt">333
</span><span class="lnt">334
</span><span class="lnt">335
</span><span class="lnt">336
</span><span class="lnt">337
</span><span class="lnt">338
</span><span class="lnt">339
</span><span class="lnt">340
</span><span class="lnt">341
</span><span class="lnt">342
</span><span class="lnt">343
</span><span class="lnt">344
</span><span class="lnt">345
</span><span class="lnt">346
</span><span class="lnt">347
</span><span class="lnt">348
</span><span class="lnt">349
</span><span class="lnt">350
</span><span class="lnt">351
</span><span class="lnt">352
</span><span class="lnt">353
</span><span class="lnt">354
</span><span class="lnt">355
</span><span class="lnt">356
</span><span class="lnt">357
</span><span class="lnt">358
</span><span class="lnt">359
</span><span class="lnt">360
</span><span class="lnt">361
</span><span class="lnt">362
</span><span class="lnt">363
</span><span class="lnt">364
</span><span class="lnt">365
</span><span class="lnt">366
</span><span class="lnt">367
</span><span class="lnt">368
</span><span class="lnt">369
</span><span class="lnt">370
</span><span class="lnt">371
</span><span class="lnt">372
</span><span class="lnt">373
</span><span class="lnt">374
</span><span class="lnt">375
</span><span class="lnt">376
</span><span class="lnt">377
</span><span class="lnt">378
</span><span class="lnt">379
</span><span class="lnt">380
</span><span class="lnt">381
</span><span class="lnt">382
</span><span class="lnt">383
</span><span class="lnt">384
</span><span class="lnt">385
</span><span class="lnt">386
</span><span class="lnt">387
</span><span class="lnt">388
</span><span class="lnt">389
</span><span class="lnt">390
</span><span class="lnt">391
</span><span class="lnt">392
</span><span class="lnt">393
</span><span class="lnt">394
</span><span class="lnt">395
</span><span class="lnt">396
</span><span class="lnt">397
</span><span class="lnt">398
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c++" data-lang="c++"><span class="c1">// Copyright 2010, Shuo Chen.  All rights reserved.
</span><span class="c1">// http://code.google.com/p/muduo/
</span><span class="c1">//
</span><span class="c1">// Use of this source code is governed by a BSD-style license
</span><span class="c1">// that can be found in the License file.
</span><span class="c1"></span> 
<span class="c1">// Author: Shuo Chen (chenshuo at chenshuo dot com)
</span><span class="c1"></span> 
<span class="cp">#include</span> <span class="cpf">&lt;muduo/net/TcpConnection.h&gt;</span><span class="cp">
</span><span class="cp"></span> 
<span class="cp">#include</span> <span class="cpf">&lt;muduo/base/Logging.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;muduo/net/Channel.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;muduo/net/EventLoop.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;muduo/net/Socket.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;muduo/net/SocketsOps.h&gt;</span><span class="cp">
</span><span class="cp"></span> 
<span class="cp">#include</span> <span class="cpf">&lt;boost/bind.hpp&gt;</span><span class="cp">
</span><span class="cp"></span> 
<span class="cp">#include</span> <span class="cpf">&lt;errno.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
</span><span class="cp"></span> 
<span class="k">using</span> <span class="k">namespace</span> <span class="n">muduo</span><span class="p">;</span>
<span class="k">using</span> <span class="k">namespace</span> <span class="n">muduo</span><span class="o">::</span><span class="n">net</span><span class="p">;</span>
 
<span class="kt">void</span> <span class="n">muduo</span><span class="o">::</span><span class="n">net</span><span class="o">::</span><span class="n">defaultConnectionCallback</span><span class="p">(</span><span class="k">const</span> <span class="n">TcpConnectionPtr</span><span class="o">&amp;</span> <span class="n">conn</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">LOG_TRACE</span> <span class="o">&lt;&lt;</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">localAddress</span><span class="p">().</span><span class="n">toIpPort</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="s">&#34; -&gt; &#34;</span>
            <span class="o">&lt;&lt;</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">peerAddress</span><span class="p">().</span><span class="n">toIpPort</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="s">&#34; is &#34;</span>
            <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">connected</span><span class="p">()</span> <span class="o">?</span> <span class="s">&#34;UP&#34;</span> <span class="o">:</span> <span class="s">&#34;DOWN&#34;</span><span class="p">);</span>
<span class="p">}</span>
 
<span class="kt">void</span> <span class="n">muduo</span><span class="o">::</span><span class="n">net</span><span class="o">::</span><span class="n">defaultMessageCallback</span><span class="p">(</span><span class="k">const</span> <span class="n">TcpConnectionPtr</span><span class="o">&amp;</span><span class="p">,</span>
                                        <span class="n">Buffer</span><span class="o">*</span> <span class="n">buf</span><span class="p">,</span>
                                        <span class="n">Timestamp</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">buf</span><span class="o">-&gt;</span><span class="n">retrieveAll</span><span class="p">();</span>
<span class="p">}</span>
 
<span class="n">TcpConnection</span><span class="o">::</span><span class="n">TcpConnection</span><span class="p">(</span><span class="n">EventLoop</span><span class="o">*</span> <span class="n">loop</span><span class="p">,</span>
                             <span class="k">const</span> <span class="n">string</span><span class="o">&amp;</span> <span class="n">nameArg</span><span class="p">,</span>
                             <span class="kt">int</span> <span class="n">sockfd</span><span class="p">,</span>
                             <span class="k">const</span> <span class="n">InetAddress</span><span class="o">&amp;</span> <span class="n">localAddr</span><span class="p">,</span>
                             <span class="k">const</span> <span class="n">InetAddress</span><span class="o">&amp;</span> <span class="n">peerAddr</span><span class="p">)</span>
  <span class="o">:</span> <span class="n">loop_</span><span class="p">(</span><span class="n">CHECK_NOTNULL</span><span class="p">(</span><span class="n">loop</span><span class="p">)),</span>
    <span class="n">name_</span><span class="p">(</span><span class="n">nameArg</span><span class="p">),</span>
    <span class="n">state_</span><span class="p">(</span><span class="n">kConnecting</span><span class="p">),</span>
    <span class="n">socket_</span><span class="p">(</span><span class="k">new</span> <span class="n">Socket</span><span class="p">(</span><span class="n">sockfd</span><span class="p">)),</span>
    <span class="n">channel_</span><span class="p">(</span><span class="k">new</span> <span class="n">Channel</span><span class="p">(</span><span class="n">loop</span><span class="p">,</span> <span class="n">sockfd</span><span class="p">)),</span>
    <span class="n">localAddr_</span><span class="p">(</span><span class="n">localAddr</span><span class="p">),</span>
    <span class="n">peerAddr_</span><span class="p">(</span><span class="n">peerAddr</span><span class="p">),</span>
    <span class="n">highWaterMark_</span><span class="p">(</span><span class="mi">64</span><span class="o">*</span><span class="mi">1024</span><span class="o">*</span><span class="mi">1024</span><span class="p">)</span>
<span class="p">{</span>
  <span class="c1">// 通道可读事件到来的时候，回调TcpConnection::handleRead，_1是事件发生时间
</span><span class="c1"></span>  <span class="n">channel_</span><span class="o">-&gt;</span><span class="n">setReadCallback</span><span class="p">(</span>
      <span class="n">boost</span><span class="o">::</span><span class="n">bind</span><span class="p">(</span><span class="o">&amp;</span><span class="n">TcpConnection</span><span class="o">::</span><span class="n">handleRead</span><span class="p">,</span> <span class="k">this</span><span class="p">,</span> <span class="n">_1</span><span class="p">));</span>
  <span class="c1">// 通道可写事件到来的时候，回调TcpConnection::handleWrite
</span><span class="c1"></span>  <span class="n">channel_</span><span class="o">-&gt;</span><span class="n">setWriteCallback</span><span class="p">(</span>
      <span class="n">boost</span><span class="o">::</span><span class="n">bind</span><span class="p">(</span><span class="o">&amp;</span><span class="n">TcpConnection</span><span class="o">::</span><span class="n">handleWrite</span><span class="p">,</span> <span class="k">this</span><span class="p">));</span>
  <span class="c1">// 连接关闭，回调TcpConnection::handleClose
</span><span class="c1"></span>  <span class="n">channel_</span><span class="o">-&gt;</span><span class="n">setCloseCallback</span><span class="p">(</span>
      <span class="n">boost</span><span class="o">::</span><span class="n">bind</span><span class="p">(</span><span class="o">&amp;</span><span class="n">TcpConnection</span><span class="o">::</span><span class="n">handleClose</span><span class="p">,</span> <span class="k">this</span><span class="p">));</span>
  <span class="c1">// 发生错误，回调TcpConnection::handleError
</span><span class="c1"></span>  <span class="n">channel_</span><span class="o">-&gt;</span><span class="n">setErrorCallback</span><span class="p">(</span>
      <span class="n">boost</span><span class="o">::</span><span class="n">bind</span><span class="p">(</span><span class="o">&amp;</span><span class="n">TcpConnection</span><span class="o">::</span><span class="n">handleError</span><span class="p">,</span> <span class="k">this</span><span class="p">));</span>
  <span class="n">LOG_DEBUG</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;TcpConnection::ctor[&#34;</span> <span class="o">&lt;&lt;</span>  <span class="n">name_</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;] at &#34;</span> <span class="o">&lt;&lt;</span> <span class="k">this</span>
            <span class="o">&lt;&lt;</span> <span class="s">&#34; fd=&#34;</span> <span class="o">&lt;&lt;</span> <span class="n">sockfd</span><span class="p">;</span>
  <span class="n">socket_</span><span class="o">-&gt;</span><span class="n">setKeepAlive</span><span class="p">(</span><span class="nb">true</span><span class="p">);</span>
<span class="p">}</span>
 
<span class="n">TcpConnection</span><span class="o">::~</span><span class="n">TcpConnection</span><span class="p">()</span>
<span class="p">{</span>
  <span class="n">LOG_DEBUG</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;TcpConnection::dtor[&#34;</span> <span class="o">&lt;&lt;</span>  <span class="n">name_</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;] at &#34;</span> <span class="o">&lt;&lt;</span> <span class="k">this</span>
            <span class="o">&lt;&lt;</span> <span class="s">&#34; fd=&#34;</span> <span class="o">&lt;&lt;</span> <span class="n">channel_</span><span class="o">-&gt;</span><span class="n">fd</span><span class="p">();</span>
<span class="p">}</span>
 
<span class="c1">// 线程安全，可以跨线程调用
</span><span class="c1"></span><span class="kt">void</span> <span class="n">TcpConnection</span><span class="o">::</span><span class="n">send</span><span class="p">(</span><span class="k">const</span> <span class="kt">void</span><span class="o">*</span> <span class="n">data</span><span class="p">,</span> <span class="n">size_t</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">state_</span> <span class="o">==</span> <span class="n">kConnected</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">loop_</span><span class="o">-&gt;</span><span class="n">isInLoopThread</span><span class="p">())</span>
    <span class="p">{</span>
      <span class="n">sendInLoop</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">else</span>
    <span class="p">{</span>
      <span class="n">string</span> <span class="n">message</span><span class="p">(</span><span class="k">static_cast</span><span class="o">&lt;</span><span class="k">const</span> <span class="kt">char</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">data</span><span class="p">),</span> <span class="n">len</span><span class="p">);</span>
      <span class="n">loop_</span><span class="o">-&gt;</span><span class="n">runInLoop</span><span class="p">(</span>
          <span class="n">boost</span><span class="o">::</span><span class="n">bind</span><span class="p">(</span><span class="o">&amp;</span><span class="n">TcpConnection</span><span class="o">::</span><span class="n">sendInLoop</span><span class="p">,</span>
                      <span class="k">this</span><span class="p">,</span>
                      <span class="n">message</span><span class="p">));</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
 
<span class="c1">// 线程安全，可以跨线程调用
</span><span class="c1"></span><span class="kt">void</span> <span class="n">TcpConnection</span><span class="o">::</span><span class="n">send</span><span class="p">(</span><span class="k">const</span> <span class="n">StringPiece</span><span class="o">&amp;</span> <span class="n">message</span><span class="p">)</span>
<span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">state_</span> <span class="o">==</span> <span class="n">kConnected</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">loop_</span><span class="o">-&gt;</span><span class="n">isInLoopThread</span><span class="p">())</span>
    <span class="p">{</span>
      <span class="n">sendInLoop</span><span class="p">(</span><span class="n">message</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">else</span>
    <span class="p">{</span>
      <span class="n">loop_</span><span class="o">-&gt;</span><span class="n">runInLoop</span><span class="p">(</span>
          <span class="n">boost</span><span class="o">::</span><span class="n">bind</span><span class="p">(</span><span class="o">&amp;</span><span class="n">TcpConnection</span><span class="o">::</span><span class="n">sendInLoop</span><span class="p">,</span>
                      <span class="k">this</span><span class="p">,</span>
                      <span class="n">message</span><span class="p">.</span><span class="n">as_string</span><span class="p">()));</span>
                    <span class="c1">//std::forward&lt;string&gt;(message)));
</span><span class="c1"></span>    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
 
<span class="c1">// 线程安全，可以跨线程调用
</span><span class="c1"></span><span class="kt">void</span> <span class="n">TcpConnection</span><span class="o">::</span><span class="n">send</span><span class="p">(</span><span class="n">Buffer</span><span class="o">*</span> <span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">state_</span> <span class="o">==</span> <span class="n">kConnected</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">loop_</span><span class="o">-&gt;</span><span class="n">isInLoopThread</span><span class="p">())</span>
    <span class="p">{</span>
      <span class="n">sendInLoop</span><span class="p">(</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">peek</span><span class="p">(),</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">readableBytes</span><span class="p">());</span>
      <span class="n">buf</span><span class="o">-&gt;</span><span class="n">retrieveAll</span><span class="p">();</span>
    <span class="p">}</span>
    <span class="k">else</span>
    <span class="p">{</span>
      <span class="n">loop_</span><span class="o">-&gt;</span><span class="n">runInLoop</span><span class="p">(</span>
          <span class="n">boost</span><span class="o">::</span><span class="n">bind</span><span class="p">(</span><span class="o">&amp;</span><span class="n">TcpConnection</span><span class="o">::</span><span class="n">sendInLoop</span><span class="p">,</span>
                      <span class="k">this</span><span class="p">,</span>
                      <span class="n">buf</span><span class="o">-&gt;</span><span class="n">retrieveAllAsString</span><span class="p">()));</span>
                    <span class="c1">//std::forward&lt;string&gt;(message)));
</span><span class="c1"></span>    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
 
<span class="kt">void</span> <span class="n">TcpConnection</span><span class="o">::</span><span class="n">sendInLoop</span><span class="p">(</span><span class="k">const</span> <span class="n">StringPiece</span><span class="o">&amp;</span> <span class="n">message</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">sendInLoop</span><span class="p">(</span><span class="n">message</span><span class="p">.</span><span class="n">data</span><span class="p">(),</span> <span class="n">message</span><span class="p">.</span><span class="n">size</span><span class="p">());</span>
<span class="p">}</span>
 
<span class="kt">void</span> <span class="n">TcpConnection</span><span class="o">::</span><span class="n">sendInLoop</span><span class="p">(</span><span class="k">const</span> <span class="kt">void</span><span class="o">*</span> <span class="n">data</span><span class="p">,</span> <span class="n">size_t</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
  <span class="cm">/*
</span><span class="cm">  loop_-&gt;assertInLoopThread();
</span><span class="cm">  sockets::write(channel_-&gt;fd(), data, len);
</span><span class="cm">  */</span>
 
  <span class="n">loop_</span><span class="o">-&gt;</span><span class="n">assertInLoopThread</span><span class="p">();</span>
  <span class="n">ssize_t</span> <span class="n">nwrote</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">size_t</span> <span class="n">remaining</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>
  <span class="kt">bool</span> <span class="n">error</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">state_</span> <span class="o">==</span> <span class="n">kDisconnected</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">LOG_WARN</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;disconnected, give up writing&#34;</span><span class="p">;</span>
    <span class="k">return</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="c1">// if no thing in output queue, try writing directly
</span><span class="c1"></span>  <span class="c1">// 通道没有关注可写事件并且发送缓冲区没有数据，直接write
</span><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">channel_</span><span class="o">-&gt;</span><span class="n">isWriting</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="n">outputBuffer_</span><span class="p">.</span><span class="n">readableBytes</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">nwrote</span> <span class="o">=</span> <span class="n">sockets</span><span class="o">::</span><span class="n">write</span><span class="p">(</span><span class="n">channel_</span><span class="o">-&gt;</span><span class="n">fd</span><span class="p">(),</span> <span class="n">data</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">nwrote</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">remaining</span> <span class="o">=</span> <span class="n">len</span> <span class="o">-</span> <span class="n">nwrote</span><span class="p">;</span>
      <span class="c1">// 写完了，回调writeCompleteCallback_
</span><span class="c1"></span>      <span class="k">if</span> <span class="p">(</span><span class="n">remaining</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">writeCompleteCallback_</span><span class="p">)</span>
      <span class="p">{</span>
        <span class="n">loop_</span><span class="o">-&gt;</span><span class="n">queueInLoop</span><span class="p">(</span><span class="n">boost</span><span class="o">::</span><span class="n">bind</span><span class="p">(</span><span class="n">writeCompleteCallback_</span><span class="p">,</span> <span class="n">shared_from_this</span><span class="p">()));</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="c1">// nwrote &lt; 0
</span><span class="c1"></span>    <span class="p">{</span>
      <span class="n">nwrote</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">errno</span> <span class="o">!=</span> <span class="n">EWOULDBLOCK</span><span class="p">)</span>
      <span class="p">{</span>
        <span class="n">LOG_SYSERR</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;TcpConnection::sendInLoop&#34;</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">errno</span> <span class="o">==</span> <span class="n">EPIPE</span><span class="p">)</span> <span class="c1">// FIXME: any others?
</span><span class="c1"></span>        <span class="p">{</span>
          <span class="n">error</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
 
  <span class="n">assert</span><span class="p">(</span><span class="n">remaining</span> <span class="o">&lt;=</span> <span class="n">len</span><span class="p">);</span>
  <span class="c1">// 没有错误，并且还有未写完的数据（说明内核发送缓冲区满，要将未写完的数据添加到output buffer中）
</span><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">error</span> <span class="o">&amp;&amp;</span> <span class="n">remaining</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">LOG_TRACE</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;I am going to write more data&#34;</span><span class="p">;</span>
    <span class="n">size_t</span> <span class="n">oldLen</span> <span class="o">=</span> <span class="n">outputBuffer_</span><span class="p">.</span><span class="n">readableBytes</span><span class="p">();</span>
    <span class="c1">// 如果超过highWaterMark_（高水位标），回调highWaterMarkCallback_
</span><span class="c1"></span>    <span class="c1">//即使oldLen + remaining &gt;= highWaterMark_ ，remain的数据也是可以存放到buffer中的，因为buffer
</span><span class="c1"></span>    <span class="c1">//自动伸缩的
</span><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">oldLen</span> <span class="o">+</span> <span class="n">remaining</span> <span class="o">&gt;=</span> <span class="n">highWaterMark_</span>
        <span class="o">&amp;&amp;</span> <span class="n">oldLen</span> <span class="o">&lt;</span> <span class="n">highWaterMark_</span>
        <span class="o">&amp;&amp;</span> <span class="n">highWaterMarkCallback_</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">loop_</span><span class="o">-&gt;</span><span class="n">queueInLoop</span><span class="p">(</span><span class="n">boost</span><span class="o">::</span><span class="n">bind</span><span class="p">(</span><span class="n">highWaterMarkCallback_</span><span class="p">,</span> <span class="n">shared_from_this</span><span class="p">(),</span> <span class="n">oldLen</span> <span class="o">+</span> <span class="n">remaining</span><span class="p">));</span>
    <span class="p">}</span>
    <span class="n">outputBuffer_</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="k">static_cast</span><span class="o">&lt;</span><span class="k">const</span> <span class="kt">char</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="o">+</span><span class="n">nwrote</span><span class="p">,</span> <span class="n">remaining</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">channel_</span><span class="o">-&gt;</span><span class="n">isWriting</span><span class="p">())</span>
    <span class="p">{</span>
      <span class="n">channel_</span><span class="o">-&gt;</span><span class="n">enableWriting</span><span class="p">();</span>     <span class="c1">// 关注POLLOUT事件
</span><span class="c1"></span>    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
 
<span class="kt">void</span> <span class="n">TcpConnection</span><span class="o">::</span><span class="n">shutdown</span><span class="p">()</span>
<span class="p">{</span>
  <span class="c1">// FIXME: use compare and swap
</span><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="n">state_</span> <span class="o">==</span> <span class="n">kConnected</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">setState</span><span class="p">(</span><span class="n">kDisconnecting</span><span class="p">);</span>
    <span class="c1">// FIXME: shared_from_this()?
</span><span class="c1"></span>    <span class="n">loop_</span><span class="o">-&gt;</span><span class="n">runInLoop</span><span class="p">(</span><span class="n">boost</span><span class="o">::</span><span class="n">bind</span><span class="p">(</span><span class="o">&amp;</span><span class="n">TcpConnection</span><span class="o">::</span><span class="n">shutdownInLoop</span><span class="p">,</span> <span class="k">this</span><span class="p">));</span>
  <span class="p">}</span>
<span class="p">}</span>
 
<span class="kt">void</span> <span class="n">TcpConnection</span><span class="o">::</span><span class="n">shutdownInLoop</span><span class="p">()</span>
<span class="p">{</span>
  <span class="n">loop_</span><span class="o">-&gt;</span><span class="n">assertInLoopThread</span><span class="p">();</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">channel_</span><span class="o">-&gt;</span><span class="n">isWriting</span><span class="p">())</span>
  <span class="p">{</span>
    <span class="c1">// we are not writing
</span><span class="c1"></span>    <span class="n">socket_</span><span class="o">-&gt;</span><span class="n">shutdownWrite</span><span class="p">();</span>
  <span class="p">}</span>
<span class="p">}</span>
 
<span class="kt">void</span> <span class="n">TcpConnection</span><span class="o">::</span><span class="n">setTcpNoDelay</span><span class="p">(</span><span class="kt">bool</span> <span class="n">on</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">socket_</span><span class="o">-&gt;</span><span class="n">setTcpNoDelay</span><span class="p">(</span><span class="n">on</span><span class="p">);</span>
<span class="p">}</span>
 
<span class="kt">void</span> <span class="n">TcpConnection</span><span class="o">::</span><span class="n">connectEstablished</span><span class="p">()</span>
<span class="p">{</span>
  <span class="n">loop_</span><span class="o">-&gt;</span><span class="n">assertInLoopThread</span><span class="p">();</span>
  <span class="n">assert</span><span class="p">(</span><span class="n">state_</span> <span class="o">==</span> <span class="n">kConnecting</span><span class="p">);</span>
  <span class="n">setState</span><span class="p">(</span><span class="n">kConnected</span><span class="p">);</span>
  <span class="n">LOG_TRACE</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;[3] usecount=&#34;</span> <span class="o">&lt;&lt;</span> <span class="n">shared_from_this</span><span class="p">().</span><span class="n">use_count</span><span class="p">();</span>
  <span class="n">channel_</span><span class="o">-&gt;</span><span class="n">tie</span><span class="p">(</span><span class="n">shared_from_this</span><span class="p">());</span>
  <span class="n">channel_</span><span class="o">-&gt;</span><span class="n">enableReading</span><span class="p">();</span> <span class="c1">// TcpConnection所对应的通道加入到Poller关注
</span><span class="c1"></span> 
  <span class="n">connectionCallback_</span><span class="p">(</span><span class="n">shared_from_this</span><span class="p">());</span>
  <span class="n">LOG_TRACE</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;[4] usecount=&#34;</span> <span class="o">&lt;&lt;</span> <span class="n">shared_from_this</span><span class="p">().</span><span class="n">use_count</span><span class="p">();</span>
<span class="p">}</span>
 
<span class="kt">void</span> <span class="n">TcpConnection</span><span class="o">::</span><span class="n">connectDestroyed</span><span class="p">()</span>
<span class="p">{</span>
  <span class="n">loop_</span><span class="o">-&gt;</span><span class="n">assertInLoopThread</span><span class="p">();</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">state_</span> <span class="o">==</span> <span class="n">kConnected</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">setState</span><span class="p">(</span><span class="n">kDisconnected</span><span class="p">);</span>
    <span class="n">channel_</span><span class="o">-&gt;</span><span class="n">disableAll</span><span class="p">();</span>
 
    <span class="n">connectionCallback_</span><span class="p">(</span><span class="n">shared_from_this</span><span class="p">());</span>
  <span class="p">}</span>
  <span class="n">channel_</span><span class="o">-&gt;</span><span class="n">remove</span><span class="p">();</span>
<span class="p">}</span>
 
<span class="kt">void</span> <span class="n">TcpConnection</span><span class="o">::</span><span class="n">handleRead</span><span class="p">(</span><span class="n">Timestamp</span> <span class="n">receiveTime</span><span class="p">)</span>
<span class="p">{</span>
  <span class="cm">/*
</span><span class="cm">  loop_-&gt;assertInLoopThread();
</span><span class="cm">  int savedErrno = 0;
</span><span class="cm">  ssize_t n = inputBuffer_.readFd(channel_-&gt;fd(), &amp;savedErrno);
</span><span class="cm">  if (n &gt; 0)
</span><span class="cm">  {
</span><span class="cm">    messageCallback_(shared_from_this(), &amp;inputBuffer_, receiveTime);
</span><span class="cm">  }
</span><span class="cm">  else if (n == 0)
</span><span class="cm">  {
</span><span class="cm">    handleClose();
</span><span class="cm">  }
</span><span class="cm">  else
</span><span class="cm">  {
</span><span class="cm">    errno = savedErrno;
</span><span class="cm">    LOG_SYSERR &lt;&lt; &#34;TcpConnection::handleRead&#34;;
</span><span class="cm">    handleError();
</span><span class="cm">  }
</span><span class="cm">  */</span>
 
  <span class="cm">/*
</span><span class="cm">  loop_-&gt;assertInLoopThread();
</span><span class="cm">  int savedErrno = 0;
</span><span class="cm">  char buf[65536];
</span><span class="cm">  ssize_t n = ::read(channel_-&gt;fd(), buf, sizeof buf);
</span><span class="cm">  if (n &gt; 0)
</span><span class="cm">  {
</span><span class="cm">    messageCallback_(shared_from_this(), buf, n);
</span><span class="cm">  }
</span><span class="cm">  else if (n == 0)
</span><span class="cm">  {
</span><span class="cm">    handleClose();
</span><span class="cm">  }
</span><span class="cm">  else
</span><span class="cm">  {
</span><span class="cm">    errno = savedErrno;
</span><span class="cm">    LOG_SYSERR &lt;&lt; &#34;TcpConnection::handleRead&#34;;
</span><span class="cm">    handleError();
</span><span class="cm">  }
</span><span class="cm">  */</span>
  <span class="n">loop_</span><span class="o">-&gt;</span><span class="n">assertInLoopThread</span><span class="p">();</span>
  <span class="kt">int</span> <span class="n">savedErrno</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="cm">/*一次性读完内核缓冲区的数据，这可以防止busy loop*/</span>
  <span class="n">ssize_t</span> <span class="n">n</span> <span class="o">=</span> <span class="n">inputBuffer_</span><span class="p">.</span><span class="n">readFd</span><span class="p">(</span><span class="n">channel_</span><span class="o">-&gt;</span><span class="n">fd</span><span class="p">(),</span> <span class="o">&amp;</span><span class="n">savedErrno</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">messageCallback_</span><span class="p">(</span><span class="n">shared_from_this</span><span class="p">(),</span> <span class="o">&amp;</span><span class="n">inputBuffer_</span><span class="p">,</span> <span class="n">receiveTime</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="c1">//读到文件eof ，就是对等方已经关闭连接
</span><span class="c1"></span>    <span class="n">handleClose</span><span class="p">();</span>
  <span class="p">}</span>
  <span class="k">else</span>
  <span class="p">{</span>
    <span class="n">errno</span> <span class="o">=</span> <span class="n">savedErrno</span><span class="p">;</span>
    <span class="n">LOG_SYSERR</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;TcpConnection::handleRead&#34;</span><span class="p">;</span>
    <span class="n">handleError</span><span class="p">();</span>
  <span class="p">}</span>
<span class="p">}</span>
 
<span class="c1">// 内核发送缓冲区有空间了，回调该函数
</span><span class="c1"></span><span class="kt">void</span> <span class="n">TcpConnection</span><span class="o">::</span><span class="n">handleWrite</span><span class="p">()</span>
<span class="p">{</span>
  <span class="n">loop_</span><span class="o">-&gt;</span><span class="n">assertInLoopThread</span><span class="p">();</span>
  <span class="cm">/*通道有关注write事件 */</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">channel_</span><span class="o">-&gt;</span><span class="n">isWriting</span><span class="p">())</span>
  <span class="p">{</span>
    <span class="cm">/*写数据到内核中*/</span>
    <span class="n">ssize_t</span> <span class="n">n</span> <span class="o">=</span> <span class="n">sockets</span><span class="o">::</span><span class="n">write</span><span class="p">(</span><span class="n">channel_</span><span class="o">-&gt;</span><span class="n">fd</span><span class="p">(),</span>
                               <span class="n">outputBuffer_</span><span class="p">.</span><span class="n">peek</span><span class="p">(),</span>
                               <span class="n">outputBuffer_</span><span class="p">.</span><span class="n">readableBytes</span><span class="p">());</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">outputBuffer_</span><span class="p">.</span><span class="n">retrieve</span><span class="p">(</span><span class="n">n</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">outputBuffer_</span><span class="p">.</span><span class="n">readableBytes</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>    <span class="c1">// 发送缓冲区已清空
</span><span class="c1"></span>      <span class="p">{</span>
        <span class="n">channel_</span><span class="o">-&gt;</span><span class="n">disableWriting</span><span class="p">();</span>      <span class="c1">// 停止关注POLLOUT事件，以免出现busy loop
</span><span class="c1"></span>        <span class="k">if</span> <span class="p">(</span><span class="n">writeCompleteCallback_</span><span class="p">)</span>     <span class="c1">// 回调writeCompleteCallback_
</span><span class="c1"></span>        <span class="p">{</span>
          <span class="c1">// 应用层发送缓冲区被清空，就回调用writeCompleteCallback_
</span><span class="c1"></span>          <span class="n">loop_</span><span class="o">-&gt;</span><span class="n">queueInLoop</span><span class="p">(</span><span class="n">boost</span><span class="o">::</span><span class="n">bind</span><span class="p">(</span><span class="n">writeCompleteCallback_</span><span class="p">,</span> <span class="n">shared_from_this</span><span class="p">()));</span>
        <span class="p">}</span>
        <span class="cm">/*如果状态码是kDisconnecting ，说明应用层已经发起shutdown命令了，这是最后一个数据包，
</span><span class="cm">        所以发完就可以关闭了。
</span><span class="cm">        请参照void TcpConnection::shutdownInLoop()
</span><span class="cm">        */</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">state_</span> <span class="o">==</span> <span class="n">kDisconnecting</span><span class="p">)</span>   <span class="c1">// 发送缓冲区已清空并且连接状态是kDisconnecting, 要关闭连接
</span><span class="c1"></span>        <span class="p">{</span>
          <span class="n">shutdownInLoop</span><span class="p">();</span>     <span class="c1">// 关闭连接
</span><span class="c1"></span>        <span class="p">}</span>
      <span class="p">}</span>
      <span class="k">else</span>
      <span class="p">{</span>
        <span class="n">LOG_TRACE</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;I am going to write more data&#34;</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">else</span>
    <span class="p">{</span>
      <span class="n">LOG_SYSERR</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;TcpConnection::handleWrite&#34;</span><span class="p">;</span>
      <span class="c1">// if (state_ == kDisconnecting)
</span><span class="c1"></span>      <span class="c1">// {
</span><span class="c1"></span>      <span class="c1">//   shutdownInLoop();
</span><span class="c1"></span>      <span class="c1">// }
</span><span class="c1"></span>    <span class="p">}</span>
  <span class="p">}</span>
  <span class="k">else</span>
  <span class="p">{</span>
    <span class="n">LOG_TRACE</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;Connection fd = &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">channel_</span><span class="o">-&gt;</span><span class="n">fd</span><span class="p">()</span>
              <span class="o">&lt;&lt;</span> <span class="s">&#34; is down, no more writing&#34;</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>
 
<span class="kt">void</span> <span class="n">TcpConnection</span><span class="o">::</span><span class="n">handleClose</span><span class="p">()</span>
<span class="p">{</span>
  <span class="n">loop_</span><span class="o">-&gt;</span><span class="n">assertInLoopThread</span><span class="p">();</span>
  <span class="n">LOG_TRACE</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;fd = &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">channel_</span><span class="o">-&gt;</span><span class="n">fd</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="s">&#34; state = &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">state_</span><span class="p">;</span>
  <span class="n">assert</span><span class="p">(</span><span class="n">state_</span> <span class="o">==</span> <span class="n">kConnected</span> <span class="o">||</span> <span class="n">state_</span> <span class="o">==</span> <span class="n">kDisconnecting</span><span class="p">);</span>
  <span class="c1">// we don&#39;t close fd, leave it to dtor, so we can find leaks easily.
</span><span class="c1"></span>  <span class="n">setState</span><span class="p">(</span><span class="n">kDisconnected</span><span class="p">);</span>
  <span class="n">channel_</span><span class="o">-&gt;</span><span class="n">disableAll</span><span class="p">();</span>
 
  <span class="n">TcpConnectionPtr</span> <span class="nf">guardThis</span><span class="p">(</span><span class="n">shared_from_this</span><span class="p">());</span>
  <span class="n">connectionCallback_</span><span class="p">(</span><span class="n">guardThis</span><span class="p">);</span>       <span class="c1">// 这一行，可以不调用
</span><span class="c1"></span>  <span class="n">LOG_TRACE</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;[7] usecount=&#34;</span> <span class="o">&lt;&lt;</span> <span class="n">guardThis</span><span class="p">.</span><span class="n">use_count</span><span class="p">();</span>
  <span class="c1">// must be the last line
</span><span class="c1"></span>  <span class="n">closeCallback_</span><span class="p">(</span><span class="n">guardThis</span><span class="p">);</span>    <span class="c1">// 调用TcpServer::removeConnection
</span><span class="c1"></span>  <span class="n">LOG_TRACE</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;[11] usecount=&#34;</span> <span class="o">&lt;&lt;</span> <span class="n">guardThis</span><span class="p">.</span><span class="n">use_count</span><span class="p">();</span>
<span class="p">}</span>
 
<span class="kt">void</span> <span class="n">TcpConnection</span><span class="o">::</span><span class="n">handleError</span><span class="p">()</span>
<span class="p">{</span>
  <span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="n">sockets</span><span class="o">::</span><span class="n">getSocketError</span><span class="p">(</span><span class="n">channel_</span><span class="o">-&gt;</span><span class="n">fd</span><span class="p">());</span>
  <span class="n">LOG_ERROR</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;TcpConnection::handleError [&#34;</span> <span class="o">&lt;&lt;</span> <span class="n">name_</span>
            <span class="o">&lt;&lt;</span> <span class="s">&#34;] - SO_ERROR = &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">err</span> <span class="o">&lt;&lt;</span> <span class="s">&#34; &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">strerror_tl</span><span class="p">(</span><span class="n">err</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div>
<h3 id="测试程序-2">测试程序</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-c++" data-lang="c++"><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c++" data-lang="c++"><span class="cp">#include</span> <span class="cpf">&lt;muduo/net/TcpServer.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;muduo/net/EventLoop.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;muduo/net/InetAddress.h&gt;</span><span class="cp">
</span><span class="cp"></span> 
<span class="cp">#include</span> <span class="cpf">&lt;boost/bind.hpp&gt;</span><span class="cp">
</span><span class="cp"></span> 
<span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
</span><span class="cp"></span><span class="cm">/*
</span><span class="cm">程序说明：
</span><span class="cm">  客户端请求连接-------》服务器马上发送一堆数据
</span><span class="cm"> 
</span><span class="cm">*/</span>
<span class="k">using</span> <span class="k">namespace</span> <span class="n">muduo</span><span class="p">;</span>
<span class="k">using</span> <span class="k">namespace</span> <span class="n">muduo</span><span class="o">::</span><span class="n">net</span><span class="p">;</span>
 
<span class="k">class</span><span class="err"> </span><span class="nc">TestServer</span>
<span class="p">{</span>
 <span class="k">public</span><span class="o">:</span>
  <span class="n">TestServer</span><span class="p">(</span><span class="n">EventLoop</span><span class="o">*</span> <span class="n">loop</span><span class="p">,</span>
             <span class="k">const</span> <span class="n">InetAddress</span><span class="o">&amp;</span> <span class="n">listenAddr</span><span class="p">)</span>
    <span class="o">:</span> <span class="n">loop_</span><span class="p">(</span><span class="n">loop</span><span class="p">),</span>
      <span class="n">server_</span><span class="p">(</span><span class="n">loop</span><span class="p">,</span> <span class="n">listenAddr</span><span class="p">,</span> <span class="s">&#34;TestServer&#34;</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">server_</span><span class="p">.</span><span class="n">setConnectionCallback</span><span class="p">(</span>
        <span class="n">boost</span><span class="o">::</span><span class="n">bind</span><span class="p">(</span><span class="o">&amp;</span><span class="n">TestServer</span><span class="o">::</span><span class="n">onConnection</span><span class="p">,</span> <span class="k">this</span><span class="p">,</span> <span class="n">_1</span><span class="p">));</span>
    <span class="n">server_</span><span class="p">.</span><span class="n">setMessageCallback</span><span class="p">(</span>
        <span class="n">boost</span><span class="o">::</span><span class="n">bind</span><span class="p">(</span><span class="o">&amp;</span><span class="n">TestServer</span><span class="o">::</span><span class="n">onMessage</span><span class="p">,</span> <span class="k">this</span><span class="p">,</span> <span class="n">_1</span><span class="p">,</span> <span class="n">_2</span><span class="p">,</span> <span class="n">_3</span><span class="p">));</span>
    <span class="n">server_</span><span class="p">.</span><span class="n">setWriteCompleteCallback</span><span class="p">(</span>
      <span class="n">boost</span><span class="o">::</span><span class="n">bind</span><span class="p">(</span><span class="o">&amp;</span><span class="n">TestServer</span><span class="o">::</span><span class="n">onWriteComplete</span><span class="p">,</span> <span class="k">this</span><span class="p">,</span> <span class="n">_1</span><span class="p">));</span>
 
    <span class="c1">// 这是一个数据生成协议
</span><span class="c1"></span>    <span class="n">string</span> <span class="n">line</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">33</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">127</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">line</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="kt">char</span><span class="p">(</span><span class="n">i</span><span class="p">));</span>
    <span class="p">}</span>
    <span class="n">line</span> <span class="o">+=</span> <span class="n">line</span><span class="p">;</span>
 
    <span class="k">for</span> <span class="p">(</span><span class="n">size_t</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">127</span><span class="o">-</span><span class="mi">33</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">message_</span> <span class="o">+=</span> <span class="n">line</span><span class="p">.</span><span class="n">substr</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="mi">72</span><span class="p">)</span> <span class="o">+</span> <span class="sc">&#39;\n&#39;</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
 
  <span class="kt">void</span> <span class="n">start</span><span class="p">()</span>
  <span class="p">{</span>
      <span class="n">server_</span><span class="p">.</span><span class="n">start</span><span class="p">();</span>
  <span class="p">}</span>
 
 <span class="k">private</span><span class="o">:</span>
  <span class="kt">void</span> <span class="n">onConnection</span><span class="p">(</span><span class="k">const</span> <span class="n">TcpConnectionPtr</span><span class="o">&amp;</span> <span class="n">conn</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">connected</span><span class="p">())</span>
    <span class="p">{</span>
      <span class="n">printf</span><span class="p">(</span><span class="s">&#34;onConnection(): new connection [%s] from %s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span>
             <span class="n">conn</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">().</span><span class="n">c_str</span><span class="p">(),</span>
             <span class="n">conn</span><span class="o">-&gt;</span><span class="n">peerAddress</span><span class="p">().</span><span class="n">toIpPort</span><span class="p">().</span><span class="n">c_str</span><span class="p">());</span>
 
      <span class="n">conn</span><span class="o">-&gt;</span><span class="n">setTcpNoDelay</span><span class="p">(</span><span class="nb">true</span><span class="p">);</span>
      <span class="cm">/*连接到来直接发送数据*/</span>
      <span class="n">conn</span><span class="o">-&gt;</span><span class="n">send</span><span class="p">(</span><span class="n">message_</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">else</span>
    <span class="p">{</span>
      <span class="n">printf</span><span class="p">(</span><span class="s">&#34;onConnection(): connection [%s] is down</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span>
             <span class="n">conn</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">().</span><span class="n">c_str</span><span class="p">());</span>
    <span class="p">}</span>
  <span class="p">}</span>
 
  <span class="kt">void</span> <span class="n">onMessage</span><span class="p">(</span><span class="k">const</span> <span class="n">TcpConnectionPtr</span><span class="o">&amp;</span> <span class="n">conn</span><span class="p">,</span>
                 <span class="n">Buffer</span><span class="o">*</span> <span class="n">buf</span><span class="p">,</span>
                 <span class="n">Timestamp</span> <span class="n">receiveTime</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">muduo</span><span class="o">::</span><span class="n">string</span> <span class="n">msg</span><span class="p">(</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">retrieveAllAsString</span><span class="p">());</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;onMessage(): received %zd bytes from connection [%s] at %s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span>
           <span class="n">msg</span><span class="p">.</span><span class="n">size</span><span class="p">(),</span>
           <span class="n">conn</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">().</span><span class="n">c_str</span><span class="p">(),</span>
           <span class="n">receiveTime</span><span class="p">.</span><span class="n">toFormattedString</span><span class="p">().</span><span class="n">c_str</span><span class="p">());</span>
 
    <span class="n">conn</span><span class="o">-&gt;</span><span class="n">send</span><span class="p">(</span><span class="n">msg</span><span class="p">);</span>
  <span class="p">}</span>
 
  <span class="kt">void</span> <span class="n">onWriteComplete</span><span class="p">(</span><span class="k">const</span> <span class="n">TcpConnectionPtr</span><span class="o">&amp;</span> <span class="n">conn</span><span class="p">)</span>
  <span class="p">{</span> <span class="cm">/*可写事件，在发送*/</span>
    <span class="n">conn</span><span class="o">-&gt;</span><span class="n">send</span><span class="p">(</span><span class="n">message_</span><span class="p">);</span>
  <span class="p">}</span>
 
  <span class="n">EventLoop</span><span class="o">*</span> <span class="n">loop_</span><span class="p">;</span>
  <span class="n">TcpServer</span> <span class="n">server_</span><span class="p">;</span>
 
  <span class="n">muduo</span><span class="o">::</span><span class="n">string</span> <span class="n">message_</span><span class="p">;</span>
<span class="p">};</span>
 
 
<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>
<span class="p">{</span>
  <span class="n">printf</span><span class="p">(</span><span class="s">&#34;main(): pid = %d</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">getpid</span><span class="p">());</span>
 
  <span class="n">InetAddress</span> <span class="n">listenAddr</span><span class="p">(</span><span class="mi">8888</span><span class="p">);</span>
  <span class="n">EventLoop</span> <span class="n">loop</span><span class="p">;</span>
 
  <span class="n">TestServer</span> <span class="n">server</span><span class="p">(</span><span class="o">&amp;</span><span class="n">loop</span><span class="p">,</span> <span class="n">listenAddr</span><span class="p">);</span>
  <span class="n">server</span><span class="p">.</span><span class="n">start</span><span class="p">();</span>
 
  <span class="n">loop</span><span class="p">.</span><span class="n">loop</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div>
<h2 id="39-tcpclient和connector">[39] TcpClient和connector</h2>

<ul>
<li><code>muduo</code>库对编写<code>tcp</code>(主动发起连接<code>TcpClient</code>)</li>
<li>客户端程序的支持<code>Connector</code>(包含了一个<code>Connector</code>对象)</li>
</ul>

<h3 id="测试程序-3">测试程序</h3>

<ul>
<li>Reactor_test11.cc    
// echo server</li>
<li>TcpClient_test.cc    
// echo client</li>
</ul>

<h3 id="tcpclient-头文件">TcpClient 头文件</h3>

<p>TcpClient.h</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-c++" data-lang="c++"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span><span class="lnt">84
</span><span class="lnt">85
</span><span class="lnt">86
</span><span class="lnt">87
</span><span class="lnt">88
</span><span class="lnt">89
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c++" data-lang="c++"><span class="c1">// Copyright 2010, Shuo Chen.  All rights reserved.
</span><span class="c1">// http://code.google.com/p/muduo/
</span><span class="c1">//
</span><span class="c1">// Use of this source code is governed by a BSD-style license
</span><span class="c1">// that can be found in the License file.
</span><span class="c1"></span> 
<span class="c1">// Author: Shuo Chen (chenshuo at chenshuo dot com)
</span><span class="c1">//
</span><span class="c1">// This is a public header file, it must only include public header files.
</span><span class="c1"></span> 
<span class="cp">#ifndef MUDUO_NET_TCPCLIENT_H
</span><span class="cp">#define MUDUO_NET_TCPCLIENT_H
</span><span class="cp"></span> 
<span class="cp">#include</span> <span class="cpf">&lt;boost/noncopyable.hpp&gt;</span><span class="cp">
</span><span class="cp"></span> 
<span class="cp">#include</span> <span class="cpf">&lt;muduo/base/Mutex.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;muduo/net/TcpConnection.h&gt;</span><span class="cp">
</span><span class="cp"></span> 
<span class="k">namespace</span> <span class="n">muduo</span>
<span class="p">{</span>
<span class="k">namespace</span> <span class="n">net</span>
<span class="p">{</span>
 
<span class="k">class</span><span class="err"> </span><span class="nc">Connector</span><span class="p">;</span>
<span class="k">typedef</span> <span class="n">boost</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">Connector</span><span class="o">&gt;</span> <span class="n">ConnectorPtr</span><span class="p">;</span>
 
<span class="k">class</span><span class="err"> </span><span class="nc">TcpClient</span> <span class="o">:</span> <span class="n">boost</span><span class="o">::</span><span class="n">noncopyable</span>
<span class="p">{</span>
 <span class="k">public</span><span class="o">:</span>
  <span class="c1">// TcpClient(EventLoop* loop);
</span><span class="c1"></span>  <span class="c1">// TcpClient(EventLoop* loop, const string&amp; host, uint16_t port);
</span><span class="c1"></span>  <span class="n">TcpClient</span><span class="p">(</span><span class="n">EventLoop</span><span class="o">*</span> <span class="n">loop</span><span class="p">,</span>
            <span class="k">const</span> <span class="n">InetAddress</span><span class="o">&amp;</span> <span class="n">serverAddr</span><span class="p">,</span>
            <span class="k">const</span> <span class="n">string</span><span class="o">&amp;</span> <span class="n">name</span><span class="p">);</span>
  <span class="o">~</span><span class="n">TcpClient</span><span class="p">();</span>  <span class="c1">// force out-line dtor, for scoped_ptr members.
</span><span class="c1"></span> 
  <span class="kt">void</span> <span class="nf">connect</span><span class="p">();</span>
  <span class="kt">void</span> <span class="nf">disconnect</span><span class="p">();</span>
  <span class="kt">void</span> <span class="nf">stop</span><span class="p">();</span>
 
  <span class="n">TcpConnectionPtr</span> <span class="nf">connection</span><span class="p">()</span> <span class="k">const</span>
  <span class="p">{</span>
    <span class="n">MutexLockGuard</span> <span class="n">lock</span><span class="p">(</span><span class="n">mutex_</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">connection_</span><span class="p">;</span>
  <span class="p">}</span>
 
  <span class="kt">bool</span> <span class="nf">retry</span><span class="p">()</span> <span class="k">const</span><span class="p">;</span>
  <span class="kt">void</span> <span class="nf">enableRetry</span><span class="p">()</span> <span class="p">{</span> <span class="n">retry_</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span> <span class="p">}</span>
 
  <span class="c1">/// Set connection callback.
</span><span class="c1"></span>  <span class="c1">/// Not thread safe.
</span><span class="c1"></span>  <span class="kt">void</span> <span class="nf">setConnectionCallback</span><span class="p">(</span><span class="k">const</span> <span class="n">ConnectionCallback</span><span class="o">&amp;</span> <span class="n">cb</span><span class="p">)</span>
  <span class="p">{</span> <span class="n">connectionCallback_</span> <span class="o">=</span> <span class="n">cb</span><span class="p">;</span> <span class="p">}</span>
 
  <span class="c1">/// Set message callback.
</span><span class="c1"></span>  <span class="c1">/// Not thread safe.
</span><span class="c1"></span>  <span class="kt">void</span> <span class="nf">setMessageCallback</span><span class="p">(</span><span class="k">const</span> <span class="n">MessageCallback</span><span class="o">&amp;</span> <span class="n">cb</span><span class="p">)</span>
  <span class="p">{</span> <span class="n">messageCallback_</span> <span class="o">=</span> <span class="n">cb</span><span class="p">;</span> <span class="p">}</span>
 
  <span class="c1">/// Set write complete callback.
</span><span class="c1"></span>  <span class="c1">/// Not thread safe.
</span><span class="c1"></span>  <span class="kt">void</span> <span class="nf">setWriteCompleteCallback</span><span class="p">(</span><span class="k">const</span> <span class="n">WriteCompleteCallback</span><span class="o">&amp;</span> <span class="n">cb</span><span class="p">)</span>
  <span class="p">{</span> <span class="n">writeCompleteCallback_</span> <span class="o">=</span> <span class="n">cb</span><span class="p">;</span> <span class="p">}</span>
 
 <span class="k">private</span><span class="o">:</span>
  <span class="c1">/// Not thread safe, but in loop
</span><span class="c1"></span>  <span class="kt">void</span> <span class="n">newConnection</span><span class="p">(</span><span class="kt">int</span> <span class="n">sockfd</span><span class="p">);</span>
  <span class="c1">/// Not thread safe, but in loop
</span><span class="c1"></span>  <span class="kt">void</span> <span class="nf">removeConnection</span><span class="p">(</span><span class="k">const</span> <span class="n">TcpConnectionPtr</span><span class="o">&amp;</span> <span class="n">conn</span><span class="p">);</span>
 
  <span class="n">EventLoop</span><span class="o">*</span> <span class="n">loop_</span><span class="p">;</span>
  <span class="n">ConnectorPtr</span> <span class="n">connector_</span><span class="p">;</span>  <span class="c1">// 用于主动发起连接
</span><span class="c1"></span>  <span class="k">const</span> <span class="n">string</span> <span class="n">name_</span><span class="p">;</span>       <span class="c1">// 名称
</span><span class="c1"></span>  <span class="n">ConnectionCallback</span> <span class="n">connectionCallback_</span><span class="p">;</span>       <span class="c1">// 连接建立回调函数
</span><span class="c1"></span>  <span class="n">MessageCallback</span> <span class="n">messageCallback_</span><span class="p">;</span>             <span class="c1">// 消息到来回调函数
</span><span class="c1"></span>  <span class="n">WriteCompleteCallback</span> <span class="n">writeCompleteCallback_</span><span class="p">;</span> <span class="c1">// 数据发送完毕回调函数
</span><span class="c1"></span>  <span class="kt">bool</span> <span class="n">retry_</span><span class="p">;</span>   <span class="c1">// 重连，是指连接建立之后又断开的时候是否重连，
</span><span class="c1"></span>                <span class="c1">//这个跟connector里面的retry是不一样的，connector里面的retry表示连接不成功时是否要重连
</span><span class="c1"></span>  <span class="kt">bool</span> <span class="n">connect_</span><span class="p">;</span> <span class="c1">// atomic 是否发起连接
</span><span class="c1"></span>  <span class="c1">// always in loop thread
</span><span class="c1"></span>  <span class="kt">int</span> <span class="n">nextConnId_</span><span class="p">;</span>          <span class="c1">// name_ + nextConnId_用于标识一个连接
</span><span class="c1"></span>  <span class="k">mutable</span> <span class="n">MutexLock</span> <span class="n">mutex_</span><span class="p">;</span>
  <span class="n">TcpConnectionPtr</span> <span class="n">connection_</span><span class="p">;</span> <span class="c1">// Connector连接成功以后，得到一个TcpConnection
</span><span class="c1"></span><span class="p">};</span>
 
<span class="p">}</span>
<span class="p">}</span>
 
<span class="cp">#endif  </span><span class="c1">// MUDUO_NET_TCPCLIENT_H
</span></code></pre></td></tr></table>
</div>
</div>
<h3 id="tcpclient-源文件">TcpClient 源文件</h3>

<p>TcpClient.cc</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-c++" data-lang="c++"><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span><span class="lnt">177
</span><span class="lnt">178
</span><span class="lnt">179
</span><span class="lnt">180
</span><span class="lnt">181
</span><span class="lnt">182
</span><span class="lnt">183
</span><span class="lnt">184
</span><span class="lnt">185
</span><span class="lnt">186
</span><span class="lnt">187
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c++" data-lang="c++"><span class="c1">// Copyright 2010, Shuo Chen.  All rights reserved.
</span><span class="c1">// http://code.google.com/p/muduo/
</span><span class="c1">//
</span><span class="c1">// Use of this source code is governed by a BSD-style license
</span><span class="c1">// that can be found in the License file.
</span><span class="c1"></span> 
<span class="c1">// Author: Shuo Chen (chenshuo at chenshuo dot com)
</span><span class="c1">//
</span><span class="c1"></span> 
<span class="cp">#include</span> <span class="cpf">&lt;muduo/net/TcpClient.h&gt;</span><span class="cp">
</span><span class="cp"></span> 
<span class="cp">#include</span> <span class="cpf">&lt;muduo/base/Logging.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;muduo/net/Connector.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;muduo/net/EventLoop.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;muduo/net/SocketsOps.h&gt;</span><span class="cp">
</span><span class="cp"></span> 
<span class="cp">#include</span> <span class="cpf">&lt;boost/bind.hpp&gt;</span><span class="cp">
</span><span class="cp"></span> 
<span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;  // snprintf</span><span class="cp">
</span><span class="cp"></span> 
<span class="k">using</span> <span class="k">namespace</span> <span class="n">muduo</span><span class="p">;</span>
<span class="k">using</span> <span class="k">namespace</span> <span class="n">muduo</span><span class="o">::</span><span class="n">net</span><span class="p">;</span>
 
<span class="c1">// TcpClient::TcpClient(EventLoop* loop)
</span><span class="c1">//   : loop_(loop)
</span><span class="c1">// {
</span><span class="c1">// }
</span><span class="c1"></span> 
<span class="c1">// TcpClient::TcpClient(EventLoop* loop, const string&amp; host, uint16_t port)
</span><span class="c1">//   : loop_(CHECK_NOTNULL(loop)),
</span><span class="c1">//     serverAddr_(host, port)
</span><span class="c1">// {
</span><span class="c1">// }
</span><span class="c1"></span> 
<span class="k">namespace</span> <span class="n">muduo</span>
<span class="p">{</span>
<span class="k">namespace</span> <span class="n">net</span>
<span class="p">{</span>
<span class="k">namespace</span> <span class="n">detail</span>
<span class="p">{</span>
 
<span class="kt">void</span> <span class="n">removeConnection</span><span class="p">(</span><span class="n">EventLoop</span><span class="o">*</span> <span class="n">loop</span><span class="p">,</span> <span class="k">const</span> <span class="n">TcpConnectionPtr</span><span class="o">&amp;</span> <span class="n">conn</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">loop</span><span class="o">-&gt;</span><span class="n">queueInLoop</span><span class="p">(</span><span class="n">boost</span><span class="o">::</span><span class="n">bind</span><span class="p">(</span><span class="o">&amp;</span><span class="n">TcpConnection</span><span class="o">::</span><span class="n">connectDestroyed</span><span class="p">,</span> <span class="n">conn</span><span class="p">));</span>
<span class="p">}</span>
 
<span class="kt">void</span> <span class="n">removeConnector</span><span class="p">(</span><span class="k">const</span> <span class="n">ConnectorPtr</span><span class="o">&amp;</span> <span class="n">connector</span><span class="p">)</span>
<span class="p">{</span>
  <span class="c1">//connector-&gt;
</span><span class="c1"></span><span class="p">}</span>
 
<span class="p">}</span>
<span class="p">}</span>
<span class="p">}</span>
 
<span class="n">TcpClient</span><span class="o">::</span><span class="n">TcpClient</span><span class="p">(</span><span class="n">EventLoop</span><span class="o">*</span> <span class="n">loop</span><span class="p">,</span>
                     <span class="k">const</span> <span class="n">InetAddress</span><span class="o">&amp;</span> <span class="n">serverAddr</span><span class="p">,</span>
                     <span class="k">const</span> <span class="n">string</span><span class="o">&amp;</span> <span class="n">name</span><span class="p">)</span>
  <span class="o">:</span> <span class="n">loop_</span><span class="p">(</span><span class="n">CHECK_NOTNULL</span><span class="p">(</span><span class="n">loop</span><span class="p">)),</span>
    <span class="n">connector_</span><span class="p">(</span><span class="k">new</span> <span class="n">Connector</span><span class="p">(</span><span class="n">loop</span><span class="p">,</span> <span class="n">serverAddr</span><span class="p">)),</span>
    <span class="n">name_</span><span class="p">(</span><span class="n">name</span><span class="p">),</span>
    <span class="n">connectionCallback_</span><span class="p">(</span><span class="n">defaultConnectionCallback</span><span class="p">),</span>
    <span class="n">messageCallback_</span><span class="p">(</span><span class="n">defaultMessageCallback</span><span class="p">),</span>
    <span class="n">retry_</span><span class="p">(</span><span class="nb">false</span><span class="p">),</span>
    <span class="n">connect_</span><span class="p">(</span><span class="nb">true</span><span class="p">),</span>
    <span class="n">nextConnId_</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="p">{</span>
  <span class="c1">// 设置连接成功回调函数
</span><span class="c1"></span>  <span class="n">connector_</span><span class="o">-&gt;</span><span class="n">setNewConnectionCallback</span><span class="p">(</span>
      <span class="n">boost</span><span class="o">::</span><span class="n">bind</span><span class="p">(</span><span class="o">&amp;</span><span class="n">TcpClient</span><span class="o">::</span><span class="n">newConnection</span><span class="p">,</span> <span class="k">this</span><span class="p">,</span> <span class="n">_1</span><span class="p">));</span>
  <span class="c1">// FIXME setConnectFailedCallback
</span><span class="c1"></span>  <span class="n">LOG_INFO</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;TcpClient::TcpClient[&#34;</span> <span class="o">&lt;&lt;</span> <span class="n">name_</span>
           <span class="o">&lt;&lt;</span> <span class="s">&#34;] - connector &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">get_pointer</span><span class="p">(</span><span class="n">connector_</span><span class="p">);</span>
<span class="p">}</span>
 
<span class="n">TcpClient</span><span class="o">::~</span><span class="n">TcpClient</span><span class="p">()</span>
<span class="p">{</span>
  <span class="n">LOG_INFO</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;TcpClient::~TcpClient[&#34;</span> <span class="o">&lt;&lt;</span> <span class="n">name_</span>
           <span class="o">&lt;&lt;</span> <span class="s">&#34;] - connector &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">get_pointer</span><span class="p">(</span><span class="n">connector_</span><span class="p">);</span>
  <span class="n">TcpConnectionPtr</span> <span class="n">conn</span><span class="p">;</span>
  <span class="p">{</span>
    <span class="n">MutexLockGuard</span> <span class="n">lock</span><span class="p">(</span><span class="n">mutex_</span><span class="p">);</span>
    <span class="n">conn</span> <span class="o">=</span> <span class="n">connection_</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">conn</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="c1">// FIXME: not 100% safe, if we are in different thread
</span><span class="c1"></span> 
    <span class="c1">// 重新设置TcpConnection中的closeCallback_为detail::removeConnection
</span><span class="c1"></span>    <span class="c1">//这里不用TcpClient::removeConnection的原因是 TcpClient::removeConnection 有重连功能,
</span><span class="c1"></span>    <span class="c1">//这里已经不需要重连了，直接调用detail::removeConnection就行了
</span><span class="c1"></span>    <span class="n">CloseCallback</span> <span class="n">cb</span> <span class="o">=</span> <span class="n">boost</span><span class="o">::</span><span class="n">bind</span><span class="p">(</span><span class="o">&amp;</span><span class="n">detail</span><span class="o">::</span><span class="n">removeConnection</span><span class="p">,</span> <span class="n">loop_</span><span class="p">,</span> <span class="n">_1</span><span class="p">);</span>
    <span class="n">loop_</span><span class="o">-&gt;</span><span class="n">runInLoop</span><span class="p">(</span>
        <span class="n">boost</span><span class="o">::</span><span class="n">bind</span><span class="p">(</span><span class="o">&amp;</span><span class="n">TcpConnection</span><span class="o">::</span><span class="n">setCloseCallback</span><span class="p">,</span> <span class="n">conn</span><span class="p">,</span> <span class="n">cb</span><span class="p">));</span>
  <span class="p">}</span>
  <span class="k">else</span>
  <span class="p">{</span>
    <span class="c1">// 这种情况，说明connector处于未连接状态，将connector_停止
</span><span class="c1"></span>    <span class="n">connector_</span><span class="o">-&gt;</span><span class="n">stop</span><span class="p">();</span>
    <span class="c1">// FIXME: HACK
</span><span class="c1"></span>    <span class="n">loop_</span><span class="o">-&gt;</span><span class="n">runAfter</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">boost</span><span class="o">::</span><span class="n">bind</span><span class="p">(</span><span class="o">&amp;</span><span class="n">detail</span><span class="o">::</span><span class="n">removeConnector</span><span class="p">,</span> <span class="n">connector_</span><span class="p">));</span>
  <span class="p">}</span>
<span class="p">}</span>
 
<span class="kt">void</span> <span class="n">TcpClient</span><span class="o">::</span><span class="n">connect</span><span class="p">()</span>
<span class="p">{</span>
  <span class="c1">// FIXME: check state
</span><span class="c1"></span>  <span class="n">LOG_INFO</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;TcpClient::connect[&#34;</span> <span class="o">&lt;&lt;</span> <span class="n">name_</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;] - connecting to &#34;</span>
           <span class="o">&lt;&lt;</span> <span class="n">connector_</span><span class="o">-&gt;</span><span class="n">serverAddress</span><span class="p">().</span><span class="n">toIpPort</span><span class="p">();</span>
  <span class="n">connect_</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
  <span class="n">connector_</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">();</span>   <span class="c1">// 发起连接
</span><span class="c1"></span><span class="p">}</span>
 
<span class="c1">// 用于连接已建立的情况下，关闭连接
</span><span class="c1"></span><span class="kt">void</span> <span class="n">TcpClient</span><span class="o">::</span><span class="n">disconnect</span><span class="p">()</span>
<span class="p">{</span>
  <span class="n">connect_</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
 
  <span class="p">{</span>
    <span class="n">MutexLockGuard</span> <span class="n">lock</span><span class="p">(</span><span class="n">mutex_</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">connection_</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">connection_</span><span class="o">-&gt;</span><span class="n">shutdown</span><span class="p">();</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
 
<span class="c1">// 停止connector_ ,连接尚未成功时进行断开
</span><span class="c1"></span><span class="kt">void</span> <span class="n">TcpClient</span><span class="o">::</span><span class="n">stop</span><span class="p">()</span>
<span class="p">{</span>
  <span class="n">connect_</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
  <span class="n">connector_</span><span class="o">-&gt;</span><span class="n">stop</span><span class="p">();</span>
<span class="p">}</span>
 
<span class="c1">//有新的连接到来
</span><span class="c1"></span><span class="kt">void</span> <span class="n">TcpClient</span><span class="o">::</span><span class="n">newConnection</span><span class="p">(</span><span class="kt">int</span> <span class="n">sockfd</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">loop_</span><span class="o">-&gt;</span><span class="n">assertInLoopThread</span><span class="p">();</span>
  <span class="n">InetAddress</span> <span class="nf">peerAddr</span><span class="p">(</span><span class="n">sockets</span><span class="o">::</span><span class="n">getPeerAddr</span><span class="p">(</span><span class="n">sockfd</span><span class="p">));</span>
  <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>
  <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span> <span class="n">buf</span><span class="p">,</span> <span class="s">&#34;:%s#%d&#34;</span><span class="p">,</span> <span class="n">peerAddr</span><span class="p">.</span><span class="n">toIpPort</span><span class="p">().</span><span class="n">c_str</span><span class="p">(),</span> <span class="n">nextConnId_</span><span class="p">);</span>
  <span class="o">++</span><span class="n">nextConnId_</span><span class="p">;</span>
  <span class="n">string</span> <span class="n">connName</span> <span class="o">=</span> <span class="n">name_</span> <span class="o">+</span> <span class="n">buf</span><span class="p">;</span>
 
  <span class="n">InetAddress</span> <span class="nf">localAddr</span><span class="p">(</span><span class="n">sockets</span><span class="o">::</span><span class="n">getLocalAddr</span><span class="p">(</span><span class="n">sockfd</span><span class="p">));</span>
  <span class="c1">// FIXME poll with zero timeout to double confirm the new connection
</span><span class="c1"></span>  <span class="c1">// FIXME use make_shared if necessary
</span><span class="c1"></span>  <span class="n">TcpConnectionPtr</span> <span class="nf">conn</span><span class="p">(</span><span class="k">new</span> <span class="n">TcpConnection</span><span class="p">(</span><span class="n">loop_</span><span class="p">,</span>
                                          <span class="n">connName</span><span class="p">,</span>
                                          <span class="n">sockfd</span><span class="p">,</span>
                                          <span class="n">localAddr</span><span class="p">,</span>
                                          <span class="n">peerAddr</span><span class="p">));</span>
 
  <span class="n">conn</span><span class="o">-&gt;</span><span class="n">setConnectionCallback</span><span class="p">(</span><span class="n">connectionCallback_</span><span class="p">);</span>
  <span class="n">conn</span><span class="o">-&gt;</span><span class="n">setMessageCallback</span><span class="p">(</span><span class="n">messageCallback_</span><span class="p">);</span>
  <span class="n">conn</span><span class="o">-&gt;</span><span class="n">setWriteCompleteCallback</span><span class="p">(</span><span class="n">writeCompleteCallback_</span><span class="p">);</span>
  <span class="n">conn</span><span class="o">-&gt;</span><span class="n">setCloseCallback</span><span class="p">(</span>
      <span class="n">boost</span><span class="o">::</span><span class="n">bind</span><span class="p">(</span><span class="o">&amp;</span><span class="n">TcpClient</span><span class="o">::</span><span class="n">removeConnection</span><span class="p">,</span> <span class="k">this</span><span class="p">,</span> <span class="n">_1</span><span class="p">));</span> <span class="c1">// FIXME: unsafe
</span><span class="c1"></span>  <span class="p">{</span>
    <span class="n">MutexLockGuard</span> <span class="n">lock</span><span class="p">(</span><span class="n">mutex_</span><span class="p">);</span>
    <span class="n">connection_</span> <span class="o">=</span> <span class="n">conn</span><span class="p">;</span>     <span class="c1">// 保存TcpConnection
</span><span class="c1"></span>  <span class="p">}</span>
  <span class="n">conn</span><span class="o">-&gt;</span><span class="n">connectEstablished</span><span class="p">();</span>        <span class="c1">// 这里回调connectionCallback_
</span><span class="c1"></span><span class="p">}</span>
 
<span class="cm">/*移除connector*/</span>
<span class="kt">void</span> <span class="n">TcpClient</span><span class="o">::</span><span class="n">removeConnection</span><span class="p">(</span><span class="k">const</span> <span class="n">TcpConnectionPtr</span><span class="o">&amp;</span> <span class="n">conn</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">loop_</span><span class="o">-&gt;</span><span class="n">assertInLoopThread</span><span class="p">();</span>
  <span class="n">assert</span><span class="p">(</span><span class="n">loop_</span> <span class="o">==</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">getLoop</span><span class="p">());</span>
 
  <span class="p">{</span>
    <span class="n">MutexLockGuard</span> <span class="n">lock</span><span class="p">(</span><span class="n">mutex_</span><span class="p">);</span>
    <span class="n">assert</span><span class="p">(</span><span class="n">connection_</span> <span class="o">==</span> <span class="n">conn</span><span class="p">);</span>
    <span class="n">connection_</span><span class="p">.</span><span class="n">reset</span><span class="p">();</span>
  <span class="p">}</span>
  <span class="cm">/*放到IO线程中销毁*/</span>
  <span class="n">loop_</span><span class="o">-&gt;</span><span class="n">queueInLoop</span><span class="p">(</span><span class="n">boost</span><span class="o">::</span><span class="n">bind</span><span class="p">(</span><span class="o">&amp;</span><span class="n">TcpConnection</span><span class="o">::</span><span class="n">connectDestroyed</span><span class="p">,</span> <span class="n">conn</span><span class="p">));</span>
  <span class="c1">//如果需要重连，则重新连接
</span><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="n">retry_</span> <span class="o">&amp;&amp;</span> <span class="n">connect_</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">LOG_INFO</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;TcpClient::connect[&#34;</span> <span class="o">&lt;&lt;</span> <span class="n">name_</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;] - Reconnecting to &#34;</span>
             <span class="o">&lt;&lt;</span> <span class="n">connector_</span><span class="o">-&gt;</span><span class="n">serverAddress</span><span class="p">().</span><span class="n">toIpPort</span><span class="p">();</span>
    <span class="c1">// 这里的重连是指连接建立成功之后被断开的重连
</span><span class="c1"></span>    <span class="n">connector_</span><span class="o">-&gt;</span><span class="n">restart</span><span class="p">();</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div>
<h3 id="connector-头文件">Connector 头文件</h3>

<p>Connector.h</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-c++" data-lang="c++"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c++" data-lang="c++"><span class="c1">// Copyright 2010, Shuo Chen.  All rights reserved.
</span><span class="c1">// http://code.google.com/p/muduo/
</span><span class="c1">//
</span><span class="c1">// Use of this source code is governed by a BSD-style license
</span><span class="c1">// that can be found in the License file.
</span><span class="c1"></span> 
<span class="c1">// Author: Shuo Chen (chenshuo at chenshuo dot com)
</span><span class="c1">//
</span><span class="c1">// This is an internal header file, you should not include this.
</span><span class="c1"></span> 
<span class="cp">#ifndef MUDUO_NET_CONNECTOR_H
</span><span class="cp">#define MUDUO_NET_CONNECTOR_H
</span><span class="cp"></span> 
<span class="cp">#include</span> <span class="cpf">&lt;muduo/net/InetAddress.h&gt;</span><span class="cp">
</span><span class="cp"></span> 
<span class="cp">#include</span> <span class="cpf">&lt;boost/enable_shared_from_this.hpp&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;boost/function.hpp&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;boost/noncopyable.hpp&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;boost/scoped_ptr.hpp&gt;</span><span class="cp">
</span><span class="cp"></span> 
<span class="k">namespace</span> <span class="n">muduo</span>
<span class="p">{</span>
<span class="k">namespace</span> <span class="n">net</span>
<span class="p">{</span>
 
<span class="k">class</span><span class="err"> </span><span class="nc">Channel</span><span class="p">;</span>
<span class="k">class</span><span class="err"> </span><span class="nc">EventLoop</span><span class="p">;</span>
 
<span class="c1">// 主动发起连接，带有自动重连功能
</span><span class="c1"></span><span class="k">class</span><span class="err"> </span><span class="nc">Connector</span> <span class="o">:</span> <span class="n">boost</span><span class="o">::</span><span class="n">noncopyable</span><span class="p">,</span>
                  <span class="k">public</span> <span class="n">boost</span><span class="o">::</span><span class="n">enable_shared_from_this</span><span class="o">&lt;</span><span class="n">Connector</span><span class="o">&gt;</span>
<span class="p">{</span>
 <span class="k">public</span><span class="o">:</span>
  <span class="k">typedef</span> <span class="n">boost</span><span class="o">::</span><span class="n">function</span><span class="o">&lt;</span><span class="kt">void</span> <span class="p">(</span><span class="kt">int</span> <span class="n">sockfd</span><span class="p">)</span><span class="o">&gt;</span> <span class="n">NewConnectionCallback</span><span class="p">;</span>
 
  <span class="n">Connector</span><span class="p">(</span><span class="n">EventLoop</span><span class="o">*</span> <span class="n">loop</span><span class="p">,</span> <span class="k">const</span> <span class="n">InetAddress</span><span class="o">&amp;</span> <span class="n">serverAddr</span><span class="p">);</span>
  <span class="o">~</span><span class="n">Connector</span><span class="p">();</span>
  <span class="cm">/*设置连接成功后的回调函数*/</span>
  <span class="kt">void</span> <span class="nf">setNewConnectionCallback</span><span class="p">(</span><span class="k">const</span> <span class="n">NewConnectionCallback</span><span class="o">&amp;</span> <span class="n">cb</span><span class="p">)</span>
  <span class="p">{</span> <span class="n">newConnectionCallback_</span> <span class="o">=</span> <span class="n">cb</span><span class="p">;</span> <span class="p">}</span>
 
  <span class="kt">void</span> <span class="nf">start</span><span class="p">();</span>  <span class="c1">// can be called in any thread
</span><span class="c1"></span>  <span class="kt">void</span> <span class="nf">restart</span><span class="p">();</span>  <span class="c1">// must be called in loop thread
</span><span class="c1"></span>  <span class="kt">void</span> <span class="nf">stop</span><span class="p">();</span>  <span class="c1">// can be called in any thread
</span><span class="c1">//服务器IP地址
</span><span class="c1"></span>  <span class="k">const</span> <span class="n">InetAddress</span><span class="o">&amp;</span> <span class="n">serverAddress</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span> <span class="k">return</span> <span class="n">serverAddr_</span><span class="p">;</span> <span class="p">}</span>
 
 <span class="k">private</span><span class="o">:</span>
  <span class="k">enum</span> <span class="n">States</span> <span class="p">{</span> <span class="n">kDisconnected</span><span class="cm">/*断开状态*/</span><span class="p">,</span> <span class="n">kConnecting</span><span class="cm">/*正在连接中*/</span><span class="p">,</span> <span class="n">kConnected</span><span class="cm">/*已连接*/</span> <span class="p">};</span>
  <span class="k">static</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">kMaxRetryDelayMs</span> <span class="o">=</span> <span class="mi">30</span><span class="o">*</span><span class="mi">1000</span><span class="p">;</span>          <span class="c1">// 30秒，最大重连延迟时间
</span><span class="c1"></span>  <span class="k">static</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">kInitRetryDelayMs</span> <span class="o">=</span> <span class="mi">500</span><span class="p">;</span>             <span class="c1">// 0.5秒，初始状态，连接不上，0.5秒后重连
</span><span class="c1"></span> 
  <span class="kt">void</span> <span class="nf">setState</span><span class="p">(</span><span class="n">States</span> <span class="n">s</span><span class="p">)</span> <span class="p">{</span> <span class="n">state_</span> <span class="o">=</span> <span class="n">s</span><span class="p">;</span> <span class="p">}</span>
  <span class="kt">void</span> <span class="nf">startInLoop</span><span class="p">();</span>
  <span class="kt">void</span> <span class="nf">stopInLoop</span><span class="p">();</span>
  <span class="kt">void</span> <span class="nf">connect</span><span class="p">();</span>
  <span class="kt">void</span> <span class="nf">connecting</span><span class="p">(</span><span class="kt">int</span> <span class="n">sockfd</span><span class="p">);</span>
  <span class="kt">void</span> <span class="nf">handleWrite</span><span class="p">();</span>
  <span class="kt">void</span> <span class="nf">handleError</span><span class="p">();</span>
  <span class="kt">void</span> <span class="nf">retry</span><span class="p">(</span><span class="kt">int</span> <span class="n">sockfd</span><span class="p">);</span>
  <span class="kt">int</span> <span class="nf">removeAndResetChannel</span><span class="p">();</span>
  <span class="kt">void</span> <span class="nf">resetChannel</span><span class="p">();</span>
 
  <span class="n">EventLoop</span><span class="o">*</span> <span class="n">loop_</span><span class="p">;</span>         <span class="c1">// 所属EventLoop
</span><span class="c1"></span>  <span class="n">InetAddress</span> <span class="n">serverAddr_</span><span class="p">;</span>  <span class="c1">// 服务器端地址
</span><span class="c1"></span>  <span class="kt">bool</span> <span class="n">connect_</span><span class="p">;</span> <span class="c1">// atomic是否连接
</span><span class="c1"></span>  <span class="n">States</span> <span class="n">state_</span><span class="p">;</span>  <span class="c1">// FIXME: use atomic variable
</span><span class="c1"></span>  <span class="n">boost</span><span class="o">::</span><span class="n">scoped_ptr</span><span class="o">&lt;</span><span class="n">Channel</span><span class="o">&gt;</span> <span class="n">channel_</span><span class="p">;</span>    <span class="c1">// Connector所对应的Channel
</span><span class="c1"></span>  <span class="n">NewConnectionCallback</span> <span class="n">newConnectionCallback_</span><span class="p">;</span>     <span class="c1">// 连接成功回调函数，
</span><span class="c1"></span>  <span class="kt">int</span> <span class="n">retryDelayMs_</span><span class="p">;</span>        <span class="c1">// 重连延迟时间（单位：毫秒）
</span><span class="c1"></span><span class="p">};</span>
 
<span class="p">}</span>
<span class="p">}</span>
 
<span class="cp">#endif  </span><span class="c1">// MUDUO_NET_CONNECTOR_H
</span></code></pre></td></tr></table>
</div>
</div>
<h3 id="connector-源文件">Connector 源文件</h3>

<p>Connector.cc</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-c++" data-lang="c++"><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span><span class="lnt">177
</span><span class="lnt">178
</span><span class="lnt">179
</span><span class="lnt">180
</span><span class="lnt">181
</span><span class="lnt">182
</span><span class="lnt">183
</span><span class="lnt">184
</span><span class="lnt">185
</span><span class="lnt">186
</span><span class="lnt">187
</span><span class="lnt">188
</span><span class="lnt">189
</span><span class="lnt">190
</span><span class="lnt">191
</span><span class="lnt">192
</span><span class="lnt">193
</span><span class="lnt">194
</span><span class="lnt">195
</span><span class="lnt">196
</span><span class="lnt">197
</span><span class="lnt">198
</span><span class="lnt">199
</span><span class="lnt">200
</span><span class="lnt">201
</span><span class="lnt">202
</span><span class="lnt">203
</span><span class="lnt">204
</span><span class="lnt">205
</span><span class="lnt">206
</span><span class="lnt">207
</span><span class="lnt">208
</span><span class="lnt">209
</span><span class="lnt">210
</span><span class="lnt">211
</span><span class="lnt">212
</span><span class="lnt">213
</span><span class="lnt">214
</span><span class="lnt">215
</span><span class="lnt">216
</span><span class="lnt">217
</span><span class="lnt">218
</span><span class="lnt">219
</span><span class="lnt">220
</span><span class="lnt">221
</span><span class="lnt">222
</span><span class="lnt">223
</span><span class="lnt">224
</span><span class="lnt">225
</span><span class="lnt">226
</span><span class="lnt">227
</span><span class="lnt">228
</span><span class="lnt">229
</span><span class="lnt">230
</span><span class="lnt">231
</span><span class="lnt">232
</span><span class="lnt">233
</span><span class="lnt">234
</span><span class="lnt">235
</span><span class="lnt">236
</span><span class="lnt">237
</span><span class="lnt">238
</span><span class="lnt">239
</span><span class="lnt">240
</span><span class="lnt">241
</span><span class="lnt">242
</span><span class="lnt">243
</span><span class="lnt">244
</span><span class="lnt">245
</span><span class="lnt">246
</span><span class="lnt">247
</span><span class="lnt">248
</span><span class="lnt">249
</span><span class="lnt">250
</span><span class="lnt">251
</span><span class="lnt">252
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c++" data-lang="c++"><span class="c1">// Copyright 2010, Shuo Chen.  All rights reserved.
</span><span class="c1">// http://code.google.com/p/muduo/
</span><span class="c1">//
</span><span class="c1">// Use of this source code is governed by a BSD-style license
</span><span class="c1">// that can be found in the License file.
</span><span class="c1"></span> 
<span class="c1">// Author: Shuo Chen (chenshuo at chenshuo dot com)
</span><span class="c1">//
</span><span class="c1"></span> 
<span class="cp">#include</span> <span class="cpf">&lt;muduo/net/Connector.h&gt;</span><span class="cp">
</span><span class="cp"></span> 
<span class="cp">#include</span> <span class="cpf">&lt;muduo/base/Logging.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;muduo/net/Channel.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;muduo/net/EventLoop.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;muduo/net/SocketsOps.h&gt;</span><span class="cp">
</span><span class="cp"></span> 
<span class="cp">#include</span> <span class="cpf">&lt;boost/bind.hpp&gt;</span><span class="cp">
</span><span class="cp"></span> 
<span class="cp">#include</span> <span class="cpf">&lt;errno.h&gt;</span><span class="cp">
</span><span class="cp"></span> 
<span class="k">using</span> <span class="k">namespace</span> <span class="n">muduo</span><span class="p">;</span>
<span class="k">using</span> <span class="k">namespace</span> <span class="n">muduo</span><span class="o">::</span><span class="n">net</span><span class="p">;</span>
 
<span class="k">const</span> <span class="kt">int</span> <span class="n">Connector</span><span class="o">::</span><span class="n">kMaxRetryDelayMs</span><span class="p">;</span>
 
<span class="n">Connector</span><span class="o">::</span><span class="n">Connector</span><span class="p">(</span><span class="n">EventLoop</span><span class="o">*</span> <span class="n">loop</span><span class="p">,</span> <span class="k">const</span> <span class="n">InetAddress</span><span class="o">&amp;</span> <span class="n">serverAddr</span><span class="p">)</span>
  <span class="o">:</span> <span class="n">loop_</span><span class="p">(</span><span class="n">loop</span><span class="p">),</span>
    <span class="n">serverAddr_</span><span class="p">(</span><span class="n">serverAddr</span><span class="p">),</span>
    <span class="n">connect_</span><span class="p">(</span><span class="nb">false</span><span class="p">),</span>
    <span class="n">state_</span><span class="p">(</span><span class="n">kDisconnected</span><span class="p">),</span>
    <span class="n">retryDelayMs_</span><span class="p">(</span><span class="n">kInitRetryDelayMs</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">LOG_DEBUG</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;ctor[&#34;</span> <span class="o">&lt;&lt;</span> <span class="k">this</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;]&#34;</span><span class="p">;</span>
<span class="p">}</span>
 
<span class="n">Connector</span><span class="o">::~</span><span class="n">Connector</span><span class="p">()</span>
<span class="p">{</span>
  <span class="n">LOG_DEBUG</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;dtor[&#34;</span> <span class="o">&lt;&lt;</span> <span class="k">this</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;]&#34;</span><span class="p">;</span>
  <span class="n">assert</span><span class="p">(</span><span class="o">!</span><span class="n">channel_</span><span class="p">);</span>
<span class="p">}</span>
 
<span class="c1">// 可以跨线程调用 ，把重新发起的连接函数放到IO线程去，所以是线程
</span><span class="c1">// 安全的
</span><span class="c1"></span><span class="kt">void</span> <span class="n">Connector</span><span class="o">::</span><span class="n">start</span><span class="p">()</span>
<span class="p">{</span>
  <span class="n">connect_</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
  <span class="n">loop_</span><span class="o">-&gt;</span><span class="n">runInLoop</span><span class="p">(</span><span class="n">boost</span><span class="o">::</span><span class="n">bind</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Connector</span><span class="o">::</span><span class="n">startInLoop</span><span class="p">,</span> <span class="k">this</span><span class="p">));</span> <span class="c1">// FIXME: unsafe
</span><span class="c1"></span><span class="p">}</span>
 
<span class="cm">/*重新发起连接*/</span>
<span class="kt">void</span> <span class="n">Connector</span><span class="o">::</span><span class="n">startInLoop</span><span class="p">()</span>
<span class="p">{</span>
  <span class="n">loop_</span><span class="o">-&gt;</span><span class="n">assertInLoopThread</span><span class="p">();</span>
  <span class="n">assert</span><span class="p">(</span><span class="n">state_</span> <span class="o">==</span> <span class="n">kDisconnected</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">connect_</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="cm">/*如果为true 重新连接，
</span><span class="cm">    如果调用stop 后，那么connect_ = false
</span><span class="cm">    */</span>
    <span class="n">connect</span><span class="p">();</span>
  <span class="p">}</span>
  <span class="k">else</span>
  <span class="p">{</span>
    <span class="n">LOG_DEBUG</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;do not connect&#34;</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>
 
<span class="cm">/*让IO线程线程停止连接，这个连接处于*/</span>
<span class="kt">void</span> <span class="n">Connector</span><span class="o">::</span><span class="n">stop</span><span class="p">()</span>
<span class="p">{</span>
  <span class="n">connect_</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
  <span class="n">loop_</span><span class="o">-&gt;</span><span class="n">runInLoop</span><span class="p">(</span><span class="n">boost</span><span class="o">::</span><span class="n">bind</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Connector</span><span class="o">::</span><span class="n">stopInLoop</span><span class="p">,</span> <span class="k">this</span><span class="p">));</span> <span class="c1">// FIXME: unsafe
</span><span class="c1"></span>  <span class="c1">// FIXME: cancel timer
</span><span class="c1"></span><span class="p">}</span>
 
<span class="kt">void</span> <span class="n">Connector</span><span class="o">::</span><span class="n">stopInLoop</span><span class="p">()</span>
<span class="p">{</span>
  <span class="n">loop_</span><span class="o">-&gt;</span><span class="n">assertInLoopThread</span><span class="p">();</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">state_</span> <span class="o">==</span> <span class="n">kConnecting</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">setState</span><span class="p">(</span><span class="n">kDisconnected</span><span class="p">);</span>
    <span class="kt">int</span> <span class="n">sockfd</span> <span class="o">=</span> <span class="n">removeAndResetChannel</span><span class="p">();</span>   <span class="c1">// 将通道从poller中移除关注，并将channel置空
</span><span class="c1"></span>    <span class="n">retry</span><span class="p">(</span><span class="n">sockfd</span><span class="p">);</span>      <span class="c1">// 这里并非要重连，只是调用sockets::close(sockfd);
</span><span class="c1"></span>  <span class="p">}</span>
<span class="p">}</span>
 
<span class="cm">/*发起连接  */</span>
<span class="kt">void</span> <span class="n">Connector</span><span class="o">::</span><span class="n">connect</span><span class="p">()</span>
<span class="p">{</span>
  <span class="kt">int</span> <span class="n">sockfd</span> <span class="o">=</span> <span class="n">sockets</span><span class="o">::</span><span class="n">createNonblockingOrDie</span><span class="p">();</span>   <span class="c1">// 创建非阻塞套接字
</span><span class="c1"></span>  <span class="cm">/*进行连接请求*/</span>
  <span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">sockets</span><span class="o">::</span><span class="n">connect</span><span class="p">(</span><span class="n">sockfd</span><span class="p">,</span> <span class="n">serverAddr_</span><span class="p">.</span><span class="n">getSockAddrInet</span><span class="p">());</span>
 
  <span class="kt">int</span> <span class="n">savedErrno</span> <span class="o">=</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">errno</span><span class="p">;</span>
  <span class="k">switch</span> <span class="p">(</span><span class="n">savedErrno</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="k">case</span> <span class="mi">0</span><span class="o">:</span>
    <span class="k">case</span> <span class="nl">EINPROGRESS</span><span class="p">:</span>   <span class="c1">// 非阻塞套接字，未连接成功返回码是EINPROGRESS表示正在连接
</span><span class="c1"></span>    <span class="k">case</span> <span class="nl">EINTR</span><span class="p">:</span>
    <span class="k">case</span> <span class="nl">EISCONN</span><span class="p">:</span>           <span class="c1">// 连接成功
</span><span class="c1"></span>      <span class="n">connecting</span><span class="p">(</span><span class="n">sockfd</span><span class="p">);</span>
      <span class="k">break</span><span class="p">;</span>
 
    <span class="k">case</span> <span class="nl">EAGAIN</span><span class="p">:</span>
    <span class="k">case</span> <span class="nl">EADDRINUSE</span><span class="p">:</span>
    <span class="k">case</span> <span class="nl">EADDRNOTAVAIL</span><span class="p">:</span>
    <span class="k">case</span> <span class="nl">ECONNREFUSED</span><span class="p">:</span>
    <span class="k">case</span> <span class="nl">ENETUNREACH</span><span class="p">:</span>
      <span class="n">retry</span><span class="p">(</span><span class="n">sockfd</span><span class="p">);</span>        <span class="c1">// 重连
</span><span class="c1"></span>      <span class="k">break</span><span class="p">;</span>
 
    <span class="k">case</span> <span class="nl">EACCES</span><span class="p">:</span>
    <span class="k">case</span> <span class="nl">EPERM</span><span class="p">:</span>
    <span class="k">case</span> <span class="nl">EAFNOSUPPORT</span><span class="p">:</span>
    <span class="k">case</span> <span class="nl">EALREADY</span><span class="p">:</span>
    <span class="k">case</span> <span class="nl">EBADF</span><span class="p">:</span>
    <span class="k">case</span> <span class="nl">EFAULT</span><span class="p">:</span>
    <span class="k">case</span> <span class="nl">ENOTSOCK</span><span class="p">:</span>
      <span class="n">LOG_SYSERR</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;connect error in Connector::startInLoop &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">savedErrno</span><span class="p">;</span>
      <span class="n">sockets</span><span class="o">::</span><span class="n">close</span><span class="p">(</span><span class="n">sockfd</span><span class="p">);</span>   <span class="c1">// 不能重连，关闭sockfd
</span><span class="c1"></span>      <span class="k">break</span><span class="p">;</span>
 
    <span class="k">default</span><span class="o">:</span>
      <span class="n">LOG_SYSERR</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;Unexpected error in Connector::startInLoop &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">savedErrno</span><span class="p">;</span>
      <span class="n">sockets</span><span class="o">::</span><span class="n">close</span><span class="p">(</span><span class="n">sockfd</span><span class="p">);</span>
      <span class="c1">// connectErrorCallback_();
</span><span class="c1"></span>      <span class="k">break</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>
 
<span class="c1">// 不能跨线程调用
</span><span class="c1"></span><span class="kt">void</span> <span class="n">Connector</span><span class="o">::</span><span class="n">restart</span><span class="p">()</span>
<span class="p">{</span>
  <span class="n">loop_</span><span class="o">-&gt;</span><span class="n">assertInLoopThread</span><span class="p">();</span>
  <span class="n">setState</span><span class="p">(</span><span class="n">kDisconnected</span><span class="p">);</span>
  <span class="n">retryDelayMs_</span> <span class="o">=</span> <span class="n">kInitRetryDelayMs</span><span class="p">;</span>
  <span class="n">connect_</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
  <span class="n">startInLoop</span><span class="p">();</span>
<span class="p">}</span>
 
<span class="kt">void</span> <span class="n">Connector</span><span class="o">::</span><span class="n">connecting</span><span class="p">(</span><span class="kt">int</span> <span class="n">sockfd</span><span class="p">)</span>
<span class="p">{</span>
  <span class="c1">//不管是真正连接还是连接成功了，都把状态设置为kConnecting
</span><span class="c1"></span>  <span class="n">setState</span><span class="p">(</span><span class="n">kConnecting</span><span class="p">);</span>
  <span class="n">assert</span><span class="p">(</span><span class="o">!</span><span class="n">channel_</span><span class="p">);</span>
  <span class="c1">// Channel与sockfd关联
</span><span class="c1"></span>  <span class="n">channel_</span><span class="p">.</span><span class="n">reset</span><span class="p">(</span><span class="k">new</span> <span class="n">Channel</span><span class="p">(</span><span class="n">loop_</span><span class="p">,</span> <span class="n">sockfd</span><span class="p">));</span>
  <span class="c1">// 设置可写回调函数，主要是为了“正在连接”状态设置的
</span><span class="c1"></span>  <span class="n">channel_</span><span class="o">-&gt;</span><span class="n">setWriteCallback</span><span class="p">(</span>
      <span class="n">boost</span><span class="o">::</span><span class="n">bind</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Connector</span><span class="o">::</span><span class="n">handleWrite</span><span class="p">,</span> <span class="k">this</span><span class="p">));</span> <span class="c1">// FIXME: unsafe
</span><span class="c1"></span>  <span class="c1">// 设置错误回调函数
</span><span class="c1"></span>  <span class="n">channel_</span><span class="o">-&gt;</span><span class="n">setErrorCallback</span><span class="p">(</span>
      <span class="n">boost</span><span class="o">::</span><span class="n">bind</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Connector</span><span class="o">::</span><span class="n">handleError</span><span class="p">,</span> <span class="k">this</span><span class="p">));</span> <span class="c1">// FIXME: unsafe
</span><span class="c1"></span> 
  <span class="c1">// channel_-&gt;tie(shared_from_this()); is not working,
</span><span class="c1"></span>  <span class="c1">// as channel_ is not managed by shared_ptr
</span><span class="c1"></span> 
  <span class="n">channel_</span><span class="o">-&gt;</span><span class="n">enableWriting</span><span class="p">();</span>     <span class="c1">// 让Poller关注可写事件，writing一定产生，不管是连接成功还是连接失败，
</span><span class="c1"></span>                                <span class="c1">//
</span><span class="c1"></span><span class="p">}</span>
 
<span class="kt">int</span> <span class="n">Connector</span><span class="o">::</span><span class="n">removeAndResetChannel</span><span class="p">()</span>
<span class="p">{</span>
  <span class="n">channel_</span><span class="o">-&gt;</span><span class="n">disableAll</span><span class="p">();</span>
  <span class="n">channel_</span><span class="o">-&gt;</span><span class="n">remove</span><span class="p">();</span>            <span class="c1">// 从poller移除关注
</span><span class="c1"></span>  <span class="kt">int</span> <span class="n">sockfd</span> <span class="o">=</span> <span class="n">channel_</span><span class="o">-&gt;</span><span class="n">fd</span><span class="p">();</span>
  <span class="c1">// Can&#39;t reset channel_ here, because we are inside Channel::handleEvent
</span><span class="c1"></span>  <span class="c1">// 不能在这里重置channel_，因为正在调用Channel::handleEvent
</span><span class="c1"></span>  <span class="n">loop_</span><span class="o">-&gt;</span><span class="n">queueInLoop</span><span class="p">(</span><span class="n">boost</span><span class="o">::</span><span class="n">bind</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Connector</span><span class="o">::</span><span class="n">resetChannel</span><span class="p">,</span> <span class="k">this</span><span class="p">));</span> <span class="c1">// FIXME: unsafe
</span><span class="c1"></span>  <span class="k">return</span> <span class="n">sockfd</span><span class="p">;</span>
<span class="p">}</span>
 
<span class="kt">void</span> <span class="n">Connector</span><span class="o">::</span><span class="n">resetChannel</span><span class="p">()</span>
<span class="p">{</span>
  <span class="n">channel_</span><span class="p">.</span><span class="n">reset</span><span class="p">();</span>     <span class="c1">// channel_ 置空
</span><span class="c1"></span><span class="p">}</span>
 
 
<span class="kt">void</span> <span class="n">Connector</span><span class="o">::</span><span class="n">handleWrite</span><span class="p">()</span>
<span class="p">{</span>
  <span class="n">LOG_TRACE</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;Connector::handleWrite &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">state_</span><span class="p">;</span>
  <span class="cm">/*由于在Connector::connecting注册可写事件时，“状态” 被设置为kConnecting（不管完不完成连接），
</span><span class="cm">  所以第一次handleWrite时，得把“状态”设置为kConnected*/</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">state_</span> <span class="o">==</span> <span class="n">kConnecting</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="cm">/*这里不用再关注可写事件了，这里也是防止busy loop*/</span>
    <span class="kt">int</span> <span class="n">sockfd</span> <span class="o">=</span> <span class="n">removeAndResetChannel</span><span class="p">();</span>   <span class="c1">// 从poller中移除关注，并将channel置空
</span><span class="c1"></span>    <span class="c1">// socket可写并不意味着连接一定建立成功
</span><span class="c1"></span>    <span class="c1">// 还需要用getsockopt(sockfd, SOL_SOCKET, SO_ERROR, ...)再次确认一下。
</span><span class="c1"></span>    <span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="n">sockets</span><span class="o">::</span><span class="n">getSocketError</span><span class="p">(</span><span class="n">sockfd</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>        <span class="c1">// 有错误
</span><span class="c1"></span>    <span class="p">{</span>
      <span class="n">LOG_WARN</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;Connector::handleWrite - SO_ERROR = &#34;</span>
               <span class="o">&lt;&lt;</span> <span class="n">err</span> <span class="o">&lt;&lt;</span> <span class="s">&#34; &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">strerror_tl</span><span class="p">(</span><span class="n">err</span><span class="p">);</span>
      <span class="n">retry</span><span class="p">(</span><span class="n">sockfd</span><span class="p">);</span>        <span class="c1">// 重连
</span><span class="c1"></span>    <span class="p">}</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">sockets</span><span class="o">::</span><span class="n">isSelfConnect</span><span class="p">(</span><span class="n">sockfd</span><span class="p">))</span>        <span class="c1">// 自连接
</span><span class="c1"></span>    <span class="p">{</span>
      <span class="n">LOG_WARN</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;Connector::handleWrite - Self connect&#34;</span><span class="p">;</span>
      <span class="n">retry</span><span class="p">(</span><span class="n">sockfd</span><span class="p">);</span>        <span class="c1">// 重连
</span><span class="c1"></span>    <span class="p">}</span>
    <span class="k">else</span>    <span class="c1">// 连接成功
</span><span class="c1"></span>    <span class="p">{</span>
      <span class="n">setState</span><span class="p">(</span><span class="n">kConnected</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">connect_</span><span class="p">)</span>
      <span class="p">{</span>
        <span class="n">newConnectionCallback_</span><span class="p">(</span><span class="n">sockfd</span><span class="p">);</span>     <span class="c1">// 回调连接成功的回调函数
</span><span class="c1"></span>      <span class="p">}</span>
      <span class="k">else</span>
      <span class="p">{</span>
        <span class="n">sockets</span><span class="o">::</span><span class="n">close</span><span class="p">(</span><span class="n">sockfd</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="k">else</span>
  <span class="p">{</span>
    <span class="c1">// what happened?
</span><span class="c1"></span>    <span class="n">assert</span><span class="p">(</span><span class="n">state_</span> <span class="o">==</span> <span class="n">kDisconnected</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>
 
<span class="cm">/*连接出错的处理函数*/</span>
<span class="kt">void</span> <span class="n">Connector</span><span class="o">::</span><span class="n">handleError</span><span class="p">()</span>
<span class="p">{</span>
  <span class="n">LOG_ERROR</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;Connector::handleError&#34;</span><span class="p">;</span>
  <span class="n">assert</span><span class="p">(</span><span class="n">state_</span> <span class="o">==</span> <span class="n">kConnecting</span><span class="p">);</span>
 
  <span class="kt">int</span> <span class="n">sockfd</span> <span class="o">=</span> <span class="n">removeAndResetChannel</span><span class="p">();</span>     <span class="c1">// 从poller中移除关注，并将channel置空
</span><span class="c1"></span>  <span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="n">sockets</span><span class="o">::</span><span class="n">getSocketError</span><span class="p">(</span><span class="n">sockfd</span><span class="p">);</span>
  <span class="n">LOG_TRACE</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;SO_ERROR = &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">err</span> <span class="o">&lt;&lt;</span> <span class="s">&#34; &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">strerror_tl</span><span class="p">(</span><span class="n">err</span><span class="p">);</span>
  <span class="n">retry</span><span class="p">(</span><span class="n">sockfd</span><span class="p">);</span>
<span class="p">}</span>
 
<span class="c1">// 采用back-off策略重连，即重连时间逐渐延长，0.5s, 1s, 2s, ...直至30s
</span><span class="c1"></span><span class="kt">void</span> <span class="n">Connector</span><span class="o">::</span><span class="n">retry</span><span class="p">(</span><span class="kt">int</span> <span class="n">sockfd</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">sockets</span><span class="o">::</span><span class="n">close</span><span class="p">(</span><span class="n">sockfd</span><span class="p">);</span>
  <span class="n">setState</span><span class="p">(</span><span class="n">kDisconnected</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">connect_</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">LOG_INFO</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;Connector::retry - Retry connecting to &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">serverAddr_</span><span class="p">.</span><span class="n">toIpPort</span><span class="p">()</span>
             <span class="o">&lt;&lt;</span> <span class="s">&#34; in &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">retryDelayMs_</span> <span class="o">&lt;&lt;</span> <span class="s">&#34; milliseconds. &#34;</span><span class="p">;</span>
    <span class="c1">// 注册一个定时操作，重连
</span><span class="c1"></span>    <span class="n">loop_</span><span class="o">-&gt;</span><span class="n">runAfter</span><span class="p">(</span><span class="n">retryDelayMs_</span><span class="o">/</span><span class="mf">1000.0</span><span class="p">,</span>
                    <span class="n">boost</span><span class="o">::</span><span class="n">bind</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Connector</span><span class="o">::</span><span class="n">startInLoop</span><span class="p">,</span> <span class="n">shared_from_this</span><span class="p">()));</span>
    <span class="n">retryDelayMs_</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">min</span><span class="p">(</span><span class="n">retryDelayMs_</span> <span class="o">*</span> <span class="mi">2</span><span class="p">,</span> <span class="n">kMaxRetryDelayMs</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">else</span>
  <span class="p">{</span>
    <span class="n">LOG_DEBUG</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;do not connect&#34;</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div>
<h3 id="测试程序-4">测试程序</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-c++" data-lang="c++"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c++" data-lang="c++"><span class="cp">#include</span> <span class="cpf">&lt;muduo/net/Channel.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;muduo/net/TcpClient.h&gt;</span><span class="cp">
</span><span class="cp"></span> 
<span class="cp">#include</span> <span class="cpf">&lt;muduo/base/Logging.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;muduo/net/EventLoop.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;muduo/net/InetAddress.h&gt;</span><span class="cp">
</span><span class="cp"></span> 
<span class="cp">#include</span> <span class="cpf">&lt;boost/bind.hpp&gt;</span><span class="cp">
</span><span class="cp"></span> 
<span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
</span><span class="cp"></span> 
<span class="k">using</span> <span class="k">namespace</span> <span class="n">muduo</span><span class="p">;</span>
<span class="k">using</span> <span class="k">namespace</span> <span class="n">muduo</span><span class="o">::</span><span class="n">net</span><span class="p">;</span>
 
<span class="k">class</span><span class="err"> </span><span class="nc">TestClient</span>
<span class="p">{</span>
 <span class="k">public</span><span class="o">:</span>
  <span class="n">TestClient</span><span class="p">(</span><span class="n">EventLoop</span><span class="o">*</span> <span class="n">loop</span><span class="p">,</span> <span class="k">const</span> <span class="n">InetAddress</span><span class="o">&amp;</span> <span class="n">listenAddr</span><span class="p">)</span>
    <span class="o">:</span> <span class="n">loop_</span><span class="p">(</span><span class="n">loop</span><span class="p">),</span>
      <span class="n">client_</span><span class="p">(</span><span class="n">loop</span><span class="p">,</span> <span class="n">listenAddr</span><span class="p">,</span> <span class="s">&#34;TestClient&#34;</span><span class="p">),</span>
      <span class="n">stdinChannel_</span><span class="p">(</span><span class="n">loop</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">client_</span><span class="p">.</span><span class="n">setConnectionCallback</span><span class="p">(</span>
        <span class="n">boost</span><span class="o">::</span><span class="n">bind</span><span class="p">(</span><span class="o">&amp;</span><span class="n">TestClient</span><span class="o">::</span><span class="n">onConnection</span><span class="p">,</span> <span class="k">this</span><span class="p">,</span> <span class="n">_1</span><span class="p">));</span>
    <span class="n">client_</span><span class="p">.</span><span class="n">setMessageCallback</span><span class="p">(</span>
        <span class="n">boost</span><span class="o">::</span><span class="n">bind</span><span class="p">(</span><span class="o">&amp;</span><span class="n">TestClient</span><span class="o">::</span><span class="n">onMessage</span><span class="p">,</span> <span class="k">this</span><span class="p">,</span> <span class="n">_1</span><span class="p">,</span> <span class="n">_2</span><span class="p">,</span> <span class="n">_3</span><span class="p">));</span>
    <span class="c1">//client_.enableRetry();
</span><span class="c1"></span>    <span class="c1">// 标准输入缓冲区中有数据的时候，回调TestClient::handleRead
</span><span class="c1"></span>    <span class="n">stdinChannel_</span><span class="p">.</span><span class="n">setReadCallback</span><span class="p">(</span><span class="n">boost</span><span class="o">::</span><span class="n">bind</span><span class="p">(</span><span class="o">&amp;</span><span class="n">TestClient</span><span class="o">::</span><span class="n">handleRead</span><span class="p">,</span> <span class="k">this</span><span class="p">));</span>
    <span class="n">stdinChannel_</span><span class="p">.</span><span class="n">enableReading</span><span class="p">();</span>
  <span class="p">}</span>
 
  <span class="kt">void</span> <span class="n">connect</span><span class="p">()</span>
  <span class="p">{</span>
    <span class="n">client_</span><span class="p">.</span><span class="n">connect</span><span class="p">();</span>
  <span class="p">}</span>
 
 <span class="k">private</span><span class="o">:</span>
  <span class="kt">void</span> <span class="n">onConnection</span><span class="p">(</span><span class="k">const</span> <span class="n">TcpConnectionPtr</span><span class="o">&amp;</span> <span class="n">conn</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">connected</span><span class="p">())</span>
    <span class="p">{</span>
      <span class="n">printf</span><span class="p">(</span><span class="s">&#34;onConnection(): new connection [%s] from %s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span>
             <span class="n">conn</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">().</span><span class="n">c_str</span><span class="p">(),</span>
             <span class="n">conn</span><span class="o">-&gt;</span><span class="n">peerAddress</span><span class="p">().</span><span class="n">toIpPort</span><span class="p">().</span><span class="n">c_str</span><span class="p">());</span>
    <span class="p">}</span>
    <span class="k">else</span>
    <span class="p">{</span>
      <span class="n">printf</span><span class="p">(</span><span class="s">&#34;onConnection(): connection [%s] is down</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span>
             <span class="n">conn</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">().</span><span class="n">c_str</span><span class="p">());</span>
    <span class="p">}</span>
  <span class="p">}</span>
 
  <span class="kt">void</span> <span class="n">onMessage</span><span class="p">(</span><span class="k">const</span> <span class="n">TcpConnectionPtr</span><span class="o">&amp;</span> <span class="n">conn</span><span class="p">,</span> <span class="n">Buffer</span><span class="o">*</span> <span class="n">buf</span><span class="p">,</span> <span class="n">Timestamp</span> <span class="n">time</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">string</span> <span class="n">msg</span><span class="p">(</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">retrieveAllAsString</span><span class="p">());</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;onMessage(): recv a message [%s]</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">msg</span><span class="p">.</span><span class="n">c_str</span><span class="p">());</span>
    <span class="n">LOG_TRACE</span> <span class="o">&lt;&lt;</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="s">&#34; recv &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">msg</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="s">&#34; bytes at &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">time</span><span class="p">.</span><span class="n">toFormattedString</span><span class="p">();</span>
  <span class="p">}</span>
 
  <span class="c1">// 标准输入缓冲区中有数据的时候，回调该函数
</span><span class="c1"></span>  <span class="kt">void</span> <span class="n">handleRead</span><span class="p">()</span>
  <span class="p">{</span>
    <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">1024</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>
    <span class="n">fgets</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">1024</span><span class="p">,</span> <span class="n">stdin</span><span class="p">);</span>
    <span class="n">buf</span><span class="p">[</span><span class="n">strlen</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>      <span class="c1">// 去除\n
</span><span class="c1"></span>    <span class="n">client_</span><span class="p">.</span><span class="n">connection</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">send</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
  <span class="p">}</span>
 
  <span class="n">EventLoop</span><span class="o">*</span> <span class="n">loop_</span><span class="p">;</span>
  <span class="n">TcpClient</span> <span class="n">client_</span><span class="p">;</span>
  <span class="n">Channel</span> <span class="n">stdinChannel_</span><span class="p">;</span>        <span class="c1">// 标准输入Channel
</span><span class="c1"></span><span class="p">};</span>
 
<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span><span class="o">*</span> <span class="n">argv</span><span class="p">[])</span>
<span class="p">{</span>
  <span class="n">LOG_INFO</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;pid = &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">getpid</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;, tid = &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">CurrentThread</span><span class="o">::</span><span class="n">tid</span><span class="p">();</span>
  <span class="n">EventLoop</span> <span class="n">loop</span><span class="p">;</span>
  <span class="n">InetAddress</span> <span class="n">serverAddr</span><span class="p">(</span><span class="s">&#34;127.0.0.1&#34;</span><span class="p">,</span> <span class="mi">8888</span><span class="p">);</span>
  <span class="n">TestClient</span> <span class="n">client</span><span class="p">(</span><span class="o">&amp;</span><span class="n">loop</span><span class="p">,</span> <span class="n">serverAddr</span><span class="p">);</span>
  <span class="n">client</span><span class="p">.</span><span class="n">connect</span><span class="p">();</span>
  <span class="n">loop</span><span class="p">.</span><span class="n">loop</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div>
<h2 id="40-http-简单描述">[40] http 简单描述</h2>

<h3 id="http-request">http request</h3>

<p><code>request line</code> + <code>header</code> + <code>body</code> (<code>header</code>分为普通报头，请求报头与实体报头) <code>header</code>与<code>body</code>之间有一空行(<code>CRLF</code>)</p>

<h4 id="请求方法有">请求方法有</h4>

<p><code>Get</code>, <code>Post</code>, <code>Head</code>, <code>Put</code>, <code>Delete</code>等</p>

<p>协议版本号：<code>1.0</code>, <code>1.1</code></p>

<h4 id="常用请求头">常用请求头</h4>

<ul>
<li>Accept：浏览器可接受的媒体（MIME）类型；</li>
<li>Accept-Language：浏览器所希望的语言种类</li>
<li>Accept-Encoding：浏览器能够解码的编码方法，如gzip，deflate等</li>
<li>User-Agent：告诉HTTP服务器， 客户端使用的操作系统和浏览器的名称和版本</li>
<li>Connection：表示是否需要持久连接，Keep-Alive表示长连接，close表示短连接</li>
</ul>

<h3 id="http-response">http response</h3>

<p>status line + header + body （header分为普通报头，响应报头与实体报头）
header与body之间有一空行（CRLF）</p>

<p>状态响应码</p>

<ul>
<li>1XX  提示信息
表示请求已被成功接收，继续处理</li>
<li>2XX  成功
表示请求已被成功接收，理解，接受</li>
<li>3XX  重定向
要完成请求必须进行更进一步的处理</li>
<li>4XX  客户端错误
请求有语法错误或请求无法实现</li>
<li>5XX  服务器端错误
服务器执行一个有效请求失败</li>
</ul>

<h3 id="一个典型的http请求">一个典型的http请求</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-c++" data-lang="c++"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c++" data-lang="c++"><span class="n">GET</span> <span class="o">/</span> <span class="n">HTTP</span><span class="o">/</span><span class="mf">1.1</span> <span class="p">(</span><span class="err">请求行</span><span class="p">)</span>
<span class="nl">Accept</span><span class="p">:</span> <span class="n">image</span><span class="o">/</span><span class="n">jpeg</span><span class="p">,</span> <span class="n">application</span><span class="o">/</span><span class="n">x</span><span class="o">-</span><span class="n">ms</span><span class="o">-</span><span class="n">application</span><span class="p">,</span> <span class="n">image</span><span class="o">/</span><span class="n">gif</span><span class="p">,</span> <span class="n">application</span><span class="o">/</span><span class="n">xaml</span><span class="o">+</span><span class="n">xml</span><span class="p">,</span> <span class="n">image</span><span class="o">/</span><span class="n">pjpeg</span><span class="p">,</span> <span class="n">application</span><span class="o">/</span><span class="n">x</span><span class="o">-</span><span class="n">ms</span><span class="o">-</span><span class="n">xbap</span><span class="p">,</span> <span class="n">application</span><span class="o">/</span><span class="n">vnd</span><span class="p">.</span><span class="n">ms</span><span class="o">-</span><span class="n">excel</span><span class="p">,</span> <span class="n">application</span><span class="o">/</span><span class="n">vnd</span><span class="p">.</span><span class="n">ms</span><span class="o">-</span><span class="n">powerpoint</span><span class="p">,</span> <span class="n">application</span><span class="o">/</span><span class="n">msword</span><span class="p">,</span> <span class="err">*/</span><span class="o">*</span><span class="p">(</span><span class="err">请求头</span><span class="p">)</span>
<span class="n">Accept</span><span class="o">-</span><span class="nl">Language</span><span class="p">:</span> <span class="n">zh</span><span class="o">-</span><span class="n">CN</span><span class="p">(</span><span class="err">请求头</span><span class="p">)</span>
<span class="n">User</span><span class="o">-</span><span class="nl">Agent</span><span class="p">:</span> <span class="n">Mozilla</span><span class="o">/</span><span class="mf">4.0</span> <span class="p">(</span><span class="n">compatible</span><span class="p">;</span> <span class="n">MSIE</span> <span class="mf">8.0</span><span class="p">;</span> <span class="n">Windows</span> <span class="n">NT</span> <span class="mf">6.1</span><span class="p">;</span> <span class="n">Trident</span><span class="o">/</span><span class="mf">4.0</span><span class="p">;</span> <span class="n">SLCC2</span><span class="p">;</span> <span class="p">.</span><span class="n">NET</span> <span class="n">CLR</span> <span class="mf">2.0.50727</span><span class="p">;</span> <span class="p">.</span><span class="n">NET</span> <span class="n">CLR</span> <span class="mf">3.5.30729</span><span class="p">;</span> <span class="p">.</span><span class="n">NET</span> <span class="n">CLR</span> <span class="mf">3.0.30729</span><span class="p">;</span> <span class="n">Media</span> <span class="n">Center</span> <span class="n">PC</span> <span class="mf">6.0</span><span class="p">;</span> <span class="n">Tablet</span> <span class="n">PC</span> <span class="mf">2.0</span><span class="p">)(</span><span class="err">请求头</span><span class="p">)</span>
<span class="n">Accept</span><span class="o">-</span><span class="nl">Encoding</span><span class="p">:</span> <span class="n">gzip</span><span class="p">,</span> <span class="n">deflate</span><span class="p">(</span><span class="err">请求头</span><span class="p">)</span>
<span class="nl">Host</span><span class="p">:</span> <span class="mf">192.168.159.188</span><span class="o">:</span><span class="mi">800</span><span class="p">(</span><span class="err">请求头</span><span class="p">)</span>
<span class="nl">Connection</span><span class="p">:</span> <span class="n">Keep</span><span class="o">-</span><span class="n">Alive</span><span class="p">(</span><span class="err">请求头</span><span class="p">)</span>

<span class="cm">/*当前是get请求，没有body，如果是post请求的话会有实体*/</span>
</code></pre></td></tr></table>
</div>
</div>
<h3 id="一个典型的http应答">一个典型的http应答</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-c++" data-lang="c++"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c++" data-lang="c++"><span class="n">HTTP</span><span class="o">/</span><span class="mf">1.1</span> <span class="mi">200</span> <span class="n">OK</span><span class="p">(</span><span class="err">请求行</span><span class="p">)</span>
<span class="n">Content</span><span class="o">-</span><span class="nl">Length</span><span class="p">:</span> <span class="mi">112</span><span class="p">(</span><span class="err">头部</span><span class="p">)</span>
<span class="nl">Connection</span><span class="p">:</span> <span class="n">Keep</span><span class="o">-</span><span class="n">Alive</span><span class="p">(</span><span class="err">头部</span><span class="p">)</span>
<span class="n">Content</span><span class="o">-</span><span class="nl">Type</span><span class="p">:</span> <span class="n">text</span><span class="o">/</span><span class="n">html</span><span class="p">(</span><span class="err">头部</span><span class="p">)</span>
<span class="nl">Server</span><span class="p">:</span> <span class="n">Muduo</span><span class="p">(</span><span class="err">头部</span><span class="p">)</span>

<span class="o">&lt;</span><span class="n">html</span><span class="o">&gt;&lt;</span><span class="n">head</span><span class="o">&gt;&lt;</span><span class="n">title</span><span class="o">&gt;</span><span class="n">This</span> <span class="n">is</span> <span class="n">title</span><span class="o">&lt;/</span><span class="n">title</span><span class="o">&gt;&lt;/</span><span class="n">head</span><span class="o">&gt;&lt;</span><span class="n">body</span><span class="o">&gt;&lt;</span><span class="n">h1</span><span class="o">&gt;</span><span class="n">Hello</span><span class="o">&lt;/</span><span class="n">h1</span><span class="o">&gt;</span><span class="n">Now</span> <span class="n">is</span> <span class="mi">20130611</span> <span class="mo">02</span><span class="o">:</span><span class="mi">14</span><span class="o">:</span><span class="mf">31.518462</span><span class="o">&lt;/</span><span class="n">body</span><span class="o">&gt;&lt;/</span><span class="n">html</span><span class="o">&gt;</span><span class="p">(</span><span class="err">实体</span><span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div>
<h3 id="muduo-http库涉及到的类">muduo_http库涉及到的类</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-c++" data-lang="c++"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c++" data-lang="c++"><span class="n">HttpRequest</span><span class="err">：</span><span class="n">http请求类封装</span>
<span class="n">HttpResponse</span><span class="err">：</span><span class="n">http响应类封装</span>
<span class="n">HttpContext</span><span class="err">：</span><span class="n">http协议解析类</span>
<span class="n">HttpServer</span><span class="err">：</span><span class="n">http服务器类封装</span>
</code></pre></td></tr></table>
</div>
</div>
<h2 id="40-1-http实现源码">[40-1] http实现源码</h2>

<h3 id="httprequest头文件-包含实现">HttpRequest头文件(包含实现)</h3>

<p>HttpResquest.h</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-c++" data-lang="c++"><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span><span class="lnt">177
</span><span class="lnt">178
</span><span class="lnt">179
</span><span class="lnt">180
</span><span class="lnt">181
</span><span class="lnt">182
</span><span class="lnt">183
</span><span class="lnt">184
</span><span class="lnt">185
</span><span class="lnt">186
</span><span class="lnt">187
</span><span class="lnt">188
</span><span class="lnt">189
</span><span class="lnt">190
</span><span class="lnt">191
</span><span class="lnt">192
</span><span class="lnt">193
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c++" data-lang="c++"><span class="c1">// Copyright 2010, Shuo Chen.  All rights reserved.
</span><span class="c1">// http://code.google.com/p/muduo/
</span><span class="c1">//
</span><span class="c1">// Use of this source code is governed by a BSD-style license
</span><span class="c1">// that can be found in the License file.
</span><span class="c1"></span> 
<span class="c1">// Author: Shuo Chen (chenshuo at chenshuo dot com)
</span><span class="c1">//
</span><span class="c1">// This is a public header file, it must only include public header files.
</span><span class="c1"></span> 
<span class="cp">#ifndef MUDUO_NET_HTTP_HTTPREQUEST_H
</span><span class="cp">#define MUDUO_NET_HTTP_HTTPREQUEST_H
</span><span class="cp"></span> 
<span class="cp">#include</span> <span class="cpf">&lt;muduo/base/copyable.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;muduo/base/Timestamp.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;muduo/base/Types.h&gt;</span><span class="cp">
</span><span class="cp"></span> 
<span class="cp">#include</span> <span class="cpf">&lt;map&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;assert.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
</span><span class="cp"></span> 
<span class="k">namespace</span> <span class="n">muduo</span>
<span class="p">{</span>
<span class="k">namespace</span> <span class="n">net</span>
<span class="p">{</span>
 
<span class="k">class</span><span class="err"> </span><span class="nc">HttpRequest</span> <span class="o">:</span> <span class="k">public</span> <span class="n">muduo</span><span class="o">::</span><span class="n">copyable</span>
<span class="p">{</span>
 <span class="k">public</span><span class="o">:</span>
  <span class="k">enum</span> <span class="n">Method</span>
  <span class="p">{</span>
    <span class="n">kInvalid</span><span class="p">,</span> <span class="n">kGet</span><span class="p">,</span> <span class="n">kPost</span><span class="p">,</span> <span class="n">kHead</span><span class="p">,</span> <span class="n">kPut</span><span class="p">,</span> <span class="n">kDelete</span>
  <span class="p">};</span>
  <span class="k">enum</span> <span class="n">Version</span>
  <span class="p">{</span>
    <span class="n">kUnknown</span><span class="p">,</span> <span class="n">kHttp10</span><span class="p">,</span> <span class="n">kHttp11</span>
  <span class="p">};</span>
 
  <span class="n">HttpRequest</span><span class="p">()</span>
    <span class="o">:</span> <span class="n">method_</span><span class="p">(</span><span class="n">kInvalid</span><span class="p">),</span>
      <span class="n">version_</span><span class="p">(</span><span class="n">kUnknown</span><span class="p">)</span>
  <span class="p">{</span>
  <span class="p">}</span>
 
  <span class="kt">void</span> <span class="n">setVersion</span><span class="p">(</span><span class="n">Version</span> <span class="n">v</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">version_</span> <span class="o">=</span> <span class="n">v</span><span class="p">;</span>
  <span class="p">}</span>
 
  <span class="n">Version</span> <span class="n">getVersion</span><span class="p">()</span> <span class="k">const</span>
  <span class="p">{</span> <span class="k">return</span> <span class="n">version_</span><span class="p">;</span> <span class="p">}</span>
 
<span class="cm">/*设置请求方法*/</span>
  <span class="kt">bool</span> <span class="n">setMethod</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">start</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">end</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">assert</span><span class="p">(</span><span class="n">method_</span> <span class="o">==</span> <span class="n">kInvalid</span><span class="p">);</span>
    <span class="n">string</span> <span class="nf">m</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">m</span> <span class="o">==</span> <span class="s">&#34;GET&#34;</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">method_</span> <span class="o">=</span> <span class="n">kGet</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">m</span> <span class="o">==</span> <span class="s">&#34;POST&#34;</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">method_</span> <span class="o">=</span> <span class="n">kPost</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">m</span> <span class="o">==</span> <span class="s">&#34;HEAD&#34;</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">method_</span> <span class="o">=</span> <span class="n">kHead</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">m</span> <span class="o">==</span> <span class="s">&#34;PUT&#34;</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">method_</span> <span class="o">=</span> <span class="n">kPut</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">m</span> <span class="o">==</span> <span class="s">&#34;DELETE&#34;</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">method_</span> <span class="o">=</span> <span class="n">kDelete</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">else</span>
    <span class="p">{</span>
      <span class="n">method_</span> <span class="o">=</span> <span class="n">kInvalid</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">method_</span> <span class="o">!=</span> <span class="n">kInvalid</span><span class="p">;</span>
  <span class="p">}</span>
 
<span class="cm">/*返回请求方法*/</span>
  <span class="n">Method</span> <span class="n">method</span><span class="p">()</span> <span class="k">const</span>
  <span class="p">{</span> <span class="k">return</span> <span class="n">method_</span><span class="p">;</span> <span class="p">}</span>
 
<span class="cm">/*请求方法转为字符串*/</span>
  <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">methodString</span><span class="p">()</span> <span class="k">const</span>
  <span class="p">{</span>
    <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">result</span> <span class="o">=</span> <span class="s">&#34;UNKNOWN&#34;</span><span class="p">;</span>
    <span class="k">switch</span><span class="p">(</span><span class="n">method_</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="k">case</span> <span class="nl">kGet</span><span class="p">:</span>
        <span class="n">result</span> <span class="o">=</span> <span class="s">&#34;GET&#34;</span><span class="p">;</span>
        <span class="k">break</span><span class="p">;</span>
      <span class="k">case</span> <span class="nl">kPost</span><span class="p">:</span>
        <span class="n">result</span> <span class="o">=</span> <span class="s">&#34;POST&#34;</span><span class="p">;</span>
        <span class="k">break</span><span class="p">;</span>
      <span class="k">case</span> <span class="nl">kHead</span><span class="p">:</span>
        <span class="n">result</span> <span class="o">=</span> <span class="s">&#34;HEAD&#34;</span><span class="p">;</span>
        <span class="k">break</span><span class="p">;</span>
      <span class="k">case</span> <span class="nl">kPut</span><span class="p">:</span>
        <span class="n">result</span> <span class="o">=</span> <span class="s">&#34;PUT&#34;</span><span class="p">;</span>
        <span class="k">break</span><span class="p">;</span>
      <span class="k">case</span> <span class="nl">kDelete</span><span class="p">:</span>
        <span class="n">result</span> <span class="o">=</span> <span class="s">&#34;DELETE&#34;</span><span class="p">;</span>
        <span class="k">break</span><span class="p">;</span>
      <span class="k">default</span><span class="o">:</span>
        <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
  <span class="p">}</span>
 
<span class="cm">/*设置请求路径*/</span>
  <span class="kt">void</span> <span class="n">setPath</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">start</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">end</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">path_</span><span class="p">.</span><span class="n">assign</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">);</span>
  <span class="p">}</span>
 
<span class="cm">/*返回请求路径*/</span>
  <span class="k">const</span> <span class="n">string</span><span class="o">&amp;</span> <span class="n">path</span><span class="p">()</span> <span class="k">const</span>
  <span class="p">{</span> <span class="k">return</span> <span class="n">path_</span><span class="p">;</span> <span class="p">}</span>
 
<span class="cm">/*设置接收时间*/</span>
  <span class="kt">void</span> <span class="n">setReceiveTime</span><span class="p">(</span><span class="n">Timestamp</span> <span class="n">t</span><span class="p">)</span>
  <span class="p">{</span> <span class="n">receiveTime_</span> <span class="o">=</span> <span class="n">t</span><span class="p">;</span> <span class="p">}</span>
 
  <span class="n">Timestamp</span> <span class="n">receiveTime</span><span class="p">()</span> <span class="k">const</span>
  <span class="p">{</span> <span class="k">return</span> <span class="n">receiveTime_</span><span class="p">;</span> <span class="p">}</span>
 
<span class="cm">/*添加一个头部信息*/</span>
  <span class="cm">/*
</span><span class="cm">Accept-Language(start):(colon) zh-CN(end)
</span><span class="cm"> 
</span><span class="cm">--&gt;Accept-Language
</span><span class="cm">   zh-CN
</span><span class="cm">*/</span>
  <span class="kt">void</span> <span class="n">addHeader</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">start</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">colon</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">end</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">string</span> <span class="n">field</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">colon</span><span class="p">);</span>     <span class="c1">// header域
</span><span class="c1"></span>    <span class="o">++</span><span class="n">colon</span><span class="p">;</span>
    <span class="c1">// 去除左空格
</span><span class="c1"></span>    <span class="k">while</span> <span class="p">(</span><span class="n">colon</span> <span class="o">&lt;</span> <span class="n">end</span> <span class="o">&amp;&amp;</span> <span class="n">isspace</span><span class="p">(</span><span class="o">*</span><span class="n">colon</span><span class="p">))</span>
    <span class="p">{</span>
      <span class="o">++</span><span class="n">colon</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">string</span> <span class="n">value</span><span class="p">(</span><span class="n">colon</span><span class="p">,</span> <span class="n">end</span><span class="p">);</span>       <span class="c1">// header值
</span><span class="c1"></span>    <span class="c1">// 去除右空格
</span><span class="c1"></span>    <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">value</span><span class="p">.</span><span class="n">empty</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="n">isspace</span><span class="p">(</span><span class="n">value</span><span class="p">[</span><span class="n">value</span><span class="p">.</span><span class="n">size</span><span class="p">()</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
    <span class="p">{</span>
      <span class="n">value</span><span class="p">.</span><span class="n">resize</span><span class="p">(</span><span class="n">value</span><span class="p">.</span><span class="n">size</span><span class="p">()</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">headers_</span><span class="p">[</span><span class="n">field</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
  <span class="p">}</span>
 
<span class="cm">/*根据头域，获得头域的信息*/</span>
  <span class="n">string</span> <span class="n">getHeader</span><span class="p">(</span><span class="k">const</span> <span class="n">string</span><span class="o">&amp;</span> <span class="n">field</span><span class="p">)</span> <span class="k">const</span>
  <span class="p">{</span>
    <span class="n">string</span> <span class="n">result</span><span class="p">;</span>
    <span class="n">std</span><span class="o">::</span><span class="n">map</span><span class="o">&lt;</span><span class="n">string</span><span class="p">,</span> <span class="n">string</span><span class="o">&gt;::</span><span class="n">const_iterator</span> <span class="n">it</span> <span class="o">=</span> <span class="n">headers_</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="n">field</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">it</span> <span class="o">!=</span> <span class="n">headers_</span><span class="p">.</span><span class="n">end</span><span class="p">())</span>
    <span class="p">{</span>
      <span class="n">result</span> <span class="o">=</span> <span class="n">it</span><span class="o">-&gt;</span><span class="n">second</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
  <span class="p">}</span>
 
  <span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">map</span><span class="o">&lt;</span><span class="n">string</span><span class="p">,</span> <span class="n">string</span><span class="o">&gt;&amp;</span> <span class="n">headers</span><span class="p">()</span> <span class="k">const</span>
  <span class="p">{</span> <span class="k">return</span> <span class="n">headers_</span><span class="p">;</span> <span class="p">}</span>
 
  <span class="kt">void</span> <span class="n">swap</span><span class="p">(</span><span class="n">HttpRequest</span><span class="o">&amp;</span> <span class="n">that</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="cm">/*貌似少了version的交换*/</span>
    <span class="n">std</span><span class="o">::</span><span class="n">swap</span><span class="p">(</span><span class="n">method_</span><span class="p">,</span> <span class="n">that</span><span class="p">.</span><span class="n">method_</span><span class="p">);</span>
    <span class="n">path_</span><span class="p">.</span><span class="n">swap</span><span class="p">(</span><span class="n">that</span><span class="p">.</span><span class="n">path_</span><span class="p">);</span>
    <span class="n">receiveTime_</span><span class="p">.</span><span class="n">swap</span><span class="p">(</span><span class="n">that</span><span class="p">.</span><span class="n">receiveTime_</span><span class="p">);</span>
    <span class="n">headers_</span><span class="p">.</span><span class="n">swap</span><span class="p">(</span><span class="n">that</span><span class="p">.</span><span class="n">headers_</span><span class="p">);</span>
  <span class="p">}</span>
 
 <span class="k">private</span><span class="o">:</span>
  <span class="n">Method</span> <span class="n">method_</span><span class="p">;</span>       <span class="c1">// 请求方法
</span><span class="c1"></span>  <span class="n">Version</span> <span class="n">version_</span><span class="p">;</span>     <span class="c1">// 协议版本1.0/1.1
</span><span class="c1"></span>  <span class="n">string</span> <span class="n">path_</span><span class="p">;</span>         <span class="c1">// 请求路径
</span><span class="c1"></span>  <span class="n">Timestamp</span> <span class="n">receiveTime_</span><span class="p">;</span>   <span class="c1">// 请求时间
</span><span class="c1"></span>  <span class="n">std</span><span class="o">::</span><span class="n">map</span><span class="o">&lt;</span><span class="n">string</span><span class="p">,</span> <span class="n">string</span><span class="o">&gt;</span> <span class="n">headers_</span><span class="p">;</span>  <span class="c1">// header列表
</span><span class="c1"></span><span class="p">};</span>
 
<span class="p">}</span>
<span class="p">}</span>
 
<span class="cp">#endif  </span><span class="c1">// MUDUO_NET_HTTP_HTTPREQUEST_H
</span></code></pre></td></tr></table>
</div>
</div>
<h3 id="httpresponse头文件">HttpResponse头文件</h3>

<p>HttpResponse.h</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-c++" data-lang="c++"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c++" data-lang="c++"><span class="c1">// Copyright 2010, Shuo Chen.  All rights reserved.
</span><span class="c1">// http://code.google.com/p/muduo/
</span><span class="c1">//
</span><span class="c1">// Use of this source code is governed by a BSD-style license
</span><span class="c1">// that can be found in the License file.
</span><span class="c1"></span> 
<span class="c1">// Author: Shuo Chen (chenshuo at chenshuo dot com)
</span><span class="c1">//
</span><span class="c1">// This is a public header file, it must only include public header files.
</span><span class="c1"></span> 
<span class="cp">#ifndef MUDUO_NET_HTTP_HTTPRESPONSE_H
</span><span class="cp">#define MUDUO_NET_HTTP_HTTPRESPONSE_H
</span><span class="cp"></span> 
<span class="cp">#include</span> <span class="cpf">&lt;muduo/base/copyable.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;muduo/base/Types.h&gt;</span><span class="cp">
</span><span class="cp"></span> 
<span class="cp">#include</span> <span class="cpf">&lt;map&gt;</span><span class="cp">
</span><span class="cp"></span> 
<span class="k">namespace</span> <span class="n">muduo</span>
<span class="p">{</span>
<span class="k">namespace</span> <span class="n">net</span>
<span class="p">{</span>
 
<span class="k">class</span><span class="err"> </span><span class="nc">Buffer</span><span class="p">;</span>
<span class="k">class</span><span class="err"> </span><span class="nc">HttpResponse</span> <span class="o">:</span> <span class="k">public</span> <span class="n">muduo</span><span class="o">::</span><span class="n">copyable</span>
<span class="p">{</span>
 <span class="k">public</span><span class="o">:</span>
  <span class="k">enum</span> <span class="n">HttpStatusCode</span>
  <span class="p">{</span>
    <span class="n">kUnknown</span><span class="p">,</span>
    <span class="n">k200Ok</span> <span class="o">=</span> <span class="mi">200</span><span class="p">,</span>       <span class="c1">// 成功
</span><span class="c1"></span>    <span class="n">k301MovedPermanently</span> <span class="o">=</span> <span class="mi">301</span><span class="p">,</span>     <span class="c1">// 301重定向，请求的页面永久性移至另一个地址
</span><span class="c1"></span>    <span class="n">k400BadRequest</span> <span class="o">=</span> <span class="mi">400</span><span class="p">,</span>           <span class="c1">// 错误的请求，语法格式有错，服务器无法处理此请求
</span><span class="c1"></span>    <span class="n">k404NotFound</span> <span class="o">=</span> <span class="mi">404</span><span class="p">,</span>     <span class="c1">// 请求的网页不存在
</span><span class="c1"></span>  <span class="p">};</span>
 
  <span class="k">explicit</span> <span class="nf">HttpResponse</span><span class="p">(</span><span class="kt">bool</span> <span class="n">close</span><span class="p">)</span>
    <span class="o">:</span> <span class="n">statusCode_</span><span class="p">(</span><span class="n">kUnknown</span><span class="p">),</span>
      <span class="n">closeConnection_</span><span class="p">(</span><span class="n">close</span><span class="p">)</span>
  <span class="p">{</span>
  <span class="p">}</span>
 
  <span class="kt">void</span> <span class="nf">setStatusCode</span><span class="p">(</span><span class="n">HttpStatusCode</span> <span class="n">code</span><span class="p">)</span>
  <span class="p">{</span> <span class="n">statusCode_</span> <span class="o">=</span> <span class="n">code</span><span class="p">;</span> <span class="p">}</span>
 
  <span class="kt">void</span> <span class="nf">setStatusMessage</span><span class="p">(</span><span class="k">const</span> <span class="n">string</span><span class="o">&amp;</span> <span class="n">message</span><span class="p">)</span>
  <span class="p">{</span> <span class="n">statusMessage_</span> <span class="o">=</span> <span class="n">message</span><span class="p">;</span> <span class="p">}</span>
 
  <span class="kt">void</span> <span class="nf">setCloseConnection</span><span class="p">(</span><span class="kt">bool</span> <span class="n">on</span><span class="p">)</span>
  <span class="p">{</span> <span class="n">closeConnection_</span> <span class="o">=</span> <span class="n">on</span><span class="p">;</span> <span class="p">}</span>
 
  <span class="kt">bool</span> <span class="nf">closeConnection</span><span class="p">()</span> <span class="k">const</span>
  <span class="p">{</span> <span class="k">return</span> <span class="n">closeConnection_</span><span class="p">;</span> <span class="p">}</span>
 
  <span class="c1">// 设置文档媒体类型（MIME）
</span><span class="c1"></span>  <span class="kt">void</span> <span class="nf">setContentType</span><span class="p">(</span><span class="k">const</span> <span class="n">string</span><span class="o">&amp;</span> <span class="n">contentType</span><span class="p">)</span>
  <span class="p">{</span> <span class="n">addHeader</span><span class="p">(</span><span class="s">&#34;Content-Type&#34;</span><span class="p">,</span> <span class="n">contentType</span><span class="p">);</span> <span class="p">}</span>
 
  <span class="c1">// FIXME: replace string with StringPiece
</span><span class="c1"></span>  <span class="kt">void</span> <span class="nf">addHeader</span><span class="p">(</span><span class="k">const</span> <span class="n">string</span><span class="o">&amp;</span> <span class="n">key</span><span class="p">,</span> <span class="k">const</span> <span class="n">string</span><span class="o">&amp;</span> <span class="n">value</span><span class="p">)</span>
  <span class="p">{</span> <span class="n">headers_</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span> <span class="p">}</span>
 
  <span class="kt">void</span> <span class="nf">setBody</span><span class="p">(</span><span class="k">const</span> <span class="n">string</span><span class="o">&amp;</span> <span class="n">body</span><span class="p">)</span>
  <span class="p">{</span> <span class="n">body_</span> <span class="o">=</span> <span class="n">body</span><span class="p">;</span> <span class="p">}</span>
 
  <span class="kt">void</span> <span class="nf">appendToBuffer</span><span class="p">(</span><span class="n">Buffer</span><span class="o">*</span> <span class="n">output</span><span class="p">)</span> <span class="k">const</span><span class="p">;</span>    <span class="c1">// 将HttpResponse添加到Buffer
</span><span class="c1"></span> 
 <span class="k">private</span><span class="o">:</span>
  <span class="n">std</span><span class="o">::</span><span class="n">map</span><span class="o">&lt;</span><span class="n">string</span><span class="p">,</span> <span class="n">string</span><span class="o">&gt;</span> <span class="n">headers_</span><span class="p">;</span>  <span class="c1">// header列表
</span><span class="c1"></span>  <span class="n">HttpStatusCode</span> <span class="n">statusCode_</span><span class="p">;</span>           <span class="c1">// 状态响应码
</span><span class="c1"></span>  <span class="c1">// FIXME: add http version
</span><span class="c1"></span>  <span class="n">string</span> <span class="n">statusMessage_</span><span class="p">;</span>                <span class="c1">// 状态响应码对应的文本信息
</span><span class="c1"></span>  <span class="kt">bool</span> <span class="n">closeConnection_</span><span class="p">;</span>                <span class="c1">// 是否关闭连接
</span><span class="c1"></span>  <span class="n">string</span> <span class="n">body_</span><span class="p">;</span>                         <span class="c1">// 实体
</span><span class="c1"></span><span class="p">};</span>
 
<span class="p">}</span>
<span class="p">}</span>
 
<span class="cp">#endif  </span><span class="c1">// MUDUO_NET_HTTP_HTTPRESPONSE_H
</span></code></pre></td></tr></table>
</div>
</div>
<h3 id="httpresponse源文件">HttpResponse源文件</h3>

<p>HttpResponse.cc</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-c++" data-lang="c++"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c++" data-lang="c++"><span class="c1">// Copyright 2010, Shuo Chen.  All rights reserved.
</span><span class="c1">// http://code.google.com/p/muduo/
</span><span class="c1">//
</span><span class="c1">// Use of this source code is governed by a BSD-style license
</span><span class="c1">// that can be found in the License file.
</span><span class="c1"></span> 
<span class="c1">// Author: Shuo Chen (chenshuo at chenshuo dot com)
</span><span class="c1">//
</span><span class="c1"></span> 
<span class="cp">#include</span> <span class="cpf">&lt;muduo/net/http/HttpResponse.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;muduo/net/Buffer.h&gt;</span><span class="cp">
</span><span class="cp"></span> 
<span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
</span><span class="cp"></span> 
<span class="k">using</span> <span class="k">namespace</span> <span class="n">muduo</span><span class="p">;</span>
<span class="k">using</span> <span class="k">namespace</span> <span class="n">muduo</span><span class="o">::</span><span class="n">net</span><span class="p">;</span>
 
<span class="kt">void</span> <span class="n">HttpResponse</span><span class="o">::</span><span class="n">appendToBuffer</span><span class="p">(</span><span class="n">Buffer</span><span class="o">*</span> <span class="n">output</span><span class="p">)</span> <span class="k">const</span>
<span class="p">{</span>
  <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>
  <span class="c1">// 添加响应头
</span><span class="c1"></span>  <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span> <span class="n">buf</span><span class="p">,</span> <span class="s">&#34;HTTP/1.1 %d &#34;</span><span class="p">,</span> <span class="n">statusCode_</span><span class="p">);</span>
  <span class="n">output</span><span class="o">-&gt;</span><span class="n">append</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
  <span class="n">output</span><span class="o">-&gt;</span><span class="n">append</span><span class="p">(</span><span class="n">statusMessage_</span><span class="p">);</span>
  <span class="n">output</span><span class="o">-&gt;</span><span class="n">append</span><span class="p">(</span><span class="s">&#34;</span><span class="se">\r\n</span><span class="s">&#34;</span><span class="p">);</span>
 
  <span class="k">if</span> <span class="p">(</span><span class="n">closeConnection_</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="c1">// 如果是短连接，不需要告诉浏览器Content-Length，浏览器也能正确处理
</span><span class="c1"></span>    <span class="c1">// 短链接不会出现粘包问题
</span><span class="c1"></span>    <span class="n">output</span><span class="o">-&gt;</span><span class="n">append</span><span class="p">(</span><span class="s">&#34;Connection: close</span><span class="se">\r\n</span><span class="s">&#34;</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">else</span>
  <span class="p">{</span>
    <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span> <span class="n">buf</span><span class="p">,</span> <span class="s">&#34;Content-Length: %zd</span><span class="se">\r\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">body_</span><span class="p">.</span><span class="n">size</span><span class="p">());</span> <span class="c1">// 实体长度
</span><span class="c1"></span>    <span class="n">output</span><span class="o">-&gt;</span><span class="n">append</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
    <span class="n">output</span><span class="o">-&gt;</span><span class="n">append</span><span class="p">(</span><span class="s">&#34;Connection: Keep-Alive</span><span class="se">\r\n</span><span class="s">&#34;</span><span class="p">);</span>
  <span class="p">}</span>
 
  <span class="c1">// header列表
</span><span class="c1"></span>  <span class="k">for</span> <span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">map</span><span class="o">&lt;</span><span class="n">string</span><span class="p">,</span> <span class="n">string</span><span class="o">&gt;::</span><span class="n">const_iterator</span> <span class="n">it</span> <span class="o">=</span> <span class="n">headers_</span><span class="p">.</span><span class="n">begin</span><span class="p">();</span>
       <span class="n">it</span> <span class="o">!=</span> <span class="n">headers_</span><span class="p">.</span><span class="n">end</span><span class="p">();</span>
       <span class="o">++</span><span class="n">it</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">output</span><span class="o">-&gt;</span><span class="n">append</span><span class="p">(</span><span class="n">it</span><span class="o">-&gt;</span><span class="n">first</span><span class="p">);</span>
    <span class="n">output</span><span class="o">-&gt;</span><span class="n">append</span><span class="p">(</span><span class="s">&#34;: &#34;</span><span class="p">);</span>
    <span class="n">output</span><span class="o">-&gt;</span><span class="n">append</span><span class="p">(</span><span class="n">it</span><span class="o">-&gt;</span><span class="n">second</span><span class="p">);</span>
    <span class="n">output</span><span class="o">-&gt;</span><span class="n">append</span><span class="p">(</span><span class="s">&#34;</span><span class="se">\r\n</span><span class="s">&#34;</span><span class="p">);</span>
  <span class="p">}</span>
 
  <span class="n">output</span><span class="o">-&gt;</span><span class="n">append</span><span class="p">(</span><span class="s">&#34;</span><span class="se">\r\n</span><span class="s">&#34;</span><span class="p">);</span>    <span class="c1">// header与body之间的空行
</span><span class="c1"></span>  <span class="n">output</span><span class="o">-&gt;</span><span class="n">append</span><span class="p">(</span><span class="n">body_</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div>
<h3 id="httpcontext文件">HttpContext文件</h3>

<p>HttpContext.h</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-c++" data-lang="c++"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c++" data-lang="c++"><span class="c1">// Copyright 2010, Shuo Chen.  All rights reserved.
</span><span class="c1">// http://code.google.com/p/muduo/
</span><span class="c1">//
</span><span class="c1">// Use of this source code is governed by a BSD-style license
</span><span class="c1">// that can be found in the License file.
</span><span class="c1"></span> 
<span class="c1">// Author: Shuo Chen (chenshuo at chenshuo dot com)
</span><span class="c1">//
</span><span class="c1">// This is an internal header file, you should not include this.
</span><span class="c1"></span> 
<span class="cp">#ifndef MUDUO_NET_HTTP_HTTPCONTEXT_H
</span><span class="cp">#define MUDUO_NET_HTTP_HTTPCONTEXT_H
</span><span class="cp"></span> 
<span class="cp">#include</span> <span class="cpf">&lt;muduo/base/copyable.h&gt;</span><span class="cp">
</span><span class="cp"></span> 
<span class="cp">#include</span> <span class="cpf">&lt;muduo/net/http/HttpRequest.h&gt;</span><span class="cp">
</span><span class="cp"></span> 
<span class="k">namespace</span> <span class="n">muduo</span>
<span class="p">{</span>
<span class="k">namespace</span> <span class="n">net</span>
<span class="p">{</span>
 
<span class="k">class</span><span class="err"> </span><span class="nc">HttpContext</span> <span class="o">:</span> <span class="k">public</span> <span class="n">muduo</span><span class="o">::</span><span class="n">copyable</span>
<span class="p">{</span>
 <span class="k">public</span><span class="o">:</span>
  <span class="k">enum</span> <span class="n">HttpRequestParseState</span>
  <span class="p">{</span>
    <span class="n">kExpectRequestLine</span><span class="p">,</span><span class="c1">//正处于请求行的状态
</span><span class="c1"></span>    <span class="n">kExpectHeaders</span><span class="p">,</span>   <span class="c1">//正处于请求头的状态
</span><span class="c1"></span>    <span class="n">kExpectBody</span><span class="p">,</span>      <span class="c1">//正处于请求实体的状态
</span><span class="c1"></span>    <span class="n">kGotAll</span><span class="p">,</span>          <span class="c1">//全部都解析完毕
</span><span class="c1"></span>  <span class="p">};</span>
 
  <span class="n">HttpContext</span><span class="p">()</span>
    <span class="o">:</span> <span class="n">state_</span><span class="p">(</span><span class="n">kExpectRequestLine</span><span class="p">)</span>
  <span class="p">{</span>
  <span class="p">}</span>
 
  <span class="c1">// default copy-ctor, dtor and assignment are fine
</span><span class="c1"></span> 
  <span class="kt">bool</span> <span class="n">expectRequestLine</span><span class="p">()</span> <span class="k">const</span>
  <span class="p">{</span> <span class="k">return</span> <span class="n">state_</span> <span class="o">==</span> <span class="n">kExpectRequestLine</span><span class="p">;</span> <span class="p">}</span>
 
  <span class="kt">bool</span> <span class="n">expectHeaders</span><span class="p">()</span> <span class="k">const</span>
  <span class="p">{</span> <span class="k">return</span> <span class="n">state_</span> <span class="o">==</span> <span class="n">kExpectHeaders</span><span class="p">;</span> <span class="p">}</span>
 
  <span class="kt">bool</span> <span class="n">expectBody</span><span class="p">()</span> <span class="k">const</span>
  <span class="p">{</span> <span class="k">return</span> <span class="n">state_</span> <span class="o">==</span> <span class="n">kExpectBody</span><span class="p">;</span> <span class="p">}</span>
 
  <span class="kt">bool</span> <span class="n">gotAll</span><span class="p">()</span> <span class="k">const</span>
  <span class="p">{</span> <span class="k">return</span> <span class="n">state_</span> <span class="o">==</span> <span class="n">kGotAll</span><span class="p">;</span> <span class="p">}</span>
 
  <span class="kt">void</span> <span class="n">receiveRequestLine</span><span class="p">()</span>
  <span class="p">{</span> <span class="n">state_</span> <span class="o">=</span> <span class="n">kExpectHeaders</span><span class="p">;</span> <span class="p">}</span>
  <span class="cm">/*注意这里没有处理body实体的请求*/</span>
  <span class="kt">void</span> <span class="n">receiveHeaders</span><span class="p">()</span>
  <span class="p">{</span> <span class="n">state_</span> <span class="o">=</span> <span class="n">kGotAll</span><span class="p">;</span> <span class="p">}</span>  <span class="c1">// FIXME
</span><span class="c1"></span> 
  <span class="c1">// 重置HttpContext状态
</span><span class="c1"></span>  <span class="kt">void</span> <span class="n">reset</span><span class="p">()</span>
  <span class="p">{</span>
    <span class="n">state_</span> <span class="o">=</span> <span class="n">kExpectRequestLine</span><span class="p">;</span>
    <span class="n">HttpRequest</span> <span class="n">dummy</span><span class="p">;</span>
    <span class="n">request_</span><span class="p">.</span><span class="n">swap</span><span class="p">(</span><span class="n">dummy</span><span class="p">);</span>
  <span class="p">}</span>
 
  <span class="k">const</span> <span class="n">HttpRequest</span><span class="o">&amp;</span> <span class="n">request</span><span class="p">()</span> <span class="k">const</span>
  <span class="p">{</span> <span class="k">return</span> <span class="n">request_</span><span class="p">;</span> <span class="p">}</span>
 
  <span class="n">HttpRequest</span><span class="o">&amp;</span> <span class="n">request</span><span class="p">()</span>
  <span class="p">{</span> <span class="k">return</span> <span class="n">request_</span><span class="p">;</span> <span class="p">}</span>
 
 <span class="k">private</span><span class="o">:</span>
  <span class="n">HttpRequestParseState</span> <span class="n">state_</span><span class="p">;</span>     <span class="c1">// 请求解析状态
</span><span class="c1"></span>  <span class="n">HttpRequest</span> <span class="n">request_</span><span class="p">;</span>             <span class="c1">// http请求
</span><span class="c1"></span><span class="p">};</span>
 
<span class="p">}</span>
<span class="p">}</span>
 
<span class="cp">#endif  </span><span class="c1">// MUDUO_NET_HTTP_HTTPCONTEXT_H
</span></code></pre></td></tr></table>
</div>
</div>
<h3 id="httpserver头文件">HttpServer头文件</h3>

<p>HttpServer.h</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-c++" data-lang="c++"><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span><span class="lnt">177
</span><span class="lnt">178
</span><span class="lnt">179
</span><span class="lnt">180
</span><span class="lnt">181
</span><span class="lnt">182
</span><span class="lnt">183
</span><span class="lnt">184
</span><span class="lnt">185
</span><span class="lnt">186
</span><span class="lnt">187
</span><span class="lnt">188
</span><span class="lnt">189
</span><span class="lnt">190
</span><span class="lnt">191
</span><span class="lnt">192
</span><span class="lnt">193
</span><span class="lnt">194
</span><span class="lnt">195
</span><span class="lnt">196
</span><span class="lnt">197
</span><span class="lnt">198
</span><span class="lnt">199
</span><span class="lnt">200
</span><span class="lnt">201
</span><span class="lnt">202
</span><span class="lnt">203
</span><span class="lnt">204
</span><span class="lnt">205
</span><span class="lnt">206
</span><span class="lnt">207
</span><span class="lnt">208
</span><span class="lnt">209
</span><span class="lnt">210
</span><span class="lnt">211
</span><span class="lnt">212
</span><span class="lnt">213
</span><span class="lnt">214
</span><span class="lnt">215
</span><span class="lnt">216
</span><span class="lnt">217
</span><span class="lnt">218
</span><span class="lnt">219
</span><span class="lnt">220
</span><span class="lnt">221
</span><span class="lnt">222
</span><span class="lnt">223
</span><span class="lnt">224
</span><span class="lnt">225
</span><span class="lnt">226
</span><span class="lnt">227
</span><span class="lnt">228
</span><span class="lnt">229
</span><span class="lnt">230
</span><span class="lnt">231
</span><span class="lnt">232
</span><span class="lnt">233
</span><span class="lnt">234
</span><span class="lnt">235
</span><span class="lnt">236
</span><span class="lnt">237
</span><span class="lnt">238
</span><span class="lnt">239
</span><span class="lnt">240
</span><span class="lnt">241
</span><span class="lnt">242
</span><span class="lnt">243
</span><span class="lnt">244
</span><span class="lnt">245
</span><span class="lnt">246
</span><span class="lnt">247
</span><span class="lnt">248
</span><span class="lnt">249
</span><span class="lnt">250
</span><span class="lnt">251
</span><span class="lnt">252
</span><span class="lnt">253
</span><span class="lnt">254
</span><span class="lnt">255
</span><span class="lnt">256
</span><span class="lnt">257
</span><span class="lnt">258
</span><span class="lnt">259
</span><span class="lnt">260
</span><span class="lnt">261
</span><span class="lnt">262
</span><span class="lnt">263
</span><span class="lnt">264
</span><span class="lnt">265
</span><span class="lnt">266
</span><span class="lnt">267
</span><span class="lnt">268
</span><span class="lnt">269
</span><span class="lnt">270
</span><span class="lnt">271
</span><span class="lnt">272
</span><span class="lnt">273
</span><span class="lnt">274
</span><span class="lnt">275
</span><span class="lnt">276
</span><span class="lnt">277
</span><span class="lnt">278
</span><span class="lnt">279
</span><span class="lnt">280
</span><span class="lnt">281
</span><span class="lnt">282
</span><span class="lnt">283
</span><span class="lnt">284
</span><span class="lnt">285
</span><span class="lnt">286
</span><span class="lnt">287
</span><span class="lnt">288
</span><span class="lnt">289
</span><span class="lnt">290
</span><span class="lnt">291
</span><span class="lnt">292
</span><span class="lnt">293
</span><span class="lnt">294
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c++" data-lang="c++"><span class="c1">// Copyright 2010, Shuo Chen.  All rights reserved.
</span><span class="c1">// http://code.google.com/p/muduo/
</span><span class="c1">//
</span><span class="c1">// Use of this source code is governed by a BSD-style license
</span><span class="c1">// that can be found in the License file.
</span><span class="c1"></span> 
<span class="c1">// Author: Shuo Chen (chenshuo at chenshuo dot com)
</span><span class="c1">//
</span><span class="c1">// This is a public header file, it must only include public header files.
</span><span class="c1"></span> 
<span class="cp">#ifndef MUDUO_NET_HTTP_HTTPSERVER_H
</span><span class="cp">#define MUDUO_NET_HTTP_HTTPSERVER_H
</span><span class="cp"></span> 
<span class="cp">#include</span> <span class="cpf">&lt;muduo/net/TcpServer.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;boost/noncopyable.hpp&gt;</span><span class="cp">
</span><span class="cp"></span> 
<span class="k">namespace</span> <span class="n">muduo</span>
<span class="p">{</span>
<span class="k">namespace</span> <span class="n">net</span>
<span class="p">{</span>
 
<span class="k">class</span><span class="err"> </span><span class="nc">HttpRequest</span><span class="p">;</span>
<span class="k">class</span><span class="err"> </span><span class="nc">HttpResponse</span><span class="p">;</span>
 
<span class="c1">/// A simple embeddable HTTP server designed for report status of a program.
</span><span class="c1">/// It is not a fully HTTP 1.1 compliant server, but provides minimum features
</span><span class="c1">/// that can communicate with HttpClient and Web browser.
</span><span class="c1">/// It is synchronous, just like Java Servlet.
</span><span class="c1"></span><span class="k">class</span><span class="err"> </span><span class="nc">HttpServer</span> <span class="o">:</span> <span class="n">boost</span><span class="o">::</span><span class="n">noncopyable</span>
<span class="p">{</span>
 <span class="k">public</span><span class="o">:</span>
  <span class="k">typedef</span> <span class="n">boost</span><span class="o">::</span><span class="n">function</span><span class="o">&lt;</span><span class="kt">void</span> <span class="p">(</span><span class="k">const</span> <span class="n">HttpRequest</span><span class="o">&amp;</span><span class="p">,</span>
                                <span class="n">HttpResponse</span><span class="o">*</span><span class="p">)</span><span class="o">&gt;</span> <span class="n">HttpCallback</span><span class="p">;</span>
 
  <span class="n">HttpServer</span><span class="p">(</span><span class="n">EventLoop</span><span class="o">*</span> <span class="n">loop</span><span class="p">,</span>
             <span class="k">const</span> <span class="n">InetAddress</span><span class="o">&amp;</span> <span class="n">listenAddr</span><span class="p">,</span>
             <span class="k">const</span> <span class="n">string</span><span class="o">&amp;</span> <span class="n">name</span><span class="p">);</span>
 
  <span class="o">~</span><span class="n">HttpServer</span><span class="p">();</span>  <span class="c1">// force out-line dtor, for scoped_ptr members.
</span><span class="c1"></span> 
  <span class="c1">/// Not thread safe, callback be registered before calling start().
</span><span class="c1"></span>  <span class="kt">void</span> <span class="nf">setHttpCallback</span><span class="p">(</span><span class="k">const</span> <span class="n">HttpCallback</span><span class="o">&amp;</span> <span class="n">cb</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">httpCallback_</span> <span class="o">=</span> <span class="n">cb</span><span class="p">;</span>
  <span class="p">}</span>
 
  <span class="cm">/*subIO thread numbers*/</span>
  <span class="kt">void</span> <span class="nf">setThreadNum</span><span class="p">(</span><span class="kt">int</span> <span class="n">numThreads</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">server_</span><span class="p">.</span><span class="n">setThreadNum</span><span class="p">(</span><span class="n">numThreads</span><span class="p">);</span>
  <span class="p">}</span>
 
  <span class="kt">void</span> <span class="nf">start</span><span class="p">();</span>
 
 <span class="k">private</span><span class="o">:</span>
  <span class="kt">void</span> <span class="n">onConnection</span><span class="p">(</span><span class="k">const</span> <span class="n">TcpConnectionPtr</span><span class="o">&amp;</span> <span class="n">conn</span><span class="p">);</span>
  <span class="cm">/*当以http请求到来时
</span><span class="cm">onMessage---&gt;onRequest---&gt;HttpCallback
</span><span class="cm">  */</span>
  <span class="kt">void</span> <span class="nf">onMessage</span><span class="p">(</span><span class="k">const</span> <span class="n">TcpConnectionPtr</span><span class="o">&amp;</span> <span class="n">conn</span><span class="p">,</span>
                 <span class="n">Buffer</span><span class="o">*</span> <span class="n">buf</span><span class="p">,</span>
                 <span class="n">Timestamp</span> <span class="n">receiveTime</span><span class="p">);</span>
  <span class="kt">void</span> <span class="nf">onRequest</span><span class="p">(</span><span class="k">const</span> <span class="n">TcpConnectionPtr</span><span class="o">&amp;</span><span class="p">,</span> <span class="k">const</span> <span class="n">HttpRequest</span><span class="o">&amp;</span><span class="p">);</span>
 
  <span class="n">TcpServer</span> <span class="n">server_</span><span class="p">;</span>
  <span class="n">HttpCallback</span> <span class="n">httpCallback_</span><span class="p">;</span>   <span class="c1">// 在处理http请求（即调用onRequest）的过程中回调此函数，对请求进行具体的处理
</span><span class="c1"></span><span class="p">};</span>
 
<span class="p">}</span>
<span class="p">}</span>
 
<span class="cp">#endif  </span><span class="c1">// MUDUO_NET_HTTP_HTTPSERVER_H
</span><span class="c1"></span><span class="err">````</span>

<span class="cp">### HttpServer源文件
</span><span class="cp"></span>
<span class="n">HttpServer</span><span class="p">.</span><span class="n">cc</span>

<span class="err">```</span> <span class="n">c</span><span class="o">++</span>

<span class="c1">// Copyright 2010, Shuo Chen.  All rights reserved.
</span><span class="c1">// http://code.google.com/p/muduo/
</span><span class="c1">//
</span><span class="c1">// Use of this source code is governed by a BSD-style license
</span><span class="c1">// that can be found in the License file.
</span><span class="c1"></span> 
<span class="c1">// Author: Shuo Chen (chenshuo at chenshuo dot com)
</span><span class="c1">//
</span><span class="c1"></span> 
<span class="cp">#include</span> <span class="cpf">&lt;muduo/net/http/HttpServer.h&gt;</span><span class="cp">
</span><span class="cp"></span> 
<span class="cp">#include</span> <span class="cpf">&lt;muduo/base/Logging.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;muduo/net/http/HttpContext.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;muduo/net/http/HttpRequest.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;muduo/net/http/HttpResponse.h&gt;</span><span class="cp">
</span><span class="cp"></span> 
<span class="cp">#include</span> <span class="cpf">&lt;boost/bind.hpp&gt;</span><span class="cp">
</span><span class="cp"></span> 
<span class="k">using</span> <span class="k">namespace</span> <span class="n">muduo</span><span class="p">;</span>
<span class="k">using</span> <span class="k">namespace</span> <span class="n">muduo</span><span class="o">::</span><span class="n">net</span><span class="p">;</span>
<span class="cm">/*
</span><span class="cm">GET / HTTP/1.1 (请求行)
</span><span class="cm">Accept: image/jpeg, application/x-ms-application, image/gif, application/xaml+xml, image/pjpeg, application/x-ms-xbap, application/vnd.ms-excel, application/vnd.ms-powerpoint, application/msword(请求头)
</span><span class="cm">Accept-Language: zh-CN(请求头)
</span><span class="cm">User-Agent: Mozilla/4.0 (compatible; MSIE 8.0; Windows NT 6.1; Trident/4.0; SLCC2; .NET CLR 2.0.50727; .NET CLR 3.5.30729; .NET CLR 3.0.30729; Media Center PC 6.0; Tablet PC 2.0)(请求头)
</span><span class="cm">Accept-Encoding: gzip, deflate(请求头)
</span><span class="cm">Host: 192.168.159.188:800(请求头)
</span><span class="cm">Connection: Keep-Alive(请求头)
</span><span class="cm"> 
</span><span class="cm">*/</span>
<span class="k">namespace</span> <span class="n">muduo</span>
<span class="p">{</span>
<span class="k">namespace</span> <span class="n">net</span>
<span class="p">{</span>
<span class="k">namespace</span> <span class="n">detail</span>
<span class="p">{</span>
 
<span class="c1">// FIXME: move to HttpContext class
</span><span class="c1"></span><span class="kt">bool</span> <span class="n">processRequestLine</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">begin</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">end</span><span class="p">,</span> <span class="n">HttpContext</span><span class="o">*</span> <span class="n">context</span><span class="p">)</span>
<span class="p">{</span>
  <span class="kt">bool</span> <span class="n">succeed</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
  <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">start</span> <span class="o">=</span> <span class="n">begin</span><span class="p">;</span>
  <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">space</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">find</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="sc">&#39; &#39;</span><span class="p">);</span>
  <span class="n">HttpRequest</span><span class="o">&amp;</span> <span class="n">request</span> <span class="o">=</span> <span class="n">context</span><span class="o">-&gt;</span><span class="n">request</span><span class="p">();</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">space</span> <span class="o">!=</span> <span class="n">end</span> <span class="o">&amp;&amp;</span> <span class="n">request</span><span class="p">.</span><span class="n">setMethod</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">space</span><span class="p">))</span>      <span class="c1">// 解析请求方法
</span><span class="c1"></span>  <span class="p">{</span>
    <span class="n">start</span> <span class="o">=</span> <span class="n">space</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span>
    <span class="n">space</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">find</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="sc">&#39; &#39;</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">space</span> <span class="o">!=</span> <span class="n">end</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">request</span><span class="p">.</span><span class="n">setPath</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">space</span><span class="p">);</span>    <span class="c1">// 解析PATH
</span><span class="c1"></span>      <span class="n">start</span> <span class="o">=</span> <span class="n">space</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span>
      <span class="n">succeed</span> <span class="o">=</span> <span class="n">end</span><span class="o">-</span><span class="n">start</span> <span class="o">==</span> <span class="mi">8</span> <span class="o">&amp;&amp;</span> <span class="n">std</span><span class="o">::</span><span class="n">equal</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="s">&#34;HTTP/1.&#34;</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">succeed</span><span class="p">)</span>
      <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">end</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="sc">&#39;1&#39;</span><span class="p">)</span>
        <span class="p">{</span>
          <span class="n">request</span><span class="p">.</span><span class="n">setVersion</span><span class="p">(</span><span class="n">HttpRequest</span><span class="o">::</span><span class="n">kHttp11</span><span class="p">);</span>     <span class="c1">// HTTP/1.1
</span><span class="c1"></span>        <span class="p">}</span>
        <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">end</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="sc">&#39;0&#39;</span><span class="p">)</span>
        <span class="p">{</span>
          <span class="n">request</span><span class="p">.</span><span class="n">setVersion</span><span class="p">(</span><span class="n">HttpRequest</span><span class="o">::</span><span class="n">kHttp10</span><span class="p">);</span>     <span class="c1">// HTTP/1.0
</span><span class="c1"></span>        <span class="p">}</span>
        <span class="k">else</span>
        <span class="p">{</span>
          <span class="n">succeed</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="n">succeed</span><span class="p">;</span>
<span class="p">}</span>
 
<span class="c1">// FIXME: move to HttpContext class
</span><span class="c1">// return false if any error
</span><span class="c1">// 开始解析请求
</span><span class="c1"></span><span class="kt">bool</span> <span class="n">parseRequest</span><span class="p">(</span><span class="n">Buffer</span><span class="o">*</span> <span class="n">buf</span><span class="p">,</span> <span class="n">HttpContext</span><span class="o">*</span> <span class="n">context</span><span class="p">,</span> <span class="n">Timestamp</span> <span class="n">receiveTime</span><span class="p">)</span>
<span class="p">{</span>
  <span class="kt">bool</span> <span class="n">ok</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
  <span class="kt">bool</span> <span class="n">hasMore</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
  <span class="k">while</span> <span class="p">(</span><span class="n">hasMore</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">context</span><span class="o">-&gt;</span><span class="n">expectRequestLine</span><span class="p">())</span>    <span class="c1">// 处于解析请求行状态
</span><span class="c1"></span>    <span class="p">{</span>
      <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">crlf</span> <span class="o">=</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">findCRLF</span><span class="p">();</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">crlf</span><span class="p">)</span>
      <span class="p">{</span>
        <span class="n">ok</span> <span class="o">=</span> <span class="n">processRequestLine</span><span class="p">(</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">peek</span><span class="p">(),</span> <span class="n">crlf</span><span class="p">,</span> <span class="n">context</span><span class="p">);</span> <span class="c1">// 解析请求行 ，*crlf =&#39;\r&#39;
</span><span class="c1"></span>        <span class="k">if</span> <span class="p">(</span><span class="n">ok</span><span class="p">)</span>
        <span class="p">{</span>
          <span class="n">context</span><span class="o">-&gt;</span><span class="n">request</span><span class="p">().</span><span class="n">setReceiveTime</span><span class="p">(</span><span class="n">receiveTime</span><span class="p">);</span>        <span class="c1">// 设置请求时间
</span><span class="c1"></span>          <span class="n">buf</span><span class="o">-&gt;</span><span class="n">retrieveUntil</span><span class="p">(</span><span class="n">crlf</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>      <span class="c1">// 将请求行从buf中取回，包括\r\n
</span><span class="c1"></span>          <span class="n">context</span><span class="o">-&gt;</span><span class="n">receiveRequestLine</span><span class="p">();</span> <span class="c1">// 将HttpContext状态改为kExpectHeaders
</span><span class="c1"></span>        <span class="p">}</span>
        <span class="k">else</span>
        <span class="p">{</span>
          <span class="n">hasMore</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
        <span class="p">}</span>
      <span class="p">}</span>
      <span class="k">else</span>
      <span class="p">{</span>
        <span class="n">hasMore</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">context</span><span class="o">-&gt;</span><span class="n">expectHeaders</span><span class="p">())</span>       <span class="c1">// 解析header
</span><span class="c1"></span>    <span class="p">{</span>
      <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">crlf</span> <span class="o">=</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">findCRLF</span><span class="p">();</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">crlf</span><span class="p">)</span>
      <span class="p">{</span>
        <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">colon</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">find</span><span class="p">(</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">peek</span><span class="p">(),</span> <span class="n">crlf</span><span class="p">,</span> <span class="sc">&#39;:&#39;</span><span class="p">);</span>       <span class="c1">//冒号所在位置
</span><span class="c1"></span>        <span class="k">if</span> <span class="p">(</span><span class="n">colon</span> <span class="o">!=</span> <span class="n">crlf</span><span class="p">)</span>
        <span class="p">{</span>
          <span class="n">context</span><span class="o">-&gt;</span><span class="n">request</span><span class="p">().</span><span class="n">addHeader</span><span class="p">(</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">peek</span><span class="p">(),</span> <span class="n">colon</span><span class="p">,</span> <span class="n">crlf</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">else</span>
        <span class="p">{</span>
          <span class="c1">// empty line, end of header
</span><span class="c1"></span>          <span class="n">context</span><span class="o">-&gt;</span><span class="n">receiveHeaders</span><span class="p">();</span>     <span class="c1">// HttpContext将状态改为kGotAll
</span><span class="c1"></span>          <span class="n">hasMore</span> <span class="o">=</span> <span class="o">!</span><span class="n">context</span><span class="o">-&gt;</span><span class="n">gotAll</span><span class="p">();</span>
        <span class="p">}</span>
        <span class="n">buf</span><span class="o">-&gt;</span><span class="n">retrieveUntil</span><span class="p">(</span><span class="n">crlf</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>        <span class="c1">// 将header从buf中取回，包括\r\n
</span><span class="c1"></span>      <span class="p">}</span>
      <span class="k">else</span>
      <span class="p">{</span>
        <span class="n">hasMore</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">context</span><span class="o">-&gt;</span><span class="n">expectBody</span><span class="p">())</span>          <span class="c1">// 当前还不支持请求中带body
</span><span class="c1"></span>    <span class="p">{</span>
      <span class="c1">// FIXME:
</span><span class="c1"></span>    <span class="p">}</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="n">ok</span><span class="p">;</span>
<span class="p">}</span>
 
<span class="kt">void</span> <span class="n">defaultHttpCallback</span><span class="p">(</span><span class="k">const</span> <span class="n">HttpRequest</span><span class="o">&amp;</span><span class="p">,</span> <span class="n">HttpResponse</span><span class="o">*</span> <span class="n">resp</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">resp</span><span class="o">-&gt;</span><span class="n">setStatusCode</span><span class="p">(</span><span class="n">HttpResponse</span><span class="o">::</span><span class="n">k404NotFound</span><span class="p">);</span>
  <span class="n">resp</span><span class="o">-&gt;</span><span class="n">setStatusMessage</span><span class="p">(</span><span class="s">&#34;Not Found&#34;</span><span class="p">);</span>
  <span class="n">resp</span><span class="o">-&gt;</span><span class="n">setCloseConnection</span><span class="p">(</span><span class="nb">true</span><span class="p">);</span>
<span class="p">}</span>
 
<span class="p">}</span>
<span class="p">}</span>
<span class="p">}</span>
 
<span class="n">HttpServer</span><span class="o">::</span><span class="n">HttpServer</span><span class="p">(</span><span class="n">EventLoop</span><span class="o">*</span> <span class="n">loop</span><span class="p">,</span>
                       <span class="k">const</span> <span class="n">InetAddress</span><span class="o">&amp;</span> <span class="n">listenAddr</span><span class="p">,</span>
                       <span class="k">const</span> <span class="n">string</span><span class="o">&amp;</span> <span class="n">name</span><span class="p">)</span>
  <span class="o">:</span> <span class="n">server_</span><span class="p">(</span><span class="n">loop</span><span class="p">,</span> <span class="n">listenAddr</span><span class="p">,</span> <span class="n">name</span><span class="p">),</span>
    <span class="n">httpCallback_</span><span class="p">(</span><span class="n">detail</span><span class="o">::</span><span class="n">defaultHttpCallback</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">server_</span><span class="p">.</span><span class="n">setConnectionCallback</span><span class="p">(</span>
      <span class="n">boost</span><span class="o">::</span><span class="n">bind</span><span class="p">(</span><span class="o">&amp;</span><span class="n">HttpServer</span><span class="o">::</span><span class="n">onConnection</span><span class="p">,</span> <span class="k">this</span><span class="p">,</span> <span class="n">_1</span><span class="p">));</span>
  <span class="n">server_</span><span class="p">.</span><span class="n">setMessageCallback</span><span class="p">(</span>
      <span class="n">boost</span><span class="o">::</span><span class="n">bind</span><span class="p">(</span><span class="o">&amp;</span><span class="n">HttpServer</span><span class="o">::</span><span class="n">onMessage</span><span class="p">,</span> <span class="k">this</span><span class="p">,</span> <span class="n">_1</span><span class="p">,</span> <span class="n">_2</span><span class="p">,</span> <span class="n">_3</span><span class="p">));</span>
<span class="p">}</span>
 
<span class="n">HttpServer</span><span class="o">::~</span><span class="n">HttpServer</span><span class="p">()</span>
<span class="p">{</span>
<span class="p">}</span>
 
<span class="kt">void</span> <span class="n">HttpServer</span><span class="o">::</span><span class="n">start</span><span class="p">()</span>
<span class="p">{</span>
  <span class="n">LOG_WARN</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;HttpServer[&#34;</span> <span class="o">&lt;&lt;</span> <span class="n">server_</span><span class="p">.</span><span class="n">name</span><span class="p">()</span>
    <span class="o">&lt;&lt;</span> <span class="s">&#34;] starts listenning on &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">server_</span><span class="p">.</span><span class="n">hostport</span><span class="p">();</span>
  <span class="n">server_</span><span class="p">.</span><span class="n">start</span><span class="p">();</span>
<span class="p">}</span>
 
<span class="kt">void</span> <span class="n">HttpServer</span><span class="o">::</span><span class="n">onConnection</span><span class="p">(</span><span class="k">const</span> <span class="n">TcpConnectionPtr</span><span class="o">&amp;</span> <span class="n">conn</span><span class="p">)</span>
<span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">connected</span><span class="p">())</span>
  <span class="p">{</span>
    <span class="c1">//boost any
</span><span class="c1"></span>    <span class="n">conn</span><span class="o">-&gt;</span><span class="n">setContext</span><span class="p">(</span><span class="n">HttpContext</span><span class="p">());</span> <span class="c1">// TcpConnection与一个HttpContext绑定
</span><span class="c1"></span>  <span class="p">}</span>
<span class="p">}</span>
 
<span class="kt">void</span> <span class="n">HttpServer</span><span class="o">::</span><span class="n">onMessage</span><span class="p">(</span><span class="k">const</span> <span class="n">TcpConnectionPtr</span><span class="o">&amp;</span> <span class="n">conn</span><span class="p">,</span>
                           <span class="n">Buffer</span><span class="o">*</span> <span class="n">buf</span><span class="p">,</span>
                           <span class="n">Timestamp</span> <span class="n">receiveTime</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">HttpContext</span><span class="o">*</span> <span class="n">context</span> <span class="o">=</span> <span class="n">boost</span><span class="o">::</span><span class="n">any_cast</span><span class="o">&lt;</span><span class="n">HttpContext</span><span class="o">&gt;</span><span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">getMutableContext</span><span class="p">());</span>
 
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">detail</span><span class="o">::</span><span class="n">parseRequest</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">receiveTime</span><span class="p">))</span>
  <span class="p">{</span>
    <span class="n">conn</span><span class="o">-&gt;</span><span class="n">send</span><span class="p">(</span><span class="s">&#34;HTTP/1.1 400 Bad Request</span><span class="se">\r\n\r\n</span><span class="s">&#34;</span><span class="p">);</span>
    <span class="n">conn</span><span class="o">-&gt;</span><span class="n">shutdown</span><span class="p">();</span>
  <span class="p">}</span>
 
  <span class="c1">// 请求消息解析完毕
</span><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="n">context</span><span class="o">-&gt;</span><span class="n">gotAll</span><span class="p">())</span>
  <span class="p">{</span>
    <span class="n">onRequest</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">context</span><span class="o">-&gt;</span><span class="n">request</span><span class="p">());</span>
    <span class="n">context</span><span class="o">-&gt;</span><span class="n">reset</span><span class="p">();</span>        <span class="c1">// 本次请求处理完毕，重置HttpContext，适用于长连接
</span><span class="c1"></span>  <span class="p">}</span>
<span class="p">}</span>
 
<span class="kt">void</span> <span class="n">HttpServer</span><span class="o">::</span><span class="n">onRequest</span><span class="p">(</span><span class="k">const</span> <span class="n">TcpConnectionPtr</span><span class="o">&amp;</span> <span class="n">conn</span><span class="p">,</span> <span class="k">const</span> <span class="n">HttpRequest</span><span class="o">&amp;</span> <span class="n">req</span><span class="p">)</span>
<span class="p">{</span>
  <span class="k">const</span> <span class="n">string</span><span class="o">&amp;</span> <span class="n">connection</span> <span class="o">=</span> <span class="n">req</span><span class="p">.</span><span class="n">getHeader</span><span class="p">(</span><span class="s">&#34;Connection&#34;</span><span class="p">);</span>
  <span class="c1">//是否关闭连接
</span><span class="c1"></span>  <span class="kt">bool</span> <span class="n">close</span> <span class="o">=</span> <span class="n">connection</span> <span class="o">==</span> <span class="s">&#34;close&#34;</span> <span class="o">||</span>
    <span class="p">(</span><span class="n">req</span><span class="p">.</span><span class="n">getVersion</span><span class="p">()</span> <span class="o">==</span> <span class="n">HttpRequest</span><span class="o">::</span><span class="n">kHttp10</span> <span class="o">&amp;&amp;</span> <span class="n">connection</span> <span class="o">!=</span> <span class="s">&#34;Keep-Alive&#34;</span><span class="p">);</span>
  <span class="n">HttpResponse</span> <span class="nf">response</span><span class="p">(</span><span class="n">close</span><span class="p">);</span>
  <span class="n">httpCallback_</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">response</span><span class="p">);</span><span class="c1">//回调用户函数
</span><span class="c1"></span>  <span class="n">Buffer</span> <span class="n">buf</span><span class="p">;</span>
  <span class="n">response</span><span class="p">.</span><span class="n">appendToBuffer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buf</span><span class="p">);</span>
  <span class="n">conn</span><span class="o">-&gt;</span><span class="n">send</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buf</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="n">closeConnection</span><span class="p">())</span>
  <span class="p">{</span>
    <span class="n">conn</span><span class="o">-&gt;</span><span class="n">shutdown</span><span class="p">();</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div>
<h3 id="测试程序-5">测试程序</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-c++" data-lang="c++"><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c++" data-lang="c++"><span class="cp">#include</span> <span class="cpf">&lt;muduo/net/http/HttpServer.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;muduo/net/http/HttpRequest.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;muduo/net/http/HttpResponse.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;muduo/net/EventLoop.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;muduo/base/Logging.h&gt;</span><span class="cp">
</span><span class="cp"></span> 
<span class="cp">#include</span> <span class="cpf">&lt;iostream&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;map&gt;</span><span class="cp">
</span><span class="cp"></span> 
<span class="k">using</span> <span class="k">namespace</span> <span class="n">muduo</span><span class="p">;</span>
<span class="k">using</span> <span class="k">namespace</span> <span class="n">muduo</span><span class="o">::</span><span class="n">net</span><span class="p">;</span>
 
<span class="k">extern</span> <span class="kt">char</span> <span class="n">favicon</span><span class="p">[</span><span class="mi">555</span><span class="p">];</span>
<span class="kt">bool</span> <span class="n">benchmark</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
 
<span class="c1">// 实际的请求处理
</span><span class="c1"></span><span class="kt">void</span> <span class="nf">onRequest</span><span class="p">(</span><span class="k">const</span> <span class="n">HttpRequest</span><span class="o">&amp;</span> <span class="n">req</span><span class="p">,</span> <span class="n">HttpResponse</span><span class="o">*</span> <span class="n">resp</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;Headers &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">req</span><span class="p">.</span><span class="n">methodString</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="s">&#34; &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">req</span><span class="p">.</span><span class="n">path</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">benchmark</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">map</span><span class="o">&lt;</span><span class="n">string</span><span class="p">,</span> <span class="n">string</span><span class="o">&gt;&amp;</span> <span class="n">headers</span> <span class="o">=</span> <span class="n">req</span><span class="p">.</span><span class="n">headers</span><span class="p">();</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">map</span><span class="o">&lt;</span><span class="n">string</span><span class="p">,</span> <span class="n">string</span><span class="o">&gt;::</span><span class="n">const_iterator</span> <span class="n">it</span> <span class="o">=</span> <span class="n">headers</span><span class="p">.</span><span class="n">begin</span><span class="p">();</span>
         <span class="n">it</span> <span class="o">!=</span> <span class="n">headers</span><span class="p">.</span><span class="n">end</span><span class="p">();</span>
         <span class="o">++</span><span class="n">it</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="n">it</span><span class="o">-&gt;</span><span class="n">first</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;: &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">it</span><span class="o">-&gt;</span><span class="n">second</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
 
  <span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="p">.</span><span class="n">path</span><span class="p">()</span> <span class="o">==</span> <span class="s">&#34;/&#34;</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">resp</span><span class="o">-&gt;</span><span class="n">setStatusCode</span><span class="p">(</span><span class="n">HttpResponse</span><span class="o">::</span><span class="n">k200Ok</span><span class="p">);</span>
    <span class="n">resp</span><span class="o">-&gt;</span><span class="n">setStatusMessage</span><span class="p">(</span><span class="s">&#34;OK&#34;</span><span class="p">);</span>
    <span class="n">resp</span><span class="o">-&gt;</span><span class="n">setContentType</span><span class="p">(</span><span class="s">&#34;text/html&#34;</span><span class="p">);</span>
    <span class="n">resp</span><span class="o">-&gt;</span><span class="n">addHeader</span><span class="p">(</span><span class="s">&#34;Server&#34;</span><span class="p">,</span> <span class="s">&#34;Muduo&#34;</span><span class="p">);</span>
    <span class="n">string</span> <span class="n">now</span> <span class="o">=</span> <span class="n">Timestamp</span><span class="o">::</span><span class="n">now</span><span class="p">().</span><span class="n">toFormattedString</span><span class="p">();</span>
    <span class="n">resp</span><span class="o">-&gt;</span><span class="n">setBody</span><span class="p">(</span><span class="s">&#34;&lt;html&gt;&lt;head&gt;&lt;title&gt;This is title&lt;/title&gt;&lt;/head&gt;&#34;</span>
        <span class="s">&#34;&lt;body&gt;&lt;h1&gt;Hello&lt;/h1&gt;Now is &#34;</span> <span class="o">+</span> <span class="n">now</span> <span class="o">+</span>
        <span class="s">&#34;&lt;/body&gt;&lt;/html&gt;&#34;</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="p">.</span><span class="n">path</span><span class="p">()</span> <span class="o">==</span> <span class="s">&#34;/favicon.ico&#34;</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">resp</span><span class="o">-&gt;</span><span class="n">setStatusCode</span><span class="p">(</span><span class="n">HttpResponse</span><span class="o">::</span><span class="n">k200Ok</span><span class="p">);</span>
    <span class="n">resp</span><span class="o">-&gt;</span><span class="n">setStatusMessage</span><span class="p">(</span><span class="s">&#34;OK&#34;</span><span class="p">);</span>
    <span class="n">resp</span><span class="o">-&gt;</span><span class="n">setContentType</span><span class="p">(</span><span class="s">&#34;image/png&#34;</span><span class="p">);</span>
    <span class="n">resp</span><span class="o">-&gt;</span><span class="n">setBody</span><span class="p">(</span><span class="n">string</span><span class="p">(</span><span class="n">favicon</span><span class="p">,</span> <span class="k">sizeof</span> <span class="n">favicon</span><span class="p">));</span>
  <span class="p">}</span>
  <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="p">.</span><span class="n">path</span><span class="p">()</span> <span class="o">==</span> <span class="s">&#34;/hello&#34;</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">resp</span><span class="o">-&gt;</span><span class="n">setStatusCode</span><span class="p">(</span><span class="n">HttpResponse</span><span class="o">::</span><span class="n">k200Ok</span><span class="p">);</span>
    <span class="n">resp</span><span class="o">-&gt;</span><span class="n">setStatusMessage</span><span class="p">(</span><span class="s">&#34;OK&#34;</span><span class="p">);</span>
    <span class="n">resp</span><span class="o">-&gt;</span><span class="n">setContentType</span><span class="p">(</span><span class="s">&#34;text/plain&#34;</span><span class="p">);</span>
    <span class="n">resp</span><span class="o">-&gt;</span><span class="n">addHeader</span><span class="p">(</span><span class="s">&#34;Server&#34;</span><span class="p">,</span> <span class="s">&#34;Muduo&#34;</span><span class="p">);</span>
    <span class="n">resp</span><span class="o">-&gt;</span><span class="n">setBody</span><span class="p">(</span><span class="s">&#34;hello, world!</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">else</span>
  <span class="p">{</span>
    <span class="n">resp</span><span class="o">-&gt;</span><span class="n">setStatusCode</span><span class="p">(</span><span class="n">HttpResponse</span><span class="o">::</span><span class="n">k404NotFound</span><span class="p">);</span>
    <span class="n">resp</span><span class="o">-&gt;</span><span class="n">setStatusMessage</span><span class="p">(</span><span class="s">&#34;Not Found&#34;</span><span class="p">);</span>
    <span class="n">resp</span><span class="o">-&gt;</span><span class="n">setCloseConnection</span><span class="p">(</span><span class="nb">true</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>
 
<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span><span class="o">*</span> <span class="n">argv</span><span class="p">[])</span>
<span class="p">{</span>
  <span class="kt">int</span> <span class="n">numThreads</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">argc</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">benchmark</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
    <span class="n">Logger</span><span class="o">::</span><span class="n">setLogLevel</span><span class="p">(</span><span class="n">Logger</span><span class="o">::</span><span class="n">WARN</span><span class="p">);</span>
    <span class="n">numThreads</span> <span class="o">=</span> <span class="n">atoi</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
  <span class="p">}</span>
  <span class="n">EventLoop</span> <span class="n">loop</span><span class="p">;</span>
  <span class="n">HttpServer</span> <span class="n">server</span><span class="p">(</span><span class="o">&amp;</span><span class="n">loop</span><span class="p">,</span> <span class="n">InetAddress</span><span class="p">(</span><span class="mi">8000</span><span class="p">),</span> <span class="s">&#34;dummy&#34;</span><span class="p">);</span>
  <span class="n">server</span><span class="p">.</span><span class="n">setHttpCallback</span><span class="p">(</span><span class="n">onRequest</span><span class="p">);</span>
  <span class="n">server</span><span class="p">.</span><span class="n">setThreadNum</span><span class="p">(</span><span class="n">numThreads</span><span class="p">);</span>
  <span class="n">server</span><span class="p">.</span><span class="n">start</span><span class="p">();</span>
  <span class="n">loop</span><span class="p">.</span><span class="n">loop</span><span class="p">();</span>
<span class="p">}</span>
 
<span class="c1">// 这是一个图片数据
</span><span class="c1"></span><span class="kt">char</span> <span class="n">favicon</span><span class="p">[</span><span class="mi">555</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
  <span class="sc">&#39;\x89&#39;</span><span class="p">,</span> <span class="sc">&#39;P&#39;</span><span class="p">,</span> <span class="sc">&#39;N&#39;</span><span class="p">,</span> <span class="sc">&#39;G&#39;</span><span class="p">,</span> <span class="sc">&#39;\xD&#39;</span><span class="p">,</span> <span class="sc">&#39;\xA&#39;</span><span class="p">,</span> <span class="sc">&#39;\x1A&#39;</span><span class="p">,</span> <span class="sc">&#39;\xA&#39;</span><span class="p">,</span>
  <span class="sc">&#39;\x0&#39;</span><span class="p">,</span> <span class="sc">&#39;\x0&#39;</span><span class="p">,</span> <span class="sc">&#39;\x0&#39;</span><span class="p">,</span> <span class="sc">&#39;\xD&#39;</span><span class="p">,</span> <span class="sc">&#39;I&#39;</span><span class="p">,</span> <span class="sc">&#39;H&#39;</span><span class="p">,</span> <span class="sc">&#39;D&#39;</span><span class="p">,</span> <span class="sc">&#39;R&#39;</span><span class="p">,</span>
  <span class="sc">&#39;\x0&#39;</span><span class="p">,</span> <span class="sc">&#39;\x0&#39;</span><span class="p">,</span> <span class="sc">&#39;\x0&#39;</span><span class="p">,</span> <span class="sc">&#39;\x10&#39;</span><span class="p">,</span> <span class="sc">&#39;\x0&#39;</span><span class="p">,</span> <span class="sc">&#39;\x0&#39;</span><span class="p">,</span> <span class="sc">&#39;\x0&#39;</span><span class="p">,</span> <span class="sc">&#39;\x10&#39;</span><span class="p">,</span>
  <span class="sc">&#39;\x8&#39;</span><span class="p">,</span> <span class="sc">&#39;\x6&#39;</span><span class="p">,</span> <span class="sc">&#39;\x0&#39;</span><span class="p">,</span> <span class="sc">&#39;\x0&#39;</span><span class="p">,</span> <span class="sc">&#39;\x0&#39;</span><span class="p">,</span> <span class="sc">&#39;\x1F&#39;</span><span class="p">,</span> <span class="sc">&#39;\xF3&#39;</span><span class="p">,</span> <span class="sc">&#39;\xFF&#39;</span><span class="p">,</span>
  <span class="sc">&#39;a&#39;</span><span class="p">,</span> <span class="sc">&#39;\x0&#39;</span><span class="p">,</span> <span class="sc">&#39;\x0&#39;</span><span class="p">,</span> <span class="sc">&#39;\x0&#39;</span><span class="p">,</span> <span class="sc">&#39;\x19&#39;</span><span class="p">,</span> <span class="sc">&#39;t&#39;</span><span class="p">,</span> <span class="sc">&#39;E&#39;</span><span class="p">,</span> <span class="sc">&#39;X&#39;</span><span class="p">,</span>
  <span class="sc">&#39;t&#39;</span><span class="p">,</span> <span class="sc">&#39;S&#39;</span><span class="p">,</span> <span class="sc">&#39;o&#39;</span><span class="p">,</span> <span class="sc">&#39;f&#39;</span><span class="p">,</span> <span class="sc">&#39;t&#39;</span><span class="p">,</span> <span class="sc">&#39;w&#39;</span><span class="p">,</span> <span class="sc">&#39;a&#39;</span><span class="p">,</span> <span class="sc">&#39;r&#39;</span><span class="p">,</span>
  <span class="sc">&#39;e&#39;</span><span class="p">,</span> <span class="sc">&#39;\x0&#39;</span><span class="p">,</span> <span class="sc">&#39;A&#39;</span><span class="p">,</span> <span class="sc">&#39;d&#39;</span><span class="p">,</span> <span class="sc">&#39;o&#39;</span><span class="p">,</span> <span class="sc">&#39;b&#39;</span><span class="p">,</span> <span class="sc">&#39;e&#39;</span><span class="p">,</span> <span class="sc">&#39;\x20&#39;</span><span class="p">,</span>
  <span class="sc">&#39;I&#39;</span><span class="p">,</span> <span class="sc">&#39;m&#39;</span><span class="p">,</span> <span class="sc">&#39;a&#39;</span><span class="p">,</span> <span class="sc">&#39;g&#39;</span><span class="p">,</span> <span class="sc">&#39;e&#39;</span><span class="p">,</span> <span class="sc">&#39;R&#39;</span><span class="p">,</span> <span class="sc">&#39;e&#39;</span><span class="p">,</span> <span class="sc">&#39;a&#39;</span><span class="p">,</span>
  <span class="sc">&#39;d&#39;</span><span class="p">,</span> <span class="sc">&#39;y&#39;</span><span class="p">,</span> <span class="sc">&#39;q&#39;</span><span class="p">,</span> <span class="sc">&#39;\xC9&#39;</span><span class="p">,</span> <span class="sc">&#39;e&#39;</span><span class="p">,</span> <span class="sc">&#39;\x3C&#39;</span><span class="p">,</span> <span class="sc">&#39;\x0&#39;</span><span class="p">,</span> <span class="sc">&#39;\x0&#39;</span><span class="p">,</span>
  <span class="sc">&#39;\x1&#39;</span><span class="p">,</span> <span class="sc">&#39;\xCD&#39;</span><span class="p">,</span> <span class="sc">&#39;I&#39;</span><span class="p">,</span> <span class="sc">&#39;D&#39;</span><span class="p">,</span> <span class="sc">&#39;A&#39;</span><span class="p">,</span> <span class="sc">&#39;T&#39;</span><span class="p">,</span> <span class="sc">&#39;x&#39;</span><span class="p">,</span> <span class="sc">&#39;\xDA&#39;</span><span class="p">,</span>
  <span class="sc">&#39;\x94&#39;</span><span class="p">,</span> <span class="sc">&#39;\x93&#39;</span><span class="p">,</span> <span class="sc">&#39;9&#39;</span><span class="p">,</span> <span class="sc">&#39;H&#39;</span><span class="p">,</span> <span class="sc">&#39;\x3&#39;</span><span class="p">,</span> <span class="sc">&#39;A&#39;</span><span class="p">,</span> <span class="sc">&#39;\x14&#39;</span><span class="p">,</span> <span class="sc">&#39;\x86&#39;</span><span class="p">,</span>
  <span class="sc">&#39;\xFF&#39;</span><span class="p">,</span> <span class="sc">&#39;\x5D&#39;</span><span class="p">,</span> <span class="sc">&#39;b&#39;</span><span class="p">,</span> <span class="sc">&#39;\xA7&#39;</span><span class="p">,</span> <span class="sc">&#39;\x4&#39;</span><span class="p">,</span> <span class="sc">&#39;R&#39;</span><span class="p">,</span> <span class="sc">&#39;\xC4&#39;</span><span class="p">,</span> <span class="sc">&#39;m&#39;</span><span class="p">,</span>
  <span class="sc">&#39;\x22&#39;</span><span class="p">,</span> <span class="sc">&#39;\x1E&#39;</span><span class="p">,</span> <span class="sc">&#39;\xA0&#39;</span><span class="p">,</span> <span class="sc">&#39;F&#39;</span><span class="p">,</span> <span class="sc">&#39;\x24&#39;</span><span class="p">,</span> <span class="sc">&#39;\x8&#39;</span><span class="p">,</span> <span class="sc">&#39;\x16&#39;</span><span class="p">,</span> <span class="sc">&#39;\x16&#39;</span><span class="p">,</span>
  <span class="sc">&#39;v&#39;</span><span class="p">,</span> <span class="sc">&#39;\xA&#39;</span><span class="p">,</span> <span class="sc">&#39;6&#39;</span><span class="p">,</span> <span class="sc">&#39;\xBA&#39;</span><span class="p">,</span> <span class="sc">&#39;J&#39;</span><span class="p">,</span> <span class="sc">&#39;\x9A&#39;</span><span class="p">,</span> <span class="sc">&#39;\x80&#39;</span><span class="p">,</span> <span class="sc">&#39;\x8&#39;</span><span class="p">,</span>
  <span class="sc">&#39;A&#39;</span><span class="p">,</span> <span class="sc">&#39;\xB4&#39;</span><span class="p">,</span> <span class="sc">&#39;q&#39;</span><span class="p">,</span> <span class="sc">&#39;\x85&#39;</span><span class="p">,</span> <span class="sc">&#39;X&#39;</span><span class="p">,</span> <span class="sc">&#39;\x89&#39;</span><span class="p">,</span> <span class="sc">&#39;G&#39;</span><span class="p">,</span> <span class="sc">&#39;\xB0&#39;</span><span class="p">,</span>
  <span class="sc">&#39;I&#39;</span><span class="p">,</span> <span class="sc">&#39;\xA9&#39;</span><span class="p">,</span> <span class="sc">&#39;Q&#39;</span><span class="p">,</span> <span class="sc">&#39;\x24&#39;</span><span class="p">,</span> <span class="sc">&#39;\xCD&#39;</span><span class="p">,</span> <span class="sc">&#39;\xA6&#39;</span><span class="p">,</span> <span class="sc">&#39;\x8&#39;</span><span class="p">,</span> <span class="sc">&#39;\xA4&#39;</span><span class="p">,</span>
  <span class="sc">&#39;H&#39;</span><span class="p">,</span> <span class="sc">&#39;c&#39;</span><span class="p">,</span> <span class="sc">&#39;\x91&#39;</span><span class="p">,</span> <span class="sc">&#39;B&#39;</span><span class="p">,</span> <span class="sc">&#39;\xB&#39;</span><span class="p">,</span> <span class="sc">&#39;\xAF&#39;</span><span class="p">,</span> <span class="sc">&#39;V&#39;</span><span class="p">,</span> <span class="sc">&#39;\xC1&#39;</span><span class="p">,</span>
  <span class="sc">&#39;F&#39;</span><span class="p">,</span> <span class="sc">&#39;\xB4&#39;</span><span class="p">,</span> <span class="sc">&#39;\x15&#39;</span><span class="p">,</span> <span class="sc">&#39;\xCF&#39;</span><span class="p">,</span> <span class="sc">&#39;\x22&#39;</span><span class="p">,</span> <span class="sc">&#39;X&#39;</span><span class="p">,</span> <span class="sc">&#39;\x98&#39;</span><span class="p">,</span> <span class="sc">&#39;\xB&#39;</span><span class="p">,</span>
  <span class="sc">&#39;T&#39;</span><span class="p">,</span> <span class="sc">&#39;H&#39;</span><span class="p">,</span> <span class="sc">&#39;\x8A&#39;</span><span class="p">,</span> <span class="sc">&#39;d&#39;</span><span class="p">,</span> <span class="sc">&#39;\x93&#39;</span><span class="p">,</span> <span class="sc">&#39;\x8D&#39;</span><span class="p">,</span> <span class="sc">&#39;\xFB&#39;</span><span class="p">,</span> <span class="sc">&#39;F&#39;</span><span class="p">,</span>
  <span class="sc">&#39;g&#39;</span><span class="p">,</span> <span class="sc">&#39;\xC9&#39;</span><span class="p">,</span> <span class="sc">&#39;\x1A&#39;</span><span class="p">,</span> <span class="sc">&#39;\x14&#39;</span><span class="p">,</span> <span class="sc">&#39;\x7D&#39;</span><span class="p">,</span> <span class="sc">&#39;\xF0&#39;</span><span class="p">,</span> <span class="sc">&#39;f&#39;</span><span class="p">,</span> <span class="sc">&#39;v&#39;</span><span class="p">,</span>
  <span class="sc">&#39;f&#39;</span><span class="p">,</span> <span class="sc">&#39;\xDF&#39;</span><span class="p">,</span> <span class="sc">&#39;\x7C&#39;</span><span class="p">,</span> <span class="sc">&#39;\xEF&#39;</span><span class="p">,</span> <span class="sc">&#39;\xE7&#39;</span><span class="p">,</span> <span class="sc">&#39;g&#39;</span><span class="p">,</span> <span class="sc">&#39;F&#39;</span><span class="p">,</span> <span class="sc">&#39;\xA8&#39;</span><span class="p">,</span>
  <span class="sc">&#39;\xD5&#39;</span><span class="p">,</span> <span class="sc">&#39;j&#39;</span><span class="p">,</span> <span class="sc">&#39;H&#39;</span><span class="p">,</span> <span class="sc">&#39;\x24&#39;</span><span class="p">,</span> <span class="sc">&#39;\x12&#39;</span><span class="p">,</span> <span class="sc">&#39;\x2A&#39;</span><span class="p">,</span> <span class="sc">&#39;\x0&#39;</span><span class="p">,</span> <span class="sc">&#39;\x5&#39;</span><span class="p">,</span>
  <span class="sc">&#39;\xBF&#39;</span><span class="p">,</span> <span class="sc">&#39;G&#39;</span><span class="p">,</span> <span class="sc">&#39;\xD4&#39;</span><span class="p">,</span> <span class="sc">&#39;\xEF&#39;</span><span class="p">,</span> <span class="sc">&#39;\xF7&#39;</span><span class="p">,</span> <span class="sc">&#39;\x2F&#39;</span><span class="p">,</span> <span class="sc">&#39;6&#39;</span><span class="p">,</span> <span class="sc">&#39;\xEC&#39;</span><span class="p">,</span>
  <span class="sc">&#39;\x12&#39;</span><span class="p">,</span> <span class="sc">&#39;\x20&#39;</span><span class="p">,</span> <span class="sc">&#39;\x1E&#39;</span><span class="p">,</span> <span class="sc">&#39;\x8F&#39;</span><span class="p">,</span> <span class="sc">&#39;\xD7&#39;</span><span class="p">,</span> <span class="sc">&#39;\xAA&#39;</span><span class="p">,</span> <span class="sc">&#39;\xD5&#39;</span><span class="p">,</span> <span class="sc">&#39;\xEA&#39;</span><span class="p">,</span>
  <span class="sc">&#39;\xAF&#39;</span><span class="p">,</span> <span class="sc">&#39;I&#39;</span><span class="p">,</span> <span class="sc">&#39;5&#39;</span><span class="p">,</span> <span class="sc">&#39;F&#39;</span><span class="p">,</span> <span class="sc">&#39;\xAA&#39;</span><span class="p">,</span> <span class="sc">&#39;T&#39;</span><span class="p">,</span> <span class="sc">&#39;\x5F&#39;</span><span class="p">,</span> <span class="sc">&#39;\x9F&#39;</span><span class="p">,</span>
  <span class="sc">&#39;\x22&#39;</span><span class="p">,</span> <span class="sc">&#39;A&#39;</span><span class="p">,</span> <span class="sc">&#39;\x2A&#39;</span><span class="p">,</span> <span class="sc">&#39;\x95&#39;</span><span class="p">,</span> <span class="sc">&#39;\xA&#39;</span><span class="p">,</span> <span class="sc">&#39;\x83&#39;</span><span class="p">,</span> <span class="sc">&#39;\xE5&#39;</span><span class="p">,</span> <span class="sc">&#39;r&#39;</span><span class="p">,</span>
  <span class="sc">&#39;9&#39;</span><span class="p">,</span> <span class="sc">&#39;d&#39;</span><span class="p">,</span> <span class="sc">&#39;\xB3&#39;</span><span class="p">,</span> <span class="sc">&#39;Y&#39;</span><span class="p">,</span> <span class="sc">&#39;\x96&#39;</span><span class="p">,</span> <span class="sc">&#39;\x99&#39;</span><span class="p">,</span> <span class="sc">&#39;L&#39;</span><span class="p">,</span> <span class="sc">&#39;\x6&#39;</span><span class="p">,</span>
  <span class="sc">&#39;\xE9&#39;</span><span class="p">,</span> <span class="sc">&#39;t&#39;</span><span class="p">,</span> <span class="sc">&#39;\x9A&#39;</span><span class="p">,</span> <span class="sc">&#39;\x25&#39;</span><span class="p">,</span> <span class="sc">&#39;\x85&#39;</span><span class="p">,</span> <span class="sc">&#39;\x2C&#39;</span><span class="p">,</span> <span class="sc">&#39;\xCB&#39;</span><span class="p">,</span> <span class="sc">&#39;T&#39;</span><span class="p">,</span>
  <span class="sc">&#39;\xA7&#39;</span><span class="p">,</span> <span class="sc">&#39;\xC4&#39;</span><span class="p">,</span> <span class="sc">&#39;b&#39;</span><span class="p">,</span> <span class="sc">&#39;1&#39;</span><span class="p">,</span> <span class="sc">&#39;\xB5&#39;</span><span class="p">,</span> <span class="sc">&#39;\x5E&#39;</span><span class="p">,</span> <span class="sc">&#39;\x0&#39;</span><span class="p">,</span> <span class="sc">&#39;\x3&#39;</span><span class="p">,</span>
  <span class="sc">&#39;h&#39;</span><span class="p">,</span> <span class="sc">&#39;\x9A&#39;</span><span class="p">,</span> <span class="sc">&#39;\xC6&#39;</span><span class="p">,</span> <span class="sc">&#39;\x16&#39;</span><span class="p">,</span> <span class="sc">&#39;\x82&#39;</span><span class="p">,</span> <span class="sc">&#39;\x20&#39;</span><span class="p">,</span> <span class="sc">&#39;X&#39;</span><span class="p">,</span> <span class="sc">&#39;R&#39;</span><span class="p">,</span>
  <span class="sc">&#39;\x14&#39;</span><span class="p">,</span> <span class="sc">&#39;E&#39;</span><span class="p">,</span> <span class="sc">&#39;6&#39;</span><span class="p">,</span> <span class="sc">&#39;S&#39;</span><span class="p">,</span> <span class="sc">&#39;\x94&#39;</span><span class="p">,</span> <span class="sc">&#39;\xCB&#39;</span><span class="p">,</span> <span class="sc">&#39;e&#39;</span><span class="p">,</span> <span class="sc">&#39;x&#39;</span><span class="p">,</span>
  <span class="sc">&#39;\xBD&#39;</span><span class="p">,</span> <span class="sc">&#39;\x5E&#39;</span><span class="p">,</span> <span class="sc">&#39;\xAA&#39;</span><span class="p">,</span> <span class="sc">&#39;U&#39;</span><span class="p">,</span> <span class="sc">&#39;T&#39;</span><span class="p">,</span> <span class="sc">&#39;\x23&#39;</span><span class="p">,</span> <span class="sc">&#39;L&#39;</span><span class="p">,</span> <span class="sc">&#39;\xC0&#39;</span><span class="p">,</span>
  <span class="sc">&#39;\xE0&#39;</span><span class="p">,</span> <span class="sc">&#39;\xE2&#39;</span><span class="p">,</span> <span class="sc">&#39;\xC1&#39;</span><span class="p">,</span> <span class="sc">&#39;\x8F&#39;</span><span class="p">,</span> <span class="sc">&#39;\x0&#39;</span><span class="p">,</span> <span class="sc">&#39;\x9E&#39;</span><span class="p">,</span> <span class="sc">&#39;\xBC&#39;</span><span class="p">,</span> <span class="sc">&#39;\x9&#39;</span><span class="p">,</span>
  <span class="sc">&#39;A&#39;</span><span class="p">,</span> <span class="sc">&#39;\x7C&#39;</span><span class="p">,</span> <span class="sc">&#39;\x3E&#39;</span><span class="p">,</span> <span class="sc">&#39;\x1F&#39;</span><span class="p">,</span> <span class="sc">&#39;\x83&#39;</span><span class="p">,</span> <span class="sc">&#39;D&#39;</span><span class="p">,</span> <span class="sc">&#39;\x22&#39;</span><span class="p">,</span> <span class="sc">&#39;\x11&#39;</span><span class="p">,</span>
  <span class="sc">&#39;\xD5&#39;</span><span class="p">,</span> <span class="sc">&#39;T&#39;</span><span class="p">,</span> <span class="sc">&#39;\x40&#39;</span><span class="p">,</span> <span class="sc">&#39;\x3F&#39;</span><span class="p">,</span> <span class="sc">&#39;8&#39;</span><span class="p">,</span> <span class="sc">&#39;\x80&#39;</span><span class="p">,</span> <span class="sc">&#39;w&#39;</span><span class="p">,</span> <span class="sc">&#39;\xE5&#39;</span><span class="p">,</span>
  <span class="sc">&#39;3&#39;</span><span class="p">,</span> <span class="sc">&#39;\x7&#39;</span><span class="p">,</span> <span class="sc">&#39;\xB8&#39;</span><span class="p">,</span> <span class="sc">&#39;\x5C&#39;</span><span class="p">,</span> <span class="sc">&#39;\x2E&#39;</span><span class="p">,</span> <span class="sc">&#39;H&#39;</span><span class="p">,</span> <span class="sc">&#39;\x92&#39;</span><span class="p">,</span> <span class="sc">&#39;\x4&#39;</span><span class="p">,</span>
  <span class="sc">&#39;\x87&#39;</span><span class="p">,</span> <span class="sc">&#39;\xC3&#39;</span><span class="p">,</span> <span class="sc">&#39;\x81&#39;</span><span class="p">,</span> <span class="sc">&#39;\x40&#39;</span><span class="p">,</span> <span class="sc">&#39;\x20&#39;</span><span class="p">,</span> <span class="sc">&#39;\x40&#39;</span><span class="p">,</span> <span class="sc">&#39;g&#39;</span><span class="p">,</span> <span class="sc">&#39;\x98&#39;</span><span class="p">,</span>
  <span class="sc">&#39;\xE9&#39;</span><span class="p">,</span> <span class="sc">&#39;6&#39;</span><span class="p">,</span> <span class="sc">&#39;\x1A&#39;</span><span class="p">,</span> <span class="sc">&#39;\xA6&#39;</span><span class="p">,</span> <span class="sc">&#39;g&#39;</span><span class="p">,</span> <span class="sc">&#39;\x15&#39;</span><span class="p">,</span> <span class="sc">&#39;\x4&#39;</span><span class="p">,</span> <span class="sc">&#39;\xE3&#39;</span><span class="p">,</span>
  <span class="sc">&#39;\xD7&#39;</span><span class="p">,</span> <span class="sc">&#39;\xC8&#39;</span><span class="p">,</span> <span class="sc">&#39;\xBD&#39;</span><span class="p">,</span> <span class="sc">&#39;\x15&#39;</span><span class="p">,</span> <span class="sc">&#39;\xE1&#39;</span><span class="p">,</span> <span class="sc">&#39;i&#39;</span><span class="p">,</span> <span class="sc">&#39;\xB7&#39;</span><span class="p">,</span> <span class="sc">&#39;C&#39;</span><span class="p">,</span>
  <span class="sc">&#39;\xAB&#39;</span><span class="p">,</span> <span class="sc">&#39;\xEA&#39;</span><span class="p">,</span> <span class="sc">&#39;x&#39;</span><span class="p">,</span> <span class="sc">&#39;\x2F&#39;</span><span class="p">,</span> <span class="sc">&#39;j&#39;</span><span class="p">,</span> <span class="sc">&#39;X&#39;</span><span class="p">,</span> <span class="sc">&#39;\x92&#39;</span><span class="p">,</span> <span class="sc">&#39;\xBB&#39;</span><span class="p">,</span>
  <span class="sc">&#39;\x18&#39;</span><span class="p">,</span> <span class="sc">&#39;\x20&#39;</span><span class="p">,</span> <span class="sc">&#39;\x9F&#39;</span><span class="p">,</span> <span class="sc">&#39;\xCF&#39;</span><span class="p">,</span> <span class="sc">&#39;3&#39;</span><span class="p">,</span> <span class="sc">&#39;\xC3&#39;</span><span class="p">,</span> <span class="sc">&#39;\xB8&#39;</span><span class="p">,</span> <span class="sc">&#39;\xE9&#39;</span><span class="p">,</span>
  <span class="sc">&#39;N&#39;</span><span class="p">,</span> <span class="sc">&#39;\xA7&#39;</span><span class="p">,</span> <span class="sc">&#39;\xD3&#39;</span><span class="p">,</span> <span class="sc">&#39;l&#39;</span><span class="p">,</span> <span class="sc">&#39;J&#39;</span><span class="p">,</span> <span class="sc">&#39;\x0&#39;</span><span class="p">,</span> <span class="sc">&#39;i&#39;</span><span class="p">,</span> <span class="sc">&#39;6&#39;</span><span class="p">,</span>
  <span class="sc">&#39;\x7C&#39;</span><span class="p">,</span> <span class="sc">&#39;\x8E&#39;</span><span class="p">,</span> <span class="sc">&#39;\xE1&#39;</span><span class="p">,</span> <span class="sc">&#39;\xFE&#39;</span><span class="p">,</span> <span class="sc">&#39;V&#39;</span><span class="p">,</span> <span class="sc">&#39;\x84&#39;</span><span class="p">,</span> <span class="sc">&#39;\xE7&#39;</span><span class="p">,</span> <span class="sc">&#39;\x3C&#39;</span><span class="p">,</span>
  <span class="sc">&#39;\x9F&#39;</span><span class="p">,</span> <span class="sc">&#39;r&#39;</span><span class="p">,</span> <span class="sc">&#39;\x2B&#39;</span><span class="p">,</span> <span class="sc">&#39;\x3A&#39;</span><span class="p">,</span> <span class="sc">&#39;B&#39;</span><span class="p">,</span> <span class="sc">&#39;\x7B&#39;</span><span class="p">,</span> <span class="sc">&#39;7&#39;</span><span class="p">,</span> <span class="sc">&#39;f&#39;</span><span class="p">,</span>
  <span class="sc">&#39;w&#39;</span><span class="p">,</span> <span class="sc">&#39;\xAE&#39;</span><span class="p">,</span> <span class="sc">&#39;\x8E&#39;</span><span class="p">,</span> <span class="sc">&#39;\xE&#39;</span><span class="p">,</span> <span class="sc">&#39;\xF3&#39;</span><span class="p">,</span> <span class="sc">&#39;\xBD&#39;</span><span class="p">,</span> <span class="sc">&#39;R&#39;</span><span class="p">,</span> <span class="sc">&#39;\xA9&#39;</span><span class="p">,</span>
  <span class="sc">&#39;d&#39;</span><span class="p">,</span> <span class="sc">&#39;\x2&#39;</span><span class="p">,</span> <span class="sc">&#39;B&#39;</span><span class="p">,</span> <span class="sc">&#39;\xAF&#39;</span><span class="p">,</span> <span class="sc">&#39;\x85&#39;</span><span class="p">,</span> <span class="sc">&#39;2&#39;</span><span class="p">,</span> <span class="sc">&#39;f&#39;</span><span class="p">,</span> <span class="sc">&#39;F&#39;</span><span class="p">,</span>
  <span class="sc">&#39;\xBA&#39;</span><span class="p">,</span> <span class="sc">&#39;\xC&#39;</span><span class="p">,</span> <span class="sc">&#39;\xD9&#39;</span><span class="p">,</span> <span class="sc">&#39;\x9F&#39;</span><span class="p">,</span> <span class="sc">&#39;\x1D&#39;</span><span class="p">,</span> <span class="sc">&#39;\x9A&#39;</span><span class="p">,</span> <span class="sc">&#39;l&#39;</span><span class="p">,</span> <span class="sc">&#39;\x22&#39;</span><span class="p">,</span>
  <span class="sc">&#39;\xE6&#39;</span><span class="p">,</span> <span class="sc">&#39;\xC7&#39;</span><span class="p">,</span> <span class="sc">&#39;\x3A&#39;</span><span class="p">,</span> <span class="sc">&#39;\x2C&#39;</span><span class="p">,</span> <span class="sc">&#39;\x80&#39;</span><span class="p">,</span> <span class="sc">&#39;\xEF&#39;</span><span class="p">,</span> <span class="sc">&#39;\xC1&#39;</span><span class="p">,</span> <span class="sc">&#39;\x15&#39;</span><span class="p">,</span>
  <span class="sc">&#39;\x90&#39;</span><span class="p">,</span> <span class="sc">&#39;\x7&#39;</span><span class="p">,</span> <span class="sc">&#39;\x93&#39;</span><span class="p">,</span> <span class="sc">&#39;\xA2&#39;</span><span class="p">,</span> <span class="sc">&#39;\x28&#39;</span><span class="p">,</span> <span class="sc">&#39;\xA0&#39;</span><span class="p">,</span> <span class="sc">&#39;S&#39;</span><span class="p">,</span> <span class="sc">&#39;j&#39;</span><span class="p">,</span>
  <span class="sc">&#39;\xB1&#39;</span><span class="p">,</span> <span class="sc">&#39;\xB8&#39;</span><span class="p">,</span> <span class="sc">&#39;\xDF&#39;</span><span class="p">,</span> <span class="sc">&#39;\x29&#39;</span><span class="p">,</span> <span class="sc">&#39;5&#39;</span><span class="p">,</span> <span class="sc">&#39;C&#39;</span><span class="p">,</span> <span class="sc">&#39;\xE&#39;</span><span class="p">,</span> <span class="sc">&#39;\x3F&#39;</span><span class="p">,</span>
  <span class="sc">&#39;X&#39;</span><span class="p">,</span> <span class="sc">&#39;\xFC&#39;</span><span class="p">,</span> <span class="sc">&#39;\x98&#39;</span><span class="p">,</span> <span class="sc">&#39;\xDA&#39;</span><span class="p">,</span> <span class="sc">&#39;y&#39;</span><span class="p">,</span> <span class="sc">&#39;j&#39;</span><span class="p">,</span> <span class="sc">&#39;P&#39;</span><span class="p">,</span> <span class="sc">&#39;\x40&#39;</span><span class="p">,</span>
  <span class="sc">&#39;\x0&#39;</span><span class="p">,</span> <span class="sc">&#39;\x87&#39;</span><span class="p">,</span> <span class="sc">&#39;\xAE&#39;</span><span class="p">,</span> <span class="sc">&#39;\x1B&#39;</span><span class="p">,</span> <span class="sc">&#39;\x17&#39;</span><span class="p">,</span> <span class="sc">&#39;B&#39;</span><span class="p">,</span> <span class="sc">&#39;\xB4&#39;</span><span class="p">,</span> <span class="sc">&#39;\x3A&#39;</span><span class="p">,</span>
  <span class="sc">&#39;\x3F&#39;</span><span class="p">,</span> <span class="sc">&#39;\xBE&#39;</span><span class="p">,</span> <span class="sc">&#39;y&#39;</span><span class="p">,</span> <span class="sc">&#39;\xC7&#39;</span><span class="p">,</span> <span class="sc">&#39;\xA&#39;</span><span class="p">,</span> <span class="sc">&#39;\x26&#39;</span><span class="p">,</span> <span class="sc">&#39;\xB6&#39;</span><span class="p">,</span> <span class="sc">&#39;\xEE&#39;</span><span class="p">,</span>
  <span class="sc">&#39;\xD9&#39;</span><span class="p">,</span> <span class="sc">&#39;\x9A&#39;</span><span class="p">,</span> <span class="sc">&#39;\x60&#39;</span><span class="p">,</span> <span class="sc">&#39;\x14&#39;</span><span class="p">,</span> <span class="sc">&#39;\x93&#39;</span><span class="p">,</span> <span class="sc">&#39;\xDB&#39;</span><span class="p">,</span> <span class="sc">&#39;\x8F&#39;</span><span class="p">,</span> <span class="sc">&#39;\xD&#39;</span><span class="p">,</span>
  <span class="sc">&#39;\xA&#39;</span><span class="p">,</span> <span class="sc">&#39;\x2E&#39;</span><span class="p">,</span> <span class="sc">&#39;\xE9&#39;</span><span class="p">,</span> <span class="sc">&#39;\x23&#39;</span><span class="p">,</span> <span class="sc">&#39;\x95&#39;</span><span class="p">,</span> <span class="sc">&#39;\x29&#39;</span><span class="p">,</span> <span class="sc">&#39;X&#39;</span><span class="p">,</span> <span class="sc">&#39;\x0&#39;</span><span class="p">,</span>
  <span class="sc">&#39;\x27&#39;</span><span class="p">,</span> <span class="sc">&#39;\xEB&#39;</span><span class="p">,</span> <span class="sc">&#39;n&#39;</span><span class="p">,</span> <span class="sc">&#39;V&#39;</span><span class="p">,</span> <span class="sc">&#39;p&#39;</span><span class="p">,</span> <span class="sc">&#39;\xBC&#39;</span><span class="p">,</span> <span class="sc">&#39;\xD6&#39;</span><span class="p">,</span> <span class="sc">&#39;\xCB&#39;</span><span class="p">,</span>
  <span class="sc">&#39;\xD6&#39;</span><span class="p">,</span> <span class="sc">&#39;G&#39;</span><span class="p">,</span> <span class="sc">&#39;\xAB&#39;</span><span class="p">,</span> <span class="sc">&#39;\x3D&#39;</span><span class="p">,</span> <span class="sc">&#39;l&#39;</span><span class="p">,</span> <span class="sc">&#39;\x7D&#39;</span><span class="p">,</span> <span class="sc">&#39;\xB8&#39;</span><span class="p">,</span> <span class="sc">&#39;\xD2&#39;</span><span class="p">,</span>
  <span class="sc">&#39;\xDD&#39;</span><span class="p">,</span> <span class="sc">&#39;\xA0&#39;</span><span class="p">,</span> <span class="sc">&#39;\x60&#39;</span><span class="p">,</span> <span class="sc">&#39;\x83&#39;</span><span class="p">,</span> <span class="sc">&#39;\xBA&#39;</span><span class="p">,</span> <span class="sc">&#39;\xEF&#39;</span><span class="p">,</span> <span class="sc">&#39;\x5F&#39;</span><span class="p">,</span> <span class="sc">&#39;\xA4&#39;</span><span class="p">,</span>
  <span class="sc">&#39;\xEA&#39;</span><span class="p">,</span> <span class="sc">&#39;\xCC&#39;</span><span class="p">,</span> <span class="sc">&#39;\x2&#39;</span><span class="p">,</span> <span class="sc">&#39;N&#39;</span><span class="p">,</span> <span class="sc">&#39;\xAE&#39;</span><span class="p">,</span> <span class="sc">&#39;\x5E&#39;</span><span class="p">,</span> <span class="sc">&#39;p&#39;</span><span class="p">,</span> <span class="sc">&#39;\x1A&#39;</span><span class="p">,</span>
  <span class="sc">&#39;\xEC&#39;</span><span class="p">,</span> <span class="sc">&#39;\xB3&#39;</span><span class="p">,</span> <span class="sc">&#39;\x40&#39;</span><span class="p">,</span> <span class="sc">&#39;9&#39;</span><span class="p">,</span> <span class="sc">&#39;\xAC&#39;</span><span class="p">,</span> <span class="sc">&#39;\xFE&#39;</span><span class="p">,</span> <span class="sc">&#39;\xF2&#39;</span><span class="p">,</span> <span class="sc">&#39;\x91&#39;</span><span class="p">,</span>
  <span class="sc">&#39;\x89&#39;</span><span class="p">,</span> <span class="sc">&#39;g&#39;</span><span class="p">,</span> <span class="sc">&#39;\x91&#39;</span><span class="p">,</span> <span class="sc">&#39;\x85&#39;</span><span class="p">,</span> <span class="sc">&#39;\x21&#39;</span><span class="p">,</span> <span class="sc">&#39;\xA8&#39;</span><span class="p">,</span> <span class="sc">&#39;\x87&#39;</span><span class="p">,</span> <span class="sc">&#39;\xB7&#39;</span><span class="p">,</span>
  <span class="sc">&#39;X&#39;</span><span class="p">,</span> <span class="sc">&#39;\x7E&#39;</span><span class="p">,</span> <span class="sc">&#39;\x7E&#39;</span><span class="p">,</span> <span class="sc">&#39;\x85&#39;</span><span class="p">,</span> <span class="sc">&#39;\xBB&#39;</span><span class="p">,</span> <span class="sc">&#39;\xCD&#39;</span><span class="p">,</span> <span class="sc">&#39;N&#39;</span><span class="p">,</span> <span class="sc">&#39;N&#39;</span><span class="p">,</span>
  <span class="sc">&#39;b&#39;</span><span class="p">,</span> <span class="sc">&#39;t&#39;</span><span class="p">,</span> <span class="sc">&#39;\x40&#39;</span><span class="p">,</span> <span class="sc">&#39;\xFA&#39;</span><span class="p">,</span> <span class="sc">&#39;\x93&#39;</span><span class="p">,</span> <span class="sc">&#39;\x89&#39;</span><span class="p">,</span> <span class="sc">&#39;\xEC&#39;</span><span class="p">,</span> <span class="sc">&#39;\x1E&#39;</span><span class="p">,</span>
  <span class="sc">&#39;\xEC&#39;</span><span class="p">,</span> <span class="sc">&#39;\x86&#39;</span><span class="p">,</span> <span class="sc">&#39;\x2&#39;</span><span class="p">,</span> <span class="sc">&#39;H&#39;</span><span class="p">,</span> <span class="sc">&#39;\x26&#39;</span><span class="p">,</span> <span class="sc">&#39;\x93&#39;</span><span class="p">,</span> <span class="sc">&#39;\xD0&#39;</span><span class="p">,</span> <span class="sc">&#39;u&#39;</span><span class="p">,</span>
  <span class="sc">&#39;\x1D&#39;</span><span class="p">,</span> <span class="sc">&#39;\x7F&#39;</span><span class="p">,</span> <span class="sc">&#39;\x9&#39;</span><span class="p">,</span> <span class="sc">&#39;2&#39;</span><span class="p">,</span> <span class="sc">&#39;\x95&#39;</span><span class="p">,</span> <span class="sc">&#39;\xBF&#39;</span><span class="p">,</span> <span class="sc">&#39;\x1F&#39;</span><span class="p">,</span> <span class="sc">&#39;\xDB&#39;</span><span class="p">,</span>
  <span class="sc">&#39;\xD7&#39;</span><span class="p">,</span> <span class="sc">&#39;c&#39;</span><span class="p">,</span> <span class="sc">&#39;\x8A&#39;</span><span class="p">,</span> <span class="sc">&#39;\x1A&#39;</span><span class="p">,</span> <span class="sc">&#39;\xF7&#39;</span><span class="p">,</span> <span class="sc">&#39;\x5C&#39;</span><span class="p">,</span> <span class="sc">&#39;\xC1&#39;</span><span class="p">,</span> <span class="sc">&#39;\xFF&#39;</span><span class="p">,</span>
  <span class="sc">&#39;\x22&#39;</span><span class="p">,</span> <span class="sc">&#39;J&#39;</span><span class="p">,</span> <span class="sc">&#39;\xC3&#39;</span><span class="p">,</span> <span class="sc">&#39;\x87&#39;</span><span class="p">,</span> <span class="sc">&#39;\x0&#39;</span><span class="p">,</span> <span class="sc">&#39;\x3&#39;</span><span class="p">,</span> <span class="sc">&#39;\x0&#39;</span><span class="p">,</span> <span class="sc">&#39;K&#39;</span><span class="p">,</span>
  <span class="sc">&#39;\xBB&#39;</span><span class="p">,</span> <span class="sc">&#39;\xF8&#39;</span><span class="p">,</span> <span class="sc">&#39;\xD6&#39;</span><span class="p">,</span> <span class="sc">&#39;\x2A&#39;</span><span class="p">,</span> <span class="sc">&#39;v&#39;</span><span class="p">,</span> <span class="sc">&#39;\x98&#39;</span><span class="p">,</span> <span class="sc">&#39;I&#39;</span><span class="p">,</span> <span class="sc">&#39;\x0&#39;</span><span class="p">,</span>
  <span class="sc">&#39;\x0&#39;</span><span class="p">,</span> <span class="sc">&#39;\x0&#39;</span><span class="p">,</span> <span class="sc">&#39;\x0&#39;</span><span class="p">,</span> <span class="sc">&#39;I&#39;</span><span class="p">,</span> <span class="sc">&#39;E&#39;</span><span class="p">,</span> <span class="sc">&#39;N&#39;</span><span class="p">,</span> <span class="sc">&#39;D&#39;</span><span class="p">,</span> <span class="sc">&#39;\xAE&#39;</span><span class="p">,</span>
  <span class="sc">&#39;B&#39;</span><span class="p">,</span> <span class="sc">&#39;\x60&#39;</span><span class="p">,</span> <span class="sc">&#39;\x82&#39;</span><span class="p">,</span>
<span class="p">};</span>
</code></pre></td></tr></table>
</div>
</div>
<h2 id="41-muduo-inspect库源码分析">[41] muduo_inspect库源码分析</h2>

<ul>
<li>muduo_inspect库通过HTTP方式为服务器提供监控接口</li>
<li>接受了多少个TCP连接</li>
<li>当前有多少个活动连接</li>
<li>一共响应了多少次请求</li>

<li><p>每次请求的平均响应时间多少毫秒</p></li>

<li><p>Inspector     // 包含了一个HttpServer对象</p></li>

<li><p>ProcessInspector // 通过ProcessInfo返回进程信息</p></li>

<li><p>ProcessInfo // 获取进程相关信息</p></li>
</ul>

<h3 id="processinspectort头文件">ProcessInspectort头文件</h3>

<p>ProcessInspector.h</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-c++" data-lang="c++"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c++" data-lang="c++"><span class="c1">// Copyright 2010, Shuo Chen.  All rights reserved.
</span><span class="c1">// http://code.google.com/p/muduo/
</span><span class="c1">//
</span><span class="c1">// Use of this source code is governed by a BSD-style license
</span><span class="c1">// that can be found in the License file.
</span><span class="c1"></span> 
<span class="c1">// Author: Shuo Chen (chenshuo at chenshuo dot com)
</span><span class="c1">//
</span><span class="c1">// This is an internal header file, you should not include this.
</span><span class="c1"></span> 
<span class="cp">#ifndef MUDUO_NET_INSPECT_PROCESSINSPECTOR_H
</span><span class="cp">#define MUDUO_NET_INSPECT_PROCESSINSPECTOR_H
</span><span class="cp"></span> 
<span class="cp">#include</span> <span class="cpf">&lt;muduo/net/inspect/Inspector.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;boost/noncopyable.hpp&gt;</span><span class="cp">
</span><span class="cp"></span> 
<span class="k">namespace</span> <span class="n">muduo</span>
<span class="p">{</span>
<span class="k">namespace</span> <span class="n">net</span>
<span class="p">{</span>
 
<span class="k">class</span><span class="err"> </span><span class="nc">ProcessInspector</span> <span class="o">:</span> <span class="n">boost</span><span class="o">::</span><span class="n">noncopyable</span>
<span class="p">{</span>
 <span class="k">public</span><span class="o">:</span>
  <span class="kt">void</span> <span class="n">registerCommands</span><span class="p">(</span><span class="n">Inspector</span><span class="o">*</span> <span class="n">ins</span><span class="p">);</span>    <span class="c1">// 注册命令接口
</span><span class="c1"></span> 
 <span class="k">private</span><span class="o">:</span>
  <span class="k">static</span> <span class="n">string</span> <span class="n">pid</span><span class="p">(</span><span class="n">HttpRequest</span><span class="o">::</span><span class="n">Method</span><span class="p">,</span> <span class="k">const</span> <span class="n">Inspector</span><span class="o">::</span><span class="n">ArgList</span><span class="o">&amp;</span><span class="p">);</span>
  <span class="k">static</span> <span class="n">string</span> <span class="nf">procStatus</span><span class="p">(</span><span class="n">HttpRequest</span><span class="o">::</span><span class="n">Method</span><span class="p">,</span> <span class="k">const</span> <span class="n">Inspector</span><span class="o">::</span><span class="n">ArgList</span><span class="o">&amp;</span><span class="p">);</span>
  <span class="k">static</span> <span class="n">string</span> <span class="nf">openedFiles</span><span class="p">(</span><span class="n">HttpRequest</span><span class="o">::</span><span class="n">Method</span><span class="p">,</span> <span class="k">const</span> <span class="n">Inspector</span><span class="o">::</span><span class="n">ArgList</span><span class="o">&amp;</span><span class="p">);</span>
  <span class="k">static</span> <span class="n">string</span> <span class="nf">threads</span><span class="p">(</span><span class="n">HttpRequest</span><span class="o">::</span><span class="n">Method</span><span class="p">,</span> <span class="k">const</span> <span class="n">Inspector</span><span class="o">::</span><span class="n">ArgList</span><span class="o">&amp;</span><span class="p">);</span>
 
<span class="p">};</span>
 
<span class="p">}</span>
<span class="p">}</span>
 
<span class="cp">#endif  </span><span class="c1">// MUDUO_NET_INSPECT_PROCESSINSPECTOR_H
</span></code></pre></td></tr></table>
</div>
</div>
<h3 id="processinspectort源文件">ProcessInspectort源文件</h3>

<p>ProcessInspector.cc</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span></pre></td>
<td class="lntd">
<pre class="chroma">// Copyright 2010, Shuo Chen.  All rights reserved.
// http://code.google.com/p/muduo/
//
// Use of this source code is governed by a BSD-style license
// that can be found in the License file.
 
// Author: Shuo Chen (chenshuo at chenshuo dot com)
//
 
#include &lt;muduo/net/inspect/ProcessInspector.h&gt;
#include &lt;muduo/base/ProcessInfo.h&gt;
#include &lt;stdio.h&gt;
 
using namespace muduo;
using namespace muduo::net;
 
/*命令注册*/
void ProcessInspector::registerCommands(Inspector* ins)
{
  /*muduo             :   proc
    command           :   pid
    commandCallback   :   pid
    commnadHelp       :   print id
  */
  ins-&gt;add(&#34;proc&#34;, &#34;pid&#34;, ProcessInspector::pid, &#34;print pid&#34;);
  ins-&gt;add(&#34;proc&#34;, &#34;status&#34;, ProcessInspector::procStatus, &#34;print /proc/self/status&#34;);
  ins-&gt;add(&#34;proc&#34;, &#34;opened_files&#34;, ProcessInspector::openedFiles, &#34;count /proc/self/fd&#34;);
  ins-&gt;add(&#34;proc&#34;, &#34;threads&#34;, ProcessInspector::threads, &#34;list /proc/self/task&#34;);
}
 
string ProcessInspector::pid(HttpRequest::Method, const Inspector::ArgList&amp;)
{
  char buf[32];
  snprintf(buf, sizeof buf, &#34;%d&#34;, ProcessInfo::pid());
  return buf;
}
 
string ProcessInspector::procStatus(HttpRequest::Method, const Inspector::ArgList&amp;)
{
  return ProcessInfo::procStatus();
}
 
string ProcessInspector::openedFiles(HttpRequest::Method, const Inspector::ArgList&amp;)
{
  char buf[32];
  snprintf(buf, sizeof buf, &#34;%d&#34;, ProcessInfo::openedFiles());
  return buf;
}
 
string ProcessInspector::threads(HttpRequest::Method, const Inspector::ArgList&amp;)
{
  std::vector&lt;pid_t&gt; threads = ProcessInfo::threads();
  string result;
  for (size_t i = 0; i &lt; threads.size(); ++i)
  {
    char buf[32];
    snprintf(buf, sizeof buf, &#34;%d\n&#34;, threads[i]);
    result += buf;
  }
  return result;
}</pre></td></tr></table>
</div>
</div>
<h3 id="inspector头文件">Inspector头文件</h3>

<p>Inspector.h</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-c++" data-lang="c++"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c++" data-lang="c++"><span class="c1">// Copyright 2010, Shuo Chen.  All rights reserved.
</span><span class="c1">// http://code.google.com/p/muduo/
</span><span class="c1">//
</span><span class="c1">// Use of this source code is governed by a BSD-style license
</span><span class="c1">// that can be found in the License file.
</span><span class="c1"></span> 
<span class="c1">// Author: Shuo Chen (chenshuo at chenshuo dot com)
</span><span class="c1">//
</span><span class="c1">// This is a public header file, it must only include public header files.
</span><span class="c1"></span> 
<span class="cp">#ifndef MUDUO_NET_INSPECT_INSPECTOR_H
</span><span class="cp">#define MUDUO_NET_INSPECT_INSPECTOR_H
</span><span class="cp"></span> 
<span class="cp">#include</span> <span class="cpf">&lt;muduo/base/Mutex.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;muduo/net/http/HttpRequest.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;muduo/net/http/HttpServer.h&gt;</span><span class="cp">
</span><span class="cp"></span> 
<span class="cp">#include</span> <span class="cpf">&lt;map&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;boost/function.hpp&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;boost/noncopyable.hpp&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;boost/scoped_ptr.hpp&gt;</span><span class="cp">
</span><span class="cp"></span> 
<span class="k">namespace</span> <span class="n">muduo</span>
<span class="p">{</span>
<span class="k">namespace</span> <span class="n">net</span>
<span class="p">{</span>
 
<span class="k">class</span><span class="err"> </span><span class="nc">ProcessInspector</span><span class="p">;</span>
 
<span class="c1">// A internal inspector of the running process, usually a singleton.
</span><span class="c1"></span><span class="k">class</span><span class="err"> </span><span class="nc">Inspector</span> <span class="o">:</span> <span class="n">boost</span><span class="o">::</span><span class="n">noncopyable</span>
<span class="p">{</span>
 <span class="k">public</span><span class="o">:</span>
  <span class="k">typedef</span> <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">string</span><span class="o">&gt;</span> <span class="n">ArgList</span><span class="p">;</span>
  <span class="k">typedef</span> <span class="n">boost</span><span class="o">::</span><span class="n">function</span><span class="o">&lt;</span><span class="n">string</span> <span class="p">(</span><span class="n">HttpRequest</span><span class="o">::</span><span class="n">Method</span><span class="p">,</span> <span class="k">const</span> <span class="n">ArgList</span><span class="o">&amp;</span> <span class="n">args</span><span class="p">)</span><span class="o">&gt;</span> <span class="n">Callback</span><span class="p">;</span>
  <span class="n">Inspector</span><span class="p">(</span><span class="n">EventLoop</span><span class="o">*</span> <span class="n">loop</span><span class="p">,</span>
            <span class="k">const</span> <span class="n">InetAddress</span><span class="o">&amp;</span> <span class="n">httpAddr</span><span class="p">,</span>
            <span class="k">const</span> <span class="n">string</span><span class="o">&amp;</span> <span class="n">name</span><span class="p">);</span>
  <span class="o">~</span><span class="n">Inspector</span><span class="p">();</span>
 
  <span class="c1">// 如add(&#34;proc&#34;, &#34;pid&#34;, ProcessInspector::pid, &#34;print pid&#34;);
</span><span class="c1"></span>  <span class="c1">// http://192.168.159.188:12345/proc/pid这个http请求就会相应的调用ProcessInspector::pid来处理
</span><span class="c1"></span>  <span class="kt">void</span> <span class="nf">add</span><span class="p">(</span><span class="k">const</span> <span class="n">string</span><span class="o">&amp;</span> <span class="n">module</span><span class="p">,</span>
           <span class="k">const</span> <span class="n">string</span><span class="o">&amp;</span> <span class="n">command</span><span class="p">,</span>
           <span class="k">const</span> <span class="n">Callback</span><span class="o">&amp;</span> <span class="n">cb</span><span class="p">,</span>
           <span class="k">const</span> <span class="n">string</span><span class="o">&amp;</span> <span class="n">help</span><span class="p">);</span>
 
 <span class="k">private</span><span class="o">:</span>
  <span class="k">typedef</span> <span class="n">std</span><span class="o">::</span><span class="n">map</span><span class="o">&lt;</span><span class="n">string</span><span class="p">,</span> <span class="n">Callback</span><span class="o">&gt;</span> <span class="n">CommandList</span><span class="p">;</span>
  <span class="k">typedef</span> <span class="n">std</span><span class="o">::</span><span class="n">map</span><span class="o">&lt;</span><span class="n">string</span><span class="p">,</span> <span class="n">string</span><span class="o">&gt;</span> <span class="n">HelpList</span><span class="p">;</span>
 
  <span class="kt">void</span> <span class="nf">start</span><span class="p">();</span>
  <span class="kt">void</span> <span class="nf">onRequest</span><span class="p">(</span><span class="k">const</span> <span class="n">HttpRequest</span><span class="o">&amp;</span> <span class="n">req</span><span class="p">,</span> <span class="n">HttpResponse</span><span class="o">*</span> <span class="n">resp</span><span class="p">);</span>
 
  <span class="n">HttpServer</span> <span class="n">server_</span><span class="p">;</span>
  <span class="n">boost</span><span class="o">::</span><span class="n">scoped_ptr</span><span class="o">&lt;</span><span class="n">ProcessInspector</span><span class="o">&gt;</span> <span class="n">processInspector_</span><span class="p">;</span>
  <span class="n">MutexLock</span> <span class="n">mutex_</span><span class="p">;</span>
  <span class="n">std</span><span class="o">::</span><span class="n">map</span><span class="o">&lt;</span><span class="n">string</span><span class="p">,</span> <span class="n">CommandList</span><span class="o">&gt;</span> <span class="n">commands_</span><span class="p">;</span>
  <span class="n">std</span><span class="o">::</span><span class="n">map</span><span class="o">&lt;</span><span class="n">string</span><span class="p">,</span> <span class="n">HelpList</span><span class="o">&gt;</span> <span class="n">helps_</span><span class="p">;</span>
  <span class="cm">/*
</span><span class="cm">commands_ --- &gt; &lt;muduo commandlist&gt;
</span><span class="cm">helps_    ----&gt; &lt;muduo helplist&gt;
</span><span class="cm"> 
</span><span class="cm">commandlist---&gt; &lt;command callback&gt;
</span><span class="cm">HelpList  ----&gt; &lt;command helplist&gt;
</span><span class="cm"> 
</span><span class="cm">commands_[][]=xx
</span><span class="cm">helps_[][]=xxx
</span><span class="cm"> 
</span><span class="cm">  */</span>
<span class="p">};</span>
 
<span class="p">}</span>
<span class="p">}</span>
 
<span class="cp">#endif  </span><span class="c1">// MUDUO_NET_INSPECT_INSPECTOR_H
</span></code></pre></td></tr></table>
</div>
</div>
<h3 id="inspector源文件">Inspector源文件</h3>

<p>Inspector.cc</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-c++" data-lang="c++"><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span><span class="lnt">177
</span><span class="lnt">178
</span><span class="lnt">179
</span><span class="lnt">180
</span><span class="lnt">181
</span><span class="lnt">182
</span><span class="lnt">183
</span><span class="lnt">184
</span><span class="lnt">185
</span><span class="lnt">186
</span><span class="lnt">187
</span><span class="lnt">188
</span><span class="lnt">189
</span><span class="lnt">190
</span><span class="lnt">191
</span><span class="lnt">192
</span><span class="lnt">193
</span><span class="lnt">194
</span><span class="lnt">195
</span><span class="lnt">196
</span><span class="lnt">197
</span><span class="lnt">198
</span><span class="lnt">199
</span><span class="lnt">200
</span><span class="lnt">201
</span><span class="lnt">202
</span><span class="lnt">203
</span><span class="lnt">204
</span><span class="lnt">205
</span><span class="lnt">206
</span><span class="lnt">207
</span><span class="lnt">208
</span><span class="lnt">209
</span><span class="lnt">210
</span><span class="lnt">211
</span><span class="lnt">212
</span><span class="lnt">213
</span><span class="lnt">214
</span><span class="lnt">215
</span><span class="lnt">216
</span><span class="lnt">217
</span><span class="lnt">218
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c++" data-lang="c++"><span class="c1">// Copyright 2010, Shuo Chen.  All rights reserved.
</span><span class="c1">// http://code.google.com/p/muduo/
</span><span class="c1">//
</span><span class="c1">// Use of this source code is governed by a BSD-style license
</span><span class="c1">// that can be found in the License file.
</span><span class="c1"></span> 
<span class="c1">// Author: Shuo Chen (chenshuo at chenshuo dot com)
</span><span class="c1">//
</span><span class="c1"></span> 
<span class="cp">#include</span> <span class="cpf">&lt;muduo/net/inspect/Inspector.h&gt;</span><span class="cp">
</span><span class="cp"></span> 
<span class="cp">#include</span> <span class="cpf">&lt;muduo/base/Thread.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;muduo/net/EventLoop.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;muduo/net/http/HttpRequest.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;muduo/net/http/HttpResponse.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;muduo/net/inspect/ProcessInspector.h&gt;</span><span class="cp">
</span><span class="cp"></span> 
<span class="c1">//#include &lt;iostream&gt;
</span><span class="c1">//#include &lt;iterator&gt;
</span><span class="c1">//#include &lt;sstream&gt;
</span><span class="c1"></span><span class="cp">#include</span> <span class="cpf">&lt;boost/bind.hpp&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;boost/algorithm/string/classification.hpp&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;boost/algorithm/string/split.hpp&gt;</span><span class="cp">
</span><span class="cp"></span> 
<span class="k">using</span> <span class="k">namespace</span> <span class="n">muduo</span><span class="p">;</span>
<span class="k">using</span> <span class="k">namespace</span> <span class="n">muduo</span><span class="o">::</span><span class="n">net</span><span class="p">;</span>
 
<span class="k">namespace</span>
<span class="p">{</span>
<span class="n">Inspector</span><span class="o">*</span> <span class="n">g_globalInspector</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
 
<span class="c1">// Looks buggy
</span><span class="c1"></span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">string</span><span class="o">&gt;</span> <span class="n">split</span><span class="p">(</span><span class="k">const</span> <span class="n">string</span><span class="o">&amp;</span> <span class="n">str</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">string</span><span class="o">&gt;</span> <span class="n">result</span><span class="p">;</span>
  <span class="n">size_t</span> <span class="n">start</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">size_t</span> <span class="n">pos</span> <span class="o">=</span> <span class="n">str</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="sc">&#39;/&#39;</span><span class="p">);</span>
  <span class="k">while</span> <span class="p">(</span><span class="n">pos</span> <span class="o">!=</span> <span class="n">string</span><span class="o">::</span><span class="n">npos</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">pos</span> <span class="o">&gt;</span> <span class="n">start</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">result</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">str</span><span class="p">.</span><span class="n">substr</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">pos</span><span class="o">-</span><span class="n">start</span><span class="p">));</span>
    <span class="p">}</span>
    <span class="n">start</span> <span class="o">=</span> <span class="n">pos</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span>
    <span class="n">pos</span> <span class="o">=</span> <span class="n">str</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="sc">&#39;/&#39;</span><span class="p">,</span> <span class="n">start</span><span class="p">);</span>
  <span class="p">}</span>
 
  <span class="k">if</span> <span class="p">(</span><span class="n">start</span> <span class="o">&lt;</span> <span class="n">str</span><span class="p">.</span><span class="n">length</span><span class="p">())</span>      <span class="c1">// 说明最后一个字符不是&#39;/&#39;
</span><span class="c1"></span>  <span class="p">{</span>
    <span class="n">result</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">str</span><span class="p">.</span><span class="n">substr</span><span class="p">(</span><span class="n">start</span><span class="p">));</span>
  <span class="p">}</span>
 
  <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>
 
<span class="p">}</span>
 
<span class="n">Inspector</span><span class="o">::</span><span class="n">Inspector</span><span class="p">(</span><span class="n">EventLoop</span><span class="o">*</span> <span class="n">loop</span><span class="p">,</span>
                     <span class="k">const</span> <span class="n">InetAddress</span><span class="o">&amp;</span> <span class="n">httpAddr</span><span class="p">,</span>
                     <span class="k">const</span> <span class="n">string</span><span class="o">&amp;</span> <span class="n">name</span><span class="p">)</span>
    <span class="o">:</span> <span class="n">server_</span><span class="p">(</span><span class="n">loop</span><span class="p">,</span> <span class="n">httpAddr</span><span class="p">,</span> <span class="s">&#34;Inspector:&#34;</span><span class="o">+</span><span class="n">name</span><span class="p">),</span>
      <span class="n">processInspector_</span><span class="p">(</span><span class="k">new</span> <span class="n">ProcessInspector</span><span class="p">)</span>
<span class="p">{</span>
  <span class="c1">//断言在主线程当中
</span><span class="c1"></span>  <span class="n">assert</span><span class="p">(</span><span class="n">CurrentThread</span><span class="o">::</span><span class="n">isMainThread</span><span class="p">());</span>
  <span class="n">assert</span><span class="p">(</span><span class="n">g_globalInspector</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>
  <span class="n">g_globalInspector</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
  <span class="cm">/*设置请求的回调函数，这里的请求是完成了协议的解析之后*/</span>
  <span class="n">server_</span><span class="p">.</span><span class="n">setHttpCallback</span><span class="p">(</span><span class="n">boost</span><span class="o">::</span><span class="n">bind</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Inspector</span><span class="o">::</span><span class="n">onRequest</span><span class="p">,</span> <span class="k">this</span><span class="p">,</span> <span class="n">_1</span><span class="p">,</span> <span class="n">_2</span><span class="p">));</span>
  <span class="cm">/*注册命令*/</span>
  <span class="n">processInspector_</span><span class="o">-&gt;</span><span class="n">registerCommands</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
  <span class="c1">// 这样子做法是为了防止竞态问题
</span><span class="c1"></span>  <span class="c1">// 如果直接调用start，（当前线程不是loop所属的IO线程，是主线程）那么有可能，当前构造函数还没返回，
</span><span class="c1"></span>  <span class="c1">// HttpServer所在的IO线程可能已经收到了http客户端的请求了（因为这时候HttpServer已启动），那么就会回调
</span><span class="c1"></span>  <span class="c1">// Inspector::onRequest，而这时候构造函数还没返回，也就是说对象还没完全构造好。那么就会出现问题了
</span><span class="c1"></span>  <span class="n">loop</span><span class="o">-&gt;</span><span class="n">runAfter</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">boost</span><span class="o">::</span><span class="n">bind</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Inspector</span><span class="o">::</span><span class="n">start</span><span class="p">,</span> <span class="k">this</span><span class="p">));</span> <span class="c1">// little race condition
</span><span class="c1"></span><span class="p">}</span>
 
<span class="n">Inspector</span><span class="o">::~</span><span class="n">Inspector</span><span class="p">()</span>
<span class="p">{</span>
  <span class="n">assert</span><span class="p">(</span><span class="n">CurrentThread</span><span class="o">::</span><span class="n">isMainThread</span><span class="p">());</span>
  <span class="n">g_globalInspector</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>
 
<span class="kt">void</span> <span class="n">Inspector</span><span class="o">::</span><span class="n">add</span><span class="p">(</span><span class="k">const</span> <span class="n">string</span><span class="o">&amp;</span> <span class="n">module</span><span class="p">,</span>
                    <span class="k">const</span> <span class="n">string</span><span class="o">&amp;</span> <span class="n">command</span><span class="p">,</span>
                    <span class="k">const</span> <span class="n">Callback</span><span class="o">&amp;</span> <span class="n">cb</span><span class="p">,</span>
                    <span class="k">const</span> <span class="n">string</span><span class="o">&amp;</span> <span class="n">help</span><span class="p">)</span>
<span class="p">{</span>
  <span class="cm">/*这里要不要加锁？？
</span><span class="cm">因为在构造函数时 程序是注册完 processInspector_-&gt;registerCommands(this); 才执行
</span><span class="cm">loop-&gt;runAfter(0, boost::bind(&amp;Inspector::start, this)); // little race condition。
</span><span class="cm"> 
</span><span class="cm">如果程序进行扩充时，就要了。
</span><span class="cm">class TcpInspector : boost::noncopyable
</span><span class="cm">{
</span><span class="cm"> public:
</span><span class="cm">  void registerCommands(Inspector* ins);  // 注册命令接口
</span><span class="cm"> 
</span><span class="cm"> private:
</span><span class="cm">  static string pid(HttpRequest::Method, const Inspector::ArgList&amp;);
</span><span class="cm">  static string procStatus(HttpRequest::Method, const Inspector::ArgList&amp;);
</span><span class="cm">  static string openedFiles(HttpRequest::Method, const Inspector::ArgList&amp;);
</span><span class="cm">  static string threads(HttpRequest::Method, const Inspector::ArgList&amp;);
</span><span class="cm"> 
</span><span class="cm">};
</span><span class="cm"> 
</span><span class="cm">MyInspector ：public ProcessInspector
</span><span class="cm">{
</span><span class="cm">   TcpInspector
</span><span class="cm">} ;
</span><span class="cm">那么
</span><span class="cm">MyInspector{
</span><span class="cm"> 
</span><span class="cm">  HttpServer server_;
</span><span class="cm">  boost::scoped_ptr&lt;ProcessInspector&gt; processInspector;
</span><span class="cm">  boost::scoped_ptr&lt;ProcessInspector&gt; TcpInspector;
</span><span class="cm">  MutexLock mutex_;
</span><span class="cm">  std::map&lt;string, CommandList&gt; commands_;
</span><span class="cm">  std::map&lt;string, HelpList&gt; helps_;
</span><span class="cm">}
</span><span class="cm">那么MyInspector 在初始化时，会初始化ProcessInspector 和TcpInspector，
</span><span class="cm">如果ProcessInspector初始化完毕后，启动了OnreRequest(),而TcpInspector还没注册完，
</span><span class="cm">也就是说TcpInspector还在add（）函数中，那么不加锁的话，就会出现问题了。
</span><span class="cm">  */</span>
  <span class="n">MutexLockGuard</span> <span class="n">lock</span><span class="p">(</span><span class="n">mutex_</span><span class="p">);</span>
  <span class="n">commands_</span><span class="p">[</span><span class="n">module</span><span class="p">][</span><span class="n">command</span><span class="p">]</span> <span class="o">=</span> <span class="n">cb</span><span class="p">;</span>
  <span class="n">helps_</span><span class="p">[</span><span class="n">module</span><span class="p">][</span><span class="n">command</span><span class="p">]</span> <span class="o">=</span> <span class="n">help</span><span class="p">;</span>
<span class="p">}</span>
 
<span class="kt">void</span> <span class="n">Inspector</span><span class="o">::</span><span class="n">start</span><span class="p">()</span>
<span class="p">{</span>
  <span class="n">server_</span><span class="p">.</span><span class="n">start</span><span class="p">();</span>
<span class="p">}</span>
 
<span class="kt">void</span> <span class="n">Inspector</span><span class="o">::</span><span class="n">onRequest</span><span class="p">(</span><span class="k">const</span> <span class="n">HttpRequest</span><span class="o">&amp;</span> <span class="n">req</span><span class="p">,</span> <span class="n">HttpResponse</span><span class="o">*</span> <span class="n">resp</span><span class="p">)</span>
<span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="p">.</span><span class="n">path</span><span class="p">()</span> <span class="o">==</span> <span class="s">&#34;/&#34;</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">string</span> <span class="n">result</span><span class="p">;</span>
    <span class="n">MutexLockGuard</span> <span class="nf">lock</span><span class="p">(</span><span class="n">mutex_</span><span class="p">);</span>
    <span class="c1">// 遍历helps
</span><span class="c1"></span>    <span class="k">for</span> <span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">map</span><span class="o">&lt;</span><span class="n">string</span><span class="p">,</span> <span class="n">HelpList</span><span class="o">&gt;::</span><span class="n">const_iterator</span> <span class="n">helpListI</span> <span class="o">=</span> <span class="n">helps_</span><span class="p">.</span><span class="n">begin</span><span class="p">();</span>
         <span class="n">helpListI</span> <span class="o">!=</span> <span class="n">helps_</span><span class="p">.</span><span class="n">end</span><span class="p">();</span>
         <span class="o">++</span><span class="n">helpListI</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="k">const</span> <span class="n">HelpList</span><span class="o">&amp;</span> <span class="n">list</span> <span class="o">=</span> <span class="n">helpListI</span><span class="o">-&gt;</span><span class="n">second</span><span class="p">;</span>
      <span class="k">for</span> <span class="p">(</span><span class="n">HelpList</span><span class="o">::</span><span class="n">const_iterator</span> <span class="n">it</span> <span class="o">=</span> <span class="n">list</span><span class="p">.</span><span class="n">begin</span><span class="p">();</span>
           <span class="n">it</span> <span class="o">!=</span> <span class="n">list</span><span class="p">.</span><span class="n">end</span><span class="p">();</span>
           <span class="o">++</span><span class="n">it</span><span class="p">)</span>
      <span class="p">{</span>
        <span class="n">result</span> <span class="o">+=</span> <span class="s">&#34;/&#34;</span><span class="p">;</span>
        <span class="n">result</span> <span class="o">+=</span> <span class="n">helpListI</span><span class="o">-&gt;</span><span class="n">first</span><span class="p">;</span>      <span class="c1">// module
</span><span class="c1"></span>        <span class="n">result</span> <span class="o">+=</span> <span class="s">&#34;/&#34;</span><span class="p">;</span>
        <span class="n">result</span> <span class="o">+=</span> <span class="n">it</span><span class="o">-&gt;</span><span class="n">first</span><span class="p">;</span>         <span class="c1">// command
</span><span class="c1"></span>        <span class="n">result</span> <span class="o">+=</span> <span class="s">&#34;</span><span class="se">\t</span><span class="s">&#34;</span><span class="p">;</span>
        <span class="n">result</span> <span class="o">+=</span> <span class="n">it</span><span class="o">-&gt;</span><span class="n">second</span><span class="p">;</span>            <span class="c1">// help
</span><span class="c1"></span>        <span class="n">result</span> <span class="o">+=</span> <span class="s">&#34;</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="n">resp</span><span class="o">-&gt;</span><span class="n">setStatusCode</span><span class="p">(</span><span class="n">HttpResponse</span><span class="o">::</span><span class="n">k200Ok</span><span class="p">);</span>
    <span class="n">resp</span><span class="o">-&gt;</span><span class="n">setStatusMessage</span><span class="p">(</span><span class="s">&#34;OK&#34;</span><span class="p">);</span>
    <span class="n">resp</span><span class="o">-&gt;</span><span class="n">setContentType</span><span class="p">(</span><span class="s">&#34;text/plain&#34;</span><span class="p">);</span>
    <span class="n">resp</span><span class="o">-&gt;</span><span class="n">setBody</span><span class="p">(</span><span class="n">result</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">else</span>
  <span class="p">{</span>
    <span class="c1">// 以&#34;/&#34;进行分割，将得到的字符串保存在result中
</span><span class="c1"></span>    <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">string</span><span class="o">&gt;</span> <span class="n">result</span> <span class="o">=</span> <span class="n">split</span><span class="p">(</span><span class="n">req</span><span class="p">.</span><span class="n">path</span><span class="p">());</span>
    <span class="c1">// boost::split(result, req.path(), boost::is_any_of(&#34;/&#34;));
</span><span class="c1"></span>    <span class="c1">//std::copy(result.begin(), result.end(), std::ostream_iterator&lt;string&gt;(std::cout, &#34;, &#34;));
</span><span class="c1"></span>    <span class="c1">//std::cout &lt;&lt; &#34;\n&#34;;
</span><span class="c1"></span>    <span class="kt">bool</span> <span class="n">ok</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="c1">// 这种情况是错误的，因此ok仍为false
</span><span class="c1"></span>    <span class="p">}</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="c1">// 只有module，没有command也是错的，因此ok仍为false
</span><span class="c1"></span>      <span class="n">string</span> <span class="n">module</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
    <span class="p">}</span>
    <span class="k">else</span>
    <span class="p">{</span>
      <span class="n">string</span> <span class="n">module</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
      <span class="c1">// 查找module所对应的命令列表
</span><span class="c1"></span>      <span class="n">std</span><span class="o">::</span><span class="n">map</span><span class="o">&lt;</span><span class="n">string</span><span class="p">,</span> <span class="n">CommandList</span><span class="o">&gt;::</span><span class="n">const_iterator</span> <span class="n">commListI</span> <span class="o">=</span> <span class="n">commands_</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="n">module</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">commListI</span> <span class="o">!=</span> <span class="n">commands_</span><span class="p">.</span><span class="n">end</span><span class="p">())</span>
      <span class="p">{</span>
        <span class="n">string</span> <span class="n">command</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
        <span class="k">const</span> <span class="n">CommandList</span><span class="o">&amp;</span> <span class="n">commList</span> <span class="o">=</span> <span class="n">commListI</span><span class="o">-&gt;</span><span class="n">second</span><span class="p">;</span>
        <span class="c1">// 查找command对应的命令
</span><span class="c1"></span>        <span class="n">CommandList</span><span class="o">::</span><span class="n">const_iterator</span> <span class="n">it</span> <span class="o">=</span> <span class="n">commList</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="n">command</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">it</span> <span class="o">!=</span> <span class="n">commList</span><span class="p">.</span><span class="n">end</span><span class="p">())</span>
        <span class="p">{</span>
          <span class="n">ArgList</span> <span class="n">args</span><span class="p">(</span><span class="n">result</span><span class="p">.</span><span class="n">begin</span><span class="p">()</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span> <span class="n">result</span><span class="p">.</span><span class="n">end</span><span class="p">());</span>     <span class="c1">// 传递给回调函数的参数表
</span><span class="c1"></span>          <span class="k">if</span> <span class="p">(</span><span class="n">it</span><span class="o">-&gt;</span><span class="n">second</span><span class="p">)</span>
          <span class="p">{</span>
            <span class="n">resp</span><span class="o">-&gt;</span><span class="n">setStatusCode</span><span class="p">(</span><span class="n">HttpResponse</span><span class="o">::</span><span class="n">k200Ok</span><span class="p">);</span>
            <span class="n">resp</span><span class="o">-&gt;</span><span class="n">setStatusMessage</span><span class="p">(</span><span class="s">&#34;OK&#34;</span><span class="p">);</span>
            <span class="n">resp</span><span class="o">-&gt;</span><span class="n">setContentType</span><span class="p">(</span><span class="s">&#34;text/plain&#34;</span><span class="p">);</span>
            <span class="k">const</span> <span class="n">Callback</span><span class="o">&amp;</span> <span class="n">cb</span> <span class="o">=</span> <span class="n">it</span><span class="o">-&gt;</span><span class="n">second</span><span class="p">;</span>
            <span class="n">resp</span><span class="o">-&gt;</span><span class="n">setBody</span><span class="p">(</span><span class="n">cb</span><span class="p">(</span><span class="n">req</span><span class="p">.</span><span class="n">method</span><span class="p">(),</span> <span class="n">args</span><span class="p">));</span>       <span class="c1">// 调用cb将返回的字符串传给setBody
</span><span class="c1"></span>            <span class="n">ok</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
          <span class="p">}</span>
        <span class="p">}</span>
      <span class="p">}</span>
 
    <span class="p">}</span>
 
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ok</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">resp</span><span class="o">-&gt;</span><span class="n">setStatusCode</span><span class="p">(</span><span class="n">HttpResponse</span><span class="o">::</span><span class="n">k404NotFound</span><span class="p">);</span>
      <span class="n">resp</span><span class="o">-&gt;</span><span class="n">setStatusMessage</span><span class="p">(</span><span class="s">&#34;Not Found&#34;</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="c1">//resp-&gt;setCloseConnection(true);
</span><span class="c1"></span>  <span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div>
<p>测试程序</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-c++" data-lang="c++"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c++" data-lang="c++"><span class="cp">#include</span> <span class="cpf">&lt;muduo/net/inspect/Inspector.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;muduo/net/EventLoop.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;muduo/net/EventLoopThread.h&gt;</span><span class="cp">
</span><span class="cp"></span> 
<span class="k">using</span> <span class="k">namespace</span> <span class="n">muduo</span><span class="p">;</span>
<span class="k">using</span> <span class="k">namespace</span> <span class="n">muduo</span><span class="o">::</span><span class="n">net</span><span class="p">;</span>
 
<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>
<span class="p">{</span>
  <span class="n">EventLoop</span> <span class="n">loop</span><span class="p">;</span>
  <span class="n">EventLoopThread</span> <span class="n">t</span><span class="p">;</span>    <span class="c1">// 监控线程 ，这里“线程该没有真正创建，t.startLoop（）函数才是真正创建”
</span><span class="c1"></span>  <span class="cm">/*Inspector 的loop 和main thread 的loop是不一样的，也就是说，现在已经有两个loop了*/</span>
  <span class="n">Inspector</span> <span class="n">ins</span><span class="p">(</span><span class="n">t</span><span class="p">.</span><span class="n">startLoop</span><span class="p">(),</span> <span class="n">InetAddress</span><span class="p">(</span><span class="mi">12345</span><span class="p">),</span> <span class="s">&#34;test&#34;</span><span class="p">);</span>
  <span class="n">loop</span><span class="p">.</span><span class="n">loop</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div>
<p>在浏览器中输入127.0.0.1:12345/proc/status</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-c++" data-lang="c++"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c++" data-lang="c++"><span class="nl">Name</span><span class="p">:</span>   <span class="n">inspector_test</span>
<span class="nl">State</span><span class="p">:</span>  <span class="n">S</span> <span class="p">(</span><span class="n">sleeping</span><span class="p">)</span>
<span class="nl">Tgid</span><span class="p">:</span>   <span class="mi">2030</span>
<span class="nl">Pid</span><span class="p">:</span>    <span class="mi">2030</span>
<span class="nl">PPid</span><span class="p">:</span>   <span class="mi">1907</span>
<span class="nl">TracerPid</span><span class="p">:</span>  <span class="mi">0</span>
<span class="nl">Uid</span><span class="p">:</span>    <span class="mi">1000</span>    <span class="mi">1000</span>    <span class="mi">1000</span>    <span class="mi">1000</span>
<span class="nl">Gid</span><span class="p">:</span>    <span class="mi">1000</span>    <span class="mi">1000</span>    <span class="mi">1000</span>    <span class="mi">1000</span>
<span class="nl">FDSize</span><span class="p">:</span> <span class="mi">256</span>
<span class="nl">Groups</span><span class="p">:</span> <span class="mi">4</span> <span class="mi">20</span> <span class="mi">24</span> <span class="mi">46</span> <span class="mi">116</span> <span class="mi">118</span> <span class="mi">124</span> <span class="mi">1000</span>
<span class="nl">VmPeak</span><span class="p">:</span>    <span class="mi">12348</span> <span class="n">kB</span>
<span class="nl">VmSize</span><span class="p">:</span>    <span class="mi">12348</span> <span class="n">kB</span>
<span class="nl">VmLck</span><span class="p">:</span>         <span class="mi">0</span> <span class="n">kB</span>
<span class="nl">VmHWM</span><span class="p">:</span>      <span class="mi">1580</span> <span class="n">kB</span>
<span class="nl">VmRSS</span><span class="p">:</span>      <span class="mi">1580</span> <span class="n">kB</span>
<span class="nl">VmData</span><span class="p">:</span>     <span class="mi">8408</span> <span class="n">kB</span>
<span class="nl">VmStk</span><span class="p">:</span>       <span class="mi">136</span> <span class="n">kB</span>
<span class="nl">VmExe</span><span class="p">:</span>       <span class="mi">860</span> <span class="n">kB</span>
<span class="nl">VmLib</span><span class="p">:</span>      <span class="mi">2868</span> <span class="n">kB</span>
<span class="nl">VmPTE</span><span class="p">:</span>        <span class="mi">32</span> <span class="n">kB</span>
<span class="nl">VmSwap</span><span class="p">:</span>        <span class="mi">0</span> <span class="n">kB</span>
<span class="nl">Threads</span><span class="p">:</span>    <span class="mi">2</span>
<span class="nl">SigQ</span><span class="p">:</span>   <span class="mi">0</span><span class="o">/</span><span class="mi">9772</span>
<span class="nl">SigPnd</span><span class="p">:</span> <span class="mo">0000000000000000</span>
<span class="nl">ShdPnd</span><span class="p">:</span> <span class="mo">0000000000000000</span>
<span class="nl">SigBlk</span><span class="p">:</span> <span class="mo">0000000000000000</span>
<span class="nl">SigIgn</span><span class="p">:</span> <span class="mo">0000000000001000</span>
<span class="nl">SigCgt</span><span class="p">:</span> <span class="mo">00000001</span><span class="mi">80000000</span>
<span class="nl">CapInh</span><span class="p">:</span> <span class="mo">0000000000000000</span>
<span class="nl">CapPrm</span><span class="p">:</span> <span class="mo">0000000000000000</span>
<span class="nl">CapEff</span><span class="p">:</span> <span class="mo">0000000000000000</span>
<span class="nl">CapBnd</span><span class="p">:</span> <span class="n">ffffffffffffffff</span>
<span class="nl">Cpus_allowed</span><span class="p">:</span>   <span class="mi">3</span>
<span class="nl">Cpus_allowed_list</span><span class="p">:</span>  <span class="mi">0</span><span class="o">-</span><span class="mi">1</span>
<span class="nl">Mems_allowed</span><span class="p">:</span>   <span class="mi">1</span>
<span class="nl">Mems_allowed_list</span><span class="p">:</span>  <span class="mi">0</span>
<span class="nl">voluntary_ctxt_switches</span><span class="p">:</span>    <span class="mi">22</span>
<span class="nl">nonvoluntary_ctxt_switches</span><span class="p">:</span> <span class="mi">14</span>
</code></pre></td></tr></table>
</div>
</div>
    </div>

    <div class="post-copyright">
  <p class="copyright-item">
    <span class="item-title">Author</span>
    <span class="item-content">Rg</span>
  </p>
  <p class="copyright-item">
    <span class="item-title">LastMod</span>
    <span class="item-content">
        2015-07-01
        
    </span>
  </p>
  
  <p class="copyright-item">
    <span class="item-title">License</span>
    <span class="item-content">本文采用<a rel="license" href="http://creativecommons.org/licenses/by-nc/4.0/" target="_blank">知识共享署名-非商业性使用 4.0 国际许可协议</a>进行许可</span>
  </p>
</div>
<div class="post-reward">
  <input type="checkbox" name="reward" id="reward" hidden />
  <label class="reward-button" for="reward">Reward</label>
  <div class="qr-code">
    
    <label class="qr-code-image" for="reward">
        <img class="image" src="https://ws2.sinaimg.cn/large/006tNc79gy1g1r15n5iquj30u014qgqe.jpg">
        <span>wechat</span>
      </label>
    
  </div>
</div><footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/muduo/">muduo</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/2016/03/13/udon-riak-core/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">udon_riak_core</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        <a class="next" href="/2015/07/01/muduo-net-library-chapter-2/">
            <span class="next-text nav-default">muduo net library chapter 2</span>
            <span class="next-text nav-mobile">Next</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        <div id="gitalk-container"></div>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js" crossorigin="anonymous"></script>
    <script type="text/javascript">
      var gitalk = new Gitalk({
        id: '2015-07-01 00:24:59 \x2b0000 UTC',
        title: 'muduo net library chapter 3',
        clientID: '88e50f263d090b13460f',
        clientSecret: 'f1007eb6cff0af3b461be3a4b73d808ab7058a21',
        repo: 'blog',
        owner: 'laohanlinux',
        admin: ['laohanlinux'],
        body: decodeURI(location.href)
      });
      gitalk.render('gitalk-container');
    </script>
    <noscript>Please enable JavaScript to view the <a href="https://github.com/gitalk/gitalk">comments powered by gitalk.</a></noscript>

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
      <a href="mailto:daimaldd@email.com" class="iconfont icon-email" title="email"></a>
      <a href="https://github.com/laohanlinux" class="iconfont icon-github" title="github"></a>
  <a href="https://laohanlinux.github.io/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2015 - 
    2019
    <span class="heart">
      <i class="iconfont icon-heart"></i>
    </span>
    <span class="author">Rg</span>
  </span>
</div>
    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script>
<script type="text/javascript" src="/dist/even.26188efa.min.js"></script>








</body>
</html>
