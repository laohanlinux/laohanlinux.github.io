<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>muduo_base_library_2 - Welcome to Rg Home</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<meta name="author" content="Rg" /><meta name="description" content="muduo 是一个linux 网络库，使用poll和epoll模式。 这些内容是本人在大学的时候，通过  &lt;&lt; c&#43;&#43;教程网 &gt;&gt;  所学的知识笔记. 已经过去好几年了，版本也是比较老的了，属于入门级别的教程； 如有错误，纯属正常!!!" /><meta name="keywords" content="Rg, Rust, even" />






<meta name="generator" content="Hugo 0.54.0 with even 4.0.0" />


<link rel="canonical" href="https://laohanlinux.github.io/2013/06/10/muduo-base-library-2/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">


<link href="/dist/even.c2a46f00.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">


<meta property="og:title" content="muduo_base_library_2" />
<meta property="og:description" content="muduo 是一个linux 网络库，使用poll和epoll模式。 这些内容是本人在大学的时候，通过  &lt;&lt; c&#43;&#43;教程网 &gt;&gt;  所学的知识笔记. 已经过去好几年了，版本也是比较老的了，属于入门级别的教程； 如有错误，纯属正常!!!" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://laohanlinux.github.io/2013/06/10/muduo-base-library-2/" />
<meta property="article:published_time" content="2013-06-10T12:43:39&#43;00:00"/>
<meta property="article:modified_time" content="2013-06-10T12:43:39&#43;00:00"/>

<meta itemprop="name" content="muduo_base_library_2">
<meta itemprop="description" content="muduo 是一个linux 网络库，使用poll和epoll模式。 这些内容是本人在大学的时候，通过  &lt;&lt; c&#43;&#43;教程网 &gt;&gt;  所学的知识笔记. 已经过去好几年了，版本也是比较老的了，属于入门级别的教程； 如有错误，纯属正常!!!">


<meta itemprop="datePublished" content="2013-06-10T12:43:39&#43;00:00" />
<meta itemprop="dateModified" content="2013-06-10T12:43:39&#43;00:00" />
<meta itemprop="wordCount" content="15317">



<meta itemprop="keywords" content="muduo,muduo base library," />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="muduo_base_library_2"/>
<meta name="twitter:description" content="muduo 是一个linux 网络库，使用poll和epoll模式。 这些内容是本人在大学的时候，通过  &lt;&lt; c&#43;&#43;教程网 &gt;&gt;  所学的知识笔记. 已经过去好几年了，版本也是比较老的了，属于入门级别的教程； 如有错误，纯属正常!!!"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">Welcome come to Rg Home</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">cd ~/</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a>
  </ul>
</nav>
  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">Welcome come to Rg Home</a>
</div>

<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">cd ~/</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li>
  </ul>
</nav>
    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">muduo_base_library_2</h1>

      <div class="post-meta">
        <span class="post-time"> 2013-06-10 </span>
        <div class="post-category">
            <a href="/categories/muduo/"> muduo </a>
            <a href="/categories/network-program/"> network program </a>
            </div>
          <span class="more-meta"> 15317 words </span>
          <span class="more-meta"> 31 mins read </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Contents</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
<ul>
<li>
<ul>
<li><a href="#1-timestamp">[1] Timestamp</a></li>
<li><a href="#11-gcc-原子操作">[11] gcc 原子操作</a></li>
<li><a href="#12-exception类实现">[12] Exception类实现</a></li>
<li><a href="#13-muduo-之线程">[13] muduo 之线程</a>
<ul>
<li><a href="#线程标识符">线程标识符</a></li>
<li><a href="#muduo库的thread类图">muduo库的Thread类图</a></li>
<li><a href="#pthread-atfork">pthread_atfork</a></li>
</ul></li>
<li><a href="#13-1-module之线程">[13-1] module之线程</a></li>
<li><a href="#14-ipc组件的分装之互斥锁">[14] IPC组件的分装之互斥锁</a>
<ul>
<li><a href="#mutexlock-的封装">MutexLock 的封装</a></li>
<li><a href="#mutexlockguard">MutexLockGuard</a></li>
<li><a href="#mutexlockguard-1">MutexLockGuard</a></li>
<li><a href="#mutexlock-和-mutexlockguard的源代码">MutexLock 和 MutexLockGuard的源代码</a></li>
</ul></li>
<li><a href="#15-blockingqueue">[15] BlockingQueue</a>
<ul>
<li><a href="#blockingqueue类图">BlockingQueue类图</a></li>
<li><a href="#blockingqueue的源文件">BlockingQueue的源文件:</a></li>
<li><a href="#blockingqueue的测试程序1">BlockingQueue的测试程序1:</a></li>
<li><a href="#blockingqueue的测试程序2">BlockingQueue的测试程序2:</a></li>
</ul></li>
<li><a href="#15-1-boundedblockingqueue">[15-1] BoundedBlockingQueue</a>
<ul>
<li><a href="#boundedblockingqueue的类图">BoundedBlockingQueue的类图</a></li>
<li><a href="#boudedblockingqueue的源代码">BoudedBlockingQueue的源代码</a></li>
<li><a href="#测试程序">测试程序</a></li>
</ul></li>
<li><a href="#16-threadpool">[16] ThreadPool</a>
<ul>
<li><a href="#threadpool类图">threadPool类图</a></li>
<li><a href="#threadpool头文件">ThreadPool头文件</a></li>
<li><a href="#threadpool的源文件">ThreadPool的源文件</a></li>
<li><a href="#threadpool的测试程序">ThreadPool的测试程序</a></li>
</ul></li>
<li><a href="#17-singleton">[17] Singleton</a>
<ul>
<li><a href="#singleton-class-uml">Singleton class uml</a></li>
<li><a href="#singleton源代码">Singleton源代码</a></li>
<li><a href="#测试程序-1">测试程序</a></li>
<li><a href="#程序输出">程序输出</a></li>
</ul></li>
<li><a href="#18-threadlocal">[18] ThreadLocal</a>
<ul>
<li><a href="#threadlocal-的源代码">ThreadLocal 的源代码</a></li>
<li><a href="#threadlocal-的测试程序">ThreadLocal 的测试程序</a></li>
<li><a href="#程序输出-1">程序输出</a></li>
</ul></li>
<li><a href="#19-threadlocalsingle">[19] ThreadLocalSingle</a>
<ul>
<li><a href="#threadlocalsingle-class-uml">ThreadLocalSingle class UML</a></li>
<li><a href="#源程序">源程序</a></li>
<li><a href="#测试程序-2">测试程序</a></li>
<li><a href="#程序输出-2">程序输出</a></li>
</ul></li>
<li><a href="#20-logger-1">[20] Logger-1</a>
<ul>
<li><a href="#日志流程">日志流程</a></li>
<li><a href="#测试程序1">测试程序1</a></li>
<li><a href="#程序输出-3">程序输出</a></li>
<li><a href="#测试程序2">测试程序2</a></li>
<li><a href="#程序输出-4">程序输出</a></li>
<li><a href="#测试程序3">测试程序3</a></li>
</ul></li>
<li><a href="#21-logger-2">[21] Logger-2</a>
<ul>
<li><a href="#logstream类图">LogStream类图</a></li>
<li><a href="#fixedbuffer类图">FixedBuffer类图</a></li>
<li><a href="#logger类图">Logger类图</a></li>
<li><a href="#impl类图">Impl类图</a></li>
<li><a href="#logstream的测试程序1">LogStream的测试程序1</a></li>
</ul></li>
<li><a href="#21-traits-技术">[21] traits 技术</a></li>
<li><a href="#22-logfile">[22] LogFile</a>
<ul>
<li><a href="#logger-类图">Logger 类图</a></li>
<li><a href="#file类图">File类图</a></li>
<li><a href="#logfile头文件-logfile-h">LogFile头文件(logfile.h)</a></li>
<li><a href="#logfile的源文件">LogFile的源文件</a></li>
<li><a href="#logfile测试类-logfile-test-cc">LogFile测试类 LogFile_Test.cc</a></li>
<li><a href="#程序输出-5">程序输出</a></li>
</ul></li>
</ul></li>
</ul>
</nav>
  </div>
</div>
    <div class="post-content">
      

<h2 id="1-timestamp">[1] Timestamp</h2>

<p>计算机从<code>1970-01-01</code>开始时间计算 ， 但目前的经过的时间秒 假设等于<code>microSecondsSinceEpoch_</code> ， 把<code>microSecondsSinceEpoch_</code>转为<code>time_t</code>（大整数），在有<code>time_t</code></p>

<p>转为<code>tm</code>就可得到准确的时间格式</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-c++" data-lang="c++"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c++" data-lang="c++"><span class="k">struct</span> <span class="n">tm</span> <span class="p">{</span>
	<span class="kt">int</span> <span class="n">tm_sec</span><span class="p">;</span> <span class="cm">/* 秒–取值区间为[0,59] */</span>

	<span class="kt">int</span> <span class="n">tm_min</span><span class="p">;</span> <span class="cm">/* 分 - 取值区间为[0,59] */</span>

	<span class="kt">int</span> <span class="n">tm_hour</span><span class="p">;</span> <span class="cm">/* 时 - 取值区间为[0,23] */</span>

	<span class="kt">int</span> <span class="n">tm_mday</span><span class="p">;</span> <span class="cm">/* 一个月中的日期 - 取值区间为[1,31] */</span>

	<span class="kt">int</span> <span class="n">tm_mon</span><span class="p">;</span> <span class="cm">/* 月份（从一月开始，0代表一月） - 取值区间为[0,11] */</span>

	<span class="kt">int</span> <span class="n">tm_year</span><span class="p">;</span> <span class="cm">/* 年份，其值从1900开始 */</span>

	<span class="kt">int</span> <span class="n">tm_wday</span><span class="p">;</span> <span class="cm">/* 星期–取值区间为[0,6]，其中0代表星期天，1代表星期一，以此类推 */</span>

	<span class="kt">int</span> <span class="n">tm_yday</span><span class="p">;</span> <span class="cm">/* 从每年的1月1日开始的天数–取值区间为[0,365]，其中0代表1月1日，1代表1月2日，以此类推 */</span>

	<span class="kt">int</span> <span class="n">tm_isdst</span><span class="p">;</span> <span class="cm">/* 夏令时标识符，实行夏令时的时候，tm_isdst为正。不实行夏令时的进候，tm_isdst为0；不了解情况时，tm_isdst()为负。*/</span>

	<span class="kt">long</span> <span class="kt">int</span> <span class="n">tm_gmtoff</span><span class="p">;</span> <span class="cm">/*指定了日期变更线东面时区中UTC东部时区正秒数或UTC西部时区的负秒数*/</span>

	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">tm_zone</span><span class="p">;</span> <span class="cm">/*当前时区的名字(与环境变量TZ有关)*/</span>
<span class="p">};</span>
</code></pre></td></tr></table>
</div>
</div>
<p>跨平台<code>PRId64</code>的使用: <code>int64_t</code>用来表示<code>64</code>位整数，在<code>32</code>位系统中是<code>long long int</code>，在<code>64</code>位系统中是<code>long int</code>,所以打印<code>int64_t</code>的格式化方法是：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-c++" data-lang="c++"><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c++" data-lang="c++"><span class="n">printf</span><span class="p">(</span><span class="err">“</span><span class="o">%</span><span class="n">ld</span><span class="err">”</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>  <span class="c1">// 64bit OS
</span><span class="c1"></span><span class="n">printf</span><span class="p">(</span><span class="s">&#34;%lld&#34;</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span> <span class="c1">// 32bit OS
</span></code></pre></td></tr></table>
</div>
</div>
<p>跨平台的做法：</p>

<p><code>#define __STDC_FORMAT_MACROS</code>
<code>#include &lt;inttypes.h&gt;</code>
<code>#undef __STDC_FORMAT_MACROS</code>
<code>printf(&quot;%&quot; PRId64 &quot;\n&quot;, value)</code></p>

<h2 id="11-gcc-原子操作">[11] gcc 原子操作</h2>

<p>// 原子自增操作
<code>type __sync_fetch_and_add(type *ptr, type value)</code></p>

<p>// 原子比较和交换（设置）操作
<code>type __sync_val_compare_and_swap(type *ptr, type oldval type newval)</code>
<code>bool __sync_bool_compare_and_swap(type *ptr, type oldval type newval)</code></p>

<p>// 原子赋值操作
<code>type __sync_lock_test_and_set (type, type value)</code></p>

<p>无锁队列的实现： <a href="http://coolshell.cn/articles/8239.html">http://coolshell.cn/articles/8239.html</a></p>

<h2 id="12-exception类实现">[12] Exception类实现</h2>

<p>Exception 类图</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-c++" data-lang="c++"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c++" data-lang="c++"><span class="o">-</span><span class="nl">message_</span><span class="p">:</span> <span class="n">string</span>
 
<span class="o">-</span><span class="nl">stack_</span><span class="p">:</span><span class="n">string</span>
 
<span class="o">&lt;&lt;</span><span class="n">create</span><span class="o">&gt;&gt;-</span><span class="n">Exception</span><span class="p">(</span><span class="nl">what</span><span class="p">:</span><span class="kt">char</span><span class="p">)</span>
 
<span class="o">&lt;&lt;</span><span class="n">create</span><span class="o">&gt;&gt;-</span><span class="n">Exception</span><span class="p">(</span><span class="nl">what</span><span class="p">:</span><span class="n">string</span><span class="p">)</span>
 
<span class="o">&lt;&lt;</span><span class="n">destroy</span><span class="o">&gt;&gt;-</span><span class="n">Exception</span><span class="p">()</span>
 
<span class="o">+</span><span class="n">what</span><span class="p">()</span><span class="o">:</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span>
 
<span class="o">+</span><span class="n">stackTrace</span><span class="p">()</span><span class="o">:</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span>
 
<span class="o">-</span><span class="n">fillStackTrace</span> <span class="p">()</span><span class="o">:</span><span class="kt">void</span>
</code></pre></td></tr></table>
</div>
</div>
<p>下面是源代码：</p>

<p>头文件：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-c++" data-lang="c++"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c++" data-lang="c++"><span class="cp">#ifndef MUDUO_BASE_EXCEPTION_H
</span><span class="cp">#define MUDUO_BASE_EXCEPTION_H
</span><span class="cp"></span> 
<span class="cp">#include</span> <span class="cpf">&lt;muduo/base/Types.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;exception&gt;</span><span class="cp">
</span><span class="cp"></span> 
<span class="k">namespace</span> <span class="n">muduo</span>
<span class="p">{</span>
 
<span class="k">class</span><span class="err"> </span><span class="nc">Exception</span> <span class="o">:</span> <span class="k">public</span> <span class="n">std</span><span class="o">::</span><span class="n">exception</span>
<span class="p">{</span>
 <span class="k">public</span><span class="o">:</span>
  <span class="k">explicit</span> <span class="n">Exception</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">what</span><span class="p">);</span>
  <span class="k">explicit</span> <span class="nf">Exception</span><span class="p">(</span><span class="k">const</span> <span class="n">string</span><span class="o">&amp;</span> <span class="n">what</span><span class="p">);</span>
  <span class="k">virtual</span> <span class="o">~</span><span class="n">Exception</span><span class="p">()</span> <span class="k">throw</span><span class="p">();</span>
  <span class="k">virtual</span> <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="nf">what</span><span class="p">()</span> <span class="k">const</span> <span class="k">throw</span><span class="p">();</span>
  <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="nf">stackTrace</span><span class="p">()</span> <span class="k">const</span> <span class="k">throw</span><span class="p">();</span>
 
 <span class="k">private</span><span class="o">:</span>
  <span class="kt">void</span> <span class="n">fillStackTrace</span><span class="p">();</span>
 
  <span class="n">string</span> <span class="n">message_</span><span class="p">;</span>
  <span class="n">string</span> <span class="n">stack_</span><span class="p">;</span>
<span class="p">};</span>
 
<span class="p">}</span>
 
<span class="cp">#endif  </span><span class="c1">// MUDUO_BASE_EXCEPTION_
</span></code></pre></td></tr></table>
</div>
</div>
<p>源文件:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-c++" data-lang="c++"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c++" data-lang="c++"><span class="c1">// Use of this source code is governed by a BSD-style license
</span><span class="c1">// that can be found in the License file.
</span><span class="c1">//
</span><span class="c1">// Author: Shuo Chen (chenshuo at chenshuo dot com)
</span><span class="c1"></span> 
<span class="cp">#include</span> <span class="cpf">&lt;muduo/base/Exception.h&gt;</span><span class="cp">
</span><span class="cp"></span> 
<span class="c1">//#include &lt;cxxabi.h&gt;
</span><span class="c1"></span><span class="cp">#include</span> <span class="cpf">&lt;execinfo.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp">
</span><span class="cp"></span> 
<span class="k">using</span> <span class="k">namespace</span> <span class="n">muduo</span><span class="p">;</span>
 
<span class="n">Exception</span><span class="o">::</span><span class="n">Exception</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">msg</span><span class="p">)</span>
  <span class="o">:</span> <span class="n">message_</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">fillStackTrace</span><span class="p">();</span>
<span class="p">}</span>
 
<span class="n">Exception</span><span class="o">::</span><span class="n">Exception</span><span class="p">(</span><span class="k">const</span> <span class="n">string</span><span class="o">&amp;</span> <span class="n">msg</span><span class="p">)</span>
  <span class="o">:</span> <span class="n">message_</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">fillStackTrace</span><span class="p">();</span>
<span class="p">}</span>
 
<span class="n">Exception</span><span class="o">::~</span><span class="n">Exception</span><span class="p">()</span> <span class="k">throw</span> <span class="p">()</span>
<span class="p">{</span>
<span class="p">}</span>
 
<span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">Exception</span><span class="o">::</span><span class="n">what</span><span class="p">()</span> <span class="k">const</span> <span class="k">throw</span><span class="p">()</span>
<span class="p">{</span>
  <span class="k">return</span> <span class="n">message_</span><span class="p">.</span><span class="n">c_str</span><span class="p">();</span>
<span class="p">}</span>
 
<span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">Exception</span><span class="o">::</span><span class="n">stackTrace</span><span class="p">()</span> <span class="k">const</span> <span class="k">throw</span><span class="p">()</span>
<span class="p">{</span>
  <span class="k">return</span> <span class="n">stack_</span><span class="p">.</span><span class="n">c_str</span><span class="p">();</span>
<span class="p">}</span>
 
<span class="c1">//填充错误堆栈
</span><span class="c1"></span><span class="kt">void</span> <span class="n">Exception</span><span class="o">::</span><span class="n">fillStackTrace</span><span class="p">()</span>
<span class="p">{</span>
  <span class="k">const</span> <span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="mi">200</span><span class="p">;</span>
  <span class="kt">void</span><span class="o">*</span> <span class="n">buffer</span><span class="p">[</span><span class="n">len</span><span class="p">];</span>
  <span class="cm">/*
</span><span class="cm">   backtrace()  returns  a  backtrace  for the calling program, in the array pointed to by buffer.  A backtrace is the series of currently
</span><span class="cm">   active function calls for the program.  Each item in the array pointed to by buffer is of type void *, and is the return  address  from
</span><span class="cm">   the corresponding stack frame.  The size argument specifies the maximum number of addresses that can be stored in buffer.
</span><span class="cm">  */</span>
  <span class="c1">//buffer 存地就是函数的地址
</span><span class="c1"></span>  <span class="kt">int</span> <span class="n">nptrs</span> <span class="o">=</span> <span class="o">::</span><span class="n">backtrace</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
  <span class="cm">/*
</span><span class="cm">            Given  the  set  of  addresses returned by backtrace() in buffer, backtrace_symbols() translates the addresses into an array of strings
</span><span class="cm">        that describe the addresses symbolically.  The size argument specifies the number of addresses in buffer.  The symbolic  representation
</span><span class="cm">       of  each  address  consists  of  the  function name (if this can be determined), a hexadecimal offset into the function, and the actual
</span><span class="cm">       return address (in hexadecimal).  The address of the array of string pointers is returned as  the  function  result  of  backtrace_sym-
</span><span class="cm">       bols().   This  array  is malloc(3)ed by backtrace_symbols(), and must be freed by the caller.  (The strings pointed to by the array of
</span><span class="cm">       pointers need not and should not be freed.)
</span><span class="cm"> 
</span><span class="cm">Pointer--------pointer1 ------string
</span><span class="cm">--------------pointer2 ------string
</span><span class="cm">--------------pointer3 ------string
</span><span class="cm">--------------pointer4 ------string
</span><span class="cm">--------------pointer5 ------string
</span><span class="cm">--------------pointer6 ------string
</span><span class="cm"> 
</span><span class="cm">我们要释放pointer占用的内存，但是pointer所指向的内存不需要我们释放
</span><span class="cm">free (Pointer) 就OK了
</span><span class="cm">  */</span>
  <span class="c1">//将buffer里面的地址转换为函数符号，也可以所说函数的名字
</span><span class="c1"></span>  <span class="kt">char</span><span class="o">**</span> <span class="n">strings</span> <span class="o">=</span> <span class="o">::</span><span class="n">backtrace_symbols</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="n">nptrs</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">strings</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nptrs</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="c1">// TODO demangle funcion name with abi::__cxa_demangle
</span><span class="c1"></span>      <span class="n">stack_</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">strings</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
      <span class="n">stack_</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="sc">&#39;\n&#39;</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="c1">//这个要自己释放
</span><span class="c1"></span>    <span class="n">free</span><span class="p">(</span><span class="n">strings</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div>
<p>测试程序:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-c++" data-lang="c++"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c++" data-lang="c++"><span class="cp">#include</span> <span class="cpf">&lt;muduo/base/Exception.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
</span><span class="cp"></span> 
<span class="k">class</span><span class="err"> </span><span class="nc">Bar</span>
<span class="p">{</span>
 <span class="k">public</span><span class="o">:</span>
  <span class="kt">void</span> <span class="n">test</span><span class="p">()</span>
  <span class="p">{</span>
    <span class="k">throw</span> <span class="n">muduo</span><span class="o">::</span><span class="n">Exception</span><span class="p">(</span><span class="s">&#34;oops&#34;</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">};</span>
 
<span class="kt">void</span> <span class="nf">foo</span><span class="p">()</span>
<span class="p">{</span>
  <span class="n">Bar</span> <span class="n">b</span><span class="p">;</span>
  <span class="n">b</span><span class="p">.</span><span class="n">test</span><span class="p">();</span>
<span class="p">}</span>
 
<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>
<span class="p">{</span>
  <span class="k">try</span>
  <span class="p">{</span>
    <span class="n">foo</span><span class="p">();</span>
  <span class="p">}</span>
  <span class="k">catch</span> <span class="p">(</span><span class="k">const</span> <span class="n">muduo</span><span class="o">::</span><span class="n">Exception</span><span class="o">&amp;</span> <span class="n">ex</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;reason: %s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">ex</span><span class="p">.</span><span class="n">what</span><span class="p">());</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;stack trace: %s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">ex</span><span class="p">.</span><span class="n">stackTrace</span><span class="p">());</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div>
<p>程序输出：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-sh" data-lang="sh"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-sh" data-lang="sh">reason: oops
stack trace: muduo::Exception::fillStackTrace<span class="o">()</span>
muduo::Exception::Exception<span class="o">(</span>char const*<span class="o">)</span>
Bar::test<span class="o">()</span>
foo<span class="o">()</span>
./exception_test<span class="o">(</span>main+0x10<span class="o">)</span>
/lib/libc.so.6<span class="o">(</span>__libc_start_main+0xe6<span class="o">)</span>
./exception_test<span class="o">()</span></code></pre></td></tr></table>
</div>
</div>
<h2 id="13-muduo-之线程">[13] muduo 之线程</h2>

<h3 id="线程标识符">线程标识符</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-c++" data-lang="c++"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c++" data-lang="c++">    <span class="n">pthread_self</span> <span class="n">gettid</span>
    <span class="n">__thread</span><span class="err">，</span><span class="n">gcc内置的线程局部存储设施</span><span class="p">,</span><span class="err">每个线程都有一份</span>
    <span class="n">__thread只能修饰POD类型</span>
<span class="n">POD类型</span><span class="err">（</span><span class="n">plain</span> <span class="n">old</span> <span class="n">data</span><span class="err">），与</span><span class="n">C兼容的原始数据</span><span class="err">，例如，结构和整型等</span><span class="n">C语言中的类型是</span> <span class="n">POD</span> <span class="err">类型，但带有用户定义的构造函数或虚函数的类则不是</span>
    <span class="n">__thread</span> <span class="n">string</span> <span class="n">t_obj1</span><span class="p">(</span><span class="err">“</span><span class="n">cppcourse</span><span class="err">”</span><span class="p">);</span>    <span class="c1">// 错误，不能调用对象的构造函数
</span><span class="c1"></span>    <span class="n">__thread</span> <span class="n">string</span><span class="o">*</span> <span class="n">t_obj2</span> <span class="o">=</span> <span class="k">new</span> <span class="n">string</span><span class="p">;</span>    <span class="c1">// 错误，初始化只能是编译期常量
</span><span class="c1"></span>    <span class="n">__thread</span> <span class="n">string</span><span class="o">*</span> <span class="n">t_obj3</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>    <span class="c1">// 正确
</span><span class="c1"></span>    <span class="n">boost</span><span class="o">::</span><span class="n">is_same</span>
    <span class="n">pthread_atfork</span>
</code></pre></td></tr></table>
</div>
</div>
<ul>
<li>Linux中，每个进程有一个<code>pid</code>，类型<code>pid_t</code>，由<code>getpid()</code>取得。Linux下的<code>POSIX</code>线程也有一个<code>id</code>，类型 <code>pthread_t</code>，由<code>pthread_self()</code>取得，该id由线程库维护，其<code>id</code>空间是各个进程独立的（即不同进程中的线程可能有相同的<code>id</code>）。<code>Linux</code>中的<code>POSIX</code>线程库实现的线程其实也是一个进程<code>（LWP）</code>，只是该进程与主进程（启动线程的进程）共享一些资源而已，比如代码段，数据段等。</li>
<li>有时候我们可能需要知道线程的真实<code>pid</code>。比如进程<code>P1</code>要向另外一个进程<code>P2</code>中的某个线程发送信号时，既不能使用P2的<code>pid</code>，更不能使用线程的<code>pthread id</code>，而只能使用该线程的真实<code>pid</code>，称为<code>tid</code>。</li>
<li>有一个函数<code>gettid()</code>可以得到<code>tid</code>，但<code>glibc</code>并没有实现该函数，只能通过<code>Linux</code>的系统调用<code>syscall</code>来获取。<code>return syscall(SYS_gettid)</code></li>
</ul>

<h3 id="muduo库的thread类图">muduo库的Thread类图</h3>

<p><code>typedef boost::function&lt;void ()&gt; ThreadFunc;</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-c++" data-lang="c++"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c++" data-lang="c++"><span class="o">-</span><span class="nl">started_</span><span class="p">:</span><span class="kt">bool</span>
 
<span class="o">-</span><span class="nl">pthreadId</span> <span class="p">:</span> <span class="n">pthread_t</span>
 
<span class="o">-</span><span class="nl">tid_</span><span class="p">:</span><span class="n">pid_t</span><span class="c1">//
</span><span class="c1"></span> 
<span class="o">-</span><span class="nl">func_</span><span class="p">:</span><span class="n">ThreadFunc</span>
 
<span class="o">-</span><span class="nl">name_</span><span class="p">:</span><span class="n">string</span> <span class="c1">//线程的名称
</span><span class="c1"></span> 
<span class="o">-</span><span class="nl">numCreated_</span><span class="p">:</span><span class="n">AtomicInt32</span> <span class="c1">//已经创建线程的个数
</span><span class="c1"></span> 
<span class="o">-------------------------------</span>
 
<span class="o">&lt;&lt;</span><span class="n">create</span><span class="o">&gt;&gt;+</span><span class="n">Thread</span><span class="p">(</span><span class="nl">func</span><span class="p">:</span><span class="k">const</span> <span class="n">ThreadFunc</span><span class="o">&amp;</span><span class="p">,</span><span class="nl">name</span><span class="p">:</span><span class="n">string</span><span class="p">)</span>
 
<span class="o">&lt;&lt;</span><span class="n">destroy</span><span class="o">&gt;&gt;+</span><span class="n">Thread</span><span class="p">()</span>
 
<span class="o">+</span><span class="n">start</span><span class="p">()</span><span class="o">:</span><span class="kt">void</span>
 
<span class="o">+</span><span class="n">join</span><span class="p">()</span><span class="o">:</span><span class="kt">int</span>
 
<span class="o">+</span><span class="n">started</span><span class="p">()</span><span class="o">:</span><span class="kt">bool</span> <span class="c1">//线程是否已经启动了
</span><span class="c1"></span> 
<span class="o">+</span><span class="n">tid</span><span class="p">()</span><span class="o">:</span><span class="n">pid_t</span>
 
<span class="o">+</span><span class="n">name</span><span class="p">()</span><span class="o">:</span><span class="k">const</span> <span class="n">string</span> <span class="o">&amp;</span>
 
<span class="o">+</span><span class="n">numCreated</span><span class="p">()</span><span class="o">:</span><span class="kt">int</span> <span class="c1">//已近启动线程的个数
</span><span class="c1"></span> 
<span class="o">-</span><span class="n">startThread</span><span class="p">(</span><span class="kr">thread</span><span class="o">:</span><span class="kt">void</span><span class="p">)</span><span class="o">:</span><span class="kt">void</span> <span class="o">*</span>
 
<span class="o">-</span><span class="n">runInThread</span><span class="p">()</span><span class="o">:</span><span class="kt">void</span>
 
<span class="o">-----------------------------------------------------------------------</span>
 
<span class="err">函数调用关系</span>
 
<span class="n">startThread</span><span class="p">()</span><span class="o">---&gt;</span><span class="n">runInthread</span><span class="o">---&gt;</span><span class="n">func</span>
</code></pre></td></tr></table>
</div>
</div>
<p><em>源文件</em>:</p>

<p>头文件：Thread.h</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="nx">namespace</span> <span class="nx">muduo</span>
<span class="p">{</span>
 
<span class="nx">class</span> <span class="nx">Thread</span> <span class="p">:</span> <span class="nx">boost</span><span class="p">::</span><span class="nx">noncopyable</span>
<span class="p">{</span>
 <span class="nx">public</span><span class="p">:</span>
  <span class="nx">typedef</span> <span class="nx">boost</span><span class="p">::</span><span class="nx">function</span><span class="p">&lt;</span><span class="nf">void</span> <span class="p">()&gt;</span> <span class="nx">ThreadFunc</span><span class="p">;</span>
 
  <span class="nx">explicit</span> <span class="nf">Thread</span><span class="p">(</span><span class="kd">const</span> <span class="nx">ThreadFunc</span><span class="o">&amp;</span><span class="p">,</span> <span class="kd">const</span> <span class="kt">string</span><span class="o">&amp;</span> <span class="nx">name</span> <span class="p">=</span> <span class="nb">string</span><span class="p">());</span>
  <span class="err">~</span><span class="nf">Thread</span><span class="p">();</span>
 
  <span class="nx">void</span> <span class="nf">start</span><span class="p">();</span>
  <span class="kt">int</span> <span class="nf">join</span><span class="p">();</span> <span class="c1">// return pthread_join()
</span><span class="c1"></span> 
  <span class="kt">bool</span> <span class="nf">started</span><span class="p">()</span> <span class="kd">const</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">started_</span><span class="p">;</span> <span class="p">}</span>
  <span class="c1">// pthread_t pthreadId() const { return pthreadId_; }
</span><span class="c1"></span>  <span class="nx">pid_t</span> <span class="nf">tid</span><span class="p">()</span> <span class="kd">const</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">tid_</span><span class="p">;</span> <span class="p">}</span>
  <span class="kd">const</span> <span class="kt">string</span><span class="o">&amp;</span> <span class="nf">name</span><span class="p">()</span> <span class="kd">const</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">name_</span><span class="p">;</span> <span class="p">}</span>
 
  <span class="nx">static</span> <span class="kt">int</span> <span class="nf">numCreated</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">numCreated_</span><span class="p">.</span><span class="nf">get</span><span class="p">();</span> <span class="p">}</span>
 
 <span class="nx">private</span><span class="p">:</span>
  <span class="nx">static</span> <span class="nx">void</span><span class="o">*</span> <span class="nf">startThread</span><span class="p">(</span><span class="nx">void</span><span class="o">*</span> <span class="nx">thread</span><span class="p">);</span>
  <span class="nx">void</span> <span class="nf">runInThread</span><span class="p">();</span>
 
  <span class="kt">bool</span>       <span class="nx">started_</span><span class="p">;</span>
  <span class="nx">pthread_t</span>  <span class="nx">pthreadId_</span><span class="p">;</span>
  <span class="nx">pid_t</span>      <span class="nx">tid_</span><span class="p">;</span>
  <span class="nx">ThreadFunc</span> <span class="nx">func_</span><span class="p">;</span>
  <span class="kt">string</span>     <span class="nx">name_</span><span class="p">;</span>
 
  <span class="nx">static</span> <span class="nx">AtomicInt32</span> <span class="nx">numCreated_</span><span class="p">;</span>
<span class="p">};</span>
 
<span class="p">}</span>
<span class="err">#</span><span class="nx">endif</span></code></pre></td></tr></table>
</div>
</div>
<p>源文件：Thread.cpp</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-c++" data-lang="c++"><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c++" data-lang="c++"><span class="k">namespace</span> <span class="n">muduo</span>
<span class="p">{</span>
<span class="k">namespace</span> <span class="n">CurrentThread</span>
<span class="p">{</span> <span class="c1">// __thread修饰的变量时线程局部存储的。 也就是所个线程都一份
</span><span class="c1"></span>  <span class="n">__thread</span> <span class="kt">int</span> <span class="n">t_cachedTid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="c1">//线程真实pid(tid)的缓存，如果每次都使用syscall(SYS_gettid)来获取tid，那么效率会很低
</span><span class="c1"></span>  <span class="n">__thread</span> <span class="kt">char</span> <span class="n">t_tidString</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span><span class="c1">//这是tid的字符串表示形式
</span><span class="c1"></span>  <span class="n">__thread</span> <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">t_threadName</span> <span class="o">=</span> <span class="s">&#34;unknown&#34;</span><span class="p">;</span>
  <span class="k">const</span> <span class="kt">bool</span> <span class="n">sameType</span> <span class="o">=</span> <span class="n">boost</span><span class="o">::</span><span class="n">is_same</span><span class="o">&lt;</span><span class="kt">int</span><span class="p">,</span> <span class="n">pid_t</span><span class="o">&gt;::</span><span class="n">value</span><span class="p">;</span>
  <span class="n">BOOST_STATIC_ASSERT</span><span class="p">(</span><span class="n">sameType</span><span class="p">);</span>
<span class="p">}</span>
 
<span class="k">namespace</span> <span class="n">detail</span>
<span class="p">{</span>
 
<span class="n">pid_t</span> <span class="n">gettid</span><span class="p">()</span>
<span class="p">{</span>
  <span class="k">return</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="n">pid_t</span><span class="o">&gt;</span><span class="p">(</span><span class="o">::</span><span class="n">syscall</span><span class="p">(</span><span class="n">SYS_gettid</span><span class="p">));</span>
<span class="p">}</span>
 
<span class="kt">void</span> <span class="n">afterFork</span><span class="p">()</span>
<span class="p">{</span>
  <span class="n">muduo</span><span class="o">::</span><span class="n">CurrentThread</span><span class="o">::</span><span class="n">t_cachedTid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">muduo</span><span class="o">::</span><span class="n">CurrentThread</span><span class="o">::</span><span class="n">t_threadName</span> <span class="o">=</span> <span class="s">&#34;main&#34;</span><span class="p">;</span>
  <span class="n">CurrentThread</span><span class="o">::</span><span class="n">tid</span><span class="p">();</span>
  <span class="c1">// no need to call pthread_atfork(NULL, NULL, &amp;afterFork);
</span><span class="c1"></span><span class="p">}</span>
 
<span class="k">class</span><span class="err"> </span><span class="nc">ThreadNameInitializer</span>
<span class="p">{</span>
 <span class="k">public</span><span class="o">:</span>
  <span class="n">ThreadNameInitializer</span><span class="p">()</span>
  <span class="p">{</span>
    <span class="n">muduo</span><span class="o">::</span><span class="n">CurrentThread</span><span class="o">::</span><span class="n">t_threadName</span> <span class="o">=</span> <span class="s">&#34;main&#34;</span><span class="p">;</span>
    <span class="n">CurrentThread</span><span class="o">::</span><span class="n">tid</span><span class="p">();</span>
    <span class="n">pthread_atfork</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">afterFork</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">};</span>
 
<span class="n">ThreadNameInitializer</span> <span class="n">init</span><span class="p">;</span>
<span class="p">}</span>
<span class="p">}</span>
 
<span class="k">using</span> <span class="k">namespace</span> <span class="n">muduo</span><span class="p">;</span>
 
<span class="kt">void</span> <span class="n">CurrentThread</span><span class="o">::</span><span class="n">cacheTid</span><span class="p">()</span>
<span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">t_cachedTid</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">t_cachedTid</span> <span class="o">=</span> <span class="n">detail</span><span class="o">::</span><span class="n">gettid</span><span class="p">();</span>
    <span class="kt">int</span> <span class="n">n</span> <span class="o">=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">t_tidString</span><span class="p">,</span> <span class="k">sizeof</span> <span class="n">t_tidString</span><span class="p">,</span> <span class="s">&#34;%5d &#34;</span><span class="p">,</span> <span class="n">t_cachedTid</span><span class="p">);</span>
    <span class="n">assert</span><span class="p">(</span><span class="n">n</span> <span class="o">==</span> <span class="mi">6</span><span class="p">);</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">n</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>
 
<span class="kt">bool</span> <span class="n">CurrentThread</span><span class="o">::</span><span class="n">isMainThread</span><span class="p">()</span>
<span class="p">{</span>
  <span class="k">return</span> <span class="n">tid</span><span class="p">()</span> <span class="o">==</span> <span class="o">::</span><span class="n">getpid</span><span class="p">();</span>
<span class="p">}</span>
 
<span class="n">AtomicInt32</span> <span class="n">Thread</span><span class="o">::</span><span class="n">numCreated_</span><span class="p">;</span>
 
<span class="n">Thread</span><span class="o">::</span><span class="n">Thread</span><span class="p">(</span><span class="k">const</span> <span class="n">ThreadFunc</span><span class="o">&amp;</span> <span class="n">func</span><span class="p">,</span> <span class="k">const</span> <span class="n">string</span><span class="o">&amp;</span> <span class="n">n</span><span class="p">)</span>
  <span class="o">:</span> <span class="n">started_</span><span class="p">(</span><span class="nb">false</span><span class="p">),</span>
    <span class="n">pthreadId_</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
    <span class="n">tid_</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
    <span class="n">func_</span><span class="p">(</span><span class="n">func</span><span class="p">),</span>
    <span class="n">name_</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">numCreated_</span><span class="p">.</span><span class="n">increment</span><span class="p">();</span>
<span class="p">}</span>
 
<span class="n">Thread</span><span class="o">::~</span><span class="n">Thread</span><span class="p">()</span>
<span class="p">{</span>
  <span class="c1">// no join
</span><span class="c1"></span><span class="p">}</span>
 
<span class="kt">void</span> <span class="n">Thread</span><span class="o">::</span><span class="n">start</span><span class="p">()</span>
<span class="p">{</span>
  <span class="n">assert</span><span class="p">(</span><span class="o">!</span><span class="n">started_</span><span class="p">);</span>
  <span class="n">started_</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
  <span class="n">errno</span> <span class="o">=</span> <span class="n">pthread_create</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pthreadId_</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">startThread</span><span class="p">,</span> <span class="k">this</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">errno</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">LOG_SYSFATAL</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;Failed in pthread_create&#34;</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>
 
<span class="kt">int</span> <span class="n">Thread</span><span class="o">::</span><span class="n">join</span><span class="p">()</span>
<span class="p">{</span>
  <span class="n">assert</span><span class="p">(</span><span class="n">started_</span><span class="p">);</span>
  <span class="k">return</span> <span class="nf">pthread_join</span><span class="p">(</span><span class="n">pthreadId_</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>
 
<span class="kt">void</span><span class="o">*</span> <span class="n">Thread</span><span class="o">::</span><span class="n">startThread</span><span class="p">(</span><span class="kt">void</span><span class="o">*</span> <span class="n">obj</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">Thread</span><span class="o">*</span> <span class="kr">thread</span> <span class="o">=</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="n">Thread</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">obj</span><span class="p">);</span>
  <span class="kr">thread</span><span class="o">-&gt;</span><span class="n">runInThread</span><span class="p">();</span>
  <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>
 
<span class="kt">void</span> <span class="n">Thread</span><span class="o">::</span><span class="n">runInThread</span><span class="p">()</span>
<span class="p">{</span>
  <span class="n">tid_</span> <span class="o">=</span> <span class="n">CurrentThread</span><span class="o">::</span><span class="n">tid</span><span class="p">();</span>
  <span class="n">muduo</span><span class="o">::</span><span class="n">CurrentThread</span><span class="o">::</span><span class="n">t_threadName</span> <span class="o">=</span> <span class="n">name_</span><span class="p">.</span><span class="n">c_str</span><span class="p">();</span>
  <span class="k">try</span>
  <span class="p">{</span>
    <span class="n">func_</span><span class="p">();</span>
    <span class="n">muduo</span><span class="o">::</span><span class="n">CurrentThread</span><span class="o">::</span><span class="n">t_threadName</span> <span class="o">=</span> <span class="s">&#34;finished&#34;</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">catch</span> <span class="p">(</span><span class="k">const</span> <span class="n">Exception</span><span class="o">&amp;</span> <span class="n">ex</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">muduo</span><span class="o">::</span><span class="n">CurrentThread</span><span class="o">::</span><span class="n">t_threadName</span> <span class="o">=</span> <span class="s">&#34;crashed&#34;</span><span class="p">;</span>
    <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&#34;exception caught in Thread %s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">name_</span><span class="p">.</span><span class="n">c_str</span><span class="p">());</span>
    <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&#34;reason: %s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">ex</span><span class="p">.</span><span class="n">what</span><span class="p">());</span>
    <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&#34;stack trace: %s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">ex</span><span class="p">.</span><span class="n">stackTrace</span><span class="p">());</span>
    <span class="n">abort</span><span class="p">();</span>
  <span class="p">}</span>
  <span class="k">catch</span> <span class="p">(</span><span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">exception</span><span class="o">&amp;</span> <span class="n">ex</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">muduo</span><span class="o">::</span><span class="n">CurrentThread</span><span class="o">::</span><span class="n">t_threadName</span> <span class="o">=</span> <span class="s">&#34;crashed&#34;</span><span class="p">;</span>
    <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&#34;exception caught in Thread %s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">name_</span><span class="p">.</span><span class="n">c_str</span><span class="p">());</span>
    <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&#34;reason: %s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">ex</span><span class="p">.</span><span class="n">what</span><span class="p">());</span>
    <span class="n">abort</span><span class="p">();</span>
  <span class="p">}</span>
  <span class="k">catch</span> <span class="p">(...)</span>
  <span class="p">{</span>
    <span class="n">muduo</span><span class="o">::</span><span class="n">CurrentThread</span><span class="o">::</span><span class="n">t_threadName</span> <span class="o">=</span> <span class="s">&#34;crashed&#34;</span><span class="p">;</span>
    <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&#34;unknown exception caught in Thread %s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">name_</span><span class="p">.</span><span class="n">c_str</span><span class="p">());</span>
    <span class="k">throw</span><span class="p">;</span> <span class="c1">// rethrow
</span><span class="c1"></span>  <span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div>
<p>测试程序1</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-php" data-lang="php"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-php" data-lang="php">#include <span class="p">&lt;</span><span class="nt">muduo</span><span class="err">/</span><span class="na">base</span><span class="err">/</span><span class="na">Thread</span><span class="err">.</span><span class="na">h</span><span class="p">&gt;</span>
#include <span class="p">&lt;</span><span class="nt">muduo</span><span class="err">/</span><span class="na">base</span><span class="err">/</span><span class="na">CurrentThread</span><span class="err">.</span><span class="na">h</span><span class="p">&gt;</span>
 
#include <span class="p">&lt;</span><span class="nt">string</span><span class="p">&gt;</span>
#include <span class="p">&lt;</span><span class="nt">boost</span><span class="err">/</span><span class="na">bind</span><span class="err">.</span><span class="na">hpp</span><span class="p">&gt;</span>
#include <span class="p">&lt;</span><span class="nt">stdio.h</span><span class="p">&gt;</span>
 
void threadFunc()
{
  printf(&#34;tid=%d\n&#34;, muduo::CurrentThread::tid());
}
 
void threadFunc2(int x)
{
  printf(&#34;tid=%d, x=%d\n&#34;, muduo::CurrentThread::tid(), x);
}
 
class Foo
{
 public:
  explicit Foo(double x)
    : x_(x)
  {
  }
 
  void memberFunc()
  {
    printf(&#34;tid=%d, Foo::x_=%f\n&#34;, muduo::CurrentThread::tid(), x_);
  }
 
  void memberFunc2(const std::string<span class="err">&amp;</span> text)
  {
    printf(&#34;tid=%d, Foo::x_=%f, text=%s\n&#34;, muduo::CurrentThread::tid(), x_, text.c_str());
  }
 
 private:
  double x_;
};
 
int main()
{
  printf(&#34;pid=%d, tid=%d\n&#34;, ::getpid(), muduo::CurrentThread::tid());
 
  muduo::Thread t1(threadFunc);
  t1.start();
  t1.join();
 
  muduo::Thread t2(boost::bind(threadFunc2, 42),
                   &#34;thread for free function with argument&#34;);
  t2.start();
  t2.join();
 
  Foo foo(87.53);
  muduo::Thread t3(boost::bind(<span class="err">&amp;</span>Foo::memberFunc, <span class="err">&amp;</span>foo),
                   &#34;thread for member function without argument&#34;);
  t3.start();
  t3.join();
 
  muduo::Thread t4(boost::bind(<span class="err">&amp;</span>Foo::memberFunc2, boost::ref(foo), std::string(&#34;Shuo Chen&#34;)));
  t4.start();
  t4.join();
 
  printf(&#34;number of created threads %d\n&#34;, muduo::Thread::numCreated());</code></pre></td></tr></table>
</div>
</div>
<p>程序输出：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-sh" data-lang="sh"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-sh" data-lang="sh"><span class="o">[</span>root@localhost bin<span class="o">]</span><span class="c1"># ./thread_test</span>
<span class="nv">pid</span><span class="o">=</span><span class="m">3133</span>, <span class="nv">tid</span><span class="o">=</span><span class="m">3133</span>
<span class="nv">tid</span><span class="o">=</span><span class="m">3134</span>
<span class="nv">tid</span><span class="o">=</span><span class="m">3135</span>, <span class="nv">x</span><span class="o">=</span><span class="m">42</span>
<span class="nv">tid</span><span class="o">=</span><span class="m">3136</span>, Foo::x_<span class="o">=</span><span class="m">87</span>.530000
<span class="nv">tid</span><span class="o">=</span><span class="m">3137</span>, Foo::x_<span class="o">=</span><span class="m">87</span>.530000, <span class="nv">text</span><span class="o">=</span>Shuo Chen
number of created threads <span class="m">4</span>
<span class="o">[</span>root@localhost bin<span class="o">]</span><span class="c1"># ^C</span></code></pre></td></tr></table>
</div>
</div>
<h3 id="pthread-atfork">pthread_atfork</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-c++" data-lang="c++"><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c++" data-lang="c++"><span class="cp">#include</span> <span class="cpf">&lt;pthread.h&gt;</span><span class="cp">
</span><span class="cp"></span><span class="kt">int</span> <span class="nf">pthread_atfork</span><span class="p">(</span><span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">prepare</span><span class="p">)(</span><span class="kt">void</span><span class="p">),</span> <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">parent</span><span class="p">)(</span><span class="kt">void</span><span class="p">),</span> <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">child</span><span class="p">)(</span><span class="kt">void</span><span class="p">));</span>
</code></pre></td></tr></table>
</div>
</div>
<p>调用fork时，内部创建子进程前在父进程中会调用prepare，内部创建子进程成功后，父进程会调用parent ，子进程会调用child.</p>

<p>测试源码：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-c++" data-lang="c++"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c++" data-lang="c++"><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;time.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;pthread.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;unistd.h&gt;</span><span class="cp">
</span><span class="cp"></span> 
<span class="kt">void</span> <span class="nf">prepare</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;pid = %d prepare ...</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="p">(</span><span class="n">getpid</span><span class="p">()));</span>
<span class="p">}</span>
 
<span class="kt">void</span> <span class="nf">parent</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;pid = %d parent ...</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="p">(</span><span class="n">getpid</span><span class="p">()));</span>
<span class="p">}</span>
 
<span class="kt">void</span> <span class="nf">child</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;pid = %d child ...</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="p">(</span><span class="n">getpid</span><span class="p">()));</span>
<span class="p">}</span>
 
 
<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;pid = %d Entering main ...</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="p">(</span><span class="n">getpid</span><span class="p">()));</span>
 
    <span class="n">pthread_atfork</span><span class="p">(</span><span class="n">prepare</span><span class="p">,</span> <span class="n">parent</span><span class="p">,</span> <span class="n">child</span><span class="p">);</span>
 
    <span class="n">fork</span><span class="p">();</span>
 
    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;pid = %d Exiting main ...</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span><span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="p">(</span><span class="n">getpid</span><span class="p">()));</span>
 
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div>
<p>程序输出：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-sh" data-lang="sh"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-sh" data-lang="sh"><span class="o">[</span>root@localhost bin<span class="o">]</span><span class="c1"># ./pthread_atfork_test</span>
<span class="nv">pid</span> <span class="o">=</span> <span class="m">3358</span> Entering main ...
<span class="nv">pid</span> <span class="o">=</span> <span class="m">3358</span> prepare ...
<span class="nv">pid</span> <span class="o">=</span> <span class="m">3358</span> parent ...
<span class="nv">pid</span> <span class="o">=</span> <span class="m">3358</span> Exiting main ...
<span class="o">[</span>root@localhost bin<span class="o">]</span><span class="c1"># pid = 3359 child ...</span>
<span class="nv">pid</span> <span class="o">=</span> <span class="m">3359</span> Exiting main ...
 
<span class="o">[</span>root@localhost bin<span class="o">]</span><span class="c1"># ^C</span></code></pre></td></tr></table>
</div>
</div>
<p>注意：</p>

<p>在编程时要特别注意，不要使用多线程和多进程进行交叉使用，很有可能出现死锁的情况！！！</p>

<h2 id="13-1-module之线程">[13-1] module之线程</h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-c++" data-lang="c++"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c++" data-lang="c++"><span class="cp">#include</span><span class="cpf">&lt;iostream&gt;</span><span class="cp">
</span><span class="cp">#include</span><span class="cpf">&lt;pthread.h&gt;</span><span class="cp">
</span><span class="cp">#include</span><span class="cpf">&lt;unistd.h&gt;</span><span class="cp">
</span><span class="cp"></span> 
<span class="k">using</span> <span class="k">namespace</span> <span class="n">std</span><span class="p">;</span>
<span class="k">const</span> <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">5</span> <span class="p">;</span>
 
<span class="n">__thread</span> <span class="kt">int</span> <span class="n">var</span> <span class="o">=</span> <span class="n">i</span> <span class="p">;</span>
 
<span class="kt">void</span> <span class="o">*</span> <span class="nf">worker1</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span> <span class="n">args</span><span class="p">);</span>
<span class="kt">void</span> <span class="o">*</span> <span class="nf">worker2</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span> <span class="n">args</span><span class="p">);</span>
 
 
<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">void</span><span class="p">){</span>
    <span class="n">pthread_t</span> <span class="n">pid1</span><span class="p">,</span> <span class="n">pid2</span><span class="p">;</span>
    <span class="k">static</span> <span class="n">__thread</span> <span class="kt">int</span> <span class="n">temp</span> <span class="o">=</span> <span class="mi">10</span> <span class="p">;</span>
 
    <span class="n">pthread_create</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pid1</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">worker1</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
    <span class="n">pthread_create</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pid2</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">worker2</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
 
    <span class="n">pthread_join</span><span class="p">(</span><span class="n">pid1</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
    <span class="n">pthread_join</span><span class="p">(</span><span class="n">pid2</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
    <span class="n">cout</span><span class="o">&lt;&lt;</span><span class="n">temp</span><span class="o">&lt;&lt;</span><span class="n">endl</span><span class="p">;</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
 
 
<span class="kt">void</span> <span class="o">*</span> <span class="nf">worker1</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">args</span><span class="p">){</span>
    <span class="n">cout</span><span class="o">&lt;&lt;++</span><span class="n">var</span><span class="o">&lt;&lt;</span><span class="n">endl</span><span class="p">;</span>
    <span class="n">cout</span><span class="o">&lt;&lt;++</span><span class="n">var</span><span class="o">&lt;&lt;</span><span class="n">endl</span><span class="p">;</span>
 
<span class="p">}</span>
<span class="kt">void</span> <span class="o">*</span> <span class="nf">worker2</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">args</span><span class="p">){</span>
    <span class="n">sleep</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span>
    <span class="n">cout</span><span class="o">&lt;&lt;++</span><span class="n">var</span><span class="o">&lt;&lt;</span><span class="n">endl</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div>
<p>程序输出：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-sh" data-lang="sh"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-sh" data-lang="sh">oem@oem-VirtualBox ~/workspace/c++ $ ./a.out
<span class="m">6</span>
<span class="m">7</span>
<span class="m">6</span>
<span class="m">10</span>
oem@oem-VirtualBox ~/workspace/c++ $</code></pre></td></tr></table>
</div>
</div>
<p><code>_thread</code>是<code>GCC</code>内置的线程局部存储设施，存取效率可以和全局变量相比。<code>__thread</code>变量每一个线程有一份独立实体，各个线程的值互不干扰。可以用来修饰那些带有全局性且值可能变，但是又不值得用全局变量保护的变量。</p>

<p><code>__thread</code>使用规则：只能修饰<code>POD</code>类型(类似整型指针的标量，不带自定义的构造、拷贝、赋值、析构的类型，二进制内容可以任意复制<code>memset</code>,<code>memcpy</code>,且内容可以复原)，不能修饰<code>class</code>类型，因为无法自动调用构造函数和析构函数，可以用于修饰全局变量，函数内的静态变量，不能修饰函数的局部变量或者<code>class</code>的普通成员变量，且<code>__thread</code>变量值只能初始化为编译器常量(值在编译器就可以确定<code>const int i=5</code>,运行期常量是运行初始化后不再改变<code>const int i=rand())</code>.</p>

<h2 id="14-ipc组件的分装之互斥锁">[14] IPC组件的分装之互斥锁</h2>

<h3 id="mutexlock-的封装">MutexLock 的封装</h3>

<ul>
<li>MutexLock类图</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-c++" data-lang="c++"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c++" data-lang="c++"><span class="o">-</span><span class="nl">mutex_</span><span class="p">:</span><span class="n">pthread_mutex_t</span> 

<span class="o">-</span><span class="nl">holder_</span><span class="p">:</span><span class="n">pid_t</span> <span class="c1">//线程的真实ID,用来表示拥有锁的线程
</span><span class="c1"></span>
<span class="o">-----------------------------</span>

<span class="o">&lt;&lt;</span><span class="n">create</span><span class="o">&gt;&gt;-</span><span class="n">MutexLock</span><span class="p">()</span>

<span class="o">&lt;&lt;</span><span class="n">destroy</span><span class="o">&gt;&gt;-</span><span class="n">MutexLock</span>

<span class="o">+</span><span class="nl">isLockedByThisThread</span><span class="p">:</span><span class="kt">bool</span> <span class="c1">// 当前线程是否拥有该锁
</span><span class="c1"></span>
<span class="o">+</span><span class="n">assertLocked</span><span class="p">()</span><span class="o">:</span><span class="kt">void</span> <span class="c1">//断言当前线程是否拥有该锁
</span><span class="c1"></span>
<span class="o">+</span><span class="n">lock</span><span class="p">()</span><span class="o">:</span><span class="kt">void</span>

<span class="o">+</span><span class="n">unlock</span><span class="p">()</span><span class="o">:</span><span class="kt">void</span>

<span class="o">+</span><span class="n">getPthreadMutex</span><span class="p">()</span><span class="o">:</span><span class="n">pthread_mutex_t</span> <span class="o">*</span>
</code></pre></td></tr></table>
</div>
</div>
<ul>
<li>MutexLockGuard类图封装:</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-c++" data-lang="c++"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c++" data-lang="c++"><span class="o">-</span><span class="nl">mutex_</span><span class="p">:</span><span class="n">MutexLock</span> <span class="o">&amp;</span>

<span class="o">-----------</span>

<span class="o">&lt;&lt;</span><span class="n">create</span><span class="o">&gt;&gt;-</span><span class="n">MutexLockGurad</span><span class="p">(</span><span class="nl">mutex</span><span class="p">:</span><span class="n">MutexLock</span><span class="o">&amp;</span><span class="p">)</span>

<span class="o">&lt;&lt;</span><span class="n">destroy</span><span class="o">&gt;&gt;-</span><span class="n">MutexLockGurad</span><span class="p">()</span>
</code></pre></td></tr></table>
</div>
</div>
<h3 id="mutexlockguard">MutexLockGuard</h3>

<ul>
<li>MutexLock类图</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-c++" data-lang="c++"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c++" data-lang="c++"><span class="o">-</span><span class="nl">mutex_</span><span class="p">:</span><span class="n">pthread_mutex_t</span> 

<span class="o">-</span><span class="nl">holder_</span><span class="p">:</span><span class="n">pid_t</span> <span class="c1">//线程的真实ID,用来表示拥有锁的线程
</span><span class="c1"></span>
<span class="o">-----------------------------</span>

<span class="o">&lt;&lt;</span><span class="n">create</span><span class="o">&gt;&gt;-</span><span class="n">MutexLock</span><span class="p">()</span>

<span class="o">&lt;&lt;</span><span class="n">destroy</span><span class="o">&gt;&gt;-</span><span class="n">MutexLock</span>

<span class="o">+</span><span class="nl">isLockedByThisThread</span><span class="p">:</span><span class="kt">bool</span> <span class="c1">// 当前线程是否拥有该锁
</span><span class="c1"></span>
<span class="o">+</span><span class="n">assertLocked</span><span class="p">()</span><span class="o">:</span><span class="kt">void</span> <span class="c1">//断言当前线程是否拥有该锁
</span><span class="c1"></span>
<span class="o">+</span><span class="n">lock</span><span class="p">()</span><span class="o">:</span><span class="kt">void</span>

<span class="o">+</span><span class="n">unlock</span><span class="p">()</span><span class="o">:</span><span class="kt">void</span>

<span class="o">+</span><span class="n">getPthreadMutex</span><span class="p">()</span><span class="o">:</span><span class="n">pthread_mutex_t</span> <span class="o">*</span>
</code></pre></td></tr></table>
</div>
</div>
<ul>
<li>MutexLockGuard类图封装</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-c++" data-lang="c++"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c++" data-lang="c++"><span class="o">-</span><span class="nl">mutex_</span><span class="p">:</span><span class="n">MutexLock</span> <span class="o">&amp;</span>

<span class="o">-----------</span>

<span class="o">&lt;&lt;</span><span class="n">create</span><span class="o">&gt;&gt;-</span><span class="n">MutexLockGurad</span><span class="p">(</span><span class="nl">mutex</span><span class="p">:</span><span class="n">MutexLock</span><span class="o">&amp;</span><span class="p">)</span>

<span class="o">&lt;&lt;</span><span class="n">destroy</span><span class="o">&gt;&gt;-</span><span class="n">MutexLockGurad</span><span class="p">()</span>
</code></pre></td></tr></table>
</div>
</div>
<h3 id="mutexlockguard-1">MutexLockGuard</h3>

<ul>
<li>MutexLockGuard 类图</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-c++" data-lang="c++"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c++" data-lang="c++"><span class="o">-</span><span class="nl">mutex_</span><span class="p">:</span><span class="n">MutexLock</span><span class="o">&amp;</span>

<span class="o">&lt;&lt;</span><span class="n">create</span><span class="o">&gt;&gt;-</span><span class="n">MutexLockGuard</span><span class="p">(</span><span class="nl">mutex</span><span class="p">:</span><span class="n">MutexLock</span><span class="o">&amp;</span><span class="p">)</span>

<span class="o">&lt;&lt;</span><span class="n">destroy</span><span class="o">&gt;&gt;-</span><span class="n">MutexLockGuard</span><span class="p">()</span>
</code></pre></td></tr></table>
</div>
</div>
<h3 id="mutexlock-和-mutexlockguard的源代码">MutexLock 和 MutexLockGuard的源代码</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="o">/</span> <span class="nx">Use</span> <span class="nx">of</span> <span class="nx">this</span> <span class="nx">source</span> <span class="nx">code</span> <span class="nx">is</span> <span class="nx">governed</span> <span class="nx">by</span> <span class="nx">a</span> <span class="nx">BSD</span><span class="o">-</span><span class="nx">style</span> <span class="nx">license</span>
<span class="c1">// that can be found in the License file.
</span><span class="c1">//
</span><span class="c1">// Author: Shuo Chen (chenshuo at chenshuo dot com)
</span><span class="c1"></span> 
<span class="err">#</span><span class="nx">ifndef</span> <span class="nx">MUDUO_BASE_MUTEX_H</span>
<span class="err">#</span><span class="nx">define</span> <span class="nx">MUDUO_BASE_MUTEX_H</span>
 
<span class="err">#</span><span class="nx">include</span> <span class="p">&lt;</span><span class="nx">muduo</span><span class="o">/</span><span class="nx">base</span><span class="o">/</span><span class="nx">CurrentThread</span><span class="p">.</span><span class="nx">h</span><span class="p">&gt;</span>
<span class="err">#</span><span class="nx">include</span> <span class="p">&lt;</span><span class="nx">boost</span><span class="o">/</span><span class="nx">noncopyable</span><span class="p">.</span><span class="nx">hpp</span><span class="p">&gt;</span>
<span class="err">#</span><span class="nx">include</span> <span class="p">&lt;</span><span class="nx">assert</span><span class="p">.</span><span class="nx">h</span><span class="p">&gt;</span>
<span class="err">#</span><span class="nx">include</span> <span class="p">&lt;</span><span class="nx">pthread</span><span class="p">.</span><span class="nx">h</span><span class="p">&gt;</span>
 
<span class="nx">namespace</span> <span class="nx">muduo</span>
<span class="p">{</span>
 
<span class="nx">class</span> <span class="nx">MutexLock</span> <span class="p">:</span> <span class="nx">boost</span><span class="p">::</span><span class="nx">noncopyable</span> <span class="c1">//表示该类不能复制
</span><span class="c1"></span><span class="p">{</span>
 <span class="nx">public</span><span class="p">:</span>
  <span class="nf">MutexLock</span><span class="p">()</span>
    <span class="p">:</span> <span class="nf">holder_</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
  <span class="p">{</span>
     <span class="c1">//初始化锁
</span><span class="c1"></span>    <span class="kt">int</span> <span class="nx">ret</span> <span class="p">=</span> <span class="nf">pthread_mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">mutex_</span><span class="p">,</span> <span class="nx">NULL</span><span class="p">);</span>
    <span class="nf">assert</span><span class="p">(</span><span class="nx">ret</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span> <span class="p">(</span><span class="nx">void</span><span class="p">)</span> <span class="nx">ret</span><span class="p">;</span>
  <span class="p">}</span>
 
  <span class="err">~</span><span class="nf">MutexLock</span><span class="p">()</span>
  <span class="p">{</span>
      <span class="c1">//断言该锁是否还在使用
</span><span class="c1"></span>    <span class="nf">assert</span><span class="p">(</span><span class="nx">holder_</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>
    <span class="c1">//没用呗使用则销毁锁资源
</span><span class="c1"></span>    <span class="kt">int</span> <span class="nx">ret</span> <span class="p">=</span> <span class="nf">pthread_mutex_destroy</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">mutex_</span><span class="p">);</span>
    <span class="nf">assert</span><span class="p">(</span><span class="nx">ret</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span> <span class="p">(</span><span class="nx">void</span><span class="p">)</span> <span class="nx">ret</span><span class="p">;</span>
  <span class="p">}</span>
 <span class="c1">//测试当前线程是否拥有锁
</span><span class="c1"></span>  <span class="kt">bool</span> <span class="nf">isLockedByThisThread</span><span class="p">()</span>
  <span class="p">{</span>
    <span class="k">return</span> <span class="nx">holder_</span> <span class="o">==</span> <span class="nx">CurrentThread</span><span class="p">::</span><span class="nf">tid</span><span class="p">();</span>
  <span class="p">}</span>
<span class="c1">//断言锁
</span><span class="c1"></span>  <span class="nx">void</span> <span class="nf">assertLocked</span><span class="p">()</span>
  <span class="p">{</span>
    <span class="nf">assert</span><span class="p">(</span><span class="nf">isLockedByThisThread</span><span class="p">());</span>
  <span class="p">}</span>
 
  <span class="c1">// internal usage
</span><span class="c1">//当前线程枷锁
</span><span class="c1"></span>  <span class="nx">void</span> <span class="nf">lock</span><span class="p">()</span>
  <span class="p">{</span>
    <span class="nf">pthread_mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">mutex_</span><span class="p">);</span>
    <span class="nx">holder_</span> <span class="p">=</span> <span class="nx">CurrentThread</span><span class="p">::</span><span class="nf">tid</span><span class="p">();</span>
  <span class="p">}</span>
<span class="c1">//当前线程解锁
</span><span class="c1"></span>  <span class="nx">void</span> <span class="nf">unlock</span><span class="p">()</span>
  <span class="p">{</span>
    <span class="nx">holder_</span> <span class="p">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="nf">pthread_mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">mutex_</span><span class="p">);</span>
  <span class="p">}</span>
 
  <span class="nx">pthread_mutex_t</span><span class="o">*</span> <span class="nf">getPthreadMutex</span><span class="p">()</span> <span class="cm">/* non-const */</span>
  <span class="p">{</span>
    <span class="k">return</span> <span class="o">&amp;</span><span class="nx">mutex_</span><span class="p">;</span>
  <span class="p">}</span>
 
 <span class="nx">private</span><span class="p">:</span>
 
  <span class="nx">pthread_mutex_t</span> <span class="nx">mutex_</span><span class="p">;</span>
  <span class="nx">pid_t</span> <span class="nx">holder_</span><span class="p">;</span>
<span class="p">};</span>
 
 
<span class="nx">class</span> <span class="nx">MutexLockGuard</span> <span class="p">:</span> <span class="nx">boost</span><span class="p">::</span><span class="nx">noncopyable</span> <span class="c1">//不可复制
</span><span class="c1"></span><span class="p">{</span>
 <span class="nx">public</span><span class="p">:</span>
<span class="c1">//构造时负责枷锁
</span><span class="c1"></span>  <span class="nx">explicit</span> <span class="nf">MutexLockGuard</span><span class="p">(</span><span class="nx">MutexLock</span><span class="o">&amp;</span> <span class="nx">mutex</span><span class="p">)</span>
    <span class="p">:</span> <span class="nf">mutex_</span><span class="p">(</span><span class="nx">mutex</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="nx">mutex_</span><span class="p">.</span><span class="nf">lock</span><span class="p">();</span>
  <span class="p">}</span>
<span class="c1">//虚构时负责解锁，但是并没有销毁mutex_
</span><span class="c1"></span>  <span class="err">~</span><span class="nf">MutexLockGuard</span><span class="p">()</span>
  <span class="p">{</span>
    <span class="nx">mutex_</span><span class="p">.</span><span class="nf">unlock</span><span class="p">();</span>
  <span class="p">}</span>
 
 <span class="nx">private</span><span class="p">:</span>
<span class="c1">// MutexLock &amp;mutex 的生存期并不会被MutexLockGuard管理
</span><span class="c1"></span> <span class="c1">//他们的关系是关联的。
</span><span class="c1"></span> <span class="c1">// 聚合关系：表示A包含B
</span><span class="c1"></span> <span class="c1">// 组合关系：表示A包含B，并且负责B的生存期
</span><span class="c1"></span>  <span class="nx">MutexLock</span><span class="o">&amp;</span> <span class="nx">mutex_</span><span class="p">;</span>
<span class="p">};</span>
 
<span class="p">}</span>
 
<span class="c1">// Prevent misuse like:
</span><span class="c1">// MutexLockGuard(mutex_); 防止匿名对象
</span><span class="c1">// A tempory object doesn&#39;t hold the lock for long!
</span><span class="c1"></span><span class="err">#</span><span class="nx">define</span> <span class="nf">MutexLockGuard</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="kt">error</span> <span class="s">&#34;Missing guard object name&#34;</span>
 
<span class="err">#</span><span class="nx">endif</span>  <span class="o">//</span> <span class="nx">MUDUO_BA</span></code></pre></td></tr></table>
</div>
</div>
<p>测试代码:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="err">#</span><span class="nx">include</span> <span class="p">&lt;</span><span class="nx">muduo</span><span class="o">/</span><span class="nx">base</span><span class="o">/</span><span class="nx">CountDownLatch</span><span class="p">.</span><span class="nx">h</span><span class="p">&gt;</span>
<span class="err">#</span><span class="nx">include</span> <span class="p">&lt;</span><span class="nx">muduo</span><span class="o">/</span><span class="nx">base</span><span class="o">/</span><span class="nx">Mutex</span><span class="p">.</span><span class="nx">h</span><span class="p">&gt;</span>
<span class="err">#</span><span class="nx">include</span> <span class="p">&lt;</span><span class="nx">muduo</span><span class="o">/</span><span class="nx">base</span><span class="o">/</span><span class="nx">Thread</span><span class="p">.</span><span class="nx">h</span><span class="p">&gt;</span>
<span class="err">#</span><span class="nx">include</span> <span class="p">&lt;</span><span class="nx">muduo</span><span class="o">/</span><span class="nx">base</span><span class="o">/</span><span class="nx">Timestamp</span><span class="p">.</span><span class="nx">h</span><span class="p">&gt;</span>
<span class="err">#</span><span class="nx">include</span> <span class="p">&lt;</span><span class="nx">boost</span><span class="o">/</span><span class="nx">bind</span><span class="p">.</span><span class="nx">hpp</span><span class="p">&gt;</span>
<span class="err">#</span><span class="nx">include</span> <span class="p">&lt;</span><span class="nx">boost</span><span class="o">/</span><span class="nx">ptr_container</span><span class="o">/</span><span class="nx">ptr_vector</span><span class="p">.</span><span class="nx">hpp</span><span class="p">&gt;</span>
<span class="err">#</span><span class="nx">include</span> <span class="p">&lt;</span><span class="nx">vector</span><span class="p">&gt;</span>
<span class="err">#</span><span class="nx">include</span> <span class="p">&lt;</span><span class="nx">stdio</span><span class="p">.</span><span class="nx">h</span><span class="p">&gt;</span>
 
<span class="nx">using</span> <span class="nx">namespace</span> <span class="nx">muduo</span><span class="p">;</span>
<span class="nx">using</span> <span class="nx">namespace</span> <span class="nx">std</span><span class="p">;</span>
 
<span class="nx">MutexLock</span> <span class="nx">g_mutex</span><span class="p">;</span>
<span class="nx">vector</span><span class="p">&lt;</span><span class="kt">int</span><span class="p">&gt;</span> <span class="nx">g_vec</span><span class="p">;</span>
<span class="kd">const</span> <span class="kt">int</span> <span class="nx">kCount</span> <span class="p">=</span> <span class="mi">10</span><span class="o">*</span><span class="mi">1000</span><span class="o">*</span><span class="mi">1000</span><span class="p">;</span>
 
<span class="nx">void</span> <span class="nf">threadFunc</span><span class="p">()</span>
<span class="p">{</span>
    <span class="c1">//插入kCount个整数
</span><span class="c1"></span>  <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="nx">i</span> <span class="p">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="p">&lt;</span> <span class="nx">kCount</span><span class="p">;</span> <span class="o">++</span><span class="nx">i</span><span class="p">)</span>
  <span class="p">{</span>
      <span class="c1">//没循环一次加解锁一次，这里花费的时间会多点
</span><span class="c1"></span>    <span class="nx">MutexLockGuard</span> <span class="nf">lock</span><span class="p">(</span><span class="nx">g_mutex</span><span class="p">);</span>
    <span class="nx">g_vec</span><span class="p">.</span><span class="nf">push_back</span><span class="p">(</span><span class="nx">i</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>
 
<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>
<span class="p">{</span>
    <span class="c1">//最多8 个线程
</span><span class="c1"></span>  <span class="kd">const</span> <span class="kt">int</span> <span class="nx">kMaxThreads</span> <span class="p">=</span> <span class="mi">8</span><span class="p">;</span><span class="err">、</span>
    <span class="c1">//预留8千多万个整数 ， 300多m
</span><span class="c1"></span>  <span class="nx">g_vec</span><span class="p">.</span><span class="nf">reserve</span><span class="p">(</span><span class="nx">kMaxThreads</span> <span class="o">*</span> <span class="nx">kCount</span><span class="p">);</span>
    <span class="c1">//登记一个时间戳
</span><span class="c1"></span>  <span class="nx">Timestamp</span> <span class="nf">start</span><span class="p">(</span><span class="nx">Timestamp</span><span class="p">::</span><span class="nf">now</span><span class="p">());</span>
    <span class="c1">//插入kCount多个整数
</span><span class="c1"></span>  <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="nx">i</span> <span class="p">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="p">&lt;</span> <span class="nx">kCount</span><span class="p">;</span> <span class="o">++</span><span class="nx">i</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="nx">g_vec</span><span class="p">.</span><span class="nf">push_back</span><span class="p">(</span><span class="nx">i</span><span class="p">);</span>
  <span class="p">}</span>
    <span class="c1">//单线程 统计插入kCount个整数所用时间
</span><span class="c1"></span>  <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;single thread without lock %f\n&#34;</span><span class="p">,</span> <span class="nf">timeDifference</span><span class="p">(</span><span class="nx">Timestamp</span><span class="p">::</span><span class="nf">now</span><span class="p">(),</span> <span class="nx">start</span><span class="p">));</span>
 
  <span class="nx">start</span> <span class="p">=</span> <span class="nx">Timestamp</span><span class="p">::</span><span class="nf">now</span><span class="p">();</span>
  <span class="nf">threadFunc</span><span class="p">();</span>
  <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;single thread with lock %f\n&#34;</span><span class="p">,</span> <span class="nf">timeDifference</span><span class="p">(</span><span class="nx">Timestamp</span><span class="p">::</span><span class="nf">now</span><span class="p">(),</span> <span class="nx">start</span><span class="p">));</span>
 
  <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="nx">nthreads</span> <span class="p">=</span> <span class="mi">1</span><span class="p">;</span> <span class="nx">nthreads</span> <span class="p">&lt;</span> <span class="nx">kMaxThreads</span><span class="p">;</span> <span class="o">++</span><span class="nx">nthreads</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="c1">//这是一个指针vector，存放的是Thread乐行的指针
</span><span class="c1"></span>    <span class="c1">//智能指针，释放threads时，它里面的对象也会被销毁
</span><span class="c1"></span>    <span class="nx">boost</span><span class="p">::</span><span class="nx">ptr_vector</span><span class="p">&lt;</span><span class="nx">Thread</span><span class="p">&gt;</span> <span class="nx">threads</span><span class="p">;</span>
    <span class="nx">g_vec</span><span class="p">.</span><span class="nf">clear</span><span class="p">();</span>
    <span class="nx">start</span> <span class="p">=</span> <span class="nx">Timestamp</span><span class="p">::</span><span class="nf">now</span><span class="p">();</span>
    <span class="cm">/*
</span><span class="cm">    第一次 1 个线程， 第二次2个线程.....，不同线程个数时所花费的时间
</span><span class="cm">    **/</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="nx">i</span> <span class="p">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="p">&lt;</span> <span class="nx">nthreads</span><span class="p">;</span> <span class="o">++</span><span class="nx">i</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="nx">threads</span><span class="p">.</span><span class="nf">push_back</span><span class="p">(</span><span class="nx">new</span> <span class="nf">Thread</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">threadFunc</span><span class="p">));</span>
      <span class="c1">//启动最后一个对象的线程，其实就是每增加一个，然后就执行它
</span><span class="c1"></span>      <span class="nx">threads</span><span class="p">.</span><span class="nf">back</span><span class="p">().</span><span class="nf">start</span><span class="p">();</span>
    <span class="p">}</span>
    <span class="c1">//等待线程的结束
</span><span class="c1"></span>    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="nx">i</span> <span class="p">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="p">&lt;</span> <span class="nx">nthreads</span><span class="p">;</span> <span class="o">++</span><span class="nx">i</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="nx">threads</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nf">join</span><span class="p">();</span>
    <span class="p">}</span>
    <span class="c1">//计算时间差
</span><span class="c1"></span>    <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;%d thread(s) with lock %f\n&#34;</span><span class="p">,</span> <span class="nx">nthreads</span><span class="p">,</span> <span class="nf">timeDifference</span><span class="p">(</span><span class="nx">Timestamp</span><span class="p">::</span><span class="nf">now</span><span class="p">(),</span> <span class="nx">start</span><span class="p">));</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<p>程序输出:</p>

<p><code>single thread without lock 1.512640</code>
<code>single thread with lock 1.305807</code>
<code>1 thread(s) with lock 0.685571</code>
<code>2 thread(s) with lock 3.381297</code>
<code>3 thread(s) with lock 4.640776</code>
<code>4 thread(s) with lock 5.383397</code>
<code>5 thread(s) with lock 7.897223</code>
<code>6 thread(s) with lock 21.798079</code>
<code>7 thread(s) with lock 23.351875</code></p>

<h2 id="15-blockingqueue">[15] BlockingQueue</h2>

<h3 id="blockingqueue类图">BlockingQueue类图</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-c++" data-lang="c++"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c++" data-lang="c++"><span class="o">-</span><span class="nl">mutex_</span> <span class="p">:</span> <span class="n">MutexLock</span> <span class="c1">//互斥锁    
</span><span class="c1"></span>
<span class="o">-</span><span class="nl">notEmpty</span> <span class="p">:</span> <span class="n">Condition</span> <span class="c1">//            
</span><span class="c1"></span>
<span class="o">-</span><span class="nl">queue_</span><span class="p">:</span> <span class="n">std</span><span class="o">::</span><span class="n">deque</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="c1">//堆栈  
</span><span class="c1"></span>
<span class="o">---------------------------</span>            

<span class="o">&lt;&lt;</span><span class="n">create</span><span class="o">&gt;&gt;-</span><span class="n">BlockingQueue</span><span class="p">()</span>    

<span class="o">+</span><span class="n">put</span><span class="p">(</span><span class="nl">X</span><span class="p">:</span><span class="k">const</span> <span class="n">T</span><span class="o">&amp;</span><span class="p">)</span><span class="o">:</span><span class="kt">void</span>                

<span class="o">+</span><span class="n">take</span><span class="p">()</span><span class="o">:</span><span class="n">T</span>                                    

<span class="o">+</span><span class="n">size</span><span class="p">()</span><span class="o">:</span><span class="n">size_t</span>                                
</code></pre></td></tr></table>
</div>
</div>
<h3 id="blockingqueue的源文件">BlockingQueue的源文件:</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="c1">// that can be found in the License file.
</span><span class="c1">//
</span><span class="c1">// Author: Shuo Chen (chenshuo at chenshuo dot com)
</span><span class="c1"></span> 
<span class="err">#</span><span class="nx">ifndef</span> <span class="nx">MUDUO_BASE_BLOCKINGQUEUE_H</span>
<span class="err">#</span><span class="nx">define</span> <span class="nx">MUDUO_BASE_BLOCKINGQUEUE_H</span>
 
<span class="err">#</span><span class="nx">include</span> <span class="p">&lt;</span><span class="nx">muduo</span><span class="o">/</span><span class="nx">base</span><span class="o">/</span><span class="nx">Condition</span><span class="p">.</span><span class="nx">h</span><span class="p">&gt;</span>
<span class="err">#</span><span class="nx">include</span> <span class="p">&lt;</span><span class="nx">muduo</span><span class="o">/</span><span class="nx">base</span><span class="o">/</span><span class="nx">Mutex</span><span class="p">.</span><span class="nx">h</span><span class="p">&gt;</span>
 
<span class="err">#</span><span class="nx">include</span> <span class="p">&lt;</span><span class="nx">boost</span><span class="o">/</span><span class="nx">noncopyable</span><span class="p">.</span><span class="nx">hpp</span><span class="p">&gt;</span>
<span class="err">#</span><span class="nx">include</span> <span class="p">&lt;</span><span class="nx">deque</span><span class="p">&gt;</span>
<span class="err">#</span><span class="nx">include</span> <span class="p">&lt;</span><span class="nx">assert</span><span class="p">.</span><span class="nx">h</span><span class="p">&gt;</span>
 
<span class="cm">/**
</span><span class="cm">阻塞队列，无界限队列
</span><span class="cm"> 
</span><span class="cm">**/</span>
<span class="nx">namespace</span> <span class="nx">muduo</span>
<span class="p">{</span>
 
<span class="nx">template</span><span class="p">&lt;</span><span class="nx">typename</span> <span class="nx">T</span><span class="p">&gt;</span>  <span class="c1">//模板
</span><span class="c1"></span><span class="nx">class</span> <span class="nx">BlockingQueue</span> <span class="p">:</span> <span class="nx">boost</span><span class="p">::</span><span class="nx">noncopyable</span> <span class="c1">//不可复制的
</span><span class="c1"></span><span class="p">{</span>
 <span class="nx">public</span><span class="p">:</span>
  <span class="nf">BlockingQueue</span><span class="p">()</span> <span class="c1">//构造函数
</span><span class="c1"></span>    <span class="p">:</span> <span class="nf">mutex_</span><span class="p">(),</span> <span class="c1">//互斥量
</span><span class="c1"></span>      <span class="nf">notEmpty_</span><span class="p">(</span><span class="nx">mutex_</span><span class="p">),</span> <span class="c1">// 测试队列是否为空，在测试直线先加锁
</span><span class="c1"></span>      <span class="nf">queue_</span><span class="p">()</span>  <span class="c1">// 队列
</span><span class="c1"></span>  <span class="p">{</span>
  <span class="p">}</span>
 
    <span class="c1">//人队列
</span><span class="c1"></span>  <span class="nx">void</span> <span class="nf">put</span><span class="p">(</span><span class="kd">const</span> <span class="nx">T</span><span class="o">&amp;</span> <span class="nx">x</span><span class="p">)</span>
  <span class="p">{</span>
      <span class="c1">//先加锁
</span><span class="c1"></span>    <span class="nx">MutexLockGuard</span> <span class="nf">lock</span><span class="p">(</span><span class="nx">mutex_</span><span class="p">);</span>
    <span class="c1">//入栈
</span><span class="c1"></span>    <span class="nx">queue_</span><span class="p">.</span><span class="nf">push_back</span><span class="p">(</span><span class="nx">x</span><span class="p">);</span>
    <span class="c1">//发送信号
</span><span class="c1"></span>    <span class="nx">notEmpty_</span><span class="p">.</span><span class="nf">notify</span><span class="p">();</span> <span class="c1">// TODO: move outside of lock
</span><span class="c1"></span>  <span class="p">}</span>
    <span class="c1">//出队列
</span><span class="c1"></span>  <span class="nx">T</span> <span class="nf">take</span><span class="p">()</span>
  <span class="p">{</span>
      <span class="c1">//出栈前先加锁，防止出错
</span><span class="c1"></span>    <span class="nx">MutexLockGuard</span> <span class="nf">lock</span><span class="p">(</span><span class="nx">mutex_</span><span class="p">);</span>
    <span class="c1">// always use a while-loop, due to spurious wakeup
</span><span class="c1"></span>    <span class="c1">//如果队列为空，一直等待。。。。
</span><span class="c1"></span>    <span class="nf">while</span> <span class="p">(</span><span class="nx">queue_</span><span class="p">.</span><span class="nf">empty</span><span class="p">())</span>
    <span class="p">{</span>
      <span class="nx">notEmpty_</span><span class="p">.</span><span class="nf">wait</span><span class="p">();</span>
    <span class="p">}</span>
    <span class="c1">//断言队列是否为空
</span><span class="c1"></span>    <span class="nf">assert</span><span class="p">(!</span><span class="nx">queue_</span><span class="p">.</span><span class="nf">empty</span><span class="p">());</span>
    <span class="c1">//第一个元素出队列
</span><span class="c1"></span>    <span class="nx">T</span> <span class="nf">front</span><span class="p">(</span><span class="nx">queue_</span><span class="p">.</span><span class="nf">front</span><span class="p">());</span>
    <span class="nx">queue_</span><span class="p">.</span><span class="nf">pop_front</span><span class="p">();</span>
    <span class="k">return</span> <span class="nx">front</span><span class="p">;</span>
  <span class="p">}</span>
    <span class="c1">//队列的大小
</span><span class="c1"></span>  <span class="nx">size_t</span> <span class="nf">size</span><span class="p">()</span> <span class="kd">const</span>
  <span class="p">{</span>
    <span class="nx">MutexLockGuard</span> <span class="nf">lock</span><span class="p">(</span><span class="nx">mutex_</span><span class="p">);</span>
    <span class="k">return</span> <span class="nx">queue_</span><span class="p">.</span><span class="nf">size</span><span class="p">();</span>
  <span class="p">}</span>
 
 <span class="nx">private</span><span class="p">:</span>
     <span class="c1">//互斥量，主要是赋给 MutexLock---&gt;MutexLockGuard ---&gt;&amp;MutexLock
</span><span class="c1"></span>  <span class="nx">mutable</span> <span class="nx">MutexLock</span> <span class="nx">mutex_</span><span class="p">;</span>
  <span class="nx">Condition</span>         <span class="nx">notEmpty_</span><span class="p">;</span>
  <span class="nx">std</span><span class="p">::</span><span class="nx">deque</span><span class="p">&lt;</span><span class="nx">T</span><span class="p">&gt;</span>     <span class="nx">queue_</span><span class="p">;</span>
<span class="p">};</span>
 
<span class="p">}</span>
 
<span class="err">#</span><span class="nx">endif</span>  <span class="o">//</span> <span class="nx">MUDUO_BASE_BLOCKINGQUEUE_H</span></code></pre></td></tr></table>
</div>
</div>
<h3 id="blockingqueue的测试程序1">BlockingQueue的测试程序1:</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-c++" data-lang="c++"><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c++" data-lang="c++"><span class="cp">#include</span> <span class="cpf">&lt;muduo/base/BlockingQueue.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;muduo/base/CountDownLatch.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;muduo/base/Thread.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;muduo/base/Timestamp.h&gt;</span><span class="cp">
</span><span class="cp"></span> 
<span class="cp">#include</span> <span class="cpf">&lt;boost/bind.hpp&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;boost/ptr_container/ptr_vector.hpp&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;map&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;string&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
</span><span class="cp"></span><span class="cm">/*
</span><span class="cm"> BlockingQueue 的测试程序
</span><span class="cm">**/</span>
<span class="k">class</span><span class="err"> </span><span class="nc">Bench</span>
<span class="p">{</span>
 <span class="k">public</span><span class="o">:</span>
  <span class="n">Bench</span><span class="p">(</span><span class="kt">int</span> <span class="n">numThreads</span><span class="p">)</span>
    <span class="o">:</span> <span class="n">latch_</span><span class="p">(</span><span class="n">numThreads</span><span class="p">),</span> <span class="c1">//计算器为numThreads ，就是线程的个数
</span><span class="c1"></span>      <span class="n">threads_</span><span class="p">(</span><span class="n">numThreads</span><span class="p">)</span> <span class="c1">//线程容器的大小numThreads
</span><span class="c1"></span>  <span class="p">{</span>
     <span class="c1">//加入numThreads个线程
</span><span class="c1"></span>    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">numThreads</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="kt">char</span> <span class="n">name</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>
      <span class="n">snprintf</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="k">sizeof</span> <span class="n">name</span><span class="p">,</span> <span class="s">&#34;work thread %d&#34;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
      <span class="n">threads_</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="k">new</span> <span class="n">muduo</span><span class="o">::</span><span class="n">Thread</span><span class="p">(</span>
            <span class="n">boost</span><span class="o">::</span><span class="n">bind</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Bench</span><span class="o">::</span><span class="n">threadFunc</span><span class="p">,</span> <span class="k">this</span><span class="p">),</span> <span class="n">muduo</span><span class="o">::</span><span class="n">string</span><span class="p">(</span><span class="n">name</span><span class="p">)));</span>
    <span class="p">}</span>
    <span class="c1">//启动线程
</span><span class="c1"></span>    <span class="n">for_each</span><span class="p">(</span><span class="n">threads_</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span> <span class="n">threads_</span><span class="p">.</span><span class="n">end</span><span class="p">(),</span> <span class="n">boost</span><span class="o">::</span><span class="n">bind</span><span class="p">(</span><span class="o">&amp;</span><span class="n">muduo</span><span class="o">::</span><span class="n">Thread</span><span class="o">::</span><span class="n">start</span><span class="p">,</span> <span class="n">_1</span><span class="p">));</span>
  <span class="p">}</span>
<span class="cm">/*主线程的Run函数*/</span>
  <span class="kt">void</span> <span class="n">run</span><span class="p">(</span><span class="kt">int</span> <span class="n">times</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;waiting for count down latch</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
    <span class="c1">//等待计算器为0 ，就是所其他线程都准备好好，主线程才运行 ！
</span><span class="c1"></span>    <span class="n">latch_</span><span class="p">.</span><span class="n">wait</span><span class="p">();</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;all threads started</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
    <span class="c1">//想队列里面加入times个时间戳
</span><span class="c1"></span>    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">times</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">muduo</span><span class="o">::</span><span class="n">Timestamp</span> <span class="n">now</span><span class="p">(</span><span class="n">muduo</span><span class="o">::</span><span class="n">Timestamp</span><span class="o">::</span><span class="n">now</span><span class="p">());</span>
      <span class="n">queue_</span><span class="p">.</span><span class="n">put</span><span class="p">(</span><span class="n">now</span><span class="p">);</span>
      <span class="n">usleep</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>
 
  <span class="kt">void</span> <span class="n">joinAll</span><span class="p">()</span>
  <span class="p">{</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">size_t</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">threads_</span><span class="p">.</span><span class="n">size</span><span class="p">();</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">queue_</span><span class="p">.</span><span class="n">put</span><span class="p">(</span><span class="n">muduo</span><span class="o">::</span><span class="n">Timestamp</span><span class="o">::</span><span class="n">invalid</span><span class="p">());</span>
    <span class="p">}</span>
 
    <span class="n">for_each</span><span class="p">(</span><span class="n">threads_</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span> <span class="n">threads_</span><span class="p">.</span><span class="n">end</span><span class="p">(),</span> <span class="n">boost</span><span class="o">::</span><span class="n">bind</span><span class="p">(</span><span class="o">&amp;</span><span class="n">muduo</span><span class="o">::</span><span class="n">Thread</span><span class="o">::</span><span class="n">join</span><span class="p">,</span> <span class="n">_1</span><span class="p">));</span>
  <span class="p">}</span>
 
 <span class="k">private</span><span class="o">:</span>
<span class="c1">//线程的回调函数
</span><span class="c1"></span>  <span class="kt">void</span> <span class="n">threadFunc</span><span class="p">()</span>
  <span class="p">{</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;tid=%d, %s started</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span>
           <span class="n">muduo</span><span class="o">::</span><span class="n">CurrentThread</span><span class="o">::</span><span class="n">tid</span><span class="p">(),</span>
           <span class="n">muduo</span><span class="o">::</span><span class="n">CurrentThread</span><span class="o">::</span><span class="n">name</span><span class="p">());</span>
 
    <span class="n">std</span><span class="o">::</span><span class="n">map</span><span class="o">&lt;</span><span class="kt">int</span><span class="p">,</span> <span class="kt">int</span><span class="o">&gt;</span> <span class="n">delays</span><span class="p">;</span>
    <span class="c1">//协程的计算器-1
</span><span class="c1"></span>    <span class="n">latch_</span><span class="p">.</span><span class="n">countDown</span><span class="p">();</span>
    <span class="c1">//如果时间无效，则false
</span><span class="c1"></span>    <span class="kt">bool</span> <span class="n">running</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
    <span class="k">while</span> <span class="p">(</span><span class="n">running</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="c1">//时间戳 t ， now
</span><span class="c1"></span>      <span class="n">muduo</span><span class="o">::</span><span class="n">Timestamp</span> <span class="n">t</span><span class="p">(</span><span class="n">queue_</span><span class="p">.</span><span class="n">take</span><span class="p">());</span>
      <span class="n">muduo</span><span class="o">::</span><span class="n">Timestamp</span> <span class="n">now</span><span class="p">(</span><span class="n">muduo</span><span class="o">::</span><span class="n">Timestamp</span><span class="o">::</span><span class="n">now</span><span class="p">());</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">t</span><span class="p">.</span><span class="n">valid</span><span class="p">())</span>
      <span class="p">{</span>
        <span class="kt">int</span> <span class="n">delay</span> <span class="o">=</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="p">(</span><span class="n">timeDifference</span><span class="p">(</span><span class="n">now</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1000000</span><span class="p">);</span>
        <span class="c1">// printf(&#34;tid=%d, latency = %d us\n&#34;,
</span><span class="c1"></span>        <span class="c1">//        muduo::CurrentThread::tid(), delay);
</span><span class="c1"></span>        <span class="o">++</span><span class="n">delays</span><span class="p">[</span><span class="n">delay</span><span class="p">];</span>
      <span class="p">}</span>
      <span class="n">running</span> <span class="o">=</span> <span class="n">t</span><span class="p">.</span><span class="n">valid</span><span class="p">();</span>
    <span class="p">}</span>
 
    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;tid=%d, %s stopped</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span>
           <span class="n">muduo</span><span class="o">::</span><span class="n">CurrentThread</span><span class="o">::</span><span class="n">tid</span><span class="p">(),</span>
           <span class="n">muduo</span><span class="o">::</span><span class="n">CurrentThread</span><span class="o">::</span><span class="n">name</span><span class="p">());</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">map</span><span class="o">&lt;</span><span class="kt">int</span><span class="p">,</span> <span class="kt">int</span><span class="o">&gt;::</span><span class="n">iterator</span> <span class="n">it</span> <span class="o">=</span> <span class="n">delays</span><span class="p">.</span><span class="n">begin</span><span class="p">();</span>
        <span class="n">it</span> <span class="o">!=</span> <span class="n">delays</span><span class="p">.</span><span class="n">end</span><span class="p">();</span> <span class="o">++</span><span class="n">it</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">printf</span><span class="p">(</span><span class="s">&#34;tid = %d, delay = %d, count = %d</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span>
             <span class="n">muduo</span><span class="o">::</span><span class="n">CurrentThread</span><span class="o">::</span><span class="n">tid</span><span class="p">(),</span>
             <span class="n">it</span><span class="o">-&gt;</span><span class="n">first</span><span class="p">,</span> <span class="n">it</span><span class="o">-&gt;</span><span class="n">second</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>
 
  <span class="n">muduo</span><span class="o">::</span><span class="n">BlockingQueue</span><span class="o">&lt;</span><span class="n">muduo</span><span class="o">::</span><span class="n">Timestamp</span><span class="o">&gt;</span> <span class="n">queue_</span><span class="p">;</span> <span class="c1">// 无界限缓冲区
</span><span class="c1"></span>  <span class="n">muduo</span><span class="o">::</span><span class="n">CountDownLatch</span> <span class="n">latch_</span><span class="p">;</span>   <span class="c1">//线程同步类，协程
</span><span class="c1"></span>  <span class="n">boost</span><span class="o">::</span><span class="n">ptr_vector</span><span class="o">&lt;</span><span class="n">muduo</span><span class="o">::</span><span class="n">Thread</span><span class="o">&gt;</span> <span class="n">threads_</span><span class="p">;</span>  <span class="c1">//线程数目
</span><span class="c1"></span><span class="p">};</span>
 
<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span><span class="o">*</span> <span class="n">argv</span><span class="p">[])</span>
<span class="p">{</span>
    <span class="c1">// 线程的个数
</span><span class="c1"></span>  <span class="kt">int</span> <span class="n">threads</span> <span class="o">=</span> <span class="n">argc</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="o">?</span> <span class="n">atoi</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
 
  <span class="n">Bench</span> <span class="n">t</span><span class="p">(</span><span class="n">threads</span><span class="p">);</span>
  <span class="n">t</span><span class="p">.</span><span class="n">run</span><span class="p">(</span><span class="mi">10000</span><span class="p">);</span>
  <span class="n">t</span><span class="p">.</span><span class="n">joinAll</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div>
<h3 id="blockingqueue的测试程序2">BlockingQueue的测试程序2:</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span><span class="lnt">84
</span><span class="lnt">85
</span><span class="lnt">86
</span><span class="lnt">87
</span><span class="lnt">88
</span><span class="lnt">89
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="err">#</span><span class="nx">include</span> <span class="p">&lt;</span><span class="nx">muduo</span><span class="o">/</span><span class="nx">base</span><span class="o">/</span><span class="nx">BlockingQueue</span><span class="p">.</span><span class="nx">h</span><span class="p">&gt;</span>
<span class="err">#</span><span class="nx">include</span> <span class="p">&lt;</span><span class="nx">muduo</span><span class="o">/</span><span class="nx">base</span><span class="o">/</span><span class="nx">CountDownLatch</span><span class="p">.</span><span class="nx">h</span><span class="p">&gt;</span>
<span class="err">#</span><span class="nx">include</span> <span class="p">&lt;</span><span class="nx">muduo</span><span class="o">/</span><span class="nx">base</span><span class="o">/</span><span class="nx">Thread</span><span class="p">.</span><span class="nx">h</span><span class="p">&gt;</span>
 
<span class="err">#</span><span class="nx">include</span> <span class="p">&lt;</span><span class="nx">boost</span><span class="o">/</span><span class="nx">bind</span><span class="p">.</span><span class="nx">hpp</span><span class="p">&gt;</span>
<span class="err">#</span><span class="nx">include</span> <span class="p">&lt;</span><span class="nx">boost</span><span class="o">/</span><span class="nx">ptr_container</span><span class="o">/</span><span class="nx">ptr_vector</span><span class="p">.</span><span class="nx">hpp</span><span class="p">&gt;</span>
<span class="err">#</span><span class="nx">include</span> <span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;</span>
<span class="err">#</span><span class="nx">include</span> <span class="p">&lt;</span><span class="nx">stdio</span><span class="p">.</span><span class="nx">h</span><span class="p">&gt;</span>
 
<span class="nx">class</span> <span class="nx">Test</span>
<span class="p">{</span>
 <span class="nx">public</span><span class="p">:</span>
  <span class="nf">Test</span><span class="p">(</span><span class="kt">int</span> <span class="nx">numThreads</span><span class="p">)</span>
    <span class="p">:</span> <span class="nf">latch_</span><span class="p">(</span><span class="nx">numThreads</span><span class="p">),</span>
      <span class="nf">threads_</span><span class="p">(</span><span class="nx">numThreads</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="nx">i</span> <span class="p">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="p">&lt;</span> <span class="nx">numThreads</span><span class="p">;</span> <span class="o">++</span><span class="nx">i</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="nx">char</span> <span class="nx">name</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>
      <span class="nf">snprintf</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="nx">sizeof</span> <span class="nx">name</span><span class="p">,</span> <span class="s">&#34;work thread %d&#34;</span><span class="p">,</span> <span class="nx">i</span><span class="p">);</span>
      <span class="nx">threads_</span><span class="p">.</span><span class="nf">push_back</span><span class="p">(</span><span class="nx">new</span> <span class="nx">muduo</span><span class="p">::</span><span class="nf">Thread</span><span class="p">(</span>
            <span class="nx">boost</span><span class="p">::</span><span class="nf">bind</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">Test</span><span class="p">::</span><span class="nx">threadFunc</span><span class="p">,</span> <span class="nx">this</span><span class="p">),</span> <span class="nx">muduo</span><span class="p">::</span><span class="nb">string</span><span class="p">(</span><span class="nx">name</span><span class="p">)));</span>
    <span class="p">}</span>
    <span class="nf">for_each</span><span class="p">(</span><span class="nx">threads_</span><span class="p">.</span><span class="nf">begin</span><span class="p">(),</span> <span class="nx">threads_</span><span class="p">.</span><span class="nf">end</span><span class="p">(),</span> <span class="nx">boost</span><span class="p">::</span><span class="nf">bind</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">muduo</span><span class="p">::</span><span class="nx">Thread</span><span class="p">::</span><span class="nx">start</span><span class="p">,</span> <span class="nx">_1</span><span class="p">));</span>
  <span class="p">}</span>
 
  <span class="nx">void</span> <span class="nf">run</span><span class="p">(</span><span class="kt">int</span> <span class="nx">times</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;waiting for count down latch\n&#34;</span><span class="p">);</span>
    <span class="nx">latch_</span><span class="p">.</span><span class="nf">wait</span><span class="p">();</span>
    <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;all threads started\n&#34;</span><span class="p">);</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="nx">i</span> <span class="p">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="p">&lt;</span> <span class="nx">times</span><span class="p">;</span> <span class="o">++</span><span class="nx">i</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="nx">char</span> <span class="nx">buf</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>
      <span class="nf">snprintf</span><span class="p">(</span><span class="nx">buf</span><span class="p">,</span> <span class="nx">sizeof</span> <span class="nx">buf</span><span class="p">,</span> <span class="s">&#34;hello %d&#34;</span><span class="p">,</span> <span class="nx">i</span><span class="p">);</span>
      <span class="nx">queue_</span><span class="p">.</span><span class="nf">put</span><span class="p">(</span><span class="nx">buf</span><span class="p">);</span>
      <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;tid=%d, put data = %s, size = %zd\n&#34;</span><span class="p">,</span> <span class="nx">muduo</span><span class="p">::</span><span class="nx">CurrentThread</span><span class="p">::</span><span class="nf">tid</span><span class="p">(),</span> <span class="nx">buf</span><span class="p">,</span> <span class="nx">queue_</span><span class="p">.</span><span class="nf">size</span><span class="p">());</span>
    <span class="p">}</span>
  <span class="p">}</span>
 
  <span class="nx">void</span> <span class="nf">joinAll</span><span class="p">()</span>
  <span class="p">{</span>
    <span class="k">for</span> <span class="p">(</span><span class="nx">size_t</span> <span class="nx">i</span> <span class="p">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="p">&lt;</span> <span class="nx">threads_</span><span class="p">.</span><span class="nf">size</span><span class="p">();</span> <span class="o">++</span><span class="nx">i</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="c1">//加入线程终止条件“stop”标示
</span><span class="c1"></span>      <span class="nx">queue_</span><span class="p">.</span><span class="nf">put</span><span class="p">(</span><span class="s">&#34;stop&#34;</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="c1">//开启线程
</span><span class="c1"></span>    <span class="nf">for_each</span><span class="p">(</span><span class="nx">threads_</span><span class="p">.</span><span class="nf">begin</span><span class="p">(),</span> <span class="nx">threads_</span><span class="p">.</span><span class="nf">end</span><span class="p">(),</span> <span class="nx">boost</span><span class="p">::</span><span class="nf">bind</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">muduo</span><span class="p">::</span><span class="nx">Thread</span><span class="p">::</span><span class="nx">join</span><span class="p">,</span> <span class="nx">_1</span><span class="p">));</span>
  <span class="p">}</span>
 
 <span class="nx">private</span><span class="p">:</span>
 
  <span class="nx">void</span> <span class="nf">threadFunc</span><span class="p">()</span>
  <span class="p">{</span>
    <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;tid=%d, %s started\n&#34;</span><span class="p">,</span>
           <span class="nx">muduo</span><span class="p">::</span><span class="nx">CurrentThread</span><span class="p">::</span><span class="nf">tid</span><span class="p">(),</span>
           <span class="nx">muduo</span><span class="p">::</span><span class="nx">CurrentThread</span><span class="p">::</span><span class="nf">name</span><span class="p">());</span>
 
    <span class="nx">latch_</span><span class="p">.</span><span class="nf">countDown</span><span class="p">();</span>
    <span class="kt">bool</span> <span class="nx">running</span> <span class="p">=</span> <span class="kc">true</span><span class="p">;</span>
    <span class="nf">while</span> <span class="p">(</span><span class="nx">running</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="nx">std</span><span class="p">::</span><span class="kt">string</span> <span class="nf">d</span><span class="p">(</span><span class="nx">queue_</span><span class="p">.</span><span class="nf">take</span><span class="p">());</span>
      <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;tid=%d, get data = %s, size = %zd\n&#34;</span><span class="p">,</span> <span class="nx">muduo</span><span class="p">::</span><span class="nx">CurrentThread</span><span class="p">::</span><span class="nf">tid</span><span class="p">(),</span> <span class="nx">d</span><span class="p">.</span><span class="nf">c_str</span><span class="p">(),</span> <span class="nx">queue_</span><span class="p">.</span><span class="nf">size</span><span class="p">());</span>
      <span class="nx">running</span> <span class="p">=</span> <span class="p">(</span><span class="nx">d</span> <span class="o">!=</span> <span class="s">&#34;stop&#34;</span><span class="p">);</span>
    <span class="p">}</span>
 
    <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;tid=%d, %s stopped\n&#34;</span><span class="p">,</span>
           <span class="nx">muduo</span><span class="p">::</span><span class="nx">CurrentThread</span><span class="p">::</span><span class="nf">tid</span><span class="p">(),</span>
           <span class="nx">muduo</span><span class="p">::</span><span class="nx">CurrentThread</span><span class="p">::</span><span class="nf">name</span><span class="p">());</span>
  <span class="p">}</span>
 
  <span class="nx">muduo</span><span class="p">::</span><span class="nx">BlockingQueue</span><span class="p">&lt;</span><span class="nx">std</span><span class="p">::</span><span class="kt">string</span><span class="p">&gt;</span> <span class="nx">queue_</span><span class="p">;</span> <span class="c1">//队列 ，条件变量的测试量
</span><span class="c1"></span>  <span class="nx">muduo</span><span class="p">::</span><span class="nx">CountDownLatch</span> <span class="nx">latch_</span><span class="p">;</span> <span class="c1">//协程
</span><span class="c1"></span>  <span class="nx">boost</span><span class="p">::</span><span class="nx">ptr_vector</span><span class="p">&lt;</span><span class="nx">muduo</span><span class="p">::</span><span class="nx">Thread</span><span class="p">&gt;</span> <span class="nx">threads_</span><span class="p">;</span> <span class="c1">//线程个数
</span><span class="c1"></span><span class="p">};</span>
 
<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>
<span class="p">{</span>
  <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;pid=%d, tid=%d\n&#34;</span><span class="p">,</span> <span class="p">::</span><span class="nf">getpid</span><span class="p">(),</span> <span class="nx">muduo</span><span class="p">::</span><span class="nx">CurrentThread</span><span class="p">::</span><span class="nf">tid</span><span class="p">());</span>
  <span class="c1">//5个子线程
</span><span class="c1"></span>  <span class="nx">Test</span> <span class="nf">t</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>
  <span class="c1">//100容量的queue
</span><span class="c1"></span>  <span class="nx">t</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
  <span class="nx">t</span><span class="p">.</span><span class="nf">joinAll</span><span class="p">();</span>
 
  <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;number of created threads %d\n&#34;</span><span class="p">,</span> <span class="nx">muduo</span><span class="p">::</span><span class="nx">Thread</span><span class="p">::</span><span class="nf">numCreated</span><span class="p">());</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<h2 id="15-1-boundedblockingqueue">[15-1] BoundedBlockingQueue</h2>

<h3 id="boundedblockingqueue的类图">BoundedBlockingQueue的类图</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="o">-</span><span class="nx">mutex_</span><span class="p">:</span> <span class="nx">MutexLock</span>       <span class="c1">//  互斥量     |
</span><span class="c1"></span>
<span class="o">-</span><span class="nx">notEmppty_</span><span class="p">:</span><span class="nx">Condition</span>  <span class="c1">//消费者发送生产者的条件变量 |
</span><span class="c1"></span>
<span class="o">-</span><span class="nx">notFull_</span>    <span class="p">:</span> <span class="nx">Condition</span>  <span class="c1">//生产者发送给消费者的条件变量|
</span><span class="c1"></span>
<span class="o">-</span><span class="nx">queue_</span><span class="p">:</span><span class="nx">boost</span><span class="p">::</span><span class="nx">circular_buffer</span><span class="p">&lt;</span><span class="nx">T</span><span class="p">&gt;</span> <span class="c1">//虚唤醒队列            |
</span><span class="c1"></span>
<span class="o">--------------------------------------</span>

<span class="o">&lt;&lt;</span><span class="nx">create</span><span class="p">&gt;</span><span class="o">-</span><span class="nf">BoudedBlockingQueue</span><span class="p">(</span><span class="nx">maxSize</span><span class="p">:</span><span class="kt">int</span><span class="p">)</span> <span class="c1">//
</span><span class="c1"></span>
<span class="o">+</span><span class="nf">put</span><span class="p">(</span><span class="nx">x</span><span class="p">:</span><span class="nx">T</span><span class="p">)</span> <span class="p">:</span> <span class="nx">void</span>         <span class="c1">//入队列                                        |
</span><span class="c1"></span>
<span class="o">+</span><span class="nf">take</span><span class="p">():</span><span class="nx">T</span>                    <span class="c1">//出队列
</span><span class="c1"></span>
<span class="o">+</span><span class="nf">empty</span><span class="p">()</span> <span class="p">:</span><span class="kt">bool</span>         <span class="c1">//判断队列是否为空
</span><span class="c1"></span>
<span class="o">+</span><span class="nf">full</span><span class="p">():</span><span class="kt">bool</span>              <span class="c1">//判断队列是否满
</span><span class="c1"></span>
<span class="o">+</span><span class="nf">size</span><span class="p">()</span> <span class="p">:</span><span class="nx">size_t</span>             <span class="c1">//产品的多少
</span><span class="c1"></span>
<span class="o">+</span><span class="nf">capacity</span><span class="p">():</span><span class="nx">size_t</span>        <span class="o">//</span><span class="nx">仓库的容量</span></code></pre></td></tr></table>
</div>
</div>
<h3 id="boudedblockingqueue的源代码">BoudedBlockingQueue的源代码</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="c1">// Use of this source code is governed by a BSD-style license
</span><span class="c1">// that can be found in the License file.
</span><span class="c1">//
</span><span class="c1">// Author: Shuo Chen (chenshuo at chenshuo dot com)
</span><span class="c1"></span> 
<span class="err">#</span><span class="nx">ifndef</span> <span class="nx">MUDUO_BASE_BOUNDEDBLOCKINGQUEUE_H</span>
<span class="err">#</span><span class="nx">define</span> <span class="nx">MUDUO_BASE_BOUNDEDBLOCKINGQUEUE_H</span>
 
<span class="err">#</span><span class="nx">include</span> <span class="p">&lt;</span><span class="nx">muduo</span><span class="o">/</span><span class="nx">base</span><span class="o">/</span><span class="nx">Condition</span><span class="p">.</span><span class="nx">h</span><span class="p">&gt;</span>
<span class="err">#</span><span class="nx">include</span> <span class="p">&lt;</span><span class="nx">muduo</span><span class="o">/</span><span class="nx">base</span><span class="o">/</span><span class="nx">Mutex</span><span class="p">.</span><span class="nx">h</span><span class="p">&gt;</span>
 
<span class="err">#</span><span class="nx">include</span> <span class="p">&lt;</span><span class="nx">boost</span><span class="o">/</span><span class="nx">circular_buffer</span><span class="p">.</span><span class="nx">hpp</span><span class="p">&gt;</span>
<span class="err">#</span><span class="nx">include</span> <span class="p">&lt;</span><span class="nx">boost</span><span class="o">/</span><span class="nx">noncopyable</span><span class="p">.</span><span class="nx">hpp</span><span class="p">&gt;</span>
<span class="err">#</span><span class="nx">include</span> <span class="p">&lt;</span><span class="nx">assert</span><span class="p">.</span><span class="nx">h</span><span class="p">&gt;</span>
<span class="cm">/**
</span><span class="cm">有界缓冲区 ：
</span><span class="cm">Mutex + condition + circular_buffer 实现
</span><span class="cm">**/</span>
<span class="nx">namespace</span> <span class="nx">muduo</span>
<span class="p">{</span>
 
<span class="nx">template</span><span class="p">&lt;</span><span class="nx">typename</span> <span class="nx">T</span><span class="p">&gt;</span>
<span class="nx">class</span> <span class="nx">BoundedBlockingQueue</span> <span class="p">:</span> <span class="nx">boost</span><span class="p">::</span><span class="nx">noncopyable</span>
<span class="p">{</span>
 <span class="nx">public</span><span class="p">:</span>
  <span class="nx">explicit</span> <span class="nf">BoundedBlockingQueue</span><span class="p">(</span><span class="kt">int</span> <span class="nx">maxSize</span><span class="p">)</span>
    <span class="p">:</span> <span class="nf">mutex_</span><span class="p">(),</span> <span class="c1">//互斥量
</span><span class="c1"></span>      <span class="nf">notEmpty_</span><span class="p">(</span><span class="nx">mutex_</span><span class="p">),</span> <span class="c1">// 测试是否为空
</span><span class="c1"></span>      <span class="nf">notFull_</span><span class="p">(</span><span class="nx">mutex_</span><span class="p">),</span>  <span class="c1">// 测试是否已满
</span><span class="c1"></span>      <span class="nf">queue_</span><span class="p">(</span><span class="nx">maxSize</span><span class="p">)</span>    <span class="c1">// 返回队列的已被使用的大小
</span><span class="c1"></span>  <span class="p">{</span>
  <span class="p">}</span>
 
    <span class="c1">//把数据填充到队列中去
</span><span class="c1"></span>  <span class="nx">void</span> <span class="nf">put</span><span class="p">(</span><span class="kd">const</span> <span class="nx">T</span><span class="o">&amp;</span> <span class="nx">x</span><span class="p">)</span>
  <span class="p">{</span>
      <span class="c1">//先加锁
</span><span class="c1"></span>    <span class="nx">MutexLockGuard</span> <span class="nf">lock</span><span class="p">(</span><span class="nx">mutex_</span><span class="p">);</span>
      <span class="c1">//等待队列有空闲，直到notFull_.notify()信号的唤醒
</span><span class="c1"></span>    <span class="nf">while</span> <span class="p">(</span><span class="nx">queue_</span><span class="p">.</span><span class="nf">full</span><span class="p">())</span>
    <span class="p">{</span>
      <span class="nx">notFull_</span><span class="p">.</span><span class="nf">wait</span><span class="p">();</span>
    <span class="p">}</span>
    <span class="c1">//断言队列是否空（原子操作）
</span><span class="c1"></span>    <span class="nf">assert</span><span class="p">(!</span><span class="nx">queue_</span><span class="p">.</span><span class="nf">full</span><span class="p">());</span>
    <span class="c1">//
</span><span class="c1"></span>    <span class="nx">queue_</span><span class="p">.</span><span class="nf">push_back</span><span class="p">(</span><span class="nx">x</span><span class="p">);</span>
    <span class="c1">//通知
</span><span class="c1"></span>    <span class="nx">notEmpty_</span><span class="p">.</span><span class="nf">notify</span><span class="p">();</span> <span class="c1">// TODO: move outside of lock
</span><span class="c1"></span>  <span class="p">}</span>
    <span class="c1">//把数据从队列中提取出来
</span><span class="c1"></span>  <span class="nx">T</span> <span class="nf">take</span><span class="p">()</span>
  <span class="p">{</span>
      <span class="c1">//加锁
</span><span class="c1"></span>    <span class="nx">MutexLockGuard</span> <span class="nf">lock</span><span class="p">(</span><span class="nx">mutex_</span><span class="p">);</span>
    <span class="c1">//等待队列有数据，直到notEmpty_.notify()信号的唤醒
</span><span class="c1"></span>    <span class="nf">while</span> <span class="p">(</span><span class="nx">queue_</span><span class="p">.</span><span class="nf">empty</span><span class="p">())</span>
    <span class="p">{</span>
      <span class="nx">notEmpty_</span><span class="p">.</span><span class="nf">wait</span><span class="p">();</span>
    <span class="p">}</span>
    <span class="c1">//断言队列是否为空
</span><span class="c1"></span>    <span class="nf">assert</span><span class="p">(!</span><span class="nx">queue_</span><span class="p">.</span><span class="nf">empty</span><span class="p">());</span>
    <span class="c1">//出数据
</span><span class="c1"></span>    <span class="nx">T</span> <span class="nf">front</span><span class="p">(</span><span class="nx">queue_</span><span class="p">.</span><span class="nf">front</span><span class="p">());</span>
    <span class="nx">queue_</span><span class="p">.</span><span class="nf">pop_front</span><span class="p">();</span>
    <span class="c1">//发送notFull_.notify()信号
</span><span class="c1"></span>    <span class="nx">notFull_</span><span class="p">.</span><span class="nf">notify</span><span class="p">();</span> <span class="c1">// TODO: move outside of lock
</span><span class="c1"></span>    <span class="k">return</span> <span class="nx">front</span><span class="p">;</span>
  <span class="p">}</span>
 
    <span class="c1">//判断队列是否为空
</span><span class="c1"></span>  <span class="kt">bool</span> <span class="nf">empty</span><span class="p">()</span> <span class="kd">const</span>
  <span class="p">{</span>
      <span class="c1">//先加锁
</span><span class="c1"></span>    <span class="nx">MutexLockGuard</span> <span class="nf">lock</span><span class="p">(</span><span class="nx">mutex_</span><span class="p">);</span>
    <span class="k">return</span> <span class="nx">queue_</span><span class="p">.</span><span class="nf">empty</span><span class="p">();</span>
  <span class="p">}</span>
    <span class="c1">//判断队列是否已满
</span><span class="c1"></span>  <span class="kt">bool</span> <span class="nf">full</span><span class="p">()</span> <span class="kd">const</span>
  <span class="p">{</span>
      <span class="c1">//加锁
</span><span class="c1"></span>    <span class="nx">MutexLockGuard</span> <span class="nf">lock</span><span class="p">(</span><span class="nx">mutex_</span><span class="p">);</span>
    <span class="k">return</span> <span class="nx">queue_</span><span class="p">.</span><span class="nf">full</span><span class="p">();</span>
  <span class="p">}</span>
    <span class="c1">//数据的大小
</span><span class="c1"></span>  <span class="nx">size_t</span> <span class="nf">size</span><span class="p">()</span> <span class="kd">const</span>
  <span class="p">{</span>
    <span class="nx">MutexLockGuard</span> <span class="nf">lock</span><span class="p">(</span><span class="nx">mutex_</span><span class="p">);</span>
    <span class="k">return</span> <span class="nx">queue_</span><span class="p">.</span><span class="nf">size</span><span class="p">();</span>
  <span class="p">}</span>
    <span class="c1">//队列的容量大小
</span><span class="c1"></span>  <span class="nx">size_t</span> <span class="nf">capacity</span><span class="p">()</span> <span class="kd">const</span>
  <span class="p">{</span>
    <span class="nx">MutexLockGuard</span> <span class="nf">lock</span><span class="p">(</span><span class="nx">mutex_</span><span class="p">);</span>
    <span class="k">return</span> <span class="nx">queue_</span><span class="p">.</span><span class="nf">capacity</span><span class="p">();</span>
  <span class="p">}</span>
 
 <span class="nx">private</span><span class="p">:</span>
  <span class="nx">mutable</span> <span class="nx">MutexLock</span>          <span class="nx">mutex_</span><span class="p">;</span>
  <span class="nx">Condition</span>                  <span class="nx">notEmpty_</span><span class="p">;</span> <span class="c1">//两个条件变量
</span><span class="c1"></span>  <span class="nx">Condition</span>                  <span class="nx">notFull_</span><span class="p">;</span>  <span class="c1">//
</span><span class="c1"></span>  <span class="nx">boost</span><span class="p">::</span><span class="nx">circular_buffer</span><span class="p">&lt;</span><span class="nx">T</span><span class="p">&gt;</span>  <span class="nx">queue_</span><span class="p">;</span>
<span class="p">};</span>
 
<span class="p">}</span>
 
<span class="err">#</span><span class="nx">endif</span>  <span class="o">//</span> <span class="nx">MUDUO_BASE_BOUNDEDBLOCKINGQUEUE_H</span></code></pre></td></tr></table>
</div>
</div>
<h3 id="测试程序">测试程序</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="o">//</span> <span class="n">Use</span> <span class="n">of</span> <span class="n">this</span> <span class="n">source</span> <span class="n">code</span> <span class="ow">is</span> <span class="n">governed</span> <span class="n">by</span> <span class="n">a</span> <span class="n">BSD</span><span class="o">-</span><span class="n">style</span> <span class="n">license</span>
<span class="o">//</span> <span class="n">that</span> <span class="n">can</span> <span class="n">be</span> <span class="n">found</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">License</span> <span class="nb">file</span><span class="o">.</span>
<span class="o">//</span>
<span class="o">//</span> <span class="n">Author</span><span class="p">:</span> <span class="n">Shuo</span> <span class="n">Chen</span> <span class="p">(</span><span class="n">chenshuo</span> <span class="n">at</span> <span class="n">chenshuo</span> <span class="n">dot</span> <span class="n">com</span><span class="p">)</span>
 
<span class="c1">#ifndef MUDUO_BASE_BOUNDEDBLOCKINGQUEUE_H</span>
<span class="c1">#define MUDUO_BASE_BOUNDEDBLOCKINGQUEUE_H</span>
 
<span class="c1">#include &lt;muduo/base/Condition.h&gt;</span>
<span class="c1">#include &lt;muduo/base/Mutex.h&gt;</span>
 
<span class="c1">#include &lt;boost/circular_buffer.hpp&gt;</span>
<span class="c1">#include &lt;boost/noncopyable.hpp&gt;</span>
<span class="c1">#include &lt;assert.h&gt;</span>
<span class="o">/**</span>
<span class="err">有界缓冲区</span> <span class="err">：</span>
<span class="n">Mutex</span> <span class="o">+</span> <span class="n">condition</span> <span class="o">+</span> <span class="n">circular_buffer</span> <span class="err">实现</span>
<span class="err">函数功能，类消费者和生产者</span>
<span class="o">**/</span>
<span class="n">namespace</span> <span class="n">muduo</span>
<span class="p">{</span>
 
<span class="n">template</span><span class="o">&lt;</span><span class="n">typename</span> <span class="n">T</span><span class="o">&gt;</span>
<span class="k">class</span> <span class="nc">BoundedBlockingQueue</span> <span class="p">:</span> <span class="n">boost</span><span class="p">::</span><span class="n">noncopyable</span>
<span class="p">{</span>
 <span class="n">public</span><span class="p">:</span>
  <span class="n">explicit</span> <span class="n">BoundedBlockingQueue</span><span class="p">(</span><span class="nb">int</span> <span class="n">maxSize</span><span class="p">)</span>
    <span class="p">:</span> <span class="n">mutex_</span><span class="p">(),</span> <span class="o">//</span><span class="err">互斥量</span>
      <span class="n">notEmpty_</span><span class="p">(</span><span class="n">mutex_</span><span class="p">),</span> <span class="o">//</span> <span class="err">测试是否为空</span>
      <span class="n">notFull_</span><span class="p">(</span><span class="n">mutex_</span><span class="p">),</span>  <span class="o">//</span> <span class="err">测试是否已满</span>
      <span class="n">queue_</span><span class="p">(</span><span class="n">maxSize</span><span class="p">)</span>    <span class="o">//</span> <span class="err">返回队列的已被使用的大小</span>
  <span class="p">{</span>
  <span class="p">}</span>
 
    <span class="o">//</span><span class="err">把数据填充到队列中去</span>
  <span class="n">void</span> <span class="n">put</span><span class="p">(</span><span class="n">const</span> <span class="n">T</span><span class="o">&amp;</span> <span class="n">x</span><span class="p">)</span>
  <span class="p">{</span>
      <span class="o">//</span><span class="err">先加锁</span>
    <span class="n">MutexLockGuard</span> <span class="n">lock</span><span class="p">(</span><span class="n">mutex_</span><span class="p">);</span>
      <span class="o">//</span><span class="err">等待队列有空闲，直到</span><span class="n">notFull_</span><span class="o">.</span><span class="n">notify</span><span class="p">()</span><span class="err">信号的唤醒</span>
    <span class="k">while</span> <span class="p">(</span><span class="n">queue_</span><span class="o">.</span><span class="n">full</span><span class="p">())</span>
    <span class="p">{</span>
      <span class="n">notFull_</span><span class="o">.</span><span class="n">wait</span><span class="p">();</span>
    <span class="p">}</span>
    <span class="o">//</span><span class="err">断言队列是否空（原子操作）</span>
    <span class="k">assert</span><span class="p">(</span><span class="err">!</span><span class="n">queue_</span><span class="o">.</span><span class="n">full</span><span class="p">());</span>
    <span class="o">//</span>
    <span class="n">queue_</span><span class="o">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">x</span><span class="p">);</span>
    <span class="o">//</span><span class="err">通知</span>
    <span class="n">notEmpty_</span><span class="o">.</span><span class="n">notify</span><span class="p">();</span> <span class="o">//</span> <span class="n">TODO</span><span class="p">:</span> <span class="n">move</span> <span class="n">outside</span> <span class="n">of</span> <span class="n">lock</span>
  <span class="p">}</span>
    <span class="o">//</span><span class="err">把数据从队列中提取出来</span>
  <span class="n">T</span> <span class="n">take</span><span class="p">()</span>
  <span class="p">{</span>
      <span class="o">//</span><span class="err">加锁</span>
    <span class="n">MutexLockGuard</span> <span class="n">lock</span><span class="p">(</span><span class="n">mutex_</span><span class="p">);</span>
    <span class="o">//</span><span class="err">等待队列有数据，直到</span><span class="n">notEmpty_</span><span class="o">.</span><span class="n">notify</span><span class="p">()</span><span class="err">信号的唤醒</span>
    <span class="k">while</span> <span class="p">(</span><span class="n">queue_</span><span class="o">.</span><span class="n">empty</span><span class="p">())</span>
    <span class="p">{</span>
      <span class="n">notEmpty_</span><span class="o">.</span><span class="n">wait</span><span class="p">();</span>
    <span class="p">}</span>
    <span class="o">//</span><span class="err">断言队列是否为空</span>
    <span class="k">assert</span><span class="p">(</span><span class="err">!</span><span class="n">queue_</span><span class="o">.</span><span class="n">empty</span><span class="p">());</span>
    <span class="o">//</span><span class="err">出数据</span>
    <span class="n">T</span> <span class="n">front</span><span class="p">(</span><span class="n">queue_</span><span class="o">.</span><span class="n">front</span><span class="p">());</span>
    <span class="n">queue_</span><span class="o">.</span><span class="n">pop_front</span><span class="p">();</span>
    <span class="o">//</span><span class="err">发送</span><span class="n">notFull_</span><span class="o">.</span><span class="n">notify</span><span class="p">()</span><span class="err">信号</span>
    <span class="n">notFull_</span><span class="o">.</span><span class="n">notify</span><span class="p">();</span> <span class="o">//</span> <span class="n">TODO</span><span class="p">:</span> <span class="n">move</span> <span class="n">outside</span> <span class="n">of</span> <span class="n">lock</span>
    <span class="k">return</span> <span class="n">front</span><span class="p">;</span>
  <span class="p">}</span>
 
    <span class="o">//</span><span class="err">判断队列是否为空</span>
  <span class="nb">bool</span> <span class="n">empty</span><span class="p">()</span> <span class="n">const</span>
  <span class="p">{</span>
      <span class="o">//</span><span class="err">先加锁</span>
    <span class="n">MutexLockGuard</span> <span class="n">lock</span><span class="p">(</span><span class="n">mutex_</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">queue_</span><span class="o">.</span><span class="n">empty</span><span class="p">();</span>
  <span class="p">}</span>
    <span class="o">//</span><span class="err">判断队列是否已满</span>
  <span class="nb">bool</span> <span class="n">full</span><span class="p">()</span> <span class="n">const</span>
  <span class="p">{</span>
      <span class="o">//</span><span class="err">加锁</span>
    <span class="n">MutexLockGuard</span> <span class="n">lock</span><span class="p">(</span><span class="n">mutex_</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">queue_</span><span class="o">.</span><span class="n">full</span><span class="p">();</span>
  <span class="p">}</span>
    <span class="o">//</span><span class="err">数据的大小</span>
  <span class="n">size_t</span> <span class="n">size</span><span class="p">()</span> <span class="n">const</span>
  <span class="p">{</span>
    <span class="n">MutexLockGuard</span> <span class="n">lock</span><span class="p">(</span><span class="n">mutex_</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">queue_</span><span class="o">.</span><span class="n">size</span><span class="p">();</span>
  <span class="p">}</span>
    <span class="o">//</span><span class="err">队列的容量大小</span>
  <span class="n">size_t</span> <span class="n">capacity</span><span class="p">()</span> <span class="n">const</span>
  <span class="p">{</span>
    <span class="n">MutexLockGuard</span> <span class="n">lock</span><span class="p">(</span><span class="n">mutex_</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">queue_</span><span class="o">.</span><span class="n">capacity</span><span class="p">();</span>
  <span class="p">}</span>
 
 <span class="n">private</span><span class="p">:</span>
  <span class="n">mutable</span> <span class="n">MutexLock</span>          <span class="n">mutex_</span><span class="p">;</span>
  <span class="n">Condition</span>                  <span class="n">notEmpty_</span><span class="p">;</span> <span class="o">//</span><span class="err">两个条件变量</span>
  <span class="n">Condition</span>                  <span class="n">notFull_</span><span class="p">;</span>  <span class="o">//</span>
  <span class="n">boost</span><span class="p">::</span><span class="n">circular_buffer</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span>  <span class="n">queue_</span><span class="p">;</span>
<span class="p">};</span>
 
<span class="p">}</span>
 
<span class="c1">#endif  // MUDUO_BASE_BOUNDEDBLOCKINGQUEUE_H</span></code></pre></td></tr></table>
</div>
</div>
<h2 id="16-threadpool">[16] ThreadPool</h2>

<p><center><img src="http://laohanlinux.github.io/images/img/blog/muduo_base_library/ThreadPool.png" alt="" /></center></p>

<h3 id="threadpool类图">threadPool类图</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-c++" data-lang="c++"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c++" data-lang="c++"><span class="o">-</span><span class="nl">mutex_</span><span class="p">:</span><span class="n">MutexLock</span>  <span class="c1">//互斥量 ---&gt; mutexlock---&gt;mutexlockGuard
</span><span class="c1"></span><span class="o">-</span><span class="nl">cond_</span><span class="p">:</span><span class="n">Codition</span> <span class="c1">//条件变量
</span><span class="c1"></span><span class="o">-</span><span class="nl">name</span><span class="p">:</span><span class="n">string</span>    <span class="c1">//名字
</span><span class="c1"></span><span class="o">-</span><span class="nl">threads_</span><span class="p">:</span><span class="n">boost</span><span class="o">::</span><span class="n">ptr_vector</span><span class="o">&lt;</span><span class="n">muduo</span><span class="o">::</span><span class="n">Thread</span><span class="o">&gt;</span> <span class="c1">//线程池容量
</span><span class="c1"></span><span class="o">-</span><span class="nl">queue_</span><span class="p">:</span> <span class="n">std</span><span class="o">::</span><span class="n">deque</span><span class="o">&lt;</span><span class="n">Task</span><span class="o">&gt;</span>    <span class="c1">//任务队列，任务我们把他作为“函数”
</span><span class="c1"></span><span class="o">-</span><span class="nl">running_</span> <span class="p">:</span><span class="kt">bool</span>        <span class="c1">// 线程池是否运行
</span><span class="c1"></span><span class="o">-----------------------------</span>
<span class="o">&lt;&lt;</span><span class="n">create</span><span class="o">&gt;&gt;-</span><span class="n">ThreadPool</span><span class="p">(</span><span class="nl">name</span><span class="p">:</span><span class="n">string</span><span class="p">)</span>
<span class="o">&lt;&lt;</span><span class="n">destroy</span><span class="o">&gt;&gt;-</span><span class="n">ThreadPool</span><span class="p">()</span>
<span class="o">+</span><span class="n">start</span><span class="p">(</span><span class="nl">numThreads</span><span class="p">:</span><span class="kt">int</span><span class="p">)</span><span class="o">:</span><span class="kt">void</span><span class="c1">// 启动线程池
</span><span class="c1"></span><span class="o">+</span><span class="n">stop</span><span class="p">()</span><span class="o">:</span><span class="kt">void</span>            <span class="c1">//关闭线程池
</span><span class="c1"></span><span class="o">+</span><span class="n">run</span><span class="p">(</span><span class="nl">f</span><span class="p">:</span><span class="n">Task</span><span class="p">)</span><span class="o">:</span><span class="kt">void</span> <span class="c1">//    启动
</span><span class="c1"></span><span class="o">+</span><span class="n">runInThread</span><span class="p">()</span><span class="o">:</span><span class="kt">void</span> <span class="c1">//线程池中的线程的回调函数
</span><span class="c1"></span><span class="o">+</span><span class="n">take</span><span class="p">()</span><span class="o">:</span><span class="n">Task</span>         <span class="c1">// 获取任务
</span></code></pre></td></tr></table>
</div>
</div>
<h3 id="threadpool头文件">ThreadPool头文件</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="c1">// Use of this source code is governed by a BSD-style license
</span><span class="c1">// that can be found in the License file.
</span><span class="c1">//
</span><span class="c1">// Author: Shuo Chen (chenshuo at chenshuo dot com)
</span><span class="c1"></span> 
<span class="err">#</span><span class="nx">ifndef</span> <span class="nx">MUDUO_BASE_THREADPOOL_H</span>
<span class="err">#</span><span class="nx">define</span> <span class="nx">MUDUO_BASE_THREADPOOL_H</span>
 
<span class="err">#</span><span class="nx">include</span> <span class="p">&lt;</span><span class="nx">muduo</span><span class="o">/</span><span class="nx">base</span><span class="o">/</span><span class="nx">Condition</span><span class="p">.</span><span class="nx">h</span><span class="p">&gt;</span>
<span class="err">#</span><span class="nx">include</span> <span class="p">&lt;</span><span class="nx">muduo</span><span class="o">/</span><span class="nx">base</span><span class="o">/</span><span class="nx">Mutex</span><span class="p">.</span><span class="nx">h</span><span class="p">&gt;</span>
 
 
<span class="err">#</span><span class="nx">include</span> <span class="p">&lt;</span><span class="nx">muduo</span><span class="o">/</span><span class="nx">base</span><span class="o">/</span><span class="nx">Thread</span><span class="p">.</span><span class="nx">h</span><span class="p">&gt;</span>
<span class="err">#</span><span class="nx">include</span> <span class="p">&lt;</span><span class="nx">muduo</span><span class="o">/</span><span class="nx">base</span><span class="o">/</span><span class="nx">Types</span><span class="p">.</span><span class="nx">h</span><span class="p">&gt;</span>
 
<span class="err">#</span><span class="nx">include</span> <span class="p">&lt;</span><span class="nx">boost</span><span class="o">/</span><span class="nx">function</span><span class="p">.</span><span class="nx">hpp</span><span class="p">&gt;</span>
<span class="err">#</span><span class="nx">include</span> <span class="p">&lt;</span><span class="nx">boost</span><span class="o">/</span><span class="nx">noncopyable</span><span class="p">.</span><span class="nx">hpp</span><span class="p">&gt;</span>
<span class="err">#</span><span class="nx">include</span> <span class="p">&lt;</span><span class="nx">boost</span><span class="o">/</span><span class="nx">ptr_container</span><span class="o">/</span><span class="nx">ptr_vector</span><span class="p">.</span><span class="nx">hpp</span><span class="p">&gt;</span>
 
<span class="err">#</span><span class="nx">include</span> <span class="p">&lt;</span><span class="nx">deque</span><span class="p">&gt;</span>
 
<span class="nx">namespace</span> <span class="nx">muduo</span>
<span class="p">{</span>
 
<span class="nx">class</span> <span class="nx">ThreadPool</span> <span class="p">:</span> <span class="nx">boost</span><span class="p">::</span><span class="nx">noncopyable</span> <span class="c1">//不可复制
</span><span class="c1"></span><span class="p">{</span>
 <span class="nx">public</span><span class="p">:</span>
  <span class="nx">typedef</span> <span class="nx">boost</span><span class="p">::</span><span class="nx">function</span><span class="p">&lt;</span><span class="nf">void</span> <span class="p">()&gt;</span> <span class="nx">Task</span><span class="p">;</span>
 
  <span class="nx">explicit</span> <span class="nf">ThreadPool</span><span class="p">(</span><span class="kd">const</span> <span class="kt">string</span><span class="o">&amp;</span> <span class="nx">name</span> <span class="p">=</span> <span class="nb">string</span><span class="p">());</span>
  <span class="err">~</span><span class="nf">ThreadPool</span><span class="p">();</span>
 
  <span class="nx">void</span> <span class="nf">start</span><span class="p">(</span><span class="kt">int</span> <span class="nx">numThreads</span><span class="p">);</span>
  <span class="nx">void</span> <span class="nf">stop</span><span class="p">();</span>
 
  <span class="nx">void</span> <span class="nf">run</span><span class="p">(</span><span class="kd">const</span> <span class="nx">Task</span><span class="o">&amp;</span> <span class="nx">f</span><span class="p">);</span>
 
 <span class="nx">private</span><span class="p">:</span>
  <span class="nx">void</span> <span class="nf">runInThread</span><span class="p">();</span>
  <span class="nx">Task</span> <span class="nf">take</span><span class="p">();</span>
 
  <span class="nx">MutexLock</span> <span class="nx">mutex_</span><span class="p">;</span>
  <span class="nx">Condition</span> <span class="nx">cond_</span><span class="p">;</span>
  <span class="kt">string</span> <span class="nx">name_</span><span class="p">;</span>
  <span class="nx">boost</span><span class="p">::</span><span class="nx">ptr_vector</span><span class="p">&lt;</span><span class="nx">muduo</span><span class="p">::</span><span class="nx">Thread</span><span class="p">&gt;</span> <span class="nx">threads_</span><span class="p">;</span>
  <span class="nx">std</span><span class="p">::</span><span class="nx">deque</span><span class="p">&lt;</span><span class="nx">Task</span><span class="p">&gt;</span> <span class="nx">queue_</span><span class="p">;</span> <span class="c1">//线程池的任务队列
</span><span class="c1"></span>  <span class="kt">bool</span> <span class="nx">running_</span><span class="p">;</span><span class="c1">//线程池是否处于启动状态
</span><span class="c1"></span><span class="p">};</span>
 
<span class="p">}</span>
 
<span class="err">#</span><span class="nx">endif</span></code></pre></td></tr></table>
</div>
</div>
<h3 id="threadpool的源文件">ThreadPool的源文件</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-c++" data-lang="c++"><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c++" data-lang="c++"><span class="c1">// Use of this source code is governed by a BSD-style license
</span><span class="c1">// that can be found in the License file.
</span><span class="c1">//
</span><span class="c1">// Author: Shuo Chen (chenshuo at chenshuo dot com)
</span><span class="c1"></span> 
<span class="cp">#include</span> <span class="cpf">&lt;muduo/base/ThreadPool.h&gt;</span><span class="cp">
</span><span class="cp"></span> 
<span class="cp">#include</span> <span class="cpf">&lt;muduo/base/Exception.h&gt;</span><span class="cp">
</span><span class="cp"></span> 
<span class="cp">#include</span> <span class="cpf">&lt;boost/bind.hpp&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;assert.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
</span><span class="cp"></span> 
<span class="k">using</span> <span class="k">namespace</span> <span class="n">muduo</span><span class="p">;</span>
 
<span class="n">ThreadPool</span><span class="o">::</span><span class="n">ThreadPool</span><span class="p">(</span><span class="k">const</span> <span class="n">string</span><span class="o">&amp;</span> <span class="n">name</span><span class="p">)</span>
  <span class="o">:</span> <span class="n">mutex_</span><span class="p">(),</span> <span class="c1">//初始化互斥量
</span><span class="c1"></span>    <span class="n">cond_</span><span class="p">(</span><span class="n">mutex_</span><span class="p">),</span> <span class="c1">//互斥量跟条件变量进行绑定
</span><span class="c1"></span>    <span class="n">name_</span><span class="p">(</span><span class="n">name</span><span class="p">),</span>
    <span class="n">running_</span><span class="p">(</span><span class="nb">false</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>
<span class="c1">//线程池的虚构
</span><span class="c1"></span><span class="n">ThreadPool</span><span class="o">::~</span><span class="n">ThreadPool</span><span class="p">()</span>
<span class="p">{</span>
    <span class="c1">//如果线程池处于运行状态，关闭线程池里的线程
</span><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="n">running_</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">stop</span><span class="p">();</span>
  <span class="p">}</span>
<span class="p">}</span>
<span class="c1">//1-----&gt;&gt;启动线程池
</span><span class="c1"></span><span class="kt">void</span> <span class="n">ThreadPool</span><span class="o">::</span><span class="n">start</span><span class="p">(</span><span class="kt">int</span> <span class="n">numThreads</span><span class="p">)</span>
<span class="p">{</span>
    <span class="c1">//断言线程池是否为空
</span><span class="c1"></span>  <span class="n">assert</span><span class="p">(</span><span class="n">threads_</span><span class="p">.</span><span class="n">empty</span><span class="p">());</span>
  <span class="c1">//启动线程池
</span><span class="c1"></span>  <span class="n">running_</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
  <span class="c1">//开辟numThreads个容量的线程池
</span><span class="c1"></span>  <span class="n">threads_</span><span class="p">.</span><span class="n">reserve</span><span class="p">(</span><span class="n">numThreads</span><span class="p">);</span>
  <span class="c1">//生产线程，这些线程可以说就是“消费者”
</span><span class="c1"></span>  <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">numThreads</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="kt">char</span> <span class="n">id</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>
    <span class="n">snprintf</span><span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="k">sizeof</span> <span class="n">id</span><span class="p">,</span> <span class="s">&#34;%d&#34;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
    <span class="n">threads_</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="k">new</span> <span class="n">muduo</span><span class="o">::</span><span class="n">Thread</span><span class="p">(</span>
        <span class="c1">//线程池里的线程的回调函数  runInThread
</span><span class="c1"></span>          <span class="n">boost</span><span class="o">::</span><span class="n">bind</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ThreadPool</span><span class="o">::</span><span class="n">runInThread</span><span class="p">,</span> <span class="k">this</span><span class="p">),</span> <span class="n">name_</span><span class="o">+</span><span class="n">id</span><span class="p">));</span>
    <span class="c1">//启动线程
</span><span class="c1"></span>    <span class="n">threads_</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">start</span><span class="p">();</span>
  <span class="p">}</span>
<span class="p">}</span>
 
<span class="cm">/**
</span><span class="cm">停止线程池里的线程
</span><span class="cm">***/</span>
<span class="kt">void</span> <span class="n">ThreadPool</span><span class="o">::</span><span class="n">stop</span><span class="p">()</span>
<span class="p">{</span>
  <span class="p">{</span>
      <span class="c1">//加锁
</span><span class="c1"></span>  <span class="n">MutexLockGuard</span> <span class="n">lock</span><span class="p">(</span><span class="n">mutex_</span><span class="p">);</span>
  <span class="n">running_</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
    <span class="c1">//唤醒线程
</span><span class="c1"></span>  <span class="n">cond_</span><span class="p">.</span><span class="n">notifyAll</span><span class="p">();</span>
  <span class="p">}</span>
  <span class="c1">//把线程加入退出队列
</span><span class="c1"></span>  <span class="n">for_each</span><span class="p">(</span><span class="n">threads_</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span>
           <span class="n">threads_</span><span class="p">.</span><span class="n">end</span><span class="p">(),</span>
           <span class="n">boost</span><span class="o">::</span><span class="n">bind</span><span class="p">(</span><span class="o">&amp;</span><span class="n">muduo</span><span class="o">::</span><span class="n">Thread</span><span class="o">::</span><span class="n">join</span><span class="p">,</span> <span class="n">_1</span><span class="p">));</span>
<span class="p">}</span>
<span class="c1">//4----&gt;&gt;&gt; 启动线程池
</span><span class="c1"></span><span class="kt">void</span> <span class="n">ThreadPool</span><span class="o">::</span><span class="n">run</span><span class="p">(</span><span class="k">const</span> <span class="n">Task</span><span class="o">&amp;</span> <span class="n">task</span><span class="p">)</span>
<span class="p">{</span>
    <span class="c1">//如果线程池没有线程，那么直接执行任务，也就是说假设没有消费者，那么生产者直接消费产品.
</span><span class="c1"></span>    <span class="c1">//而不把任务加入任务队列
</span><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="n">threads_</span><span class="p">.</span><span class="n">empty</span><span class="p">())</span>
  <span class="p">{</span>
    <span class="n">task</span><span class="p">();</span>
  <span class="p">}</span>
  <span class="c1">//如果线程池有线程
</span><span class="c1"></span>  <span class="k">else</span>
  <span class="p">{</span>
      <span class="c1">//加锁
</span><span class="c1"></span>    <span class="n">MutexLockGuard</span> <span class="n">lock</span><span class="p">(</span><span class="n">mutex_</span><span class="p">);</span>
        <span class="c1">//加入任务队列
</span><span class="c1"></span>    <span class="n">queue_</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">task</span><span class="p">);</span>
    <span class="c1">//唤醒
</span><span class="c1"></span>    <span class="n">cond_</span><span class="p">.</span><span class="n">notify</span><span class="p">();</span>
  <span class="p">}</span>
<span class="p">}</span>
<span class="c1">//3-----&gt;&gt;&gt; 这是一个任务分配函数，线程池函数或者线程池里面的函数都可以到这里取出一个任务，然后在自己的线程中执行这和任务，返回一个任务指针
</span><span class="c1"></span><span class="n">ThreadPool</span><span class="o">::</span><span class="n">Task</span> <span class="n">ThreadPool</span><span class="o">::</span><span class="n">take</span><span class="p">()</span>
<span class="p">{</span>
  <span class="n">MutexLockGuard</span> <span class="n">lock</span><span class="p">(</span><span class="n">mutex_</span><span class="p">);</span>
  <span class="c1">// always use a while-loop, due to spurious wakeup
</span><span class="c1"></span>  <span class="c1">//防止假唤醒,running_ 用来接收线程池发送的“线程退出”命令
</span><span class="c1"></span>  <span class="k">while</span> <span class="p">(</span><span class="n">queue_</span><span class="p">.</span><span class="n">empty</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="n">running_</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">cond_</span><span class="p">.</span><span class="n">wait</span><span class="p">();</span>
  <span class="p">}</span>
  <span class="n">Task</span> <span class="n">task</span><span class="p">;</span>
  <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">queue_</span><span class="p">.</span><span class="n">empty</span><span class="p">())</span>
  <span class="p">{</span>
    <span class="n">task</span> <span class="o">=</span> <span class="n">queue_</span><span class="p">.</span><span class="n">front</span><span class="p">();</span>
    <span class="n">queue_</span><span class="p">.</span><span class="n">pop_front</span><span class="p">();</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="n">task</span><span class="p">;</span>
<span class="p">}</span>
 
<span class="c1">//2----&gt;&gt;线程池（可以把他当做主线程进行理解）里的线程的回调函数，可以在线程池函数中执行一些任务，并不是说只有线程池里面的函数才能执行任务，这能达到负载均衡的效果
</span><span class="c1"></span><span class="kt">void</span> <span class="n">ThreadPool</span><span class="o">::</span><span class="n">runInThread</span><span class="p">()</span>
<span class="p">{</span>
  <span class="k">try</span>
  <span class="p">{</span>
        <span class="c1">//测试线程池是否在运行 ，不运行马上停止线程池
</span><span class="c1"></span>    <span class="k">while</span> <span class="p">(</span><span class="n">running_</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">Task</span> <span class="n">task</span><span class="p">(</span><span class="n">take</span><span class="p">());</span> <span class="c1">//任务是函数，task == 函数指针
</span><span class="c1"></span>      <span class="k">if</span> <span class="p">(</span><span class="n">task</span><span class="p">)</span>
      <span class="p">{</span><span class="c1">//执行任务，消费产品
</span><span class="c1"></span>        <span class="n">task</span><span class="p">();</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="k">catch</span> <span class="p">(</span><span class="k">const</span> <span class="n">Exception</span><span class="o">&amp;</span> <span class="n">ex</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&#34;exception caught in ThreadPool %s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">name_</span><span class="p">.</span><span class="n">c_str</span><span class="p">());</span>
    <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&#34;reason: %s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">ex</span><span class="p">.</span><span class="n">what</span><span class="p">());</span>
    <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&#34;stack trace: %s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">ex</span><span class="p">.</span><span class="n">stackTrace</span><span class="p">());</span>
    <span class="n">abort</span><span class="p">();</span>
  <span class="p">}</span>
  <span class="k">catch</span> <span class="p">(</span><span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">exception</span><span class="o">&amp;</span> <span class="n">ex</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&#34;exception caught in ThreadPool %s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">name_</span><span class="p">.</span><span class="n">c_str</span><span class="p">());</span>
    <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&#34;reason: %s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">ex</span><span class="p">.</span><span class="n">what</span><span class="p">());</span>
    <span class="n">abort</span><span class="p">();</span>
  <span class="p">}</span>
  <span class="k">catch</span> <span class="p">(...)</span>
  <span class="p">{</span>
    <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&#34;unknown exception caught in ThreadPool %s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">name_</span><span class="p">.</span><span class="n">c_str</span><span class="p">());</span>
    <span class="k">throw</span><span class="p">;</span> <span class="c1">// rethrow
</span><span class="c1"></span>  <span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div>
<h3 id="threadpool的测试程序">ThreadPool的测试程序</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-c++" data-lang="c++"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c++" data-lang="c++"><span class="cp">#include</span> <span class="cpf">&lt;muduo/base/ThreadPool.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;muduo/base/CountDownLatch.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;muduo/base/CurrentThread.h&gt;</span><span class="cp">
</span><span class="cp"></span> 
<span class="cp">#include</span> <span class="cpf">&lt;boost/bind.hpp&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
</span><span class="cp"></span> 
<span class="kt">void</span> <span class="nf">print</span><span class="p">()</span>
<span class="p">{</span>
  <span class="n">printf</span><span class="p">(</span><span class="s">&#34;tid=%d</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">muduo</span><span class="o">::</span><span class="n">CurrentThread</span><span class="o">::</span><span class="n">tid</span><span class="p">());</span>
<span class="p">}</span>
 
<span class="kt">void</span> <span class="nf">printString</span><span class="p">(</span><span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span> <span class="n">str</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">printf</span><span class="p">(</span><span class="s">&#34;tid=%d, str=%s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">muduo</span><span class="o">::</span><span class="n">CurrentThread</span><span class="o">::</span><span class="n">tid</span><span class="p">(),</span> <span class="n">str</span><span class="p">.</span><span class="n">c_str</span><span class="p">());</span>
<span class="p">}</span>
 
<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>
<span class="p">{</span>
  <span class="n">muduo</span><span class="o">::</span><span class="n">ThreadPool</span> <span class="n">pool</span><span class="p">(</span><span class="s">&#34;MainThreadPool&#34;</span><span class="p">);</span>
  <span class="n">pool</span><span class="p">.</span><span class="n">start</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>
 
  <span class="n">pool</span><span class="p">.</span><span class="n">run</span><span class="p">(</span><span class="n">print</span><span class="p">);</span>
  <span class="n">pool</span><span class="p">.</span><span class="n">run</span><span class="p">(</span><span class="n">print</span><span class="p">);</span>
  <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>
    <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span> <span class="n">buf</span><span class="p">,</span> <span class="s">&#34;task %d&#34;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
    <span class="n">pool</span><span class="p">.</span><span class="n">run</span><span class="p">(</span><span class="n">boost</span><span class="o">::</span><span class="n">bind</span><span class="p">(</span><span class="n">printString</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="p">(</span><span class="n">buf</span><span class="p">)));</span>
  <span class="p">}</span>
 <span class="c1">//CountDowndLatch 作文任务放进去，子线会执行，然后唤醒pool，pool就会调用stop停止线程池
</span><span class="c1"></span>  <span class="n">muduo</span><span class="o">::</span><span class="n">CountDownLatch</span> <span class="n">latch</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
  <span class="n">pool</span><span class="p">.</span><span class="n">run</span><span class="p">(</span><span class="n">boost</span><span class="o">::</span><span class="n">bind</span><span class="p">(</span><span class="o">&amp;</span><span class="n">muduo</span><span class="o">::</span><span class="n">CountDownLatch</span><span class="o">::</span><span class="n">countDown</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">latch</span><span class="p">));</span>
  <span class="n">latch</span><span class="p">.</span><span class="n">wait</span><span class="p">();</span>
  <span class="n">pool</span><span class="p">.</span><span class="n">stop</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div>
<h2 id="17-singleton">[17] Singleton</h2>

<h3 id="singleton-class-uml">Singleton class uml</h3>

<p><center><img src="http://laohanlinux.github.io/images/img/blog/muduo_base_library/singleton.png" alt="" /></center></p>

<h3 id="singleton源代码">Singleton源代码</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-c++" data-lang="c++"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c++" data-lang="c++"><span class="c1">// Use of this source code is governed by a BSD-style license
</span><span class="c1">// that can be found in the License file.
</span><span class="c1">//
</span><span class="c1">// Author: Shuo Chen (chenshuo at chenshuo dot com)
</span><span class="c1"></span> 
<span class="cp">#ifndef MUDUO_BASE_SINGLETON_H
</span><span class="cp">#define MUDUO_BASE_SINGLETON_H
</span><span class="cp"></span> 
<span class="cp">#include</span> <span class="cpf">&lt;boost/noncopyable.hpp&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;pthread.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;stdlib.h&gt; // atexit</span><span class="cp">
</span><span class="cp"></span> 
<span class="k">namespace</span> <span class="n">muduo</span>
<span class="p">{</span>
 
<span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="o">&gt;</span>
<span class="k">class</span><span class="err"> </span><span class="nc">Singleton</span> <span class="o">:</span> <span class="n">boost</span><span class="o">::</span><span class="n">noncopyable</span> <span class="c1">//不可复制的
</span><span class="c1"></span><span class="p">{</span>
 <span class="k">public</span><span class="o">:</span>
  <span class="k">static</span> <span class="n">T</span><span class="o">&amp;</span> <span class="n">instance</span><span class="p">()</span> <span class="c1">//单例一个对象
</span><span class="c1"></span>  <span class="p">{</span>
    <span class="n">pthread_once</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ponce_</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">Singleton</span><span class="o">::</span><span class="n">init</span><span class="p">);</span> <span class="c1">//线程安全，并且一次调用
</span><span class="c1"></span>    <span class="k">return</span> <span class="o">*</span><span class="n">value_</span><span class="p">;</span>
  <span class="p">}</span>
 
 <span class="k">private</span><span class="o">:</span>
  <span class="n">Singleton</span><span class="p">();</span>
  <span class="o">~</span><span class="n">Singleton</span><span class="p">();</span>
 
    <span class="c1">//初始化对象value
</span><span class="c1"></span>  <span class="k">static</span> <span class="kt">void</span> <span class="nf">init</span><span class="p">()</span>
  <span class="p">{</span>
    <span class="n">value_</span> <span class="o">=</span> <span class="k">new</span> <span class="n">T</span><span class="p">();</span>
    <span class="c1">//加入释放队列
</span><span class="c1"></span>    <span class="o">::</span><span class="n">atexit</span><span class="p">(</span><span class="n">destroy</span><span class="p">);</span>
  <span class="p">}</span>
 
  <span class="k">static</span> <span class="kt">void</span> <span class="nf">destroy</span><span class="p">()</span>
  <span class="p">{</span>
      <span class="c1">//T_must_be_complete_type 完全类型
</span><span class="c1"></span>    <span class="k">typedef</span> <span class="kt">char</span> <span class="n">T_must_be_complete_type</span><span class="p">[</span><span class="k">sizeof</span><span class="p">(</span><span class="n">T</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">?</span> <span class="o">-</span><span class="mi">1</span> <span class="o">:</span> <span class="mi">1</span><span class="p">];</span>
    <span class="c1">//真正释放实例资源
</span><span class="c1"></span>    <span class="k">delete</span> <span class="n">value_</span><span class="p">;</span>
  <span class="p">}</span>
 
 <span class="k">private</span><span class="o">:</span>
  <span class="k">static</span> <span class="n">pthread_once_t</span> <span class="n">ponce_</span><span class="p">;</span>
  <span class="k">static</span> <span class="n">T</span><span class="o">*</span>             <span class="n">value_</span><span class="p">;</span>
<span class="p">};</span>
 
<span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="o">&gt;</span>
<span class="n">pthread_once_t</span> <span class="n">Singleton</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;::</span><span class="n">ponce_</span> <span class="o">=</span> <span class="n">PTHREAD_ONCE_INIT</span><span class="p">;</span>
 
<span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="o">&gt;</span>
<span class="n">T</span><span class="o">*</span> <span class="n">Singleton</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;::</span><span class="n">value_</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
 
<span class="p">}</span>
<span class="cp">#endif
</span></code></pre></td></tr></table>
</div>
</div>
<h3 id="测试程序-1">测试程序</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-c++" data-lang="c++"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c++" data-lang="c++"><span class="cp">#include</span> <span class="cpf">&lt;muduo/base/Singleton.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;muduo/base/CurrentThread.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;muduo/base/Thread.h&gt;</span><span class="cp">
</span><span class="cp"></span> 
<span class="cp">#include</span> <span class="cpf">&lt;boost/noncopyable.hpp&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
</span><span class="cp"></span> 
<span class="k">class</span><span class="err"> </span><span class="nc">Test</span> <span class="o">:</span> <span class="n">boost</span><span class="o">::</span><span class="n">noncopyable</span>
<span class="p">{</span>
 <span class="k">public</span><span class="o">:</span>
  <span class="n">Test</span><span class="p">()</span>
  <span class="p">{</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;tid=%d, constructing %p</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">muduo</span><span class="o">::</span><span class="n">CurrentThread</span><span class="o">::</span><span class="n">tid</span><span class="p">(),</span> <span class="k">this</span><span class="p">);</span>
  <span class="p">}</span>
 
  <span class="o">~</span><span class="n">Test</span><span class="p">()</span>
  <span class="p">{</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;tid=%d, destructing %p %s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">muduo</span><span class="o">::</span><span class="n">CurrentThread</span><span class="o">::</span><span class="n">tid</span><span class="p">(),</span> <span class="k">this</span><span class="p">,</span> <span class="n">name_</span><span class="p">.</span><span class="n">c_str</span><span class="p">());</span>
  <span class="p">}</span>
 
  <span class="k">const</span> <span class="n">muduo</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span> <span class="n">name</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span> <span class="k">return</span> <span class="n">name_</span><span class="p">;</span> <span class="p">}</span>
  <span class="kt">void</span> <span class="n">setName</span><span class="p">(</span><span class="k">const</span> <span class="n">muduo</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span> <span class="n">n</span><span class="p">)</span> <span class="p">{</span> <span class="n">name_</span> <span class="o">=</span> <span class="n">n</span><span class="p">;</span> <span class="p">}</span>
 
 <span class="k">private</span><span class="o">:</span>
  <span class="n">muduo</span><span class="o">::</span><span class="n">string</span> <span class="n">name_</span><span class="p">;</span>
<span class="p">};</span>
 
<span class="kt">void</span> <span class="nf">threadFunc</span><span class="p">()</span>
<span class="p">{</span>
  <span class="n">printf</span><span class="p">(</span><span class="s">&#34;tid=%d, %p name=%s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span>
         <span class="n">muduo</span><span class="o">::</span><span class="n">CurrentThread</span><span class="o">::</span><span class="n">tid</span><span class="p">(),</span>
         <span class="o">&amp;</span><span class="n">muduo</span><span class="o">::</span><span class="n">Singleton</span><span class="o">&lt;</span><span class="n">Test</span><span class="o">&gt;::</span><span class="n">instance</span><span class="p">(),</span>
         <span class="n">muduo</span><span class="o">::</span><span class="n">Singleton</span><span class="o">&lt;</span><span class="n">Test</span><span class="o">&gt;::</span><span class="n">instance</span><span class="p">().</span><span class="n">name</span><span class="p">().</span><span class="n">c_str</span><span class="p">());</span>
  <span class="n">muduo</span><span class="o">::</span><span class="n">Singleton</span><span class="o">&lt;</span><span class="n">Test</span><span class="o">&gt;::</span><span class="n">instance</span><span class="p">().</span><span class="n">setName</span><span class="p">(</span><span class="s">&#34;only one, changed&#34;</span><span class="p">);</span>
<span class="p">}</span>
 
<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>
<span class="p">{</span>
    <span class="c1">//muduo::Singleton&lt;Test&gt;::instance() 单例化 Test
</span><span class="c1"></span>  <span class="n">muduo</span><span class="o">::</span><span class="n">Singleton</span><span class="o">&lt;</span><span class="n">Test</span><span class="o">&gt;::</span><span class="n">instance</span><span class="p">().</span><span class="n">setName</span><span class="p">(</span><span class="s">&#34;only one&#34;</span><span class="p">);</span>
  <span class="n">muduo</span><span class="o">::</span><span class="n">Thread</span> <span class="n">t1</span><span class="p">(</span><span class="n">threadFunc</span><span class="p">);</span>
  <span class="n">t1</span><span class="p">.</span><span class="n">start</span><span class="p">();</span>
  <span class="n">t1</span><span class="p">.</span><span class="n">join</span><span class="p">();</span>
  <span class="n">printf</span><span class="p">(</span><span class="s">&#34;tid=%d, %p name=%s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span>
         <span class="n">muduo</span><span class="o">::</span><span class="n">CurrentThread</span><span class="o">::</span><span class="n">tid</span><span class="p">(),</span>
         <span class="o">&amp;</span><span class="n">muduo</span><span class="o">::</span><span class="n">Singleton</span><span class="o">&lt;</span><span class="n">Test</span><span class="o">&gt;::</span><span class="n">instance</span><span class="p">(),</span>
         <span class="n">muduo</span><span class="o">::</span><span class="n">Singleton</span><span class="o">&lt;</span><span class="n">Test</span><span class="o">&gt;::</span><span class="n">instance</span><span class="p">().</span><span class="n">name</span><span class="p">().</span><span class="n">c_str</span><span class="p">());</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div>
<h3 id="程序输出">程序输出</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-sh" data-lang="sh"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-sh" data-lang="sh"><span class="o">[</span>root@localhost bin<span class="o">]</span><span class="c1"># ./singleton_test</span>
<span class="nv">tid</span><span class="o">=</span><span class="m">2777</span>, constructing 0x87cc008
<span class="nv">tid</span><span class="o">=</span><span class="m">2778</span>, 0x87cc008 <span class="nv">name</span><span class="o">=</span>only one
<span class="nv">tid</span><span class="o">=</span><span class="m">2777</span>, 0x87cc008 <span class="nv">name</span><span class="o">=</span>only one, changed
<span class="nv">tid</span><span class="o">=</span><span class="m">2777</span>, destructing 0x87cc008 only one, changed
<span class="o">[</span>root@localhost bin<span class="o">]</span>#</code></pre></td></tr></table>
</div>
</div>
<h2 id="18-threadlocal">[18] ThreadLocal</h2>

<p><center> <img src="http://laohanlinux.github.io/images/img/blog/muduo_base_library/ThreadLocalSingleton.png" alt="" /> </center></p>

<h3 id="threadlocal-的源代码">ThreadLocal 的源代码</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-c++" data-lang="c++"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c++" data-lang="c++"><span class="c1">// Use of this source code is governed by a BSD-style license
</span><span class="c1">// that can be found in the License file.
</span><span class="c1">//
</span><span class="c1">// Author: Shuo Chen (chenshuo at chenshuo dot com)
</span><span class="c1"></span> 
<span class="cp">#ifndef MUDUO_BASE_THREADLOCAL_H
</span><span class="cp">#define MUDUO_BASE_THREADLOCAL_H
</span><span class="cp"></span> 
<span class="cp">#include</span> <span class="cpf">&lt;boost/noncopyable.hpp&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;pthread.h&gt;</span><span class="cp">
</span><span class="cp"></span> 
<span class="k">namespace</span> <span class="n">muduo</span>
<span class="p">{</span>
 
<span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="o">&gt;</span>
<span class="k">class</span><span class="err"> </span><span class="nc">ThreadLocal</span> <span class="o">:</span> <span class="n">boost</span><span class="o">::</span><span class="n">noncopyable</span>
<span class="p">{</span>
 <span class="k">public</span><span class="o">:</span>
     <span class="c1">//构造函数，创建pkey
</span><span class="c1"></span>  <span class="n">ThreadLocal</span><span class="p">()</span>
  <span class="p">{</span>
     <span class="cm">/*
</span><span class="cm">     创建的键存放在pkey指定的内存单元，这个键可以被进程中的所有线程使用，但每个线程
</span><span class="cm">把这个键与不同的线程 “私有数据地址” 进行关联。创建新键时，每个线程的数据地址设为NULL值。   
</span><span class="cm">    ThreadLocal::destructor键的虚构函数   
</span><span class="cm">     **/</span>
    <span class="n">pthread_key_create</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pkey_</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ThreadLocal</span><span class="o">::</span><span class="n">destructor</span><span class="p">);</span>
  <span class="p">}</span>
 
  <span class="o">~</span><span class="n">ThreadLocal</span><span class="p">()</span>
  <span class="p">{</span>
    <span class="n">pthread_key_delete</span><span class="p">(</span><span class="n">pkey_</span><span class="p">);</span>
  <span class="p">}</span>
    <span class="c1">// 获取数据，如果数据还没有，则新建一个
</span><span class="c1"></span>  <span class="n">T</span><span class="o">&amp;</span> <span class="n">value</span><span class="p">()</span>
  <span class="p">{</span>
    <span class="n">T</span><span class="o">*</span> <span class="n">perThreadValue</span> <span class="o">=</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="n">T</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">pthread_getspecific</span><span class="p">(</span><span class="n">pkey_</span><span class="p">));</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">perThreadValue</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">T</span><span class="o">*</span> <span class="n">newObj</span> <span class="o">=</span> <span class="k">new</span> <span class="n">T</span><span class="p">();</span>
      <span class="c1">//pthread_setspecific使pkey 和 私有数据进行关联
</span><span class="c1"></span>      <span class="n">pthread_setspecific</span><span class="p">(</span><span class="n">pkey_</span><span class="p">,</span> <span class="n">newObj</span><span class="p">);</span>
      <span class="n">perThreadValue</span> <span class="o">=</span> <span class="n">newObj</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="o">*</span><span class="n">perThreadValue</span><span class="p">;</span>
  <span class="p">}</span>
 
 <span class="k">private</span><span class="o">:</span>
 
  <span class="k">static</span> <span class="kt">void</span> <span class="n">destructor</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">x</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">T</span><span class="o">*</span> <span class="n">obj</span> <span class="o">=</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="n">T</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">x</span><span class="p">);</span>
    <span class="c1">//判断是否为全类型，如果是则delete obj，
</span><span class="c1"></span>    <span class="k">typedef</span> <span class="kt">char</span> <span class="n">T_must_be_complete_type</span><span class="p">[</span><span class="k">sizeof</span><span class="p">(</span><span class="n">T</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">?</span> <span class="o">-</span><span class="mi">1</span> <span class="o">:</span> <span class="mi">1</span><span class="p">];</span>
    <span class="k">delete</span> <span class="n">obj</span><span class="p">;</span>
  <span class="p">}</span>
 
 <span class="k">private</span><span class="o">:</span>
  <span class="n">pthread_key_t</span> <span class="n">pkey_</span><span class="p">;</span>
<span class="p">};</span>
 
<span class="p">}</span>
<span class="cp">#endif
</span></code></pre></td></tr></table>
</div>
</div>
<h3 id="threadlocal-的测试程序">ThreadLocal 的测试程序</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-c++" data-lang="c++"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c++" data-lang="c++"><span class="cp">#include</span> <span class="cpf">&lt;muduo/base/ThreadLocal.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;muduo/base/CurrentThread.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;muduo/base/Thread.h&gt;</span><span class="cp">
</span><span class="cp"></span> 
<span class="cp">#include</span> <span class="cpf">&lt;boost/noncopyable.hpp&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
</span><span class="cp"></span> 
<span class="k">class</span><span class="err"> </span><span class="nc">Test</span><span class="o">:</span><span class="n">boost</span><span class="o">::</span><span class="n">noncopyable</span>
<span class="p">{</span>
<span class="k">private</span> <span class="o">:</span>
    <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">name_</span><span class="p">;</span>
<span class="k">public</span> <span class="o">:</span>
    <span class="n">Test</span><span class="p">(){</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">&#34;tid=%d,constructing %p</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span><span class="n">muduo</span><span class="o">::</span><span class="n">CurrentThread</span><span class="o">::</span><span class="n">tid</span><span class="p">(),</span><span class="k">this</span><span class="p">);</span>
 
    <span class="p">}</span>  
    <span class="o">~</span><span class="n">Test</span><span class="p">(){</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">&#34;tid= %d,destructing %p %s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span><span class="n">muduo</span><span class="o">::</span><span class="n">CurrentThread</span><span class="o">::</span><span class="n">tid</span><span class="p">(),</span><span class="k">this</span><span class="p">,</span><span class="n">name_</span><span class="p">.</span><span class="n">c_str</span><span class="p">());</span>
    <span class="p">}</span>
 
    <span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="o">&amp;</span><span class="n">name</span><span class="p">()</span><span class="k">const</span><span class="p">{</span> <span class="k">return</span> <span class="n">name_</span> <span class="p">;}</span>
    <span class="kt">void</span> <span class="n">setName</span><span class="p">(</span><span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="o">&amp;</span><span class="n">n</span> <span class="p">){</span> <span class="n">name_</span> <span class="o">=</span> <span class="n">n</span> <span class="p">;}</span>
 
<span class="p">};</span>
 
<span class="n">muduo</span><span class="o">::</span><span class="n">ThreadLocal</span><span class="o">&lt;</span><span class="n">Test</span><span class="o">&gt;</span> <span class="n">testObj1</span><span class="p">;</span>
<span class="n">muduo</span><span class="o">::</span><span class="n">ThreadLocal</span><span class="o">&lt;</span><span class="n">Test</span><span class="o">&gt;</span> <span class="n">testObj2</span><span class="p">;</span>
 
<span class="kt">void</span> <span class="nf">print</span><span class="p">(){</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;tid =%d</span><span class="se">\t</span><span class="s">obj1 %p</span><span class="se">\t</span><span class="s">name=%s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span><span class="n">muduo</span><span class="o">::</span><span class="n">CurrentThread</span><span class="o">::</span><span class="n">tid</span><span class="p">(),</span>
        <span class="o">&amp;</span><span class="n">testObj1</span><span class="p">.</span><span class="n">value</span><span class="p">(),</span>
        <span class="n">testObj1</span><span class="p">.</span><span class="n">value</span><span class="p">().</span><span class="n">name</span><span class="p">().</span><span class="n">c_str</span><span class="p">());</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;tid=%d</span><span class="se">\t</span><span class="s">obj2 %p name=%s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span>
        <span class="n">muduo</span><span class="o">::</span><span class="n">CurrentThread</span><span class="o">::</span><span class="n">tid</span><span class="p">(),</span>
        <span class="o">&amp;</span><span class="n">testObj2</span><span class="p">.</span><span class="n">value</span><span class="p">(),</span>
        <span class="n">testObj2</span><span class="p">.</span><span class="n">value</span><span class="p">().</span><span class="n">name</span><span class="p">().</span><span class="n">c_str</span><span class="p">());</span>
<span class="p">}</span>
 
<span class="kt">void</span> <span class="nf">threadFunc</span><span class="p">(){</span>
    <span class="n">print</span><span class="p">();</span>
    <span class="n">testObj1</span><span class="p">.</span><span class="n">value</span><span class="p">().</span><span class="n">setName</span><span class="p">(</span><span class="s">&#34;changed 1&#34;</span><span class="p">)</span> <span class="p">;</span>
    <span class="n">testObj2</span><span class="p">.</span><span class="n">value</span><span class="p">().</span><span class="n">setName</span><span class="p">(</span><span class="s">&#34;changed 2&#34;</span><span class="p">);</span>
    <span class="n">print</span><span class="p">();</span>
 
<span class="p">}</span>
<span class="kt">int</span> <span class="nf">main</span> <span class="p">(</span><span class="kt">void</span> <span class="p">){</span>
    <span class="n">testObj1</span><span class="p">.</span><span class="n">value</span><span class="p">().</span><span class="n">setName</span><span class="p">(</span><span class="s">&#34;main One&#34;</span><span class="p">);</span>
    <span class="n">print</span><span class="p">();</span>
    <span class="n">muduo</span><span class="o">::</span><span class="n">Thread</span> <span class="n">t1</span> <span class="p">(</span><span class="n">threadFunc</span><span class="p">)</span> <span class="p">;</span>
    <span class="n">t1</span><span class="p">.</span><span class="n">start</span><span class="p">();</span>
    <span class="n">t1</span><span class="p">.</span><span class="n">join</span><span class="p">();</span>
    <span class="n">testObj2</span><span class="p">.</span><span class="n">value</span><span class="p">().</span><span class="n">setName</span><span class="p">(</span><span class="s">&#34;main two&#34;</span> <span class="p">)</span> <span class="p">;</span>
    <span class="n">print</span><span class="p">();</span>
    <span class="n">pthread_exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
    <span class="k">return</span>  <span class="mi">0</span> <span class="p">;</span>
 
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div>
<h3 id="程序输出-1">程序输出</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-sh" data-lang="sh"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-sh" data-lang="sh"><span class="o">[</span>root@localhost bin<span class="o">]</span><span class="c1"># ./threadlocal_test</span>
<span class="nv">tid</span><span class="o">=</span><span class="m">2915</span>,constructing 0x9435028
<span class="nv">tid</span> <span class="o">=</span><span class="m">2915</span>   obj1 0x9435028  <span class="nv">name</span><span class="o">=</span>main One
<span class="nv">tid</span><span class="o">=</span><span class="m">2915</span>,constructing 0x9435038
<span class="nv">tid</span><span class="o">=</span><span class="m">2915</span>    obj2 0x9435038 <span class="nv">name</span><span class="o">=</span>
<span class="nv">tid</span><span class="o">=</span><span class="m">2916</span>,constructing 0xb6c00468
<span class="nv">tid</span> <span class="o">=</span><span class="m">2916</span>   obj1 0xb6c00468 <span class="nv">name</span><span class="o">=</span>
<span class="nv">tid</span><span class="o">=</span><span class="m">2916</span>,constructing 0xb6c00478
<span class="nv">tid</span><span class="o">=</span><span class="m">2916</span>    obj2 0xb6c00478 <span class="nv">name</span><span class="o">=</span>
<span class="nv">tid</span> <span class="o">=</span><span class="m">2916</span>   obj1 0xb6c00468 <span class="nv">name</span><span class="o">=</span>changed <span class="m">1</span>
<span class="nv">tid</span><span class="o">=</span><span class="m">2916</span>    obj2 0xb6c00478 <span class="nv">name</span><span class="o">=</span>changed <span class="m">2</span>
<span class="nv">tid</span><span class="o">=</span> <span class="m">2916</span>,destructing 0xb6c00468 changed <span class="m">1</span>
<span class="nv">tid</span><span class="o">=</span> <span class="m">2916</span>,destructing 0xb6c00478 changed <span class="m">2</span>
<span class="nv">tid</span> <span class="o">=</span><span class="m">2915</span>   obj1 0x9435028  <span class="nv">name</span><span class="o">=</span>main One
<span class="nv">tid</span><span class="o">=</span><span class="m">2915</span>    obj2 0x9435038 <span class="nv">name</span><span class="o">=</span>main two
<span class="nv">tid</span><span class="o">=</span> <span class="m">2915</span>,destructing 0x9435028 main One
<span class="nv">tid</span><span class="o">=</span> <span class="m">2915</span>,destructing 0x9435038 main two
<span class="o">[</span>root@localhost bin<span class="o">]</span><span class="c1"># ls</span></code></pre></td></tr></table>
</div>
</div>
<h2 id="19-threadlocalsingle">[19] ThreadLocalSingle</h2>

<h3 id="threadlocalsingle-class-uml">ThreadLocalSingle class UML</h3>

<p><center><img src="http://laohanlinux.github.io/images/img/blog/muduo_base_library/ThreadLocalSingletonDeleter.png" alt="" /></center></p>

<h3 id="源程序">源程序</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-c++" data-lang="c++"><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c++" data-lang="c++"><span class="c1">// Use of this source code is governed by a BSD-style license
</span><span class="c1">// that can be found in the License file.
</span><span class="c1">//
</span><span class="c1">// Author: Shuo Chen (chenshuo at chenshuo dot com)
</span><span class="c1"></span> 
<span class="cp">#ifndef MUDUO_BASE_THREADLOCALSINGLETON_H
</span><span class="cp">#define MUDUO_BASE_THREADLOCALSINGLETON_H
</span><span class="cp"></span> 
<span class="cp">#include</span> <span class="cpf">&lt;boost/noncopyable.hpp&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;assert.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;pthread.h&gt;</span><span class="cp">
</span><span class="cp"></span><span class="cm">/**
</span><span class="cm"> 
</span><span class="cm">线程本地单例封装
</span><span class="cm">---------------------------
</span><span class="cm">-ponce_:pthread_once_t
</span><span class="cm">-value:T*
</span><span class="cm">----------------------
</span><span class="cm">+instance():T&amp;
</span><span class="cm">&lt;&lt;create&gt;&gt;-Singleton()
</span><span class="cm">&lt;&lt;destroy&gt;&gt;-Singleton()
</span><span class="cm">-init():void
</span><span class="cm">-destroy():void
</span><span class="cm">---------------------------
</span><span class="cm">***/</span>
 
<span class="k">namespace</span> <span class="n">muduo</span>
<span class="p">{</span>
 
<span class="c1">//使用模板
</span><span class="c1"></span><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="o">&gt;</span>
<span class="k">class</span><span class="err"> </span><span class="nc">ThreadLocalSingleton</span> <span class="o">:</span> <span class="n">boost</span><span class="o">::</span><span class="n">noncopyable</span> <span class="c1">//不可复制的
</span><span class="c1"></span><span class="p">{</span>
 <span class="k">public</span><span class="o">:</span>
 
  <span class="k">static</span> <span class="n">T</span><span class="o">&amp;</span> <span class="n">instance</span><span class="p">()</span>
  <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">t_value_</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">t_value_</span> <span class="o">=</span> <span class="k">new</span> <span class="n">T</span><span class="p">();</span>
      <span class="n">deleter_</span><span class="p">.</span><span class="n">set</span><span class="p">(</span><span class="n">t_value_</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="o">*</span><span class="n">t_value_</span><span class="p">;</span>
  <span class="p">}</span>
 
  <span class="k">static</span> <span class="n">T</span><span class="o">*</span> <span class="n">pointer</span><span class="p">()</span>
  <span class="p">{</span>
    <span class="k">return</span> <span class="n">t_value_</span><span class="p">;</span>
  <span class="p">}</span>
 
 <span class="k">private</span><span class="o">:</span>
 
  <span class="k">static</span> <span class="kt">void</span> <span class="n">destructor</span><span class="p">(</span><span class="kt">void</span><span class="o">*</span> <span class="n">obj</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">assert</span><span class="p">(</span><span class="n">obj</span> <span class="o">==</span> <span class="n">t_value_</span><span class="p">);</span>
    <span class="c1">//T_must_be_complete_type : 完全类型
</span><span class="c1"></span>    <span class="c1">// Thread a;
</span><span class="c1"></span>    <span class="c1">// a *p  ; //p这种类型就不是完全类型
</span><span class="c1"></span>    <span class="k">typedef</span> <span class="kt">char</span> <span class="n">T_must_be_complete_type</span><span class="p">[</span><span class="k">sizeof</span><span class="p">(</span><span class="n">T</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">?</span> <span class="o">-</span><span class="mi">1</span> <span class="o">:</span> <span class="mi">1</span><span class="p">];</span>
    <span class="c1">//
</span><span class="c1"></span>    <span class="k">delete</span> <span class="n">t_value_</span><span class="p">;</span>
    <span class="n">t_value_</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="p">}</span>
 
<span class="cm">/**
</span><span class="cm">Deleter 主要是用来使ThreadLocalSingleton::destructor作为pkey_的虚构回调函数
</span><span class="cm">Deleter 只是虚构时只是pthread_key_delete(pkey_)而已
</span><span class="cm">**/</span>
  <span class="k">class</span><span class="err"> </span><span class="nc">Deleter</span>
  <span class="p">{</span>
   <span class="k">public</span><span class="o">:</span>
    <span class="n">Deleter</span><span class="p">()</span>
    <span class="p">{</span>
      <span class="n">pthread_key_create</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pkey_</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ThreadLocalSingleton</span><span class="o">::</span><span class="n">destructor</span><span class="p">);</span>
    <span class="p">}</span>
 
    <span class="o">~</span><span class="n">Deleter</span><span class="p">()</span>
    <span class="p">{</span>
      <span class="n">pthread_key_delete</span><span class="p">(</span><span class="n">pkey_</span><span class="p">);</span>
    <span class="p">}</span>
 
    <span class="kt">void</span> <span class="n">set</span><span class="p">(</span><span class="n">T</span><span class="o">*</span> <span class="n">newObj</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">assert</span><span class="p">(</span><span class="n">pthread_getspecific</span><span class="p">(</span><span class="n">pkey_</span><span class="p">)</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">);</span>
      <span class="n">pthread_setspecific</span><span class="p">(</span><span class="n">pkey_</span><span class="p">,</span> <span class="n">newObj</span><span class="p">);</span>
    <span class="p">}</span>
 
    <span class="n">pthread_key_t</span> <span class="n">pkey_</span><span class="p">;</span>
  <span class="p">};</span>
 
  <span class="k">static</span> <span class="n">__thread</span> <span class="n">T</span><span class="o">*</span> <span class="n">t_value_</span><span class="p">;</span> <span class="c1">//只被执行一次，并且是线程安全 ====实际数据
</span><span class="c1"></span>                                <span class="c1">// __thread 修饰的变量一定是全局的或者静态的
</span><span class="c1"></span>  <span class="k">static</span> <span class="n">Deleter</span> <span class="n">deleter_</span><span class="p">;</span>      <span class="c1">//消费实际数据函数
</span><span class="c1"></span><span class="p">};</span>
 
<span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="o">&gt;</span>
<span class="n">__thread</span> <span class="n">T</span><span class="o">*</span> <span class="n">ThreadLocalSingleton</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;::</span><span class="n">t_value_</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
 
<span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="o">&gt;</span>
<span class="k">typename</span> <span class="n">ThreadLocalSingleton</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;::</span><span class="n">Deleter</span> <span class="n">ThreadLocalSingleton</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;::</span><span class="n">deleter_</span><span class="p">;</span>
 
<span class="p">}</span>
<span class="cp">#endif
</span></code></pre></td></tr></table>
</div>
</div>
<h3 id="测试程序-2">测试程序</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="nl">#include</span> <span class="o">&lt;</span><span class="n">muduo</span><span class="o">/</span><span class="n">base</span><span class="o">/</span><span class="nv">ThreadLocalSingleton</span><span class="p">.</span><span class="n">h</span><span class="o">&gt;</span>
<span class="nl">#include</span> <span class="o">&lt;</span><span class="n">muduo</span><span class="o">/</span><span class="n">base</span><span class="o">/</span><span class="nv">CurrentThread</span><span class="p">.</span><span class="n">h</span><span class="o">&gt;</span>
<span class="nl">#include</span> <span class="o">&lt;</span><span class="n">muduo</span><span class="o">/</span><span class="n">base</span><span class="o">/</span><span class="nv">Thread</span><span class="p">.</span><span class="n">h</span><span class="o">&gt;</span>
 
<span class="nl">#include</span> <span class="o">&lt;</span><span class="n">boost</span><span class="o">/</span><span class="n">bind</span><span class="p">.</span><span class="n">hpp</span><span class="o">&gt;</span>
<span class="nl">#include</span> <span class="o">&lt;</span><span class="n">boost</span><span class="o">/</span><span class="n">noncopyable</span><span class="p">.</span><span class="n">hpp</span><span class="o">&gt;</span>
<span class="nl">#include</span> <span class="o">&lt;</span><span class="n">stdio</span><span class="p">.</span><span class="n">h</span><span class="o">&gt;</span>
 
<span class="n">class</span> <span class="nv">Test</span> <span class="p">:</span> <span class="nn">boost</span><span class="p">::</span><span class="n">noncopyable</span>
<span class="p">{</span>
 <span class="nn">public</span><span class="p">:</span>
  <span class="nv">Test</span><span class="p">()</span>
  <span class="p">{</span>
    <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;tid=%d, constructing %p</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="nn">muduo</span><span class="p">::</span><span class="nv">CurrentThread</span><span class="p">::</span><span class="nf">tid</span><span class="p">(),</span> <span class="n">this</span><span class="p">);</span>
  <span class="p">}</span>
 
  <span class="err">~</span><span class="nv">Test</span><span class="p">()</span>
  <span class="p">{</span>
    <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;tid=%d, destructing %p %s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="nn">muduo</span><span class="p">::</span><span class="nv">CurrentThread</span><span class="p">::</span><span class="nf">tid</span><span class="p">(),</span> <span class="n">this</span><span class="p">,</span> <span class="n">name_</span><span class="p">.</span><span class="nf">c_str</span><span class="p">());</span>
  <span class="p">}</span>
 
  <span class="n">const</span> <span class="nn">std</span><span class="p">::</span><span class="n">string</span><span class="err">&amp;</span> <span class="nf">name</span><span class="p">()</span> <span class="n">const</span> <span class="p">{</span> <span class="n">return</span> <span class="n">name_</span><span class="p">;</span> <span class="p">}</span>
  <span class="n">void</span> <span class="nf">setName</span><span class="p">(</span><span class="n">const</span> <span class="nn">std</span><span class="p">::</span><span class="n">string</span><span class="err">&amp;</span> <span class="n">n</span><span class="p">)</span> <span class="p">{</span> <span class="n">name_</span> <span class="o">=</span> <span class="n">n</span><span class="p">;</span> <span class="p">}</span>
 
 <span class="nn">private</span><span class="p">:</span>
  <span class="nn">std</span><span class="p">::</span><span class="n">string</span> <span class="n">name_</span><span class="p">;</span>
<span class="p">};</span>
 
<span class="n">void</span> <span class="nf">threadFunc</span><span class="p">(</span><span class="n">const</span> <span class="n">char</span><span class="o">*</span> <span class="n">changeTo</span><span class="p">)</span>
<span class="p">{</span>
  <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;tid=%d, %p name=%s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span>
         <span class="nn">muduo</span><span class="p">::</span><span class="nv">CurrentThread</span><span class="p">::</span><span class="nf">tid</span><span class="p">(),</span>
         <span class="err">&amp;</span><span class="nn">muduo</span><span class="p">::</span><span class="nv">ThreadLocalSingleton</span><span class="o">&lt;</span><span class="nv">Test</span><span class="o">&gt;</span><span class="p">::</span><span class="nf">instance</span><span class="p">(),</span>
         <span class="nn">muduo</span><span class="p">::</span><span class="nv">ThreadLocalSingleton</span><span class="o">&lt;</span><span class="nv">Test</span><span class="o">&gt;</span><span class="p">::</span><span class="nf">instance</span><span class="p">().</span><span class="nf">name</span><span class="p">().</span><span class="nf">c_str</span><span class="p">());</span>
  <span class="nn">muduo</span><span class="p">::</span><span class="nv">ThreadLocalSingleton</span><span class="o">&lt;</span><span class="nv">Test</span><span class="o">&gt;</span><span class="p">::</span><span class="nf">instance</span><span class="p">().</span><span class="nf">setName</span><span class="p">(</span><span class="n">changeTo</span><span class="p">);</span>
  <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;tid=%d, %p name=%s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span>
         <span class="nn">muduo</span><span class="p">::</span><span class="nv">CurrentThread</span><span class="p">::</span><span class="nf">tid</span><span class="p">(),</span>
         <span class="err">&amp;</span><span class="nn">muduo</span><span class="p">::</span><span class="nv">ThreadLocalSingleton</span><span class="o">&lt;</span><span class="nv">Test</span><span class="o">&gt;</span><span class="p">::</span><span class="nf">instance</span><span class="p">(),</span>
         <span class="nn">muduo</span><span class="p">::</span><span class="nv">ThreadLocalSingleton</span><span class="o">&lt;</span><span class="nv">Test</span><span class="o">&gt;</span><span class="p">::</span><span class="nf">instance</span><span class="p">().</span><span class="nf">name</span><span class="p">().</span><span class="nf">c_str</span><span class="p">());</span>
 
  <span class="o">//</span> <span class="n">no</span> <span class="n">need</span> <span class="n">to</span> <span class="n">manually</span> <span class="n">delete</span> <span class="n">it</span>
  <span class="o">//</span> <span class="nn">muduo</span><span class="p">::</span><span class="nv">ThreadLocalSingleton</span><span class="o">&lt;</span><span class="nv">Test</span><span class="o">&gt;</span><span class="p">::</span><span class="nf">destroy</span><span class="p">();</span>
<span class="p">}</span>
 
<span class="n">int</span> <span class="nf">main</span><span class="p">()</span>
<span class="p">{</span>
  <span class="nn">muduo</span><span class="p">::</span><span class="nv">ThreadLocalSingleton</span><span class="o">&lt;</span><span class="nv">Test</span><span class="o">&gt;</span><span class="p">::</span><span class="nf">instance</span><span class="p">().</span><span class="nf">setName</span><span class="p">(</span><span class="s">&#34;main one&#34;</span><span class="p">);</span>
  <span class="nn">muduo</span><span class="p">::</span><span class="nv">Thread</span> <span class="nf">t1</span><span class="p">(</span><span class="nn">boost</span><span class="p">::</span><span class="nf">bind</span><span class="p">(</span><span class="n">threadFunc</span><span class="p">,</span> <span class="s">&#34;thread1&#34;</span><span class="p">));</span>
  <span class="nn">muduo</span><span class="p">::</span><span class="nv">Thread</span> <span class="nf">t2</span><span class="p">(</span><span class="nn">boost</span><span class="p">::</span><span class="nf">bind</span><span class="p">(</span><span class="n">threadFunc</span><span class="p">,</span> <span class="s">&#34;thread2&#34;</span><span class="p">));</span>
  <span class="n">t1</span><span class="p">.</span><span class="nf">start</span><span class="p">();</span>
  <span class="n">t2</span><span class="p">.</span><span class="nf">start</span><span class="p">();</span>
  <span class="n">t1</span><span class="p">.</span><span class="nf">join</span><span class="p">();</span>
  <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;tid=%d, %p name=%s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span>
         <span class="nn">muduo</span><span class="p">::</span><span class="nv">CurrentThread</span><span class="p">::</span><span class="nf">tid</span><span class="p">(),</span>
         <span class="err">&amp;</span><span class="nn">muduo</span><span class="p">::</span><span class="nv">ThreadLocalSingleton</span><span class="o">&lt;</span><span class="nv">Test</span><span class="o">&gt;</span><span class="p">::</span><span class="nf">instance</span><span class="p">(),</span>
         <span class="nn">muduo</span><span class="p">::</span><span class="nv">ThreadLocalSingleton</span><span class="o">&lt;</span><span class="nv">Test</span><span class="o">&gt;</span><span class="p">::</span><span class="nf">instance</span><span class="p">().</span><span class="nf">name</span><span class="p">().</span><span class="nf">c_str</span><span class="p">());</span>
  <span class="n">t2</span><span class="p">.</span><span class="nf">join</span><span class="p">();</span>
 
  <span class="nf">pthread_exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<h3 id="程序输出-2">程序输出</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-c++" data-lang="c++"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c++" data-lang="c++"><span class="p">[</span><span class="n">root</span><span class="err">@</span><span class="n">localhost</span> <span class="n">bin</span><span class="p">]</span><span class="cp"># ./threadlocalsingleton_test
</span><span class="cp"></span><span class="n">tid</span><span class="o">=</span><span class="mi">2183</span><span class="p">,</span> <span class="n">Obj</span> <span class="n">address</span>  <span class="mh">0x89b4028</span><span class="p">,</span> <span class="n">function</span> <span class="n">Test</span>
<span class="n">tid</span><span class="o">=</span><span class="mi">2184</span><span class="p">,</span> <span class="n">Obj</span> <span class="n">address</span>  <span class="mh">0xb6c00468</span><span class="p">,</span> <span class="n">function</span> <span class="n">Test</span>
<span class="n">tid</span><span class="o">=</span><span class="mi">2184</span><span class="p">,</span> <span class="n">obj</span> <span class="n">address</span> <span class="mh">0xb6c00468</span> <span class="n">name</span><span class="o">=</span>
<span class="n">tid</span><span class="o">=</span><span class="mi">2184</span><span class="p">,</span> <span class="mh">0xb6c00468</span> <span class="n">name</span><span class="o">=</span><span class="n">thread1</span>
<span class="n">tid</span><span class="o">=</span><span class="mi">2184</span><span class="p">,</span> <span class="n">destructing</span> <span class="mh">0xb6c00468</span> <span class="n">thread1</span>
<span class="n">tid</span><span class="o">=</span><span class="mi">2183</span><span class="p">,</span> <span class="mh">0x89b4028</span> <span class="n">name</span><span class="o">=</span><span class="n">main</span> <span class="n">one</span>
<span class="n">tid</span><span class="o">=</span><span class="mi">2185</span><span class="p">,</span> <span class="n">Obj</span> <span class="n">address</span>  <span class="mh">0xb6c00468</span><span class="p">,</span> <span class="n">function</span> <span class="n">Test</span>
<span class="n">tid</span><span class="o">=</span><span class="mi">2185</span><span class="p">,</span> <span class="n">obj</span> <span class="n">address</span> <span class="mh">0xb6c00468</span> <span class="n">name</span><span class="o">=</span>
<span class="n">tid</span><span class="o">=</span><span class="mi">2185</span><span class="p">,</span> <span class="mh">0xb6c00468</span> <span class="n">name</span><span class="o">=</span><span class="n">thread2</span>
<span class="n">tid</span><span class="o">=</span><span class="mi">2185</span><span class="p">,</span> <span class="n">destructing</span> <span class="mh">0xb6c00468</span> <span class="n">thread2</span>
<span class="n">tid</span><span class="o">=</span><span class="mi">2183</span><span class="p">,</span> <span class="n">destructing</span> <span class="mh">0x89b4028</span> <span class="n">main</span> <span class="n">one</span>
<span class="p">[</span><span class="n">root</span><span class="err">@</span><span class="n">localhost</span> <span class="n">bin</span><span class="p">]</span><span class="cp">#
</span></code></pre></td></tr></table>
</div>
</div>
<h2 id="20-logger-1">[20] Logger-1</h2>

<h3 id="日志流程">日志流程</h3>

<p><center> <img src="http://laohanlinux.github.io/images/img/blog/muduo_base_library/logger%281%29.png" alt="" /> </center></p>

<ul>
<li>TRACE
指出比DEBUG粒度更细的一些信息事件（开发过程中使用）</li>
<li>DEBUG
指出细粒度信息事件对调试应用程序是非常有帮助的。（开发过程中使用）</li>
<li>INFO
表明消息在粗粒度级别上突出强调应用程序的运行过程。</li>
<li>WARN
系统能正常运行，但可能会出现潜在错误的情形。</li>
<li>ERROR
指出虽然发生错误事件，但仍然不影响系统的继续运行。</li>
<li>FATAL
指出每个严重的错误事件将会导致应用程序的退出。</li>
</ul>

<h3 id="测试程序1">测试程序1</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="nl">#include</span> <span class="o">&lt;</span><span class="n">muduo</span><span class="o">/</span><span class="n">base</span><span class="o">/</span><span class="nv">Logging</span><span class="p">.</span><span class="n">h</span><span class="o">&gt;</span>
<span class="nl">#include</span> <span class="o">&lt;</span><span class="n">errno</span><span class="p">.</span><span class="n">h</span><span class="o">&gt;</span>
 
<span class="n">using</span> <span class="n">namespace</span> <span class="n">muduo</span><span class="p">;</span>
 
<span class="n">int</span> <span class="nf">main</span><span class="p">()</span>
<span class="p">{</span>
 
 <span class="o">//</span> <span class="nv">Logger</span><span class="p">.</span><span class="nv">LogLevel</span> <span class="o">=</span> <span class="nv">LogLevel</span><span class="p">::</span><span class="nv">INFO</span> <span class="p">;</span>
<span class="o">//</span>  <span class="nn">muduo</span><span class="p">::</span><span class="nv">Logger</span><span class="p">.</span><span class="nf">setLogLevel</span><span class="p">(</span> <span class="nv">LogLevel</span><span class="p">::</span><span class="nv">INFO</span> <span class="p">)</span> <span class="p">;</span>
    <span class="nv">LOG_TRACE</span><span class="o">&lt;&lt;</span><span class="s">&#34;trace ...&#34;</span><span class="p">;</span>
    <span class="nv">LOG_DEBUG</span><span class="o">&lt;&lt;</span><span class="s">&#34;debug ...&#34;</span><span class="p">;</span>
    <span class="nv">LOG_INFO</span><span class="o">&lt;&lt;</span><span class="s">&#34;info ...&#34;</span><span class="p">;</span>
    <span class="nv">LOG_WARN</span><span class="o">&lt;&lt;</span><span class="s">&#34;warn ...&#34;</span><span class="p">;</span>
    <span class="nv">LOG_ERROR</span><span class="o">&lt;&lt;</span><span class="s">&#34;error ...&#34;</span><span class="p">;</span>
    <span class="o">//</span><span class="nv">LOG_FATAL</span><span class="o">&lt;&lt;</span><span class="s">&#34;fatal ...&#34;</span><span class="p">;</span>
    <span class="n">errno</span> <span class="o">=</span> <span class="mi">13</span><span class="p">;</span>
    <span class="nv">LOG_SYSERR</span><span class="o">&lt;&lt;</span><span class="s">&#34;syserr ...&#34;</span><span class="p">;</span>
    <span class="nv">LOG_SYSFATAL</span><span class="o">&lt;&lt;</span><span class="s">&#34;sysfatal ...&#34;</span><span class="p">;</span>
    <span class="n">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<h3 id="程序输出-3">程序输出</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="p">[</span><span class="n">root</span><span class="p">@</span><span class="n">localhost</span> <span class="n">bin</span><span class="p">]</span><span class="err">#</span> <span class="p">.</span><span class="o">/</span><span class="n">log_test1</span>
<span class="mi">20131016</span> <span class="mi">15</span><span class="p">:</span><span class="mi">34</span><span class="p">:</span><span class="mi">26</span><span class="p">.</span><span class="mi">231014</span><span class="nv">Z</span>  <span class="mi">3904</span> <span class="nv">TRACE</span> <span class="n">main</span> <span class="nb">trace</span> <span class="p">...</span> <span class="p">-</span><span class="err"> L</span><span class="ni">og_test1</span><span class="p">.</span><span class="nn">cc</span><span class="p">:</span><span class="mi">11</span>
<span class="mi">20131016</span> <span class="mi">15</span><span class="p">:</span><span class="mi">34</span><span class="p">:</span><span class="mi">26</span><span class="p">.</span><span class="mi">231251</span><span class="nv">Z</span>  <span class="mi">3904</span> <span class="nv">DEBUG</span> <span class="n">main</span> <span class="n">debug</span> <span class="p">...</span> <span class="p">-</span><span class="err"> L</span><span class="ni">og_test1</span><span class="p">.</span><span class="nn">cc</span><span class="p">:</span><span class="mi">12</span>
<span class="mi">20131016</span> <span class="mi">15</span><span class="p">:</span><span class="mi">34</span><span class="p">:</span><span class="mi">26</span><span class="p">.</span><span class="mi">231264</span><span class="nv">Z</span>  <span class="mi">3904</span> <span class="nv">INFO</span>  <span class="n">info</span> <span class="p">...</span> <span class="p">-</span><span class="err"> L</span><span class="ni">og_test1</span><span class="p">.</span><span class="nn">cc</span><span class="p">:</span><span class="mi">13</span>
<span class="mi">20131016</span> <span class="mi">15</span><span class="p">:</span><span class="mi">34</span><span class="p">:</span><span class="mi">26</span><span class="p">.</span><span class="mi">231274</span><span class="nv">Z</span>  <span class="mi">3904</span> <span class="nv">WARN</span>  <span class="n">warn</span> <span class="p">...</span> <span class="p">-</span><span class="err"> L</span><span class="ni">og_test1</span><span class="p">.</span><span class="nn">cc</span><span class="p">:</span><span class="mi">14</span>
<span class="mi">20131016</span> <span class="mi">15</span><span class="p">:</span><span class="mi">34</span><span class="p">:</span><span class="mi">26</span><span class="p">.</span><span class="mi">231285</span><span class="nv">Z</span>  <span class="mi">3904</span> <span class="nv">ERROR</span> <span class="n">error</span> <span class="p">...</span> <span class="p">-</span><span class="err"> L</span><span class="ni">og_test1</span><span class="p">.</span><span class="nn">cc</span><span class="p">:</span><span class="mi">15</span>
<span class="mi">20131016</span> <span class="mi">15</span><span class="p">:</span><span class="mi">34</span><span class="p">:</span><span class="mi">26</span><span class="p">.</span><span class="mi">231293</span><span class="nv">Z</span>  <span class="mi">3904</span> <span class="nv">ERROR</span> <span class="nv">Permission</span> <span class="nf">denied</span> <span class="p">(</span><span class="n">errno</span><span class="o">=</span><span class="mi">13</span><span class="p">)</span> <span class="n">syserr</span> <span class="p">...</span> <span class="p">-</span><span class="err"> L</span><span class="ni">og_test1</span><span class="p">.</span><span class="nn">cc</span><span class="p">:</span><span class="mi">18</span>
<span class="mi">20131016</span> <span class="mi">15</span><span class="p">:</span><span class="mi">34</span><span class="p">:</span><span class="mi">26</span><span class="p">.</span><span class="mi">231317</span><span class="nv">Z</span>  <span class="mi">3904</span> <span class="nv">FATAL</span> <span class="nv">Permission</span> <span class="nf">denied</span> <span class="p">(</span><span class="n">errno</span><span class="o">=</span><span class="mi">13</span><span class="p">)</span> <span class="n">sysfatal</span> <span class="p">...</span> <span class="p">-</span><span class="err"> L</span><span class="ni">og_test1</span><span class="p">.</span><span class="nn">cc</span><span class="p">:</span><span class="mi">19</span>
<span class="nv">Aborted</span>
<span class="p">[</span><span class="n">root</span><span class="p">@</span><span class="n">localhost</span> <span class="n">bin</span><span class="p">]</span><span class="err">#</span></code></pre></td></tr></table>
</div>
</div>
<h3 id="测试程序2">测试程序2</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="nl">#include</span> <span class="o">&lt;</span><span class="n">muduo</span><span class="o">/</span><span class="n">base</span><span class="o">/</span><span class="nv">LogFile</span><span class="p">.</span><span class="n">h</span><span class="o">&gt;</span>
<span class="nl">#include</span> <span class="o">&lt;</span><span class="n">muduo</span><span class="o">/</span><span class="n">base</span><span class="o">/</span><span class="nv">Logging</span><span class="p">.</span><span class="n">h</span><span class="o">&gt;</span>
 
<span class="nn">boost</span><span class="p">::</span><span class="n">scoped_ptr</span><span class="o">&lt;</span><span class="nn">muduo</span><span class="p">::</span><span class="nv">LogFile</span><span class="o">&gt;</span> <span class="n">g_logFile</span><span class="p">;</span>
 
<span class="n">void</span> <span class="nf">outputFunc</span><span class="p">(</span><span class="n">const</span> <span class="n">char</span><span class="o">*</span> <span class="n">msg</span><span class="p">,</span> <span class="n">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">g_logFile</span><span class="p">-</span><span class="err">&gt;</span><span class="ni">append</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
<span class="p">}</span>
 
<span class="n">void</span> <span class="nf">flushFunc</span><span class="p">()</span>
<span class="p">{</span>
  <span class="n">g_logFile</span><span class="p">-</span><span class="err">&gt;</span><span class="ni">flush</span><span class="p">();</span>
<span class="p">}</span>
 
<span class="n">int</span> <span class="nf">main</span><span class="p">(</span><span class="n">int</span> <span class="n">argc</span><span class="p">,</span> <span class="n">char</span><span class="o">*</span> <span class="n">argv</span><span class="p">[])</span>
<span class="p">{</span>
  <span class="n">char</span> <span class="n">name</span><span class="p">[</span><span class="mi">256</span><span class="p">];</span>
  <span class="nf">strncpy</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">256</span><span class="p">);</span>
  <span class="n">g_logFile</span><span class="p">.</span><span class="nf">reset</span><span class="p">(</span><span class="n">new</span> <span class="nn">muduo</span><span class="p">::</span><span class="nv">LogFile</span><span class="p">(::</span><span class="nf">basename</span><span class="p">(</span><span class="n">name</span><span class="p">),</span> <span class="mi">200</span><span class="o">*</span><span class="mi">1000</span><span class="p">));</span>
  <span class="nn">muduo</span><span class="p">::</span><span class="nv">Logger</span><span class="p">::</span><span class="nf">setOutput</span><span class="p">(</span><span class="n">outputFunc</span><span class="p">);</span>
  <span class="nn">muduo</span><span class="p">::</span><span class="nv">Logger</span><span class="p">::</span><span class="nf">setFlush</span><span class="p">(</span><span class="n">flushFunc</span><span class="p">);</span>
 
  <span class="nn">muduo</span><span class="p">::</span><span class="n">string</span> <span class="n">line</span> <span class="o">=</span> <span class="s">&#34;1234567890 abcdefghijklmnopqrstuvwxyz ABCDEFGHIJKLMNOPQRSTUVWXYZ &#34;</span><span class="p">;</span>
 
  <span class="nf">for</span> <span class="p">(</span><span class="n">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">10000</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="nv">LOG_INFO</span> <span class="o">&lt;&lt;</span> <span class="n">line</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">;</span>
 
    <span class="nf">usleep</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<h3 id="程序输出-4">程序输出</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="p">[</span><span class="n">root</span><span class="p">@</span><span class="n">localhost</span> <span class="n">bin</span><span class="p">]</span><span class="err">#</span> <span class="n">cat</span> <span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">muduo_log</span>
<span class="mi">20131016</span> <span class="mi">15</span><span class="p">:</span><span class="mi">50</span><span class="p">:</span><span class="mi">46</span><span class="p">.</span><span class="mi">099054</span><span class="nv">Z</span>  <span class="mi">4358</span> <span class="nv">TRACE</span> <span class="n">main</span> <span class="nb">trace</span> <span class="p">...</span> <span class="p">-</span><span class="err"> L</span><span class="ni">og_test2</span><span class="p">.</span><span class="nn">cc</span><span class="p">:</span><span class="mi">28</span>
<span class="mi">20131016</span> <span class="mi">15</span><span class="p">:</span><span class="mi">50</span><span class="p">:</span><span class="mi">46</span><span class="p">.</span><span class="mi">099182</span><span class="nv">Z</span>  <span class="mi">4358</span> <span class="nv">DEBUG</span> <span class="n">main</span> <span class="n">debug</span> <span class="p">...</span> <span class="p">-</span><span class="err"> L</span><span class="ni">og_test2</span><span class="p">.</span><span class="nn">cc</span><span class="p">:</span><span class="mi">29</span>
<span class="mi">20131016</span> <span class="mi">15</span><span class="p">:</span><span class="mi">50</span><span class="p">:</span><span class="mi">46</span><span class="p">.</span><span class="mi">099191</span><span class="nv">Z</span>  <span class="mi">4358</span> <span class="nv">INFO</span>  <span class="n">info</span> <span class="p">...</span> <span class="p">-</span><span class="err"> L</span><span class="ni">og_test2</span><span class="p">.</span><span class="nn">cc</span><span class="p">:</span><span class="mi">30</span>
<span class="mi">20131016</span> <span class="mi">15</span><span class="p">:</span><span class="mi">50</span><span class="p">:</span><span class="mi">46</span><span class="p">.</span><span class="mi">099197</span><span class="nv">Z</span>  <span class="mi">4358</span> <span class="nv">WARN</span>  <span class="n">warn</span> <span class="p">...</span> <span class="p">-</span><span class="err"> L</span><span class="ni">og_test2</span><span class="p">.</span><span class="nn">cc</span><span class="p">:</span><span class="mi">31</span>
<span class="mi">20131016</span> <span class="mi">15</span><span class="p">:</span><span class="mi">50</span><span class="p">:</span><span class="mi">46</span><span class="p">.</span><span class="mi">099201</span><span class="nv">Z</span>  <span class="mi">4358</span> <span class="nv">ERROR</span> <span class="n">error</span> <span class="p">...</span> <span class="p">-</span><span class="err"> L</span><span class="ni">og_test2</span><span class="p">.</span><span class="nn">cc</span><span class="p">:</span><span class="mi">32</span>
<span class="mi">20131016</span> <span class="mi">15</span><span class="p">:</span><span class="mi">50</span><span class="p">:</span><span class="mi">46</span><span class="p">.</span><span class="mi">099206</span><span class="nv">Z</span>  <span class="mi">4358</span> <span class="nv">ERROR</span> <span class="nv">Permission</span> <span class="nf">denied</span> <span class="p">(</span><span class="n">errno</span><span class="o">=</span><span class="mi">13</span><span class="p">)</span> <span class="n">syserr</span> <span class="p">...</span> <span class="p">-</span><span class="err"> L</span><span class="ni">og_test2</span><span class="p">.</span><span class="nn">cc</span><span class="p">:</span><span class="mi">35</span>
<span class="p">[</span><span class="n">root</span><span class="p">@</span><span class="n">localhost</span> <span class="n">bin</span><span class="p">]</span><span class="err">#</span></code></pre></td></tr></table>
</div>
</div>
<h3 id="测试程序3">测试程序3</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-erlang" data-lang="erlang"><span class="nl">#include</span> <span class="o">&lt;</span><span class="n">muduo</span><span class="o">/</span><span class="n">base</span><span class="o">/</span><span class="nv">Logging</span><span class="p">.</span><span class="n">h</span><span class="o">&gt;</span>
<span class="nl">#include</span> <span class="o">&lt;</span><span class="n">muduo</span><span class="o">/</span><span class="n">base</span><span class="o">/</span><span class="nv">LogFile</span><span class="p">.</span><span class="n">h</span><span class="o">&gt;</span>
<span class="nl">#include</span> <span class="o">&lt;</span><span class="n">muduo</span><span class="o">/</span><span class="n">base</span><span class="o">/</span><span class="nv">ThreadPool</span><span class="p">.</span><span class="n">h</span><span class="o">&gt;</span>
 
<span class="nl">#include</span> <span class="o">&lt;</span><span class="n">stdio</span><span class="p">.</span><span class="n">h</span><span class="o">&gt;</span>
 
<span class="n">int</span> <span class="n">g_total</span><span class="p">;</span>
<span class="nv">FILE</span><span class="o">*</span> <span class="n">g_file</span><span class="p">;</span>
<span class="nn">boost</span><span class="p">::</span><span class="n">scoped_ptr</span><span class="o">&lt;</span><span class="nn">muduo</span><span class="p">::</span><span class="nv">LogFile</span><span class="o">&gt;</span> <span class="n">g_logFile</span><span class="p">;</span>
 
<span class="n">void</span> <span class="nf">dummyOutput</span><span class="p">(</span><span class="n">const</span> <span class="n">char</span><span class="o">*</span> <span class="n">msg</span><span class="p">,</span> <span class="n">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">g_total</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">g_file</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="nf">fwrite</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">g_file</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="n">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">g_logFile</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">g_logFile</span><span class="p">-</span><span class="err">&gt;</span><span class="ni">append</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>
 
<span class="n">void</span> <span class="nf">bench</span><span class="p">(</span><span class="n">const</span> <span class="n">char</span><span class="o">*</span> <span class="n">type</span><span class="p">)</span>
<span class="p">{</span>
  <span class="nn">muduo</span><span class="p">::</span><span class="nv">Logger</span><span class="p">::</span><span class="nf">setOutput</span><span class="p">(</span><span class="n">dummyOutput</span><span class="p">);</span>
  <span class="nn">muduo</span><span class="p">::</span><span class="nv">Timestamp</span> <span class="nf">start</span><span class="p">(</span><span class="nn">muduo</span><span class="p">::</span><span class="nv">Timestamp</span><span class="p">::</span><span class="nf">now</span><span class="p">());</span>
  <span class="n">g_total</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
 
  <span class="n">int</span> <span class="n">n</span> <span class="o">=</span> <span class="mi">1000</span><span class="o">*</span><span class="mi">1000</span><span class="p">;</span>
  <span class="n">const</span> <span class="n">bool</span> <span class="n">kLongLog</span> <span class="o">=</span> <span class="n">false</span><span class="p">;</span>
  <span class="nn">muduo</span><span class="p">::</span><span class="n">string</span> <span class="n">empty</span> <span class="o">=</span> <span class="s">&#34; &#34;</span><span class="p">;</span>
  <span class="nn">muduo</span><span class="p">::</span><span class="n">string</span> <span class="nf">longStr</span><span class="p">(</span><span class="mi">3000</span><span class="p">,</span> <span class="n">&#39;X&#39;</span><span class="p">);</span>
  <span class="n">longStr</span> <span class="o">+=</span> <span class="s">&#34; &#34;</span><span class="p">;</span>
  <span class="nf">for</span> <span class="p">(</span><span class="n">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="nv">LOG_INFO</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;Hello 0123456789&#34;</span> <span class="o">&lt;&lt;</span> <span class="s">&#34; abcdefghijklmnopqrstuvwxyz&#34;</span>
             <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">kLongLog</span> <span class="o">?</span> <span class="n">longStr</span> <span class="p">:</span> <span class="n">empty</span><span class="p">)</span>
             <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="nn">muduo</span><span class="p">::</span><span class="nv">Timestamp</span> <span class="k">end</span><span class="p">(</span><span class="nn">muduo</span><span class="p">::</span><span class="nv">Timestamp</span><span class="p">::</span><span class="nf">now</span><span class="p">());</span>
  <span class="n">double</span> <span class="n">seconds</span> <span class="o">=</span> <span class="nf">timeDifference</span><span class="p">(</span><span class="k">end</span><span class="p">,</span> <span class="n">start</span><span class="p">);</span>
  <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;%12s: %f seconds, %d bytes, %10.2f msg/s, %.2f MiB/s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span>
         <span class="n">type</span><span class="p">,</span> <span class="n">seconds</span><span class="p">,</span> <span class="n">g_total</span><span class="p">,</span> <span class="n">n</span> <span class="o">/</span> <span class="n">seconds</span><span class="p">,</span> <span class="n">g_total</span> <span class="o">/</span> <span class="n">seconds</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">));</span>
<span class="p">}</span>
 
<span class="n">void</span> <span class="nf">logInThread</span><span class="p">()</span>
<span class="p">{</span>
  <span class="nv">LOG_INFO</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;logInThread&#34;</span><span class="p">;</span>
  <span class="nf">usleep</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>
<span class="p">}</span>
 
<span class="n">int</span> <span class="nf">main</span><span class="p">()</span>
<span class="p">{</span>
  <span class="nf">getppid</span><span class="p">();</span> <span class="o">//</span> <span class="n">for</span> <span class="n">ltrace</span> <span class="ow">and</span> <span class="n">strace</span>
    <span class="o">//</span><span class="err">线程池</span> <span class="err">，</span> <span class="err">名字</span><span class="s">&#34;pool&#34;</span>
  <span class="nn">muduo</span><span class="p">::</span><span class="nv">ThreadPool</span> <span class="nf">pool</span><span class="p">(</span><span class="s">&#34;pool&#34;</span><span class="p">);</span>
    <span class="o">//</span><span class="err">五个线程</span>
  <span class="n">pool</span><span class="p">.</span><span class="nf">start</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>
  <span class="o">//</span><span class="err">五个任务</span>
  <span class="n">pool</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="n">logInThread</span><span class="p">);</span>
  <span class="n">pool</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="n">logInThread</span><span class="p">);</span>
  <span class="n">pool</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="n">logInThread</span><span class="p">);</span>
  <span class="n">pool</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="n">logInThread</span><span class="p">);</span>
  <span class="n">pool</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="n">logInThread</span><span class="p">);</span>
 
  <span class="nv">LOG_TRACE</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;trace&#34;</span><span class="p">;</span>
  <span class="nv">LOG_DEBUG</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;debug&#34;</span><span class="p">;</span>
  <span class="nv">LOG_INFO</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;Hello&#34;</span><span class="p">;</span>
  <span class="nv">LOG_WARN</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;World&#34;</span><span class="p">;</span>
  <span class="nv">LOG_ERROR</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;Error&#34;</span><span class="p">;</span>
  <span class="nv">LOG_INFO</span> <span class="o">&lt;&lt;</span> <span class="nf">sizeof</span><span class="p">(</span><span class="nn">muduo</span><span class="p">::</span><span class="nv">Logger</span><span class="p">);</span>
  <span class="nv">LOG_INFO</span> <span class="o">&lt;&lt;</span> <span class="nf">sizeof</span><span class="p">(</span><span class="nn">muduo</span><span class="p">::</span><span class="nv">LogStream</span><span class="p">);</span>
  <span class="nv">LOG_INFO</span> <span class="o">&lt;&lt;</span> <span class="nf">sizeof</span><span class="p">(</span><span class="nn">muduo</span><span class="p">::</span><span class="nv">Fmt</span><span class="p">);</span>
  <span class="nv">LOG_INFO</span> <span class="o">&lt;&lt;</span> <span class="nf">sizeof</span><span class="p">(</span><span class="nn">muduo</span><span class="p">::</span><span class="nv">LogStream</span><span class="p">::</span><span class="nv">Buffer</span><span class="p">);</span>
 
  <span class="nf">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
  <span class="o">//</span>
  <span class="nf">bench</span><span class="p">(</span><span class="s">&#34;nop&#34;</span><span class="p">);</span>
 
  <span class="n">char</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">64</span><span class="o">*</span><span class="mi">1024</span><span class="p">];</span>
 
  <span class="n">g_file</span> <span class="o">=</span> <span class="nf">fopen</span><span class="p">(</span><span class="s">&#34;/dev/null&#34;</span><span class="p">,</span> <span class="s">&#34;w&#34;</span><span class="p">);</span>
  <span class="nf">setbuffer</span><span class="p">(</span><span class="n">g_file</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="n">sizeof</span> <span class="n">buffer</span><span class="p">);</span>
  <span class="nf">bench</span><span class="p">(</span><span class="s">&#34;/dev/null&#34;</span><span class="p">);</span>
  <span class="nf">fclose</span><span class="p">(</span><span class="n">g_file</span><span class="p">);</span>
 
  <span class="n">g_file</span> <span class="o">=</span> <span class="nf">fopen</span><span class="p">(</span><span class="s">&#34;/tmp/log&#34;</span><span class="p">,</span> <span class="s">&#34;w&#34;</span><span class="p">);</span>
  <span class="nf">setbuffer</span><span class="p">(</span><span class="n">g_file</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="n">sizeof</span> <span class="n">buffer</span><span class="p">);</span>
  <span class="nf">bench</span><span class="p">(</span><span class="s">&#34;/tmp/log&#34;</span><span class="p">);</span>
  <span class="nf">fclose</span><span class="p">(</span><span class="n">g_file</span><span class="p">);</span>
 
  <span class="n">g_file</span> <span class="o">=</span> <span class="nv">NULL</span><span class="p">;</span>
  <span class="o">//</span><span class="err">线程安全的方式</span>
  <span class="n">g_logFile</span><span class="p">.</span><span class="nf">reset</span><span class="p">(</span><span class="n">new</span> <span class="nn">muduo</span><span class="p">::</span><span class="nv">LogFile</span><span class="p">(</span><span class="s">&#34;test_log_st&#34;</span><span class="p">,</span> <span class="mi">500</span><span class="o">*</span><span class="mi">1000</span><span class="o">*</span><span class="mi">1000</span><span class="p">,</span> <span class="n">false</span><span class="p">));</span>
  <span class="nf">bench</span><span class="p">(</span><span class="s">&#34;test_log_st&#34;</span><span class="p">);</span>
    <span class="o">//</span><span class="err">线程不安全的方式</span>
  <span class="n">g_logFile</span><span class="p">.</span><span class="nf">reset</span><span class="p">(</span><span class="n">new</span> <span class="nn">muduo</span><span class="p">::</span><span class="nv">LogFile</span><span class="p">(</span><span class="s">&#34;test_log_mt&#34;</span><span class="p">,</span> <span class="mi">500</span><span class="o">*</span><span class="mi">1000</span><span class="o">*</span><span class="mi">1000</span><span class="p">,</span> <span class="n">true</span><span class="p">));</span>
  <span class="nf">bench</span><span class="p">(</span><span class="s">&#34;test_log_mt&#34;</span><span class="p">);</span>
  <span class="n">g_logFile</span><span class="p">.</span><span class="nf">reset</span><span class="p">();</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<h2 id="21-logger-2">[21] Logger-2</h2>

<p><center> <img src="http://laohanlinux.github.io/images/img/blog/muduo_base_library/logger2.png" alt="" /></center></p>

<h3 id="logstream类图">LogStream类图</h3>

<p><center> <img src="http://laohanlinux.github.io/images/img/blog/muduo_base_library/logstream.png" alt="" /></center></p>

<h3 id="fixedbuffer类图">FixedBuffer类图</h3>

<p><center><img src="http://laohanlinux.github.io/images/img/blog/muduo_base_library/fixedbuffer.png" alt="" /></center></p>

<h3 id="logger类图">Logger类图</h3>

<p><center><img src="http://laohanlinux.github.io/images/img/blog/muduo_base_library/logger3.png" alt="" /></center></p>

<h3 id="impl类图">Impl类图</h3>

<p><center><img src="http://laohanlinux.github.io/images/img/blog/muduo_base_library/loggerimpl.png" alt="" /></center></p>

<h3 id="logstream的测试程序1">LogStream的测试程序1</h3>

<p>logstream_test.cc</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-c++" data-lang="c++"><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span><span class="lnt">177
</span><span class="lnt">178
</span><span class="lnt">179
</span><span class="lnt">180
</span><span class="lnt">181
</span><span class="lnt">182
</span><span class="lnt">183
</span><span class="lnt">184
</span><span class="lnt">185
</span><span class="lnt">186
</span><span class="lnt">187
</span><span class="lnt">188
</span><span class="lnt">189
</span><span class="lnt">190
</span><span class="lnt">191
</span><span class="lnt">192
</span><span class="lnt">193
</span><span class="lnt">194
</span><span class="lnt">195
</span><span class="lnt">196
</span><span class="lnt">197
</span><span class="lnt">198
</span><span class="lnt">199
</span><span class="lnt">200
</span><span class="lnt">201
</span><span class="lnt">202
</span><span class="lnt">203
</span><span class="lnt">204
</span><span class="lnt">205
</span><span class="lnt">206
</span><span class="lnt">207
</span><span class="lnt">208
</span><span class="lnt">209
</span><span class="lnt">210
</span><span class="lnt">211
</span><span class="lnt">212
</span><span class="lnt">213
</span><span class="lnt">214
</span><span class="lnt">215
</span><span class="lnt">216
</span><span class="lnt">217
</span><span class="lnt">218
</span><span class="lnt">219
</span><span class="lnt">220
</span><span class="lnt">221
</span><span class="lnt">222
</span><span class="lnt">223
</span><span class="lnt">224
</span><span class="lnt">225
</span><span class="lnt">226
</span><span class="lnt">227
</span><span class="lnt">228
</span><span class="lnt">229
</span><span class="lnt">230
</span><span class="lnt">231
</span><span class="lnt">232
</span><span class="lnt">233
</span><span class="lnt">234
</span><span class="lnt">235
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c++" data-lang="c++"><span class="cp">#include</span> <span class="cpf">&lt;muduo/base/LogStream.h&gt;</span><span class="cp">
</span><span class="cp"></span> 
<span class="cp">#include</span> <span class="cpf">&lt;limits&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;stdint.h&gt;</span><span class="cp">
</span><span class="cp"></span> 
<span class="c1">//#define BOOST_TEST_MODULE LogStreamTest
</span><span class="c1"></span><span class="cp">#define BOOST_TEST_MAIN
</span><span class="cp">#define BOOST_TEST_DYN_LINK
</span><span class="cp">#include</span> <span class="cpf">&lt;boost/test/unit_test.hpp&gt;</span><span class="cp">
</span><span class="cp"></span> 
<span class="k">using</span> <span class="n">muduo</span><span class="o">::</span><span class="n">string</span><span class="p">;</span>
 
<span class="n">BOOST_AUTO_TEST_CASE</span><span class="p">(</span><span class="n">testLogStreamBooleans</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">muduo</span><span class="o">::</span><span class="n">LogStream</span> <span class="n">os</span><span class="p">;</span>
  <span class="k">const</span> <span class="n">muduo</span><span class="o">::</span><span class="n">LogStream</span><span class="o">::</span><span class="n">Buffer</span><span class="o">&amp;</span> <span class="n">buf</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">buffer</span><span class="p">();</span>
  <span class="n">BOOST_CHECK_EQUAL</span><span class="p">(</span><span class="n">buf</span><span class="p">.</span><span class="n">asString</span><span class="p">(),</span> <span class="n">string</span><span class="p">(</span><span class="s">&#34;&#34;</span><span class="p">));</span>
  <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="nb">true</span><span class="p">;</span>
  <span class="n">BOOST_CHECK_EQUAL</span><span class="p">(</span><span class="n">buf</span><span class="p">.</span><span class="n">asString</span><span class="p">(),</span> <span class="n">string</span><span class="p">(</span><span class="s">&#34;1&#34;</span><span class="p">));</span>
  <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="sc">&#39;\n&#39;</span><span class="p">;</span>
  <span class="n">BOOST_CHECK_EQUAL</span><span class="p">(</span><span class="n">buf</span><span class="p">.</span><span class="n">asString</span><span class="p">(),</span> <span class="n">string</span><span class="p">(</span><span class="s">&#34;1</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">));</span>
  <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="nb">false</span><span class="p">;</span>
  <span class="n">BOOST_CHECK_EQUAL</span><span class="p">(</span><span class="n">buf</span><span class="p">.</span><span class="n">asString</span><span class="p">(),</span> <span class="n">string</span><span class="p">(</span><span class="s">&#34;1</span><span class="se">\n</span><span class="s">0&#34;</span><span class="p">));</span>
<span class="p">}</span>
 
<span class="n">BOOST_AUTO_TEST_CASE</span><span class="p">(</span><span class="n">testLogStreamIntegers</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">muduo</span><span class="o">::</span><span class="n">LogStream</span> <span class="n">os</span><span class="p">;</span>
  <span class="k">const</span> <span class="n">muduo</span><span class="o">::</span><span class="n">LogStream</span><span class="o">::</span><span class="n">Buffer</span><span class="o">&amp;</span> <span class="n">buf</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">buffer</span><span class="p">();</span>
  <span class="n">BOOST_CHECK_EQUAL</span><span class="p">(</span><span class="n">buf</span><span class="p">.</span><span class="n">asString</span><span class="p">(),</span> <span class="n">string</span><span class="p">(</span><span class="s">&#34;&#34;</span><span class="p">));</span>
  <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">;</span>
  <span class="n">BOOST_CHECK_EQUAL</span><span class="p">(</span><span class="n">buf</span><span class="p">.</span><span class="n">asString</span><span class="p">(),</span> <span class="n">string</span><span class="p">(</span><span class="s">&#34;1&#34;</span><span class="p">));</span>
  <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">BOOST_CHECK_EQUAL</span><span class="p">(</span><span class="n">buf</span><span class="p">.</span><span class="n">asString</span><span class="p">(),</span> <span class="n">string</span><span class="p">(</span><span class="s">&#34;10&#34;</span><span class="p">));</span>
  <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
  <span class="n">BOOST_CHECK_EQUAL</span><span class="p">(</span><span class="n">buf</span><span class="p">.</span><span class="n">asString</span><span class="p">(),</span> <span class="n">string</span><span class="p">(</span><span class="s">&#34;10-1&#34;</span><span class="p">));</span>
  <span class="n">os</span><span class="p">.</span><span class="n">resetBuffer</span><span class="p">();</span>
 
  <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="mi">0</span> <span class="o">&lt;&lt;</span> <span class="s">&#34; &#34;</span> <span class="o">&lt;&lt;</span> <span class="mi">123</span> <span class="o">&lt;&lt;</span> <span class="sc">&#39;x&#39;</span> <span class="o">&lt;&lt;</span> <span class="mh">0x64</span><span class="p">;</span>
  <span class="n">BOOST_CHECK_EQUAL</span><span class="p">(</span><span class="n">buf</span><span class="p">.</span><span class="n">asString</span><span class="p">(),</span> <span class="n">string</span><span class="p">(</span><span class="s">&#34;0 123x100&#34;</span><span class="p">));</span>
<span class="p">}</span>
 
<span class="n">BOOST_AUTO_TEST_CASE</span><span class="p">(</span><span class="n">testLogStreamIntegerLimits</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">muduo</span><span class="o">::</span><span class="n">LogStream</span> <span class="n">os</span><span class="p">;</span>
  <span class="k">const</span> <span class="n">muduo</span><span class="o">::</span><span class="n">LogStream</span><span class="o">::</span><span class="n">Buffer</span><span class="o">&amp;</span> <span class="n">buf</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">buffer</span><span class="p">();</span>
  <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="o">-</span><span class="mi">2147483647</span><span class="p">;</span>
  <span class="n">BOOST_CHECK_EQUAL</span><span class="p">(</span><span class="n">buf</span><span class="p">.</span><span class="n">asString</span><span class="p">(),</span> <span class="n">string</span><span class="p">(</span><span class="s">&#34;-2147483647&#34;</span><span class="p">));</span>
  <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="p">(</span><span class="o">-</span><span class="mi">2147483647</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
  <span class="n">BOOST_CHECK_EQUAL</span><span class="p">(</span><span class="n">buf</span><span class="p">.</span><span class="n">asString</span><span class="p">(),</span> <span class="n">string</span><span class="p">(</span><span class="s">&#34;-2147483647-2147483648&#34;</span><span class="p">));</span>
  <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="sc">&#39; &#39;</span><span class="p">;</span>
  <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="mi">2147483647</span><span class="p">;</span>
  <span class="n">BOOST_CHECK_EQUAL</span><span class="p">(</span><span class="n">buf</span><span class="p">.</span><span class="n">asString</span><span class="p">(),</span> <span class="n">string</span><span class="p">(</span><span class="s">&#34;-2147483647-2147483648 2147483647&#34;</span><span class="p">));</span>
  <span class="n">os</span><span class="p">.</span><span class="n">resetBuffer</span><span class="p">();</span>
 
  <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">numeric_limits</span><span class="o">&lt;</span><span class="n">int16_t</span><span class="o">&gt;::</span><span class="n">min</span><span class="p">();</span>
  <span class="n">BOOST_CHECK_EQUAL</span><span class="p">(</span><span class="n">buf</span><span class="p">.</span><span class="n">asString</span><span class="p">(),</span> <span class="n">string</span><span class="p">(</span><span class="s">&#34;-32768&#34;</span><span class="p">));</span>
  <span class="n">os</span><span class="p">.</span><span class="n">resetBuffer</span><span class="p">();</span>
 
  <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">numeric_limits</span><span class="o">&lt;</span><span class="n">int16_t</span><span class="o">&gt;::</span><span class="n">max</span><span class="p">();</span>
  <span class="n">BOOST_CHECK_EQUAL</span><span class="p">(</span><span class="n">buf</span><span class="p">.</span><span class="n">asString</span><span class="p">(),</span> <span class="n">string</span><span class="p">(</span><span class="s">&#34;32767&#34;</span><span class="p">));</span>
  <span class="n">os</span><span class="p">.</span><span class="n">resetBuffer</span><span class="p">();</span>
 
  <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">numeric_limits</span><span class="o">&lt;</span><span class="n">uint16_t</span><span class="o">&gt;::</span><span class="n">min</span><span class="p">();</span>
  <span class="n">BOOST_CHECK_EQUAL</span><span class="p">(</span><span class="n">buf</span><span class="p">.</span><span class="n">asString</span><span class="p">(),</span> <span class="n">string</span><span class="p">(</span><span class="s">&#34;0&#34;</span><span class="p">));</span>
  <span class="n">os</span><span class="p">.</span><span class="n">resetBuffer</span><span class="p">();</span>
 
  <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">numeric_limits</span><span class="o">&lt;</span><span class="n">uint16_t</span><span class="o">&gt;::</span><span class="n">max</span><span class="p">();</span>
  <span class="n">BOOST_CHECK_EQUAL</span><span class="p">(</span><span class="n">buf</span><span class="p">.</span><span class="n">asString</span><span class="p">(),</span> <span class="n">string</span><span class="p">(</span><span class="s">&#34;65535&#34;</span><span class="p">));</span>
  <span class="n">os</span><span class="p">.</span><span class="n">resetBuffer</span><span class="p">();</span>
 
  <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">numeric_limits</span><span class="o">&lt;</span><span class="n">int32_t</span><span class="o">&gt;::</span><span class="n">min</span><span class="p">();</span>
  <span class="n">BOOST_CHECK_EQUAL</span><span class="p">(</span><span class="n">buf</span><span class="p">.</span><span class="n">asString</span><span class="p">(),</span> <span class="n">string</span><span class="p">(</span><span class="s">&#34;-2147483648&#34;</span><span class="p">));</span>
  <span class="n">os</span><span class="p">.</span><span class="n">resetBuffer</span><span class="p">();</span>
 
  <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">numeric_limits</span><span class="o">&lt;</span><span class="n">int32_t</span><span class="o">&gt;::</span><span class="n">max</span><span class="p">();</span>
  <span class="n">BOOST_CHECK_EQUAL</span><span class="p">(</span><span class="n">buf</span><span class="p">.</span><span class="n">asString</span><span class="p">(),</span> <span class="n">string</span><span class="p">(</span><span class="s">&#34;2147483647&#34;</span><span class="p">));</span>
  <span class="n">os</span><span class="p">.</span><span class="n">resetBuffer</span><span class="p">();</span>
 
  <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">numeric_limits</span><span class="o">&lt;</span><span class="n">uint32_t</span><span class="o">&gt;::</span><span class="n">min</span><span class="p">();</span>
  <span class="n">BOOST_CHECK_EQUAL</span><span class="p">(</span><span class="n">buf</span><span class="p">.</span><span class="n">asString</span><span class="p">(),</span> <span class="n">string</span><span class="p">(</span><span class="s">&#34;0&#34;</span><span class="p">));</span>
  <span class="n">os</span><span class="p">.</span><span class="n">resetBuffer</span><span class="p">();</span>
 
  <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">numeric_limits</span><span class="o">&lt;</span><span class="n">uint32_t</span><span class="o">&gt;::</span><span class="n">max</span><span class="p">();</span>
  <span class="n">BOOST_CHECK_EQUAL</span><span class="p">(</span><span class="n">buf</span><span class="p">.</span><span class="n">asString</span><span class="p">(),</span> <span class="n">string</span><span class="p">(</span><span class="s">&#34;4294967295&#34;</span><span class="p">));</span>
  <span class="n">os</span><span class="p">.</span><span class="n">resetBuffer</span><span class="p">();</span>
 
  <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">numeric_limits</span><span class="o">&lt;</span><span class="n">int64_t</span><span class="o">&gt;::</span><span class="n">min</span><span class="p">();</span>
  <span class="n">BOOST_CHECK_EQUAL</span><span class="p">(</span><span class="n">buf</span><span class="p">.</span><span class="n">asString</span><span class="p">(),</span> <span class="n">string</span><span class="p">(</span><span class="s">&#34;-9223372036854775808&#34;</span><span class="p">));</span>
  <span class="n">os</span><span class="p">.</span><span class="n">resetBuffer</span><span class="p">();</span>
 
  <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">numeric_limits</span><span class="o">&lt;</span><span class="n">int64_t</span><span class="o">&gt;::</span><span class="n">max</span><span class="p">();</span>
  <span class="n">BOOST_CHECK_EQUAL</span><span class="p">(</span><span class="n">buf</span><span class="p">.</span><span class="n">asString</span><span class="p">(),</span> <span class="n">string</span><span class="p">(</span><span class="s">&#34;9223372036854775807&#34;</span><span class="p">));</span>
  <span class="n">os</span><span class="p">.</span><span class="n">resetBuffer</span><span class="p">();</span>
 
  <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">numeric_limits</span><span class="o">&lt;</span><span class="n">uint64_t</span><span class="o">&gt;::</span><span class="n">min</span><span class="p">();</span>
  <span class="n">BOOST_CHECK_EQUAL</span><span class="p">(</span><span class="n">buf</span><span class="p">.</span><span class="n">asString</span><span class="p">(),</span> <span class="n">string</span><span class="p">(</span><span class="s">&#34;0&#34;</span><span class="p">));</span>
  <span class="n">os</span><span class="p">.</span><span class="n">resetBuffer</span><span class="p">();</span>
 
  <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">numeric_limits</span><span class="o">&lt;</span><span class="n">uint64_t</span><span class="o">&gt;::</span><span class="n">max</span><span class="p">();</span>
  <span class="n">BOOST_CHECK_EQUAL</span><span class="p">(</span><span class="n">buf</span><span class="p">.</span><span class="n">asString</span><span class="p">(),</span> <span class="n">string</span><span class="p">(</span><span class="s">&#34;18446744073709551615&#34;</span><span class="p">));</span>
  <span class="n">os</span><span class="p">.</span><span class="n">resetBuffer</span><span class="p">();</span>
 
  <span class="n">int16_t</span> <span class="n">a</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">int32_t</span> <span class="n">b</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">int64_t</span> <span class="n">c</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="n">a</span><span class="p">;</span>
  <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="n">b</span><span class="p">;</span>
  <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="n">c</span><span class="p">;</span>
  <span class="n">BOOST_CHECK_EQUAL</span><span class="p">(</span><span class="n">buf</span><span class="p">.</span><span class="n">asString</span><span class="p">(),</span> <span class="n">string</span><span class="p">(</span><span class="s">&#34;000&#34;</span><span class="p">));</span>
<span class="p">}</span>
 
<span class="n">BOOST_AUTO_TEST_CASE</span><span class="p">(</span><span class="n">testLogStreamFloats</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">muduo</span><span class="o">::</span><span class="n">LogStream</span> <span class="n">os</span><span class="p">;</span>
  <span class="k">const</span> <span class="n">muduo</span><span class="o">::</span><span class="n">LogStream</span><span class="o">::</span><span class="n">Buffer</span><span class="o">&amp;</span> <span class="n">buf</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">buffer</span><span class="p">();</span>
 
  <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="mf">0.0</span><span class="p">;</span>
  <span class="n">BOOST_CHECK_EQUAL</span><span class="p">(</span><span class="n">buf</span><span class="p">.</span><span class="n">asString</span><span class="p">(),</span> <span class="n">string</span><span class="p">(</span><span class="s">&#34;0&#34;</span><span class="p">));</span>
  <span class="n">os</span><span class="p">.</span><span class="n">resetBuffer</span><span class="p">();</span>
 
  <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="mf">1.0</span><span class="p">;</span>
  <span class="n">BOOST_CHECK_EQUAL</span><span class="p">(</span><span class="n">buf</span><span class="p">.</span><span class="n">asString</span><span class="p">(),</span> <span class="n">string</span><span class="p">(</span><span class="s">&#34;1&#34;</span><span class="p">));</span>
  <span class="n">os</span><span class="p">.</span><span class="n">resetBuffer</span><span class="p">();</span>
 
  <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="mf">0.1</span><span class="p">;</span>
  <span class="n">BOOST_CHECK_EQUAL</span><span class="p">(</span><span class="n">buf</span><span class="p">.</span><span class="n">asString</span><span class="p">(),</span> <span class="n">string</span><span class="p">(</span><span class="s">&#34;0.1&#34;</span><span class="p">));</span>
  <span class="n">os</span><span class="p">.</span><span class="n">resetBuffer</span><span class="p">();</span>
 
  <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="mf">0.05</span><span class="p">;</span>
  <span class="n">BOOST_CHECK_EQUAL</span><span class="p">(</span><span class="n">buf</span><span class="p">.</span><span class="n">asString</span><span class="p">(),</span> <span class="n">string</span><span class="p">(</span><span class="s">&#34;0.05&#34;</span><span class="p">));</span>
  <span class="n">os</span><span class="p">.</span><span class="n">resetBuffer</span><span class="p">();</span>
 
  <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="mf">0.15</span><span class="p">;</span>
  <span class="n">BOOST_CHECK_EQUAL</span><span class="p">(</span><span class="n">buf</span><span class="p">.</span><span class="n">asString</span><span class="p">(),</span> <span class="n">string</span><span class="p">(</span><span class="s">&#34;0.15&#34;</span><span class="p">));</span>
  <span class="n">os</span><span class="p">.</span><span class="n">resetBuffer</span><span class="p">();</span>
 
  <span class="kt">double</span> <span class="n">a</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">;</span>
  <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="n">a</span><span class="p">;</span>
  <span class="n">BOOST_CHECK_EQUAL</span><span class="p">(</span><span class="n">buf</span><span class="p">.</span><span class="n">asString</span><span class="p">(),</span> <span class="n">string</span><span class="p">(</span><span class="s">&#34;0.1&#34;</span><span class="p">));</span>
  <span class="n">os</span><span class="p">.</span><span class="n">resetBuffer</span><span class="p">();</span>
 
  <span class="kt">double</span> <span class="n">b</span> <span class="o">=</span> <span class="mf">0.05</span><span class="p">;</span>
  <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="n">b</span><span class="p">;</span>
  <span class="n">BOOST_CHECK_EQUAL</span><span class="p">(</span><span class="n">buf</span><span class="p">.</span><span class="n">asString</span><span class="p">(),</span> <span class="n">string</span><span class="p">(</span><span class="s">&#34;0.05&#34;</span><span class="p">));</span>
  <span class="n">os</span><span class="p">.</span><span class="n">resetBuffer</span><span class="p">();</span>
 
  <span class="kt">double</span> <span class="n">c</span> <span class="o">=</span> <span class="mf">0.15</span><span class="p">;</span>
  <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="n">c</span><span class="p">;</span>
  <span class="n">BOOST_CHECK_EQUAL</span><span class="p">(</span><span class="n">buf</span><span class="p">.</span><span class="n">asString</span><span class="p">(),</span> <span class="n">string</span><span class="p">(</span><span class="s">&#34;0.15&#34;</span><span class="p">));</span>
  <span class="n">os</span><span class="p">.</span><span class="n">resetBuffer</span><span class="p">();</span>
 
  <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="n">a</span><span class="o">+</span><span class="n">b</span><span class="p">;</span>
  <span class="n">BOOST_CHECK_EQUAL</span><span class="p">(</span><span class="n">buf</span><span class="p">.</span><span class="n">asString</span><span class="p">(),</span> <span class="n">string</span><span class="p">(</span><span class="s">&#34;0.15&#34;</span><span class="p">));</span>
  <span class="n">os</span><span class="p">.</span><span class="n">resetBuffer</span><span class="p">();</span>
 
  <span class="n">BOOST_CHECK</span><span class="p">(</span><span class="n">a</span><span class="o">+</span><span class="n">b</span> <span class="o">!=</span> <span class="n">c</span><span class="p">);</span>
 
  <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="mf">1.23456789</span><span class="p">;</span>
  <span class="n">BOOST_CHECK_EQUAL</span><span class="p">(</span><span class="n">buf</span><span class="p">.</span><span class="n">asString</span><span class="p">(),</span> <span class="n">string</span><span class="p">(</span><span class="s">&#34;1.23456789&#34;</span><span class="p">));</span>
  <span class="n">os</span><span class="p">.</span><span class="n">resetBuffer</span><span class="p">();</span>
 
  <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="mf">1.234567</span><span class="p">;</span>
  <span class="n">BOOST_CHECK_EQUAL</span><span class="p">(</span><span class="n">buf</span><span class="p">.</span><span class="n">asString</span><span class="p">(),</span> <span class="n">string</span><span class="p">(</span><span class="s">&#34;1.234567&#34;</span><span class="p">));</span>
  <span class="n">os</span><span class="p">.</span><span class="n">resetBuffer</span><span class="p">();</span>
 
  <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="o">-</span><span class="mf">123.456</span><span class="p">;</span>
  <span class="n">BOOST_CHECK_EQUAL</span><span class="p">(</span><span class="n">buf</span><span class="p">.</span><span class="n">asString</span><span class="p">(),</span> <span class="n">string</span><span class="p">(</span><span class="s">&#34;-123.456&#34;</span><span class="p">));</span>
  <span class="n">os</span><span class="p">.</span><span class="n">resetBuffer</span><span class="p">();</span>
<span class="p">}</span>
 
<span class="n">BOOST_AUTO_TEST_CASE</span><span class="p">(</span><span class="n">testLogStreamVoid</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">muduo</span><span class="o">::</span><span class="n">LogStream</span> <span class="n">os</span><span class="p">;</span>
  <span class="k">const</span> <span class="n">muduo</span><span class="o">::</span><span class="n">LogStream</span><span class="o">::</span><span class="n">Buffer</span><span class="o">&amp;</span> <span class="n">buf</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">buffer</span><span class="p">();</span>
 
  <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">void</span><span class="o">*&gt;</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
  <span class="n">BOOST_CHECK_EQUAL</span><span class="p">(</span><span class="n">buf</span><span class="p">.</span><span class="n">asString</span><span class="p">(),</span> <span class="n">string</span><span class="p">(</span><span class="s">&#34;0x0&#34;</span><span class="p">));</span>
  <span class="n">os</span><span class="p">.</span><span class="n">resetBuffer</span><span class="p">();</span>
 
  <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="k">reinterpret_cast</span><span class="o">&lt;</span><span class="kt">void</span><span class="o">*&gt;</span><span class="p">(</span><span class="mi">8888</span><span class="p">);</span>
  <span class="n">BOOST_CHECK_EQUAL</span><span class="p">(</span><span class="n">buf</span><span class="p">.</span><span class="n">asString</span><span class="p">(),</span> <span class="n">string</span><span class="p">(</span><span class="s">&#34;0x22B8&#34;</span><span class="p">));</span>
  <span class="n">os</span><span class="p">.</span><span class="n">resetBuffer</span><span class="p">();</span>
<span class="p">}</span>
 
<span class="n">BOOST_AUTO_TEST_CASE</span><span class="p">(</span><span class="n">testLogStreamStrings</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">muduo</span><span class="o">::</span><span class="n">LogStream</span> <span class="n">os</span><span class="p">;</span>
  <span class="k">const</span> <span class="n">muduo</span><span class="o">::</span><span class="n">LogStream</span><span class="o">::</span><span class="n">Buffer</span><span class="o">&amp;</span> <span class="n">buf</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">buffer</span><span class="p">();</span>
 
  <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;Hello &#34;</span><span class="p">;</span>
  <span class="n">BOOST_CHECK_EQUAL</span><span class="p">(</span><span class="n">buf</span><span class="p">.</span><span class="n">asString</span><span class="p">(),</span> <span class="n">string</span><span class="p">(</span><span class="s">&#34;Hello &#34;</span><span class="p">));</span>
 
  <span class="n">string</span> <span class="n">chenshuo</span> <span class="o">=</span> <span class="s">&#34;Shuo Chen&#34;</span><span class="p">;</span>
  <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="n">chenshuo</span><span class="p">;</span>
  <span class="n">BOOST_CHECK_EQUAL</span><span class="p">(</span><span class="n">buf</span><span class="p">.</span><span class="n">asString</span><span class="p">(),</span> <span class="n">string</span><span class="p">(</span><span class="s">&#34;Hello Shuo Chen&#34;</span><span class="p">));</span>
<span class="p">}</span>
 
<span class="n">BOOST_AUTO_TEST_CASE</span><span class="p">(</span><span class="n">testLogStreamFmts</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">muduo</span><span class="o">::</span><span class="n">LogStream</span> <span class="n">os</span><span class="p">;</span>
  <span class="k">const</span> <span class="n">muduo</span><span class="o">::</span><span class="n">LogStream</span><span class="o">::</span><span class="n">Buffer</span><span class="o">&amp;</span> <span class="n">buf</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">buffer</span><span class="p">();</span>
 
  <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="n">muduo</span><span class="o">::</span><span class="n">Fmt</span><span class="p">(</span><span class="s">&#34;%4d&#34;</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
  <span class="n">BOOST_CHECK_EQUAL</span><span class="p">(</span><span class="n">buf</span><span class="p">.</span><span class="n">asString</span><span class="p">(),</span> <span class="n">string</span><span class="p">(</span><span class="s">&#34;   1&#34;</span><span class="p">));</span>
  <span class="n">os</span><span class="p">.</span><span class="n">resetBuffer</span><span class="p">();</span>
 
  <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="n">muduo</span><span class="o">::</span><span class="n">Fmt</span><span class="p">(</span><span class="s">&#34;%4.2f&#34;</span><span class="p">,</span> <span class="mf">1.2</span><span class="p">);</span>
  <span class="n">BOOST_CHECK_EQUAL</span><span class="p">(</span><span class="n">buf</span><span class="p">.</span><span class="n">asString</span><span class="p">(),</span> <span class="n">string</span><span class="p">(</span><span class="s">&#34;1.20&#34;</span><span class="p">));</span>
  <span class="n">os</span><span class="p">.</span><span class="n">resetBuffer</span><span class="p">();</span>
 
  <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="n">muduo</span><span class="o">::</span><span class="n">Fmt</span><span class="p">(</span><span class="s">&#34;%4.2f&#34;</span><span class="p">,</span> <span class="mf">1.2</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">muduo</span><span class="o">::</span><span class="n">Fmt</span><span class="p">(</span><span class="s">&#34;%4d&#34;</span><span class="p">,</span> <span class="mi">43</span><span class="p">);</span>
  <span class="n">BOOST_CHECK_EQUAL</span><span class="p">(</span><span class="n">buf</span><span class="p">.</span><span class="n">asString</span><span class="p">(),</span> <span class="n">string</span><span class="p">(</span><span class="s">&#34;1.20  43&#34;</span><span class="p">));</span>
  <span class="n">os</span><span class="p">.</span><span class="n">resetBuffer</span><span class="p">();</span>
<span class="p">}</span>
 
<span class="n">BOOST_AUTO_TEST_CASE</span><span class="p">(</span><span class="n">testLogStreamLong</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">muduo</span><span class="o">::</span><span class="n">LogStream</span> <span class="n">os</span><span class="p">;</span>
  <span class="k">const</span> <span class="n">muduo</span><span class="o">::</span><span class="n">LogStream</span><span class="o">::</span><span class="n">Buffer</span><span class="o">&amp;</span> <span class="n">buf</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">buffer</span><span class="p">();</span>
  <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">399</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;123456789 &#34;</span><span class="p">;</span>
    <span class="n">BOOST_CHECK_EQUAL</span><span class="p">(</span><span class="n">buf</span><span class="p">.</span><span class="n">length</span><span class="p">(),</span> <span class="mi">10</span><span class="o">*</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">));</span>
    <span class="n">BOOST_CHECK_EQUAL</span><span class="p">(</span><span class="n">buf</span><span class="p">.</span><span class="n">avail</span><span class="p">(),</span> <span class="mi">4000</span> <span class="o">-</span> <span class="mi">10</span><span class="o">*</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">));</span>
  <span class="p">}</span>
 
  <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;abcdefghi &#34;</span><span class="p">;</span>
  <span class="n">BOOST_CHECK_EQUAL</span><span class="p">(</span><span class="n">buf</span><span class="p">.</span><span class="n">length</span><span class="p">(),</span> <span class="mi">3990</span><span class="p">);</span>
  <span class="n">BOOST_CHECK_EQUAL</span><span class="p">(</span><span class="n">buf</span><span class="p">.</span><span class="n">avail</span><span class="p">(),</span> <span class="mi">10</span><span class="p">);</span>
 
  <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;abcdefghi&#34;</span><span class="p">;</span>
  <span class="n">BOOST_CHECK_EQUAL</span><span class="p">(</span><span class="n">buf</span><span class="p">.</span><span class="n">length</span><span class="p">(),</span> <span class="mi">3999</span><span class="p">);</span>
  <span class="n">BOOST_CHECK_EQUAL</span><span class="p">(</span><span class="n">buf</span><span class="p">.</span><span class="n">avail</span><span class="p">(),</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div>
<p>Logstream 测试程序2 logstream_bench.cc 性能测试，测试不停数据类型的效率</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-c++" data-lang="c++"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c++" data-lang="c++"><span class="cp">#include</span> <span class="cpf">&lt;muduo/base/LogStream.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;muduo/base/Timestamp.h&gt;</span><span class="cp">
</span><span class="cp"></span> 
<span class="cp">#include</span> <span class="cpf">&lt;sstream&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
</span><span class="cp">#define __STDC_FORMAT_MACROS
</span><span class="cp">#include</span> <span class="cpf">&lt;inttypes.h&gt;</span><span class="cp">
</span><span class="cp"></span> 
<span class="k">using</span> <span class="k">namespace</span> <span class="n">muduo</span><span class="p">;</span>
 
<span class="k">const</span> <span class="n">size_t</span> <span class="n">N</span> <span class="o">=</span> <span class="mi">1000000</span><span class="p">;</span>
 
<span class="cp">#pragma GCC diagnostic ignored &#34;-Wold-style-cast&#34;
</span><span class="cp"></span> 
<span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="o">&gt;</span>
<span class="kt">void</span> <span class="n">benchPrintf</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">fmt</span><span class="p">)</span>
<span class="p">{</span>
  <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>
  <span class="n">Timestamp</span> <span class="nf">start</span><span class="p">(</span><span class="n">Timestamp</span><span class="o">::</span><span class="n">now</span><span class="p">());</span>
  <span class="k">for</span> <span class="p">(</span><span class="n">size_t</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">N</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
    <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span> <span class="n">buf</span><span class="p">,</span> <span class="n">fmt</span><span class="p">,</span> <span class="p">(</span><span class="n">T</span><span class="p">)(</span><span class="n">i</span><span class="p">));</span>
  <span class="n">Timestamp</span> <span class="nf">end</span><span class="p">(</span><span class="n">Timestamp</span><span class="o">::</span><span class="n">now</span><span class="p">());</span>
 
  <span class="n">printf</span><span class="p">(</span><span class="s">&#34;benchPrintf %f</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">timeDifference</span><span class="p">(</span><span class="n">end</span><span class="p">,</span> <span class="n">start</span><span class="p">));</span>
<span class="p">}</span>
 
<span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="o">&gt;</span>
<span class="kt">void</span> <span class="n">benchStringStream</span><span class="p">()</span>
<span class="p">{</span>
  <span class="n">Timestamp</span> <span class="n">start</span><span class="p">(</span><span class="n">Timestamp</span><span class="o">::</span><span class="n">now</span><span class="p">());</span>
  <span class="n">std</span><span class="o">::</span><span class="n">ostringstream</span> <span class="n">os</span><span class="p">;</span>
 
  <span class="k">for</span> <span class="p">(</span><span class="n">size_t</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">N</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">T</span><span class="p">)(</span><span class="n">i</span><span class="p">);</span>
    <span class="n">os</span><span class="p">.</span><span class="n">seekp</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="n">ios_base</span><span class="o">::</span><span class="n">beg</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="n">Timestamp</span> <span class="n">end</span><span class="p">(</span><span class="n">Timestamp</span><span class="o">::</span><span class="n">now</span><span class="p">());</span>
 
  <span class="n">printf</span><span class="p">(</span><span class="s">&#34;benchStringStream %f</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">timeDifference</span><span class="p">(</span><span class="n">end</span><span class="p">,</span> <span class="n">start</span><span class="p">));</span>
<span class="p">}</span>
 
<span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="o">&gt;</span>
<span class="kt">void</span> <span class="n">benchLogStream</span><span class="p">()</span>
<span class="p">{</span>
  <span class="n">Timestamp</span> <span class="n">start</span><span class="p">(</span><span class="n">Timestamp</span><span class="o">::</span><span class="n">now</span><span class="p">());</span>
  <span class="n">LogStream</span> <span class="n">os</span><span class="p">;</span>
  <span class="k">for</span> <span class="p">(</span><span class="n">size_t</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">N</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">T</span><span class="p">)(</span><span class="n">i</span><span class="p">);</span>
    <span class="n">os</span><span class="p">.</span><span class="n">resetBuffer</span><span class="p">();</span>
  <span class="p">}</span>
  <span class="n">Timestamp</span> <span class="n">end</span><span class="p">(</span><span class="n">Timestamp</span><span class="o">::</span><span class="n">now</span><span class="p">());</span>
 
  <span class="n">printf</span><span class="p">(</span><span class="s">&#34;benchLogStream %f</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">timeDifference</span><span class="p">(</span><span class="n">end</span><span class="p">,</span> <span class="n">start</span><span class="p">));</span>
<span class="p">}</span>
 
<span class="kt">int</span> <span class="n">main</span><span class="p">()</span>
<span class="p">{</span>
  <span class="n">benchPrintf</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="p">(</span><span class="s">&#34;%d&#34;</span><span class="p">);</span>
 
  <span class="n">puts</span><span class="p">(</span><span class="s">&#34;int&#34;</span><span class="p">);</span>
  <span class="n">benchPrintf</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="p">(</span><span class="s">&#34;%d&#34;</span><span class="p">);</span>
  <span class="n">benchStringStream</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="p">();</span>
  <span class="n">benchLogStream</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="p">();</span>
 
  <span class="n">puts</span><span class="p">(</span><span class="s">&#34;double&#34;</span><span class="p">);</span>
  <span class="n">benchPrintf</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span><span class="p">(</span><span class="s">&#34;%.12g&#34;</span><span class="p">);</span>
  <span class="n">benchStringStream</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span><span class="p">();</span>
  <span class="n">benchLogStream</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span><span class="p">();</span>
 
  <span class="n">puts</span><span class="p">(</span><span class="s">&#34;int64_t&#34;</span><span class="p">);</span>
  <span class="n">benchPrintf</span><span class="o">&lt;</span><span class="n">int64_t</span><span class="o">&gt;</span><span class="p">(</span><span class="s">&#34;%&#34;</span> <span class="n">PRId64</span><span class="p">);</span>
  <span class="n">benchStringStream</span><span class="o">&lt;</span><span class="n">int64_t</span><span class="o">&gt;</span><span class="p">();</span>
  <span class="n">benchLogStream</span><span class="o">&lt;</span><span class="n">int64_t</span><span class="o">&gt;</span><span class="p">();</span>
 
  <span class="n">puts</span><span class="p">(</span><span class="s">&#34;void*&#34;</span><span class="p">);</span>
  <span class="n">benchPrintf</span><span class="o">&lt;</span><span class="kt">void</span><span class="o">*&gt;</span><span class="p">(</span><span class="s">&#34;%p&#34;</span><span class="p">);</span>
  <span class="n">benchStringStream</span><span class="o">&lt;</span><span class="kt">void</span><span class="o">*&gt;</span><span class="p">();</span>
  <span class="n">benchLogStream</span><span class="o">&lt;</span><span class="kt">void</span><span class="o">*&gt;</span><span class="p">();</span>
 
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div>
<h2 id="21-traits-技术">[21] traits 技术</h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-c++" data-lang="c++"><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span><span class="lnt">177
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c++" data-lang="c++"><span class="c1">//
</span><span class="c1">// Redistribution and use in source and binary forms, with or without
</span><span class="c1">// modification, are permitted provided that the following conditions are
</span><span class="c1">// met:
</span><span class="c1">//
</span><span class="c1">//     * Redistributions of source code must retain the above copyright
</span><span class="c1">// notice, this list of conditions and the following disclaimer.
</span><span class="c1">//     * Redistributions in binary form must reproduce the above
</span><span class="c1">// copyright notice, this list of conditions and the following disclaimer
</span><span class="c1">// in the documentation and/or other materials provided with the
</span><span class="c1">// distribution.
</span><span class="c1">//     * Neither the name of Google Inc. nor the names of its
</span><span class="c1">// contributors may be used to endorse or promote products derived from
</span><span class="c1">// this software without specific prior written permission.
</span><span class="c1">//
</span><span class="c1">// THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS
</span><span class="c1">// &#34;AS IS&#34; AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT
</span><span class="c1">// LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR
</span><span class="c1">// A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT
</span><span class="c1">// OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
</span><span class="c1">// SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
</span><span class="c1">// LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
</span><span class="c1">// DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY
</span><span class="c1">// THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
</span><span class="c1">// (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
</span><span class="c1">// OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
</span><span class="c1">//
</span><span class="c1">// Author: Sanjay Ghemawat
</span><span class="c1">//
</span><span class="c1">// A string like object that points into another piece of memory.
</span><span class="c1">// Useful for providing an interface that allows clients to easily
</span><span class="c1">// pass in either a &#34;const char*&#34; or a &#34;string&#34;.
</span><span class="c1">//
</span><span class="c1">// Arghh!  I wish C++ literals were automatically of type &#34;string&#34;.
</span><span class="c1"></span> 
<span class="cp">#ifndef MUDUO_BASE_STRINGPIECE_H
</span><span class="cp">#define MUDUO_BASE_STRINGPIECE_H
</span><span class="cp"></span> 
<span class="cp">#include</span> <span class="cpf">&lt;string.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;iosfwd&gt;    // for ostream forward-declaration</span><span class="cp">
</span><span class="cp"></span> 
<span class="cp">#include</span> <span class="cpf">&lt;muduo/base/Types.h&gt;</span><span class="cp">
</span><span class="cp">#ifndef MUDUO_STD_STRING
</span><span class="cp">#include</span> <span class="cpf">&lt;string&gt;</span><span class="cp">
</span><span class="cp">#endif
</span><span class="cp"></span> 
<span class="k">namespace</span> <span class="n">muduo</span> <span class="p">{</span>
 
<span class="k">class</span><span class="err"> </span><span class="nc">StringPiece</span> <span class="p">{</span>
 <span class="k">private</span><span class="o">:</span>
  <span class="k">const</span> <span class="kt">char</span><span class="o">*</span>   <span class="n">ptr_</span><span class="p">;</span>
  <span class="kt">int</span>           <span class="n">length_</span><span class="p">;</span>
 
 <span class="k">public</span><span class="o">:</span>
  <span class="c1">// We provide non-explicit singleton constructors so users can pass
</span><span class="c1"></span>  <span class="c1">// in a &#34;const char*&#34; or a &#34;string&#34; wherever a &#34;StringPiece&#34; is
</span><span class="c1"></span>  <span class="c1">// expected.
</span><span class="c1"></span>  <span class="n">StringPiece</span><span class="p">()</span>
    <span class="o">:</span> <span class="n">ptr_</span><span class="p">(</span><span class="nb">NULL</span><span class="p">),</span> <span class="n">length_</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="p">{</span> <span class="p">}</span>
  <span class="n">StringPiece</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">str</span><span class="p">)</span>
    <span class="o">:</span> <span class="n">ptr_</span><span class="p">(</span><span class="n">str</span><span class="p">),</span> <span class="n">length_</span><span class="p">(</span><span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="p">(</span><span class="n">strlen</span><span class="p">(</span><span class="n">ptr_</span><span class="p">)))</span> <span class="p">{</span> <span class="p">}</span>
  <span class="n">StringPiece</span><span class="p">(</span><span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span><span class="o">*</span> <span class="n">str</span><span class="p">)</span>
    <span class="o">:</span> <span class="n">ptr_</span><span class="p">(</span><span class="k">reinterpret_cast</span><span class="o">&lt;</span><span class="k">const</span> <span class="kt">char</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">str</span><span class="p">)),</span>
      <span class="n">length_</span><span class="p">(</span><span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="p">(</span><span class="n">strlen</span><span class="p">(</span><span class="n">ptr_</span><span class="p">)))</span> <span class="p">{</span> <span class="p">}</span>
  <span class="n">StringPiece</span><span class="p">(</span><span class="k">const</span> <span class="n">string</span><span class="o">&amp;</span> <span class="n">str</span><span class="p">)</span>
    <span class="o">:</span> <span class="n">ptr_</span><span class="p">(</span><span class="n">str</span><span class="p">.</span><span class="n">data</span><span class="p">()),</span> <span class="n">length_</span><span class="p">(</span><span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="p">(</span><span class="n">str</span><span class="p">.</span><span class="n">size</span><span class="p">()))</span> <span class="p">{</span> <span class="p">}</span>
<span class="cp">#ifndef MUDUO_STD_STRING
</span><span class="cp"></span>  <span class="n">StringPiece</span><span class="p">(</span><span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span> <span class="n">str</span><span class="p">)</span>
    <span class="o">:</span> <span class="n">ptr_</span><span class="p">(</span><span class="n">str</span><span class="p">.</span><span class="n">data</span><span class="p">()),</span> <span class="n">length_</span><span class="p">(</span><span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="p">(</span><span class="n">str</span><span class="p">.</span><span class="n">size</span><span class="p">()))</span> <span class="p">{</span> <span class="p">}</span>
<span class="cp">#endif
</span><span class="cp"></span>  <span class="n">StringPiece</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">offset</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
    <span class="o">:</span> <span class="n">ptr_</span><span class="p">(</span><span class="n">offset</span><span class="p">),</span> <span class="n">length_</span><span class="p">(</span><span class="n">len</span><span class="p">)</span> <span class="p">{</span> <span class="p">}</span>
 
  <span class="c1">// data() may return a pointer to a buffer with embedded NULs, and the
</span><span class="c1"></span>  <span class="c1">// returned buffer may or may not be null terminated.  Therefore it is
</span><span class="c1"></span>  <span class="c1">// typically a mistake to pass data() to a routine that expects a NUL
</span><span class="c1"></span>  <span class="c1">// terminated string.  Use &#34;as_string().c_str()&#34; if you really need to do
</span><span class="c1"></span>  <span class="c1">// this.  Or better yet, change your routine so it does not rely on NUL
</span><span class="c1"></span>  <span class="c1">// termination.
</span><span class="c1"></span>  <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">data</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span> <span class="k">return</span> <span class="n">ptr_</span><span class="p">;</span> <span class="p">}</span>
  <span class="kt">int</span> <span class="n">size</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span> <span class="k">return</span> <span class="n">length_</span><span class="p">;</span> <span class="p">}</span>
  <span class="kt">bool</span> <span class="n">empty</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span> <span class="k">return</span> <span class="n">length_</span> <span class="o">==</span> <span class="mi">0</span><span class="p">;</span> <span class="p">}</span>
 
  <span class="kt">void</span> <span class="n">clear</span><span class="p">()</span> <span class="p">{</span> <span class="n">ptr_</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span> <span class="n">length_</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="p">}</span>
  <span class="kt">void</span> <span class="n">set</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">buffer</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span> <span class="p">{</span> <span class="n">ptr_</span> <span class="o">=</span> <span class="n">buffer</span><span class="p">;</span> <span class="n">length_</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span> <span class="p">}</span>
  <span class="kt">void</span> <span class="n">set</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">str</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">ptr_</span> <span class="o">=</span> <span class="n">str</span><span class="p">;</span>
    <span class="n">length_</span> <span class="o">=</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="p">(</span><span class="n">strlen</span><span class="p">(</span><span class="n">str</span><span class="p">));</span>
  <span class="p">}</span>
  <span class="kt">void</span> <span class="n">set</span><span class="p">(</span><span class="k">const</span> <span class="kt">void</span><span class="o">*</span> <span class="n">buffer</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">ptr_</span> <span class="o">=</span> <span class="k">reinterpret_cast</span><span class="o">&lt;</span><span class="k">const</span> <span class="kt">char</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">buffer</span><span class="p">);</span>
    <span class="n">length_</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>
  <span class="p">}</span>
 
  <span class="kt">char</span> <span class="k">operator</span><span class="p">[](</span><span class="kt">int</span> <span class="n">i</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span> <span class="k">return</span> <span class="n">ptr_</span><span class="p">[</span><span class="n">i</span><span class="p">];</span> <span class="p">}</span>
 
  <span class="kt">void</span> <span class="n">remove_prefix</span><span class="p">(</span><span class="kt">int</span> <span class="n">n</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">ptr_</span> <span class="o">+=</span> <span class="n">n</span><span class="p">;</span>
    <span class="n">length_</span> <span class="o">-=</span> <span class="n">n</span><span class="p">;</span>
  <span class="p">}</span>
 
  <span class="kt">void</span> <span class="n">remove_suffix</span><span class="p">(</span><span class="kt">int</span> <span class="n">n</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">length_</span> <span class="o">-=</span> <span class="n">n</span><span class="p">;</span>
  <span class="p">}</span>
 
  <span class="kt">bool</span> <span class="k">operator</span><span class="o">==</span><span class="p">(</span><span class="k">const</span> <span class="n">StringPiece</span><span class="o">&amp;</span> <span class="n">x</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span>
    <span class="k">return</span> <span class="p">((</span><span class="n">length_</span> <span class="o">==</span> <span class="n">x</span><span class="p">.</span><span class="n">length_</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
            <span class="p">(</span><span class="n">memcmp</span><span class="p">(</span><span class="n">ptr_</span><span class="p">,</span> <span class="n">x</span><span class="p">.</span><span class="n">ptr_</span><span class="p">,</span> <span class="n">length_</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">));</span>
  <span class="p">}</span>
  <span class="kt">bool</span> <span class="k">operator</span><span class="o">!=</span><span class="p">(</span><span class="k">const</span> <span class="n">StringPiece</span><span class="o">&amp;</span> <span class="n">x</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span>
    <span class="k">return</span> <span class="o">!</span><span class="p">(</span><span class="o">*</span><span class="k">this</span> <span class="o">==</span> <span class="n">x</span><span class="p">);</span>
  <span class="p">}</span>
 
<span class="cp">#define STRINGPIECE_BINARY_PREDICATE(cmp,auxcmp)                             \
</span><span class="cp"></span>  <span class="kt">bool</span> <span class="k">operator</span> <span class="n">cmp</span> <span class="p">(</span><span class="k">const</span> <span class="n">StringPiece</span><span class="o">&amp;</span> <span class="n">x</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span>                           \
    <span class="kt">int</span> <span class="n">r</span> <span class="o">=</span> <span class="n">memcmp</span><span class="p">(</span><span class="n">ptr_</span><span class="p">,</span> <span class="n">x</span><span class="p">.</span><span class="n">ptr_</span><span class="p">,</span> <span class="n">length_</span> <span class="o">&lt;</span> <span class="n">x</span><span class="p">.</span><span class="n">length_</span> <span class="o">?</span> <span class="nl">length_</span> <span class="p">:</span> <span class="n">x</span><span class="p">.</span><span class="n">length_</span><span class="p">);</span> \
    <span class="k">return</span> <span class="p">((</span><span class="n">r</span> <span class="n">auxcmp</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span> <span class="p">((</span><span class="n">r</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">length_</span> <span class="n">cmp</span> <span class="n">x</span><span class="p">.</span><span class="n">length_</span><span class="p">)));</span>          \
  <span class="p">}</span>
  <span class="n">STRINGPIECE_BINARY_PREDICATE</span><span class="p">(</span><span class="o">&lt;</span><span class="p">,</span>  <span class="o">&lt;</span><span class="p">);</span>
  <span class="n">STRINGPIECE_BINARY_PREDICATE</span><span class="p">(</span><span class="o">&lt;=</span><span class="p">,</span> <span class="o">&lt;</span><span class="p">);</span>
  <span class="n">STRINGPIECE_BINARY_PREDICATE</span><span class="p">(</span><span class="o">&gt;=</span><span class="p">,</span> <span class="o">&gt;</span><span class="p">);</span>
  <span class="n">STRINGPIECE_BINARY_PREDICATE</span><span class="p">(</span><span class="o">&gt;</span><span class="p">,</span>  <span class="o">&gt;</span><span class="p">);</span>
<span class="cp">#undef STRINGPIECE_BINARY_PREDICATE
</span><span class="cp"></span> 
  <span class="kt">int</span> <span class="nf">compare</span><span class="p">(</span><span class="k">const</span> <span class="n">StringPiece</span><span class="o">&amp;</span> <span class="n">x</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="n">r</span> <span class="o">=</span> <span class="n">memcmp</span><span class="p">(</span><span class="n">ptr_</span><span class="p">,</span> <span class="n">x</span><span class="p">.</span><span class="n">ptr_</span><span class="p">,</span> <span class="n">length_</span> <span class="o">&lt;</span> <span class="n">x</span><span class="p">.</span><span class="n">length_</span> <span class="o">?</span> <span class="nl">length_</span> <span class="p">:</span> <span class="n">x</span><span class="p">.</span><span class="n">length_</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">r</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">length_</span> <span class="o">&lt;</span> <span class="n">x</span><span class="p">.</span><span class="n">length_</span><span class="p">)</span> <span class="n">r</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
      <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">length_</span> <span class="o">&gt;</span> <span class="n">x</span><span class="p">.</span><span class="n">length_</span><span class="p">)</span> <span class="n">r</span> <span class="o">=</span> <span class="o">+</span><span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">r</span><span class="p">;</span>
  <span class="p">}</span>
 
  <span class="n">string</span> <span class="nf">as_string</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">string</span><span class="p">(</span><span class="n">data</span><span class="p">(),</span> <span class="n">size</span><span class="p">());</span>
  <span class="p">}</span>
 
  <span class="kt">void</span> <span class="nf">CopyToString</span><span class="p">(</span><span class="n">string</span><span class="o">*</span> <span class="n">target</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span>
    <span class="n">target</span><span class="o">-&gt;</span><span class="n">assign</span><span class="p">(</span><span class="n">ptr_</span><span class="p">,</span> <span class="n">length_</span><span class="p">);</span>
  <span class="p">}</span>
 
<span class="cp">#ifndef MUDUO_STD_STRING
</span><span class="cp"></span>  <span class="kt">void</span> <span class="nf">CopyToStdString</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">*</span> <span class="n">target</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span>
    <span class="n">target</span><span class="o">-&gt;</span><span class="n">assign</span><span class="p">(</span><span class="n">ptr_</span><span class="p">,</span> <span class="n">length_</span><span class="p">);</span>
  <span class="p">}</span>
<span class="cp">#endif
</span><span class="cp"></span> 
  <span class="c1">// Does &#34;this&#34; start with &#34;x&#34;
</span><span class="c1"></span>  <span class="kt">bool</span> <span class="nf">starts_with</span><span class="p">(</span><span class="k">const</span> <span class="n">StringPiece</span><span class="o">&amp;</span> <span class="n">x</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span>
    <span class="k">return</span> <span class="p">((</span><span class="n">length_</span> <span class="o">&gt;=</span> <span class="n">x</span><span class="p">.</span><span class="n">length_</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">memcmp</span><span class="p">(</span><span class="n">ptr_</span><span class="p">,</span> <span class="n">x</span><span class="p">.</span><span class="n">ptr_</span><span class="p">,</span> <span class="n">x</span><span class="p">.</span><span class="n">length_</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">));</span>
  <span class="p">}</span>
<span class="p">};</span>
 
<span class="p">}</span>   <span class="c1">// namespace muduo
</span><span class="c1"></span> 
<span class="c1">// ------------------------------------------------------------------
</span><span class="c1">// Functions used to create STL containers that use StringPiece
</span><span class="c1">//  Remember that a StringPiece&#39;s lifetime had better be less than
</span><span class="c1">//  that of the underlying string or char*.  If it is not, then you
</span><span class="c1">//  cannot safely store a StringPiece into an STL container
</span><span class="c1">// ------------------------------------------------------------------
</span><span class="c1"></span> 
<span class="cp">#ifdef HAVE_TYPE_TRAITS
</span><span class="cp"></span><span class="c1">// This makes vector&lt;StringPiece&gt; really fast for some STL implementations
</span><span class="c1"></span><span class="k">template</span><span class="o">&lt;&gt;</span> <span class="k">struct</span> <span class="n">__type_traits</span><span class="o">&lt;</span><span class="n">muduo</span><span class="o">::</span><span class="n">StringPiece</span><span class="o">&gt;</span> <span class="p">{</span>
  <span class="k">typedef</span> <span class="n">__true_type</span>    <span class="n">has_trivial_default_constructor</span><span class="p">;</span>
  <span class="k">typedef</span> <span class="n">__true_type</span>    <span class="n">has_trivial_copy_constructor</span><span class="p">;</span>
  <span class="k">typedef</span> <span class="n">__true_type</span>    <span class="n">has_trivial_assignment_operator</span><span class="p">;</span>
  <span class="k">typedef</span> <span class="n">__true_type</span>    <span class="n">has_trivial_destructor</span><span class="p">;</span>
  <span class="k">typedef</span> <span class="n">__true_type</span>    <span class="n">is_POD_type</span><span class="p">;</span>
<span class="p">};</span>
<span class="cp">#endif
</span><span class="cp"></span> 
<span class="c1">// allow StringPiece to be logged
</span><span class="c1"></span><span class="n">std</span><span class="o">::</span><span class="n">ostream</span><span class="o">&amp;</span> <span class="k">operator</span><span class="o">&lt;&lt;</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">ostream</span><span class="o">&amp;</span> <span class="n">o</span><span class="p">,</span> <span class="k">const</span> <span class="n">muduo</span><span class="o">::</span><span class="n">StringPiece</span><span class="o">&amp;</span> <span class="n">piece</span><span class="p">);</span>
 
<span class="cp">#endif  </span><span class="c1">// MUDUO_BASE_STRINGPIECE_H
</span></code></pre></td></tr></table>
</div>
</div>
<h2 id="22-logfile">[22] LogFile</h2>

<p>日志滚动</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></pre></td>
<td class="lntd">
<pre class="chroma">    日志滚动条件
    1、文件大小（例如每写满1G换下一个文件）
    2、时间（每天零点新建一个日志文件，不论前一个文件是否写满）
    一个典型的日志文件名
    logfile_test.20130411-115604.popo.7743.log</pre></td></tr></table>
</div>
</div>
<h3 id="logger-类图">Logger 类图</h3>

<p><center><img src="http://laohanlinux.github.io/images/img/blog/muduo_base_library/loggerclass.png" alt="" /></center></p>

<h3 id="file类图">File类图</h3>

<p><center><img src="http://laohanlinux.github.io/images/img/blog/muduo_base_library/fileclass.png" alt="" /></center></p>

<p>file类是LogFile的一个内置类</p>

<h3 id="logfile头文件-logfile-h">LogFile头文件(logfile.h)</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-c++" data-lang="c++"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c++" data-lang="c++"><span class="cp">#ifndef MUDUO_BASE_LOGFILE_H
</span><span class="cp">#define MUDUO_BASE_LOGFILE_H
</span><span class="cp"></span> 
<span class="cp">#include</span> <span class="cpf">&lt;muduo/base/Mutex.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;muduo/base/Types.h&gt;</span><span class="cp">
</span><span class="cp"></span> 
<span class="cp">#include</span> <span class="cpf">&lt;boost/noncopyable.hpp&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;boost/scoped_ptr.hpp&gt;</span><span class="cp">
</span><span class="cp"></span> 
<span class="k">namespace</span> <span class="n">muduo</span>
<span class="p">{</span>
 
<span class="k">class</span><span class="err"> </span><span class="nc">LogFile</span> <span class="o">:</span> <span class="n">boost</span><span class="o">::</span><span class="n">noncopyable</span>
<span class="p">{</span>
 <span class="k">public</span><span class="o">:</span>
  <span class="n">LogFile</span><span class="p">(</span><span class="k">const</span> <span class="n">string</span><span class="o">&amp;</span> <span class="n">basename</span><span class="p">,</span>
          <span class="n">size_t</span> <span class="n">rollSize</span><span class="p">,</span>
          <span class="kt">bool</span> <span class="n">threadSafe</span> <span class="o">=</span> <span class="nb">true</span><span class="p">,</span>
          <span class="kt">int</span> <span class="n">flushInterval</span> <span class="o">=</span> <span class="mi">3</span><span class="p">);</span>
  <span class="o">~</span><span class="n">LogFile</span><span class="p">();</span>
 
  <span class="kt">void</span> <span class="nf">append</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">logline</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">);</span>
  <span class="kt">void</span> <span class="nf">flush</span><span class="p">();</span>
 
 <span class="k">private</span><span class="o">:</span>
  <span class="kt">void</span> <span class="n">append_unlocked</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">logline</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">);</span>
 
  <span class="k">static</span> <span class="n">string</span> <span class="nf">getLogFileName</span><span class="p">(</span><span class="k">const</span> <span class="n">string</span><span class="o">&amp;</span> <span class="n">basename</span><span class="p">,</span> <span class="n">time_t</span><span class="o">*</span> <span class="n">now</span><span class="p">);</span> <span class="c1">//获取日志文件路径
</span><span class="c1"></span>  <span class="kt">void</span> <span class="nf">rollFile</span><span class="p">();</span> <span class="c1">//滚动日志
</span><span class="c1"></span> 
  <span class="k">const</span> <span class="n">string</span> <span class="n">basename_</span><span class="p">;</span> <span class="c1">//日志文件basename
</span><span class="c1"></span>  <span class="k">const</span> <span class="n">size_t</span> <span class="n">rollSize_</span><span class="p">;</span> <span class="c1">//日志文件达到 rolSize_ 换一个新文件
</span><span class="c1"></span>  <span class="k">const</span> <span class="kt">int</span> <span class="n">flushInterval_</span><span class="p">;</span> <span class="c1">//日志文件写入间隔时间 ，不是每一次的日志都直接写入文件，这样也有助于提高效率
</span><span class="c1"></span> 
  <span class="kt">int</span> <span class="n">count_</span><span class="p">;</span> <span class="c1">//计数器 ，当达到kCheckTimeRoll_时，会去检测是否要滚动日志文件
</span><span class="c1"></span> 
  <span class="n">boost</span><span class="o">::</span><span class="n">scoped_ptr</span><span class="o">&lt;</span><span class="n">MutexLock</span><span class="o">&gt;</span> <span class="n">mutex_</span><span class="p">;</span>
  <span class="n">time_t</span> <span class="n">startOfPeriod_</span><span class="p">;</span> <span class="c1">//开始记录日志时间(调整至零点)
</span><span class="c1"></span>  <span class="n">time_t</span> <span class="n">lastRoll_</span><span class="p">;</span> <span class="c1">//上一次滚动日志文件时间
</span><span class="c1"></span>  <span class="n">time_t</span> <span class="n">lastFlush_</span><span class="p">;</span><span class="c1">//上一次日志写入文件时间
</span><span class="c1"></span>  <span class="k">class</span><span class="err"> </span><span class="nc">File</span><span class="p">;</span>               <span class="c1">//日志文件类
</span><span class="c1"></span>  <span class="n">boost</span><span class="o">::</span><span class="n">scoped_ptr</span><span class="o">&lt;</span><span class="n">File</span><span class="o">&gt;</span> <span class="n">file_</span><span class="p">;</span> <span class="c1">//日子文件指针，这是一个智能指针
</span><span class="c1"></span> 
  <span class="k">const</span> <span class="k">static</span> <span class="kt">int</span> <span class="n">kCheckTimeRoll_</span> <span class="o">=</span> <span class="mi">1024</span><span class="p">;</span> <span class="c1">//
</span><span class="c1"></span>  <span class="k">const</span> <span class="k">static</span> <span class="kt">int</span> <span class="n">kRollPerSeconds_</span> <span class="o">=</span> <span class="mi">60</span><span class="o">*</span><span class="mi">60</span><span class="o">*</span><span class="mi">24</span><span class="p">;</span> <span class="c1">//一天
</span><span class="c1"></span><span class="p">};</span>
 
<span class="p">}</span>
<span class="cp">#endif  </span><span class="c1">// MUDUO_BASE_LOGFILE_H
</span></code></pre></td></tr></table>
</div>
</div>
<h3 id="logfile的源文件">LogFile的源文件</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-c++" data-lang="c++"><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span><span class="lnt">177
</span><span class="lnt">178
</span><span class="lnt">179
</span><span class="lnt">180
</span><span class="lnt">181
</span><span class="lnt">182
</span><span class="lnt">183
</span><span class="lnt">184
</span><span class="lnt">185
</span><span class="lnt">186
</span><span class="lnt">187
</span><span class="lnt">188
</span><span class="lnt">189
</span><span class="lnt">190
</span><span class="lnt">191
</span><span class="lnt">192
</span><span class="lnt">193
</span><span class="lnt">194
</span><span class="lnt">195
</span><span class="lnt">196
</span><span class="lnt">197
</span><span class="lnt">198
</span><span class="lnt">199
</span><span class="lnt">200
</span><span class="lnt">201
</span><span class="lnt">202
</span><span class="lnt">203
</span><span class="lnt">204
</span><span class="lnt">205
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c++" data-lang="c++"><span class="cp">#include</span> <span class="cpf">&lt;muduo/base/LogFile.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;muduo/base/Logging.h&gt; // strerror_tl</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;muduo/base/ProcessInfo.h&gt;</span><span class="cp">
</span><span class="cp"></span> 
<span class="cp">#include</span> <span class="cpf">&lt;assert.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;time.h&gt;</span><span class="cp">
</span><span class="cp"></span> 
<span class="k">using</span> <span class="k">namespace</span> <span class="n">muduo</span><span class="p">;</span>
 
<span class="c1">// not thread safe 不是线程安全
</span><span class="c1"></span><span class="k">class</span><span class="err"> </span><span class="nc">LogFile</span><span class="o">::</span><span class="nl">File</span> <span class="p">:</span> <span class="n">boost</span><span class="o">::</span><span class="n">noncopyable</span> <span class="c1">//不可复制
</span><span class="c1"></span><span class="p">{</span>
 <span class="k">public</span><span class="o">:</span><span class="err">、</span>
    <span class="cm">/********
</span><span class="cm">    //File 类
</span><span class="cm"> 
</span><span class="cm">    **********/</span>
 
  <span class="k">explicit</span> <span class="n">File</span><span class="p">(</span><span class="k">const</span> <span class="n">string</span><span class="o">&amp;</span> <span class="n">filename</span><span class="p">)</span>
    <span class="o">:</span> <span class="n">fp_</span><span class="p">(</span><span class="o">::</span><span class="n">fopen</span><span class="p">(</span><span class="n">filename</span><span class="p">.</span><span class="n">data</span><span class="p">(),</span> <span class="s">&#34;ae&#34;</span><span class="p">)),</span>
      <span class="n">writtenBytes_</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">assert</span><span class="p">(</span><span class="n">fp_</span><span class="p">);</span>  <span class="c1">//断言fp_指针是否为空
</span><span class="c1"></span>    <span class="o">::</span><span class="n">setbuffer</span><span class="p">(</span><span class="n">fp_</span><span class="p">,</span> <span class="n">buffer_</span><span class="p">,</span> <span class="k">sizeof</span> <span class="n">buffer_</span><span class="p">);</span> <span class="c1">//是指缓冲区的大小
</span><span class="c1"></span>    <span class="c1">// posix_fadvise POSIX_FADV_DONTNEED ?
</span><span class="c1"></span>  <span class="p">}</span>
 
    <span class="c1">//虚构函数 ， 关闭fp_指针
</span><span class="c1"></span>  <span class="o">~</span><span class="n">File</span><span class="p">()</span>
  <span class="p">{</span>
    <span class="o">::</span><span class="n">fclose</span><span class="p">(</span><span class="n">fp_</span><span class="p">);</span>
  <span class="p">}</span>
<span class="c1">//追加 日志
</span><span class="c1"></span>  <span class="kt">void</span> <span class="n">append</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">logline</span><span class="p">,</span> <span class="k">const</span> <span class="n">size_t</span> <span class="n">len</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">size_t</span> <span class="n">n</span> <span class="o">=</span> <span class="n">write</span><span class="p">(</span><span class="n">logline</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
    <span class="n">size_t</span> <span class="n">remain</span> <span class="o">=</span> <span class="n">len</span> <span class="o">-</span> <span class="n">n</span><span class="p">;</span>
    <span class="k">while</span> <span class="p">(</span><span class="n">remain</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">size_t</span> <span class="n">x</span> <span class="o">=</span> <span class="n">write</span><span class="p">(</span><span class="n">logline</span> <span class="o">+</span> <span class="n">n</span><span class="p">,</span> <span class="n">remain</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">x</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
      <span class="p">{</span>
        <span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="n">ferror</span><span class="p">(</span><span class="n">fp_</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
        <span class="p">{</span>
          <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&#34;LogFile::File::append() failed %s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">strerror_tl</span><span class="p">(</span><span class="n">err</span><span class="p">));</span>
        <span class="p">}</span>
        <span class="k">break</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="n">n</span> <span class="o">+=</span> <span class="n">x</span><span class="p">;</span>
      <span class="n">remain</span> <span class="o">=</span> <span class="n">len</span> <span class="o">-</span> <span class="n">n</span><span class="p">;</span> <span class="c1">// remain -= x
</span><span class="c1"></span>    <span class="p">}</span>
 
    <span class="n">writtenBytes_</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>
  <span class="p">}</span>
 
<span class="c1">//清空缓冲区
</span><span class="c1"></span>  <span class="kt">void</span> <span class="n">flush</span><span class="p">()</span>
  <span class="p">{</span>
    <span class="o">::</span><span class="n">fflush</span><span class="p">(</span><span class="n">fp_</span><span class="p">);</span>
  <span class="p">}</span>
 
  <span class="n">size_t</span> <span class="n">writtenBytes</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span> <span class="k">return</span> <span class="n">writtenBytes_</span><span class="p">;</span> <span class="p">}</span>
 
 <span class="k">private</span><span class="o">:</span>
<span class="c1">//不加锁写入文件，logfile已经加锁了
</span><span class="c1"></span>  <span class="n">size_t</span> <span class="n">write</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">logline</span><span class="p">,</span> <span class="n">size_t</span> <span class="n">len</span><span class="p">)</span>
  <span class="p">{</span>
<span class="cp">#undef fwrite_unlocked
</span><span class="cp"></span>    <span class="k">return</span> <span class="o">::</span><span class="n">fwrite_unlocked</span><span class="p">(</span><span class="n">logline</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">fp_</span><span class="p">);</span>
  <span class="p">}</span>
 
  <span class="n">FILE</span><span class="o">*</span> <span class="n">fp_</span><span class="p">;</span>
  <span class="kt">char</span> <span class="n">buffer_</span><span class="p">[</span><span class="mi">64</span><span class="o">*</span><span class="mi">1024</span><span class="p">];</span>
  <span class="n">size_t</span> <span class="n">writtenBytes_</span><span class="p">;</span>
<span class="p">};</span>
 
<span class="cm">/*******
</span><span class="cm"> 
</span><span class="cm">LogFile类
</span><span class="cm">*******/</span>
<span class="n">LogFile</span><span class="o">::</span><span class="n">LogFile</span><span class="p">(</span><span class="k">const</span> <span class="n">string</span><span class="o">&amp;</span> <span class="n">basename</span><span class="p">,</span>
                 <span class="n">size_t</span> <span class="n">rollSize</span><span class="p">,</span>      
                 <span class="kt">bool</span> <span class="n">threadSafe</span><span class="p">,</span>          
                 <span class="kt">int</span> <span class="n">flushInterval</span><span class="p">)</span> 
  <span class="o">:</span> <span class="n">basename_</span><span class="p">(</span><span class="n">basename</span><span class="p">),</span><span class="c1">//文件basename
</span><span class="c1"></span>    <span class="n">rollSize_</span><span class="p">(</span><span class="n">rollSize</span><span class="p">),</span><span class="c1">//日志滚动大小界限
</span><span class="c1"></span>    <span class="n">flushInterval_</span><span class="p">(</span><span class="n">flushInterval</span><span class="p">),</span> <span class="c1">//清空缓冲区
</span><span class="c1"></span>    <span class="n">count_</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
    <span class="n">mutex_</span><span class="p">(</span><span class="n">threadSafe</span> <span class="o">?</span> <span class="k">new</span> <span class="nl">MutexLock</span> <span class="p">:</span> <span class="nb">NULL</span><span class="p">),</span><span class="c1">//是否以线程安全的方式进行操作
</span><span class="c1"></span>    <span class="n">startOfPeriod_</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
    <span class="n">lastRoll_</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
    <span class="n">lastFlush_</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="p">{</span>
    <span class="c1">//断言 ，basename 是否包含&#34;/&#34;
</span><span class="c1"></span>  <span class="n">assert</span><span class="p">(</span><span class="n">basename</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="sc">&#39;/&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="n">string</span><span class="o">::</span><span class="n">npos</span><span class="p">);</span>
    <span class="c1">//滚动日志
</span><span class="c1"></span>  <span class="n">rollFile</span><span class="p">();</span>
<span class="p">}</span>
 
<span class="n">LogFile</span><span class="o">::~</span><span class="n">LogFile</span><span class="p">()</span>
<span class="p">{</span>
<span class="p">}</span>
 
<span class="c1">//追加 日志记录
</span><span class="c1"></span><span class="kt">void</span> <span class="n">LogFile</span><span class="o">::</span><span class="n">append</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">logline</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">mutex_</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">MutexLockGuard</span> <span class="n">lock</span><span class="p">(</span><span class="o">*</span><span class="n">mutex_</span><span class="p">);</span>
    <span class="n">append_unlocked</span><span class="p">(</span><span class="n">logline</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">else</span>
  <span class="p">{</span>
    <span class="n">append_unlocked</span><span class="p">(</span><span class="n">logline</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>
 
<span class="kt">void</span> <span class="n">LogFile</span><span class="o">::</span><span class="n">flush</span><span class="p">()</span>
<span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">mutex_</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">MutexLockGuard</span> <span class="n">lock</span><span class="p">(</span><span class="o">*</span><span class="n">mutex_</span><span class="p">);</span>
    <span class="n">file_</span><span class="o">-&gt;</span><span class="n">flush</span><span class="p">();</span>
  <span class="p">}</span>
  <span class="k">else</span>
  <span class="p">{</span>
    <span class="n">file_</span><span class="o">-&gt;</span><span class="n">flush</span><span class="p">();</span>
  <span class="p">}</span>
<span class="p">}</span>
 
<span class="kt">void</span> <span class="n">LogFile</span><span class="o">::</span><span class="n">append_unlocked</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">logline</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">file_</span><span class="o">-&gt;</span><span class="n">append</span><span class="p">(</span><span class="n">logline</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
    <span class="c1">//判断是否要滚动日志文件了 ，大小上测试
</span><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="n">file_</span><span class="o">-&gt;</span><span class="n">writtenBytes</span><span class="p">()</span> <span class="o">&gt;</span> <span class="n">rollSize_</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="c1">//滚动日志文件
</span><span class="c1"></span>    <span class="n">rollFile</span><span class="p">();</span>
  <span class="p">}</span>
  <span class="k">else</span>
  <span class="p">{</span>
    <span class="c1">//时间上测试 ，就是计数器
</span><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">count_</span> <span class="o">&gt;</span> <span class="n">kCheckTimeRoll_</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">count_</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="n">time_t</span> <span class="n">now</span> <span class="o">=</span> <span class="o">::</span><span class="n">time</span><span class="p">(</span><span class="nb">NULL</span><span class="p">);</span>
      <span class="n">time_t</span> <span class="n">thisPeriod_</span> <span class="o">=</span> <span class="n">now</span> <span class="o">/</span> <span class="n">kRollPerSeconds_</span> <span class="o">*</span> <span class="n">kRollPerSeconds_</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">thisPeriod_</span> <span class="o">!=</span> <span class="n">startOfPeriod_</span><span class="p">)</span>
      <span class="p">{</span>
        <span class="n">rollFile</span><span class="p">();</span>
      <span class="p">}</span>
      <span class="c1">//是否应该清空数据
</span><span class="c1"></span>      <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">now</span> <span class="o">-</span> <span class="n">lastFlush_</span> <span class="o">&gt;</span> <span class="n">flushInterval_</span><span class="p">)</span>
      <span class="p">{</span>
        <span class="n">lastFlush_</span> <span class="o">=</span> <span class="n">now</span><span class="p">;</span>
        <span class="n">file_</span><span class="o">-&gt;</span><span class="n">flush</span><span class="p">();</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="c1">//计数器++
</span><span class="c1"></span>    <span class="k">else</span>
    <span class="p">{</span>
      <span class="o">++</span><span class="n">count_</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
 
<span class="c1">//日志滚动
</span><span class="c1"></span><span class="kt">void</span> <span class="n">LogFile</span><span class="o">::</span><span class="n">rollFile</span><span class="p">()</span>
<span class="p">{</span>
  <span class="n">time_t</span> <span class="n">now</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">string</span> <span class="n">filename</span> <span class="o">=</span> <span class="n">getLogFileName</span><span class="p">(</span><span class="n">basename_</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">now</span><span class="p">);</span>
  <span class="n">time_t</span> <span class="n">start</span> <span class="o">=</span> <span class="n">now</span> <span class="o">/</span> <span class="n">kRollPerSeconds_</span> <span class="o">*</span> <span class="n">kRollPerSeconds_</span><span class="p">;</span>
<span class="c1">//如果是时间上的滚动，那么就要更新一下时间了
</span><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="n">now</span> <span class="o">&gt;</span> <span class="n">lastRoll_</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">lastRoll_</span> <span class="o">=</span> <span class="n">now</span><span class="p">;</span>
    <span class="n">lastFlush_</span> <span class="o">=</span> <span class="n">now</span><span class="p">;</span>
    <span class="n">startOfPeriod_</span> <span class="o">=</span> <span class="n">start</span><span class="p">;</span>
    <span class="n">file_</span><span class="p">.</span><span class="n">reset</span><span class="p">(</span><span class="k">new</span> <span class="n">File</span><span class="p">(</span><span class="n">filename</span><span class="p">));</span>
  <span class="p">}</span>
<span class="p">}</span>
 
<span class="c1">//得到日志文件名
</span><span class="c1"></span><span class="n">string</span> <span class="n">LogFile</span><span class="o">::</span><span class="n">getLogFileName</span><span class="p">(</span><span class="k">const</span> <span class="n">string</span><span class="o">&amp;</span> <span class="n">basename</span><span class="p">,</span> <span class="n">time_t</span><span class="o">*</span> <span class="n">now</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">string</span> <span class="n">filename</span><span class="p">;</span>
  <span class="n">filename</span><span class="p">.</span><span class="n">reserve</span><span class="p">(</span><span class="n">basename</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">+</span> <span class="mi">64</span><span class="p">);</span>
  <span class="n">filename</span> <span class="o">=</span> <span class="n">basename</span><span class="p">;</span>
 
  <span class="kt">char</span> <span class="n">timebuf</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>
  <span class="kt">char</span> <span class="n">pidbuf</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>
  <span class="k">struct</span> <span class="n">tm</span> <span class="n">tm</span><span class="p">;</span>
  <span class="o">*</span><span class="n">now</span> <span class="o">=</span> <span class="n">time</span><span class="p">(</span><span class="nb">NULL</span><span class="p">);</span>
  <span class="n">gmtime_r</span><span class="p">(</span><span class="n">now</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tm</span><span class="p">);</span> <span class="c1">// FIXME: localtime_r ?
</span><span class="c1"></span>  <span class="n">strftime</span><span class="p">(</span><span class="n">timebuf</span><span class="p">,</span> <span class="k">sizeof</span> <span class="n">timebuf</span><span class="p">,</span> <span class="s">&#34;.%Y%m%d-%H%M%S.&#34;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tm</span><span class="p">);</span>
  <span class="n">filename</span> <span class="o">+=</span> <span class="n">timebuf</span><span class="p">;</span>
  <span class="n">filename</span> <span class="o">+=</span> <span class="n">ProcessInfo</span><span class="o">::</span><span class="n">hostname</span><span class="p">();</span>
  <span class="n">snprintf</span><span class="p">(</span><span class="n">pidbuf</span><span class="p">,</span> <span class="k">sizeof</span> <span class="n">pidbuf</span><span class="p">,</span> <span class="s">&#34;.%d&#34;</span><span class="p">,</span> <span class="n">ProcessInfo</span><span class="o">::</span><span class="n">pid</span><span class="p">());</span>
  <span class="n">filename</span> <span class="o">+=</span> <span class="n">pidbuf</span><span class="p">;</span>
  <span class="n">filename</span> <span class="o">+=</span> <span class="s">&#34;.log&#34;</span><span class="p">;</span>
 
  <span class="k">return</span> <span class="n">filename</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div>
<h3 id="logfile测试类-logfile-test-cc">LogFile测试类 LogFile_Test.cc</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-c++" data-lang="c++"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c++" data-lang="c++"><span class="cp">#include</span> <span class="cpf">&lt;muduo/base/LogFile.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;muduo/base/Logging.h&gt;</span><span class="cp">
</span><span class="cp"></span> 
<span class="n">boost</span><span class="o">::</span><span class="n">scoped_ptr</span><span class="o">&lt;</span><span class="n">muduo</span><span class="o">::</span><span class="n">LogFile</span><span class="o">&gt;</span> <span class="n">g_logFile</span><span class="p">;</span>
 
<span class="c1">//msg日志内容，日志长度
</span><span class="c1"></span><span class="kt">void</span> <span class="nf">outputFunc</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">msg</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">g_logFile</span><span class="o">-&gt;</span><span class="n">append</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
<span class="p">}</span>
 
<span class="kt">void</span> <span class="nf">flushFunc</span><span class="p">()</span>
<span class="p">{</span>
  <span class="n">g_logFile</span><span class="o">-&gt;</span><span class="n">flush</span><span class="p">();</span>
<span class="p">}</span>
 
<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span><span class="o">*</span> <span class="n">argv</span><span class="p">[])</span>
<span class="p">{</span>
  <span class="kt">char</span> <span class="n">name</span><span class="p">[</span><span class="mi">256</span><span class="p">];</span>
 
  <span class="n">strncpy</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">256</span><span class="p">);</span>
  <span class="c1">//日志滚动的大小200*1000 = 196k
</span><span class="c1"></span>  <span class="n">g_logFile</span><span class="p">.</span><span class="n">reset</span><span class="p">(</span><span class="k">new</span> <span class="n">muduo</span><span class="o">::</span><span class="n">LogFile</span><span class="p">(</span><span class="o">::</span><span class="n">basename</span><span class="p">(</span><span class="n">name</span><span class="p">),</span> <span class="mi">200</span><span class="o">*</span><span class="mi">1000</span><span class="p">));</span>
 
    <span class="c1">//Logger的输出函数
</span><span class="c1"></span>  <span class="n">muduo</span><span class="o">::</span><span class="n">Logger</span><span class="o">::</span><span class="n">setOutput</span><span class="p">(</span><span class="n">outputFunc</span><span class="p">);</span>
    <span class="c1">//Logger的缓冲区清空函数
</span><span class="c1"></span>  <span class="n">muduo</span><span class="o">::</span><span class="n">Logger</span><span class="o">::</span><span class="n">setFlush</span><span class="p">(</span><span class="n">flushFunc</span><span class="p">);</span>
        <span class="c1">//日志
</span><span class="c1"></span>  <span class="n">muduo</span><span class="o">::</span><span class="n">string</span> <span class="n">line</span> <span class="o">=</span> <span class="s">&#34;1234567890 abcdefghijklmnopqrstuvwxyz ABCDEFGHIJKLMNOPQRSTUVWXYZ &#34;</span><span class="p">;</span>
    <span class="c1">//10000条日志记录
</span><span class="c1"></span>  <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">10000</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">LOG_INFO</span> <span class="o">&lt;&lt;</span> <span class="n">line</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">;</span>
 
    <span class="n">usleep</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div>
<h3 id="程序输出-5">程序输出</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-sh" data-lang="sh"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-sh" data-lang="sh"><span class="o">[</span>root@localhost bin<span class="o">]</span><span class="c1"># ls -lh logfile_test*</span>
-rwxr-xr-x. <span class="m">1</span> root root 610K Oct <span class="m">17</span> <span class="m">16</span>:02 logfile_test
-rw-r--r--. <span class="m">1</span> root root 196K Oct <span class="m">17</span> <span class="m">16</span>:03 logfile_test.20131017-080304.localhost.localdomain.2656.log
-rw-r--r--. <span class="m">1</span> root root 196K Oct <span class="m">17</span> <span class="m">16</span>:03 logfile_test.20131017-080309.localhost.localdomain.2656.log
-rw-r--r--. <span class="m">1</span> root root 196K Oct <span class="m">17</span> <span class="m">16</span>:03 logfile_test.20131017-080312.localhost.localdomain.2656.log
-rw-r--r--. <span class="m">1</span> root root 196K Oct <span class="m">17</span> <span class="m">16</span>:03 logfile_test.20131017-080314.localhost.localdomain.2656.log
-rw-r--r--. <span class="m">1</span> root root 196K Oct <span class="m">17</span> <span class="m">16</span>:03 logfile_test.20131017-080316.localhost.localdomain.2656.log
-rw-r--r--. <span class="m">1</span> root root 196K Oct <span class="m">17</span> <span class="m">16</span>:03 logfile_test.20131017-080319.localhost.localdomain.2656.log
-rw-r--r--. <span class="m">1</span> root root  87K Oct <span class="m">17</span> <span class="m">16</span>:03 logfile_test.20131017-080321.localhost.localdomain.2656.log
<span class="o">[</span>root@localhost bin<span class="o">]</span>#</code></pre></td></tr></table>
</div>
</div>
    </div>

    <div class="post-copyright">
  <p class="copyright-item">
    <span class="item-title">Author</span>
    <span class="item-content">Rg</span>
  </p>
  <p class="copyright-item">
    <span class="item-title">LastMod</span>
    <span class="item-content">
        2013-06-10
        
    </span>
  </p>
  
  
</div>
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/muduo/">muduo</a>
          <a href="/tags/muduo-base-library/">muduo base library</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/2014/07/01/muduo-simple-example/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">muduo simple example</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        <a class="next" href="/2013/06/10/muduo-base-library-1/">
            <span class="next-text nav-default">muduo_base_library_1</span>
            <span class="next-text nav-mobile">Next</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        <div id="gitalk-container"></div>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js" crossorigin="anonymous"></script>
    <script type="text/javascript">
      var gitalk = new Gitalk({
        id: '2013-06-10 12:43:39 \x2b0000 UTC',
        title: 'muduo_base_library_2',
        clientID: '88e50f263d090b13460f',
        clientSecret: 'f1007eb6cff0af3b461be3a4b73d808ab7058a21',
        repo: 'blog',
        owner: 'laohanlinux',
        admin: ['laohanlinux'],
        body: decodeURI(location.href)
      });
      gitalk.render('gitalk-container');
    </script>
    <noscript>Please enable JavaScript to view the <a href="https://github.com/gitalk/gitalk">comments powered by gitalk.</a></noscript>

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
      <a href="mailto:daimaldd@email.com" class="iconfont icon-email" title="email"></a>
      <a href="https://github.com/laohanlinux" class="iconfont icon-github" title="github"></a>
  <a href="https://laohanlinux.github.io/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2014 - 
    2019
    <span class="heart">
      <i class="iconfont icon-heart"></i>
    </span>
    <span class="author">Rg</span>
  </span>
</div>
    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script>
<script type="text/javascript" src="/dist/even.26188efa.min.js"></script>








</body>
</html>
