<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>muduo_base_library_1 - Welcome to Rg Home</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<meta name="author" content="Rg" /><meta name="description" content="muduo 是一个linux 网络库，使用poll和epoll模式。 这些内容是本人在大学的时候，通过  &lt;&lt; c&#43;&#43;教程网 &gt;&gt;  所学的知识笔记. 已经过去好几年了，版本也是比较老的了，属于入门级别的教程； 如有错误，纯属正常!!!" /><meta name="keywords" content="Rg, Rust, even" />






<meta name="generator" content="Hugo 0.54.0 with even 4.0.0" />


<link rel="canonical" href="https://laohanlinux.github.io/2013/06/10/muduo-base-library-1/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">


<link href="/dist/even.3292c2b1.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">


<meta property="og:title" content="muduo_base_library_1" />
<meta property="og:description" content="muduo 是一个linux 网络库，使用poll和epoll模式。 这些内容是本人在大学的时候，通过  &lt;&lt; c&#43;&#43;教程网 &gt;&gt;  所学的知识笔记. 已经过去好几年了，版本也是比较老的了，属于入门级别的教程； 如有错误，纯属正常!!!" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://laohanlinux.github.io/2013/06/10/muduo-base-library-1/" />
<meta property="article:published_time" content="2013-06-10T01:09:28&#43;00:00"/>
<meta property="article:modified_time" content="2013-06-10T01:09:28&#43;00:00"/>

<meta itemprop="name" content="muduo_base_library_1">
<meta itemprop="description" content="muduo 是一个linux 网络库，使用poll和epoll模式。 这些内容是本人在大学的时候，通过  &lt;&lt; c&#43;&#43;教程网 &gt;&gt;  所学的知识笔记. 已经过去好几年了，版本也是比较老的了，属于入门级别的教程； 如有错误，纯属正常!!!">


<meta itemprop="datePublished" content="2013-06-10T01:09:28&#43;00:00" />
<meta itemprop="dateModified" content="2013-06-10T01:09:28&#43;00:00" />
<meta itemprop="wordCount" content="7701">



<meta itemprop="keywords" content="muduo,muduo base library," />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="muduo_base_library_1"/>
<meta name="twitter:description" content="muduo 是一个linux 网络库，使用poll和epoll模式。 这些内容是本人在大学的时候，通过  &lt;&lt; c&#43;&#43;教程网 &gt;&gt;  所学的知识笔记. 已经过去好几年了，版本也是比较老的了，属于入门级别的教程； 如有错误，纯属正常!!!"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">Welcome come to Rg Home</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Go ~/</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a>
  </ul>
</nav>
  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">Welcome come to Rg Home</a>
</div>

<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Go ~/</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li>
  </ul>
</nav>
    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">muduo_base_library_1</h1>

      <div class="post-meta">
        <span class="post-time"> 2013-06-10 </span>
        <div class="post-category">
            <a href="/categories/muduo/"> muduo </a>
            <a href="/categories/network-program/"> network program </a>
            </div>
          <span class="more-meta"> 7701 words </span>
          <span class="more-meta"> 16 mins read </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Contents</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
<ul>
<li><a href="#muduo-base-library">Muduo Base Library</a>
<ul>
<li>
<ul>
<li><a href="#面向对象编程">面向对象编程</a></li>
<li><a href="#基于对象编程">基于对象编程</a></li>
<li><a href="#poll">poll</a></li>
<li><a href="#poll2">poll2</a></li>
<li><a href="#epoll-1">epoll 1</a></li>
<li><a href="#epoll-summary">epoll summary</a></li>
<li><a href="#epoll在lt和et模式下的读写方式">Epoll在LT和ET模式下的读写方式</a></li>
</ul></li>
</ul></li>
</ul>
</nav>
  </div>
</div>
    <div class="post-content">
      

<h1 id="muduo-base-library">Muduo Base Library</h1>

<h3 id="面向对象编程">面向对象编程</h3>

<p>面向对象也就是把<code>对象</code>作为<code>接口</code>暴露出去，一般内部是一个<code>接口</code>或者<code>抽象类</code>。</p>

<p><em>source code</em></p>

<ul>
<li>Thread.h</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-c++" data-lang="c++"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c++" data-lang="c++"><span class="cp">#ifndef _THREAD_H_ 
</span><span class="cp">#define _THREAD_H_
</span><span class="cp">#include</span> <span class="cpf">&lt;pthread.h&gt;</span><span class="cp">
</span><span class="cp"></span><span class="k">class</span><span class="err"> </span><span class="nc">Thread</span><span class="p">{</span>
<span class="k">public</span> <span class="o">:</span>
 
    <span class="n">Thread</span><span class="p">();</span>
    <span class="k">virtual</span> <span class="o">~</span><span class="n">Thread</span><span class="p">();</span>
    <span class="kt">void</span> <span class="nf">Start</span><span class="p">();</span>
    <span class="kt">void</span> <span class="nf">Join</span><span class="p">();</span>
 
<span class="k">private</span> <span class="o">:</span>
    <span class="c1">// 纯虚函数 ²»ÐҪ 
</span><span class="c1"></span>    <span class="kt">void</span> <span class="n">Run</span><span class="p">()</span> <span class="o">=</span><span class="mi">0</span> <span class="p">;</span>
    <span class="n">pthread_t</span> <span class="n">threadId_</span> <span class="p">;</span> 
 
<span class="p">};</span><span class="cp">#ifndef _THREAD_H_ 
</span><span class="cp">#define _THREAD_H_
</span><span class="cp">#include</span> <span class="cpf">&lt;pthread.h&gt;</span><span class="cp">
</span><span class="cp"></span><span class="k">class</span><span class="err"> </span><span class="nc">Thread</span><span class="p">{</span>
<span class="k">public</span> <span class="o">:</span>
 
    <span class="n">Thread</span><span class="p">();</span>
    <span class="k">virtual</span> <span class="o">~</span><span class="n">Thread</span><span class="p">();</span>
    <span class="kt">void</span> <span class="nf">Start</span><span class="p">();</span>
    <span class="kt">void</span> <span class="nf">Join</span><span class="p">();</span>
 
<span class="k">private</span> <span class="o">:</span>
    <span class="c1">// 纯虚函数 ²»ÐҪ 
</span><span class="c1"></span>    <span class="kt">void</span> <span class="n">Run</span><span class="p">()</span> <span class="o">=</span><span class="mi">0</span> <span class="p">;</span>
    <span class="n">pthread_t</span> <span class="n">threadId_</span> <span class="p">;</span> 
 
<span class="p">};</span>
</code></pre></td></tr></table>
</div>
</div>
<ul>
<li>Thread.cpp</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-c++" data-lang="c++"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c++" data-lang="c++"><span class="cp">#include</span> <span class="cpf">&#34;Thread.h&#34;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;iostream&gt;</span><span class="cp">
</span><span class="cp"></span><span class="k">using</span> <span class="k">namespace</span> <span class="n">std</span><span class="p">;</span>
 
 
<span class="n">Thread</span><span class="o">::</span><span class="n">Thread</span><span class="p">()</span> <span class="o">:</span> <span class="n">autoDelete_</span><span class="p">(</span><span class="nb">false</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">cout</span><span class="o">&lt;&lt;</span><span class="s">&#34;Thread ...&#34;</span><span class="o">&lt;&lt;</span><span class="n">endl</span><span class="p">;</span>
<span class="p">}</span>
 
<span class="n">Thread</span><span class="o">::~</span><span class="n">Thread</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">cout</span><span class="o">&lt;&lt;</span><span class="s">&#34;~Thread ...&#34;</span><span class="o">&lt;&lt;</span><span class="n">endl</span><span class="p">;</span>
<span class="p">}</span>
 
<span class="kt">void</span> <span class="n">Thread</span><span class="o">::</span><span class="n">Start</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">pthread_create</span><span class="p">(</span><span class="o">&amp;</span><span class="n">threadId_</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">ThreadRoutine</span><span class="p">,</span> <span class="k">this</span><span class="p">);</span>
<span class="p">}</span>
 
<span class="kt">void</span> <span class="n">Thread</span><span class="o">::</span><span class="n">Join</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">pthread_join</span><span class="p">(</span><span class="n">threadId_</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>
 
<span class="kt">void</span><span class="o">*</span> <span class="n">Thread</span><span class="o">::</span><span class="n">ThreadRoutine</span><span class="p">(</span><span class="kt">void</span><span class="o">*</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">Thread</span><span class="o">*</span> <span class="kr">thread</span> <span class="o">=</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="n">Thread</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">arg</span><span class="p">);</span>
    <span class="kr">thread</span><span class="o">-&gt;</span><span class="n">Run</span><span class="p">();</span>
    <span class="k">if</span> <span class="p">(</span><span class="kr">thread</span><span class="o">-&gt;</span><span class="n">autoDelete_</span><span class="p">)</span>
        <span class="k">delete</span> <span class="kr">thread</span><span class="p">;</span>
    <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>
 
<span class="kt">void</span> <span class="n">Thread</span><span class="o">::</span><span class="n">SetAutoDelete</span><span class="p">(</span><span class="kt">bool</span> <span class="n">autoDelete</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">autoDelete_</span> <span class="o">=</span> <span class="n">autoDelete</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div>
<ul>
<li>Thread test</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-c++" data-lang="c++"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c++" data-lang="c++"><span class="cp">#include</span> <span class="cpf">&#34;Thread.h&#34;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;unistd.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;iostream&gt;</span><span class="cp">
</span><span class="cp"></span><span class="k">using</span> <span class="k">namespace</span> <span class="n">std</span><span class="p">;</span>
 
<span class="k">class</span><span class="err"> </span><span class="nc">TestThread</span> <span class="o">:</span> <span class="k">public</span> <span class="n">Thread</span>
<span class="p">{</span>
<span class="k">public</span><span class="o">:</span>
    <span class="n">TestThread</span><span class="p">(</span><span class="kt">int</span> <span class="n">count</span><span class="p">)</span> <span class="o">:</span> <span class="n">count_</span><span class="p">(</span><span class="n">count</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">cout</span><span class="o">&lt;&lt;</span><span class="s">&#34;TestThread ...&#34;</span><span class="o">&lt;&lt;</span><span class="n">endl</span><span class="p">;</span>
    <span class="p">}</span>
 
    <span class="o">~</span><span class="n">TestThread</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="n">cout</span><span class="o">&lt;&lt;</span><span class="s">&#34;~TestThread ...&#34;</span><span class="o">&lt;&lt;</span><span class="n">endl</span><span class="p">;</span>
    <span class="p">}</span>
 
<span class="k">private</span><span class="o">:</span>
    <span class="kt">void</span> <span class="n">Run</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">while</span> <span class="p">(</span><span class="n">count_</span><span class="o">--</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">cout</span><span class="o">&lt;&lt;</span><span class="s">&#34;this is a test ...&#34;</span><span class="o">&lt;&lt;</span><span class="n">endl</span><span class="p">;</span>
            <span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
 
    <span class="kt">int</span> <span class="n">count_</span><span class="p">;</span>
<span class="p">};</span>
 
<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
    <span class="cm">/*
</span><span class="cm">    TestThread t(5);
</span><span class="cm">    t.Start();
</span><span class="cm"> 
</span><span class="cm">    t.Join();
</span><span class="cm">    */</span>
 
    <span class="n">TestThread</span><span class="o">*</span> <span class="n">t2</span> <span class="o">=</span> <span class="k">new</span> <span class="n">TestThread</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>
    <span class="n">t2</span><span class="o">-&gt;</span><span class="n">SetAutoDelete</span><span class="p">(</span><span class="nb">true</span><span class="p">);</span>
    <span class="n">t2</span><span class="o">-&gt;</span><span class="n">Start</span><span class="p">();</span>
    <span class="n">t2</span><span class="o">-&gt;</span><span class="n">Join</span><span class="p">();</span>
 
    <span class="k">for</span> <span class="p">(;</span> <span class="p">;</span> <span class="p">)</span>
        <span class="n">pause</span><span class="p">();</span>
 
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div>
<h3 id="基于对象编程">基于对象编程</h3>

<p>基于对象编程，提供出来的就不是<code>接口</code>了， 而是一个具体的类，虽然他和面向对象想一个都是起到回调的作用，但是他的回调不是通过继承来实现相应的虚函数,可以独立的函数，或者成员函数。看下面的例子就知道了。</p>

<p><em>source code</em></p>

<ul>
<li>Thread.h</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-c++" data-lang="c++"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c++" data-lang="c++"><span class="cp">#ifndef _THREAD_
</span><span class="cp">#define _THREAD_
</span><span class="cp">#include</span> <span class="cpf">&lt;pthread.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;boost/function.hpp&gt;</span><span class="cp">
</span><span class="cp"></span><span class="k">class</span><span class="err"> </span><span class="nc">Thread</span> <span class="p">{</span>
<span class="k">public</span> <span class="o">:</span>
    <span class="k">typedef</span> <span class="n">boost</span><span class="o">::</span><span class="n">function</span><span class="o">&lt;</span><span class="kt">void</span> <span class="p">()</span><span class="o">&gt;</span> <span class="n">ThreadFunc</span> <span class="p">;</span>
    <span class="k">explicit</span> <span class="nf">Thread</span><span class="p">(</span> <span class="k">const</span> <span class="n">ThreadFunc</span> <span class="o">&amp;</span><span class="n">func</span><span class="p">)</span> <span class="p">;</span>
    <span class="o">~</span><span class="n">Thread</span><span class="p">();</span>
    <span class="kt">void</span> <span class="nf">Start</span> <span class="p">()</span> <span class="p">;</span>
    <span class="kt">void</span> <span class="nf">Join</span><span class="p">();</span>
    <span class="kt">void</span> <span class="nf">SetAutoDelete</span><span class="p">(</span><span class="kt">bool</span> <span class="n">autoDelete</span><span class="p">);</span>
<span class="k">private</span> <span class="o">:</span>
    <span class="k">static</span> <span class="kt">void</span><span class="o">*</span> <span class="n">ThreadRoutine</span><span class="p">(</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span> <span class="p">;</span>
    <span class="kt">void</span> <span class="nf">Run</span><span class="p">();</span>
    <span class="n">ThreadFunc</span> <span class="n">func</span> <span class="p">;</span>
    <span class="n">pthread_t</span> <span class="n">threadId</span> <span class="p">;</span>
    <span class="kt">bool</span> <span class="n">autoDelete_</span><span class="p">;</span>
<span class="p">}</span> <span class="p">;</span>
<span class="cp">#endif </span><span class="c1">// _THREAD_H_
</span></code></pre></td></tr></table>
</div>
</div>
<ul>
<li>Thread.cpp</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-c++" data-lang="c++"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c++" data-lang="c++"><span class="cp">#include</span> <span class="cpf">&#34;Thread.h&#34;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;boost/bind.hpp&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;iostream&gt;</span><span class="cp">
</span><span class="cp"></span><span class="k">using</span> <span class="k">namespace</span> <span class="n">std</span> <span class="p">;</span>
<span class="n">Thread</span><span class="o">::</span><span class="n">Thread</span><span class="p">(</span> <span class="k">const</span> <span class="n">ThreadFunc</span> <span class="o">&amp;</span><span class="n">func_</span> <span class="p">)</span> <span class="o">:</span> <span class="n">func</span><span class="p">(</span><span class="n">func_</span><span class="p">),</span><span class="n">autoDelete_</span><span class="p">(</span><span class="nb">false</span><span class="p">){</span>
 
<span class="p">}</span>
<span class="n">Thread</span><span class="o">::~</span><span class="n">Thread</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">cout</span><span class="o">&lt;&lt;</span><span class="n">__FUNCTION__</span><span class="o">&lt;&lt;</span><span class="n">endl</span><span class="p">;</span>
<span class="p">}</span>
 
 
<span class="kt">void</span> <span class="n">Thread</span><span class="o">::</span><span class="n">Start</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">pthread_create</span><span class="p">(</span><span class="o">&amp;</span><span class="n">threadId</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">ThreadRoutine</span><span class="p">,</span> <span class="k">this</span><span class="p">);</span>
<span class="p">}</span>
 
<span class="kt">void</span> <span class="n">Thread</span><span class="o">::</span><span class="n">Join</span><span class="p">(){</span>
 
    <span class="n">pthread_join</span><span class="p">(</span><span class="n">threadId</span><span class="p">,</span><span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>
<span class="kt">void</span> <span class="o">*</span> <span class="n">Thread</span><span class="o">::</span><span class="n">ThreadRoutine</span><span class="p">(</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">){</span>
    <span class="n">Thread</span> <span class="o">*</span><span class="kr">thread</span> <span class="o">=</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="n">Thread</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span> <span class="p">;</span>
    <span class="kr">thread</span><span class="o">-&gt;</span><span class="n">Run</span><span class="p">();</span>
    <span class="k">if</span> <span class="p">(</span> <span class="kr">thread</span><span class="o">-&gt;</span><span class="n">autoDelete_</span><span class="p">)</span>
        <span class="k">delete</span><span class="p">(</span><span class="kr">thread</span><span class="p">);</span>
    <span class="n">cout</span><span class="o">&lt;&lt;</span><span class="s">&#34;After delete&#34;</span><span class="o">&lt;&lt;</span><span class="n">endl</span><span class="p">;</span>
 
 
 
<span class="p">}</span>
<span class="kt">void</span> <span class="n">Thread</span><span class="o">::</span><span class="n">Run</span><span class="p">(){</span>
    <span class="n">func</span><span class="p">();</span>
<span class="p">}</span>
<span class="kt">void</span> <span class="n">Thread</span><span class="o">::</span><span class="n">SetAutoDelete</span><span class="p">(</span><span class="kt">bool</span> <span class="n">autoDelete</span><span class="p">)</span>  <span class="p">{</span>
    <span class="k">this</span><span class="o">-&gt;</span><span class="n">autoDelete_</span> <span class="o">=</span> <span class="n">autoDelete</span><span class="p">;</span>
 
</code></pre></td></tr></table>
</div>
</div>
<ul>
<li>Thread_test.cpp</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-c++" data-lang="c++"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c++" data-lang="c++"><span class="cp">#include</span> <span class="cpf">&lt;unistd.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&#34;Thread.h&#34;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;iostream&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;boost/bind.hpp&gt;</span><span class="cp">
</span><span class="cp"></span><span class="k">using</span> <span class="k">namespace</span> <span class="n">std</span> <span class="p">;</span>
 
<span class="k">class</span><span class="err"> </span><span class="nc">NumberFunction</span><span class="p">{</span>
<span class="k">public</span> <span class="o">:</span>
    <span class="n">NumberFunction</span><span class="p">(</span> <span class="kt">int</span> <span class="n">count</span><span class="p">)</span><span class="o">:</span><span class="n">coun_t</span><span class="p">(</span><span class="n">count</span><span class="p">){}</span>
        <span class="kt">void</span> <span class="n">NFunction</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">while</span><span class="p">(</span><span class="n">coun_t</span><span class="o">--</span> <span class="o">&amp;&amp;</span> <span class="n">coun_t</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">){</span>
            <span class="n">cout</span><span class="o">&lt;&lt;</span><span class="n">__FUNCTION__</span><span class="o">&lt;&lt;</span><span class="n">endl</span><span class="p">;</span>
            <span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="k">private</span> <span class="o">:</span>
    <span class="kt">int</span> <span class="n">coun_t</span> <span class="p">;</span>
<span class="p">};</span>
 
<span class="kt">void</span> <span class="nf">threadFunc</span> <span class="p">(){</span>
 
    <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">9</span> <span class="p">;</span>
    <span class="k">while</span><span class="p">(</span><span class="n">i</span><span class="o">--</span><span class="p">){</span>
        <span class="n">cout</span><span class="o">&lt;&lt;</span><span class="s">&#34;threadFunc...!!&#34;</span><span class="o">&lt;&lt;</span><span class="n">endl</span> <span class="p">;</span>
        <span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
    <span class="p">}</span>
 
    <span class="n">cout</span><span class="o">&lt;&lt;</span><span class="n">endl</span> <span class="p">;</span>
<span class="p">}</span>
 
<span class="kt">void</span> <span class="nf">threadFunc2</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="p">){</span>
    <span class="k">while</span><span class="p">(</span><span class="n">i</span><span class="o">--&amp;&amp;</span><span class="n">i</span><span class="o">&gt;=</span><span class="mi">0</span><span class="p">){</span>
        <span class="n">cout</span><span class="o">&lt;&lt;</span><span class="s">&#34;Threadfunc2 ....&#34;</span><span class="o">&lt;&lt;</span><span class="n">endl</span><span class="p">;</span>
        <span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
    <span class="p">}</span>
 
<span class="p">}</span>
<span class="kt">int</span> <span class="nf">main</span> <span class="p">(){</span>
 
    <span class="n">Thread</span> <span class="o">*</span><span class="n">t</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Thread</span><span class="p">(</span><span class="n">threadFunc</span><span class="p">);</span>
    <span class="n">Thread</span> <span class="o">*</span><span class="n">t2</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Thread</span><span class="p">(</span><span class="n">boost</span><span class="o">::</span><span class="n">bind</span><span class="p">(</span> <span class="n">threadFunc2</span> <span class="p">,</span> <span class="mi">10</span><span class="p">))</span> <span class="p">;</span>
    <span class="n">NumberFunction</span> <span class="n">foo</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span> <span class="p">;</span>
    <span class="n">Thread</span> <span class="o">*</span><span class="n">t3</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Thread</span><span class="p">(</span> <span class="n">boost</span><span class="o">::</span><span class="n">bind</span><span class="p">(</span><span class="o">&amp;</span><span class="n">NumberFunction</span><span class="o">::</span><span class="n">NFunction</span><span class="p">,</span><span class="o">&amp;</span><span class="n">foo</span><span class="p">))</span> <span class="p">;</span>
    <span class="n">t</span><span class="o">-&gt;</span><span class="n">SetAutoDelete</span><span class="p">(</span><span class="nb">true</span><span class="p">);</span>
    <span class="n">t</span><span class="o">-&gt;</span><span class="n">Start</span><span class="p">();</span>
 
    <span class="n">t2</span><span class="o">-&gt;</span><span class="n">SetAutoDelete</span><span class="p">(</span><span class="nb">true</span><span class="p">)</span> <span class="p">;</span>
    <span class="n">t2</span><span class="o">-&gt;</span><span class="n">Start</span><span class="p">();</span>
 
    <span class="n">t3</span><span class="o">-&gt;</span><span class="n">SetAutoDelete</span><span class="p">(</span><span class="nb">true</span><span class="p">)</span> <span class="p">;</span>
    <span class="n">t3</span><span class="o">-&gt;</span><span class="n">Start</span><span class="p">();</span>
 
    <span class="n">t2</span><span class="o">-&gt;</span><span class="n">Join</span><span class="p">();</span>
    <span class="n">t</span><span class="o">-&gt;</span><span class="n">Join</span><span class="p">();</span>
    <span class="n">t3</span><span class="o">-&gt;</span><span class="n">Join</span><span class="p">();</span>
    <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">9</span> <span class="p">;</span>
    <span class="k">while</span> <span class="p">(</span><span class="n">i</span><span class="o">--</span><span class="p">){</span>
        <span class="n">cout</span><span class="o">&lt;&lt;</span><span class="n">__FUNCTION__</span><span class="o">&lt;&lt;</span><span class="n">endl</span><span class="p">;</span>
    <span class="p">}</span>
 
 
    <span class="k">return</span> <span class="mi">0</span> <span class="p">;</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div>
<p>我们看一下下面这张图</p>

<p><center><img src="http://laohanlinux.github.io/images/img/blog/muduo_base_library/muduo_base_library_1.png" alt="" /></center></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-c++" data-lang="c++"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c++" data-lang="c++"><span class="k">class</span><span class="err"> </span><span class="nc">EchoServer</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="o">:</span>
        <span class="n">EchoServer</span><span class="p">(){</span>
            <span class="n">server</span><span class="p">.</span><span class="n">SetConnectionCallback</span> <span class="p">(</span><span class="n">boost</span><span class="o">::</span><span class="n">bind</span><span class="p">(</span> <span class="n">onConnection</span><span class="p">())</span> <span class="p">;</span>
            <span class="n">server</span><span class="p">.</span><span class="n">SetConnectionCallback</span> <span class="p">(</span><span class="n">boost</span><span class="o">::</span><span class="n">bind</span><span class="p">(</span> <span class="n">onMessage</span><span class="p">()</span> <span class="p">)</span> <span class="p">;</span>
            <span class="n">server</span><span class="p">.</span><span class="n">SetConnectionCallback</span> <span class="p">(</span><span class="n">boost</span><span class="o">::</span><span class="n">bind</span><span class="p">(</span> <span class="n">onClose</span><span class="p">()</span> <span class="p">)</span> <span class="p">;</span>
            <span class="n">TcpServer</span> <span class="n">server</span> <span class="p">;</span>
        <span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div>
<p><em>面向对象风格</em>:</p>

<blockquote>
<p>用一个EchoServer 继承TcpServer(抽象类)，然后EchoServer实现三个接口onConnection、onMessage、onClose。</p>
</blockquote>

<p><em>基于对象风格</em>:</p>

<blockquote>
<p>用一个EchoServer包含一个TcpServer(具体类)对象，在构造函数中使用boost::bind来注册 三个成员函数 onConnection、onMessage、onClose。</p>
</blockquote>

<h3 id="poll">poll</h3>

<p><code>signal (SIGPIPE ,SIG_IGN)</code>: 　</p>

<p>Linux网络编程 第12讲 tcp 11中状态</p>

<ul>
<li><code>ＳＩＧＰＩＰＥ</code>产生的原因：<br /></li>
</ul>

<p>如果客户端关闭套接字<code>close</code> 而服务器调用一次<code>RST segment</code>(TCP传输层)如果服务器再次调用了<code>write</code> ，这个时候就会产生<code>SIGPIPE</code>信号,</p>

<ul>
<li><code>TIMEOUT</code>会对大并发服务器产生很大的影响</li>
</ul>

<p>由于服务器主动关闭连接，服务器就会进入<code>TIME_WAIT</code>,所以我们要使<code>client</code>先关闭，服务器被动关闭；</p>

<ul>
<li>踢掉不活跃的客户端</li>
</ul>

<p>如果客户端不活跃了，一些客户端不断开连接，这样子就会占用服务器的连接资源，服务器端也有要个机制来踢掉不活跃的连接，即使服务器又会进入time-wait状态。</p>

<ul>
<li>客户端关闭在<code>poll</code>中属于<code>pollin</code>事件，并且可读的数据为<code>0</code>； 对于监听套接字来说，有连接请求也属于<code>pollin</code>事件。</li>
</ul>

<p>所以我们使用了<code>nonblocking sokcet + I/O</code>复用</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-c++" data-lang="c++"><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c++" data-lang="c++"><span class="cp">#include</span> <span class="cpf">&lt;unistd.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;sys/types.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;fcntl.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;sys/socket.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;netinet/in.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;arpa/inet.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;signal.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;sys/wait.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;poll.h&gt;</span><span class="cp">
</span><span class="cp"></span> 
<span class="cp">#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;errno.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;string.h&gt;</span><span class="cp">
</span><span class="cp"></span> 
<span class="cp">#include</span> <span class="cpf">&lt;vector&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;iostream&gt;</span><span class="cp">
</span><span class="cp"></span> 
<span class="cp">#define ERR_EXIT(m) \
</span><span class="cp"></span>        <span class="k">do</span> \
        <span class="p">{</span> \
                <span class="n">perror</span><span class="p">(</span><span class="n">m</span><span class="p">);</span> \
                <span class="n">exit</span><span class="p">(</span><span class="n">EXIT_FAILURE</span><span class="p">);</span> \
        <span class="p">}</span> <span class="k">while</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
 
<span class="k">typedef</span> <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="k">struct</span> <span class="n">pollfd</span><span class="o">&gt;</span> <span class="n">PollFdList</span><span class="p">;</span>
 
<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
    <span class="c1">// 防止进程由于客户端的关闭产生SIG_PIPE信号而是服务器进程退出
</span><span class="c1"></span>    <span class="n">signal</span><span class="p">(</span><span class="n">SIGPIPE</span><span class="p">,</span> <span class="n">SIG_IGN</span><span class="p">);</span>
    <span class="c1">//SIGCHLD 子进程状态改变后会产生此信号，父进程需要调用一个wait函数以确定发生了什么。
</span><span class="c1"></span>    <span class="c1">//如果进程特定设置该信号的配置为SIG_IGN，则调用进程的子进程不产生僵死进程。
</span><span class="c1"></span>    <span class="c1">//其实要想防止进程僵死，我们应该在他的父进程里面调用wait，以获取子进程的状态就不会让子进程变成僵死进程了
</span><span class="c1"></span>    <span class="n">signal</span><span class="p">(</span><span class="n">SIGCHLD</span><span class="p">,</span> <span class="n">SIG_IGN</span><span class="p">);</span>
 
    <span class="c1">//int idlefd = open(&#34;/dev/null&#34;, O_RDONLY | O_CLOEXEC);
</span><span class="c1"></span>    <span class="kt">int</span> <span class="n">listenfd</span><span class="p">;</span>
 
    <span class="c1">//if ((listenfd = socket(PF_INET, SOCK_STREAM, IPPROTO_TCP)) &lt; 0)
</span><span class="c1"></span>    <span class="c1">//SOCK_NONBLOCK:非阻塞 ，2.6.2**才有
</span><span class="c1"></span>    <span class="c1">//SOCK_CLOEXEC :当进程调用vfork或者fork产生进程时，继承下来的描述是关闭的状态
</span><span class="c1"></span>    <span class="c1">//
</span><span class="c1"></span>    <span class="k">if</span> <span class="p">((</span><span class="n">listenfd</span> <span class="o">=</span> <span class="n">socket</span><span class="p">(</span><span class="n">PF_INET</span><span class="p">,</span> <span class="n">SOCK_STREAM</span> <span class="o">|</span> <span class="n">SOCK_NONBLOCK</span> <span class="o">|</span> <span class="n">SOCK_CLOEXEC</span><span class="p">,</span> <span class="n">IPPROTO_TCP</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">ERR_EXIT</span><span class="p">(</span><span class="s">&#34;socket&#34;</span><span class="p">);</span>
 
    <span class="k">struct</span> <span class="n">sockaddr_in</span> <span class="n">servaddr</span><span class="p">;</span>
    <span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">servaddr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">servaddr</span><span class="p">));</span>
    <span class="n">servaddr</span><span class="p">.</span><span class="n">sin_family</span> <span class="o">=</span> <span class="n">AF_INET</span><span class="p">;</span>
    <span class="n">servaddr</span><span class="p">.</span><span class="n">sin_port</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="mi">5188</span><span class="p">);</span>
    <span class="n">servaddr</span><span class="p">.</span><span class="n">sin_addr</span><span class="p">.</span><span class="n">s_addr</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">INADDR_ANY</span><span class="p">);</span>
 
    <span class="kt">int</span> <span class="n">on</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="c1">//SOL_SOCKET:在套接字级别上进行设置
</span><span class="c1"></span>    <span class="c1">// SO_REUSEADDR，打开或关闭地址复用功能。
</span><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">setsockopt</span><span class="p">(</span><span class="n">listenfd</span><span class="p">,</span> <span class="n">SOL_SOCKET</span><span class="p">,</span> <span class="n">SO_REUSEADDR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">on</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">on</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">ERR_EXIT</span><span class="p">(</span><span class="s">&#34;setsockopt&#34;</span><span class="p">);</span>
 
    <span class="k">if</span> <span class="p">(</span><span class="n">bind</span><span class="p">(</span><span class="n">listenfd</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr</span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">servaddr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">servaddr</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">ERR_EXIT</span><span class="p">(</span><span class="s">&#34;bind&#34;</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">listen</span><span class="p">(</span><span class="n">listenfd</span><span class="p">,</span> <span class="n">SOMAXCONN</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">ERR_EXIT</span><span class="p">(</span><span class="s">&#34;listen&#34;</span><span class="p">);</span>
 
    <span class="k">struct</span> <span class="n">pollfd</span> <span class="n">pfd</span><span class="p">;</span>
    <span class="n">pfd</span><span class="p">.</span><span class="n">fd</span> <span class="o">=</span> <span class="n">listenfd</span><span class="p">;</span>
    <span class="c1">//注册事件
</span><span class="c1"></span>    <span class="n">pfd</span><span class="p">.</span><span class="n">events</span> <span class="o">=</span> <span class="n">POLLIN</span><span class="p">;</span>
 
    <span class="n">PollFdList</span> <span class="n">pollfds</span><span class="p">;</span>
    <span class="n">pollfds</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">pfd</span><span class="p">);</span>
    <span class="c1">//a positive number is returned
</span><span class="c1"></span>    <span class="kt">int</span> <span class="n">nready</span><span class="p">;</span>
 
    <span class="k">struct</span> <span class="n">sockaddr_in</span> <span class="n">peeraddr</span><span class="p">;</span>
    <span class="n">socklen_t</span> <span class="n">peerlen</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">connfd</span><span class="p">;</span>
 
    <span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="c1">//可用POLLIN事件数
</span><span class="c1"></span>        <span class="c1">//  -1 ：无限等待，直到发送POLLIN事件
</span><span class="c1"></span>        <span class="n">nready</span> <span class="o">=</span> <span class="n">poll</span><span class="p">(</span><span class="o">&amp;*</span><span class="n">pollfds</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span> <span class="n">pollfds</span><span class="p">.</span><span class="n">size</span><span class="p">(),</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">nready</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">errno</span> <span class="o">==</span> <span class="n">EINTR</span><span class="p">)</span>
                <span class="k">continue</span><span class="p">;</span>
 
            <span class="n">ERR_EXIT</span><span class="p">(</span><span class="s">&#34;poll&#34;</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">nready</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>    <span class="c1">// nothing happended
</span><span class="c1"></span>            <span class="k">continue</span><span class="p">;</span>
 
        <span class="c1">//如果POLLIN事件里面包含监听socket，那么监听socket将会
</span><span class="c1"></span>        <span class="k">if</span> <span class="p">(</span><span class="n">pollfds</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">revents</span> <span class="o">&amp;</span> <span class="n">POLLIN</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">peerlen</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">peeraddr</span><span class="p">);</span>
            <span class="c1">//SOCK_NONBLOCK : 非阻塞模式
</span><span class="c1"></span>            <span class="n">connfd</span> <span class="o">=</span> <span class="n">accept4</span><span class="p">(</span><span class="n">listenfd</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr</span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">peeraddr</span><span class="p">,</span>
                        <span class="o">&amp;</span><span class="n">peerlen</span><span class="p">,</span> <span class="n">SOCK_NONBLOCK</span> <span class="o">|</span> <span class="n">SOCK_CLOEXEC</span><span class="p">);</span>
 
            <span class="k">if</span> <span class="p">(</span><span class="n">connfd</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">ERR_EXIT</span><span class="p">(</span><span class="s">&#34;accept4&#34;</span><span class="p">);</span>
 
<span class="cm">/*
</span><span class="cm">            if (connfd == -1)
</span><span class="cm">            {
</span><span class="cm">                if (errno == EMFILE)
</span><span class="cm">                {
</span><span class="cm">                    close(idlefd);
</span><span class="cm">                    idlefd = accept(listenfd, NULL, NULL);
</span><span class="cm">                    close(idlefd);
</span><span class="cm">                    idlefd = open(&#34;/dev/null&#34;, O_RDONLY | O_CLOEXEC);
</span><span class="cm">                    continue;
</span><span class="cm">                }
</span><span class="cm">                else
</span><span class="cm">                    ERR_EXIT(&#34;accept4&#34;);
</span><span class="cm">            }
</span><span class="cm">*/</span>
 
            <span class="n">pfd</span><span class="p">.</span><span class="n">fd</span> <span class="o">=</span> <span class="n">connfd</span><span class="p">;</span>
            <span class="n">pfd</span><span class="p">.</span><span class="n">events</span> <span class="o">=</span> <span class="n">POLLIN</span><span class="p">;</span>
            <span class="n">pfd</span><span class="p">.</span><span class="n">revents</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
            <span class="n">pollfds</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">pfd</span><span class="p">);</span>
            <span class="o">--</span><span class="n">nready</span><span class="p">;</span>
 
            <span class="c1">// 连接成功
</span><span class="c1"></span>            <span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="o">&lt;&lt;</span><span class="s">&#34;ip=&#34;</span><span class="o">&lt;&lt;</span><span class="n">inet_ntoa</span><span class="p">(</span><span class="n">peeraddr</span><span class="p">.</span><span class="n">sin_addr</span><span class="p">)</span><span class="o">&lt;&lt;</span>
                <span class="s">&#34; port=&#34;</span><span class="o">&lt;&lt;</span><span class="n">ntohs</span><span class="p">(</span><span class="n">peeraddr</span><span class="p">.</span><span class="n">sin_port</span><span class="p">)</span><span class="o">&lt;&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">nready</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
                <span class="k">continue</span><span class="p">;</span>
        <span class="p">}</span>
 
        <span class="c1">//std::cout&lt;&lt;pollfds.size()&lt;&lt;std::endl;
</span><span class="c1"></span>        <span class="c1">//std::cout&lt;&lt;nready&lt;&lt;std::endl;、
</span><span class="c1"></span>        <span class="c1">//过滤掉第一个socketfd，也就是监听sdocket
</span><span class="c1"></span>        <span class="k">for</span> <span class="p">(</span><span class="n">PollFdList</span><span class="o">::</span><span class="n">iterator</span> <span class="n">it</span><span class="o">=</span><span class="n">pollfds</span><span class="p">.</span><span class="n">begin</span><span class="p">()</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span>
            <span class="n">it</span> <span class="o">!=</span> <span class="n">pollfds</span><span class="p">.</span><span class="n">end</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="n">nready</span> <span class="o">&gt;</span><span class="mi">0</span><span class="p">;</span> <span class="o">++</span><span class="n">it</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="c1">//如果有POLLIN事件
</span><span class="c1"></span>                <span class="k">if</span> <span class="p">(</span><span class="n">it</span><span class="o">-&gt;</span><span class="n">revents</span> <span class="o">&amp;</span> <span class="n">POLLIN</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="o">--</span><span class="n">nready</span><span class="p">;</span>
                    <span class="n">connfd</span> <span class="o">=</span> <span class="n">it</span><span class="o">-&gt;</span><span class="n">fd</span><span class="p">;</span>
                    <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">1024</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>
                    <span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">read</span><span class="p">(</span><span class="n">connfd</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="mi">1024</span><span class="p">);</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                        <span class="n">ERR_EXIT</span><span class="p">(</span><span class="s">&#34;read&#34;</span><span class="p">);</span>
                    <span class="c1">//如果等于0 ，就是说客户端已关闭，既然是POLLIN事件，那么就表示有数据可读，但现在为0（），也就是所读到了文件的EOF
</span><span class="c1"></span>                    <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
                    <span class="p">{</span>
                        <span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="o">&lt;&lt;</span><span class="s">&#34;client close&#34;</span><span class="o">&lt;&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
                        <span class="n">it</span> <span class="o">=</span> <span class="n">pollfds</span><span class="p">.</span><span class="n">erase</span><span class="p">(</span><span class="n">it</span><span class="p">);</span>
                        <span class="o">--</span><span class="n">it</span><span class="p">;</span>
 
                        <span class="n">close</span><span class="p">(</span><span class="n">connfd</span><span class="p">);</span>
                        <span class="k">continue</span><span class="p">;</span>
                    <span class="p">}</span>
 
                    <span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="o">&lt;&lt;</span><span class="n">buf</span><span class="p">;</span>
                    <span class="n">write</span><span class="p">(</span><span class="n">connfd</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">buf</span><span class="p">));</span>
 
                <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
 
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div>
<h3 id="poll2">poll2</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></pre></td>
<td class="lntd">
<pre class="chroma">application buffer          kernel buffer

|------|                |--------|
| read | &lt;--------------| buffer |
|------|                |--------|


|------|                |--------|
|write | &lt;--------------| buffer |
|------|                |--------|</pre></td></tr></table>
</div>
</div>
<p>数据包　粘包　一个包　两次<code>read</code>
- Read
可能并没有把<code>confd</code>对应的缓冲区的数据读完，那么<code>connfg</code>仍然是活跃的，我们应该将读到的数据保存在<code>connfd</code>的应用层的缓冲区（每一次都进行追加）。如何解析协议，我们让应用层的解析协议自己来解析
- 忙等待
 假设客户端关注了<code>socket</code>的<code>POLLOUT</code>事件，而此时内核缓冲区有空闲，但是应用层却没数据可写，那么内核将会处于忙等待状态(<code>busy waitting loop</code>)，一直发送<code>POLLOUT</code>事件。</p>

<p>解决的方法是：我们要看应用层的缓冲区，如果应用层的缓冲区有数据发，那么我们应该关注<code>POLLOUT</code>事件，要不然就取消<code>POLLOUT</code>事件的关注。</p>

<p>对于客户端在读数据时，我们也应该采用相应的方法，如果应用层的空间空闲时，我们就关注<code>POLLIN</code>事件，要不然就取消<code>POLLIN</code>事件。</p>

<h3 id="epoll-1">epoll 1</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-c++" data-lang="c++"><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span><span class="lnt">177
</span><span class="lnt">178
</span><span class="lnt">179
</span><span class="lnt">180
</span><span class="lnt">181
</span><span class="lnt">182
</span><span class="lnt">183
</span><span class="lnt">184
</span><span class="lnt">185
</span><span class="lnt">186
</span><span class="lnt">187
</span><span class="lnt">188
</span><span class="lnt">189
</span><span class="lnt">190
</span><span class="lnt">191
</span><span class="lnt">192
</span><span class="lnt">193
</span><span class="lnt">194
</span><span class="lnt">195
</span><span class="lnt">196
</span><span class="lnt">197
</span><span class="lnt">198
</span><span class="lnt">199
</span><span class="lnt">200
</span><span class="lnt">201
</span><span class="lnt">202
</span><span class="lnt">203
</span><span class="lnt">204
</span><span class="lnt">205
</span><span class="lnt">206
</span><span class="lnt">207
</span><span class="lnt">208
</span><span class="lnt">209
</span><span class="lnt">210
</span><span class="lnt">211
</span><span class="lnt">212
</span><span class="lnt">213
</span><span class="lnt">214
</span><span class="lnt">215
</span><span class="lnt">216
</span><span class="lnt">217
</span><span class="lnt">218
</span><span class="lnt">219
</span><span class="lnt">220
</span><span class="lnt">221
</span><span class="lnt">222
</span><span class="lnt">223
</span><span class="lnt">224
</span><span class="lnt">225
</span><span class="lnt">226
</span><span class="lnt">227
</span><span class="lnt">228
</span><span class="lnt">229
</span><span class="lnt">230
</span><span class="lnt">231
</span><span class="lnt">232
</span><span class="lnt">233
</span><span class="lnt">234
</span><span class="lnt">235
</span><span class="lnt">236
</span><span class="lnt">237
</span><span class="lnt">238
</span><span class="lnt">239
</span><span class="lnt">240
</span><span class="lnt">241
</span><span class="lnt">242
</span><span class="lnt">243
</span><span class="lnt">244
</span><span class="lnt">245
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c++" data-lang="c++"><span class="cm">/*
</span><span class="cm"> poll 在已连接的套接字中遍历
</span><span class="cm"> epoll_wait 返回的都是活跃的套接字，所以减少了很多无效的套接字
</span><span class="cm"> 
</span><span class="cm"> Poll模型 ：
</span><span class="cm"> 每次调用 poll函数的时候。都需要把监听套接字与已连接套接字所感兴趣的事件数组 拷贝到内核。
</span><span class="cm"> 
</span><span class="cm"> 
</span><span class="cm"> LT模式 ：
</span><span class="cm"> Write  EPOLLOUT 事件
</span><span class="cm">    高电平 writebuf内核有空闲空间，我们就说他处于高电平状态，也就是一直处于活跃状态。此时可能会产生busy waitting loop
</span><span class="cm">    低电平 当writebuf内核没有空闲空间，我们就说他处于低电平状态，没有激活。
</span><span class="cm">Read EPOLLIN 事件
</span><span class="cm">    xxx
</span><span class="cm"> 
</span><span class="cm"> 
</span><span class="cm"> 
</span><span class="cm"> ET模型 边缘触发
</span><span class="cm"> 在该模式下，一开始我们就关注EPOLLIN事件和EPOLLOUT事件 ， 此时writbuf一直处于高电平，不会触发EPOLLOUT事件.
</span><span class="cm">        而EPOLLIN可能会产生，因为开始Readbuf是空的，如果在 epoll_wait前，readbuf有数据了，那么就有unreadablr---&gt;readable,
</span><span class="cm">        也就是产生了EPOLLLIN事件，这也是为什么监听socket 能够接收到外来请求的原因。
</span><span class="cm">        关注EPOLLIN 和 EPOLLOUT事件后，我们也没必要取消他们的关注，只有到断开他们的socketfd时 ， 我们才需要取消。
</span><span class="cm"> 
</span><span class="cm">需要注意的是，在读写时，如果是读，一定要读到EAGAIN，写也是要写到EAGAIN
</span><span class="cm"> socket从unreadable变为readable或从unwritable变为writable
</span><span class="cm"> 有些人说从readable变为unreadable或者writable变为unwritable时也会触发事件。
</span><span class="cm"> 我个人觉得第一种合理一点。
</span><span class="cm"> 
</span><span class="cm"> 
</span><span class="cm">*/</span>
 
<span class="cp">#include</span> <span class="cpf">&lt;unistd.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;sys/types.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;fcntl.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;sys/socket.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;netnet/in.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;arpa/inet.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;signal.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;sys/wait.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;sys/epoll.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;errno.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;string.h&gt;</span><span class="cp">
</span><span class="cp"></span> 
<span class="cp">#include</span> <span class="cpf">&lt;vector.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;algorithm&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;iostream&gt;</span><span class="cp">
</span><span class="cp"></span> 
<span class="k">typedef</span> <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="k">struct</span> <span class="n">epoll_event</span><span class="o">&gt;</span> <span class="n">EventList</span> <span class="p">;</span>
 
<span class="cp">#define ERR_EXIT(m) \
</span><span class="cp"></span>    <span class="k">do</span>\
    <span class="p">{</span>\
        <span class="n">perror</span><span class="p">(</span><span class="n">m</span><span class="p">);</span>\
        <span class="n">exit</span><span class="p">(</span><span class="n">EXIT_FAILURE</span><span class="p">);</span>\
    <span class="p">}</span><span class="k">while</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
 
<span class="kt">int</span> <span class="nf">main</span> <span class="p">(</span> <span class="kt">void</span> <span class="p">)</span> <span class="p">{</span>
    <span class="c1">//防止进程由于客户端的关闭而使服务器进程退出
</span><span class="c1"></span>    <span class="n">signal</span><span class="p">(</span><span class="n">SIGPIPE</span> <span class="p">,</span><span class="n">SIG_IGN</span><span class="p">)</span> <span class="p">;</span>  
    <span class="c1">//防止僵死进程的发生
</span><span class="c1"></span>    <span class="n">signal</span><span class="p">(</span><span class="n">SIGCHLD</span><span class="p">,</span><span class="n">SIG_IGN</span><span class="p">);</span>
 
 
    <span class="c1">//备胎描述符
</span><span class="c1"></span>    <span class="kt">int</span> <span class="n">idlefd</span> <span class="o">=</span> <span class="n">open</span><span class="p">(</span><span class="s">&#34;/dev/null&#34;</span><span class="p">,</span><span class="n">O_RDONLY</span> <span class="o">|</span> <span class="n">O_CLOEXEC</span><span class="p">)</span> <span class="p">;</span>
    <span class="c1">//监听描述符
</span><span class="c1"></span>    <span class="kt">int</span> <span class="n">listenfd</span> <span class="p">;</span>
 
    <span class="k">if</span><span class="p">((</span><span class="n">listenfd</span> <span class="o">=</span><span class="n">socket</span><span class="p">(</span><span class="n">PF_INET</span><span class="p">,</span><span class="n">SOCK_STRAM</span><span class="o">|</span><span class="n">SOCK_NONBLOCK</span><span class="o">|</span><span class="n">SOCK_CLOSEXEC</span><span class="p">,</span><span class="n">IPPROTO_TCP</span><span class="p">))</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">){</span>
 
        <span class="n">ERR_EXIT</span><span class="p">(</span><span class="s">&#34;socket&#34;</span><span class="p">);</span>
    <span class="p">}</span>
 
    <span class="k">struct</span> <span class="n">sockaddr_in</span> <span class="n">servaddr</span> <span class="p">;</span>
    <span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">servaddr</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="k">sizeof</span><span class="p">(</span><span class="n">servaddr</span><span class="p">))</span> <span class="p">;</span>
    <span class="n">servaddr</span><span class="p">.</span><span class="n">sin_family</span> <span class="o">=</span> <span class="n">AF_INET</span><span class="p">;</span>
    <span class="n">servaddr</span><span class="p">.</span><span class="n">sin_port</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="mi">5188</span><span class="p">);</span>
    <span class="n">servaddr</span><span class="p">.</span><span class="n">sin_addr</span><span class="p">.</span><span class="n">s_addr</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">INADDR_ANY</span><span class="p">)</span> <span class="p">;</span>
 
    <span class="kt">int</span> <span class="n">on</span> <span class="o">=</span><span class="mi">1</span> <span class="p">;</span> 
    <span class="c1">//socketfd 重用
</span><span class="c1"></span>    <span class="k">if</span><span class="p">(</span><span class="n">setsocketopt</span><span class="p">(</span><span class="n">listenfd</span><span class="p">,</span><span class="n">SOL_SOCKET</span><span class="p">,</span><span class="n">SO_REUSERADDR</span><span class="p">,</span><span class="o">&amp;</span><span class="n">on</span><span class="p">,</span><span class="k">sizeof</span><span class="p">(</span><span class="n">n</span><span class="p">))</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">)</span>
 
    <span class="p">{</span>
        <span class="n">ERR_EXIT</span><span class="p">(</span><span class="s">&#34;setsocketopt&#34;</span><span class="p">);</span>
    <span class="p">}</span>
 
    <span class="k">if</span><span class="p">(</span> <span class="n">bind</span><span class="p">(</span><span class="n">listenfd</span><span class="p">,(</span><span class="k">struct</span> <span class="n">sockaddr</span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">servaddr</span><span class="p">,</span><span class="k">sizeof</span><span class="p">(</span><span class="n">servaddr</span><span class="p">))</span> <span class="o">&lt;</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">ERR_EXIT</span><span class="p">(</span><span class="s">&#34;bind&#34;</span><span class="p">);</span>
 
    <span class="k">if</span><span class="p">(</span><span class="n">listen</span><span class="p">(</span><span class="n">listen</span><span class="p">,</span><span class="n">SOMAXCONN</span><span class="p">)</span> <span class="o">&lt;</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">ERR_EXIT</span><span class="p">(</span><span class="s">&#34;listen&#34;</span><span class="p">);</span>
 
    <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span> <span class="n">clients</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">epollfd</span><span class="p">;</span> 
    <span class="c1">// 函数返回一个epoll专用的描述符epfd，epfd引用了一个新的epoll机制例程（instance.）。
</span><span class="c1"></span>    <span class="n">epollfd</span> <span class="o">=</span> <span class="n">epoll_create1</span><span class="p">(</span><span class="n">EPOLL_CLOEXEC</span><span class="p">);</span>
 
    <span class="c1">//事件结构体
</span><span class="c1"></span>    <span class="k">struct</span> <span class="n">epoll_event</span> <span class="n">event</span> <span class="p">;</span>
    <span class="n">event</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">fd</span> <span class="o">=</span> <span class="n">listenfd</span> <span class="p">;</span> <span class="c1">//关注listenfd
</span><span class="c1"></span>    <span class="n">event</span><span class="p">.</span><span class="n">events</span> <span class="o">=</span> <span class="n">EPOLLIN</span> <span class="p">;</span> <span class="c1">// /* | EPOLLET*/; 默认是LT模型
</span><span class="c1"></span> 
    <span class="c1">// 把lisenfd 添加到epollfd 中进行管理
</span><span class="c1"></span>    <span class="c1">//如果是poll的话，就不用这样了，poll直接使用一个数组就行了
</span><span class="c1"></span>    <span class="cm">/*函数声明：int epoll_ctl(int epfd, int op, int fd, struct epoll_event *event) 
</span><span class="cm">该函数用于控制某个epoll文件描述符上的事件，可以注册事件，修改事件，删除事件。 
</span><span class="cm">参数： 
</span><span class="cm">epfd：由 epoll_create 生成的epoll专用的文件描述符； 
</span><span class="cm">op：要进行的操作例如注册事件，可能的取值EPOLL_CTL_ADD 注册、EPOLL_CTL_MOD 修 改、EPOLL_CTL_DEL 删除 
</span><span class="cm"> 
</span><span class="cm">fd：关联的文件描述符； 
</span><span class="cm">event：指向epoll_event的指针； 
</span><span class="cm">如果调用成功返回0,不成功返回-1 
</span><span class="cm"> 
</span><span class="cm">71 - 78 就交给epollfd 内核帮我们做了，并且只有epoll_ctl才会拷贝到内核，一次拷贝就行了，以后就不用拷贝了，
</span><span class="cm">如果我们使用poll 那么每次循环都要拷贝到内核里面去，大大降低了效率
</span><span class="cm">        */</span>
    <span class="n">epoll_ctl</span><span class="p">(</span><span class="n">epollfd</span> <span class="p">,</span> <span class="n">EPOLL_CTL_ADD</span><span class="p">,</span><span class="n">listenfd</span><span class="p">,</span><span class="o">&amp;</span><span class="n">event</span><span class="p">);</span>
 
    <span class="c1">//事件列表，初始为16 个
</span><span class="c1"></span>    <span class="n">EventList</span> <span class="n">events</span><span class="p">(</span><span class="mi">16</span><span class="p">)</span> <span class="p">;</span>
    <span class="k">struct</span> <span class="n">sockaddr_in</span> <span class="n">peeraddr</span> <span class="p">;</span>
    <span class="n">socklen_t</span> <span class="n">peerlen</span> <span class="p">;</span>
    <span class="kt">int</span> <span class="n">connfd</span> <span class="p">;</span>
 
    <span class="kt">int</span> <span class="n">nready</span> <span class="p">;</span> 
    <span class="k">while</span><span class="p">(</span><span class="mi">1</span><span class="p">){</span>
 
<span class="cm">/*函数声明:int epoll_wait(int epfd,struct epoll_event * events,int maxevents,int timeout)
</span><span class="cm">该函数用于轮询I/O事件的发生；
</span><span class="cm">参数：
</span><span class="cm">epfd:由epoll_create 生成的epoll专用的文件描述符；
</span><span class="cm">epoll_event:用于回传代处理事件的数组，要处理的事件都会存储在events里面了
</span><span class="cm">maxevents:每次能处理的事件数；
</span><span class="cm">timeout:等待I/O事件发生的超时值(单位我也不太清楚)；-1相当于阻塞，0相当于非阻塞。一般用-1即可
</span><span class="cm">返回发生事件数。
</span><span class="cm">         -1 表示等待到至少一个事件发生*/</span>
        <span class="n">nready</span> <span class="o">=</span> <span class="n">epoll_wait</span><span class="p">(</span><span class="n">epollfd</span><span class="p">,</span><span class="o">&amp;*</span><span class="n">events</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span><span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="p">(</span><span class="n">events</span><span class="p">.</span><span class="n">size</span><span class="p">()),</span> <span class="o">-</span><span class="mi">1</span> <span class="p">);</span> 
        <span class="k">if</span><span class="p">(</span> <span class="n">nready</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">){</span>
 
            <span class="k">if</span><span class="p">(</span><span class="n">errno</span> <span class="o">==</span> <span class="n">EINTR</span><span class="p">)</span>
                <span class="k">continue</span> <span class="p">;</span>
            <span class="n">ERR_EXIT</span><span class="p">(</span><span class="s">&#34;epoll_wait&#34;</span><span class="p">)</span> <span class="p">;</span>
        <span class="p">}</span>
 
        <span class="k">if</span><span class="p">(</span><span class="n">nready</span> <span class="o">==</span><span class="mi">0</span> <span class="p">)</span> <span class="c1">//nothing to happened 
</span><span class="c1"></span>            <span class="k">continue</span> <span class="p">;</span>
        <span class="c1">// 
</span><span class="c1"></span>        <span class="k">if</span><span class="p">((</span><span class="n">size_t</span><span class="p">)</span><span class="n">nready</span> <span class="o">==</span> <span class="n">events</span><span class="p">.</span><span class="n">size</span><span class="p">())</span>
            <span class="n">events</span><span class="p">.</span><span class="n">resize</span><span class="p">(</span><span class="n">events</span><span class="p">.</span><span class="n">size</span><span class="p">()</span><span class="o">*</span><span class="mi">2</span><span class="p">)</span> <span class="p">;</span>
 
        <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nready</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="c1">//如果是监听socket，则accetp
</span><span class="c1"></span>            <span class="k">if</span> <span class="p">(</span><span class="n">events</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">data</span><span class="p">.</span><span class="n">fd</span> <span class="o">==</span> <span class="n">listenfd</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">peerlen</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span> <span class="n">peeraddr</span> <span class="p">)</span> <span class="p">;</span>
                <span class="c1">// 这里的处理还不够好，因为accept4每一次只能到tcp就绪队列里面拿出一个就绪socketfd ， 有可能这个队列不止一个，
</span><span class="c1"></span>                <span class="c1">//在并发的时候这是必然的， 所以最后是while掉accept4，把里面的就绪socketfd全部拿出来，而不时只拿一个socketfd。
</span><span class="c1"></span>                <span class="c1">//下面的代码可根据需求进行改进
</span><span class="c1"></span>                <span class="n">connfd</span> <span class="o">=::</span><span class="n">accept4</span><span class="p">(</span><span class="n">listenfd</span><span class="p">,(</span><span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">peeraddr</span><span class="p">,</span><span class="o">&amp;</span><span class="n">peerlen</span><span class="p">,</span><span class="n">SOCK_NONBLOCK</span><span class="o">|</span><span class="n">SOCK_CLOSEXEC</span><span class="p">)</span> <span class="p">;</span>
 
                <span class="k">if</span><span class="p">(</span> <span class="n">connfd</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="p">)</span>
                <span class="p">{</span>
 
                    <span class="k">if</span><span class="p">(</span><span class="n">errno</span> <span class="o">==</span> <span class="n">EMFILE</span><span class="p">){</span>
                        <span class="n">close</span><span class="p">(</span><span class="n">idlefd</span><span class="p">)</span> <span class="p">;</span>
                        <span class="n">idlefd</span> <span class="o">=</span> <span class="n">accept</span><span class="p">(</span><span class="n">listenfd</span><span class="p">,</span><span class="nb">NULL</span><span class="p">,</span><span class="nb">NULL</span><span class="p">)</span> <span class="p">;</span>
                        <span class="n">close</span><span class="p">(</span><span class="n">idlefd</span><span class="p">)</span> <span class="p">;</span>
                        <span class="n">idlefd</span> <span class="o">=</span> <span class="n">open</span><span class="p">(</span><span class="s">&#34;/dev/null&#34;</span><span class="p">,</span><span class="n">O_RDONLY</span><span class="o">|</span><span class="n">O_CLOEXEC</span><span class="p">)</span> <span class="p">;</span>
                    <span class="p">}</span>
 
                <span class="p">}</span>
                <span class="k">else</span>
                    <span class="n">ERR_EXIT</span><span class="p">(</span><span class="s">&#34;accept4&#34;</span><span class="p">)</span> <span class="p">;</span>
                <span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="o">&lt;&lt;</span><span class="s">&#34;ip=&#34;</span><span class="o">&lt;&lt;</span><span class="n">inet_ntoa</span><span class="p">(</span><span class="n">peeraddr</span><span class="p">.</span><span class="n">sin_addr</span><span class="p">)</span><span class="o">&lt;&lt;</span><span class="s">&#34; port=&#34;</span><span class="o">&lt;&lt;</span><span class="n">ntohs</span><span class="p">(</span><span class="n">peeraddr</span><span class="p">.</span><span class="n">sin_port</span><span class="p">)</span><span class="o">&lt;&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
                <span class="n">clients</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">connfd</span><span class="p">)</span> <span class="p">;</span>
 
                <span class="n">event</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">fd</span> <span class="o">=</span><span class="n">connfd</span> <span class="p">;</span>
                <span class="n">event</span><span class="p">.</span><span class="n">events</span> <span class="o">=</span> <span class="n">EPOLLIN</span><span class="cm">/*| EPOLLET*/</span> <span class="p">;</span>
                <span class="n">epoll_ctl</span><span class="p">(</span><span class="n">epollfd</span><span class="p">,</span><span class="n">EPOLL_CTL_ADD</span> <span class="p">,</span><span class="n">connfd</span> <span class="p">,</span><span class="o">&amp;</span><span class="n">event</span><span class="p">)</span> <span class="p">;</span>
            <span class="p">}</span><span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">events</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">events</span> <span class="o">&amp;</span> <span class="n">EPOLLIN</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="c1">//下面的这些都要改进
</span><span class="c1"></span>                <span class="n">connfd</span> <span class="o">=</span> <span class="n">events</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">data</span><span class="p">.</span><span class="n">fd</span><span class="p">;</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">connfd</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
                    <span class="k">continue</span><span class="p">;</span>
 
                <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">1024</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>
                <span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">read</span><span class="p">(</span><span class="n">connfd</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="mi">1024</span><span class="p">);</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                    <span class="n">ERR_EXIT</span><span class="p">(</span><span class="s">&#34;read&#34;</span><span class="p">);</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="o">&lt;&lt;</span><span class="s">&#34;client close&#34;</span><span class="o">&lt;&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
                    <span class="n">close</span><span class="p">(</span><span class="n">connfd</span><span class="p">);</span>
                    <span class="n">event</span> <span class="o">=</span> <span class="n">events</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
                    <span class="n">epoll_ctl</span><span class="p">(</span><span class="n">epollfd</span><span class="p">,</span> <span class="n">EPOLL_CTL_DEL</span><span class="p">,</span> <span class="n">connfd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">event</span><span class="p">);</span>
                    <span class="n">clients</span><span class="p">.</span><span class="n">erase</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">remove</span><span class="p">(</span><span class="n">clients</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span> <span class="n">clients</span><span class="p">.</span><span class="n">end</span><span class="p">(),</span> <span class="n">connfd</span><span class="p">),</span> <span class="n">clients</span><span class="p">.</span><span class="n">end</span><span class="p">());</span>
                    <span class="k">continue</span><span class="p">;</span>
                <span class="p">}</span>
 
                <span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="o">&lt;&lt;</span><span class="n">buf</span><span class="p">;</span>
                <span class="n">write</span><span class="p">(</span><span class="n">connfd</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">buf</span><span class="p">));</span>
            <span class="p">}</span>
 
 
 
        <span class="p">}</span>
 
    <span class="p">}</span>
 
 
<span class="p">}</span>
 
<span class="cm">/*
</span><span class="cm">正确的读法
</span><span class="cm">n = 0;
</span><span class="cm">while ((nread = read(fd, buf + n, BUFSIZ-1)) &gt; 0) {
</span><span class="cm">    n += nread;
</span><span class="cm">}
</span><span class="cm">if (nread == -1 &amp;&amp; errno != EAGAIN) {
</span><span class="cm">    perror(&#34;read error&#34;);
</span><span class="cm">}
</span><span class="cm">*/</span>
 
 
<span class="cm">/*
</span><span class="cm">正确的写法
</span><span class="cm">int nwrite, data_size = strlen(buf);
</span><span class="cm">n = data_size;
</span><span class="cm">while (n &gt; 0) {
</span><span class="cm">    nwrite = write(fd, buf + data_size - n, n);
</span><span class="cm">    if (nwrite &lt; n) {
</span><span class="cm">        if (nwrite == -1 &amp;&amp; errno != EAGAIN) {
</span><span class="cm">            perror(&#34;write error&#34;);
</span><span class="cm">        }
</span><span class="cm">        break;
</span><span class="cm">    }
</span><span class="cm">    n -= nwrite;
</span><span class="cm">}
</span><span class="cm">*/</span>
</code></pre></td></tr></table>
</div>
</div>
<h3 id="epoll-summary">epoll summary</h3>

<p>下面的总结参照于c++教育网</p>

<ul>
<li>EPOLLIN事件
内核中的<code>socket</code>接收缓冲区为空-低电平</li>
</ul>

<p>内核中的<code>socket</code>接收缓冲区不为空-高电平</p>

<ul>
<li><code>EPOLLOUT</code>事件
内核中的<code>socket</code>发送缓冲区不满-高电平</li>
</ul>

<p>内核中的<code>socket</code>发送缓冲区满-低电平</p>

<ul>
<li>LT电平触发
高电平触发</li>
<li>ET 边沿触发
低电平&ndash;》高电平 触发</li>
</ul>

<p>高电平&ndash;》低电平 触发  （注，本人不赞同这种观点）</p>

<ul>
<li>EPOLL 在有些情况下是不建议使用的</li>
</ul>

<p>如：已连接套接字不多，并且这些套接字非常活跃</p>

<p>因为<code>epoll</code>内部的实现比较复杂（使用<code>callback</code>原理），编写时也需更加复杂的代码逻辑</p>

<h3 id="epoll在lt和et模式下的读写方式">Epoll在LT和ET模式下的读写方式</h3>

<p>在一个非阻塞的<code>socket</code>上调用<code>read/write</code>函数, 返回<code>EAGAIN</code>或者<code>EWOULDBLOCK</code>(注: <code>EAGAIN</code>就是E<code>WOULDBLOCK</code>)</p>

<p>从字面上看, 意思是:
- EAGAIN: 再试一次
- EWOULDBLOCK: 如果这是一个阻塞socket, 操作将被block
- perror输出:  Resource temporarily unavailable</p>

<p>总结:</p>

<p>这个错误表示资源暂时不够, 可能<code>read</code>时, 读缓冲区没有数据, 或者, <code>write</code>时,写缓冲区满了.  遇到这种情况, 如果是阻塞<code>socket</code>, <code>read/write</code>就要阻塞掉.而如果是非阻塞<code>socket</code>, <code>read/write</code>立即返回<code>-1</code>, 同时<code>errno</code>设置为<code>EAGAIN</code>.所以, 对于阻塞socket, read/write返回-1代表网络出错了.</p>

<p>但对于非阻塞<code>socket</code>,<code>read/write</code>返回<code>-1</code>不一定网络真的出错了.可能是<code>Resource temporarily unavailable</code>. 这时你应该再试, 直到<code>Resource available</code>.</p>

<p>综上, 对于<code>non-blocking</code>的<code>socket</code>,  正确的读写操作为:
- 读: 忽略掉<code>errno = EAGAIN</code>的错误, 下次继续读　
- 写: 忽略掉<code>errno = EAGAIN</code>的错误, 下次继续写　</p>

<p>对于<code>select</code>和<code>epoll</code>的<code>LT</code>模式, 这种读写方式是没有问题的. 但对于<code>epoll</code>的<code>ET</code>模式, 这种方式还有漏洞.</p>

<p><code>epoll</code>的两种模式<code>LT</code>和<code>ET</code></p>

<p>二者的差异在于<code>level-trigger</code>模式下只要某个<code>socket</code>处于<code>readable/writable</code>状态，无论什么时候进行<code>epoll_wait</code>都会返回该<code>socket</code>；而<code>edge-trigger</code>模式下只有某个<code>socket</code>从<code>unreadable</code>变为<code>readable</code>或从<code>unwritable</code>变为<code>writable</code>时<code>epoll_wait</code>才会返回该<code>socket</code>。如下两个示意图:</p>

<p>从<code>socket</code>读数据:</p>

<p><center><img src="http://laohanlinux.github.io/images/img/blog/muduo_base_library/muduo_base_library_2.png" alt="" /></center></p>

<p>往<code>socket</code>写数据</p>

<p><center><img src="http://laohanlinux.github.io/images/img/blog/muduo_base_library/muduo_base_library_3.png" alt="" /></center></p>

<p>所以, 在<code>epoll</code>的<code>ET</code>模式下, 正确的读写方式为:
- 读: 只要可读, 就一直读, 直到返回<code>0</code>, 或者<code>errno = EAGAIN</code>
- 写: 只要可写, 就一直写, 直到数据发送完, 或者<code>errno = EAGAIN</code></p>

<p>正确的读:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-c++" data-lang="c++"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c++" data-lang="c++"><span class="n">n</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>  
<span class="k">while</span> <span class="p">((</span><span class="n">nread</span> <span class="o">=</span> <span class="n">read</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">buf</span> <span class="o">+</span> <span class="n">n</span><span class="p">,</span> <span class="n">BUFSIZ</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>  
    <span class="n">n</span> <span class="o">+=</span> <span class="n">nread</span><span class="p">;</span>  
<span class="p">}</span>  
<span class="k">if</span> <span class="p">(</span><span class="n">nread</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">errno</span> <span class="o">!=</span> <span class="n">EAGAIN</span><span class="p">)</span> <span class="p">{</span>  
    <span class="n">perror</span><span class="p">(</span><span class="s">&#34;read error&#34;</span><span class="p">);</span>  
<span class="p">}</span>  
</code></pre></td></tr></table>
</div>
</div>
<p>正确的写:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-c++" data-lang="c++"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c++" data-lang="c++"><span class="kt">int</span> <span class="n">nwrite</span><span class="p">,</span> <span class="n">data_size</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>  
<span class="n">n</span> <span class="o">=</span> <span class="n">data_size</span><span class="p">;</span>  
<span class="k">while</span> <span class="p">(</span><span class="n">n</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>  
    <span class="n">nwrite</span> <span class="o">=</span> <span class="n">write</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">buf</span> <span class="o">+</span> <span class="n">data_size</span> <span class="o">-</span> <span class="n">n</span><span class="p">,</span> <span class="n">n</span><span class="p">);</span>  
    <span class="k">if</span> <span class="p">(</span><span class="n">nwrite</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">)</span> <span class="p">{</span>  
        <span class="k">if</span> <span class="p">(</span><span class="n">nwrite</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">errno</span> <span class="o">!=</span> <span class="n">EAGAIN</span><span class="p">)</span> <span class="p">{</span>  
            <span class="n">perror</span><span class="p">(</span><span class="s">&#34;write error&#34;</span><span class="p">);</span>  
        <span class="p">}</span>  
        <span class="k">break</span><span class="p">;</span>  
    <span class="p">}</span>  
    <span class="n">n</span> <span class="o">-=</span> <span class="n">nwrite</span><span class="p">;</span>  
<span class="p">}</span>  
</code></pre></td></tr></table>
</div>
</div>
<p>正确的<code>accept</code>，<code>accept</code>要考虑<code>2</code>个问题</p>

<ul>
<li>阻塞模式 accept 存在的问题
考虑这种情况：<code>TCP</code>连接被客户端夭折，即在服务器调用<code>accept</code>之前，客户端主动发送<code>RST</code>终止连接，导致刚刚建立的连接从就绪队列中移出，如果套接口被设置成阻塞模式，服务器就会一直阻塞,在<code>accept</code> 调用上，直到其他某个客户建立一个新的连接为止。但是在此期间，服务器单纯地阻塞在<code>accept</code> 调用上，就绪队列中的其他描述符都得不到处理.</li>
</ul>

<p>解决办法是把监听套接口设置为非阻塞，当客户在服务器调用<code>accept</code>之前中止某个连接时,<code>accept</code>调用可以立即返回<code>-1</code>，这时源自<code>Berkeley</code>的实现会在内核中处理该事件，并不会将该事件通知给<code>epool</code>，而其他实现把<code>errno</code>设置为<code>ECONNABORTED</code>或者<code>EPROTO</code> 错误，我们应该忽略这两个错误。</p>

<ul>
<li><code>ET</code>模式下<code>accept</code>存在的问题
考虑这种情况：多个连接同时到达，服务器的<code>TCP</code>就绪队列瞬间积累多个就绪连接，由于是边缘触发模式，<code>epoll</code>只会通知一次，<code>accept</code>只处理一个连接，导致<code>TCP</code>就绪队列中剩下的连接都得不到处理。</li>
</ul>

<p>解决办法是用<code>while</code>循环抱住<code>accept</code>调用，处理完<code>TCP</code>就绪队列中的所有连接后再退出循环。如何知道是否处理完就绪队列中的所有连接呢？<code>accept</code>  返回<code>-1</code>并且<code>errno</code>设置为<code>EAGAIN</code>就表示所有连接都处理完。</p>

<p>综合以上两种情况，服务器应该使用非阻塞地<code>accept</code>，<code>accept</code>在<code>ET</code>模式下 的正确使用方式为：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-c++" data-lang="c++"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c++" data-lang="c++"><span class="k">while</span> <span class="p">((</span><span class="n">conn_sock</span> <span class="o">=</span> <span class="n">accept</span><span class="p">(</span><span class="n">listenfd</span><span class="p">,(</span><span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">remote</span><span class="p">,</span>   
                <span class="p">(</span><span class="n">size_t</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">addrlen</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>  
    <span class="n">handle_client</span><span class="p">(</span><span class="n">conn_sock</span><span class="p">);</span>  
<span class="p">}</span>  
<span class="k">if</span> <span class="p">(</span><span class="n">conn_sock</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>  
    <span class="k">if</span> <span class="p">(</span><span class="n">errno</span> <span class="o">!=</span> <span class="n">EAGAIN</span> <span class="o">&amp;&amp;</span> <span class="n">errno</span> <span class="o">!=</span> <span class="n">ECONNABORTED</span>   
            <span class="o">&amp;&amp;</span> <span class="n">errno</span> <span class="o">!=</span> <span class="n">EPROTO</span> <span class="o">&amp;&amp;</span> <span class="n">errno</span> <span class="o">!=</span> <span class="n">EINTR</span><span class="p">)</span>   
        <span class="n">perror</span><span class="p">(</span><span class="s">&#34;accept&#34;</span><span class="p">);</span>  
<span class="p">}</span>  
 
</code></pre></td></tr></table>
</div>
</div>
<p>一道腾讯后台开发的面试题</p>

<p>使用<code>Linux epoll</code>模型，水平触发模式；当<code>socket</code>可写时，会不停的触发<code>socket</code>可写的事件，如何处理？</p>

<p>第一种最普遍的方式：</p>

<p>需要向<code>socket</code>写数据的时候才把<code>socket</code>加入<code>epoll</code>，等待可写事件。接受到可写事件后，调用<code>write</code>或者<code>send</code>发送数据。当所有数据都写完后，把<code>socket</code>移出<code>epoll</code>。
这种方式的缺点是，即使发送很少的数据，也要把<code>socket</code>加入<code>epoll</code>,写完后在移出<code>epoll</code>，有一定操作代价。</p>

<p>一种改进的方式：
开始不把<code>socket</code>加入<code>epoll</code>，需要向<code>socket</code>写数据的时候，直接调用<code>write</code>或者<code>send</code>发送数据。
如果返回<code>EAGAIN</code>，把<code>socket</code>加入<code>epoll</code>，在<code>epoll</code>的驱动下写数据，全部数据发送完毕后，再移出<code>epoll</code>。</p>

<p>这种方式的优点是：数据不多的时候可以避免<code>epoll</code>的事件处理，提高效率。
最后贴一个使用<code>epoll</code>, <code>ET</code>模式的简单<code>HTTP</code>服务器代码:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-c++" data-lang="c++"><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c++" data-lang="c++"><span class="cp">#include</span> <span class="cpf">&lt;sys/socket.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;sys/wait.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;netinet/in.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;netinet/tcp.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;sys/epoll.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;sys/sendfile.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;sys/stat.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;unistd.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;string.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;strings.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;fcntl.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;errno.h&gt; </span><span class="cp">
</span><span class="cp"></span> 
<span class="cp">#define MAX_EVENTS 10
</span><span class="cp">#define PORT 8080
</span><span class="cp"></span> 
<span class="c1">//设置socket连接为非阻塞模式
</span><span class="c1"></span><span class="kt">void</span> <span class="nf">setnonblocking</span><span class="p">(</span><span class="kt">int</span> <span class="n">sockfd</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="n">opts</span><span class="p">;</span>
 
    <span class="n">opts</span> <span class="o">=</span> <span class="n">fcntl</span><span class="p">(</span><span class="n">sockfd</span><span class="p">,</span> <span class="n">F_GETFL</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span><span class="n">opts</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">perror</span><span class="p">(</span><span class="s">&#34;fcntl(F_GETFL)</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
        <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">opts</span> <span class="o">=</span> <span class="p">(</span><span class="n">opts</span> <span class="o">|</span> <span class="n">O_NONBLOCK</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span><span class="n">fcntl</span><span class="p">(</span><span class="n">sockfd</span><span class="p">,</span> <span class="n">F_SETFL</span><span class="p">,</span> <span class="n">opts</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">perror</span><span class="p">(</span><span class="s">&#34;fcntl(F_SETFL)</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
        <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
 
<span class="kt">int</span> <span class="nf">main</span><span class="p">(){</span>
    <span class="k">struct</span> <span class="n">epoll_event</span> <span class="n">ev</span><span class="p">,</span> <span class="n">events</span><span class="p">[</span><span class="n">MAX_EVENTS</span><span class="p">];</span>
    <span class="kt">int</span> <span class="n">addrlen</span><span class="p">,</span> <span class="n">listenfd</span><span class="p">,</span> <span class="n">conn_sock</span><span class="p">,</span> <span class="n">nfds</span><span class="p">,</span> <span class="n">epfd</span><span class="p">,</span> <span class="n">fd</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">nread</span><span class="p">,</span> <span class="n">n</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">sockaddr_in</span> <span class="n">local</span><span class="p">,</span> <span class="n">remote</span><span class="p">;</span>
    <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="n">BUFSIZ</span><span class="p">];</span>
 
    <span class="c1">//创建listen socket
</span><span class="c1"></span>    <span class="k">if</span><span class="p">(</span> <span class="p">(</span><span class="n">listenfd</span> <span class="o">=</span> <span class="n">socket</span><span class="p">(</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">SOCK_STREAM</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">perror</span><span class="p">(</span><span class="s">&#34;sockfd</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
        <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">setnonblocking</span><span class="p">(</span><span class="n">listenfd</span><span class="p">);</span>
    <span class="n">bzero</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">local</span><span class="p">));</span>
    <span class="n">local</span><span class="p">.</span><span class="n">sin_family</span> <span class="o">=</span> <span class="n">AF_INET</span><span class="p">;</span>
    <span class="n">local</span><span class="p">.</span><span class="n">sin_addr</span><span class="p">.</span><span class="n">s_addr</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">INADDR_ANY</span><span class="p">);;</span>
    <span class="n">local</span><span class="p">.</span><span class="n">sin_port</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">PORT</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span> <span class="n">bind</span><span class="p">(</span><span class="n">listenfd</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">local</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">local</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">perror</span><span class="p">(</span><span class="s">&#34;bind</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
        <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">listen</span><span class="p">(</span><span class="n">listenfd</span><span class="p">,</span> <span class="mi">20</span><span class="p">);</span>
 
    <span class="n">epfd</span> <span class="o">=</span> <span class="n">epoll_create</span><span class="p">(</span><span class="n">MAX_EVENTS</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">epfd</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">perror</span><span class="p">(</span><span class="s">&#34;epoll_create&#34;</span><span class="p">);</span>
        <span class="n">exit</span><span class="p">(</span><span class="n">EXIT_FAILURE</span><span class="p">);</span>
    <span class="p">}</span>
 
    <span class="n">ev</span><span class="p">.</span><span class="n">events</span> <span class="o">=</span> <span class="n">EPOLLIN</span><span class="p">;</span>
    <span class="n">ev</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">fd</span> <span class="o">=</span> <span class="n">listenfd</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">epoll_ctl</span><span class="p">(</span><span class="n">epfd</span><span class="p">,</span> <span class="n">EPOLL_CTL_ADD</span><span class="p">,</span> <span class="n">listenfd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ev</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">perror</span><span class="p">(</span><span class="s">&#34;epoll_ctl: listen_sock&#34;</span><span class="p">);</span>
        <span class="n">exit</span><span class="p">(</span><span class="n">EXIT_FAILURE</span><span class="p">);</span>
    <span class="p">}</span>
 
    <span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
        <span class="n">nfds</span> <span class="o">=</span> <span class="n">epoll_wait</span><span class="p">(</span><span class="n">epfd</span><span class="p">,</span> <span class="n">events</span><span class="p">,</span> <span class="n">MAX_EVENTS</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">nfds</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">perror</span><span class="p">(</span><span class="s">&#34;epoll_pwait&#34;</span><span class="p">);</span>
            <span class="n">exit</span><span class="p">(</span><span class="n">EXIT_FAILURE</span><span class="p">);</span>
        <span class="p">}</span>
 
        <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nfds</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">fd</span> <span class="o">=</span> <span class="n">events</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">data</span><span class="p">.</span><span class="n">fd</span><span class="p">;</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">fd</span> <span class="o">==</span> <span class="n">listenfd</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">while</span> <span class="p">((</span><span class="n">conn_sock</span> <span class="o">=</span> <span class="n">accept</span><span class="p">(</span><span class="n">listenfd</span><span class="p">,(</span><span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">remote</span><span class="p">,</span> 
                                <span class="p">(</span><span class="n">size_t</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">addrlen</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                    <span class="n">setnonblocking</span><span class="p">(</span><span class="n">conn_sock</span><span class="p">);</span>
                    <span class="n">ev</span><span class="p">.</span><span class="n">events</span> <span class="o">=</span> <span class="n">EPOLLIN</span> <span class="o">|</span> <span class="n">EPOLLET</span><span class="p">;</span>
                    <span class="n">ev</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">fd</span> <span class="o">=</span> <span class="n">conn_sock</span><span class="p">;</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">epoll_ctl</span><span class="p">(</span><span class="n">epfd</span><span class="p">,</span> <span class="n">EPOLL_CTL_ADD</span><span class="p">,</span> <span class="n">conn_sock</span><span class="p">,</span>
                                <span class="o">&amp;</span><span class="n">ev</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
                        <span class="n">perror</span><span class="p">(</span><span class="s">&#34;epoll_ctl: add&#34;</span><span class="p">);</span>
                        <span class="n">exit</span><span class="p">(</span><span class="n">EXIT_FAILURE</span><span class="p">);</span>
                    <span class="p">}</span>
                <span class="p">}</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">conn_sock</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">errno</span> <span class="o">!=</span> <span class="n">EAGAIN</span> <span class="o">&amp;&amp;</span> <span class="n">errno</span> <span class="o">!=</span> <span class="n">ECONNABORTED</span> 
                            <span class="o">&amp;&amp;</span> <span class="n">errno</span> <span class="o">!=</span> <span class="n">EPROTO</span> <span class="o">&amp;&amp;</span> <span class="n">errno</span> <span class="o">!=</span> <span class="n">EINTR</span><span class="p">)</span> 
                        <span class="n">perror</span><span class="p">(</span><span class="s">&#34;accept&#34;</span><span class="p">);</span>
                <span class="p">}</span>
                <span class="k">continue</span><span class="p">;</span>
            <span class="p">}</span>  
            <span class="k">if</span> <span class="p">(</span><span class="n">events</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">events</span> <span class="o">&amp;</span> <span class="n">EPOLLIN</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">n</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
                <span class="k">while</span> <span class="p">((</span><span class="n">nread</span> <span class="o">=</span> <span class="n">read</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">buf</span> <span class="o">+</span> <span class="n">n</span><span class="p">,</span> <span class="n">BUFSIZ</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                    <span class="n">n</span> <span class="o">+=</span> <span class="n">nread</span><span class="p">;</span>
                <span class="p">}</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">nread</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">errno</span> <span class="o">!=</span> <span class="n">EAGAIN</span><span class="p">)</span> <span class="p">{</span>
                    <span class="n">perror</span><span class="p">(</span><span class="s">&#34;read error&#34;</span><span class="p">);</span>
                <span class="p">}</span>
                <span class="n">ev</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">fd</span> <span class="o">=</span> <span class="n">fd</span><span class="p">;</span>
                <span class="n">ev</span><span class="p">.</span><span class="n">events</span> <span class="o">=</span> <span class="n">events</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">events</span> <span class="o">|</span> <span class="n">EPOLLOUT</span><span class="p">;</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">epoll_ctl</span><span class="p">(</span><span class="n">epfd</span><span class="p">,</span> <span class="n">EPOLL_CTL_MOD</span><span class="p">,</span> <span class="n">fd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ev</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
                    <span class="n">perror</span><span class="p">(</span><span class="s">&#34;epoll_ctl: mod&#34;</span><span class="p">);</span>
                <span class="p">}</span>
            <span class="p">}</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">events</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">events</span> <span class="o">&amp;</span> <span class="n">EPOLLOUT</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&#34;HTTP/1.1 200 OK</span><span class="se">\r\n</span><span class="s">Content-Length: %d</span><span class="se">\r\n\r\n</span><span class="s">Hello World&#34;</span><span class="p">,</span> <span class="mi">11</span><span class="p">);</span>
                <span class="kt">int</span> <span class="n">nwrite</span><span class="p">,</span> <span class="n">data_size</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
                <span class="n">n</span> <span class="o">=</span> <span class="n">data_size</span><span class="p">;</span>
                <span class="k">while</span> <span class="p">(</span><span class="n">n</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                    <span class="n">nwrite</span> <span class="o">=</span> <span class="n">write</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">buf</span> <span class="o">+</span> <span class="n">data_size</span> <span class="o">-</span> <span class="n">n</span><span class="p">,</span> <span class="n">n</span><span class="p">);</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">nwrite</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">)</span> <span class="p">{</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">nwrite</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">errno</span> <span class="o">!=</span> <span class="n">EAGAIN</span><span class="p">)</span> <span class="p">{</span>
                            <span class="n">perror</span><span class="p">(</span><span class="s">&#34;write error&#34;</span><span class="p">);</span>
                        <span class="p">}</span>
                        <span class="k">break</span><span class="p">;</span>
                    <span class="p">}</span>
                    <span class="n">n</span> <span class="o">-=</span> <span class="n">nwrite</span><span class="p">;</span>
                <span class="p">}</span>
                <span class="n">close</span><span class="p">(</span><span class="n">fd</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
 
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div>
    </div>

    <div class="post-copyright">
  <p class="copyright-item">
    <span class="item-title">Author</span>
    <span class="item-content">Rg</span>
  </p>
  <p class="copyright-item">
    <span class="item-title">LastMod</span>
    <span class="item-content">
        2013-06-10
        
    </span>
  </p>
  
  <p class="copyright-item">
    <span class="item-title">License</span>
    <span class="item-content">本文采用<a rel="license" href="http://creativecommons.org/licenses/by-nc/4.0/" target="_blank">知识共享署名-非商业性使用 4.0 国际许可协议</a>进行许可</span>
  </p>
</div>
<div class="post-reward">
  <input type="checkbox" name="reward" id="reward" hidden />
  <label class="reward-button" for="reward">Reward</label>
  <div class="qr-code">
    
    <label class="qr-code-image" for="reward">
        <img class="image" src="https://ws2.sinaimg.cn/large/006tNc79gy1g1r15n5iquj30u014qgqe.jpg">
        <span>wechat</span>
      </label>
    
  </div>
</div><footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/muduo/">muduo</a>
          <a href="/tags/muduo-base-library/">muduo base library</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/2013/06/10/muduo-base-library-2/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">muduo_base_library_2</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        
      </nav>
    </footer>
  </article>
        </div>
        <div id="gitalk-container"></div>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js" crossorigin="anonymous"></script>
    <script type="text/javascript">
      var gitalk = new Gitalk({
        id: '2013-06-10 01:09:28 \x2b0000 UTC',
        title: 'muduo_base_library_1',
        clientID: '88e50f263d090b13460f',
        clientSecret: 'f1007eb6cff0af3b461be3a4b73d808ab7058a21',
        repo: 'blog',
        owner: 'laohanlinux',
        admin: ['laohanlinux'],
        body: decodeURI(location.href)
      });
      gitalk.render('gitalk-container');
    </script>
    <noscript>Please enable JavaScript to view the <a href="https://github.com/gitalk/gitalk">comments powered by gitalk.</a></noscript>

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
      <a href="mailto:daimaldd@email.com" class="iconfont icon-email" title="email"></a>
      <a href="https://github.com/laohanlinux" class="iconfont icon-github" title="github"></a>
  <a href="https://laohanlinux.github.io/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2013 - 
    2019
    <span class="heart">
      <i class="iconfont icon-heart"></i>
    </span>
    <span class="author">Rg</span>
  </span>
</div>
    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script>
<script type="text/javascript" src="/dist/even.26188efa.min.js"></script>








</body>
</html>
