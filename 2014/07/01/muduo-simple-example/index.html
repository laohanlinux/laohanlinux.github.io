<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>muduo simple example - Welcome to Rg Home</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<meta name="author" content="Rg" /><meta name="description" content="muduo 是一个linux 网络库，使用poll和epoll模式。 这些内容是本人在大学的时候，通过  &lt;&lt; c&#43;&#43;教程网 &gt;&gt;  所学的知识笔记. 已经过去好几年了，版本也是比较老的了，属于入门级别的教程； 如有错误，纯属正常!!!" /><meta name="keywords" content="Rg, Rust, even" />






<meta name="generator" content="Hugo 0.54.0 with even 4.0.0" />


<link rel="canonical" href="https://laohanlinux.github.io/2014/07/01/muduo-simple-example/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">


<link href="/dist/even.3292c2b1.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">


<meta property="og:title" content="muduo simple example" />
<meta property="og:description" content="muduo 是一个linux 网络库，使用poll和epoll模式。 这些内容是本人在大学的时候，通过  &lt;&lt; c&#43;&#43;教程网 &gt;&gt;  所学的知识笔记. 已经过去好几年了，版本也是比较老的了，属于入门级别的教程； 如有错误，纯属正常!!!" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://laohanlinux.github.io/2014/07/01/muduo-simple-example/" />
<meta property="article:published_time" content="2014-07-01T01:22:24&#43;00:00"/>
<meta property="article:modified_time" content="2014-07-01T01:22:24&#43;00:00"/>

<meta itemprop="name" content="muduo simple example">
<meta itemprop="description" content="muduo 是一个linux 网络库，使用poll和epoll模式。 这些内容是本人在大学的时候，通过  &lt;&lt; c&#43;&#43;教程网 &gt;&gt;  所学的知识笔记. 已经过去好几年了，版本也是比较老的了，属于入门级别的教程； 如有错误，纯属正常!!!">


<meta itemprop="datePublished" content="2014-07-01T01:22:24&#43;00:00" />
<meta itemprop="dateModified" content="2014-07-01T01:22:24&#43;00:00" />
<meta itemprop="wordCount" content="10827">



<meta itemprop="keywords" content="muduo," />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="muduo simple example"/>
<meta name="twitter:description" content="muduo 是一个linux 网络库，使用poll和epoll模式。 这些内容是本人在大学的时候，通过  &lt;&lt; c&#43;&#43;教程网 &gt;&gt;  所学的知识笔记. 已经过去好几年了，版本也是比较老的了，属于入门级别的教程； 如有错误，纯属正常!!!"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">Welcome come to Rg Home</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Go ~/</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a>
  </ul>
</nav>
  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">Welcome come to Rg Home</a>
</div>

<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Go ~/</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li>
  </ul>
</nav>
    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">muduo simple example</h1>

      <div class="post-meta">
        <span class="post-time"> 2014-07-01 </span>
        <div class="post-category">
            <a href="/categories/muduo/"> muduo </a>
            <a href="/categories/network-program/"> network program </a>
            </div>
          <span class="more-meta"> 10827 words </span>
          <span class="more-meta"> 22 mins read </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Contents</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
<ul>
<li>
<ul>
<li><a href="#42-四个-服务器设计模型">[42] 四个 服务器设计模型</a>
<ul>
<li><a href="#下面的程序都是用来解-数独-的-数独的实现如下">下面的程序都是用来解 数独 的，数独的实现如下</a></li>
<li><a href="#reactor模型">reactor模型</a></li>
<li><a href="#multiple-reactor">multiple reactor</a></li>
<li><a href="#reactor-threadpool">reactor + threadPool</a></li>
<li><a href="#multiple-reactors-threadpool">multiple reactors+threadpool</a></li>
</ul></li>
<li><a href="#43-文件传输服务器">[43] 文件传输服务器</a>
<ul>
<li><a href="#单线程模式之一次性发完一个文件">单线程模式之一次性发完一个文件</a></li>
<li><a href="#单线程模型之分块发送文件">单线程模型之分块发送文件</a></li>
<li><a href="#单线程模型之分块发送-智能指针">单线程模型之分块发送（智能指针）</a></li>
</ul></li>
<li><a href="#44-45-muduo实现简单了聊天功能">[44-45] muduo实现简单了聊天功能</a>
<ul>
<li><a href="#聊天服务器-muduomanual-pdf-p66">聊天服务器（MuduoManual.pdf P66）</a></li>
<li><a href="#code-h">code.h</a></li>
<li><a href="#examples-asio-chat-server-cc-单线程">examples/asio/chat/server.cc 单线程</a></li>
<li><a href="#examples-asio-chat-server-threaded-cc-多线程tcpserver-并用mutex来保护共享数据">examples/asio/chat/server_threaded.cc，多线程TcpServer，并用mutex来保护共享数据</a></li>
<li><a href="#examples-asio-chat-server-threaded-efficient-cc-借shared-ptr实现copy-on-write的手法来降低锁竞争">examples/asio/chat/server_threaded_efficient.cc,借shared_ptr实现copy-on-write的手法来降低锁竞争</a></li>
<li><a href="#examples-asio-chat-server-threaded-highperformance-cc-采用thread-local变量实现多线程高效转发">examples/asio/chat/server_threaded_highperformance.cc，采用thread local变量实现多线程高效转发</a></li>
</ul></li>
<li><a href="#47-限制服务器最大并发连接数">[47] 限制服务器最大并发连接数</a>
<ul>
<li><a href="#timing-wheel">Timing wheel</a></li>
</ul></li>
</ul></li>
</ul>
</nav>
  </div>
</div>
    <div class="post-content">
      

<h2 id="42-四个-服务器设计模型">[42] 四个 服务器设计模型</h2>

<p>五个简单TCP协议（MuduoManual.pdf P50）
muduo库网络模型使用示例（sudoku求解服务器MuduoManual.pdf P35 ）</p>

<ul>
<li>reactor（一个IO线程）</li>
<li>reactor + threadpool (一个IO + 多个计算线程)</li>
<li>multiple reactor （多个IO线程）</li>
<li>one loop per thread + thread pool （多个IO线程 + 计算线程池）</li>
</ul>

<p>网络编程关注4个半事件：</p>

<ul>
<li>连接建立</li>
<li>连接断开</li>
<li>消息到达</li>
<li>信息发送完毕（对于低流量的服务来说，通常不需要关注该事件）</li>
</ul>

<p>如何实现server</p>

<ul>
<li>提供一个xxxServer类</li>
<li>在该类中包含一个TcpServer对象</li>
</ul>

<p>注册一些事件</p>

<ul>
<li>OnConnection </li>
<li>OnMessage</li>
<li>OnWriteComplete</li>
<li>TcpConnection::shutdown（）内部实现，只关闭写入这一半</li>
</ul>

<h3 id="下面的程序都是用来解-数独-的-数独的实现如下">下面的程序都是用来解 数独 的，数独的实现如下</h3>

<p>sudoku.h</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-c++" data-lang="c++"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c++" data-lang="c++"><span class="cp">#ifndef MUDUO_EXAMPLES_SUDOKU_SUDOKU_H
</span><span class="cp">#define MUDUO_EXAMPLES_SUDOKU_SUDOKU_H
</span><span class="cp"></span> 
 
<span class="cp">#include</span> <span class="cpf">&lt;muduo/base/Types.h&gt;</span><span class="cp">
</span><span class="cp"></span> 
<span class="c1">// FIXME, use (const char*, len) for saving memory copying.
</span><span class="c1"></span><span class="n">muduo</span><span class="o">::</span><span class="n">string</span> <span class="n">solveSudoku</span><span class="p">(</span><span class="k">const</span> <span class="n">muduo</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span> <span class="n">puzzle</span><span class="p">);</span>
<span class="k">const</span> <span class="kt">int</span> <span class="n">kCells</span> <span class="o">=</span> <span class="mi">81</span><span class="p">;</span>
 
<span class="cp">#endif
</span></code></pre></td></tr></table>
</div>
</div>
<p>sudoku.cc</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-c++" data-lang="c++"><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span><span class="lnt">177
</span><span class="lnt">178
</span><span class="lnt">179
</span><span class="lnt">180
</span><span class="lnt">181
</span><span class="lnt">182
</span><span class="lnt">183
</span><span class="lnt">184
</span><span class="lnt">185
</span><span class="lnt">186
</span><span class="lnt">187
</span><span class="lnt">188
</span><span class="lnt">189
</span><span class="lnt">190
</span><span class="lnt">191
</span><span class="lnt">192
</span><span class="lnt">193
</span><span class="lnt">194
</span><span class="lnt">195
</span><span class="lnt">196
</span><span class="lnt">197
</span><span class="lnt">198
</span><span class="lnt">199
</span><span class="lnt">200
</span><span class="lnt">201
</span><span class="lnt">202
</span><span class="lnt">203
</span><span class="lnt">204
</span><span class="lnt">205
</span><span class="lnt">206
</span><span class="lnt">207
</span><span class="lnt">208
</span><span class="lnt">209
</span><span class="lnt">210
</span><span class="lnt">211
</span><span class="lnt">212
</span><span class="lnt">213
</span><span class="lnt">214
</span><span class="lnt">215
</span><span class="lnt">216
</span><span class="lnt">217
</span><span class="lnt">218
</span><span class="lnt">219
</span><span class="lnt">220
</span><span class="lnt">221
</span><span class="lnt">222
</span><span class="lnt">223
</span><span class="lnt">224
</span><span class="lnt">225
</span><span class="lnt">226
</span><span class="lnt">227
</span><span class="lnt">228
</span><span class="lnt">229
</span><span class="lnt">230
</span><span class="lnt">231
</span><span class="lnt">232
</span><span class="lnt">233
</span><span class="lnt">234
</span><span class="lnt">235
</span><span class="lnt">236
</span><span class="lnt">237
</span><span class="lnt">238
</span><span class="lnt">239
</span><span class="lnt">240
</span><span class="lnt">241
</span><span class="lnt">242
</span><span class="lnt">243
</span><span class="lnt">244
</span><span class="lnt">245
</span><span class="lnt">246
</span><span class="lnt">247
</span><span class="lnt">248
</span><span class="lnt">249
</span><span class="lnt">250
</span><span class="lnt">251
</span><span class="lnt">252
</span><span class="lnt">253
</span><span class="lnt">254
</span><span class="lnt">255
</span><span class="lnt">256
</span><span class="lnt">257
</span><span class="lnt">258
</span><span class="lnt">259
</span><span class="lnt">260
</span><span class="lnt">261
</span><span class="lnt">262
</span><span class="lnt">263
</span><span class="lnt">264
</span><span class="lnt">265
</span><span class="lnt">266
</span><span class="lnt">267
</span><span class="lnt">268
</span><span class="lnt">269
</span><span class="lnt">270
</span><span class="lnt">271
</span><span class="lnt">272
</span><span class="lnt">273
</span><span class="lnt">274
</span><span class="lnt">275
</span><span class="lnt">276
</span><span class="lnt">277
</span><span class="lnt">278
</span><span class="lnt">279
</span><span class="lnt">280
</span><span class="lnt">281
</span><span class="lnt">282
</span><span class="lnt">283
</span><span class="lnt">284
</span><span class="lnt">285
</span><span class="lnt">286
</span><span class="lnt">287
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c++" data-lang="c++"><span class="cp">#include</span> <span class="cpf">&#34;sudoku.h&#34;</span><span class="cp">
</span><span class="cp"></span> 
<span class="cp">#include</span> <span class="cpf">&lt;vector&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;assert.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;string.h&gt;</span><span class="cp">
</span><span class="cp"></span> 
<span class="k">using</span> <span class="k">namespace</span> <span class="n">muduo</span><span class="p">;</span>
 
<span class="k">struct</span> <span class="n">Node</span><span class="p">;</span>
<span class="k">typedef</span> <span class="n">Node</span> <span class="n">Column</span><span class="p">;</span>
<span class="k">struct</span> <span class="n">Node</span>
<span class="p">{</span>
    <span class="n">Node</span><span class="o">*</span> <span class="n">left</span><span class="p">;</span>
    <span class="n">Node</span><span class="o">*</span> <span class="n">right</span><span class="p">;</span>
    <span class="n">Node</span><span class="o">*</span> <span class="n">up</span><span class="p">;</span>
    <span class="n">Node</span><span class="o">*</span> <span class="n">down</span><span class="p">;</span>
    <span class="n">Column</span><span class="o">*</span> <span class="n">col</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">name</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">size</span><span class="p">;</span>
<span class="p">};</span>
 
<span class="k">const</span> <span class="kt">int</span> <span class="n">kMaxNodes</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="mi">81</span><span class="o">*</span><span class="mi">4</span> <span class="o">+</span> <span class="mi">9</span><span class="o">*</span><span class="mi">9</span><span class="o">*</span><span class="mi">9</span><span class="o">*</span><span class="mi">4</span><span class="p">;</span>
<span class="k">const</span> <span class="kt">int</span> <span class="n">kMaxColumns</span> <span class="o">=</span> <span class="mi">400</span><span class="p">;</span>
<span class="k">const</span> <span class="kt">int</span> <span class="n">kRow</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span> <span class="n">kCol</span> <span class="o">=</span> <span class="mi">200</span><span class="p">,</span> <span class="n">kBox</span> <span class="o">=</span> <span class="mi">300</span><span class="p">;</span>
 
<span class="k">class</span><span class="err"> </span><span class="nc">SudokuSolver</span>
<span class="p">{</span>
 <span class="k">public</span><span class="o">:</span>
    <span class="n">SudokuSolver</span><span class="p">(</span><span class="kt">int</span> <span class="n">board</span><span class="p">[</span><span class="n">kCells</span><span class="p">])</span>
      <span class="o">:</span> <span class="n">inout_</span><span class="p">(</span><span class="n">board</span><span class="p">),</span>
        <span class="n">cur_node_</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">stack_</span><span class="p">.</span><span class="n">reserve</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
 
        <span class="n">root_</span> <span class="o">=</span> <span class="n">new_column</span><span class="p">();</span>
        <span class="n">root_</span><span class="o">-&gt;</span><span class="n">left</span> <span class="o">=</span> <span class="n">root_</span><span class="o">-&gt;</span><span class="n">right</span> <span class="o">=</span> <span class="n">root_</span><span class="p">;</span>
        <span class="n">memset</span><span class="p">(</span><span class="n">columns_</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">columns_</span><span class="p">));</span>
 
        <span class="kt">bool</span> <span class="n">rows</span><span class="p">[</span><span class="n">kCells</span><span class="p">][</span><span class="mi">10</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="p">{</span><span class="nb">false</span><span class="p">}</span> <span class="p">};</span>
        <span class="kt">bool</span> <span class="n">cols</span><span class="p">[</span><span class="n">kCells</span><span class="p">][</span><span class="mi">10</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="p">{</span><span class="nb">false</span><span class="p">}</span> <span class="p">};</span>
        <span class="kt">bool</span> <span class="n">boxes</span><span class="p">[</span><span class="n">kCells</span><span class="p">][</span><span class="mi">10</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="p">{</span><span class="nb">false</span><span class="p">}</span> <span class="p">};</span>
 
        <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">kCells</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
            <span class="kt">int</span> <span class="n">row</span> <span class="o">=</span> <span class="n">i</span> <span class="o">/</span> <span class="mi">9</span><span class="p">;</span>
            <span class="kt">int</span> <span class="n">col</span> <span class="o">=</span> <span class="n">i</span> <span class="o">%</span> <span class="mi">9</span><span class="p">;</span>
            <span class="kt">int</span> <span class="n">box</span> <span class="o">=</span> <span class="n">row</span><span class="o">/</span><span class="mi">3</span><span class="o">*</span><span class="mi">3</span> <span class="o">+</span> <span class="n">col</span><span class="o">/</span><span class="mi">3</span><span class="p">;</span>
            <span class="kt">int</span> <span class="n">val</span> <span class="o">=</span> <span class="n">inout_</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
            <span class="n">rows</span><span class="p">[</span><span class="n">row</span><span class="p">][</span><span class="n">val</span><span class="p">]</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
            <span class="n">cols</span><span class="p">[</span><span class="n">col</span><span class="p">][</span><span class="n">val</span><span class="p">]</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
            <span class="n">boxes</span><span class="p">[</span><span class="n">box</span><span class="p">][</span><span class="n">val</span><span class="p">]</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
        <span class="p">}</span>
 
        <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">kCells</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">inout_</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">append_column</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>
 
        <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">9</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">v</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">v</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">;</span> <span class="o">++</span><span class="n">v</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rows</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">v</span><span class="p">])</span>
                    <span class="n">append_column</span><span class="p">(</span><span class="n">get_row_col</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">v</span><span class="p">));</span>
                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cols</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">v</span><span class="p">])</span>
                    <span class="n">append_column</span><span class="p">(</span><span class="n">get_col_col</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">v</span><span class="p">));</span>
                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">boxes</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">v</span><span class="p">])</span>
                    <span class="n">append_column</span><span class="p">(</span><span class="n">get_box_col</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">v</span><span class="p">));</span>
            <span class="p">}</span>
        <span class="p">}</span>
 
        <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">kCells</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">inout_</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                <span class="kt">int</span> <span class="n">row</span> <span class="o">=</span> <span class="n">i</span> <span class="o">/</span> <span class="mi">9</span><span class="p">;</span>
                <span class="kt">int</span> <span class="n">col</span> <span class="o">=</span> <span class="n">i</span> <span class="o">%</span> <span class="mi">9</span><span class="p">;</span>
                <span class="kt">int</span> <span class="n">box</span> <span class="o">=</span> <span class="n">row</span><span class="o">/</span><span class="mi">3</span><span class="o">*</span><span class="mi">3</span> <span class="o">+</span> <span class="n">col</span><span class="o">/</span><span class="mi">3</span><span class="p">;</span>
                <span class="c1">//int val = inout[i];
</span><span class="c1"></span>                <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">v</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">v</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">;</span> <span class="o">++</span><span class="n">v</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">rows</span><span class="p">[</span><span class="n">row</span><span class="p">][</span><span class="n">v</span><span class="p">]</span> <span class="o">||</span> <span class="n">cols</span><span class="p">[</span><span class="n">col</span><span class="p">][</span><span class="n">v</span><span class="p">]</span> <span class="o">||</span> <span class="n">boxes</span><span class="p">[</span><span class="n">box</span><span class="p">][</span><span class="n">v</span><span class="p">]))</span> <span class="p">{</span>
                        <span class="n">Node</span><span class="o">*</span> <span class="n">n0</span> <span class="o">=</span> <span class="n">new_row</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
                        <span class="n">Node</span><span class="o">*</span> <span class="n">nr</span> <span class="o">=</span> <span class="n">new_row</span><span class="p">(</span><span class="n">get_row_col</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">v</span><span class="p">));</span>
                        <span class="n">Node</span><span class="o">*</span> <span class="n">nc</span> <span class="o">=</span> <span class="n">new_row</span><span class="p">(</span><span class="n">get_col_col</span><span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="n">v</span><span class="p">));</span>
                        <span class="n">Node</span><span class="o">*</span> <span class="n">nb</span> <span class="o">=</span> <span class="n">new_row</span><span class="p">(</span><span class="n">get_box_col</span><span class="p">(</span><span class="n">box</span><span class="p">,</span> <span class="n">v</span><span class="p">));</span>
                        <span class="n">put_left</span><span class="p">(</span><span class="n">n0</span><span class="p">,</span> <span class="n">nr</span><span class="p">);</span>
                        <span class="n">put_left</span><span class="p">(</span><span class="n">n0</span><span class="p">,</span> <span class="n">nc</span><span class="p">);</span>
                        <span class="n">put_left</span><span class="p">(</span><span class="n">n0</span><span class="p">,</span> <span class="n">nb</span><span class="p">);</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
 
    <span class="kt">bool</span> <span class="n">solve</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">root_</span><span class="o">-&gt;</span><span class="n">left</span> <span class="o">==</span> <span class="n">root_</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">for</span> <span class="p">(</span><span class="n">size_t</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">stack_</span><span class="p">.</span><span class="n">size</span><span class="p">();</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">Node</span><span class="o">*</span> <span class="n">n</span> <span class="o">=</span> <span class="n">stack_</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
                <span class="kt">int</span> <span class="n">cell</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
                <span class="kt">int</span> <span class="n">val</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
                <span class="k">while</span> <span class="p">(</span><span class="n">cell</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="o">||</span> <span class="n">val</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">n</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="p">)</span>
                        <span class="n">cell</span> <span class="o">=</span> <span class="n">n</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">;</span>
                    <span class="k">else</span>
                        <span class="n">val</span> <span class="o">=</span> <span class="n">n</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">%</span> <span class="mi">10</span><span class="p">;</span>
                    <span class="n">n</span> <span class="o">=</span> <span class="n">n</span><span class="o">-&gt;</span><span class="n">right</span><span class="p">;</span>
                <span class="p">}</span>
 
                <span class="c1">//assert(cell != -1 &amp;&amp; val != -1);
</span><span class="c1"></span>                <span class="n">inout_</span><span class="p">[</span><span class="n">cell</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
        <span class="p">}</span>
 
        <span class="n">Column</span><span class="o">*</span> <span class="k">const</span> <span class="n">col</span> <span class="o">=</span> <span class="n">get_min_column</span><span class="p">();</span>
        <span class="n">cover</span><span class="p">(</span><span class="n">col</span><span class="p">);</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">Node</span><span class="o">*</span> <span class="n">row</span> <span class="o">=</span> <span class="n">col</span><span class="o">-&gt;</span><span class="n">down</span><span class="p">;</span> <span class="n">row</span> <span class="o">!=</span> <span class="n">col</span><span class="p">;</span> <span class="n">row</span> <span class="o">=</span> <span class="n">row</span><span class="o">-&gt;</span><span class="n">down</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">stack_</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">row</span><span class="p">);</span>
            <span class="k">for</span> <span class="p">(</span><span class="n">Node</span><span class="o">*</span> <span class="n">j</span> <span class="o">=</span> <span class="n">row</span><span class="o">-&gt;</span><span class="n">right</span><span class="p">;</span> <span class="n">j</span> <span class="o">!=</span> <span class="n">row</span><span class="p">;</span> <span class="n">j</span> <span class="o">=</span> <span class="n">j</span><span class="o">-&gt;</span><span class="n">right</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">cover</span><span class="p">(</span><span class="n">j</span><span class="o">-&gt;</span><span class="n">col</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">solve</span><span class="p">())</span> <span class="p">{</span>
                <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="n">stack_</span><span class="p">.</span><span class="n">pop_back</span><span class="p">();</span>
            <span class="k">for</span> <span class="p">(</span><span class="n">Node</span><span class="o">*</span> <span class="n">j</span> <span class="o">=</span> <span class="n">row</span><span class="o">-&gt;</span><span class="n">left</span><span class="p">;</span> <span class="n">j</span> <span class="o">!=</span> <span class="n">row</span><span class="p">;</span> <span class="n">j</span> <span class="o">=</span> <span class="n">j</span><span class="o">-&gt;</span><span class="n">left</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">uncover</span><span class="p">(</span><span class="n">j</span><span class="o">-&gt;</span><span class="n">col</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="n">uncover</span><span class="p">(</span><span class="n">col</span><span class="p">);</span>
        <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
    <span class="p">}</span>
 
 <span class="k">private</span><span class="o">:</span>
 
    <span class="n">Column</span><span class="o">*</span> <span class="n">root_</span><span class="p">;</span>
    <span class="kt">int</span><span class="o">*</span>    <span class="n">inout_</span><span class="p">;</span>
    <span class="n">Column</span><span class="o">*</span> <span class="n">columns_</span><span class="p">[</span><span class="mi">400</span><span class="p">];</span>
    <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">Node</span><span class="o">*&gt;</span> <span class="n">stack_</span><span class="p">;</span>
    <span class="n">Node</span>    <span class="n">nodes_</span><span class="p">[</span><span class="n">kMaxNodes</span><span class="p">];</span>
    <span class="kt">int</span>     <span class="n">cur_node_</span><span class="p">;</span>
 
    <span class="n">Column</span><span class="o">*</span> <span class="nf">new_column</span><span class="p">(</span><span class="kt">int</span> <span class="n">n</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">assert</span><span class="p">(</span><span class="n">cur_node_</span> <span class="o">&lt;</span> <span class="n">kMaxNodes</span><span class="p">);</span>
        <span class="n">Column</span><span class="o">*</span> <span class="n">c</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">nodes_</span><span class="p">[</span><span class="n">cur_node_</span><span class="o">++</span><span class="p">];</span>
        <span class="n">memset</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">Column</span><span class="p">));</span>
        <span class="n">c</span><span class="o">-&gt;</span><span class="n">left</span> <span class="o">=</span> <span class="n">c</span><span class="p">;</span>
        <span class="n">c</span><span class="o">-&gt;</span><span class="n">right</span> <span class="o">=</span> <span class="n">c</span><span class="p">;</span>
        <span class="n">c</span><span class="o">-&gt;</span><span class="n">up</span> <span class="o">=</span> <span class="n">c</span><span class="p">;</span>
        <span class="n">c</span><span class="o">-&gt;</span><span class="n">down</span> <span class="o">=</span> <span class="n">c</span><span class="p">;</span>
        <span class="n">c</span><span class="o">-&gt;</span><span class="n">col</span> <span class="o">=</span> <span class="n">c</span><span class="p">;</span>
        <span class="n">c</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">=</span> <span class="n">n</span><span class="p">;</span>
        <span class="k">return</span> <span class="n">c</span><span class="p">;</span>
    <span class="p">}</span>
 
    <span class="kt">void</span> <span class="nf">append_column</span><span class="p">(</span><span class="kt">int</span> <span class="n">n</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">assert</span><span class="p">(</span><span class="n">columns_</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">);</span>
 
        <span class="n">Column</span><span class="o">*</span> <span class="n">c</span> <span class="o">=</span> <span class="n">new_column</span><span class="p">(</span><span class="n">n</span><span class="p">);</span>
        <span class="n">put_left</span><span class="p">(</span><span class="n">root_</span><span class="p">,</span> <span class="n">c</span><span class="p">);</span>
        <span class="n">columns_</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">c</span><span class="p">;</span>
    <span class="p">}</span>
 
    <span class="n">Node</span><span class="o">*</span> <span class="nf">new_row</span><span class="p">(</span><span class="kt">int</span> <span class="n">col</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">assert</span><span class="p">(</span><span class="n">columns_</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">);</span>
        <span class="n">assert</span><span class="p">(</span><span class="n">cur_node_</span> <span class="o">&lt;</span> <span class="n">kMaxNodes</span><span class="p">);</span>
 
        <span class="n">Node</span><span class="o">*</span> <span class="n">r</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">nodes_</span><span class="p">[</span><span class="n">cur_node_</span><span class="o">++</span><span class="p">];</span>
 
        <span class="c1">//Node* r = new Node;
</span><span class="c1"></span>        <span class="n">memset</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">Node</span><span class="p">));</span>
        <span class="n">r</span><span class="o">-&gt;</span><span class="n">left</span> <span class="o">=</span> <span class="n">r</span><span class="p">;</span>
        <span class="n">r</span><span class="o">-&gt;</span><span class="n">right</span> <span class="o">=</span> <span class="n">r</span><span class="p">;</span>
        <span class="n">r</span><span class="o">-&gt;</span><span class="n">up</span> <span class="o">=</span> <span class="n">r</span><span class="p">;</span>
        <span class="n">r</span><span class="o">-&gt;</span><span class="n">down</span> <span class="o">=</span> <span class="n">r</span><span class="p">;</span>
        <span class="n">r</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">=</span> <span class="n">col</span><span class="p">;</span>
        <span class="n">r</span><span class="o">-&gt;</span><span class="n">col</span> <span class="o">=</span> <span class="n">columns_</span><span class="p">[</span><span class="n">col</span><span class="p">];</span>
        <span class="n">put_up</span><span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">col</span><span class="p">,</span> <span class="n">r</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">r</span><span class="p">;</span>
    <span class="p">}</span>
 
    <span class="kt">int</span> <span class="nf">get_row_col</span><span class="p">(</span><span class="kt">int</span> <span class="n">row</span><span class="p">,</span> <span class="kt">int</span> <span class="n">val</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="n">kRow</span><span class="o">+</span><span class="n">row</span><span class="o">*</span><span class="mi">10</span><span class="o">+</span><span class="n">val</span><span class="p">;</span>
    <span class="p">}</span>
 
    <span class="kt">int</span> <span class="nf">get_col_col</span><span class="p">(</span><span class="kt">int</span> <span class="n">col</span><span class="p">,</span> <span class="kt">int</span> <span class="n">val</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="n">kCol</span><span class="o">+</span><span class="n">col</span><span class="o">*</span><span class="mi">10</span><span class="o">+</span><span class="n">val</span><span class="p">;</span>
    <span class="p">}</span>
 
    <span class="kt">int</span> <span class="nf">get_box_col</span><span class="p">(</span><span class="kt">int</span> <span class="n">box</span><span class="p">,</span> <span class="kt">int</span> <span class="n">val</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="n">kBox</span><span class="o">+</span><span class="n">box</span><span class="o">*</span><span class="mi">10</span><span class="o">+</span><span class="n">val</span><span class="p">;</span>
    <span class="p">}</span>
 
    <span class="n">Column</span><span class="o">*</span> <span class="nf">get_min_column</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="n">Column</span><span class="o">*</span> <span class="n">c</span> <span class="o">=</span> <span class="n">root_</span><span class="o">-&gt;</span><span class="n">right</span><span class="p">;</span>
        <span class="kt">int</span> <span class="n">min_size</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">min_size</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">for</span> <span class="p">(</span><span class="n">Column</span><span class="o">*</span> <span class="n">cc</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">right</span><span class="p">;</span> <span class="n">cc</span> <span class="o">!=</span> <span class="n">root_</span><span class="p">;</span> <span class="n">cc</span> <span class="o">=</span> <span class="n">cc</span><span class="o">-&gt;</span><span class="n">right</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">min_size</span> <span class="o">&gt;</span> <span class="n">cc</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">)</span> <span class="p">{</span>
                    <span class="n">c</span> <span class="o">=</span> <span class="n">cc</span><span class="p">;</span>
                    <span class="n">min_size</span> <span class="o">=</span> <span class="n">cc</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">;</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">min_size</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">)</span>
                        <span class="k">break</span><span class="p">;</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">c</span><span class="p">;</span>
    <span class="p">}</span>
 
    <span class="kt">void</span> <span class="nf">cover</span><span class="p">(</span><span class="n">Column</span><span class="o">*</span> <span class="n">c</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">c</span><span class="o">-&gt;</span><span class="n">right</span><span class="o">-&gt;</span><span class="n">left</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">left</span><span class="p">;</span>
        <span class="n">c</span><span class="o">-&gt;</span><span class="n">left</span><span class="o">-&gt;</span><span class="n">right</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">right</span><span class="p">;</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">Node</span><span class="o">*</span> <span class="n">row</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">down</span><span class="p">;</span> <span class="n">row</span> <span class="o">!=</span> <span class="n">c</span><span class="p">;</span> <span class="n">row</span> <span class="o">=</span> <span class="n">row</span><span class="o">-&gt;</span><span class="n">down</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">for</span> <span class="p">(</span><span class="n">Node</span><span class="o">*</span> <span class="n">j</span> <span class="o">=</span> <span class="n">row</span><span class="o">-&gt;</span><span class="n">right</span><span class="p">;</span> <span class="n">j</span> <span class="o">!=</span> <span class="n">row</span><span class="p">;</span> <span class="n">j</span> <span class="o">=</span> <span class="n">j</span><span class="o">-&gt;</span><span class="n">right</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">j</span><span class="o">-&gt;</span><span class="n">down</span><span class="o">-&gt;</span><span class="n">up</span> <span class="o">=</span> <span class="n">j</span><span class="o">-&gt;</span><span class="n">up</span><span class="p">;</span>
                <span class="n">j</span><span class="o">-&gt;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">down</span> <span class="o">=</span> <span class="n">j</span><span class="o">-&gt;</span><span class="n">down</span><span class="p">;</span>
                <span class="n">j</span><span class="o">-&gt;</span><span class="n">col</span><span class="o">-&gt;</span><span class="n">size</span><span class="o">--</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
 
    <span class="kt">void</span> <span class="nf">uncover</span><span class="p">(</span><span class="n">Column</span><span class="o">*</span> <span class="n">c</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">Node</span><span class="o">*</span> <span class="n">row</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">up</span><span class="p">;</span> <span class="n">row</span> <span class="o">!=</span> <span class="n">c</span><span class="p">;</span> <span class="n">row</span> <span class="o">=</span> <span class="n">row</span><span class="o">-&gt;</span><span class="n">up</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">for</span> <span class="p">(</span><span class="n">Node</span><span class="o">*</span> <span class="n">j</span> <span class="o">=</span> <span class="n">row</span><span class="o">-&gt;</span><span class="n">left</span><span class="p">;</span> <span class="n">j</span> <span class="o">!=</span> <span class="n">row</span><span class="p">;</span> <span class="n">j</span> <span class="o">=</span> <span class="n">j</span><span class="o">-&gt;</span><span class="n">left</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">j</span><span class="o">-&gt;</span><span class="n">col</span><span class="o">-&gt;</span><span class="n">size</span><span class="o">++</span><span class="p">;</span>
                <span class="n">j</span><span class="o">-&gt;</span><span class="n">down</span><span class="o">-&gt;</span><span class="n">up</span> <span class="o">=</span> <span class="n">j</span><span class="p">;</span>
                <span class="n">j</span><span class="o">-&gt;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">down</span> <span class="o">=</span> <span class="n">j</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="n">c</span><span class="o">-&gt;</span><span class="n">right</span><span class="o">-&gt;</span><span class="n">left</span> <span class="o">=</span> <span class="n">c</span><span class="p">;</span>
        <span class="n">c</span><span class="o">-&gt;</span><span class="n">left</span><span class="o">-&gt;</span><span class="n">right</span> <span class="o">=</span> <span class="n">c</span><span class="p">;</span>
    <span class="p">}</span>
 
    <span class="kt">void</span> <span class="nf">put_left</span><span class="p">(</span><span class="n">Column</span><span class="o">*</span> <span class="n">old</span><span class="p">,</span> <span class="n">Column</span><span class="o">*</span> <span class="n">nnew</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">nnew</span><span class="o">-&gt;</span><span class="n">left</span> <span class="o">=</span> <span class="n">old</span><span class="o">-&gt;</span><span class="n">left</span><span class="p">;</span>
        <span class="n">nnew</span><span class="o">-&gt;</span><span class="n">right</span> <span class="o">=</span> <span class="n">old</span><span class="p">;</span>
        <span class="n">old</span><span class="o">-&gt;</span><span class="n">left</span><span class="o">-&gt;</span><span class="n">right</span> <span class="o">=</span> <span class="n">nnew</span><span class="p">;</span>
        <span class="n">old</span><span class="o">-&gt;</span><span class="n">left</span> <span class="o">=</span> <span class="n">nnew</span><span class="p">;</span>
    <span class="p">}</span>
 
    <span class="kt">void</span> <span class="nf">put_up</span><span class="p">(</span><span class="n">Column</span><span class="o">*</span> <span class="n">old</span><span class="p">,</span> <span class="n">Node</span><span class="o">*</span> <span class="n">nnew</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">nnew</span><span class="o">-&gt;</span><span class="n">up</span> <span class="o">=</span> <span class="n">old</span><span class="o">-&gt;</span><span class="n">up</span><span class="p">;</span>
        <span class="n">nnew</span><span class="o">-&gt;</span><span class="n">down</span> <span class="o">=</span> <span class="n">old</span><span class="p">;</span>
        <span class="n">old</span><span class="o">-&gt;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">down</span> <span class="o">=</span> <span class="n">nnew</span><span class="p">;</span>
        <span class="n">old</span><span class="o">-&gt;</span><span class="n">up</span> <span class="o">=</span> <span class="n">nnew</span><span class="p">;</span>
        <span class="n">old</span><span class="o">-&gt;</span><span class="n">size</span><span class="o">++</span><span class="p">;</span>
        <span class="n">nnew</span><span class="o">-&gt;</span><span class="n">col</span> <span class="o">=</span> <span class="n">old</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">};</span>
 
<span class="n">string</span> <span class="nf">solveSudoku</span><span class="p">(</span><span class="k">const</span> <span class="n">string</span><span class="o">&amp;</span> <span class="n">puzzle</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">assert</span><span class="p">(</span><span class="n">puzzle</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">==</span> <span class="n">implicit_cast</span><span class="o">&lt;</span><span class="n">size_t</span><span class="o">&gt;</span><span class="p">(</span><span class="n">kCells</span><span class="p">));</span>
 
  <span class="n">string</span> <span class="n">result</span> <span class="o">=</span> <span class="s">&#34;NoSolution&#34;</span><span class="p">;</span>
 
  <span class="kt">int</span> <span class="n">board</span><span class="p">[</span><span class="n">kCells</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span> <span class="p">};</span>
  <span class="kt">bool</span> <span class="n">valid</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
  <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">kCells</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">board</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">puzzle</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="sc">&#39;0&#39;</span><span class="p">;</span>
    <span class="n">valid</span> <span class="o">=</span> <span class="n">valid</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">board</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="n">board</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">9</span><span class="p">);</span>
  <span class="p">}</span>
 
  <span class="k">if</span> <span class="p">(</span><span class="n">valid</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">SudokuSolver</span> <span class="n">s</span><span class="p">(</span><span class="n">board</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="p">.</span><span class="n">solve</span><span class="p">())</span>
    <span class="p">{</span>
      <span class="n">result</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span>
      <span class="n">result</span><span class="p">.</span><span class="n">resize</span><span class="p">(</span><span class="n">kCells</span><span class="p">);</span>
      <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">kCells</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
      <span class="p">{</span>
        <span class="n">result</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">char</span><span class="o">&gt;</span><span class="p">(</span><span class="n">board</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="sc">&#39;0&#39;</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div>
<h3 id="reactor模型">reactor模型</h3>

<p>只有一个IO线程：这个IO线程既负责listenfd也负责connfd</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-c++" data-lang="c++"><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c++" data-lang="c++"><span class="cp">#include</span> <span class="cpf">&#34;sudoku.h&#34;</span><span class="cp">
</span><span class="cp"></span> 
<span class="cp">#include</span> <span class="cpf">&lt;muduo/base/Atomic.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;muduo/base/Logging.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;muduo/base/Thread.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;muduo/net/EventLoop.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;muduo/net/InetAddress.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;muduo/net/TcpServer.h&gt;</span><span class="cp">
</span><span class="cp"></span> 
<span class="cp">#include</span> <span class="cpf">&lt;boost/bind.hpp&gt;</span><span class="cp">
</span><span class="cp"></span> 
<span class="cp">#include</span> <span class="cpf">&lt;utility&gt;</span><span class="cp">
</span><span class="cp"></span> 
<span class="cp">#include</span> <span class="cpf">&lt;mcheck.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;unistd.h&gt;</span><span class="cp">
</span><span class="cp"></span> 
<span class="k">using</span> <span class="k">namespace</span> <span class="n">muduo</span><span class="p">;</span>
<span class="k">using</span> <span class="k">namespace</span> <span class="n">muduo</span><span class="o">::</span><span class="n">net</span><span class="p">;</span>
 
<span class="k">class</span><span class="err"> </span><span class="nc">SudokuServer</span>
<span class="p">{</span>
 <span class="k">public</span><span class="o">:</span>
  <span class="n">SudokuServer</span><span class="p">(</span><span class="n">EventLoop</span><span class="o">*</span> <span class="n">loop</span><span class="p">,</span> <span class="k">const</span> <span class="n">InetAddress</span><span class="o">&amp;</span> <span class="n">listenAddr</span><span class="p">)</span>
    <span class="o">:</span> <span class="n">loop_</span><span class="p">(</span><span class="n">loop</span><span class="p">),</span>
      <span class="n">server_</span><span class="p">(</span><span class="n">loop</span><span class="p">,</span> <span class="n">listenAddr</span><span class="p">,</span> <span class="s">&#34;SudokuServer&#34;</span><span class="p">),</span>
      <span class="n">startTime_</span><span class="p">(</span><span class="n">Timestamp</span><span class="o">::</span><span class="n">now</span><span class="p">())</span>
  <span class="p">{</span>
    <span class="n">server_</span><span class="p">.</span><span class="n">setConnectionCallback</span><span class="p">(</span>
        <span class="n">boost</span><span class="o">::</span><span class="n">bind</span><span class="p">(</span><span class="o">&amp;</span><span class="n">SudokuServer</span><span class="o">::</span><span class="n">onConnection</span><span class="p">,</span> <span class="k">this</span><span class="p">,</span> <span class="n">_1</span><span class="p">));</span>
    <span class="n">server_</span><span class="p">.</span><span class="n">setMessageCallback</span><span class="p">(</span>
        <span class="n">boost</span><span class="o">::</span><span class="n">bind</span><span class="p">(</span><span class="o">&amp;</span><span class="n">SudokuServer</span><span class="o">::</span><span class="n">onMessage</span><span class="p">,</span> <span class="k">this</span><span class="p">,</span> <span class="n">_1</span><span class="p">,</span> <span class="n">_2</span><span class="p">,</span> <span class="n">_3</span><span class="p">));</span>
  <span class="p">}</span>
 
  <span class="kt">void</span> <span class="n">start</span><span class="p">()</span>
  <span class="p">{</span>
    <span class="n">server_</span><span class="p">.</span><span class="n">start</span><span class="p">();</span>
  <span class="p">}</span>
 
 <span class="k">private</span><span class="o">:</span>
  <span class="kt">void</span> <span class="n">onConnection</span><span class="p">(</span><span class="k">const</span> <span class="n">TcpConnectionPtr</span><span class="o">&amp;</span> <span class="n">conn</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">LOG_TRACE</span> <span class="o">&lt;&lt;</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">peerAddress</span><span class="p">().</span><span class="n">toIpPort</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="s">&#34; -&gt; &#34;</span>
        <span class="o">&lt;&lt;</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">localAddress</span><span class="p">().</span><span class="n">toIpPort</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="s">&#34; is &#34;</span>
        <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">connected</span><span class="p">()</span> <span class="o">?</span> <span class="s">&#34;UP&#34;</span> <span class="o">:</span> <span class="s">&#34;DOWN&#34;</span><span class="p">);</span>
  <span class="p">}</span>
 
  <span class="kt">void</span> <span class="n">onMessage</span><span class="p">(</span><span class="k">const</span> <span class="n">TcpConnectionPtr</span><span class="o">&amp;</span> <span class="n">conn</span><span class="p">,</span> <span class="n">Buffer</span><span class="o">*</span> <span class="n">buf</span><span class="p">,</span> <span class="n">Timestamp</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">LOG_DEBUG</span> <span class="o">&lt;&lt;</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">();</span>
    <span class="n">size_t</span> <span class="n">len</span> <span class="o">=</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">readableBytes</span><span class="p">();</span>
    <span class="k">while</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;=</span> <span class="n">kCells</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">crlf</span> <span class="o">=</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">findCRLF</span><span class="p">();</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">crlf</span><span class="p">)</span>
      <span class="p">{</span>
        <span class="n">string</span> <span class="n">request</span><span class="p">(</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">peek</span><span class="p">(),</span> <span class="n">crlf</span><span class="p">);</span>
        <span class="n">buf</span><span class="o">-&gt;</span><span class="n">retrieveUntil</span><span class="p">(</span><span class="n">crlf</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>
        <span class="n">len</span> <span class="o">=</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">readableBytes</span><span class="p">();</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">processRequest</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">request</span><span class="p">))</span>
        <span class="p">{</span>
          <span class="n">conn</span><span class="o">-&gt;</span><span class="n">send</span><span class="p">(</span><span class="s">&#34;Bad Request!</span><span class="se">\r\n</span><span class="s">&#34;</span><span class="p">);</span>
          <span class="n">conn</span><span class="o">-&gt;</span><span class="n">shutdown</span><span class="p">();</span>
          <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>
      <span class="p">}</span>
      <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="mi">100</span><span class="p">)</span> <span class="c1">// id + &#34;:&#34; + kCells + &#34;\r\n&#34;
</span><span class="c1"></span>      <span class="p">{</span>
        <span class="n">conn</span><span class="o">-&gt;</span><span class="n">send</span><span class="p">(</span><span class="s">&#34;Id too long!</span><span class="se">\r\n</span><span class="s">&#34;</span><span class="p">);</span>
        <span class="n">conn</span><span class="o">-&gt;</span><span class="n">shutdown</span><span class="p">();</span>
        <span class="k">break</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">else</span>
      <span class="p">{</span>
        <span class="k">break</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
 
  <span class="kt">bool</span> <span class="n">processRequest</span><span class="p">(</span><span class="k">const</span> <span class="n">TcpConnectionPtr</span><span class="o">&amp;</span> <span class="n">conn</span><span class="p">,</span> <span class="k">const</span> <span class="n">string</span><span class="o">&amp;</span> <span class="n">request</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">string</span> <span class="n">id</span><span class="p">;</span>
    <span class="n">string</span> <span class="n">puzzle</span><span class="p">;</span>
    <span class="kt">bool</span> <span class="n">goodRequest</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
 
    <span class="n">string</span><span class="o">::</span><span class="n">const_iterator</span> <span class="n">colon</span> <span class="o">=</span> <span class="n">find</span><span class="p">(</span><span class="n">request</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span> <span class="n">request</span><span class="p">.</span><span class="n">end</span><span class="p">(),</span> <span class="sc">&#39;:&#39;</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">colon</span> <span class="o">!=</span> <span class="n">request</span><span class="p">.</span><span class="n">end</span><span class="p">())</span>
    <span class="p">{</span>
      <span class="n">id</span><span class="p">.</span><span class="n">assign</span><span class="p">(</span><span class="n">request</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span> <span class="n">colon</span><span class="p">);</span>
      <span class="n">puzzle</span><span class="p">.</span><span class="n">assign</span><span class="p">(</span><span class="n">colon</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">request</span><span class="p">.</span><span class="n">end</span><span class="p">());</span>
    <span class="p">}</span>
    <span class="k">else</span>
    <span class="p">{</span>
      <span class="n">puzzle</span> <span class="o">=</span> <span class="n">request</span><span class="p">;</span>
    <span class="p">}</span>
 
    <span class="k">if</span> <span class="p">(</span><span class="n">puzzle</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">==</span> <span class="n">implicit_cast</span><span class="o">&lt;</span><span class="n">size_t</span><span class="o">&gt;</span><span class="p">(</span><span class="n">kCells</span><span class="p">))</span>
    <span class="p">{</span>
      <span class="n">LOG_DEBUG</span> <span class="o">&lt;&lt;</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">();</span>
      <span class="n">string</span> <span class="n">result</span> <span class="o">=</span> <span class="n">solveSudoku</span><span class="p">(</span><span class="n">puzzle</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">id</span><span class="p">.</span><span class="n">empty</span><span class="p">())</span>
      <span class="p">{</span>
        <span class="n">conn</span><span class="o">-&gt;</span><span class="n">send</span><span class="p">(</span><span class="n">result</span><span class="o">+</span><span class="s">&#34;</span><span class="se">\r\n</span><span class="s">&#34;</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="k">else</span>
      <span class="p">{</span>
        <span class="n">conn</span><span class="o">-&gt;</span><span class="n">send</span><span class="p">(</span><span class="n">id</span><span class="o">+</span><span class="s">&#34;:&#34;</span><span class="o">+</span><span class="n">result</span><span class="o">+</span><span class="s">&#34;</span><span class="se">\r\n</span><span class="s">&#34;</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">else</span>
    <span class="p">{</span>
      <span class="n">goodRequest</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">goodRequest</span><span class="p">;</span>
  <span class="p">}</span>
 
  <span class="n">EventLoop</span><span class="o">*</span> <span class="n">loop_</span><span class="p">;</span>
  <span class="n">TcpServer</span> <span class="n">server_</span><span class="p">;</span>
  <span class="n">Timestamp</span> <span class="n">startTime_</span><span class="p">;</span>
<span class="p">};</span>
 
<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span><span class="o">*</span> <span class="n">argv</span><span class="p">[])</span>
<span class="p">{</span>
  <span class="n">LOG_INFO</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;pid = &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">getpid</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;, tid = &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">CurrentThread</span><span class="o">::</span><span class="n">tid</span><span class="p">();</span>
  <span class="n">EventLoop</span> <span class="n">loop</span><span class="p">;</span>
  <span class="n">InetAddress</span> <span class="n">listenAddr</span><span class="p">(</span><span class="mi">9981</span><span class="p">);</span>
  <span class="n">SudokuServer</span> <span class="n">server</span><span class="p">(</span><span class="o">&amp;</span><span class="n">loop</span><span class="p">,</span> <span class="n">listenAddr</span><span class="p">);</span>
 
  <span class="n">server</span><span class="p">.</span><span class="n">start</span><span class="p">();</span>
 
  <span class="n">loop</span><span class="p">.</span><span class="n">loop</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div>
<h3 id="multiple-reactor">multiple reactor</h3>

<ul>
<li>IO线程的数目多个</li>
<li>EventLoopThreadPoll IO线程池</li>
<li>直接设置server_.setThreadNum(numThreads)就OK了</li>
</ul>

<p>main reactor 负责listenfd accept , sub reactor  负责connfd, 使用roundbin轮叫策略
来一个连接，就选择下一个EventLoop，这样让多个连接分配给若干个EventLoop来处理，
而每个EventLoop属于一个IO线程，也就意味着，多个连接分配给若干个IO线程来处理。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-c++" data-lang="c++"><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c++" data-lang="c++"><span class="n">include</span> <span class="s">&#34;sudoku.h&#34;</span>
 
<span class="cp">#include</span> <span class="cpf">&lt;muduo/base/Atomic.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;muduo/base/Logging.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;muduo/base/Thread.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;muduo/net/EventLoop.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;muduo/net/InetAddress.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;muduo/net/TcpServer.h&gt;</span><span class="cp">
</span><span class="cp"></span> 
<span class="cp">#include</span> <span class="cpf">&lt;boost/bind.hpp&gt;</span><span class="cp">
</span><span class="cp"></span> 
<span class="cp">#include</span> <span class="cpf">&lt;utility&gt;</span><span class="cp">
</span><span class="cp"></span> 
<span class="cp">#include</span> <span class="cpf">&lt;mcheck.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;unistd.h&gt;</span><span class="cp">
</span><span class="cp"></span> 
<span class="k">using</span> <span class="k">namespace</span> <span class="n">muduo</span><span class="p">;</span>
<span class="k">using</span> <span class="k">namespace</span> <span class="n">muduo</span><span class="o">::</span><span class="n">net</span><span class="p">;</span>
 
<span class="k">class</span><span class="err"> </span><span class="nc">SudokuServer</span>
<span class="p">{</span>
 <span class="k">public</span><span class="o">:</span>
  <span class="n">SudokuServer</span><span class="p">(</span><span class="n">EventLoop</span><span class="o">*</span> <span class="n">loop</span><span class="p">,</span> <span class="k">const</span> <span class="n">InetAddress</span><span class="o">&amp;</span> <span class="n">listenAddr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">numThreads</span><span class="p">)</span>
    <span class="o">:</span> <span class="n">loop_</span><span class="p">(</span><span class="n">loop</span><span class="p">),</span>
      <span class="n">server_</span><span class="p">(</span><span class="n">loop</span><span class="p">,</span> <span class="n">listenAddr</span><span class="p">,</span> <span class="s">&#34;SudokuServer&#34;</span><span class="p">),</span>
      <span class="n">numThreads_</span><span class="p">(</span><span class="n">numThreads</span><span class="p">),</span>
      <span class="n">startTime_</span><span class="p">(</span><span class="n">Timestamp</span><span class="o">::</span><span class="n">now</span><span class="p">())</span>
  <span class="p">{</span>
    <span class="n">server_</span><span class="p">.</span><span class="n">setConnectionCallback</span><span class="p">(</span>
        <span class="n">boost</span><span class="o">::</span><span class="n">bind</span><span class="p">(</span><span class="o">&amp;</span><span class="n">SudokuServer</span><span class="o">::</span><span class="n">onConnection</span><span class="p">,</span> <span class="k">this</span><span class="p">,</span> <span class="n">_1</span><span class="p">));</span>
    <span class="n">server_</span><span class="p">.</span><span class="n">setMessageCallback</span><span class="p">(</span>
        <span class="n">boost</span><span class="o">::</span><span class="n">bind</span><span class="p">(</span><span class="o">&amp;</span><span class="n">SudokuServer</span><span class="o">::</span><span class="n">onMessage</span><span class="p">,</span> <span class="k">this</span><span class="p">,</span> <span class="n">_1</span><span class="p">,</span> <span class="n">_2</span><span class="p">,</span> <span class="n">_3</span><span class="p">));</span>
    <span class="n">server_</span><span class="p">.</span><span class="n">setThreadNum</span><span class="p">(</span><span class="n">numThreads</span><span class="p">);</span>
  <span class="p">}</span>
 
  <span class="kt">void</span> <span class="n">start</span><span class="p">()</span>
  <span class="p">{</span>
    <span class="n">LOG_INFO</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;starting &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">numThreads_</span> <span class="o">&lt;&lt;</span> <span class="s">&#34; threads.&#34;</span><span class="p">;</span>
    <span class="n">server_</span><span class="p">.</span><span class="n">start</span><span class="p">();</span>
  <span class="p">}</span>
 
 <span class="k">private</span><span class="o">:</span>
  <span class="kt">void</span> <span class="n">onConnection</span><span class="p">(</span><span class="k">const</span> <span class="n">TcpConnectionPtr</span><span class="o">&amp;</span> <span class="n">conn</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">LOG_TRACE</span> <span class="o">&lt;&lt;</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">peerAddress</span><span class="p">().</span><span class="n">toIpPort</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="s">&#34; -&gt; &#34;</span>
        <span class="o">&lt;&lt;</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">localAddress</span><span class="p">().</span><span class="n">toIpPort</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="s">&#34; is &#34;</span>
        <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">connected</span><span class="p">()</span> <span class="o">?</span> <span class="s">&#34;UP&#34;</span> <span class="o">:</span> <span class="s">&#34;DOWN&#34;</span><span class="p">);</span>
  <span class="p">}</span>
 
  <span class="kt">void</span> <span class="n">onMessage</span><span class="p">(</span><span class="k">const</span> <span class="n">TcpConnectionPtr</span><span class="o">&amp;</span> <span class="n">conn</span><span class="p">,</span> <span class="n">Buffer</span><span class="o">*</span> <span class="n">buf</span><span class="p">,</span> <span class="n">Timestamp</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">LOG_DEBUG</span> <span class="o">&lt;&lt;</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">();</span>
    <span class="n">size_t</span> <span class="n">len</span> <span class="o">=</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">readableBytes</span><span class="p">();</span>
    <span class="k">while</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;=</span> <span class="n">kCells</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">crlf</span> <span class="o">=</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">findCRLF</span><span class="p">();</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">crlf</span><span class="p">)</span>
      <span class="p">{</span>
        <span class="n">string</span> <span class="n">request</span><span class="p">(</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">peek</span><span class="p">(),</span> <span class="n">crlf</span><span class="p">);</span>
        <span class="n">buf</span><span class="o">-&gt;</span><span class="n">retrieveUntil</span><span class="p">(</span><span class="n">crlf</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>
        <span class="n">len</span> <span class="o">=</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">readableBytes</span><span class="p">();</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">processRequest</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">request</span><span class="p">))</span>
        <span class="p">{</span>
          <span class="n">conn</span><span class="o">-&gt;</span><span class="n">send</span><span class="p">(</span><span class="s">&#34;Bad Request!</span><span class="se">\r\n</span><span class="s">&#34;</span><span class="p">);</span>
          <span class="n">conn</span><span class="o">-&gt;</span><span class="n">shutdown</span><span class="p">();</span>
          <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>
      <span class="p">}</span>
      <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="mi">100</span><span class="p">)</span> <span class="c1">// id + &#34;:&#34; + kCells + &#34;\r\n&#34;
</span><span class="c1"></span>      <span class="p">{</span>
        <span class="n">conn</span><span class="o">-&gt;</span><span class="n">send</span><span class="p">(</span><span class="s">&#34;Id too long!</span><span class="se">\r\n</span><span class="s">&#34;</span><span class="p">);</span>
        <span class="n">conn</span><span class="o">-&gt;</span><span class="n">shutdown</span><span class="p">();</span>
        <span class="k">break</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">else</span>
      <span class="p">{</span>
        <span class="k">break</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
 
  <span class="kt">bool</span> <span class="n">processRequest</span><span class="p">(</span><span class="k">const</span> <span class="n">TcpConnectionPtr</span><span class="o">&amp;</span> <span class="n">conn</span><span class="p">,</span> <span class="k">const</span> <span class="n">string</span><span class="o">&amp;</span> <span class="n">request</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">string</span> <span class="n">id</span><span class="p">;</span>
    <span class="n">string</span> <span class="n">puzzle</span><span class="p">;</span>
    <span class="kt">bool</span> <span class="n">goodRequest</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
 
    <span class="n">string</span><span class="o">::</span><span class="n">const_iterator</span> <span class="n">colon</span> <span class="o">=</span> <span class="n">find</span><span class="p">(</span><span class="n">request</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span> <span class="n">request</span><span class="p">.</span><span class="n">end</span><span class="p">(),</span> <span class="sc">&#39;:&#39;</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">colon</span> <span class="o">!=</span> <span class="n">request</span><span class="p">.</span><span class="n">end</span><span class="p">())</span>
    <span class="p">{</span>
      <span class="n">id</span><span class="p">.</span><span class="n">assign</span><span class="p">(</span><span class="n">request</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span> <span class="n">colon</span><span class="p">);</span>
      <span class="n">puzzle</span><span class="p">.</span><span class="n">assign</span><span class="p">(</span><span class="n">colon</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">request</span><span class="p">.</span><span class="n">end</span><span class="p">());</span>
    <span class="p">}</span>
    <span class="k">else</span>
    <span class="p">{</span>
      <span class="n">puzzle</span> <span class="o">=</span> <span class="n">request</span><span class="p">;</span>
    <span class="p">}</span>
 
    <span class="k">if</span> <span class="p">(</span><span class="n">puzzle</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">==</span> <span class="n">implicit_cast</span><span class="o">&lt;</span><span class="n">size_t</span><span class="o">&gt;</span><span class="p">(</span><span class="n">kCells</span><span class="p">))</span>
    <span class="p">{</span>
      <span class="n">LOG_DEBUG</span> <span class="o">&lt;&lt;</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">();</span>
      <span class="n">string</span> <span class="n">result</span> <span class="o">=</span> <span class="n">solveSudoku</span><span class="p">(</span><span class="n">puzzle</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">id</span><span class="p">.</span><span class="n">empty</span><span class="p">())</span>
      <span class="p">{</span>
        <span class="n">conn</span><span class="o">-&gt;</span><span class="n">send</span><span class="p">(</span><span class="n">result</span><span class="o">+</span><span class="s">&#34;</span><span class="se">\r\n</span><span class="s">&#34;</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="k">else</span>
      <span class="p">{</span>
        <span class="n">conn</span><span class="o">-&gt;</span><span class="n">send</span><span class="p">(</span><span class="n">id</span><span class="o">+</span><span class="s">&#34;:&#34;</span><span class="o">+</span><span class="n">result</span><span class="o">+</span><span class="s">&#34;</span><span class="se">\r\n</span><span class="s">&#34;</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">else</span>
    <span class="p">{</span>
      <span class="n">goodRequest</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">goodRequest</span><span class="p">;</span>
  <span class="p">}</span>
 
  <span class="n">EventLoop</span><span class="o">*</span> <span class="n">loop_</span><span class="p">;</span>
  <span class="n">TcpServer</span> <span class="n">server_</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">numThreads_</span><span class="p">;</span>
  <span class="n">Timestamp</span> <span class="n">startTime_</span><span class="p">;</span>
<span class="p">};</span>
 
<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span><span class="o">*</span> <span class="n">argv</span><span class="p">[])</span>
<span class="p">{</span>
  <span class="n">LOG_INFO</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;pid = &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">getpid</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;, tid = &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">CurrentThread</span><span class="o">::</span><span class="n">tid</span><span class="p">();</span>
  <span class="kt">int</span> <span class="n">numThreads</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">argc</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">numThreads</span> <span class="o">=</span> <span class="n">atoi</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
  <span class="p">}</span>
  <span class="n">EventLoop</span> <span class="n">loop</span><span class="p">;</span>
  <span class="n">InetAddress</span> <span class="n">listenAddr</span><span class="p">(</span><span class="mi">9981</span><span class="p">);</span>
  <span class="n">SudokuServer</span> <span class="n">server</span><span class="p">(</span><span class="o">&amp;</span><span class="n">loop</span><span class="p">,</span> <span class="n">listenAddr</span><span class="p">,</span> <span class="n">numThreads</span><span class="p">);</span>
 
  <span class="n">server</span><span class="p">.</span><span class="n">start</span><span class="p">();</span>
 
  <span class="n">loop</span><span class="p">.</span><span class="n">loop</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div>
<h3 id="reactor-threadpool">reactor + threadPool</h3>

<ul>
<li>一个IO线程，多个计算thread的模式</li>
<li>EventLoop + threadpool + numThreads_</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-c++" data-lang="c++"><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c++" data-lang="c++"><span class="n">include</span> <span class="s">&#34;sudoku.h&#34;</span>
 
<span class="cp">#include</span> <span class="cpf">&lt;muduo/base/Atomic.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;muduo/base/Logging.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;muduo/base/Thread.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;muduo/base/ThreadPool.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;muduo/net/EventLoop.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;muduo/net/InetAddress.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;muduo/net/TcpServer.h&gt;</span><span class="cp">
</span><span class="cp"></span> 
<span class="cp">#include</span> <span class="cpf">&lt;boost/bind.hpp&gt;</span><span class="cp">
</span><span class="cp"></span> 
<span class="cp">#include</span> <span class="cpf">&lt;utility&gt;</span><span class="cp">
</span><span class="cp"></span> 
<span class="cp">#include</span> <span class="cpf">&lt;mcheck.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;unistd.h&gt;</span><span class="cp">
</span><span class="cp"></span> 
<span class="k">using</span> <span class="k">namespace</span> <span class="n">muduo</span><span class="p">;</span>
<span class="k">using</span> <span class="k">namespace</span> <span class="n">muduo</span><span class="o">::</span><span class="n">net</span><span class="p">;</span>
 
<span class="k">class</span><span class="err"> </span><span class="nc">SudokuServer</span>
<span class="p">{</span>
 <span class="k">public</span><span class="o">:</span>
  <span class="n">SudokuServer</span><span class="p">(</span><span class="n">EventLoop</span><span class="o">*</span> <span class="n">loop</span><span class="p">,</span> <span class="k">const</span> <span class="n">InetAddress</span><span class="o">&amp;</span> <span class="n">listenAddr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">numThreads</span><span class="p">)</span>
    <span class="o">:</span> <span class="n">loop_</span><span class="p">(</span><span class="n">loop</span><span class="p">),</span>
      <span class="n">server_</span><span class="p">(</span><span class="n">loop</span><span class="p">,</span> <span class="n">listenAddr</span><span class="p">,</span> <span class="s">&#34;SudokuServer&#34;</span><span class="p">),</span>
      <span class="n">numThreads_</span><span class="p">(</span><span class="n">numThreads</span><span class="p">),</span>
      <span class="n">startTime_</span><span class="p">(</span><span class="n">Timestamp</span><span class="o">::</span><span class="n">now</span><span class="p">())</span>
  <span class="p">{</span>
    <span class="n">server_</span><span class="p">.</span><span class="n">setConnectionCallback</span><span class="p">(</span>
        <span class="n">boost</span><span class="o">::</span><span class="n">bind</span><span class="p">(</span><span class="o">&amp;</span><span class="n">SudokuServer</span><span class="o">::</span><span class="n">onConnection</span><span class="p">,</span> <span class="k">this</span><span class="p">,</span> <span class="n">_1</span><span class="p">));</span>
    <span class="n">server_</span><span class="p">.</span><span class="n">setMessageCallback</span><span class="p">(</span>
        <span class="n">boost</span><span class="o">::</span><span class="n">bind</span><span class="p">(</span><span class="o">&amp;</span><span class="n">SudokuServer</span><span class="o">::</span><span class="n">onMessage</span><span class="p">,</span> <span class="k">this</span><span class="p">,</span> <span class="n">_1</span><span class="p">,</span> <span class="n">_2</span><span class="p">,</span> <span class="n">_3</span><span class="p">));</span>
  <span class="p">}</span>
 
  <span class="kt">void</span> <span class="n">start</span><span class="p">()</span>
  <span class="p">{</span>
    <span class="n">LOG_INFO</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;starting &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">numThreads_</span> <span class="o">&lt;&lt;</span> <span class="s">&#34; threads.&#34;</span><span class="p">;</span>
    <span class="n">threadPool_</span><span class="p">.</span><span class="n">start</span><span class="p">(</span><span class="n">numThreads_</span><span class="p">);</span><span class="c1">//线程池的线程个数
</span><span class="c1"></span>    <span class="n">server_</span><span class="p">.</span><span class="n">start</span><span class="p">();</span>
  <span class="p">}</span>
 
 <span class="k">private</span><span class="o">:</span>
  <span class="kt">void</span> <span class="n">onConnection</span><span class="p">(</span><span class="k">const</span> <span class="n">TcpConnectionPtr</span><span class="o">&amp;</span> <span class="n">conn</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">LOG_TRACE</span> <span class="o">&lt;&lt;</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">peerAddress</span><span class="p">().</span><span class="n">toIpPort</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="s">&#34; -&gt; &#34;</span>
        <span class="o">&lt;&lt;</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">localAddress</span><span class="p">().</span><span class="n">toIpPort</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="s">&#34; is &#34;</span>
        <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">connected</span><span class="p">()</span> <span class="o">?</span> <span class="s">&#34;UP&#34;</span> <span class="o">:</span> <span class="s">&#34;DOWN&#34;</span><span class="p">);</span>
  <span class="p">}</span>
 
  <span class="kt">void</span> <span class="n">onMessage</span><span class="p">(</span><span class="k">const</span> <span class="n">TcpConnectionPtr</span><span class="o">&amp;</span> <span class="n">conn</span><span class="p">,</span> <span class="n">Buffer</span><span class="o">*</span> <span class="n">buf</span><span class="p">,</span> <span class="n">Timestamp</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">LOG_DEBUG</span> <span class="o">&lt;&lt;</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">();</span>
    <span class="n">size_t</span> <span class="n">len</span> <span class="o">=</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">readableBytes</span><span class="p">();</span>
    <span class="k">while</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;=</span> <span class="n">kCells</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">crlf</span> <span class="o">=</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">findCRLF</span><span class="p">();</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">crlf</span><span class="p">)</span>
      <span class="p">{</span>
        <span class="n">string</span> <span class="n">request</span><span class="p">(</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">peek</span><span class="p">(),</span> <span class="n">crlf</span><span class="p">);</span>
        <span class="n">buf</span><span class="o">-&gt;</span><span class="n">retrieveUntil</span><span class="p">(</span><span class="n">crlf</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>
        <span class="n">len</span> <span class="o">=</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">readableBytes</span><span class="p">();</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">processRequest</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">request</span><span class="p">))</span>
        <span class="p">{</span>
          <span class="n">conn</span><span class="o">-&gt;</span><span class="n">send</span><span class="p">(</span><span class="s">&#34;Bad Request!</span><span class="se">\r\n</span><span class="s">&#34;</span><span class="p">);</span>
          <span class="n">conn</span><span class="o">-&gt;</span><span class="n">shutdown</span><span class="p">();</span>
          <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>
      <span class="p">}</span>
      <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="mi">100</span><span class="p">)</span> <span class="c1">// id + &#34;:&#34; + kCells + &#34;\r\n&#34;
</span><span class="c1"></span>      <span class="p">{</span>
        <span class="n">conn</span><span class="o">-&gt;</span><span class="n">send</span><span class="p">(</span><span class="s">&#34;Id too long!</span><span class="se">\r\n</span><span class="s">&#34;</span><span class="p">);</span>
        <span class="n">conn</span><span class="o">-&gt;</span><span class="n">shutdown</span><span class="p">();</span>
        <span class="k">break</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">else</span>
      <span class="p">{</span>
        <span class="k">break</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
 
  <span class="kt">bool</span> <span class="n">processRequest</span><span class="p">(</span><span class="k">const</span> <span class="n">TcpConnectionPtr</span><span class="o">&amp;</span> <span class="n">conn</span><span class="p">,</span> <span class="k">const</span> <span class="n">string</span><span class="o">&amp;</span> <span class="n">request</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">string</span> <span class="n">id</span><span class="p">;</span>
    <span class="n">string</span> <span class="n">puzzle</span><span class="p">;</span>
    <span class="kt">bool</span> <span class="n">goodRequest</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
 
    <span class="n">string</span><span class="o">::</span><span class="n">const_iterator</span> <span class="n">colon</span> <span class="o">=</span> <span class="n">find</span><span class="p">(</span><span class="n">request</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span> <span class="n">request</span><span class="p">.</span><span class="n">end</span><span class="p">(),</span> <span class="sc">&#39;:&#39;</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">colon</span> <span class="o">!=</span> <span class="n">request</span><span class="p">.</span><span class="n">end</span><span class="p">())</span>
    <span class="p">{</span>
      <span class="n">id</span><span class="p">.</span><span class="n">assign</span><span class="p">(</span><span class="n">request</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span> <span class="n">colon</span><span class="p">);</span>
      <span class="n">puzzle</span><span class="p">.</span><span class="n">assign</span><span class="p">(</span><span class="n">colon</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">request</span><span class="p">.</span><span class="n">end</span><span class="p">());</span>
    <span class="p">}</span>
    <span class="k">else</span>
    <span class="p">{</span>
      <span class="n">puzzle</span> <span class="o">=</span> <span class="n">request</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="cm">/*计算线程中的线程进行处理*/</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">puzzle</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">==</span> <span class="n">implicit_cast</span><span class="o">&lt;</span><span class="n">size_t</span><span class="o">&gt;</span><span class="p">(</span><span class="n">kCells</span><span class="p">))</span>
    <span class="p">{</span>
      <span class="n">threadPool_</span><span class="p">.</span><span class="n">run</span><span class="p">(</span><span class="n">boost</span><span class="o">::</span><span class="n">bind</span><span class="p">(</span><span class="o">&amp;</span><span class="n">solve</span><span class="p">,</span> <span class="n">conn</span><span class="p">,</span> <span class="n">puzzle</span><span class="p">,</span> <span class="n">id</span><span class="p">));</span>
    <span class="p">}</span>
    <span class="k">else</span>
    <span class="p">{</span>
      <span class="n">goodRequest</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">goodRequest</span><span class="p">;</span>
  <span class="p">}</span>
 
  <span class="k">static</span> <span class="kt">void</span> <span class="n">solve</span><span class="p">(</span><span class="k">const</span> <span class="n">TcpConnectionPtr</span><span class="o">&amp;</span> <span class="n">conn</span><span class="p">,</span>
                    <span class="k">const</span> <span class="n">string</span><span class="o">&amp;</span> <span class="n">puzzle</span><span class="p">,</span>
                    <span class="k">const</span> <span class="n">string</span><span class="o">&amp;</span> <span class="n">id</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">LOG_DEBUG</span> <span class="o">&lt;&lt;</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">();</span>
    <span class="n">string</span> <span class="n">result</span> <span class="o">=</span> <span class="n">solveSudoku</span><span class="p">(</span><span class="n">puzzle</span><span class="p">);</span>
    <span class="cm">/*这里处理完数据后，conn-&gt;send() 还是在IO线程中发送，而不是
</span><span class="cm">在计算线程中处理
</span><span class="cm">    */</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">id</span><span class="p">.</span><span class="n">empty</span><span class="p">())</span>
    <span class="p">{</span>
      <span class="n">conn</span><span class="o">-&gt;</span><span class="n">send</span><span class="p">(</span><span class="n">result</span><span class="o">+</span><span class="s">&#34;</span><span class="se">\r\n</span><span class="s">&#34;</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">else</span>
    <span class="p">{</span>
      <span class="n">conn</span><span class="o">-&gt;</span><span class="n">send</span><span class="p">(</span><span class="n">id</span><span class="o">+</span><span class="s">&#34;:&#34;</span><span class="o">+</span><span class="n">result</span><span class="o">+</span><span class="s">&#34;</span><span class="se">\r\n</span><span class="s">&#34;</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>
 
  <span class="n">EventLoop</span><span class="o">*</span> <span class="n">loop_</span><span class="p">;</span>
  <span class="n">TcpServer</span> <span class="n">server_</span><span class="p">;</span>
  <span class="n">ThreadPool</span> <span class="n">threadPool_</span><span class="p">;</span> <span class="c1">//计算线程池
</span><span class="c1"></span>  <span class="kt">int</span> <span class="n">numThreads_</span><span class="p">;</span>
  <span class="n">Timestamp</span> <span class="n">startTime_</span><span class="p">;</span>
<span class="p">};</span>
 
<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span><span class="o">*</span> <span class="n">argv</span><span class="p">[])</span>
<span class="p">{</span>
  <span class="n">LOG_INFO</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;pid = &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">getpid</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;, tid = &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">CurrentThread</span><span class="o">::</span><span class="n">tid</span><span class="p">();</span>
  <span class="kt">int</span> <span class="n">numThreads</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">argc</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">numThreads</span> <span class="o">=</span> <span class="n">atoi</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
  <span class="p">}</span>
  <span class="n">EventLoop</span> <span class="n">loop</span><span class="p">;</span>
  <span class="n">InetAddress</span> <span class="n">listenAddr</span><span class="p">(</span><span class="mi">9981</span><span class="p">);</span>
  <span class="n">SudokuServer</span> <span class="n">server</span><span class="p">(</span><span class="o">&amp;</span><span class="n">loop</span><span class="p">,</span> <span class="n">listenAddr</span><span class="p">,</span> <span class="n">numThreads</span><span class="p">);</span>
 
  <span class="n">server</span><span class="p">.</span><span class="n">start</span><span class="p">();</span>
 
  <span class="n">loop</span><span class="p">.</span><span class="n">loop</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div>
<h3 id="multiple-reactors-threadpool">multiple reactors+threadpool</h3>

<p>EventLoopThreadPoll + threadpool + IOnumThreads_ + ThreadPoolnumThreads_</p>

<p><center><img src="https://i.loli.net/2019/05/03/5ccbe0ede31a9.png" alt="" /></center></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-c++" data-lang="c++"><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c++" data-lang="c++"><span class="n">include</span> <span class="s">&#34;sudoku.h&#34;</span>
 
<span class="cp">#include</span> <span class="cpf">&lt;muduo/base/Atomic.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;muduo/base/Logging.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;muduo/base/Thread.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;muduo/base/ThreadPool.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;muduo/net/EventLoop.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;muduo/net/InetAddress.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;muduo/net/TcpServer.h&gt;</span><span class="cp">
</span><span class="cp"></span> 
<span class="cp">#include</span> <span class="cpf">&lt;boost/bind.hpp&gt;</span><span class="cp">
</span><span class="cp"></span> 
<span class="cp">#include</span> <span class="cpf">&lt;utility&gt;</span><span class="cp">
</span><span class="cp"></span> 
<span class="cp">#include</span> <span class="cpf">&lt;mcheck.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;unistd.h&gt;</span><span class="cp">
</span><span class="cp"></span> 
<span class="k">using</span> <span class="k">namespace</span> <span class="n">muduo</span><span class="p">;</span>
<span class="k">using</span> <span class="k">namespace</span> <span class="n">muduo</span><span class="o">::</span><span class="n">net</span><span class="p">;</span>
 
<span class="k">class</span><span class="err"> </span><span class="nc">SudokuServer</span>
<span class="p">{</span>
 <span class="k">public</span><span class="o">:</span>
  <span class="n">SudokuServer</span><span class="p">(</span><span class="n">EventLoop</span><span class="o">*</span> <span class="n">loop</span><span class="p">,</span> <span class="k">const</span> <span class="n">InetAddress</span><span class="o">&amp;</span> <span class="n">listenAddr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">numThreads</span><span class="p">)</span>
    <span class="o">:</span> <span class="n">loop_</span><span class="p">(</span><span class="n">loop</span><span class="p">),</span>
      <span class="n">server_</span><span class="p">(</span><span class="n">loop</span><span class="p">,</span> <span class="n">listenAddr</span><span class="p">,</span> <span class="s">&#34;SudokuServer&#34;</span><span class="p">),</span>
      <span class="n">numThreads_</span><span class="p">(</span><span class="n">numThreads</span><span class="p">),</span>
      <span class="n">startTime_</span><span class="p">(</span><span class="n">Timestamp</span><span class="o">::</span><span class="n">now</span><span class="p">())</span>
  <span class="p">{</span>
    <span class="n">server_</span><span class="p">.</span><span class="n">setConnectionCallback</span><span class="p">(</span>
        <span class="n">boost</span><span class="o">::</span><span class="n">bind</span><span class="p">(</span><span class="o">&amp;</span><span class="n">SudokuServer</span><span class="o">::</span><span class="n">onConnection</span><span class="p">,</span> <span class="k">this</span><span class="p">,</span> <span class="n">_1</span><span class="p">));</span>
    <span class="n">server_</span><span class="p">.</span><span class="n">setMessageCallback</span><span class="p">(</span>
        <span class="n">boost</span><span class="o">::</span><span class="n">bind</span><span class="p">(</span><span class="o">&amp;</span><span class="n">SudokuServer</span><span class="o">::</span><span class="n">onMessage</span><span class="p">,</span> <span class="k">this</span><span class="p">,</span> <span class="n">_1</span><span class="p">,</span> <span class="n">_2</span><span class="p">,</span> <span class="n">_3</span><span class="p">));</span>
     <span class="n">server_</span><span class="p">.</span><span class="n">setThreadNum</span><span class="p">(</span><span class="n">numThreads</span><span class="p">);</span><span class="c1">//IO线程池的初始化
</span><span class="c1"></span>  <span class="p">}</span>
 
  <span class="kt">void</span> <span class="n">start</span><span class="p">()</span>
  <span class="p">{</span>
    <span class="n">LOG_INFO</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;starting &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">numThreads_</span> <span class="o">&lt;&lt;</span> <span class="s">&#34; threads.&#34;</span><span class="p">;</span>
    <span class="n">threadPool_</span><span class="p">.</span><span class="n">start</span><span class="p">(</span><span class="n">numThreads_</span><span class="p">);</span>
    <span class="n">server_</span><span class="p">.</span><span class="n">start</span><span class="p">();</span>
  <span class="p">}</span>
 
 <span class="k">private</span><span class="o">:</span>
  <span class="kt">void</span> <span class="n">onConnection</span><span class="p">(</span><span class="k">const</span> <span class="n">TcpConnectionPtr</span><span class="o">&amp;</span> <span class="n">conn</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">LOG_TRACE</span> <span class="o">&lt;&lt;</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">peerAddress</span><span class="p">().</span><span class="n">toIpPort</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="s">&#34; -&gt; &#34;</span>
        <span class="o">&lt;&lt;</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">localAddress</span><span class="p">().</span><span class="n">toIpPort</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="s">&#34; is &#34;</span>
        <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">connected</span><span class="p">()</span> <span class="o">?</span> <span class="s">&#34;UP&#34;</span> <span class="o">:</span> <span class="s">&#34;DOWN&#34;</span><span class="p">);</span>
  <span class="p">}</span>
 
  <span class="kt">void</span> <span class="n">onMessage</span><span class="p">(</span><span class="k">const</span> <span class="n">TcpConnectionPtr</span><span class="o">&amp;</span> <span class="n">conn</span><span class="p">,</span> <span class="n">Buffer</span><span class="o">*</span> <span class="n">buf</span><span class="p">,</span> <span class="n">Timestamp</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">LOG_DEBUG</span> <span class="o">&lt;&lt;</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">();</span>
    <span class="n">size_t</span> <span class="n">len</span> <span class="o">=</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">readableBytes</span><span class="p">();</span>
    <span class="k">while</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;=</span> <span class="n">kCells</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">crlf</span> <span class="o">=</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">findCRLF</span><span class="p">();</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">crlf</span><span class="p">)</span>
      <span class="p">{</span>
        <span class="n">string</span> <span class="n">request</span><span class="p">(</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">peek</span><span class="p">(),</span> <span class="n">crlf</span><span class="p">);</span>
        <span class="n">buf</span><span class="o">-&gt;</span><span class="n">retrieveUntil</span><span class="p">(</span><span class="n">crlf</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>
        <span class="n">len</span> <span class="o">=</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">readableBytes</span><span class="p">();</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">processRequest</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">request</span><span class="p">))</span>
        <span class="p">{</span>
          <span class="n">conn</span><span class="o">-&gt;</span><span class="n">send</span><span class="p">(</span><span class="s">&#34;Bad Request!</span><span class="se">\r\n</span><span class="s">&#34;</span><span class="p">);</span>
          <span class="n">conn</span><span class="o">-&gt;</span><span class="n">shutdown</span><span class="p">();</span>
          <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>
      <span class="p">}</span>
      <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="mi">100</span><span class="p">)</span> <span class="c1">// id + &#34;:&#34; + kCells + &#34;\r\n&#34;
</span><span class="c1"></span>      <span class="p">{</span>
        <span class="n">conn</span><span class="o">-&gt;</span><span class="n">send</span><span class="p">(</span><span class="s">&#34;Id too long!</span><span class="se">\r\n</span><span class="s">&#34;</span><span class="p">);</span>
        <span class="n">conn</span><span class="o">-&gt;</span><span class="n">shutdown</span><span class="p">();</span>
        <span class="k">break</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">else</span>
      <span class="p">{</span>
        <span class="k">break</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
 
  <span class="kt">bool</span> <span class="n">processRequest</span><span class="p">(</span><span class="k">const</span> <span class="n">TcpConnectionPtr</span><span class="o">&amp;</span> <span class="n">conn</span><span class="p">,</span> <span class="k">const</span> <span class="n">string</span><span class="o">&amp;</span> <span class="n">request</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">string</span> <span class="n">id</span><span class="p">;</span>
    <span class="n">string</span> <span class="n">puzzle</span><span class="p">;</span>
    <span class="kt">bool</span> <span class="n">goodRequest</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
 
    <span class="n">string</span><span class="o">::</span><span class="n">const_iterator</span> <span class="n">colon</span> <span class="o">=</span> <span class="n">find</span><span class="p">(</span><span class="n">request</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span> <span class="n">request</span><span class="p">.</span><span class="n">end</span><span class="p">(),</span> <span class="sc">&#39;:&#39;</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">colon</span> <span class="o">!=</span> <span class="n">request</span><span class="p">.</span><span class="n">end</span><span class="p">())</span>
    <span class="p">{</span>
      <span class="n">id</span><span class="p">.</span><span class="n">assign</span><span class="p">(</span><span class="n">request</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span> <span class="n">colon</span><span class="p">);</span>
      <span class="n">puzzle</span><span class="p">.</span><span class="n">assign</span><span class="p">(</span><span class="n">colon</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">request</span><span class="p">.</span><span class="n">end</span><span class="p">());</span>
    <span class="p">}</span>
    <span class="k">else</span>
    <span class="p">{</span>
      <span class="n">puzzle</span> <span class="o">=</span> <span class="n">request</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="cm">/*计算线程中的线程进行处理*/</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">puzzle</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">==</span> <span class="n">implicit_cast</span><span class="o">&lt;</span><span class="n">size_t</span><span class="o">&gt;</span><span class="p">(</span><span class="n">kCells</span><span class="p">))</span>
    <span class="p">{</span>
      <span class="n">threadPool_</span><span class="p">.</span><span class="n">run</span><span class="p">(</span><span class="n">boost</span><span class="o">::</span><span class="n">bind</span><span class="p">(</span><span class="o">&amp;</span><span class="n">solve</span><span class="p">,</span> <span class="n">conn</span><span class="p">,</span> <span class="n">puzzle</span><span class="p">,</span> <span class="n">id</span><span class="p">));</span>
    <span class="p">}</span>
    <span class="k">else</span>
    <span class="p">{</span>
      <span class="n">goodRequest</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">goodRequest</span><span class="p">;</span>
  <span class="p">}</span>
 
  <span class="k">static</span> <span class="kt">void</span> <span class="n">solve</span><span class="p">(</span><span class="k">const</span> <span class="n">TcpConnectionPtr</span><span class="o">&amp;</span> <span class="n">conn</span><span class="p">,</span>
                    <span class="k">const</span> <span class="n">string</span><span class="o">&amp;</span> <span class="n">puzzle</span><span class="p">,</span>
                    <span class="k">const</span> <span class="n">string</span><span class="o">&amp;</span> <span class="n">id</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">LOG_DEBUG</span> <span class="o">&lt;&lt;</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">();</span>
    <span class="n">string</span> <span class="n">result</span> <span class="o">=</span> <span class="n">solveSudoku</span><span class="p">(</span><span class="n">puzzle</span><span class="p">);</span>
    <span class="cm">/*这里处理完数据后，conn-&gt;send() 还是在IO线程中发送，而不是
</span><span class="cm">在计算线程中处理
</span><span class="cm">    */</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">id</span><span class="p">.</span><span class="n">empty</span><span class="p">())</span>
    <span class="p">{</span>
      <span class="n">conn</span><span class="o">-&gt;</span><span class="n">send</span><span class="p">(</span><span class="n">result</span><span class="o">+</span><span class="s">&#34;</span><span class="se">\r\n</span><span class="s">&#34;</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">else</span>
    <span class="p">{</span>
      <span class="n">conn</span><span class="o">-&gt;</span><span class="n">send</span><span class="p">(</span><span class="n">id</span><span class="o">+</span><span class="s">&#34;:&#34;</span><span class="o">+</span><span class="n">result</span><span class="o">+</span><span class="s">&#34;</span><span class="se">\r\n</span><span class="s">&#34;</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>
 
  <span class="n">EventLoop</span><span class="o">*</span> <span class="n">loop_</span><span class="p">;</span>
  <span class="n">TcpServer</span> <span class="n">server_</span><span class="p">;</span>
  <span class="n">ThreadPool</span> <span class="n">threadPool_</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">numThreads_</span><span class="p">;</span>
  <span class="n">Timestamp</span> <span class="n">startTime_</span><span class="p">;</span>
<span class="p">};</span>
 
<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span><span class="o">*</span> <span class="n">argv</span><span class="p">[])</span>
<span class="p">{</span>
  <span class="n">LOG_INFO</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;pid = &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">getpid</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;, tid = &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">CurrentThread</span><span class="o">::</span><span class="n">tid</span><span class="p">();</span>
  <span class="kt">int</span> <span class="n">numThreads</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">argc</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">numThreads</span> <span class="o">=</span> <span class="n">atoi</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
  <span class="p">}</span>
  <span class="n">EventLoop</span> <span class="n">loop</span><span class="p">;</span>
  <span class="n">InetAddress</span> <span class="n">listenAddr</span><span class="p">(</span><span class="mi">9981</span><span class="p">);</span>
  <span class="n">SudokuServer</span> <span class="n">server</span><span class="p">(</span><span class="o">&amp;</span><span class="n">loop</span><span class="p">,</span> <span class="n">listenAddr</span><span class="p">,</span> <span class="n">numThreads</span><span class="p">);</span>
 
  <span class="n">server</span><span class="p">.</span><span class="n">start</span><span class="p">();</span>
 
  <span class="n">loop</span><span class="p">.</span><span class="n">loop</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div>
<p>sudoKu 求解服务器，既是一个IO密集型，又是一个计算密集型的服务</p>

<p>IO线程池 + 计算线程池
计算时间如果比较久，就会使得IO线程阻塞，IO线程很快就用尽，就不处理大量的并发连接
一个IO线程+计算线程池
使用muduo 库来编程还是比较容易的，有兴趣的朋友可以试一下！</p>

<h2 id="43-文件传输服务器">[43] 文件传输服务器</h2>

<ul>
<li>文件传输（MuduoManual.pdf P57）</li>
<li>examples/filetransfer/download.cc</li>
<li>examples/filetransfer/download2.cc</li>
<li>examples/filetransfer/download3.cc</li>
</ul>

<p>tests/Filetransfer_test.cc</p>

<h3 id="单线程模式之一次性发完一个文件">单线程模式之一次性发完一个文件</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-c++" data-lang="c++"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c++" data-lang="c++"><span class="cp">#include</span> <span class="cpf">&lt;muduo/base/Logging.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;muduo/net/EventLoop.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;muduo/net/TcpServer.h&gt;</span><span class="cp">
</span><span class="cp"></span> 
<span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
</span><span class="cp"></span> 
<span class="k">using</span> <span class="k">namespace</span> <span class="n">muduo</span><span class="p">;</span>
<span class="k">using</span> <span class="k">namespace</span> <span class="n">muduo</span><span class="o">::</span><span class="n">net</span><span class="p">;</span>
 
<span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">g_file</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
 
<span class="c1">// FIXME: use FileUtil::readFile()
</span><span class="c1"></span><span class="n">string</span> <span class="nf">readFile</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">filename</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">string</span> <span class="n">content</span><span class="p">;</span>
  <span class="n">FILE</span><span class="o">*</span> <span class="n">fp</span> <span class="o">=</span> <span class="o">::</span><span class="n">fopen</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s">&#34;rb&#34;</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">fp</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="c1">// inefficient!!!
</span><span class="c1"></span>    <span class="k">const</span> <span class="kt">int</span> <span class="n">kBufSize</span> <span class="o">=</span> <span class="mi">1024</span><span class="o">*</span><span class="mi">1024</span><span class="p">;</span>
    <span class="kt">char</span> <span class="n">iobuf</span><span class="p">[</span><span class="n">kBufSize</span><span class="p">];</span>
    <span class="o">::</span><span class="n">setbuffer</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="n">iobuf</span><span class="p">,</span> <span class="k">sizeof</span> <span class="n">iobuf</span><span class="p">);</span>
 
    <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="n">kBufSize</span><span class="p">];</span>
    <span class="n">size_t</span> <span class="n">nread</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">while</span> <span class="p">(</span> <span class="p">(</span><span class="n">nread</span> <span class="o">=</span> <span class="o">::</span><span class="n">fread</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="k">sizeof</span> <span class="n">buf</span><span class="p">,</span> <span class="n">fp</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">content</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">nread</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="o">::</span><span class="n">fclose</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="n">content</span><span class="p">;</span>
<span class="p">}</span>
 
<span class="kt">void</span> <span class="nf">onHighWaterMark</span><span class="p">(</span><span class="k">const</span> <span class="n">TcpConnectionPtr</span><span class="o">&amp;</span> <span class="n">conn</span><span class="p">,</span> <span class="n">size_t</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">LOG_INFO</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;HighWaterMark &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">len</span><span class="p">;</span>
<span class="p">}</span>
 
<span class="kt">void</span> <span class="nf">onConnection</span><span class="p">(</span><span class="k">const</span> <span class="n">TcpConnectionPtr</span><span class="o">&amp;</span> <span class="n">conn</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">LOG_INFO</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;FileServer - &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">peerAddress</span><span class="p">().</span><span class="n">toIpPort</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="s">&#34; -&gt; &#34;</span>
           <span class="o">&lt;&lt;</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">localAddress</span><span class="p">().</span><span class="n">toIpPort</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="s">&#34; is &#34;</span>
           <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">connected</span><span class="p">()</span> <span class="o">?</span> <span class="s">&#34;UP&#34;</span> <span class="o">:</span> <span class="s">&#34;DOWN&#34;</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">connected</span><span class="p">())</span>
  <span class="p">{</span>
    <span class="n">LOG_INFO</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;FileServer - Sending file &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">g_file</span>
             <span class="o">&lt;&lt;</span> <span class="s">&#34; to &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">peerAddress</span><span class="p">().</span><span class="n">toIpPort</span><span class="p">();</span>
    <span class="n">conn</span><span class="o">-&gt;</span><span class="n">setHighWaterMarkCallback</span><span class="p">(</span><span class="n">onHighWaterMark</span><span class="p">,</span> <span class="mi">64</span><span class="o">*</span><span class="mi">1024</span><span class="p">);</span>
    <span class="n">string</span> <span class="n">fileContent</span> <span class="o">=</span> <span class="n">readFile</span><span class="p">(</span><span class="n">g_file</span><span class="p">);</span>
    <span class="n">conn</span><span class="o">-&gt;</span><span class="n">send</span><span class="p">(</span><span class="n">fileContent</span><span class="p">);</span>
    <span class="n">conn</span><span class="o">-&gt;</span><span class="n">shutdown</span><span class="p">();</span>
    <span class="n">LOG_INFO</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;FileServer - done&#34;</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>
 
<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span><span class="o">*</span> <span class="n">argv</span><span class="p">[])</span>
<span class="p">{</span>
  <span class="n">LOG_INFO</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;pid = &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">getpid</span><span class="p">();</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">argc</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">g_file</span> <span class="o">=</span> <span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
 
    <span class="n">EventLoop</span> <span class="n">loop</span><span class="p">;</span>
    <span class="n">InetAddress</span> <span class="n">listenAddr</span><span class="p">(</span><span class="mi">2021</span><span class="p">);</span>
    <span class="n">TcpServer</span> <span class="n">server</span><span class="p">(</span><span class="o">&amp;</span><span class="n">loop</span><span class="p">,</span> <span class="n">listenAddr</span><span class="p">,</span> <span class="s">&#34;FileServer&#34;</span><span class="p">);</span>
    <span class="n">server</span><span class="p">.</span><span class="n">setConnectionCallback</span><span class="p">(</span><span class="n">onConnection</span><span class="p">);</span>
    <span class="n">server</span><span class="p">.</span><span class="n">start</span><span class="p">();</span>
    <span class="n">loop</span><span class="p">.</span><span class="n">loop</span><span class="p">();</span>
  <span class="p">}</span>
  <span class="k">else</span>
  <span class="p">{</span>
    <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&#34;Usage: %s file_for_downloading</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div>
<h3 id="单线程模型之分块发送文件">单线程模型之分块发送文件</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-c++" data-lang="c++"><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c++" data-lang="c++"><span class="cp">#include</span> <span class="cpf">&lt;muduo/base/Logging.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;muduo/net/EventLoop.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;muduo/net/TcpServer.h&gt;</span><span class="cp">
</span><span class="cp"></span> 
<span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
</span><span class="cp"></span> 
<span class="k">using</span> <span class="k">namespace</span> <span class="n">muduo</span><span class="p">;</span>
<span class="k">using</span> <span class="k">namespace</span> <span class="n">muduo</span><span class="o">::</span><span class="n">net</span><span class="p">;</span>
 
<span class="kt">void</span> <span class="nf">onHighWaterMark</span><span class="p">(</span><span class="k">const</span> <span class="n">TcpConnectionPtr</span><span class="o">&amp;</span> <span class="n">conn</span><span class="p">,</span> <span class="n">size_t</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">LOG_INFO</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;HighWaterMark &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">len</span><span class="p">;</span>
<span class="p">}</span>
 
<span class="k">const</span> <span class="kt">int</span> <span class="n">kBufSize</span> <span class="o">=</span> <span class="mi">64</span><span class="o">*</span><span class="mi">1024</span><span class="p">;</span>
<span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">g_file</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
 
<span class="kt">void</span> <span class="nf">onConnection</span><span class="p">(</span><span class="k">const</span> <span class="n">TcpConnectionPtr</span><span class="o">&amp;</span> <span class="n">conn</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">LOG_INFO</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;FileServer - &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">peerAddress</span><span class="p">().</span><span class="n">toIpPort</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="s">&#34; -&gt; &#34;</span>
           <span class="o">&lt;&lt;</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">localAddress</span><span class="p">().</span><span class="n">toIpPort</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="s">&#34; is &#34;</span>
           <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">connected</span><span class="p">()</span> <span class="o">?</span> <span class="s">&#34;UP&#34;</span> <span class="o">:</span> <span class="s">&#34;DOWN&#34;</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">connected</span><span class="p">())</span>
  <span class="p">{</span>
    <span class="n">LOG_INFO</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;FileServer - Sending file &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">g_file</span>
             <span class="o">&lt;&lt;</span> <span class="s">&#34; to &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">peerAddress</span><span class="p">().</span><span class="n">toIpPort</span><span class="p">();</span>
    <span class="cm">/*高水位标志的回调函数*/</span>
    <span class="n">conn</span><span class="o">-&gt;</span><span class="n">setHighWaterMarkCallback</span><span class="p">(</span><span class="n">onHighWaterMark</span><span class="p">,</span> <span class="n">kBufSize</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>
 
    <span class="n">FILE</span><span class="o">*</span> <span class="n">fp</span> <span class="o">=</span> <span class="o">::</span><span class="n">fopen</span><span class="p">(</span><span class="n">g_file</span><span class="p">,</span> <span class="s">&#34;rb&#34;</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">fp</span><span class="p">)</span>
    <span class="p">{</span>
    <span class="cm">/*设置conn 的上下文*/</span>
      <span class="n">conn</span><span class="o">-&gt;</span><span class="n">setContext</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
      <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="n">kBufSize</span><span class="p">];</span>
      <span class="n">size_t</span> <span class="n">nread</span> <span class="o">=</span> <span class="o">::</span><span class="n">fread</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="k">sizeof</span> <span class="n">buf</span><span class="p">,</span> <span class="n">fp</span><span class="p">);</span>
      <span class="n">conn</span><span class="o">-&gt;</span><span class="n">send</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">nread</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="cm">/*发送完毕就shutdown connection*/</span>
    <span class="k">else</span>
    <span class="p">{</span>
      <span class="n">conn</span><span class="o">-&gt;</span><span class="n">shutdown</span><span class="p">();</span>
      <span class="n">LOG_INFO</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;FileServer - no such file&#34;</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="cm">/*如果连接关闭，那么就关闭文件指针*/</span>
  <span class="k">else</span>
  <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">getContext</span><span class="p">().</span><span class="n">empty</span><span class="p">())</span>
    <span class="p">{</span>
      <span class="n">FILE</span><span class="o">*</span> <span class="n">fp</span> <span class="o">=</span> <span class="n">boost</span><span class="o">::</span><span class="n">any_cast</span><span class="o">&lt;</span><span class="n">FILE</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">getContext</span><span class="p">());</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">fp</span><span class="p">)</span>
      <span class="p">{</span>
        <span class="o">::</span><span class="n">fclose</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
 
<span class="cm">/*如果发完一块，还有其他块，那么接着发送，这只fp是保存在
</span><span class="cm"> 
</span><span class="cm">connection的上下文中，所以是同一个文件指针*/</span>
<span class="kt">void</span> <span class="nf">onWriteComplete</span><span class="p">(</span><span class="k">const</span> <span class="n">TcpConnectionPtr</span><span class="o">&amp;</span> <span class="n">conn</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">FILE</span><span class="o">*</span> <span class="n">fp</span> <span class="o">=</span> <span class="n">boost</span><span class="o">::</span><span class="n">any_cast</span><span class="o">&lt;</span><span class="n">FILE</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">getContext</span><span class="p">());</span>
  <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="n">kBufSize</span><span class="p">];</span>
  <span class="n">size_t</span> <span class="n">nread</span> <span class="o">=</span> <span class="o">::</span><span class="n">fread</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="k">sizeof</span> <span class="n">buf</span><span class="p">,</span> <span class="n">fp</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">nread</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">conn</span><span class="o">-&gt;</span><span class="n">send</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">nread</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="cm">/*如果发完也关闭掉*/</span>
  <span class="k">else</span>
  <span class="p">{</span>
    <span class="o">::</span><span class="n">fclose</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
    <span class="n">fp</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="n">conn</span><span class="o">-&gt;</span><span class="n">setContext</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
    <span class="n">conn</span><span class="o">-&gt;</span><span class="n">shutdown</span><span class="p">();</span>
    <span class="n">LOG_INFO</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;FileServer - done&#34;</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>
 
<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span><span class="o">*</span> <span class="n">argv</span><span class="p">[])</span>
<span class="p">{</span>
  <span class="n">LOG_INFO</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;pid = &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">getpid</span><span class="p">();</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">argc</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">g_file</span> <span class="o">=</span> <span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
 
    <span class="n">EventLoop</span> <span class="n">loop</span><span class="p">;</span>
    <span class="n">InetAddress</span> <span class="n">listenAddr</span><span class="p">(</span><span class="mi">2021</span><span class="p">);</span>
    <span class="n">TcpServer</span> <span class="n">server</span><span class="p">(</span><span class="o">&amp;</span><span class="n">loop</span><span class="p">,</span> <span class="n">listenAddr</span><span class="p">,</span> <span class="s">&#34;FileServer&#34;</span><span class="p">);</span>
    <span class="n">server</span><span class="p">.</span><span class="n">setConnectionCallback</span><span class="p">(</span><span class="n">onConnection</span><span class="p">);</span>
    <span class="n">server</span><span class="p">.</span><span class="n">setWriteCompleteCallback</span><span class="p">(</span><span class="n">onWriteComplete</span><span class="p">);</span>
    <span class="n">server</span><span class="p">.</span><span class="n">start</span><span class="p">();</span>
    <span class="n">loop</span><span class="p">.</span><span class="n">loop</span><span class="p">();</span>
  <span class="p">}</span>
  <span class="k">else</span>
  <span class="p">{</span>
    <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&#34;Usage: %s file_for_downloading</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div>
<h3 id="单线程模型之分块发送-智能指针">单线程模型之分块发送（智能指针）</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-c++" data-lang="c++"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span><span class="lnt">84
</span><span class="lnt">85
</span><span class="lnt">86
</span><span class="lnt">87
</span><span class="lnt">88
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c++" data-lang="c++"><span class="cp">#include</span> <span class="cpf">&lt;muduo/base/Logging.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;muduo/net/EventLoop.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;muduo/net/TcpServer.h&gt;</span><span class="cp">
</span><span class="cp"></span> 
<span class="cp">#include</span> <span class="cpf">&lt;boost/shared_ptr.hpp&gt;</span><span class="cp">
</span><span class="cp"></span> 
<span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
</span><span class="cp"></span> 
<span class="k">using</span> <span class="k">namespace</span> <span class="n">muduo</span><span class="p">;</span>
<span class="k">using</span> <span class="k">namespace</span> <span class="n">muduo</span><span class="o">::</span><span class="n">net</span><span class="p">;</span>
<span class="cm">/*这个程序和第二个是一样，只是这里的文件指针是智能共享的，
</span><span class="cm">不用我们手动关闭*/</span>
 
<span class="kt">void</span> <span class="nf">onHighWaterMark</span><span class="p">(</span><span class="k">const</span> <span class="n">TcpConnectionPtr</span><span class="o">&amp;</span> <span class="n">conn</span><span class="p">,</span> <span class="n">size_t</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">LOG_INFO</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;HighWaterMark &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">len</span><span class="p">;</span>
<span class="p">}</span>
 
<span class="k">const</span> <span class="kt">int</span> <span class="n">kBufSize</span> <span class="o">=</span> <span class="mi">64</span><span class="o">*</span><span class="mi">1024</span><span class="p">;</span>
<span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">g_file</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="k">typedef</span> <span class="n">boost</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">FILE</span><span class="o">&gt;</span> <span class="n">FilePtr</span><span class="p">;</span>
 
<span class="kt">void</span> <span class="nf">onConnection</span><span class="p">(</span><span class="k">const</span> <span class="n">TcpConnectionPtr</span><span class="o">&amp;</span> <span class="n">conn</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">LOG_INFO</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;FileServer - &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">peerAddress</span><span class="p">().</span><span class="n">toIpPort</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="s">&#34; -&gt; &#34;</span>
           <span class="o">&lt;&lt;</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">localAddress</span><span class="p">().</span><span class="n">toIpPort</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="s">&#34; is &#34;</span>
           <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">connected</span><span class="p">()</span> <span class="o">?</span> <span class="s">&#34;UP&#34;</span> <span class="o">:</span> <span class="s">&#34;DOWN&#34;</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">connected</span><span class="p">())</span>
  <span class="p">{</span>
    <span class="n">LOG_INFO</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;FileServer - Sending file &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">g_file</span>
             <span class="o">&lt;&lt;</span> <span class="s">&#34; to &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">peerAddress</span><span class="p">().</span><span class="n">toIpPort</span><span class="p">();</span>
    <span class="n">conn</span><span class="o">-&gt;</span><span class="n">setHighWaterMarkCallback</span><span class="p">(</span><span class="n">onHighWaterMark</span><span class="p">,</span> <span class="n">kBufSize</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>
 
    <span class="n">FILE</span><span class="o">*</span> <span class="n">fp</span> <span class="o">=</span> <span class="o">::</span><span class="n">fopen</span><span class="p">(</span><span class="n">g_file</span><span class="p">,</span> <span class="s">&#34;rb&#34;</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">fp</span><span class="p">)</span>
    <span class="p">{</span>
    <span class="cm">/*这里ctx接受两个参数，因为ctx不是类的指针，所以他不是调用delete
</span><span class="cm">    来消费ctx指针，而是调用fclose这个函数来消费这个ctx指针*/</span>
      <span class="n">FilePtr</span> <span class="n">ctx</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="o">::</span><span class="n">fclose</span><span class="p">);</span>
      <span class="n">conn</span><span class="o">-&gt;</span><span class="n">setContext</span><span class="p">(</span><span class="n">ctx</span><span class="p">);</span>
      <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="n">kBufSize</span><span class="p">];</span>
      <span class="n">size_t</span> <span class="n">nread</span> <span class="o">=</span> <span class="o">::</span><span class="n">fread</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="k">sizeof</span> <span class="n">buf</span><span class="p">,</span> <span class="n">fp</span><span class="p">);</span>
      <span class="n">conn</span><span class="o">-&gt;</span><span class="n">send</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">nread</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">else</span>
    <span class="p">{</span>
      <span class="n">conn</span><span class="o">-&gt;</span><span class="n">shutdown</span><span class="p">();</span>
      <span class="n">LOG_INFO</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;FileServer - no such file&#34;</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
 
<span class="kt">void</span> <span class="nf">onWriteComplete</span><span class="p">(</span><span class="k">const</span> <span class="n">TcpConnectionPtr</span><span class="o">&amp;</span> <span class="n">conn</span><span class="p">)</span>
<span class="p">{</span>
  <span class="k">const</span> <span class="n">FilePtr</span><span class="o">&amp;</span> <span class="n">fp</span> <span class="o">=</span> <span class="n">boost</span><span class="o">::</span><span class="n">any_cast</span><span class="o">&lt;</span><span class="k">const</span> <span class="n">FilePtr</span><span class="o">&amp;&gt;</span><span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">getContext</span><span class="p">());</span>
  <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="n">kBufSize</span><span class="p">];</span>
  <span class="n">size_t</span> <span class="n">nread</span> <span class="o">=</span> <span class="o">::</span><span class="n">fread</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="k">sizeof</span> <span class="n">buf</span><span class="p">,</span> <span class="n">get_pointer</span><span class="p">(</span><span class="n">fp</span><span class="p">));</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">nread</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">conn</span><span class="o">-&gt;</span><span class="n">send</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">nread</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">else</span>
  <span class="p">{</span>
    <span class="n">conn</span><span class="o">-&gt;</span><span class="n">shutdown</span><span class="p">();</span>
    <span class="n">LOG_INFO</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;FileServer - done&#34;</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>
 
<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span><span class="o">*</span> <span class="n">argv</span><span class="p">[])</span>
<span class="p">{</span>
  <span class="n">LOG_INFO</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;pid = &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">getpid</span><span class="p">();</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">argc</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">g_file</span> <span class="o">=</span> <span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
 
    <span class="n">EventLoop</span> <span class="n">loop</span><span class="p">;</span>
    <span class="n">InetAddress</span> <span class="n">listenAddr</span><span class="p">(</span><span class="mi">2021</span><span class="p">);</span>
    <span class="n">TcpServer</span> <span class="n">server</span><span class="p">(</span><span class="o">&amp;</span><span class="n">loop</span><span class="p">,</span> <span class="n">listenAddr</span><span class="p">,</span> <span class="s">&#34;FileServer&#34;</span><span class="p">);</span>
    <span class="n">server</span><span class="p">.</span><span class="n">setConnectionCallback</span><span class="p">(</span><span class="n">onConnection</span><span class="p">);</span>
    <span class="n">server</span><span class="p">.</span><span class="n">setWriteCompleteCallback</span><span class="p">(</span><span class="n">onWriteComplete</span><span class="p">);</span>
    <span class="n">server</span><span class="p">.</span><span class="n">start</span><span class="p">();</span>
    <span class="n">loop</span><span class="p">.</span><span class="n">loop</span><span class="p">();</span>
  <span class="p">}</span>
  <span class="k">else</span>
  <span class="p">{</span>
    <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&#34;Usage: %s file_for_downloading</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div>
<h2 id="44-45-muduo实现简单了聊天功能">[44-45] muduo实现简单了聊天功能</h2>

<h3 id="聊天服务器-muduomanual-pdf-p66">聊天服务器（MuduoManual.pdf P66）</h3>

<ul>
<li>examples/asio/chat/server.cc 单线程</li>
<li>examples/asio/chat/server_threaded.cc，多线程TcpServer，并用mutex来保护共享数据</li>
<li>examples/asio/chat/server_threaded_efficient.cc,借shared_ptr实现copy-on-write的手法来降低锁竞争</li>
<li>examples/asio/chat/server_threaded_highperformance.cc，采用thread local变量实现多线程高效转发</li>
</ul>

<p>消息分为包头与包体，每条消息有一个4字节的头部，以网络序存放字符串的长度。包体是一个字符串，字符串也不一定以’\0’结尾。比方说有两条消息&rdquo;hello&rdquo;和&rdquo;chenshuo&rdquo;，那么打包后的字节流是： <code>0x00,0x00,0x00,0x05, 'h','e','l','l','o',0x00,0x00,0x00,0x08,'c','h', 'e','n','s','h','u','o'</code> 共21字节。</p>

<p><center> <img src="https://i.loli.net/2019/05/03/5ccbe075e6079.png" alt="" /></center></p>

<p><code>shared_ptr</code> 指针</p>

<p>借<code>shared_ptr</code>实现<code>copy on write</code></p>

<p><code>shared_ptr</code>是引用计数智能指针，如果当前只有一个观察者，那么引用计数为<code>1</code>,可以用<code>shared_ptr::unique()</code>来判断 对于<code>write</code>端，如果发现引用计数为<code>1</code>，这时可以安全地修改对象，不必担心有人在读它。 对于<code>read</code>端，在读之前把引用计数加<code>1</code>，读完之后减<code>1</code>，这样可以保证在读的期间其引用计数大于<code>1</code>，可以阻止并发写。 比较难的是，对于<code>write</code>端，如果发现引用计数大于<code>1</code>，该如何处理?既然要更新数据，肯定要加锁，如果这时候其他线程正在读，那么不能在原来的数据上修改，得创建一个副本，在副本上修改，修改完了再替换。如果没有用户在读，那么可以直接修改。</p>

<h3 id="code-h">code.h</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-c++" data-lang="c++"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c++" data-lang="c++"><span class="cp">#ifndef MUDUO_EXAMPLES_ASIO_CHAT_CODEC_H
</span><span class="cp">#define MUDUO_EXAMPLES_ASIO_CHAT_CODEC_H
</span><span class="cp"></span> 
<span class="cp">#include</span> <span class="cpf">&lt;muduo/base/Logging.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;muduo/net/Buffer.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;muduo/net/Endian.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;muduo/net/TcpConnection.h&gt;</span><span class="cp">
</span><span class="cp"></span> 
<span class="cp">#include</span> <span class="cpf">&lt;boost/function.hpp&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;boost/noncopyable.hpp&gt;</span><span class="cp">
</span><span class="cp"></span> 
<span class="k">class</span><span class="err"> </span><span class="nc">LengthHeaderCodec</span> <span class="o">:</span> <span class="n">boost</span><span class="o">::</span><span class="n">noncopyable</span>
<span class="p">{</span>
 <span class="k">public</span><span class="o">:</span>
  <span class="k">typedef</span> <span class="n">boost</span><span class="o">::</span><span class="n">function</span><span class="o">&lt;</span><span class="kt">void</span> <span class="p">(</span><span class="k">const</span> <span class="n">muduo</span><span class="o">::</span><span class="n">net</span><span class="o">::</span><span class="n">TcpConnectionPtr</span><span class="o">&amp;</span><span class="p">,</span>
                                <span class="k">const</span> <span class="n">muduo</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span> <span class="n">message</span><span class="p">,</span>
                                <span class="n">muduo</span><span class="o">::</span><span class="n">Timestamp</span><span class="p">)</span><span class="o">&gt;</span> <span class="n">StringMessageCallback</span><span class="p">;</span>
 
  <span class="k">explicit</span> <span class="nf">LengthHeaderCodec</span><span class="p">(</span><span class="k">const</span> <span class="n">StringMessageCallback</span><span class="o">&amp;</span> <span class="n">cb</span><span class="p">)</span>
    <span class="o">:</span> <span class="n">messageCallback_</span><span class="p">(</span><span class="n">cb</span><span class="p">)</span>
  <span class="p">{</span>
  <span class="p">}</span>
<span class="cm">/*消息到达的回调函数*/</span>
  <span class="kt">void</span> <span class="nf">onMessage</span><span class="p">(</span><span class="k">const</span> <span class="n">muduo</span><span class="o">::</span><span class="n">net</span><span class="o">::</span><span class="n">TcpConnectionPtr</span><span class="o">&amp;</span> <span class="n">conn</span><span class="p">,</span>
                 <span class="n">muduo</span><span class="o">::</span><span class="n">net</span><span class="o">::</span><span class="n">Buffer</span><span class="o">*</span> <span class="n">buf</span><span class="p">,</span>
                 <span class="n">muduo</span><span class="o">::</span><span class="n">Timestamp</span> <span class="n">receiveTime</span><span class="p">)</span>
  <span class="p">{</span>
  <span class="cm">/*这里可能有多条信息一起到达*/</span>
    <span class="k">while</span> <span class="p">(</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">readableBytes</span><span class="p">()</span> <span class="o">&gt;=</span> <span class="n">kHeaderLen</span><span class="p">)</span> <span class="c1">// kHeaderLen == 4
</span><span class="c1"></span>    <span class="p">{</span>
      <span class="c1">// FIXME: use Buffer::peekInt32()
</span><span class="c1"></span>        <span class="cm">/*这里的消息包括消息头(包头)和消息尾(包体)*/</span>
      <span class="k">const</span> <span class="kt">void</span><span class="o">*</span> <span class="n">data</span> <span class="o">=</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">peek</span><span class="p">();</span> <span class="c1">//这里只是查看一下数据而已，并没有取出数据
</span><span class="c1"></span>      <span class="cm">/*读出的是对方发过来的网络字节序(大端)的前4个字节(header)*/</span>
      <span class="n">int32_t</span> <span class="n">be32</span> <span class="o">=</span> <span class="o">*</span><span class="k">static_cast</span><span class="o">&lt;</span><span class="k">const</span> <span class="n">int32_t</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">data</span><span class="p">);</span> <span class="c1">// SIGBUS
</span><span class="c1"></span>        <span class="cm">/*把网络字节转为主机字节序*/</span>
      <span class="k">const</span> <span class="n">int32_t</span> <span class="n">len</span> <span class="o">=</span> <span class="n">muduo</span><span class="o">::</span><span class="n">net</span><span class="o">::</span><span class="n">sockets</span><span class="o">::</span><span class="n">networkToHost32</span><span class="p">(</span><span class="n">be32</span><span class="p">);</span>
        <span class="cm">/*这里假设消息的包体长度不超过64k */</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="mi">65536</span> <span class="o">||</span> <span class="n">len</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="c1">//消息不合法
</span><span class="c1"></span>      <span class="p">{</span>
        <span class="n">LOG_ERROR</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;Invalid length &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">len</span><span class="p">;</span>
        <span class="n">conn</span><span class="o">-&gt;</span><span class="n">shutdown</span><span class="p">();</span>  <span class="c1">// FIXME: disable reading
</span><span class="c1"></span>        <span class="k">break</span><span class="p">;</span>
      <span class="p">}</span>
 
      <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">readableBytes</span><span class="p">()</span> <span class="o">&gt;=</span> <span class="n">len</span> <span class="o">+</span> <span class="n">kHeaderLen</span><span class="p">)</span>
      <span class="p">{</span>
        <span class="n">buf</span><span class="o">-&gt;</span><span class="n">retrieve</span><span class="p">(</span><span class="n">kHeaderLen</span><span class="p">);</span>
        <span class="cm">/*这里还没有取出消息的包体，只是peek一下*/</span>
        <span class="n">muduo</span><span class="o">::</span><span class="n">string</span> <span class="n">message</span><span class="p">(</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">peek</span><span class="p">(),</span> <span class="n">len</span><span class="p">);</span>
        <span class="cm">/*回调应用程序，让应用层来处理包体*/</span>
        <span class="n">messageCallback_</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">receiveTime</span><span class="p">);</span>
        <span class="cm">/*取出包体*/</span>
        <span class="n">buf</span><span class="o">-&gt;</span><span class="n">retrieve</span><span class="p">(</span><span class="n">len</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="cm">/*未达到完整的一条消息*/</span>
      <span class="k">else</span>
      <span class="p">{</span>
        <span class="k">break</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
 
  <span class="c1">// FIXME: TcpConnectionPtr
</span><span class="c1"></span>    <span class="cm">/*编码函数*/</span>
  <span class="kt">void</span> <span class="nf">send</span><span class="p">(</span><span class="n">muduo</span><span class="o">::</span><span class="n">net</span><span class="o">::</span><span class="n">TcpConnection</span><span class="o">*</span> <span class="n">conn</span><span class="p">,</span>
            <span class="k">const</span> <span class="n">muduo</span><span class="o">::</span><span class="n">StringPiece</span><span class="o">&amp;</span> <span class="n">message</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">muduo</span><span class="o">::</span><span class="n">net</span><span class="o">::</span><span class="n">Buffer</span> <span class="n">buf</span><span class="p">;</span>
    <span class="n">buf</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">message</span><span class="p">.</span><span class="n">data</span><span class="p">(),</span> <span class="n">message</span><span class="p">.</span><span class="n">size</span><span class="p">());</span>
    <span class="n">int32_t</span> <span class="n">len</span> <span class="o">=</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="n">int32_t</span><span class="o">&gt;</span><span class="p">(</span><span class="n">message</span><span class="p">.</span><span class="n">size</span><span class="p">());</span>
    <span class="n">int32_t</span> <span class="n">be32</span> <span class="o">=</span> <span class="n">muduo</span><span class="o">::</span><span class="n">net</span><span class="o">::</span><span class="n">sockets</span><span class="o">::</span><span class="n">hostToNetwork32</span><span class="p">(</span><span class="n">len</span><span class="p">);</span>
    <span class="n">buf</span><span class="p">.</span><span class="n">prepend</span><span class="p">(</span><span class="o">&amp;</span><span class="n">be32</span><span class="p">,</span> <span class="k">sizeof</span> <span class="n">be32</span><span class="p">);</span>
    <span class="cm">/*编完码后,发送出去*/</span>
    <span class="n">conn</span><span class="o">-&gt;</span><span class="n">send</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buf</span><span class="p">);</span>
  <span class="p">}</span>
 
 <span class="k">private</span><span class="o">:</span>
  <span class="n">StringMessageCallback</span> <span class="n">messageCallback_</span><span class="p">;</span>
  <span class="k">const</span> <span class="k">static</span> <span class="n">size_t</span> <span class="n">kHeaderLen</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">int32_t</span><span class="p">);</span>
<span class="p">};</span>
</code></pre></td></tr></table>
</div>
</div>
<h3 id="examples-asio-chat-server-cc-单线程">examples/asio/chat/server.cc 单线程</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-c++" data-lang="c++"><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c++" data-lang="c++"><span class="cp">#include</span> <span class="cpf">&#34;codec.h&#34;</span><span class="cp">
</span><span class="cp"></span> 
<span class="cp">#include</span> <span class="cpf">&lt;muduo/base/Logging.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;muduo/base/Mutex.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;muduo/net/EventLoop.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;muduo/net/TcpServer.h&gt;</span><span class="cp">
</span><span class="cp"></span> 
<span class="cp">#include</span> <span class="cpf">&lt;boost/bind.hpp&gt;</span><span class="cp">
</span><span class="cp"></span> 
<span class="cp">#include</span> <span class="cpf">&lt;set&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
</span><span class="cp"></span> 
<span class="k">using</span> <span class="k">namespace</span> <span class="n">muduo</span><span class="p">;</span>
<span class="k">using</span> <span class="k">namespace</span> <span class="n">muduo</span><span class="o">::</span><span class="n">net</span><span class="p">;</span>
<span class="cm">/*
</span><span class="cm">Program :这是一个单线程的程序，不需要mutex
</span><span class="cm"> 
</span><span class="cm">*/</span>
 
<span class="k">class</span><span class="err"> </span><span class="nc">ChatServer</span> <span class="o">:</span> <span class="n">boost</span><span class="o">::</span><span class="n">noncopyable</span>
<span class="p">{</span>
 <span class="k">public</span><span class="o">:</span>
  <span class="n">ChatServer</span><span class="p">(</span><span class="n">EventLoop</span><span class="o">*</span> <span class="n">loop</span><span class="p">,</span>
             <span class="k">const</span> <span class="n">InetAddress</span><span class="o">&amp;</span> <span class="n">listenAddr</span><span class="p">)</span>
  <span class="o">:</span> <span class="n">loop_</span><span class="p">(</span><span class="n">loop</span><span class="p">),</span>
    <span class="n">server_</span><span class="p">(</span><span class="n">loop</span><span class="p">,</span> <span class="n">listenAddr</span><span class="p">,</span> <span class="s">&#34;ChatServer&#34;</span><span class="p">),</span>
    <span class="cm">/*消息编解码初始化，邋onString錗essage()为编解码完后的回调函数*/</span>
    <span class="n">codec_</span><span class="p">(</span><span class="n">boost</span><span class="o">::</span><span class="n">bind</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ChatServer</span><span class="o">::</span><span class="n">onStringMessage</span><span class="p">,</span> <span class="k">this</span><span class="p">,</span> <span class="n">_1</span><span class="p">,</span> <span class="n">_2</span><span class="p">,</span> <span class="n">_3</span><span class="p">))</span>
  <span class="p">{</span>
    <span class="n">server_</span><span class="p">.</span><span class="n">setConnectionCallback</span><span class="p">(</span>
        <span class="n">boost</span><span class="o">::</span><span class="n">bind</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ChatServer</span><span class="o">::</span><span class="n">onConnection</span><span class="p">,</span> <span class="k">this</span><span class="p">,</span> <span class="n">_1</span><span class="p">));</span>
    <span class="cm">/*消息达到时的回调函数*/</span>
    <span class="n">server_</span><span class="p">.</span><span class="n">setMessageCallback</span><span class="p">(</span>
        <span class="n">boost</span><span class="o">::</span><span class="n">bind</span><span class="p">(</span><span class="o">&amp;</span><span class="n">LengthHeaderCodec</span><span class="o">::</span><span class="n">onMessage</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">codec_</span><span class="p">,</span> <span class="n">_1</span><span class="p">,</span> <span class="n">_2</span><span class="p">,</span> <span class="n">_3</span><span class="p">));</span>
  <span class="p">}</span>
 
  <span class="kt">void</span> <span class="n">start</span><span class="p">()</span>
  <span class="p">{</span>
    <span class="n">server_</span><span class="p">.</span><span class="n">start</span><span class="p">();</span>
  <span class="p">}</span>
 
 <span class="k">private</span><span class="o">:</span>
    <span class="cm">/*只有一个IO线程，因而这里的connection_不需要mutex保护*/</span>
    <span class="cm">/*连接到达对等方对开连接时的回调函数*/</span>
  <span class="kt">void</span> <span class="n">onConnection</span><span class="p">(</span><span class="k">const</span> <span class="n">TcpConnectionPtr</span><span class="o">&amp;</span> <span class="n">conn</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">LOG_INFO</span> <span class="o">&lt;&lt;</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">localAddress</span><span class="p">().</span><span class="n">toIpPort</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="s">&#34; -&gt; &#34;</span>
             <span class="o">&lt;&lt;</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">peerAddress</span><span class="p">().</span><span class="n">toIpPort</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="s">&#34; is &#34;</span>
             <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">connected</span><span class="p">()</span> <span class="o">?</span> <span class="s">&#34;UP&#34;</span> <span class="o">:</span> <span class="s">&#34;DOWN&#34;</span><span class="p">);</span>
    <span class="cm">/*如果已经连接了，回调*/</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">connected</span><span class="p">())</span>
    <span class="p">{</span>
      <span class="n">connections_</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="n">conn</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="cm">/*连接断开*/</span>
    <span class="k">else</span>
    <span class="p">{</span>
      <span class="n">connections_</span><span class="p">.</span><span class="n">erase</span><span class="p">(</span><span class="n">conn</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="cm">/*编解码class 的回调函数*/</span>
<span class="cm">/*转发消息给所有客户端*/</span>
  <span class="kt">void</span> <span class="n">onStringMessage</span><span class="p">(</span><span class="k">const</span> <span class="n">TcpConnectionPtr</span><span class="o">&amp;</span><span class="p">,</span>
                       <span class="k">const</span> <span class="n">string</span><span class="o">&amp;</span> <span class="n">message</span><span class="p">,</span>
                       <span class="n">Timestamp</span><span class="p">)</span>
  <span class="p">{</span>
  <span class="cm">/*只有一个IO线程，因而这里的connections_不需要mutex保护;
</span><span class="cm">    转发信息给所有客户端
</span><span class="cm">  */</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">ConnectionList</span><span class="o">::</span><span class="n">iterator</span> <span class="n">it</span> <span class="o">=</span> <span class="n">connections_</span><span class="p">.</span><span class="n">begin</span><span class="p">();</span>
        <span class="n">it</span> <span class="o">!=</span> <span class="n">connections_</span><span class="p">.</span><span class="n">end</span><span class="p">();</span>
        <span class="o">++</span><span class="n">it</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">codec_</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="n">get_pointer</span><span class="p">(</span><span class="o">*</span><span class="n">it</span><span class="p">),</span> <span class="n">message</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>
 
  <span class="k">typedef</span> <span class="n">std</span><span class="o">::</span><span class="n">set</span><span class="o">&lt;</span><span class="n">TcpConnectionPtr</span><span class="o">&gt;</span> <span class="n">ConnectionList</span><span class="p">;</span>
  <span class="n">EventLoop</span><span class="o">*</span> <span class="n">loop_</span><span class="p">;</span>
  <span class="n">TcpServer</span> <span class="n">server_</span><span class="p">;</span>
  <span class="cm">/*消息编解码class*/</span>
  <span class="n">LengthHeaderCodec</span> <span class="n">codec_</span><span class="p">;</span>
  <span class="cm">/*连接列表*/</span>
  <span class="n">ConnectionList</span> <span class="n">connections_</span><span class="p">;</span>
<span class="p">};</span>
 
<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span><span class="o">*</span> <span class="n">argv</span><span class="p">[])</span>
<span class="p">{</span>
  <span class="n">LOG_INFO</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;pid = &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">getpid</span><span class="p">();</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">argc</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">EventLoop</span> <span class="n">loop</span><span class="p">;</span>
    <span class="n">uint16_t</span> <span class="n">port</span> <span class="o">=</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="n">uint16_t</span><span class="o">&gt;</span><span class="p">(</span><span class="n">atoi</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]));</span>
    <span class="n">InetAddress</span> <span class="n">serverAddr</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
    <span class="n">ChatServer</span> <span class="n">server</span><span class="p">(</span><span class="o">&amp;</span><span class="n">loop</span><span class="p">,</span> <span class="n">serverAddr</span><span class="p">);</span>
    <span class="n">server</span><span class="p">.</span><span class="n">start</span><span class="p">();</span>
    <span class="n">loop</span><span class="p">.</span><span class="n">loop</span><span class="p">();</span>
  <span class="p">}</span>
  <span class="k">else</span>
  <span class="p">{</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;Usage: %s port</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div>
<h3 id="examples-asio-chat-server-threaded-cc-多线程tcpserver-并用mutex来保护共享数据">examples/asio/chat/server_threaded.cc，多线程TcpServer，并用mutex来保护共享数据</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-c++" data-lang="c++"><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c++" data-lang="c++"><span class="cp">#include</span> <span class="cpf">&#34;codec.h&#34;</span><span class="cp">
</span><span class="cp"></span> 
<span class="cp">#include</span> <span class="cpf">&lt;muduo/base/Logging.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;muduo/base/Mutex.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;muduo/net/EventLoop.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;muduo/net/TcpServer.h&gt;</span><span class="cp">
</span><span class="cp"></span> 
<span class="cp">#include</span> <span class="cpf">&lt;boost/bind.hpp&gt;</span><span class="cp">
</span><span class="cp"></span> 
<span class="cp">#include</span> <span class="cpf">&lt;set&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
</span><span class="cp"></span> 
<span class="k">using</span> <span class="k">namespace</span> <span class="n">muduo</span><span class="p">;</span>
<span class="k">using</span> <span class="k">namespace</span> <span class="n">muduo</span><span class="o">::</span><span class="n">net</span><span class="p">;</span>
<span class="cm">/*这是一个典型的多线程聊天程序,multipleReactor 模型*/</span>
 
<span class="k">class</span><span class="err"> </span><span class="nc">ChatServer</span> <span class="o">:</span> <span class="n">boost</span><span class="o">::</span><span class="n">noncopyable</span>
<span class="p">{</span>
 <span class="k">public</span><span class="o">:</span>
  <span class="n">ChatServer</span><span class="p">(</span><span class="n">EventLoop</span><span class="o">*</span> <span class="n">loop</span><span class="p">,</span>
             <span class="k">const</span> <span class="n">InetAddress</span><span class="o">&amp;</span> <span class="n">listenAddr</span><span class="p">)</span>
  <span class="o">:</span> <span class="n">loop_</span><span class="p">(</span><span class="n">loop</span><span class="p">),</span>
    <span class="n">server_</span><span class="p">(</span><span class="n">loop</span><span class="p">,</span> <span class="n">listenAddr</span><span class="p">,</span> <span class="s">&#34;ChatServer&#34;</span><span class="p">),</span>
    <span class="n">codec_</span><span class="p">(</span><span class="n">boost</span><span class="o">::</span><span class="n">bind</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ChatServer</span><span class="o">::</span><span class="n">onStringMessage</span><span class="p">,</span> <span class="k">this</span><span class="p">,</span> <span class="n">_1</span><span class="p">,</span> <span class="n">_2</span><span class="p">,</span> <span class="n">_3</span><span class="p">))</span>
  <span class="p">{</span>
    <span class="n">server_</span><span class="p">.</span><span class="n">setConnectionCallback</span><span class="p">(</span>
        <span class="n">boost</span><span class="o">::</span><span class="n">bind</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ChatServer</span><span class="o">::</span><span class="n">onConnection</span><span class="p">,</span> <span class="k">this</span><span class="p">,</span> <span class="n">_1</span><span class="p">));</span>
    <span class="n">server_</span><span class="p">.</span><span class="n">setMessageCallback</span><span class="p">(</span>
        <span class="n">boost</span><span class="o">::</span><span class="n">bind</span><span class="p">(</span><span class="o">&amp;</span><span class="n">LengthHeaderCodec</span><span class="o">::</span><span class="n">onMessage</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">codec_</span><span class="p">,</span> <span class="n">_1</span><span class="p">,</span> <span class="n">_2</span><span class="p">,</span> <span class="n">_3</span><span class="p">));</span>
  <span class="p">}</span>
 
  <span class="kt">void</span> <span class="n">setThreadNum</span><span class="p">(</span><span class="kt">int</span> <span class="n">numThreads</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">server_</span><span class="p">.</span><span class="n">setThreadNum</span><span class="p">(</span><span class="n">numThreads</span><span class="p">);</span>
  <span class="p">}</span>
 
  <span class="kt">void</span> <span class="n">start</span><span class="p">()</span>
  <span class="p">{</span>
    <span class="n">server_</span><span class="p">.</span><span class="n">start</span><span class="p">();</span>
  <span class="p">}</span>
 
 <span class="k">private</span><span class="o">:</span>
  <span class="kt">void</span> <span class="n">onConnection</span><span class="p">(</span><span class="k">const</span> <span class="n">TcpConnectionPtr</span><span class="o">&amp;</span> <span class="n">conn</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">LOG_INFO</span> <span class="o">&lt;&lt;</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">localAddress</span><span class="p">().</span><span class="n">toIpPort</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="s">&#34; -&gt; &#34;</span>
        <span class="o">&lt;&lt;</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">peerAddress</span><span class="p">().</span><span class="n">toIpPort</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="s">&#34; is &#34;</span>
        <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">connected</span><span class="p">()</span> <span class="o">?</span> <span class="s">&#34;UP&#34;</span> <span class="o">:</span> <span class="s">&#34;DOWN&#34;</span><span class="p">);</span>
 
    <span class="n">MutexLockGuard</span> <span class="nf">lock</span><span class="p">(</span><span class="n">mutex_</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">connected</span><span class="p">())</span>
    <span class="p">{</span>
      <span class="n">connections_</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="n">conn</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">else</span>
    <span class="p">{</span>
      <span class="n">connections_</span><span class="p">.</span><span class="n">erase</span><span class="p">(</span><span class="n">conn</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>
 
  <span class="kt">void</span> <span class="n">onStringMessage</span><span class="p">(</span><span class="k">const</span> <span class="n">TcpConnectionPtr</span><span class="o">&amp;</span><span class="p">,</span>
                       <span class="k">const</span> <span class="n">string</span><span class="o">&amp;</span> <span class="n">message</span><span class="p">,</span>
                       <span class="n">Timestamp</span><span class="p">)</span>
  <span class="p">{</span>
  <span class="cm">/*多线程需要保护连接列表*/</span>
    <span class="n">MutexLockGuard</span> <span class="n">lock</span><span class="p">(</span><span class="n">mutex_</span><span class="p">);</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">ConnectionList</span><span class="o">::</span><span class="n">iterator</span> <span class="n">it</span> <span class="o">=</span> <span class="n">connections_</span><span class="p">.</span><span class="n">begin</span><span class="p">();</span>
        <span class="n">it</span> <span class="o">!=</span> <span class="n">connections_</span><span class="p">.</span><span class="n">end</span><span class="p">();</span>
        <span class="o">++</span><span class="n">it</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">codec_</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="n">get_pointer</span><span class="p">(</span><span class="o">*</span><span class="n">it</span><span class="p">),</span> <span class="n">message</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>
 
  <span class="k">typedef</span> <span class="n">std</span><span class="o">::</span><span class="n">set</span><span class="o">&lt;</span><span class="n">TcpConnectionPtr</span><span class="o">&gt;</span> <span class="n">ConnectionList</span><span class="p">;</span>
  <span class="n">EventLoop</span><span class="o">*</span> <span class="n">loop_</span><span class="p">;</span>
  <span class="n">TcpServer</span> <span class="n">server_</span><span class="p">;</span>
  <span class="n">LengthHeaderCodec</span> <span class="n">codec_</span><span class="p">;</span>
  <span class="n">MutexLock</span> <span class="n">mutex_</span><span class="p">;</span>
  <span class="n">ConnectionList</span> <span class="n">connections_</span><span class="p">;</span>
<span class="p">};</span>
 
<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span><span class="o">*</span> <span class="n">argv</span><span class="p">[])</span>
<span class="p">{</span>
  <span class="n">LOG_INFO</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;pid = &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">getpid</span><span class="p">();</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">argc</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">EventLoop</span> <span class="n">loop</span><span class="p">;</span>
    <span class="n">uint16_t</span> <span class="n">port</span> <span class="o">=</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="n">uint16_t</span><span class="o">&gt;</span><span class="p">(</span><span class="n">atoi</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]));</span>
    <span class="n">InetAddress</span> <span class="n">serverAddr</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
    <span class="n">ChatServer</span> <span class="n">server</span><span class="p">(</span><span class="o">&amp;</span><span class="n">loop</span><span class="p">,</span> <span class="n">serverAddr</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">argc</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">server</span><span class="p">.</span><span class="n">setThreadNum</span><span class="p">(</span><span class="n">atoi</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">]));</span>
    <span class="p">}</span>
    <span class="n">server</span><span class="p">.</span><span class="n">start</span><span class="p">();</span>
    <span class="n">loop</span><span class="p">.</span><span class="n">loop</span><span class="p">();</span>
  <span class="p">}</span>
  <span class="k">else</span>
  <span class="p">{</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;Usage: %s port [thread_num]</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div>
<h3 id="examples-asio-chat-server-threaded-efficient-cc-借shared-ptr实现copy-on-write的手法来降低锁竞争">examples/asio/chat/server_threaded_efficient.cc,借shared_ptr实现copy-on-write的手法来降低锁竞争</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-c++" data-lang="c++"><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c++" data-lang="c++"><span class="cp">#include</span> <span class="cpf">&#34;codec.h&#34;</span><span class="cp">
</span><span class="cp"></span> 
<span class="cp">#include</span> <span class="cpf">&lt;muduo/base/Logging.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;muduo/base/Mutex.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;muduo/net/EventLoop.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;muduo/net/TcpServer.h&gt;</span><span class="cp">
</span><span class="cp"></span> 
<span class="cp">#include</span> <span class="cpf">&lt;boost/bind.hpp&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;boost/shared_ptr.hpp&gt;</span><span class="cp">
</span><span class="cp"></span> 
<span class="cp">#include</span> <span class="cpf">&lt;set&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
</span><span class="cp"></span> 
<span class="k">using</span> <span class="k">namespace</span> <span class="n">muduo</span><span class="p">;</span>
<span class="k">using</span> <span class="k">namespace</span> <span class="n">muduo</span><span class="o">::</span><span class="n">net</span><span class="p">;</span>
<span class="cm">/*这是一个典型的多线程聊天程序multipleReactor 模型，
</span><span class="cm">但是这里使用了一些编程技巧，达到一些优化*/</span>
 
<span class="k">class</span><span class="err"> </span><span class="nc">ChatServer</span> <span class="o">:</span> <span class="n">boost</span><span class="o">::</span><span class="n">noncopyable</span>
<span class="p">{</span>
 <span class="k">public</span><span class="o">:</span>
  <span class="n">ChatServer</span><span class="p">(</span><span class="n">EventLoop</span><span class="o">*</span> <span class="n">loop</span><span class="p">,</span>
             <span class="k">const</span> <span class="n">InetAddress</span><span class="o">&amp;</span> <span class="n">listenAddr</span><span class="p">)</span>
  <span class="o">:</span> <span class="n">loop_</span><span class="p">(</span><span class="n">loop</span><span class="p">),</span>
    <span class="n">server_</span><span class="p">(</span><span class="n">loop</span><span class="p">,</span> <span class="n">listenAddr</span><span class="p">,</span> <span class="s">&#34;ChatServer&#34;</span><span class="p">),</span><span class="c1">//loop : acceptor loop
</span><span class="c1"></span>    <span class="n">codec_</span><span class="p">(</span><span class="n">boost</span><span class="o">::</span><span class="n">bind</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ChatServer</span><span class="o">::</span><span class="n">onStringMessage</span><span class="p">,</span> <span class="k">this</span><span class="p">,</span> <span class="n">_1</span><span class="p">,</span> <span class="n">_2</span><span class="p">,</span> <span class="n">_3</span><span class="p">)),</span>
    <span class="n">connections_</span><span class="p">(</span><span class="k">new</span> <span class="n">ConnectionList</span><span class="p">)</span><span class="c1">//初始化时，share_ptr的引用为1
</span><span class="c1"></span>  <span class="p">{</span>
    <span class="n">server_</span><span class="p">.</span><span class="n">setConnectionCallback</span><span class="p">(</span>
        <span class="n">boost</span><span class="o">::</span><span class="n">bind</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ChatServer</span><span class="o">::</span><span class="n">onConnection</span><span class="p">,</span> <span class="k">this</span><span class="p">,</span> <span class="n">_1</span><span class="p">));</span>
    <span class="n">server_</span><span class="p">.</span><span class="n">setMessageCallback</span><span class="p">(</span>
        <span class="n">boost</span><span class="o">::</span><span class="n">bind</span><span class="p">(</span><span class="o">&amp;</span><span class="n">LengthHeaderCodec</span><span class="o">::</span><span class="n">onMessage</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">codec_</span><span class="p">,</span> <span class="n">_1</span><span class="p">,</span> <span class="n">_2</span><span class="p">,</span> <span class="n">_3</span><span class="p">));</span>
  <span class="p">}</span>
 
  <span class="kt">void</span> <span class="n">setThreadNum</span><span class="p">(</span><span class="kt">int</span> <span class="n">numThreads</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">server_</span><span class="p">.</span><span class="n">setThreadNum</span><span class="p">(</span><span class="n">numThreads</span><span class="p">);</span>
  <span class="p">}</span>
 
  <span class="kt">void</span> <span class="n">start</span><span class="p">()</span>
  <span class="p">{</span>
    <span class="n">server_</span><span class="p">.</span><span class="n">start</span><span class="p">();</span>
  <span class="p">}</span>
 
 <span class="k">private</span><span class="o">:</span>
  <span class="kt">void</span> <span class="n">onConnection</span><span class="p">(</span><span class="k">const</span> <span class="n">TcpConnectionPtr</span><span class="o">&amp;</span> <span class="n">conn</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">LOG_INFO</span> <span class="o">&lt;&lt;</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">localAddress</span><span class="p">().</span><span class="n">toIpPort</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="s">&#34; -&gt; &#34;</span>
        <span class="o">&lt;&lt;</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">peerAddress</span><span class="p">().</span><span class="n">toIpPort</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="s">&#34; is &#34;</span>
        <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">connected</span><span class="p">()</span> <span class="o">?</span> <span class="s">&#34;UP&#34;</span> <span class="o">:</span> <span class="s">&#34;DOWN&#34;</span><span class="p">);</span>
 
    <span class="n">MutexLockGuard</span> <span class="nf">lock</span><span class="p">(</span><span class="n">mutex_</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">connections_</span><span class="p">.</span><span class="n">unique</span><span class="p">())</span><span class="c1">//说明引用计数大于1
</span><span class="c1"></span>    <span class="p">{</span><span class="c1">//new ConnectionList(*connections_) 这段代码拷贝了一份ConnectionList
</span><span class="c1"></span>    <span class="c1">//connections_原来的引用计数减1，而connections_现在的引用计数
</span><span class="c1"></span>    <span class="c1">// 等于1
</span><span class="c1"></span>      <span class="n">connections_</span><span class="p">.</span><span class="n">reset</span><span class="p">(</span><span class="k">new</span> <span class="n">ConnectionList</span><span class="p">(</span><span class="o">*</span><span class="n">connections_</span><span class="p">));</span>
    <span class="p">}</span>
    <span class="c1">//所以这里断言才会成功
</span><span class="c1"></span>    <span class="n">assert</span><span class="p">(</span><span class="n">connections_</span><span class="p">.</span><span class="n">unique</span><span class="p">());</span>
    <span class="cm">/*在复本上修改,不会影响读者,所以读者在遍历列表的时候,
</span><span class="cm">    不需要mutex保护*/</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">connected</span><span class="p">())</span>
    <span class="p">{</span>
      <span class="n">connections_</span><span class="o">-&gt;</span><span class="n">insert</span><span class="p">(</span><span class="n">conn</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">else</span>
    <span class="p">{</span>
      <span class="n">connections_</span><span class="o">-&gt;</span><span class="n">erase</span><span class="p">(</span><span class="n">conn</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>
 
  <span class="k">typedef</span> <span class="n">std</span><span class="o">::</span><span class="n">set</span><span class="o">&lt;</span><span class="n">TcpConnectionPtr</span><span class="o">&gt;</span> <span class="n">ConnectionList</span><span class="p">;</span>
  <span class="k">typedef</span> <span class="n">boost</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">ConnectionList</span><span class="o">&gt;</span> <span class="n">ConnectionListPtr</span><span class="p">;</span>
<span class="cm">/*读操作*/</span>
  <span class="kt">void</span> <span class="nf">onStringMessage</span><span class="p">(</span><span class="k">const</span> <span class="n">TcpConnectionPtr</span><span class="o">&amp;</span><span class="p">,</span>
                       <span class="k">const</span> <span class="n">string</span><span class="o">&amp;</span> <span class="n">message</span><span class="p">,</span>
                       <span class="n">Timestamp</span><span class="p">)</span>
  <span class="p">{</span>
  <span class="cm">/*引用计数加1，mutex保护的临时区大大缩短*/</span>
    <span class="n">ConnectionListPtr</span> <span class="n">connections</span> <span class="o">=</span> <span class="n">getConnectionList</span><span class="p">();;</span><span class="c1">//栈上变量
</span><span class="c1"></span>  <span class="cm">/*可能大家会有疑问，不受mutex保护，写者更改了连接列表怎么办�*
</span><span class="cm">    实际上，写者是在另一个副本上修改，所以无需担心*/</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">ConnectionList</span><span class="o">::</span><span class="n">iterator</span> <span class="n">it</span> <span class="o">=</span> <span class="n">connections</span><span class="o">-&gt;</span><span class="n">begin</span><span class="p">();</span>
        <span class="n">it</span> <span class="o">!=</span> <span class="n">connections</span><span class="o">-&gt;</span><span class="n">end</span><span class="p">();</span>
        <span class="o">++</span><span class="n">it</span><span class="p">)</span>
    <span class="p">{</span>
    <span class="cm">/*这里也是无法减少第一个和第二个连接发送所需的时间,
</span><span class="cm">    因为他们都是在同步发送的，就是所要等到转发完一条消息到
</span><span class="cm">    一个connection后,然后才能转发下一个连接connection.
</span><span class="cm">    实质就是调用这个函数的IO负责转发*/</span>
      <span class="n">codec_</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="n">get_pointer</span><span class="p">(</span><span class="o">*</span><span class="n">it</span><span class="p">),</span> <span class="n">message</span><span class="p">);</span>
    <span class="p">}</span>
        <span class="cm">/*这个断言不一定成立
</span><span class="cm">        assert(!connections.uniquer())。
</span><span class="cm">        这是由于Onconnection()----&gt;connections_.reset(new ConnectionList(*connections_));*/</span>
        <span class="cm">/*当connection这个栈上的变量销毁的时候，引用计数减1*/</span>
  <span class="p">}</span>
 
  <span class="n">ConnectionListPtr</span> <span class="nf">getConnectionList</span><span class="p">()</span>
  <span class="p">{</span>
  <span class="cm">/*保护区域变小了&lt;&gt;*/</span>
    <span class="n">MutexLockGuard</span> <span class="n">lock</span><span class="p">(</span><span class="n">mutex_</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">connections_</span><span class="p">;</span>
  <span class="p">}</span>
 
  <span class="n">EventLoop</span><span class="o">*</span> <span class="n">loop_</span><span class="p">;</span>
  <span class="n">TcpServer</span> <span class="n">server_</span><span class="p">;</span> <span class="cm">/*tcpserver服务器*/</span>
  <span class="n">LengthHeaderCodec</span> <span class="n">codec_</span><span class="p">;</span>
  <span class="n">MutexLock</span> <span class="n">mutex_</span><span class="p">;</span>
  <span class="n">ConnectionListPtr</span> <span class="n">connections_</span><span class="p">;</span>
<span class="p">};</span>
 
<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span><span class="o">*</span> <span class="n">argv</span><span class="p">[])</span>
<span class="p">{</span>
  <span class="n">LOG_INFO</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;pid = &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">getpid</span><span class="p">();</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">argc</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">EventLoop</span> <span class="n">loop</span><span class="p">;</span>
    <span class="n">uint16_t</span> <span class="n">port</span> <span class="o">=</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="n">uint16_t</span><span class="o">&gt;</span><span class="p">(</span><span class="n">atoi</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]));</span>
    <span class="n">InetAddress</span> <span class="n">serverAddr</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
    <span class="n">ChatServer</span> <span class="n">server</span><span class="p">(</span><span class="o">&amp;</span><span class="n">loop</span><span class="p">,</span> <span class="n">serverAddr</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">argc</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)</span>
    <span class="p">{</span>
    <span class="cm">/*IO线程个数*/</span>
      <span class="n">server</span><span class="p">.</span><span class="n">setThreadNum</span><span class="p">(</span><span class="n">atoi</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">]));</span>
    <span class="p">}</span>
    <span class="n">server</span><span class="p">.</span><span class="n">start</span><span class="p">();</span>
    <span class="n">loop</span><span class="p">.</span><span class="n">loop</span><span class="p">();</span>
  <span class="p">}</span>
  <span class="k">else</span>
  <span class="p">{</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;Usage: %s port [thread_num]</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div>
<h3 id="examples-asio-chat-server-threaded-highperformance-cc-采用thread-local变量实现多线程高效转发">examples/asio/chat/server_threaded_highperformance.cc，采用thread local变量实现多线程高效转发</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-c++" data-lang="c++"><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c++" data-lang="c++"><span class="cp">#include</span> <span class="cpf">&#34;codec.h&#34;</span><span class="cp">
</span><span class="cp"></span> 
<span class="cp">#include</span> <span class="cpf">&lt;muduo/base/Logging.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;muduo/base/Mutex.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;muduo/base/ThreadLocalSingleton.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;muduo/net/EventLoop.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;muduo/net/TcpServer.h&gt;</span><span class="cp">
</span><span class="cp"></span> 
<span class="cp">#include</span> <span class="cpf">&lt;boost/bind.hpp&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;boost/shared_ptr.hpp&gt;</span><span class="cp">
</span><span class="cp"></span> 
<span class="cp">#include</span> <span class="cpf">&lt;set&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
</span><span class="cp"></span> 
<span class="k">using</span> <span class="k">namespace</span> <span class="n">muduo</span><span class="p">;</span>
<span class="k">using</span> <span class="k">namespace</span> <span class="n">muduo</span><span class="o">::</span><span class="n">net</span><span class="p">;</span>
<span class="cm">/*这个主要是针对第二个进行改正的，*/</span>
<span class="k">class</span><span class="err"> </span><span class="nc">ChatServer</span> <span class="o">:</span> <span class="n">boost</span><span class="o">::</span><span class="n">noncopyable</span>
<span class="p">{</span>
 <span class="k">public</span><span class="o">:</span>
  <span class="n">ChatServer</span><span class="p">(</span><span class="n">EventLoop</span><span class="o">*</span> <span class="n">loop</span><span class="p">,</span>
             <span class="k">const</span> <span class="n">InetAddress</span><span class="o">&amp;</span> <span class="n">listenAddr</span><span class="p">)</span>
  <span class="o">:</span> <span class="n">loop_</span><span class="p">(</span><span class="n">loop</span><span class="p">),</span>
    <span class="n">server_</span><span class="p">(</span><span class="n">loop</span><span class="p">,</span> <span class="n">listenAddr</span><span class="p">,</span> <span class="s">&#34;ChatServer&#34;</span><span class="p">),</span>
    <span class="n">codec_</span><span class="p">(</span><span class="n">boost</span><span class="o">::</span><span class="n">bind</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ChatServer</span><span class="o">::</span><span class="n">onStringMessage</span><span class="p">,</span> <span class="k">this</span><span class="p">,</span> <span class="n">_1</span><span class="p">,</span> <span class="n">_2</span><span class="p">,</span> <span class="n">_3</span><span class="p">))</span>
  <span class="p">{</span>
    <span class="n">server_</span><span class="p">.</span><span class="n">setConnectionCallback</span><span class="p">(</span>
        <span class="n">boost</span><span class="o">::</span><span class="n">bind</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ChatServer</span><span class="o">::</span><span class="n">onConnection</span><span class="p">,</span> <span class="k">this</span><span class="p">,</span> <span class="n">_1</span><span class="p">));</span>
    <span class="n">server_</span><span class="p">.</span><span class="n">setMessageCallback</span><span class="p">(</span>
        <span class="n">boost</span><span class="o">::</span><span class="n">bind</span><span class="p">(</span><span class="o">&amp;</span><span class="n">LengthHeaderCodec</span><span class="o">::</span><span class="n">onMessage</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">codec_</span><span class="p">,</span> <span class="n">_1</span><span class="p">,</span> <span class="n">_2</span><span class="p">,</span> <span class="n">_3</span><span class="p">));</span>
  <span class="p">}</span>
 
  <span class="kt">void</span> <span class="n">setThreadNum</span><span class="p">(</span><span class="kt">int</span> <span class="n">numThreads</span><span class="p">)</span>
  <span class="p">{</span>
  <span class="cm">/*设置sub IO线程池的大小*/</span>
    <span class="n">server_</span><span class="p">.</span><span class="n">setThreadNum</span><span class="p">(</span><span class="n">numThreads</span><span class="p">);</span>
  <span class="p">}</span>
 
  <span class="kt">void</span> <span class="n">start</span><span class="p">()</span>
  <span class="p">{</span><span class="cm">/*设置线程的初始化函数*/</span>
    <span class="n">server_</span><span class="p">.</span><span class="n">setThreadInitCallback</span><span class="p">(</span><span class="n">boost</span><span class="o">::</span><span class="n">bind</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ChatServer</span><span class="o">::</span><span class="n">threadInit</span><span class="p">,</span> <span class="k">this</span><span class="p">,</span> <span class="n">_1</span><span class="p">));</span>
    <span class="n">server_</span><span class="p">.</span><span class="n">start</span><span class="p">();</span>
  <span class="p">}</span>
 
 <span class="k">private</span><span class="o">:</span>
  <span class="kt">void</span> <span class="n">onConnection</span><span class="p">(</span><span class="k">const</span> <span class="n">TcpConnectionPtr</span><span class="o">&amp;</span> <span class="n">conn</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">LOG_INFO</span> <span class="o">&lt;&lt;</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">localAddress</span><span class="p">().</span><span class="n">toIpPort</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="s">&#34; -&gt; &#34;</span>
             <span class="o">&lt;&lt;</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">peerAddress</span><span class="p">().</span><span class="n">toIpPort</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="s">&#34; is &#34;</span>
             <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">connected</span><span class="p">()</span> <span class="o">?</span> <span class="s">&#34;UP&#34;</span> <span class="o">:</span> <span class="s">&#34;DOWN&#34;</span><span class="p">);</span>
 
    <span class="k">if</span> <span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">connected</span><span class="p">())</span>
    <span class="p">{</span>
      <span class="n">connections_</span><span class="p">.</span><span class="n">instance</span><span class="p">().</span><span class="n">insert</span><span class="p">(</span><span class="n">conn</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">else</span>
    <span class="p">{</span>
      <span class="n">connections_</span><span class="p">.</span><span class="n">instance</span><span class="p">().</span><span class="n">erase</span><span class="p">(</span><span class="n">conn</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">cout</span><span class="o">&lt;&lt;</span><span class="s">&#34;connection adress :&#34;</span><span class="o">&lt;&lt;&amp;</span><span class="n">connections_</span><span class="o">&lt;&lt;</span><span class="s">&#34;</span><span class="se">\t</span><span class="s">&#34;</span><span class="o">&lt;&lt;</span><span class="s">&#34;connection size :&#34;</span><span class="o">&lt;&lt;</span><span class="n">connections_</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="p">;</span>
  <span class="p">}</span>
 
  <span class="kt">void</span> <span class="n">onStringMessage</span><span class="p">(</span><span class="k">const</span> <span class="n">TcpConnectionPtr</span><span class="o">&amp;</span><span class="p">,</span>
                       <span class="k">const</span> <span class="n">string</span><span class="o">&amp;</span> <span class="n">message</span><span class="p">,</span>
                       <span class="n">Timestamp</span><span class="p">)</span>
  <span class="p">{</span>
  <span class="cm">/*把消息&#34;转发&#34;作为IO线程的任务来处理*/</span>
    <span class="n">EventLoop</span><span class="o">::</span><span class="n">Functor</span> <span class="n">f</span> <span class="o">=</span> <span class="n">boost</span><span class="o">::</span><span class="n">bind</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ChatServer</span><span class="o">::</span><span class="n">distributeMessage</span><span class="p">,</span> <span class="k">this</span><span class="p">,</span> <span class="n">message</span><span class="p">);</span>
    <span class="n">LOG_DEBUG</span><span class="p">;</span>
    <span class="cm">/*转发消息给所有客户端，高效率(多线程来转发),转发到不同的IO线程,
</span><span class="cm"> 
</span><span class="cm">    */</span>
    <span class="n">MutexLockGuard</span> <span class="nf">lock</span><span class="p">(</span><span class="n">mutex_</span><span class="p">);</span>
    <span class="cm">/*for 循环和f达到异步进行*/</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">set</span><span class="o">&lt;</span><span class="n">EventLoop</span><span class="o">*&gt;::</span><span class="n">iterator</span> <span class="n">it</span> <span class="o">=</span> <span class="n">loops_</span><span class="p">.</span><span class="n">begin</span><span class="p">();</span>
        <span class="n">it</span> <span class="o">!=</span> <span class="n">loops_</span><span class="p">.</span><span class="n">end</span><span class="p">();</span>
        <span class="o">++</span><span class="n">it</span><span class="p">)</span>
    <span class="p">{</span><span class="cm">/*
</span><span class="cm">    1.让对应的IO线程来执行distributeMessage
</span><span class="cm">    2.distributeMessage放到IO线程队列中执行，因此，这里的mutex_锁竞争大大减小
</span><span class="cm">    3.distributeMesssge 不受mutex_保护
</span><span class="cm">            */</span>
      <span class="p">(</span><span class="o">*</span><span class="n">it</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">queueInLoop</span><span class="p">(</span><span class="n">f</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">LOG_DEBUG</span><span class="p">;</span>
  <span class="p">}</span>
 
  <span class="k">typedef</span> <span class="n">std</span><span class="o">::</span><span class="n">set</span><span class="o">&lt;</span><span class="n">TcpConnectionPtr</span><span class="o">&gt;</span> <span class="n">ConnectionList</span><span class="p">;</span>
 
  <span class="kt">void</span> <span class="nf">distributeMessage</span><span class="p">(</span><span class="k">const</span> <span class="n">string</span><span class="o">&amp;</span> <span class="n">message</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">LOG_DEBUG</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;begin&#34;</span><span class="p">;</span>
    <span class="c1">// connectionList_是线程局部变量
</span><span class="c1"></span>    <span class="k">for</span> <span class="p">(</span><span class="n">ConnectionList</span><span class="o">::</span><span class="n">iterator</span> <span class="n">it</span> <span class="o">=</span> <span class="n">connections_</span><span class="p">.</span><span class="n">instance</span><span class="p">().</span><span class="n">begin</span><span class="p">();</span>
        <span class="n">it</span> <span class="o">!=</span> <span class="n">connections_</span><span class="p">.</span><span class="n">instance</span><span class="p">().</span><span class="n">end</span><span class="p">();</span>
        <span class="o">++</span><span class="n">it</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">codec_</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="n">get_pointer</span><span class="p">(</span><span class="o">*</span><span class="n">it</span><span class="p">),</span> <span class="n">message</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">LOG_DEBUG</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;end&#34;</span><span class="p">;</span>
  <span class="p">}</span>
<span class="cm">/*IO线程执行前时的前回调函数*/</span>
  <span class="kt">void</span> <span class="nf">threadInit</span><span class="p">(</span><span class="n">EventLoop</span><span class="o">*</span> <span class="n">loop</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">assert</span><span class="p">(</span><span class="n">connections_</span><span class="p">.</span><span class="n">pointer</span><span class="p">()</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">);</span>
    <span class="cm">/*实例化一个对象*/</span>
    <span class="n">connections_</span><span class="p">.</span><span class="n">instance</span><span class="p">();</span>
    <span class="n">assert</span><span class="p">(</span><span class="n">connections_</span><span class="p">.</span><span class="n">pointer</span><span class="p">()</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">);</span>
    <span class="n">MutexLockGuard</span> <span class="n">lock</span><span class="p">(</span><span class="n">mutex_</span><span class="p">);</span>
    <span class="n">loops_</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="n">loop</span><span class="p">);</span>
  <span class="p">}</span>
 
  <span class="n">EventLoop</span><span class="o">*</span> <span class="n">loop_</span><span class="p">;</span> <span class="c1">//loop_传递给server_
</span><span class="c1"></span>  <span class="n">TcpServer</span> <span class="n">server_</span><span class="p">;</span>
  <span class="n">LengthHeaderCodec</span> <span class="n">codec_</span><span class="p">;</span>
  <span class="cm">/*线程局部单例变量，每个线程都有一个connections_(连接列表)实例*/</span>
  <span class="n">ThreadLocalSingleton</span><span class="o">&lt;</span><span class="n">ConnectionList</span><span class="o">&gt;</span> <span class="n">connections_</span><span class="p">;</span>
 
  <span class="n">MutexLock</span> <span class="n">mutex_</span><span class="p">;</span>
  <span class="n">std</span><span class="o">::</span><span class="n">set</span><span class="o">&lt;</span><span class="n">EventLoop</span><span class="o">*&gt;</span> <span class="n">loops_</span><span class="p">;</span>        <span class="c1">//eventLoop列表
</span><span class="c1"></span><span class="p">};</span>
 
<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span><span class="o">*</span> <span class="n">argv</span><span class="p">[])</span>
<span class="p">{</span>
  <span class="n">LOG_INFO</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;pid = &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">getpid</span><span class="p">();</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">argc</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">EventLoop</span> <span class="n">loop</span><span class="p">;</span><span class="c1">//acceptor loop
</span><span class="c1"></span>    <span class="n">uint16_t</span> <span class="n">port</span> <span class="o">=</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="n">uint16_t</span><span class="o">&gt;</span><span class="p">(</span><span class="n">atoi</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]));</span>
    <span class="n">InetAddress</span> <span class="n">serverAddr</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
    <span class="n">ChatServer</span> <span class="n">server</span><span class="p">(</span><span class="o">&amp;</span><span class="n">loop</span><span class="p">,</span> <span class="n">serverAddr</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">argc</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">server</span><span class="p">.</span><span class="n">setThreadNum</span><span class="p">(</span><span class="n">atoi</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">]));</span> <span class="c1">//多个subIO线程
</span><span class="c1"></span>    <span class="p">}</span>
    <span class="n">server</span><span class="p">.</span><span class="n">start</span><span class="p">();</span>
    <span class="n">loop</span><span class="p">.</span><span class="n">loop</span><span class="p">();</span>
  <span class="p">}</span>
  <span class="k">else</span>
  <span class="p">{</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;Usage: %s port [thread_num]</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div>
<h2 id="47-限制服务器最大并发连接数">[47] 限制服务器最大并发连接数</h2>

<p>限制服务器最大并发连接数（<code>MuduoManual.pdf P108</code>）
用<code>Timing wheel</code>踢掉空闲连接（<code>MuduoManual.pdf P122</code>）</p>

<h3 id="timing-wheel">Timing wheel</h3>

<p>echo.h</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-c++" data-lang="c++"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c++" data-lang="c++"><span class="cp">#ifndef MUDUO_EXAMPLES_IDLECONNECTION_ECHO_H
</span><span class="cp">#define MUDUO_EXAMPLES_IDLECONNECTION_ECHO_H
</span><span class="cp"></span> 
<span class="cp">#include</span> <span class="cpf">&lt;muduo/net/TcpServer.h&gt;</span><span class="cp">
</span><span class="cp"></span><span class="c1">//#include &lt;muduo/base/Types.h&gt;
</span><span class="c1"></span> 
<span class="cp">#include</span> <span class="cpf">&lt;boost/circular_buffer.hpp&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;boost/unordered_set.hpp&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;boost/version.hpp&gt;</span><span class="cp">
</span><span class="cp"></span> 
<span class="cp">#if BOOST_VERSION &lt; 104700
</span><span class="cp"></span><span class="k">namespace</span> <span class="n">boost</span>
<span class="p">{</span>
<span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="o">&gt;</span>
<span class="kr">inline</span> <span class="n">size_t</span> <span class="n">hash_value</span><span class="p">(</span><span class="k">const</span> <span class="n">boost</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;&amp;</span> <span class="n">x</span><span class="p">)</span>
<span class="p">{</span>
  <span class="k">return</span> <span class="n">boost</span><span class="o">::</span><span class="n">hash_value</span><span class="p">(</span><span class="n">x</span><span class="p">.</span><span class="n">get</span><span class="p">());</span>
<span class="p">}</span>
<span class="p">}</span>
<span class="cp">#endif
</span><span class="cp"></span> 
<span class="c1">// RFC 862
</span><span class="c1"></span><span class="k">class</span><span class="err"> </span><span class="nc">EchoServer</span>
<span class="p">{</span>
 <span class="k">public</span><span class="o">:</span>
  <span class="n">EchoServer</span><span class="p">(</span><span class="n">muduo</span><span class="o">::</span><span class="n">net</span><span class="o">::</span><span class="n">EventLoop</span><span class="o">*</span> <span class="n">loop</span><span class="p">,</span>
             <span class="k">const</span> <span class="n">muduo</span><span class="o">::</span><span class="n">net</span><span class="o">::</span><span class="n">InetAddress</span><span class="o">&amp;</span> <span class="n">listenAddr</span><span class="p">,</span>
             <span class="kt">int</span> <span class="n">idleSeconds</span><span class="p">);</span>
 
  <span class="kt">void</span> <span class="nf">start</span><span class="p">();</span>
 
 <span class="k">private</span><span class="o">:</span>
  <span class="kt">void</span> <span class="n">onConnection</span><span class="p">(</span><span class="k">const</span> <span class="n">muduo</span><span class="o">::</span><span class="n">net</span><span class="o">::</span><span class="n">TcpConnectionPtr</span><span class="o">&amp;</span> <span class="n">conn</span><span class="p">);</span>
 
  <span class="kt">void</span> <span class="nf">onMessage</span><span class="p">(</span><span class="k">const</span> <span class="n">muduo</span><span class="o">::</span><span class="n">net</span><span class="o">::</span><span class="n">TcpConnectionPtr</span><span class="o">&amp;</span> <span class="n">conn</span><span class="p">,</span>
                 <span class="n">muduo</span><span class="o">::</span><span class="n">net</span><span class="o">::</span><span class="n">Buffer</span><span class="o">*</span> <span class="n">buf</span><span class="p">,</span>
                 <span class="n">muduo</span><span class="o">::</span><span class="n">Timestamp</span> <span class="n">time</span><span class="p">);</span>
 
  <span class="kt">void</span> <span class="nf">onTimer</span><span class="p">();</span>
 
  <span class="kt">void</span> <span class="nf">dumpConnectionBuckets</span><span class="p">()</span> <span class="k">const</span><span class="p">;</span>
 
  <span class="k">typedef</span> <span class="n">boost</span><span class="o">::</span><span class="n">weak_ptr</span><span class="o">&lt;</span><span class="n">muduo</span><span class="o">::</span><span class="n">net</span><span class="o">::</span><span class="n">TcpConnection</span><span class="o">&gt;</span> <span class="n">WeakTcpConnectionPtr</span><span class="p">;</span>
 
  <span class="k">struct</span> <span class="nl">Entry</span> <span class="p">:</span> <span class="k">public</span> <span class="n">muduo</span><span class="o">::</span><span class="n">copyable</span>
  <span class="p">{</span>
    <span class="k">explicit</span> <span class="n">Entry</span><span class="p">(</span><span class="k">const</span> <span class="n">WeakTcpConnectionPtr</span><span class="o">&amp;</span> <span class="n">weakConn</span><span class="p">)</span>
      <span class="o">:</span> <span class="n">weakConn_</span><span class="p">(</span><span class="n">weakConn</span><span class="p">)</span> <span class="c1">//这是一个弱指针，所以创建一个对象时，引用计数不会加一
</span><span class="c1"></span>    <span class="p">{</span>
    <span class="p">}</span>
 
    <span class="o">~</span><span class="n">Entry</span><span class="p">()</span>
    <span class="p">{</span><span class="cm">/*当引用计数为0时，会调用虚构函数；
</span><span class="cm">将弱指针提升为强指针，然后关闭连接
</span><span class="cm">    */</span>
      <span class="n">muduo</span><span class="o">::</span><span class="n">net</span><span class="o">::</span><span class="n">TcpConnectionPtr</span> <span class="n">conn</span> <span class="o">=</span> <span class="n">weakConn_</span><span class="p">.</span><span class="n">lock</span><span class="p">();</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">conn</span><span class="p">)</span>
      <span class="p">{</span>
        <span class="n">conn</span><span class="o">-&gt;</span><span class="n">shutdown</span><span class="p">();</span>
      <span class="p">}</span>
    <span class="p">}</span>
 
    <span class="n">WeakTcpConnectionPtr</span> <span class="n">weakConn_</span><span class="p">;</span>
  <span class="p">};</span>
  <span class="k">typedef</span> <span class="n">boost</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">Entry</span><span class="o">&gt;</span> <span class="n">EntryPtr</span><span class="p">;</span> <span class="c1">//共享型Entry指针
</span><span class="c1"></span>  <span class="k">typedef</span> <span class="n">boost</span><span class="o">::</span><span class="n">weak_ptr</span><span class="o">&lt;</span><span class="n">Entry</span><span class="o">&gt;</span> <span class="n">WeakEntryPtr</span><span class="p">;</span><span class="c1">//弱指针Entry型
</span><span class="c1"></span>  <span class="k">typedef</span> <span class="n">boost</span><span class="o">::</span><span class="n">unordered_set</span><span class="o">&lt;</span><span class="n">EntryPtr</span><span class="o">&gt;</span> <span class="n">Bucket</span><span class="p">;</span><span class="c1">//共享型Entry集合
</span><span class="c1"></span>  <span class="k">typedef</span> <span class="n">boost</span><span class="o">::</span><span class="n">circular_buffer</span><span class="o">&lt;</span><span class="n">Bucket</span><span class="o">&gt;</span> <span class="n">WeakConnectionList</span><span class="p">;</span>
 
  <span class="n">muduo</span><span class="o">::</span><span class="n">net</span><span class="o">::</span><span class="n">EventLoop</span><span class="o">*</span> <span class="n">loop_</span><span class="p">;</span>
  <span class="n">muduo</span><span class="o">::</span><span class="n">net</span><span class="o">::</span><span class="n">TcpServer</span> <span class="n">server_</span><span class="p">;</span>
  <span class="n">WeakConnectionList</span> <span class="n">connectionBuckets_</span><span class="p">;</span>
<span class="p">};</span>
 
<span class="cp">#endif  </span><span class="c1">// MUDUO_EXAMPLES_IDLECONNECTION_ECHO_H
</span></code></pre></td></tr></table>
</div>
</div>
<p>echo.cc</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-c++" data-lang="c++"><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c++" data-lang="c++"><span class="cp">#include</span> <span class="cpf">&#34;echo.h&#34;</span><span class="cp">
</span><span class="cp"></span> 
<span class="cp">#include</span> <span class="cpf">&lt;muduo/base/Logging.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;muduo/net/EventLoop.h&gt;</span><span class="cp">
</span><span class="cp"></span> 
<span class="cp">#include</span> <span class="cpf">&lt;boost/bind.hpp&gt;</span><span class="cp">
</span><span class="cp"></span> 
<span class="cp">#include</span> <span class="cpf">&lt;assert.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
</span><span class="cp"></span> 
<span class="k">using</span> <span class="k">namespace</span> <span class="n">muduo</span><span class="p">;</span>
<span class="k">using</span> <span class="k">namespace</span> <span class="n">muduo</span><span class="o">::</span><span class="n">net</span><span class="p">;</span>
 
 
<span class="n">EchoServer</span><span class="o">::</span><span class="n">EchoServer</span><span class="p">(</span><span class="n">EventLoop</span><span class="o">*</span> <span class="n">loop</span><span class="p">,</span>
                       <span class="k">const</span> <span class="n">InetAddress</span><span class="o">&amp;</span> <span class="n">listenAddr</span><span class="p">,</span>
                       <span class="kt">int</span> <span class="n">idleSeconds</span><span class="p">)</span>
  <span class="o">:</span> <span class="n">loop_</span><span class="p">(</span><span class="n">loop</span><span class="p">),</span>
    <span class="n">server_</span><span class="p">(</span><span class="n">loop</span><span class="p">,</span> <span class="n">listenAddr</span><span class="p">,</span> <span class="s">&#34;EchoServer&#34;</span><span class="p">),</span>
    <span class="n">connectionBuckets_</span><span class="p">(</span><span class="n">idleSeconds</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">server_</span><span class="p">.</span><span class="n">setConnectionCallback</span><span class="p">(</span>
      <span class="n">boost</span><span class="o">::</span><span class="n">bind</span><span class="p">(</span><span class="o">&amp;</span><span class="n">EchoServer</span><span class="o">::</span><span class="n">onConnection</span><span class="p">,</span> <span class="k">this</span><span class="p">,</span> <span class="n">_1</span><span class="p">));</span>
  <span class="n">server_</span><span class="p">.</span><span class="n">setMessageCallback</span><span class="p">(</span>
      <span class="n">boost</span><span class="o">::</span><span class="n">bind</span><span class="p">(</span><span class="o">&amp;</span><span class="n">EchoServer</span><span class="o">::</span><span class="n">onMessage</span><span class="p">,</span> <span class="k">this</span><span class="p">,</span> <span class="n">_1</span><span class="p">,</span> <span class="n">_2</span><span class="p">,</span> <span class="n">_3</span><span class="p">));</span>
  <span class="n">loop</span><span class="o">-&gt;</span><span class="n">runEvery</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">boost</span><span class="o">::</span><span class="n">bind</span><span class="p">(</span><span class="o">&amp;</span><span class="n">EchoServer</span><span class="o">::</span><span class="n">onTimer</span><span class="p">,</span> <span class="k">this</span><span class="p">));</span>
  <span class="n">connectionBuckets_</span><span class="p">.</span><span class="n">resize</span><span class="p">(</span><span class="n">idleSeconds</span><span class="p">);</span>
  <span class="n">dumpConnectionBuckets</span><span class="p">();</span>
<span class="p">}</span>
 
<span class="kt">void</span> <span class="n">EchoServer</span><span class="o">::</span><span class="n">start</span><span class="p">()</span>
<span class="p">{</span>
  <span class="n">server_</span><span class="p">.</span><span class="n">start</span><span class="p">();</span>
<span class="p">}</span>
<span class="cm">/*连接到来时的回调函数*/</span>
<span class="kt">void</span> <span class="n">EchoServer</span><span class="o">::</span><span class="n">onConnection</span><span class="p">(</span><span class="k">const</span> <span class="n">TcpConnectionPtr</span><span class="o">&amp;</span> <span class="n">conn</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">LOG_INFO</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;EchoServer - &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">peerAddress</span><span class="p">().</span><span class="n">toIpPort</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="s">&#34; -&gt; &#34;</span>
           <span class="o">&lt;&lt;</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">localAddress</span><span class="p">().</span><span class="n">toIpPort</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="s">&#34; is &#34;</span>
           <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">connected</span><span class="p">()</span> <span class="o">?</span> <span class="s">&#34;UP&#34;</span> <span class="o">:</span> <span class="s">&#34;DOWN&#34;</span><span class="p">);</span>
 
  <span class="k">if</span> <span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">connected</span><span class="p">())</span>
  <span class="p">{</span>
  <span class="cm">/*将连接和entryptr绑定
</span><span class="cm">  引用计数为1，这是一个临时对象*/</span>
    <span class="n">EntryPtr</span> <span class="n">entry</span><span class="p">(</span><span class="k">new</span> <span class="n">Entry</span><span class="p">(</span><span class="n">conn</span><span class="p">));</span>
  <span class="cm">/*插入到队尾，这时候引用计数位2*/</span>
    <span class="n">connectionBuckets_</span><span class="p">.</span><span class="n">back</span><span class="p">().</span><span class="n">insert</span><span class="p">(</span><span class="n">entry</span><span class="p">);</span>
  <span class="cm">/*打出桶的连接数*/</span>
    <span class="n">dumpConnectionBuckets</span><span class="p">();</span>
    <span class="n">WeakEntryPtr</span> <span class="nf">weakEntry</span><span class="p">(</span><span class="n">entry</span><span class="p">);</span>
    <span class="cm">/*设置一下上下文，不使用强引用，防止引用计数加1
</span><span class="cm">    这也是为了在OnMessage()函数调用时可以使用
</span><span class="cm">    */</span>
    <span class="n">conn</span><span class="o">-&gt;</span><span class="n">setContext</span><span class="p">(</span><span class="n">weakEntry</span><span class="p">);</span>
  <span class="p">}</span><span class="c1">//临时对象无效，引用计数减1
</span><span class="c1"></span> 
  <span class="k">else</span>
  <span class="p">{</span>
    <span class="n">assert</span><span class="p">(</span><span class="o">!</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">getContext</span><span class="p">().</span><span class="n">empty</span><span class="p">());</span>
    <span class="cm">/*输出一下引用计数*/</span>
    <span class="n">WeakEntryPtr</span> <span class="nf">weakEntry</span><span class="p">(</span><span class="n">boost</span><span class="o">::</span><span class="n">any_cast</span><span class="o">&lt;</span><span class="n">WeakEntryPtr</span><span class="o">&gt;</span><span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">getContext</span><span class="p">()));</span>
    <span class="n">LOG_DEBUG</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;Entry use_count = &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">weakEntry</span><span class="p">.</span><span class="n">use_count</span><span class="p">();</span>
  <span class="p">}</span>
<span class="p">}</span>
 
<span class="cm">/*消息到达时的回调函数*/</span>
<span class="kt">void</span> <span class="n">EchoServer</span><span class="o">::</span><span class="n">onMessage</span><span class="p">(</span><span class="k">const</span> <span class="n">TcpConnectionPtr</span><span class="o">&amp;</span> <span class="n">conn</span><span class="p">,</span>
                           <span class="n">Buffer</span><span class="o">*</span> <span class="n">buf</span><span class="p">,</span>
                           <span class="n">Timestamp</span> <span class="n">time</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">string</span> <span class="n">msg</span><span class="p">(</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">retrieveAllAsString</span><span class="p">());</span>
  <span class="n">LOG_INFO</span> <span class="o">&lt;&lt;</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="s">&#34; echo &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">msg</span><span class="p">.</span><span class="n">size</span><span class="p">()</span>
           <span class="o">&lt;&lt;</span> <span class="s">&#34; bytes at &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">time</span><span class="p">.</span><span class="n">toString</span><span class="p">();</span>
  <span class="n">conn</span><span class="o">-&gt;</span><span class="n">send</span><span class="p">(</span><span class="n">msg</span><span class="p">);</span>
 
  <span class="n">assert</span><span class="p">(</span><span class="o">!</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">getContext</span><span class="p">().</span><span class="n">empty</span><span class="p">());</span>
  <span class="n">WeakEntryPtr</span> <span class="nf">weakEntry</span><span class="p">(</span><span class="n">boost</span><span class="o">::</span><span class="n">any_cast</span><span class="o">&lt;</span><span class="n">WeakEntryPtr</span><span class="o">&gt;</span><span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">getContext</span><span class="p">()));</span>
  <span class="n">EntryPtr</span> <span class="nf">entry</span><span class="p">(</span><span class="n">weakEntry</span><span class="p">.</span><span class="n">lock</span><span class="p">());</span><span class="c1">//+1
</span><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="n">entry</span><span class="p">)</span>
  <span class="p">{</span>
  <span class="cm">/*在tail后面插入一个entry*/</span>
    <span class="n">connectionBuckets_</span><span class="p">.</span><span class="n">back</span><span class="p">().</span><span class="n">insert</span><span class="p">(</span><span class="n">entry</span><span class="p">);</span><span class="c1">//+1
</span><span class="c1"></span>    <span class="n">dumpConnectionBuckets</span><span class="p">();</span>
  <span class="p">}</span><span class="c1">//-1
</span><span class="c1"></span><span class="p">}</span>
 
<span class="cm">/*时钟达到*/</span>
<span class="kt">void</span> <span class="n">EchoServer</span><span class="o">::</span><span class="n">onTimer</span><span class="p">()</span>
<span class="p">{</span>
<span class="cm">/*清空该位置上的集合，集合里面的指针引用计数都减1*/</span>
  <span class="n">connectionBuckets_</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">Bucket</span><span class="p">());</span>
  <span class="n">dumpConnectionBuckets</span><span class="p">();</span>
<span class="p">}</span>
<span class="cm">/*打出桶的连接数*/</span>
 
<span class="kt">void</span> <span class="n">EchoServer</span><span class="o">::</span><span class="n">dumpConnectionBuckets</span><span class="p">()</span> <span class="k">const</span>
<span class="p">{</span>
  <span class="n">LOG_INFO</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;size = &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">connectionBuckets_</span><span class="p">.</span><span class="n">size</span><span class="p">();</span>
  <span class="kt">int</span> <span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="cm">/*弱引用*/</span>
  <span class="k">for</span> <span class="p">(</span><span class="n">WeakConnectionList</span><span class="o">::</span><span class="n">const_iterator</span> <span class="n">bucketI</span> <span class="o">=</span> <span class="n">connectionBuckets_</span><span class="p">.</span><span class="n">begin</span><span class="p">();</span>
      <span class="n">bucketI</span> <span class="o">!=</span> <span class="n">connectionBuckets_</span><span class="p">.</span><span class="n">end</span><span class="p">();</span>
      <span class="o">++</span><span class="n">bucketI</span><span class="p">,</span> <span class="o">++</span><span class="n">idx</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="k">const</span> <span class="n">Bucket</span><span class="o">&amp;</span> <span class="n">bucket</span> <span class="o">=</span> <span class="o">*</span><span class="n">bucketI</span><span class="p">;</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;[%d] len = %zd : &#34;</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="n">bucket</span><span class="p">.</span><span class="n">size</span><span class="p">());</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">Bucket</span><span class="o">::</span><span class="n">const_iterator</span> <span class="n">it</span> <span class="o">=</span> <span class="n">bucket</span><span class="p">.</span><span class="n">begin</span><span class="p">();</span>
        <span class="n">it</span> <span class="o">!=</span> <span class="n">bucket</span><span class="p">.</span><span class="n">end</span><span class="p">();</span>
        <span class="o">++</span><span class="n">it</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="kt">bool</span> <span class="n">connectionDead</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">it</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">weakConn_</span><span class="p">.</span><span class="n">expired</span><span class="p">();</span>
      <span class="n">printf</span><span class="p">(</span><span class="s">&#34;%p(%ld)%s, &#34;</span><span class="p">,</span> <span class="n">get_pointer</span><span class="p">(</span><span class="o">*</span><span class="n">it</span><span class="p">),</span> <span class="n">it</span><span class="o">-&gt;</span><span class="n">use_count</span><span class="p">(),</span>
          <span class="n">connectionDead</span> <span class="o">?</span> <span class="s">&#34; DEAD&#34;</span> <span class="o">:</span> <span class="s">&#34;&#34;</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">puts</span><span class="p">(</span><span class="s">&#34;&#34;</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div>
<p>sortedlist.h</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-c++" data-lang="c++"><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span><span class="lnt">177
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c++" data-lang="c++"><span class="cp">#include</span> <span class="cpf">&lt;muduo/base/Logging.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;muduo/net/EventLoop.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;muduo/net/TcpServer.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;boost/bind.hpp&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;list&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
</span><span class="cp"></span> 
<span class="k">using</span> <span class="k">namespace</span> <span class="n">muduo</span><span class="p">;</span>
<span class="k">using</span> <span class="k">namespace</span> <span class="n">muduo</span><span class="o">::</span><span class="n">net</span><span class="p">;</span>
 
<span class="c1">// RFC 862
</span><span class="c1"></span><span class="k">class</span><span class="err"> </span><span class="nc">EchoServer</span>
<span class="p">{</span>
 <span class="k">public</span><span class="o">:</span>
  <span class="n">EchoServer</span><span class="p">(</span><span class="n">EventLoop</span><span class="o">*</span> <span class="n">loop</span><span class="p">,</span>
             <span class="k">const</span> <span class="n">InetAddress</span><span class="o">&amp;</span> <span class="n">listenAddr</span><span class="p">,</span>
             <span class="kt">int</span> <span class="n">idleSeconds</span><span class="p">);</span>
 
  <span class="kt">void</span> <span class="nf">start</span><span class="p">()</span>
  <span class="p">{</span>
    <span class="n">server_</span><span class="p">.</span><span class="n">start</span><span class="p">();</span>
  <span class="p">}</span>
 
 <span class="k">private</span><span class="o">:</span>
  <span class="kt">void</span> <span class="n">onConnection</span><span class="p">(</span><span class="k">const</span> <span class="n">TcpConnectionPtr</span><span class="o">&amp;</span> <span class="n">conn</span><span class="p">);</span>
 
  <span class="kt">void</span> <span class="nf">onMessage</span><span class="p">(</span><span class="k">const</span> <span class="n">TcpConnectionPtr</span><span class="o">&amp;</span> <span class="n">conn</span><span class="p">,</span>
                 <span class="n">Buffer</span><span class="o">*</span> <span class="n">buf</span><span class="p">,</span>
                 <span class="n">Timestamp</span> <span class="n">time</span><span class="p">);</span>
 
  <span class="kt">void</span> <span class="nf">onTimer</span><span class="p">();</span>
 
  <span class="kt">void</span> <span class="nf">dumpConnectionList</span><span class="p">()</span> <span class="k">const</span><span class="p">;</span>
 
  <span class="k">typedef</span> <span class="n">boost</span><span class="o">::</span><span class="n">weak_ptr</span><span class="o">&lt;</span><span class="n">TcpConnection</span><span class="o">&gt;</span> <span class="n">WeakTcpConnectionPtr</span><span class="p">;</span><span class="c1">//弱连接指针
</span><span class="c1"></span>  <span class="k">typedef</span> <span class="n">std</span><span class="o">::</span><span class="n">list</span><span class="o">&lt;</span><span class="n">WeakTcpConnectionPtr</span><span class="o">&gt;</span> <span class="n">WeakConnectionList</span><span class="p">;</span><span class="c1">//连接列表(元素是指针)
</span><span class="c1"></span> 
  <span class="k">struct</span> <span class="nl">Node</span> <span class="p">:</span> <span class="k">public</span> <span class="n">muduo</span><span class="o">::</span><span class="n">copyable</span>
  <span class="p">{</span>
    <span class="n">Timestamp</span> <span class="n">lastReceiveTime</span><span class="p">;</span>  <span class="c1">//该连接最后一次活跃时刻
</span><span class="c1"></span>    <span class="n">WeakConnectionList</span><span class="o">::</span><span class="n">iterator</span> <span class="n">position</span><span class="p">;</span> <span class="c1">//该连接在连接列表中的位置
</span><span class="c1"></span>  <span class="p">};</span>
 
  <span class="n">EventLoop</span><span class="o">*</span> <span class="n">loop_</span><span class="p">;</span>
  <span class="n">TcpServer</span> <span class="n">server_</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">idleSeconds_</span><span class="p">;</span>
  <span class="n">WeakConnectionList</span> <span class="n">connectionList_</span><span class="p">;</span><span class="c1">//连接列表
</span><span class="c1"></span><span class="p">};</span>
 
<span class="n">EchoServer</span><span class="o">::</span><span class="n">EchoServer</span><span class="p">(</span><span class="n">EventLoop</span><span class="o">*</span> <span class="n">loop</span><span class="p">,</span>
                       <span class="k">const</span> <span class="n">InetAddress</span><span class="o">&amp;</span> <span class="n">listenAddr</span><span class="p">,</span>
                       <span class="kt">int</span> <span class="n">idleSeconds</span><span class="p">)</span>
  <span class="o">:</span> <span class="n">loop_</span><span class="p">(</span><span class="n">loop</span><span class="p">),</span>
    <span class="n">server_</span><span class="p">(</span><span class="n">loop</span><span class="p">,</span> <span class="n">listenAddr</span><span class="p">,</span> <span class="s">&#34;EchoServer&#34;</span><span class="p">),</span>
    <span class="n">idleSeconds_</span><span class="p">(</span><span class="n">idleSeconds</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">server_</span><span class="p">.</span><span class="n">setConnectionCallback</span><span class="p">(</span>
      <span class="n">boost</span><span class="o">::</span><span class="n">bind</span><span class="p">(</span><span class="o">&amp;</span><span class="n">EchoServer</span><span class="o">::</span><span class="n">onConnection</span><span class="p">,</span> <span class="k">this</span><span class="p">,</span> <span class="n">_1</span><span class="p">));</span>
  <span class="n">server_</span><span class="p">.</span><span class="n">setMessageCallback</span><span class="p">(</span>
      <span class="n">boost</span><span class="o">::</span><span class="n">bind</span><span class="p">(</span><span class="o">&amp;</span><span class="n">EchoServer</span><span class="o">::</span><span class="n">onMessage</span><span class="p">,</span> <span class="k">this</span><span class="p">,</span> <span class="n">_1</span><span class="p">,</span> <span class="n">_2</span><span class="p">,</span> <span class="n">_3</span><span class="p">));</span>
  <span class="n">loop</span><span class="o">-&gt;</span><span class="n">runEvery</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">boost</span><span class="o">::</span><span class="n">bind</span><span class="p">(</span><span class="o">&amp;</span><span class="n">EchoServer</span><span class="o">::</span><span class="n">onTimer</span><span class="p">,</span> <span class="k">this</span><span class="p">));</span>
  <span class="n">dumpConnectionList</span><span class="p">();</span>
<span class="p">}</span>
 
<span class="kt">void</span> <span class="n">EchoServer</span><span class="o">::</span><span class="n">onConnection</span><span class="p">(</span><span class="k">const</span> <span class="n">TcpConnectionPtr</span><span class="o">&amp;</span> <span class="n">conn</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">LOG_INFO</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;EchoServer - &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">peerAddress</span><span class="p">().</span><span class="n">toIpPort</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="s">&#34; -&gt; &#34;</span>
           <span class="o">&lt;&lt;</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">localAddress</span><span class="p">().</span><span class="n">toIpPort</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="s">&#34; is &#34;</span>
           <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">connected</span><span class="p">()</span> <span class="o">?</span> <span class="s">&#34;UP&#34;</span> <span class="o">:</span> <span class="s">&#34;DOWN&#34;</span><span class="p">);</span>
 
  <span class="k">if</span> <span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">connected</span><span class="p">())</span>
  <span class="p">{</span>
    <span class="n">Node</span> <span class="n">node</span><span class="p">;</span>
    <span class="n">node</span><span class="p">.</span><span class="n">lastReceiveTime</span> <span class="o">=</span> <span class="n">Timestamp</span><span class="o">::</span><span class="n">now</span><span class="p">();</span>
    <span class="n">connectionList_</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">conn</span><span class="p">);</span>
    <span class="n">node</span><span class="p">.</span><span class="n">position</span> <span class="o">=</span> <span class="o">--</span><span class="n">connectionList_</span><span class="p">.</span><span class="n">end</span><span class="p">();</span>
    <span class="n">conn</span><span class="o">-&gt;</span><span class="n">setContext</span><span class="p">(</span><span class="n">node</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">else</span>
  <span class="p">{</span>
    <span class="n">assert</span><span class="p">(</span><span class="o">!</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">getContext</span><span class="p">().</span><span class="n">empty</span><span class="p">());</span>
    <span class="k">const</span> <span class="n">Node</span><span class="o">&amp;</span> <span class="n">node</span> <span class="o">=</span> <span class="n">boost</span><span class="o">::</span><span class="n">any_cast</span><span class="o">&lt;</span><span class="k">const</span> <span class="n">Node</span><span class="o">&amp;&gt;</span><span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">getContext</span><span class="p">());</span>
    <span class="n">connectionList_</span><span class="p">.</span><span class="n">erase</span><span class="p">(</span><span class="n">node</span><span class="p">.</span><span class="n">position</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="n">dumpConnectionList</span><span class="p">();</span>
<span class="p">}</span>
 
<span class="kt">void</span> <span class="n">EchoServer</span><span class="o">::</span><span class="n">onMessage</span><span class="p">(</span><span class="k">const</span> <span class="n">TcpConnectionPtr</span><span class="o">&amp;</span> <span class="n">conn</span><span class="p">,</span>
                           <span class="n">Buffer</span><span class="o">*</span> <span class="n">buf</span><span class="p">,</span>
                           <span class="n">Timestamp</span> <span class="n">time</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">string</span> <span class="n">msg</span><span class="p">(</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">retrieveAllAsString</span><span class="p">());</span>
  <span class="n">LOG_INFO</span> <span class="o">&lt;&lt;</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="s">&#34; echo &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">msg</span><span class="p">.</span><span class="n">size</span><span class="p">()</span>
           <span class="o">&lt;&lt;</span> <span class="s">&#34; bytes at &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">time</span><span class="p">.</span><span class="n">toString</span><span class="p">();</span>
  <span class="n">conn</span><span class="o">-&gt;</span><span class="n">send</span><span class="p">(</span><span class="n">msg</span><span class="p">);</span>
 
  <span class="n">assert</span><span class="p">(</span><span class="o">!</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">getContext</span><span class="p">().</span><span class="n">empty</span><span class="p">());</span>
  <span class="n">Node</span><span class="o">*</span> <span class="n">node</span> <span class="o">=</span> <span class="n">boost</span><span class="o">::</span><span class="n">any_cast</span><span class="o">&lt;</span><span class="n">Node</span><span class="o">&gt;</span><span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">getMutableContext</span><span class="p">());</span>
  <span class="n">node</span><span class="o">-&gt;</span><span class="n">lastReceiveTime</span> <span class="o">=</span> <span class="n">time</span><span class="p">;</span>
  <span class="c1">// move node inside list with list::splice()
</span><span class="c1"></span>  <span class="n">connectionList_</span><span class="p">.</span><span class="n">erase</span><span class="p">(</span><span class="n">node</span><span class="o">-&gt;</span><span class="n">position</span><span class="p">);</span>
  <span class="n">connectionList_</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">conn</span><span class="p">);</span>
  <span class="n">node</span><span class="o">-&gt;</span><span class="n">position</span> <span class="o">=</span> <span class="o">--</span><span class="n">connectionList_</span><span class="p">.</span><span class="n">end</span><span class="p">();</span>
 
  <span class="n">dumpConnectionList</span><span class="p">();</span>
<span class="p">}</span>
<span class="cm">/*时钟回调函数*/</span>
<span class="kt">void</span> <span class="n">EchoServer</span><span class="o">::</span><span class="n">onTimer</span><span class="p">()</span>
<span class="p">{</span>
  <span class="n">dumpConnectionList</span><span class="p">();</span>
  <span class="n">Timestamp</span> <span class="n">now</span> <span class="o">=</span> <span class="n">Timestamp</span><span class="o">::</span><span class="n">now</span><span class="p">();</span>
  <span class="k">for</span> <span class="p">(</span><span class="n">WeakConnectionList</span><span class="o">::</span><span class="n">iterator</span> <span class="n">it</span> <span class="o">=</span> <span class="n">connectionList_</span><span class="p">.</span><span class="n">begin</span><span class="p">();</span>
      <span class="n">it</span> <span class="o">!=</span> <span class="n">connectionList_</span><span class="p">.</span><span class="n">end</span><span class="p">();)</span>
  <span class="p">{</span>
    <span class="n">TcpConnectionPtr</span> <span class="n">conn</span> <span class="o">=</span> <span class="n">it</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">();</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">conn</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">Node</span><span class="o">*</span> <span class="n">n</span> <span class="o">=</span> <span class="n">boost</span><span class="o">::</span><span class="n">any_cast</span><span class="o">&lt;</span><span class="n">Node</span><span class="o">&gt;</span><span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">getMutableContext</span><span class="p">());</span>
      <span class="kt">double</span> <span class="n">age</span> <span class="o">=</span> <span class="n">timeDifference</span><span class="p">(</span><span class="n">now</span><span class="p">,</span> <span class="n">n</span><span class="o">-&gt;</span><span class="n">lastReceiveTime</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">age</span> <span class="o">&gt;</span> <span class="n">idleSeconds_</span><span class="p">)</span>
      <span class="p">{</span><span class="cm">/*剔除超时的连接*/</span>
        <span class="n">conn</span><span class="o">-&gt;</span><span class="n">shutdown</span><span class="p">();</span>
      <span class="p">}</span>
      <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">age</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
      <span class="p">{</span>
        <span class="n">LOG_WARN</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;Time jump&#34;</span><span class="p">;</span>
        <span class="n">n</span><span class="o">-&gt;</span><span class="n">lastReceiveTime</span> <span class="o">=</span> <span class="n">now</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">else</span>
      <span class="p">{</span>
        <span class="k">break</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="o">++</span><span class="n">it</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">else</span>
    <span class="p">{</span>
      <span class="n">LOG_WARN</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;Expired&#34;</span><span class="p">;</span>
      <span class="n">it</span> <span class="o">=</span> <span class="n">connectionList_</span><span class="p">.</span><span class="n">erase</span><span class="p">(</span><span class="n">it</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
 
<span class="kt">void</span> <span class="n">EchoServer</span><span class="o">::</span><span class="n">dumpConnectionList</span><span class="p">()</span> <span class="k">const</span>
<span class="p">{</span>
  <span class="n">LOG_INFO</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;size = &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">connectionList_</span><span class="p">.</span><span class="n">size</span><span class="p">();</span>
 
  <span class="k">for</span> <span class="p">(</span><span class="n">WeakConnectionList</span><span class="o">::</span><span class="n">const_iterator</span> <span class="n">it</span> <span class="o">=</span> <span class="n">connectionList_</span><span class="p">.</span><span class="n">begin</span><span class="p">();</span>
      <span class="n">it</span> <span class="o">!=</span> <span class="n">connectionList_</span><span class="p">.</span><span class="n">end</span><span class="p">();</span> <span class="o">++</span><span class="n">it</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">TcpConnectionPtr</span> <span class="n">conn</span> <span class="o">=</span> <span class="n">it</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">();</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">conn</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">printf</span><span class="p">(</span><span class="s">&#34;conn %p</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">get_pointer</span><span class="p">(</span><span class="n">conn</span><span class="p">));</span>
      <span class="k">const</span> <span class="n">Node</span><span class="o">&amp;</span> <span class="n">n</span> <span class="o">=</span> <span class="n">boost</span><span class="o">::</span><span class="n">any_cast</span><span class="o">&lt;</span><span class="k">const</span> <span class="n">Node</span><span class="o">&amp;&gt;</span><span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">getContext</span><span class="p">());</span>
      <span class="n">printf</span><span class="p">(</span><span class="s">&#34;    time %s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">n</span><span class="p">.</span><span class="n">lastReceiveTime</span><span class="p">.</span><span class="n">toString</span><span class="p">().</span><span class="n">c_str</span><span class="p">());</span>
    <span class="p">}</span>
    <span class="k">else</span>
    <span class="p">{</span>
      <span class="n">printf</span><span class="p">(</span><span class="s">&#34;expired</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
 
<span class="kt">int</span> <span class="n">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span><span class="o">*</span> <span class="n">argv</span><span class="p">[])</span>
<span class="p">{</span>
  <span class="n">EventLoop</span> <span class="n">loop</span><span class="p">;</span>
  <span class="n">InetAddress</span> <span class="nf">listenAddr</span><span class="p">(</span><span class="mi">2007</span><span class="p">);</span>
  <span class="kt">int</span> <span class="n">idleSeconds</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">argc</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">idleSeconds</span> <span class="o">=</span> <span class="n">atoi</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
  <span class="p">}</span>
  <span class="n">LOG_INFO</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;pid = &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">getpid</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;, idle seconds = &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">idleSeconds</span><span class="p">;</span>
  <span class="n">EchoServer</span> <span class="nf">server</span><span class="p">(</span><span class="o">&amp;</span><span class="n">loop</span><span class="p">,</span> <span class="n">listenAddr</span><span class="p">,</span> <span class="n">idleSeconds</span><span class="p">);</span>
  <span class="n">server</span><span class="p">.</span><span class="n">start</span><span class="p">();</span>
  <span class="n">loop</span><span class="p">.</span><span class="n">loop</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-c++" data-lang="c++"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c++" data-lang="c++"><span class="cp">#include</span> <span class="cpf">&#34;echo.h&#34;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
</span><span class="cp"></span> 
<span class="cp">#include</span> <span class="cpf">&lt;muduo/base/Logging.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;muduo/net/EventLoop.h&gt;</span><span class="cp">
</span><span class="cp"></span> 
<span class="k">using</span> <span class="k">namespace</span> <span class="n">muduo</span><span class="p">;</span>
<span class="k">using</span> <span class="k">namespace</span> <span class="n">muduo</span><span class="o">::</span><span class="n">net</span><span class="p">;</span>
 
<span class="kt">void</span> <span class="nf">testHash</span><span class="p">()</span>
<span class="p">{</span>
  <span class="n">boost</span><span class="o">::</span><span class="n">hash</span><span class="o">&lt;</span><span class="n">boost</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span> <span class="o">&gt;</span> <span class="n">h</span><span class="p">;</span>
  <span class="n">boost</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span> <span class="n">x1</span><span class="p">(</span><span class="k">new</span> <span class="kt">int</span><span class="p">(</span><span class="mi">10</span><span class="p">));</span>
  <span class="n">boost</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span> <span class="n">x2</span><span class="p">(</span><span class="k">new</span> <span class="kt">int</span><span class="p">(</span><span class="mi">10</span><span class="p">));</span>
  <span class="n">h</span><span class="p">(</span><span class="n">x1</span><span class="p">);</span>
  <span class="n">assert</span><span class="p">(</span><span class="n">h</span><span class="p">(</span><span class="n">x1</span><span class="p">)</span> <span class="o">!=</span> <span class="n">h</span><span class="p">(</span><span class="n">x2</span><span class="p">));</span>
  <span class="n">x1</span> <span class="o">=</span> <span class="n">x2</span><span class="p">;</span>
  <span class="n">assert</span><span class="p">(</span><span class="n">h</span><span class="p">(</span><span class="n">x1</span><span class="p">)</span> <span class="o">==</span> <span class="n">h</span><span class="p">(</span><span class="n">x2</span><span class="p">));</span>
  <span class="n">x1</span><span class="p">.</span><span class="n">reset</span><span class="p">();</span>
  <span class="n">assert</span><span class="p">(</span><span class="n">h</span><span class="p">(</span><span class="n">x1</span><span class="p">)</span> <span class="o">!=</span> <span class="n">h</span><span class="p">(</span><span class="n">x2</span><span class="p">));</span>
  <span class="n">x2</span><span class="p">.</span><span class="n">reset</span><span class="p">();</span>
  <span class="n">assert</span><span class="p">(</span><span class="n">h</span><span class="p">(</span><span class="n">x1</span><span class="p">)</span> <span class="o">==</span> <span class="n">h</span><span class="p">(</span><span class="n">x2</span><span class="p">));</span>
<span class="p">}</span>
 
<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span><span class="o">*</span> <span class="n">argv</span><span class="p">[])</span>
<span class="p">{</span>
  <span class="n">testHash</span><span class="p">();</span>
  <span class="n">EventLoop</span> <span class="n">loop</span><span class="p">;</span>
  <span class="n">InetAddress</span> <span class="n">listenAddr</span><span class="p">(</span><span class="mi">2007</span><span class="p">);</span>
  <span class="kt">int</span> <span class="n">idleSeconds</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">argc</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">idleSeconds</span> <span class="o">=</span> <span class="n">atoi</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
  <span class="p">}</span>
  <span class="n">LOG_INFO</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;pid = &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">getpid</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;, idle seconds = &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">idleSeconds</span><span class="p">;</span>
  <span class="n">EchoServer</span> <span class="n">server</span><span class="p">(</span><span class="o">&amp;</span><span class="n">loop</span><span class="p">,</span> <span class="n">listenAddr</span><span class="p">,</span> <span class="n">idleSeconds</span><span class="p">);</span>
  <span class="n">server</span><span class="p">.</span><span class="n">start</span><span class="p">();</span>
  <span class="n">loop</span><span class="p">.</span><span class="n">loop</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div>
    </div>

    <div class="post-copyright">
  <p class="copyright-item">
    <span class="item-title">Author</span>
    <span class="item-content">Rg</span>
  </p>
  <p class="copyright-item">
    <span class="item-title">LastMod</span>
    <span class="item-content">
        2014-07-01
        
    </span>
  </p>
  
  <p class="copyright-item">
    <span class="item-title">License</span>
    <span class="item-content">本文采用<a rel="license" href="http://creativecommons.org/licenses/by-nc/4.0/" target="_blank">知识共享署名-非商业性使用 4.0 国际许可协议</a>进行许可</span>
  </p>
</div>
<div class="post-reward">
  <input type="checkbox" name="reward" id="reward" hidden />
  <label class="reward-button" for="reward">Reward</label>
  <div class="qr-code">
    
    <label class="qr-code-image" for="reward">
        <img class="image" src="https://ws2.sinaimg.cn/large/006tNc79gy1g1r15n5iquj30u014qgqe.jpg">
        <span>wechat</span>
      </label>
    <label class="qr-code-image" for="reward">
        <img class="image" src="https://ws4.sinaimg.cn/large/006tNc79gy1g1srtxmkyyj30lw0pukae.jpg">
        <span>alipay</span>
      </label>
  </div>
</div><footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/muduo/">muduo</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/2015/04/25/cowboy/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">cowboy</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        <a class="next" href="/2013/06/10/muduo-base-library-2/">
            <span class="next-text nav-default">muduo_base_library_2</span>
            <span class="next-text nav-mobile">Next</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        <div id="gitalk-container"></div>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js" crossorigin="anonymous"></script>
    <script type="text/javascript">
      var gitalk = new Gitalk({
        id: '2014-07-01 01:22:24 \x2b0000 UTC',
        title: 'muduo simple example',
        clientID: '88e50f263d090b13460f',
        clientSecret: 'f1007eb6cff0af3b461be3a4b73d808ab7058a21',
        repo: 'blog',
        owner: 'laohanlinux',
        admin: ['laohanlinux'],
        body: decodeURI(location.href)
      });
      gitalk.render('gitalk-container');
    </script>
    <noscript>Please enable JavaScript to view the <a href="https://github.com/gitalk/gitalk">comments powered by gitalk.</a></noscript>

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
      <a href="mailto:daimaldd@email.com" class="iconfont icon-email" title="email"></a>
      <a href="https://github.com/laohanlinux" class="iconfont icon-github" title="github"></a>
  <a href="https://laohanlinux.github.io/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2013 - 
    2019
    <span class="heart">
      <i class="iconfont icon-heart"></i>
    </span>
    <span class="author">Rg</span>
  </span>
</div>
    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script>
<script type="text/javascript" src="/dist/even.26188efa.min.js"></script>








</body>
</html>
