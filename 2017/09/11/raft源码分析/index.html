<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>raft源码分析 - Welcome to Rg Home</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<meta name="author" content="Rg" /><meta name="description" content="raft 源码分析." /><meta name="keywords" content="Rg, Rust, even" />






<meta name="generator" content="Hugo 0.54.0 with even 4.0.0" />


<link rel="canonical" href="https://laohanlinux.github.io/2017/09/11/raft%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">


<link href="/dist/even.b431c293.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">


<meta property="og:title" content="raft源码分析" />
<meta property="og:description" content="raft 源码分析." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://laohanlinux.github.io/2017/09/11/raft%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/" />
<meta property="article:published_time" content="2017-09-11T12:08:30&#43;00:00"/>
<meta property="article:modified_time" content="2017-09-11T12:08:30&#43;00:00"/>

<meta itemprop="name" content="raft源码分析">
<meta itemprop="description" content="raft 源码分析.">


<meta itemprop="datePublished" content="2017-09-11T12:08:30&#43;00:00" />
<meta itemprop="dateModified" content="2017-09-11T12:08:30&#43;00:00" />
<meta itemprop="wordCount" content="13573">



<meta itemprop="keywords" content="raft,raft source analyse," />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="raft源码分析"/>
<meta name="twitter:description" content="raft 源码分析."/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">Welcome come to Rg Home</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">cd ~/</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a>
  </ul>
</nav>
  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">Welcome come to Rg Home</a>
</div>

<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">cd ~/</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li>
  </ul>
</nav>
    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">raft源码分析</h1>

      <div class="post-meta">
        <span class="post-time"> 2017-09-11 </span>
        <div class="post-category">
            <a href="/categories/distribute-system/"> Distribute System </a>
            </div>
          <span class="more-meta"> 13573 words </span>
          <span class="more-meta"> 28 mins read </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Contents</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
<ul>
<li><a href="#项目简介">项目简介</a>
<ul>
<li><a href="#节点的增加和删除">节点的增加和删除</a></li>
<li><a href="#roadmap">roadmap</a></li>
</ul></li>
<li><a href="#源码分析">源码分析</a>
<ul>
<li><a href="#源码目录结构">源码目录结构</a></li>
<li><a href="#主要的数据结构">主要的数据结构</a>
<ul>
<li><a href="#rpc-go">rpc.go</a></li>
<li><a href="#log-go">log.go</a></li>
<li><a href="#peers-go">Peers.go</a></li>
<li><a href="#server-go">server.go</a></li>
<li><a href="#configuration-go">configuration.go</a></li>
</ul></li>
</ul></li>
<li><a href="#demo">Demo</a></li>
</ul>
</nav>
  </div>
</div>
    <div class="post-content">
      

<p>这篇文章主要是从源码的级别来看<code>Raft</code>算法的实现。在网上找到了一个简化版：<a href="https://github.com/peterbourgon/raft">源码</a>.
一个<code>Server</code>结构代表<code>Raft</code>网络中的一个<code>节点</code>。节点会创建一个<code>Server</code>，并且通过<code>端(peers)</code>接口的方式暴露给其他节点。
传输层采用<code>http</code>包装，<code>端对端</code>通信通过<code>rest http</code>方式。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-sh" data-lang="sh"><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-sh" data-lang="sh"><span class="p">|</span>http transport<span class="p">|</span> ---&gt; <span class="p">|</span>peers<span class="p">|</span> ---&gt; <span class="p">|</span>server<span class="p">|</span></code></pre></td></tr></table>
</div>
</div>
<h1 id="项目简介">项目简介</h1>

<h2 id="节点的增加和删除">节点的增加和删除</h2>

<p>支持动态增删节点，采用一个简单的<code>共识</code>算法(节点更新时，接受配置更新的节点需要超过1/2，即新集群要大于旧集群)。</p>

<h2 id="roadmap">roadmap</h2>

<ul>
<li>leader选举</li>
<li>日志复制</li>
<li>单元测试</li>
<li>http 传输层</li>
<li>配置变更</li>
</ul>

<p>除此之外，还有一些是未完成的
- net/rpc 传输层或者其他类型的传输层
- 日志压缩
- 快照安装以及恢复
- 完整的<code>demo</code>应用
- 一些比较复杂的测试用例
  具体细节，看下面的代码分析。</p>

<h1 id="源码分析">源码分析</h1>

<h2 id="源码目录结构">源码目录结构</h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-sh" data-lang="sh"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-sh" data-lang="sh">├── JOINT-CONSENSUS.md
├── LICENSE
├── README.md
├── configuration.go // 配置
├── example_test.go // demo
├── log.go // 日志
├── log_test.go // 日志测试模块
├── peers.go // 端
├── peers_test.go // 端模块
├── rpc.go // rpc 对象模块
├── server.go //  server模块
├── server_internals_test.go // server内部测试模块
├── server_test.go //  server测试模块
├── transport.go // 传输层
└── transport_test.go // 传输层模块</code></pre></td></tr></table>
</div>
</div>
<h2 id="主要的数据结构">主要的数据结构</h2>

<h3 id="rpc-go">rpc.go</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="c1">// 日志追加
</span><span class="c1"></span><span class="kd">type</span> <span class="nx">appendEntriesTuple</span> <span class="kd">struct</span> <span class="p">{</span>
        <span class="c1">// 日志追加请求
</span><span class="c1"></span>       	<span class="nx">Request</span>  <span class="nx">appendEntries</span> 
       	<span class="c1">// 应答通道
</span><span class="c1"></span>       	<span class="nx">Response</span> <span class="kd">chan</span> <span class="nx">appendEntriesResponse</span> 
<span class="p">}</span>
<span class="c1">// 投票选举
</span><span class="c1"></span><span class="kd">type</span> <span class="nx">requestVoteTuple</span> <span class="kd">struct</span> <span class="p">{</span>
        <span class="c1">// 选举内容
</span><span class="c1"></span>       	<span class="nx">Request</span>  <span class="nx">requestVote</span> 
       	<span class="c1">// 选举结构应答
</span><span class="c1"></span>       	<span class="nx">Response</span> <span class="kd">chan</span> <span class="nx">requestVoteResponse</span>
<span class="p">}</span>

<span class="c1">// appendEntries represents an appendEntries RPC.
</span><span class="c1">// 日志追加-实体
</span><span class="c1"></span><span class="kd">type</span> <span class="nx">appendEntries</span> <span class="kd">struct</span> <span class="p">{</span>
        <span class="c1">// 任期号
</span><span class="c1"></span>       	<span class="nx">Term</span>         <span class="kt">uint64</span>     <span class="s">`json:&#34;term&#34;`</span> 
   	    <span class="c1">// leader 标识
</span><span class="c1"></span>       	<span class="nx">LeaderID</span>     <span class="kt">uint64</span>     <span class="s">`json:&#34;leader_id&#34;`</span> 
   	    <span class="c1">// 前一个日志索引
</span><span class="c1"></span>       	<span class="nx">PrevLogIndex</span> <span class="kt">uint64</span>     <span class="s">`json:&#34;prev_log_index&#34;`</span> 
       	<span class="c1">// 前一个日志任期号
</span><span class="c1"></span>       	<span class="nx">PrevLogTerm</span>  <span class="kt">uint64</span>     <span class="s">`json:&#34;prev_log_term&#34;`</span> 
       	<span class="c1">// 要追加的实体数组-支持批量追加
</span><span class="c1"></span>       	<span class="nx">Entries</span>      <span class="p">[]</span><span class="nx">logEntry</span> <span class="s">`json:&#34;entries&#34;`</span> 
       	<span class="c1">// 已经committed的缩影
</span><span class="c1"></span>       	<span class="nx">CommitIndex</span>  <span class="kt">uint64</span>     <span class="s">`json:&#34;commit_index&#34;`</span> 
<span class="p">}</span>

<span class="c1">// appendEntriesResponse represents the response to an appendEntries RPC.
</span><span class="c1">// 日志追加应答
</span><span class="c1"></span><span class="kd">type</span> <span class="nx">appendEntriesResponse</span> <span class="kd">struct</span> <span class="p">{</span>
        <span class="c1">// 应答节点的任期号
</span><span class="c1"></span>       	<span class="nx">Term</span>    <span class="kt">uint64</span> <span class="s">`json:&#34;term&#34;`</span> 
       	<span class="c1">// 是否追加成功
</span><span class="c1"></span>       	<span class="nx">Success</span> <span class="kt">bool</span>   <span class="s">`json:&#34;success&#34;`</span> 
       	<span class="c1">// 失败的原因
</span><span class="c1"></span>       	<span class="nx">reason</span>  <span class="kt">string</span> 
<span class="p">}</span>

<span class="c1">// requestVote represents a requestVote RPC.
</span><span class="c1">// 投票请求实体
</span><span class="c1"></span><span class="kd">type</span> <span class="nx">requestVote</span> <span class="kd">struct</span> <span class="p">{</span>
         <span class="c1">// 发起者的任期号 
</span><span class="c1"></span>       	<span class="nx">Term</span>         <span class="kt">uint64</span> <span class="s">`json:&#34;term&#34;`</span>
   	    <span class="c1">// 发起者的id
</span><span class="c1"></span>       	<span class="nx">CandidateID</span>  <span class="kt">uint64</span> <span class="s">`json:&#34;candidate_id&#34;`</span>
   	    <span class="c1">// 发起者的最新条目
</span><span class="c1"></span>       	<span class="nx">LastLogIndex</span> <span class="kt">uint64</span> <span class="s">`json:&#34;last_log_index&#34;`</span>
   	    <span class="c1">// 发起者的最新任期号
</span><span class="c1"></span>       	<span class="nx">LastLogTerm</span>  <span class="kt">uint64</span> <span class="s">`json:&#34;last_log_term&#34;`</span>
<span class="p">}</span>

<span class="c1">// requestVoteResponse represents the response to a requestVote RPC.
</span><span class="c1">// 投票应答
</span><span class="c1"></span><span class="kd">type</span> <span class="nx">requestVoteResponse</span> <span class="kd">struct</span> <span class="p">{</span>
        <span class="c1">// 应答者任期号
</span><span class="c1"></span>       	<span class="nx">Term</span>        <span class="kt">uint64</span> <span class="s">`json:&#34;term&#34;`</span>
   	    <span class="c1">// 应答结果，true赞同，false反对
</span><span class="c1"></span>       	<span class="nx">VoteGranted</span> <span class="kt">bool</span>   <span class="s">`json:&#34;vote_granted&#34;`</span>
        <span class="c1">// 反对原因
</span><span class="c1"></span>       	<span class="nx">reason</span>      <span class="kt">string</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<h3 id="log-go">log.go</h3>

<p><img src="http://laohanlinux.github.io/images/img/raft-rs.png" alt="" /></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span><span class="lnt">177
</span><span class="lnt">178
</span><span class="lnt">179
</span><span class="lnt">180
</span><span class="lnt">181
</span><span class="lnt">182
</span><span class="lnt">183
</span><span class="lnt">184
</span><span class="lnt">185
</span><span class="lnt">186
</span><span class="lnt">187
</span><span class="lnt">188
</span><span class="lnt">189
</span><span class="lnt">190
</span><span class="lnt">191
</span><span class="lnt">192
</span><span class="lnt">193
</span><span class="lnt">194
</span><span class="lnt">195
</span><span class="lnt">196
</span><span class="lnt">197
</span><span class="lnt">198
</span><span class="lnt">199
</span><span class="lnt">200
</span><span class="lnt">201
</span><span class="lnt">202
</span><span class="lnt">203
</span><span class="lnt">204
</span><span class="lnt">205
</span><span class="lnt">206
</span><span class="lnt">207
</span><span class="lnt">208
</span><span class="lnt">209
</span><span class="lnt">210
</span><span class="lnt">211
</span><span class="lnt">212
</span><span class="lnt">213
</span><span class="lnt">214
</span><span class="lnt">215
</span><span class="lnt">216
</span><span class="lnt">217
</span><span class="lnt">218
</span><span class="lnt">219
</span><span class="lnt">220
</span><span class="lnt">221
</span><span class="lnt">222
</span><span class="lnt">223
</span><span class="lnt">224
</span><span class="lnt">225
</span><span class="lnt">226
</span><span class="lnt">227
</span><span class="lnt">228
</span><span class="lnt">229
</span><span class="lnt">230
</span><span class="lnt">231
</span><span class="lnt">232
</span><span class="lnt">233
</span><span class="lnt">234
</span><span class="lnt">235
</span><span class="lnt">236
</span><span class="lnt">237
</span><span class="lnt">238
</span><span class="lnt">239
</span><span class="lnt">240
</span><span class="lnt">241
</span><span class="lnt">242
</span><span class="lnt">243
</span><span class="lnt">244
</span><span class="lnt">245
</span><span class="lnt">246
</span><span class="lnt">247
</span><span class="lnt">248
</span><span class="lnt">249
</span><span class="lnt">250
</span><span class="lnt">251
</span><span class="lnt">252
</span><span class="lnt">253
</span><span class="lnt">254
</span><span class="lnt">255
</span><span class="lnt">256
</span><span class="lnt">257
</span><span class="lnt">258
</span><span class="lnt">259
</span><span class="lnt">260
</span><span class="lnt">261
</span><span class="lnt">262
</span><span class="lnt">263
</span><span class="lnt">264
</span><span class="lnt">265
</span><span class="lnt">266
</span><span class="lnt">267
</span><span class="lnt">268
</span><span class="lnt">269
</span><span class="lnt">270
</span><span class="lnt">271
</span><span class="lnt">272
</span><span class="lnt">273
</span><span class="lnt">274
</span><span class="lnt">275
</span><span class="lnt">276
</span><span class="lnt">277
</span><span class="lnt">278
</span><span class="lnt">279
</span><span class="lnt">280
</span><span class="lnt">281
</span><span class="lnt">282
</span><span class="lnt">283
</span><span class="lnt">284
</span><span class="lnt">285
</span><span class="lnt">286
</span><span class="lnt">287
</span><span class="lnt">288
</span><span class="lnt">289
</span><span class="lnt">290
</span><span class="lnt">291
</span><span class="lnt">292
</span><span class="lnt">293
</span><span class="lnt">294
</span><span class="lnt">295
</span><span class="lnt">296
</span><span class="lnt">297
</span><span class="lnt">298
</span><span class="lnt">299
</span><span class="lnt">300
</span><span class="lnt">301
</span><span class="lnt">302
</span><span class="lnt">303
</span><span class="lnt">304
</span><span class="lnt">305
</span><span class="lnt">306
</span><span class="lnt">307
</span><span class="lnt">308
</span><span class="lnt">309
</span><span class="lnt">310
</span><span class="lnt">311
</span><span class="lnt">312
</span><span class="lnt">313
</span><span class="lnt">314
</span><span class="lnt">315
</span><span class="lnt">316
</span><span class="lnt">317
</span><span class="lnt">318
</span><span class="lnt">319
</span><span class="lnt">320
</span><span class="lnt">321
</span><span class="lnt">322
</span><span class="lnt">323
</span><span class="lnt">324
</span><span class="lnt">325
</span><span class="lnt">326
</span><span class="lnt">327
</span><span class="lnt">328
</span><span class="lnt">329
</span><span class="lnt">330
</span><span class="lnt">331
</span><span class="lnt">332
</span><span class="lnt">333
</span><span class="lnt">334
</span><span class="lnt">335
</span><span class="lnt">336
</span><span class="lnt">337
</span><span class="lnt">338
</span><span class="lnt">339
</span><span class="lnt">340
</span><span class="lnt">341
</span><span class="lnt">342
</span><span class="lnt">343
</span><span class="lnt">344
</span><span class="lnt">345
</span><span class="lnt">346
</span><span class="lnt">347
</span><span class="lnt">348
</span><span class="lnt">349
</span><span class="lnt">350
</span><span class="lnt">351
</span><span class="lnt">352
</span><span class="lnt">353
</span><span class="lnt">354
</span><span class="lnt">355
</span><span class="lnt">356
</span><span class="lnt">357
</span><span class="lnt">358
</span><span class="lnt">359
</span><span class="lnt">360
</span><span class="lnt">361
</span><span class="lnt">362
</span><span class="lnt">363
</span><span class="lnt">364
</span><span class="lnt">365
</span><span class="lnt">366
</span><span class="lnt">367
</span><span class="lnt">368
</span><span class="lnt">369
</span><span class="lnt">370
</span><span class="lnt">371
</span><span class="lnt">372
</span><span class="lnt">373
</span><span class="lnt">374
</span><span class="lnt">375
</span><span class="lnt">376
</span><span class="lnt">377
</span><span class="lnt">378
</span><span class="lnt">379
</span><span class="lnt">380
</span><span class="lnt">381
</span><span class="lnt">382
</span><span class="lnt">383
</span><span class="lnt">384
</span><span class="lnt">385
</span><span class="lnt">386
</span><span class="lnt">387
</span><span class="lnt">388
</span><span class="lnt">389
</span><span class="lnt">390
</span><span class="lnt">391
</span><span class="lnt">392
</span><span class="lnt">393
</span><span class="lnt">394
</span><span class="lnt">395
</span><span class="lnt">396
</span><span class="lnt">397
</span><span class="lnt">398
</span><span class="lnt">399
</span><span class="lnt">400
</span><span class="lnt">401
</span><span class="lnt">402
</span><span class="lnt">403
</span><span class="lnt">404
</span><span class="lnt">405
</span><span class="lnt">406
</span><span class="lnt">407
</span><span class="lnt">408
</span><span class="lnt">409
</span><span class="lnt">410
</span><span class="lnt">411
</span><span class="lnt">412
</span><span class="lnt">413
</span><span class="lnt">414
</span><span class="lnt">415
</span><span class="lnt">416
</span><span class="lnt">417
</span><span class="lnt">418
</span><span class="lnt">419
</span><span class="lnt">420
</span><span class="lnt">421
</span><span class="lnt">422
</span><span class="lnt">423
</span><span class="lnt">424
</span><span class="lnt">425
</span><span class="lnt">426
</span><span class="lnt">427
</span><span class="lnt">428
</span><span class="lnt">429
</span><span class="lnt">430
</span><span class="lnt">431
</span><span class="lnt">432
</span><span class="lnt">433
</span><span class="lnt">434
</span><span class="lnt">435
</span><span class="lnt">436
</span><span class="lnt">437
</span><span class="lnt">438
</span><span class="lnt">439
</span><span class="lnt">440
</span><span class="lnt">441
</span><span class="lnt">442
</span><span class="lnt">443
</span><span class="lnt">444
</span><span class="lnt">445
</span><span class="lnt">446
</span><span class="lnt">447
</span><span class="lnt">448
</span><span class="lnt">449
</span><span class="lnt">450
</span><span class="lnt">451
</span><span class="lnt">452
</span><span class="lnt">453
</span><span class="lnt">454
</span><span class="lnt">455
</span><span class="lnt">456
</span><span class="lnt">457
</span><span class="lnt">458
</span><span class="lnt">459
</span><span class="lnt">460
</span><span class="lnt">461
</span><span class="lnt">462
</span><span class="lnt">463
</span><span class="lnt">464
</span><span class="lnt">465
</span><span class="lnt">466
</span><span class="lnt">467
</span><span class="lnt">468
</span><span class="lnt">469
</span><span class="lnt">470
</span><span class="lnt">471
</span><span class="lnt">472
</span><span class="lnt">473
</span><span class="lnt">474
</span><span class="lnt">475
</span><span class="lnt">476
</span><span class="lnt">477
</span><span class="lnt">478
</span><span class="lnt">479
</span><span class="lnt">480
</span><span class="lnt">481
</span><span class="lnt">482
</span><span class="lnt">483
</span><span class="lnt">484
</span><span class="lnt">485
</span><span class="lnt">486
</span><span class="lnt">487
</span><span class="lnt">488
</span><span class="lnt">489
</span><span class="lnt">490
</span><span class="lnt">491
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="kd">var</span> <span class="p">(</span>
        <span class="c1">// 任期号太小
</span><span class="c1"></span>       	<span class="nx">errTermTooSmall</span>    <span class="p">=</span> <span class="nx">errors</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span><span class="s">&#34;term too small&#34;</span><span class="p">)</span>
       	<span class="c1">// 日志索引太小
</span><span class="c1"></span>       	<span class="nx">errIndexTooSmall</span>   <span class="p">=</span> <span class="nx">errors</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span><span class="s">&#34;index too small&#34;</span><span class="p">)</span>
       	<span class="c1">// 日志缩影太大
</span><span class="c1"></span>       	<span class="nx">errIndexTooBig</span>     <span class="p">=</span> <span class="nx">errors</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span><span class="s">&#34;commit index too big&#34;</span><span class="p">)</span>
       	<span class="c1">// 日志条目内容已损坏
</span><span class="c1"></span>       	<span class="nx">errInvalidChecksum</span> <span class="p">=</span> <span class="nx">errors</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span><span class="s">&#34;invalid checksum&#34;</span><span class="p">)</span>
	   <span class="c1">// 无效的命令
</span><span class="c1"></span>       	<span class="nx">errNoCommand</span>       <span class="p">=</span> <span class="nx">errors</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span><span class="s">&#34;no command&#34;</span><span class="p">)</span>
       	<span class="c1">// 错误的日志索引
</span><span class="c1"></span>       	<span class="nx">errBadIndex</span>        <span class="p">=</span> <span class="nx">errors</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span><span class="s">&#34;bad index&#34;</span><span class="p">)</span>
       	<span class="c1">// 错误任期号
</span><span class="c1"></span>       	<span class="nx">errBadTerm</span>         <span class="p">=</span> <span class="nx">errors</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span><span class="s">&#34;bad term&#34;</span><span class="p">)</span>
<span class="p">)</span>
<span class="c1">// 日志结构
</span><span class="c1"></span><span class="kd">type</span> <span class="nx">raftLog</span> <span class="kd">struct</span> <span class="p">{</span>
        <span class="c1">// 日志读写锁
</span><span class="c1"></span>       	<span class="nx">sync</span><span class="p">.</span><span class="nx">RWMutex</span>
       	<span class="c1">// 日志存储接口
</span><span class="c1"></span>       	<span class="nx">store</span>     <span class="nx">io</span><span class="p">.</span><span class="nx">Writer</span>
   	    <span class="c1">// 日志镜像，现在存储于内存
</span><span class="c1"></span>       	<span class="nx">entries</span>   <span class="p">[]</span><span class="nx">logEntry</span>
       	<span class="c1">// 下一条日志commit索引
</span><span class="c1"></span>       	<span class="nx">commitPos</span> <span class="kt">int</span>
       	<span class="c1">// &#34;操作&#34;的回调函数，这个函数比较重要，可以&#34;操作集合&#34;镜像，
</span><span class="c1"></span>       	<span class="c1">// 在快照时，只需要将&#34;结果&#34;快到存储层即可
</span><span class="c1"></span>       	<span class="nx">apply</span>     <span class="kd">func</span><span class="p">(</span><span class="kt">uint64</span><span class="p">,</span> <span class="p">[]</span><span class="kt">byte</span><span class="p">)</span> <span class="p">[]</span><span class="kt">byte</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">newRaftLog</span><span class="p">(</span><span class="nx">store</span> <span class="nx">io</span><span class="p">.</span><span class="nx">ReadWriter</span><span class="p">,</span> <span class="nx">apply</span> <span class="kd">func</span><span class="p">(</span><span class="kt">uint64</span><span class="p">,</span> <span class="p">[]</span><span class="kt">byte</span><span class="p">)</span> <span class="p">[]</span><span class="kt">byte</span><span class="p">)</span> <span class="o">*</span><span class="nx">raftLog</span> <span class="p">{</span>
       	<span class="nx">l</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">raftLog</span><span class="p">{</span>
       		<span class="nx">store</span><span class="p">:</span>     <span class="nx">store</span><span class="p">,</span>
       		<span class="nx">entries</span><span class="p">:</span>   <span class="p">[]</span><span class="nx">logEntry</span><span class="p">{},</span>
       		<span class="nx">commitPos</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="c1">// no commits to begin with
</span><span class="c1"></span>       		<span class="nx">apply</span><span class="p">:</span>     <span class="nx">apply</span><span class="p">,</span>
       	<span class="p">}</span>
       	<span class="nx">l</span><span class="p">.</span><span class="nb">recover</span><span class="p">(</span><span class="nx">store</span><span class="p">)</span>
       	<span class="k">return</span> <span class="nx">l</span>
<span class="p">}</span>

<span class="c1">// recover reads from the log&#39;s store, to populate the log with log entries
</span><span class="c1">// from persistent storage. It should be called once, at log instantiation.
</span><span class="c1">// 日志恢复，当服务重启时，重建日志条目(一般重建都是居于于快照和日志的，可是这里没有实现快照，所以从日志中重建即可)
</span><span class="c1">// 1、这里的日志时commited之后的日志，所以重建时，commitPos也会更新
</span><span class="c1">// 2、重建日志条目，会调用apply函数，对日志进行处理，这个函数相当于&#34;状态机&#34;功能；如果有快照(相当于Redis 的RDB)，先将安装快照，再恢复日志(相当于Redis 的aof)
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">l</span> <span class="o">*</span><span class="nx">raftLog</span><span class="p">)</span> <span class="nb">recover</span><span class="p">(</span><span class="nx">r</span> <span class="nx">io</span><span class="p">.</span><span class="nx">Reader</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
       	<span class="k">for</span> <span class="p">{</span>
       		<span class="kd">var</span> <span class="nx">entry</span> <span class="nx">logEntry</span>
       		<span class="k">switch</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">entry</span><span class="p">.</span><span class="nf">decode</span><span class="p">(</span><span class="nx">r</span><span class="p">);</span> <span class="nx">err</span> <span class="p">{</span>
       		<span class="k">case</span> <span class="nx">io</span><span class="p">.</span><span class="nx">EOF</span><span class="p">:</span>
       			<span class="k">return</span> <span class="kc">nil</span> <span class="c1">// successful completion
</span><span class="c1"></span>       		<span class="k">case</span> <span class="kc">nil</span><span class="p">:</span>
       			<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">l</span><span class="p">.</span><span class="nf">appendEntry</span><span class="p">(</span><span class="nx">entry</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
       				<span class="k">return</span> <span class="nx">err</span>
       			<span class="p">}</span>
       			<span class="nx">l</span><span class="p">.</span><span class="nx">commitPos</span><span class="o">++</span>
       			<span class="nx">l</span><span class="p">.</span><span class="nf">apply</span><span class="p">(</span><span class="nx">entry</span><span class="p">.</span><span class="nx">Index</span><span class="p">,</span> <span class="nx">entry</span><span class="p">.</span><span class="nx">Command</span><span class="p">)</span>
       		<span class="k">default</span><span class="p">:</span>
       			<span class="k">return</span> <span class="nx">err</span> <span class="c1">// unsuccessful completion
</span><span class="c1"></span>       		<span class="p">}</span>
       	<span class="p">}</span>
<span class="p">}</span>

<span class="c1">// entriesAfter returns a slice of log entries after (i.e. not including) the
</span><span class="c1">// passed index, and the term of the log entry specified by index, as a
</span><span class="c1">// convenience to the caller. (This function is only used by a leader attempting
</span><span class="c1">// to flush log entries to its followers.)
</span><span class="c1">//
</span><span class="c1">// This function is called to populate an AppendEntries RPC. That implies they
</span><span class="c1">// are destined for a follower, which implies the application of the commands
</span><span class="c1">// should have the response thrown away, which implies we shouldn&#39;t pass a
</span><span class="c1">// commandResponse channel (see: commitTo implementation). In the normal case,
</span><span class="c1">// the raftLogEntries we return here will get serialized as they pass thru their
</span><span class="c1">// transport, and lose their commandResponse channel anyway. But in the case of
</span><span class="c1">// a LocalPeer (or equivalent) this doesn&#39;t happen. So, we must make sure to
</span><span class="c1">// proactively strip commandResponse channels.
</span><span class="c1">// 检索index之后的日志条目
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">l</span> <span class="o">*</span><span class="nx">raftLog</span><span class="p">)</span> <span class="nf">entriesAfter</span><span class="p">(</span><span class="nx">index</span> <span class="kt">uint64</span><span class="p">)</span> <span class="p">([]</span><span class="nx">logEntry</span><span class="p">,</span> <span class="kt">uint64</span><span class="p">)</span> <span class="p">{</span>
       	<span class="nx">l</span><span class="p">.</span><span class="nf">RLock</span><span class="p">()</span>
       	<span class="k">defer</span> <span class="nx">l</span><span class="p">.</span><span class="nf">RUnlock</span><span class="p">()</span>

  		<span class="c1">// 1.检索出index对应term以及在实体集合entries中的位置Pos
</span><span class="c1"></span>       	<span class="nx">pos</span> <span class="o">:=</span> <span class="mi">0</span>
       	<span class="nx">lastTerm</span> <span class="o">:=</span> <span class="nb">uint64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
       	<span class="k">for</span> <span class="p">;</span> <span class="nx">pos</span> <span class="p">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="nx">l</span><span class="p">.</span><span class="nx">entries</span><span class="p">);</span> <span class="nx">pos</span><span class="o">++</span> <span class="p">{</span>
       		<span class="k">if</span> <span class="nx">l</span><span class="p">.</span><span class="nx">entries</span><span class="p">[</span><span class="nx">pos</span><span class="p">].</span><span class="nx">Index</span> <span class="p">&gt;</span> <span class="nx">index</span> <span class="p">{</span>
       			<span class="k">break</span>
       		<span class="p">}</span>
       		<span class="nx">lastTerm</span> <span class="p">=</span> <span class="nx">l</span><span class="p">.</span><span class="nx">entries</span><span class="p">[</span><span class="nx">pos</span><span class="p">].</span><span class="nx">Term</span>
       	<span class="p">}</span>

       	<span class="nx">a</span> <span class="o">:=</span> <span class="nx">l</span><span class="p">.</span><span class="nx">entries</span><span class="p">[</span><span class="nx">pos</span><span class="p">:]</span>
       	<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nx">a</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">{</span>
       		<span class="k">return</span> <span class="p">[]</span><span class="nx">logEntry</span><span class="p">{},</span> <span class="nx">lastTerm</span>
       	<span class="p">}</span>
		<span class="c1">// 除去command Response channel
</span><span class="c1"></span>       	<span class="k">return</span> <span class="nf">stripResponseChannels</span><span class="p">(</span><span class="nx">a</span><span class="p">),</span> <span class="nx">lastTerm</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">stripResponseChannels</span><span class="p">(</span><span class="nx">a</span> <span class="p">[]</span><span class="nx">logEntry</span><span class="p">)</span> <span class="p">[]</span><span class="nx">logEntry</span> <span class="p">{</span>
       	<span class="nx">stripped</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">([]</span><span class="nx">logEntry</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="nx">a</span><span class="p">))</span>
       	<span class="k">for</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">entry</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">a</span> <span class="p">{</span>
       		<span class="nx">stripped</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="p">=</span> <span class="nx">logEntry</span><span class="p">{</span>
       			<span class="nx">Index</span><span class="p">:</span>           <span class="nx">entry</span><span class="p">.</span><span class="nx">Index</span><span class="p">,</span>
       			<span class="nx">Term</span><span class="p">:</span>            <span class="nx">entry</span><span class="p">.</span><span class="nx">Term</span><span class="p">,</span>
       			<span class="nx">Command</span><span class="p">:</span>         <span class="nx">entry</span><span class="p">.</span><span class="nx">Command</span><span class="p">,</span>
       			<span class="nx">commandResponse</span><span class="p">:</span> <span class="kc">nil</span><span class="p">,</span>
       		<span class="p">}</span>
       	<span class="p">}</span>
       	<span class="k">return</span> <span class="nx">stripped</span>
<span class="p">}</span>

<span class="c1">// contains returns true if a log entry with the given index and term exists in
</span><span class="c1">// the log.
</span><span class="c1">// 判断是够包含{term, index}条目
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">l</span> <span class="o">*</span><span class="nx">raftLog</span><span class="p">)</span> <span class="nf">contains</span><span class="p">(</span><span class="nx">index</span><span class="p">,</span> <span class="nx">term</span> <span class="kt">uint64</span><span class="p">)</span> <span class="kt">bool</span> <span class="p">{</span>
       	<span class="nx">l</span><span class="p">.</span><span class="nf">RLock</span><span class="p">()</span>
       	<span class="k">defer</span> <span class="nx">l</span><span class="p">.</span><span class="nf">RUnlock</span><span class="p">()</span>

       	<span class="c1">// It&#39;s not necessarily true that l.entries[i] has index == i.
</span><span class="c1"></span>       	<span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">entry</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">l</span><span class="p">.</span><span class="nx">entries</span> <span class="p">{</span>
       		<span class="k">if</span> <span class="nx">entry</span><span class="p">.</span><span class="nx">Index</span> <span class="o">==</span> <span class="nx">index</span> <span class="o">&amp;&amp;</span> <span class="nx">entry</span><span class="p">.</span><span class="nx">Term</span> <span class="o">==</span> <span class="nx">term</span> <span class="p">{</span>
       			<span class="k">return</span> <span class="kc">true</span>
       		<span class="p">}</span>
       		<span class="k">if</span> <span class="nx">entry</span><span class="p">.</span><span class="nx">Index</span> <span class="p">&gt;</span> <span class="nx">index</span> <span class="o">||</span> <span class="nx">entry</span><span class="p">.</span><span class="nx">Term</span> <span class="p">&gt;</span> <span class="nx">term</span> <span class="p">{</span>
       			<span class="k">break</span>
       		<span class="p">}</span>
       	<span class="p">}</span>
       	<span class="k">return</span> <span class="kc">false</span>
<span class="p">}</span>

<span class="c1">// 判断{term, index}是否为最新的日志条目，如果是,则将则将在其之后的日志清理掉,
</span><span class="c1">// 这个条目应该在[commit_index, last_index]范围内
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">l</span> <span class="o">*</span><span class="nx">raftLog</span><span class="p">)</span> <span class="nf">ensureLastIs</span><span class="p">(</span><span class="nx">index</span><span class="p">,</span> <span class="nx">term</span> <span class="kt">uint64</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
       	<span class="nx">l</span><span class="p">.</span><span class="nf">Lock</span><span class="p">()</span>
       	<span class="k">defer</span> <span class="nx">l</span><span class="p">.</span><span class="nf">Unlock</span><span class="p">()</span>

       	<span class="c1">// Taken loosely from benbjohnson&#39;s impl
</span><span class="c1"></span>
       	<span class="k">if</span> <span class="nx">index</span> <span class="p">&lt;</span> <span class="nx">l</span><span class="p">.</span><span class="nf">getCommitIndexWithLock</span><span class="p">()</span> <span class="p">{</span>
       		<span class="k">return</span> <span class="nx">errIndexTooSmall</span>
       	<span class="p">}</span>

       	<span class="k">if</span> <span class="nx">index</span> <span class="p">&gt;</span> <span class="nx">l</span><span class="p">.</span><span class="nf">lastIndexWithLock</span><span class="p">()</span> <span class="p">{</span>
       		<span class="k">return</span> <span class="nx">errIndexTooBig</span>
       	<span class="p">}</span>

       	<span class="c1">// It&#39;s possible that the passed index is 0. It means the leader has come to
</span><span class="c1"></span>       	<span class="c1">// decide we need a complete log rebuild. Of course, that&#39;s only valid if we
</span><span class="c1"></span>       	<span class="c1">// haven&#39;t committed anything, so this check comes after that one.
</span><span class="c1"></span>  		<span class="c1">// 全部重建，前提是没有commited过任何的条目
</span><span class="c1"></span>       	<span class="k">if</span> <span class="nx">index</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">{</span>
       		<span class="k">for</span> <span class="nx">pos</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">pos</span> <span class="p">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="nx">l</span><span class="p">.</span><span class="nx">entries</span><span class="p">);</span> <span class="nx">pos</span><span class="o">++</span> <span class="p">{</span>
       			<span class="k">if</span> <span class="nx">l</span><span class="p">.</span><span class="nx">entries</span><span class="p">[</span><span class="nx">pos</span><span class="p">].</span><span class="nx">commandResponse</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
       				<span class="nb">close</span><span class="p">(</span><span class="nx">l</span><span class="p">.</span><span class="nx">entries</span><span class="p">[</span><span class="nx">pos</span><span class="p">].</span><span class="nx">commandResponse</span><span class="p">)</span>
       				<span class="nx">l</span><span class="p">.</span><span class="nx">entries</span><span class="p">[</span><span class="nx">pos</span><span class="p">].</span><span class="nx">commandResponse</span> <span class="p">=</span> <span class="kc">nil</span>
       			<span class="p">}</span>
       			<span class="k">if</span> <span class="nx">l</span><span class="p">.</span><span class="nx">entries</span><span class="p">[</span><span class="nx">pos</span><span class="p">].</span><span class="nx">committed</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
       				<span class="nx">l</span><span class="p">.</span><span class="nx">entries</span><span class="p">[</span><span class="nx">pos</span><span class="p">].</span><span class="nx">committed</span> <span class="o">&lt;-</span> <span class="kc">false</span>
       				<span class="nb">close</span><span class="p">(</span><span class="nx">l</span><span class="p">.</span><span class="nx">entries</span><span class="p">[</span><span class="nx">pos</span><span class="p">].</span><span class="nx">committed</span><span class="p">)</span>
       				<span class="nx">l</span><span class="p">.</span><span class="nx">entries</span><span class="p">[</span><span class="nx">pos</span><span class="p">].</span><span class="nx">committed</span> <span class="p">=</span> <span class="kc">nil</span>
       			<span class="p">}</span>
       		<span class="p">}</span>
       		<span class="nx">l</span><span class="p">.</span><span class="nx">entries</span> <span class="p">=</span> <span class="p">[]</span><span class="nx">logEntry</span><span class="p">{}</span>
       		<span class="k">return</span> <span class="kc">nil</span>
       	<span class="p">}</span>

       	<span class="c1">// Normal case: find the position of the matching log entry.
</span><span class="c1"></span>       	<span class="nx">pos</span> <span class="o">:=</span> <span class="mi">0</span>
       	<span class="k">for</span> <span class="p">;</span> <span class="nx">pos</span> <span class="p">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="nx">l</span><span class="p">.</span><span class="nx">entries</span><span class="p">);</span> <span class="nx">pos</span><span class="o">++</span> <span class="p">{</span>
       		<span class="k">if</span> <span class="nx">l</span><span class="p">.</span><span class="nx">entries</span><span class="p">[</span><span class="nx">pos</span><span class="p">].</span><span class="nx">Index</span> <span class="p">&lt;</span> <span class="nx">index</span> <span class="p">{</span>
       			<span class="k">continue</span> <span class="c1">// didn&#39;t find it yet
</span><span class="c1"></span>       		<span class="p">}</span>
       		<span class="k">if</span> <span class="nx">l</span><span class="p">.</span><span class="nx">entries</span><span class="p">[</span><span class="nx">pos</span><span class="p">].</span><span class="nx">Index</span> <span class="p">&gt;</span> <span class="nx">index</span> <span class="p">{</span>
       			<span class="k">return</span> <span class="nx">errBadIndex</span> <span class="c1">// somehow went past it
</span><span class="c1"></span>       		<span class="p">}</span>
       		<span class="k">if</span> <span class="nx">l</span><span class="p">.</span><span class="nx">entries</span><span class="p">[</span><span class="nx">pos</span><span class="p">].</span><span class="nx">Index</span> <span class="o">!=</span> <span class="nx">index</span> <span class="p">{</span>
       			<span class="nb">panic</span><span class="p">(</span><span class="s">&#34;not &lt;, not &gt;, but somehow !=&#34;</span><span class="p">)</span>
       		<span class="p">}</span>
       		<span class="k">if</span> <span class="nx">l</span><span class="p">.</span><span class="nx">entries</span><span class="p">[</span><span class="nx">pos</span><span class="p">].</span><span class="nx">Term</span> <span class="o">!=</span> <span class="nx">term</span> <span class="p">{</span>
       			<span class="k">return</span> <span class="nx">errBadTerm</span>
       		<span class="p">}</span>
       		<span class="k">break</span> <span class="c1">// good
</span><span class="c1"></span>       	<span class="p">}</span>

       	<span class="c1">// Sanity check.
</span><span class="c1"></span>        <span class="c1">// ? 怎么可能出现这种情况？
</span><span class="c1"></span>       	<span class="k">if</span> <span class="nx">pos</span> <span class="p">&lt;</span> <span class="nx">l</span><span class="p">.</span><span class="nx">commitPos</span> <span class="p">{</span>
       		<span class="nb">panic</span><span class="p">(</span><span class="s">&#34;index &gt;= commitIndex, but pos &lt; commitPos&#34;</span><span class="p">)</span>
       	<span class="p">}</span>

       	<span class="c1">// `pos` is the position of log entry matching index and term.
</span><span class="c1"></span>       	<span class="c1">// We want to truncate everything after that.
</span><span class="c1"></span>  		<span class="c1">// 应为{term, index}是最新的了，所以将在其之后的所有条目给cut掉
</span><span class="c1"></span>       	<span class="nx">truncateFrom</span> <span class="o">:=</span> <span class="nx">pos</span> <span class="o">+</span> <span class="mi">1</span>
       	<span class="k">if</span> <span class="nx">truncateFrom</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="nx">l</span><span class="p">.</span><span class="nx">entries</span><span class="p">)</span> <span class="p">{</span>
       		<span class="k">return</span> <span class="kc">nil</span> <span class="c1">// nothing to truncate
</span><span class="c1"></span>       	<span class="p">}</span>

       	<span class="c1">// If we blow away log entries that haven&#39;t yet sent responses to clients,
</span><span class="c1"></span>       	<span class="c1">// signal the clients to stop waiting, by closing the channel without a
</span><span class="c1"></span>       	<span class="c1">// response value.
</span><span class="c1"></span>       	<span class="k">for</span> <span class="nx">pos</span> <span class="p">=</span> <span class="nx">truncateFrom</span><span class="p">;</span> <span class="nx">pos</span> <span class="p">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="nx">l</span><span class="p">.</span><span class="nx">entries</span><span class="p">);</span> <span class="nx">pos</span><span class="o">++</span> <span class="p">{</span>
       		<span class="k">if</span> <span class="nx">l</span><span class="p">.</span><span class="nx">entries</span><span class="p">[</span><span class="nx">pos</span><span class="p">].</span><span class="nx">commandResponse</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
       			<span class="nb">close</span><span class="p">(</span><span class="nx">l</span><span class="p">.</span><span class="nx">entries</span><span class="p">[</span><span class="nx">pos</span><span class="p">].</span><span class="nx">commandResponse</span><span class="p">)</span>
       			<span class="nx">l</span><span class="p">.</span><span class="nx">entries</span><span class="p">[</span><span class="nx">pos</span><span class="p">].</span><span class="nx">commandResponse</span> <span class="p">=</span> <span class="kc">nil</span>
       		<span class="p">}</span>
       		<span class="k">if</span> <span class="nx">l</span><span class="p">.</span><span class="nx">entries</span><span class="p">[</span><span class="nx">pos</span><span class="p">].</span><span class="nx">committed</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
       			<span class="nx">l</span><span class="p">.</span><span class="nx">entries</span><span class="p">[</span><span class="nx">pos</span><span class="p">].</span><span class="nx">committed</span> <span class="o">&lt;-</span> <span class="kc">false</span>
       			<span class="nb">close</span><span class="p">(</span><span class="nx">l</span><span class="p">.</span><span class="nx">entries</span><span class="p">[</span><span class="nx">pos</span><span class="p">].</span><span class="nx">committed</span><span class="p">)</span>
       			<span class="nx">l</span><span class="p">.</span><span class="nx">entries</span><span class="p">[</span><span class="nx">pos</span><span class="p">].</span><span class="nx">committed</span> <span class="p">=</span> <span class="kc">nil</span>
       		<span class="p">}</span>
       	<span class="p">}</span>

       	<span class="c1">// Truncate the log.
</span><span class="c1"></span>       	<span class="nx">l</span><span class="p">.</span><span class="nx">entries</span> <span class="p">=</span> <span class="nx">l</span><span class="p">.</span><span class="nx">entries</span><span class="p">[:</span><span class="nx">truncateFrom</span><span class="p">]</span>

       	<span class="c1">// Done.
</span><span class="c1"></span>       	<span class="k">return</span> <span class="kc">nil</span>
<span class="p">}</span>

<span class="c1">// getCommitIndex returns the commit index of the log. That is, the index of the
</span><span class="c1">// last log entry which can be considered committed.
</span><span class="c1">// 获取最新的commited日志条目
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">l</span> <span class="o">*</span><span class="nx">raftLog</span><span class="p">)</span> <span class="nf">getCommitIndex</span><span class="p">()</span> <span class="kt">uint64</span> <span class="p">{</span>
       	<span class="nx">l</span><span class="p">.</span><span class="nf">RLock</span><span class="p">()</span>
       	<span class="k">defer</span> <span class="nx">l</span><span class="p">.</span><span class="nf">RUnlock</span><span class="p">()</span>
       	<span class="k">return</span> <span class="nx">l</span><span class="p">.</span><span class="nf">getCommitIndexWithLock</span><span class="p">()</span>
<span class="p">}</span>

<span class="c1">// 获取最新的日志条目
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">l</span> <span class="o">*</span><span class="nx">raftLog</span><span class="p">)</span> <span class="nf">getCommitIndexWithLock</span><span class="p">()</span> <span class="kt">uint64</span> <span class="p">{</span>
       	<span class="k">if</span> <span class="nx">l</span><span class="p">.</span><span class="nx">commitPos</span> <span class="p">&lt;</span> <span class="mi">0</span> <span class="p">{</span>
       		<span class="k">return</span> <span class="mi">0</span>
       	<span class="p">}</span>
       	<span class="k">if</span> <span class="nx">l</span><span class="p">.</span><span class="nx">commitPos</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="nx">l</span><span class="p">.</span><span class="nx">entries</span><span class="p">)</span> <span class="p">{</span>
       		<span class="nb">panic</span><span class="p">(</span><span class="nx">fmt</span><span class="p">.</span><span class="nf">Sprintf</span><span class="p">(</span><span class="s">&#34;commitPos %d &gt; len(l.entries) %d; bad bookkeeping in raftLog&#34;</span><span class="p">,</span> <span class="nx">l</span><span class="p">.</span><span class="nx">commitPos</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="nx">l</span><span class="p">.</span><span class="nx">entries</span><span class="p">)))</span>
       	<span class="p">}</span>
       	<span class="k">return</span> <span class="nx">l</span><span class="p">.</span><span class="nx">entries</span><span class="p">[</span><span class="nx">l</span><span class="p">.</span><span class="nx">commitPos</span><span class="p">].</span><span class="nx">Index</span>
<span class="p">}</span>

<span class="c1">// lastIndex returns the index of the most recent log entry.
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">l</span> <span class="o">*</span><span class="nx">raftLog</span><span class="p">)</span> <span class="nf">lastIndex</span><span class="p">()</span> <span class="kt">uint64</span> <span class="p">{</span>
       	<span class="nx">l</span><span class="p">.</span><span class="nf">RLock</span><span class="p">()</span>
       	<span class="k">defer</span> <span class="nx">l</span><span class="p">.</span><span class="nf">RUnlock</span><span class="p">()</span>
       	<span class="k">return</span> <span class="nx">l</span><span class="p">.</span><span class="nf">lastIndexWithLock</span><span class="p">()</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">l</span> <span class="o">*</span><span class="nx">raftLog</span><span class="p">)</span> <span class="nf">lastIndexWithLock</span><span class="p">()</span> <span class="kt">uint64</span> <span class="p">{</span>
       	<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nx">l</span><span class="p">.</span><span class="nx">entries</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="p">{</span>
       		<span class="k">return</span> <span class="mi">0</span>
       	<span class="p">}</span>
       	<span class="k">return</span> <span class="nx">l</span><span class="p">.</span><span class="nx">entries</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="nx">l</span><span class="p">.</span><span class="nx">entries</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="nx">Index</span>
<span class="p">}</span>

<span class="c1">// lastTerm returns the term of the most recent log entry.
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">l</span> <span class="o">*</span><span class="nx">raftLog</span><span class="p">)</span> <span class="nf">lastTerm</span><span class="p">()</span> <span class="kt">uint64</span> <span class="p">{</span>
       	<span class="nx">l</span><span class="p">.</span><span class="nf">RLock</span><span class="p">()</span>
       	<span class="k">defer</span> <span class="nx">l</span><span class="p">.</span><span class="nf">RUnlock</span><span class="p">()</span>
       	<span class="k">return</span> <span class="nx">l</span><span class="p">.</span><span class="nf">lastTermWithLock</span><span class="p">()</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">l</span> <span class="o">*</span><span class="nx">raftLog</span><span class="p">)</span> <span class="nf">lastTermWithLock</span><span class="p">()</span> <span class="kt">uint64</span> <span class="p">{</span>
       	<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nx">l</span><span class="p">.</span><span class="nx">entries</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="p">{</span>
       		<span class="k">return</span> <span class="mi">0</span>
       	<span class="p">}</span>
       	<span class="k">return</span> <span class="nx">l</span><span class="p">.</span><span class="nx">entries</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="nx">l</span><span class="p">.</span><span class="nx">entries</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="nx">Term</span>
<span class="p">}</span>

<span class="c1">// appendEntry appends the passed log entry to the log. It will return an error
</span><span class="c1">// if the entry&#39;s term is smaller than the log&#39;s most recent term, or if the
</span><span class="c1">// entry&#39;s index is too small relative to the log&#39;s most recent entry.
</span><span class="c1">// 追加日志，注意此时还没有commit该条目
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">l</span> <span class="o">*</span><span class="nx">raftLog</span><span class="p">)</span> <span class="nf">appendEntry</span><span class="p">(</span><span class="nx">entry</span> <span class="nx">logEntry</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
       	<span class="nx">l</span><span class="p">.</span><span class="nf">Lock</span><span class="p">()</span>
       	<span class="k">defer</span> <span class="nx">l</span><span class="p">.</span><span class="nf">Unlock</span><span class="p">()</span>
  		<span class="c1">// 判定{entry.term, entry.index} &gt; {last_term, last_index}
</span><span class="c1"></span>       	<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nx">l</span><span class="p">.</span><span class="nx">entries</span><span class="p">)</span> <span class="p">&gt;</span> <span class="mi">0</span> <span class="p">{</span>
       		<span class="nx">lastTerm</span> <span class="o">:=</span> <span class="nx">l</span><span class="p">.</span><span class="nf">lastTermWithLock</span><span class="p">()</span>
       		<span class="k">if</span> <span class="nx">entry</span><span class="p">.</span><span class="nx">Term</span> <span class="p">&lt;</span> <span class="nx">lastTerm</span> <span class="p">{</span>
       			<span class="k">return</span> <span class="nx">errTermTooSmall</span>
       		<span class="p">}</span>
       		<span class="nx">lastIndex</span> <span class="o">:=</span> <span class="nx">l</span><span class="p">.</span><span class="nf">lastIndexWithLock</span><span class="p">()</span>
       		<span class="k">if</span> <span class="nx">entry</span><span class="p">.</span><span class="nx">Term</span> <span class="o">==</span> <span class="nx">lastTerm</span> <span class="o">&amp;&amp;</span> <span class="nx">entry</span><span class="p">.</span><span class="nx">Index</span> <span class="o">&lt;=</span> <span class="nx">lastIndex</span> <span class="p">{</span>
       			<span class="k">return</span> <span class="nx">errIndexTooSmall</span>
       		<span class="p">}</span>
       	<span class="p">}</span>

       	<span class="nx">l</span><span class="p">.</span><span class="nx">entries</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">l</span><span class="p">.</span><span class="nx">entries</span><span class="p">,</span> <span class="nx">entry</span><span class="p">)</span>
       	<span class="k">return</span> <span class="kc">nil</span>
<span class="p">}</span>

<span class="c1">// commitTo commits all log entries up to and including the passed commitIndex.
</span><span class="c1">// Commit means: synchronize the log entry to persistent storage, and call the
</span><span class="c1">// state machine apply function for the log entry&#39;s command.
</span><span class="c1">// 注意:
</span><span class="c1">// 1、commit是一个后端任务，再此并没有&#34;1/2&#34;确认的概念(实际上是不是这样呢，这得去参考raft的论文了)
</span><span class="c1">// 2、apply函数是在commit过程中调用，而不是在append的时候调用
</span><span class="c1">// 3、apply相当于状态机函数，一般用户会将这些操作结果保存起来，用于快照
</span><span class="c1"></span>
<span class="c1">// 比如，想实现一个kv存储，那么用户只要将kv相关的逻辑植入这个函数即可
</span><span class="c1"></span>
<span class="c1">// committed &lt;= commitIndex &lt;= last_index
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">l</span> <span class="o">*</span><span class="nx">raftLog</span><span class="p">)</span> <span class="nf">commitTo</span><span class="p">(</span><span class="nx">commitIndex</span> <span class="kt">uint64</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
       	<span class="k">if</span> <span class="nx">commitIndex</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">{</span>
       		<span class="nb">panic</span><span class="p">(</span><span class="s">&#34;commitTo(0)&#34;</span><span class="p">)</span>
       	<span class="p">}</span>

       	<span class="nx">l</span><span class="p">.</span><span class="nf">Lock</span><span class="p">()</span>
       	<span class="k">defer</span> <span class="nx">l</span><span class="p">.</span><span class="nf">Unlock</span><span class="p">()</span>

       	<span class="c1">// Reject old commit indexes
</span><span class="c1"></span>       	<span class="k">if</span> <span class="nx">commitIndex</span> <span class="p">&lt;</span> <span class="nx">l</span><span class="p">.</span><span class="nf">getCommitIndexWithLock</span><span class="p">()</span> <span class="p">{</span>
       		<span class="k">return</span> <span class="nx">errIndexTooSmall</span>
       	<span class="p">}</span>

       	<span class="c1">// Reject new commit indexes
</span><span class="c1"></span>       	<span class="k">if</span> <span class="nx">commitIndex</span> <span class="p">&gt;</span> <span class="nx">l</span><span class="p">.</span><span class="nf">lastIndexWithLock</span><span class="p">()</span> <span class="p">{</span>
       		<span class="k">return</span> <span class="nx">errIndexTooBig</span>
       	<span class="p">}</span>

       	<span class="c1">// If we&#39;ve already committed to the commitIndex, great!
</span><span class="c1"></span>       	<span class="k">if</span> <span class="nx">commitIndex</span> <span class="o">==</span> <span class="nx">l</span><span class="p">.</span><span class="nf">getCommitIndexWithLock</span><span class="p">()</span> <span class="p">{</span>
       		<span class="k">return</span> <span class="kc">nil</span>
       	<span class="p">}</span>

       	<span class="c1">// We should start committing at precisely the last commitPos + 1
</span><span class="c1"></span>       	<span class="nx">pos</span> <span class="o">:=</span> <span class="nx">l</span><span class="p">.</span><span class="nx">commitPos</span> <span class="o">+</span> <span class="mi">1</span>
       	<span class="k">if</span> <span class="nx">pos</span> <span class="p">&lt;</span> <span class="mi">0</span> <span class="p">{</span>
       		<span class="nb">panic</span><span class="p">(</span><span class="s">&#34;pending commit pos &lt; 0&#34;</span><span class="p">)</span>
       	<span class="p">}</span>

       	<span class="c1">// Commit entries between our existing commit index and the passed index.
</span><span class="c1"></span>       	<span class="c1">// Remember to include the passed index.
</span><span class="c1"></span>       	<span class="k">for</span> <span class="p">{</span>
       		<span class="c1">// Sanity checks. TODO replace with plain `for` when this is stable.
</span><span class="c1"></span>       		<span class="k">if</span> <span class="nx">pos</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="nx">l</span><span class="p">.</span><span class="nx">entries</span><span class="p">)</span> <span class="p">{</span>
       			<span class="nb">panic</span><span class="p">(</span><span class="nx">fmt</span><span class="p">.</span><span class="nf">Sprintf</span><span class="p">(</span><span class="s">&#34;commitTo pos=%d advanced past all log entries (%d)&#34;</span><span class="p">,</span> <span class="nx">pos</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="nx">l</span><span class="p">.</span><span class="nx">entries</span><span class="p">)))</span>
       		<span class="p">}</span>
       		<span class="k">if</span> <span class="nx">l</span><span class="p">.</span><span class="nx">entries</span><span class="p">[</span><span class="nx">pos</span><span class="p">].</span><span class="nx">Index</span> <span class="p">&gt;</span> <span class="nx">commitIndex</span> <span class="p">{</span>
       			<span class="nb">panic</span><span class="p">(</span><span class="s">&#34;commitTo advanced past the desired commitIndex&#34;</span><span class="p">)</span>
       		<span class="p">}</span>

       		<span class="c1">// Encode the entry to persistent storage.
</span><span class="c1"></span>       		<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">l</span><span class="p">.</span><span class="nx">entries</span><span class="p">[</span><span class="nx">pos</span><span class="p">].</span><span class="nf">encode</span><span class="p">(</span><span class="nx">l</span><span class="p">.</span><span class="nx">store</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
       			<span class="k">return</span> <span class="nx">err</span>
       		<span class="p">}</span>

       		<span class="c1">// Forward non-configuration commands to the state machine.
</span><span class="c1"></span>       		<span class="c1">// Send the responses to the waiting client, if applicable.
</span><span class="c1"></span>       		<span class="c1">// 如果不是配置类型的Log，则调用apply function
</span><span class="c1"></span>       		<span class="c1">// 配置类型的Log，在其他地方处理
</span><span class="c1"></span>       		<span class="k">if</span> <span class="p">!</span><span class="nx">l</span><span class="p">.</span><span class="nx">entries</span><span class="p">[</span><span class="nx">pos</span><span class="p">].</span><span class="nx">isConfiguration</span> <span class="p">{</span>
       			<span class="nx">resp</span> <span class="o">:=</span> <span class="nx">l</span><span class="p">.</span><span class="nf">apply</span><span class="p">(</span><span class="nx">l</span><span class="p">.</span><span class="nx">entries</span><span class="p">[</span><span class="nx">pos</span><span class="p">].</span><span class="nx">Index</span><span class="p">,</span> <span class="nx">l</span><span class="p">.</span><span class="nx">entries</span><span class="p">[</span><span class="nx">pos</span><span class="p">].</span><span class="nx">Command</span><span class="p">)</span>
       			<span class="k">if</span> <span class="nx">l</span><span class="p">.</span><span class="nx">entries</span><span class="p">[</span><span class="nx">pos</span><span class="p">].</span><span class="nx">commandResponse</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
       				<span class="k">select</span> <span class="p">{</span>
       				<span class="k">case</span> <span class="nx">l</span><span class="p">.</span><span class="nx">entries</span><span class="p">[</span><span class="nx">pos</span><span class="p">].</span><span class="nx">commandResponse</span> <span class="o">&lt;-</span> <span class="nx">resp</span><span class="p">:</span>
       					<span class="k">break</span>
				    <span class="c1">// 问什么选取这个时间？？？
</span><span class="c1"></span>       				<span class="k">case</span> <span class="o">&lt;-</span><span class="nx">time</span><span class="p">.</span><span class="nf">After</span><span class="p">(</span><span class="nf">maximumElectionTimeout</span><span class="p">()):</span> <span class="c1">// &lt;&lt; ElectionInterval
</span><span class="c1"></span>       					<span class="nb">panic</span><span class="p">(</span><span class="s">&#34;uncoöperative command response receiver&#34;</span><span class="p">)</span>
       				<span class="p">}</span>
       				<span class="nb">close</span><span class="p">(</span><span class="nx">l</span><span class="p">.</span><span class="nx">entries</span><span class="p">[</span><span class="nx">pos</span><span class="p">].</span><span class="nx">commandResponse</span><span class="p">)</span>
       				<span class="nx">l</span><span class="p">.</span><span class="nx">entries</span><span class="p">[</span><span class="nx">pos</span><span class="p">].</span><span class="nx">commandResponse</span> <span class="p">=</span> <span class="kc">nil</span>
       			<span class="p">}</span>
       		<span class="p">}</span>

       		<span class="c1">// Signal the entry has been committed, if applicable.
</span><span class="c1"></span>       		<span class="k">if</span> <span class="nx">l</span><span class="p">.</span><span class="nx">entries</span><span class="p">[</span><span class="nx">pos</span><span class="p">].</span><span class="nx">committed</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
       			<span class="nx">l</span><span class="p">.</span><span class="nx">entries</span><span class="p">[</span><span class="nx">pos</span><span class="p">].</span><span class="nx">committed</span> <span class="o">&lt;-</span> <span class="kc">true</span>
       			<span class="nb">close</span><span class="p">(</span><span class="nx">l</span><span class="p">.</span><span class="nx">entries</span><span class="p">[</span><span class="nx">pos</span><span class="p">].</span><span class="nx">committed</span><span class="p">)</span>
       			<span class="nx">l</span><span class="p">.</span><span class="nx">entries</span><span class="p">[</span><span class="nx">pos</span><span class="p">].</span><span class="nx">committed</span> <span class="p">=</span> <span class="kc">nil</span>
       		<span class="p">}</span>

       		<span class="c1">// Mark our commit position cursor.
</span><span class="c1"></span>       		<span class="nx">l</span><span class="p">.</span><span class="nx">commitPos</span> <span class="p">=</span> <span class="nx">pos</span>

       		<span class="c1">// If that was the last one, we&#39;re done.
</span><span class="c1"></span>       		<span class="k">if</span> <span class="nx">l</span><span class="p">.</span><span class="nx">entries</span><span class="p">[</span><span class="nx">pos</span><span class="p">].</span><span class="nx">Index</span> <span class="o">==</span> <span class="nx">commitIndex</span> <span class="p">{</span>
       			<span class="k">break</span>
       		<span class="p">}</span>
       		<span class="k">if</span> <span class="nx">l</span><span class="p">.</span><span class="nx">entries</span><span class="p">[</span><span class="nx">pos</span><span class="p">].</span><span class="nx">Index</span> <span class="p">&gt;</span> <span class="nx">commitIndex</span> <span class="p">{</span>
       			<span class="nb">panic</span><span class="p">(</span><span class="nx">fmt</span><span class="p">.</span><span class="nf">Sprintf</span><span class="p">(</span>
       				<span class="s">&#34;current entry Index %d is beyond our desired commitIndex %d&#34;</span><span class="p">,</span>
       				<span class="nx">l</span><span class="p">.</span><span class="nx">entries</span><span class="p">[</span><span class="nx">pos</span><span class="p">].</span><span class="nx">Index</span><span class="p">,</span>
       				<span class="nx">commitIndex</span><span class="p">,</span>
       			<span class="p">))</span>
       		<span class="p">}</span>

       		<span class="c1">// Otherwise, advance!
</span><span class="c1"></span>       		<span class="nx">pos</span><span class="o">++</span>
       	<span class="p">}</span>

       	<span class="c1">// Done.
</span><span class="c1"></span>       	<span class="k">return</span> <span class="kc">nil</span>
<span class="p">}</span>

<span class="c1">// logEntry is the atomic unit being managed by the distributed log. A log entry
</span><span class="c1">// always has an index (monotonically increasing), a term in which the Raft
</span><span class="c1">// network leader first sees the entry, and a command. The command is what gets
</span><span class="c1">// executed against the node state machine when the log entry is successfully
</span><span class="c1">// replicated.
</span><span class="c1"></span><span class="kd">type</span> <span class="nx">logEntry</span> <span class="kd">struct</span> <span class="p">{</span>
  		<span class="c1">// 日志索引号
</span><span class="c1"></span>       	<span class="nx">Index</span>           <span class="kt">uint64</span>        <span class="s">`json:&#34;index&#34;`</span>
       	<span class="c1">// 任期号
</span><span class="c1"></span>  		<span class="nx">Term</span>            <span class="kt">uint64</span>        <span class="s">`json:&#34;term&#34;`</span> <span class="c1">// when received by leader
</span><span class="c1"></span>  		<span class="c1">// 日志内容
</span><span class="c1"></span>       	<span class="nx">Command</span>         <span class="p">[]</span><span class="kt">byte</span>        <span class="s">`json:&#34;command,omitempty&#34;`</span>
  		<span class="c1">// commited 通道
</span><span class="c1"></span>       	<span class="nx">committed</span>       <span class="kd">chan</span> <span class="kt">bool</span>     <span class="s">`json:&#34;-&#34;`</span>
  		<span class="c1">// 命令应答 通道
</span><span class="c1"></span>       	<span class="nx">commandResponse</span> <span class="kd">chan</span><span class="o">&lt;-</span> <span class="p">[]</span><span class="kt">byte</span> <span class="s">`json:&#34;-&#34;`</span> <span class="c1">// only non-nil on receiver&#39;s log
</span><span class="c1"></span>  		<span class="c1">// 日志类型标示
</span><span class="c1"></span>       	<span class="nx">isConfiguration</span> <span class="kt">bool</span>          <span class="s">`json:&#34;-&#34;`</span> <span class="c1">// for configuration change entries
</span><span class="c1"></span><span class="p">}</span>

<span class="c1">// encode serializes the log entry to the passed io.Writer.
</span><span class="c1">//
</span><span class="c1">// Entries are serialized in a simple binary format:
</span><span class="c1">//
</span><span class="c1">//     		 ---------------------------------------------
</span><span class="c1">//     		| uint32 | uint64 | uint64 | uint32 | []byte  |
</span><span class="c1">//     		 ---------------------------------------------
</span><span class="c1">//     		| CRC    | TERM   | INDEX  | SIZE   | COMMAND |
</span><span class="c1">//     		 ---------------------------------------------
</span><span class="c1">//
</span><span class="c1"></span>
<span class="c1">// 序列化，大端
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">e</span> <span class="o">*</span><span class="nx">logEntry</span><span class="p">)</span> <span class="nf">encode</span><span class="p">(</span><span class="nx">w</span> <span class="nx">io</span><span class="p">.</span><span class="nx">Writer</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
       	<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">Command</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="p">{</span>
       		<span class="k">return</span> <span class="nx">errNoCommand</span>
       	<span class="p">}</span>
       	<span class="k">if</span> <span class="nx">e</span><span class="p">.</span><span class="nx">Index</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="p">{</span>
       		<span class="k">return</span> <span class="nx">errBadIndex</span>
       	<span class="p">}</span>
       	<span class="k">if</span> <span class="nx">e</span><span class="p">.</span><span class="nx">Term</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="p">{</span>
       		<span class="k">return</span> <span class="nx">errBadTerm</span>
       	<span class="p">}</span>

       	<span class="nx">commandSize</span> <span class="o">:=</span> <span class="nb">len</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">Command</span><span class="p">)</span>
       	<span class="nx">buf</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">([]</span><span class="kt">byte</span><span class="p">,</span> <span class="mi">24</span><span class="o">+</span><span class="nx">commandSize</span><span class="p">)</span>

       	<span class="nx">binary</span><span class="p">.</span><span class="nx">LittleEndian</span><span class="p">.</span><span class="nf">PutUint64</span><span class="p">(</span><span class="nx">buf</span><span class="p">[</span><span class="mi">4</span><span class="p">:</span><span class="mi">12</span><span class="p">],</span> <span class="nx">e</span><span class="p">.</span><span class="nx">Term</span><span class="p">)</span>
       	<span class="nx">binary</span><span class="p">.</span><span class="nx">LittleEndian</span><span class="p">.</span><span class="nf">PutUint64</span><span class="p">(</span><span class="nx">buf</span><span class="p">[</span><span class="mi">12</span><span class="p">:</span><span class="mi">20</span><span class="p">],</span> <span class="nx">e</span><span class="p">.</span><span class="nx">Index</span><span class="p">)</span>
       	<span class="nx">binary</span><span class="p">.</span><span class="nx">LittleEndian</span><span class="p">.</span><span class="nf">PutUint32</span><span class="p">(</span><span class="nx">buf</span><span class="p">[</span><span class="mi">20</span><span class="p">:</span><span class="mi">24</span><span class="p">],</span> <span class="nb">uint32</span><span class="p">(</span><span class="nx">commandSize</span><span class="p">))</span>

       	<span class="nb">copy</span><span class="p">(</span><span class="nx">buf</span><span class="p">[</span><span class="mi">24</span><span class="p">:],</span> <span class="nx">e</span><span class="p">.</span><span class="nx">Command</span><span class="p">)</span>

       	<span class="nx">binary</span><span class="p">.</span><span class="nx">LittleEndian</span><span class="p">.</span><span class="nf">PutUint32</span><span class="p">(</span>
       		<span class="nx">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">4</span><span class="p">],</span>
       		<span class="nx">crc32</span><span class="p">.</span><span class="nf">ChecksumIEEE</span><span class="p">(</span><span class="nx">buf</span><span class="p">[</span><span class="mi">4</span><span class="p">:]),</span>
       	<span class="p">)</span>

       	<span class="nx">_</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">w</span><span class="p">.</span><span class="nf">Write</span><span class="p">(</span><span class="nx">buf</span><span class="p">)</span>
       	<span class="k">return</span> <span class="nx">err</span>
<span class="p">}</span>

<span class="c1">// 反序列化
</span><span class="c1">// decode deserializes one log entry from the passed io.Reader.
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">e</span> <span class="o">*</span><span class="nx">logEntry</span><span class="p">)</span> <span class="nf">decode</span><span class="p">(</span><span class="nx">r</span> <span class="nx">io</span><span class="p">.</span><span class="nx">Reader</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
       	<span class="nx">header</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">([]</span><span class="kt">byte</span><span class="p">,</span> <span class="mi">24</span><span class="p">)</span>

       	<span class="k">if</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">r</span><span class="p">.</span><span class="nf">Read</span><span class="p">(</span><span class="nx">header</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
       		<span class="k">return</span> <span class="nx">err</span>
       	<span class="p">}</span>

       	<span class="nx">command</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">([]</span><span class="kt">byte</span><span class="p">,</span> <span class="nx">binary</span><span class="p">.</span><span class="nx">LittleEndian</span><span class="p">.</span><span class="nf">Uint32</span><span class="p">(</span><span class="nx">header</span><span class="p">[</span><span class="mi">20</span><span class="p">:</span><span class="mi">24</span><span class="p">]))</span>

       	<span class="k">if</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">r</span><span class="p">.</span><span class="nf">Read</span><span class="p">(</span><span class="nx">command</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
       		<span class="k">return</span> <span class="nx">err</span>
       	<span class="p">}</span>

       	<span class="nx">crc</span> <span class="o">:=</span> <span class="nx">binary</span><span class="p">.</span><span class="nx">LittleEndian</span><span class="p">.</span><span class="nf">Uint32</span><span class="p">(</span><span class="nx">header</span><span class="p">[:</span><span class="mi">4</span><span class="p">])</span>

       	<span class="nx">check</span> <span class="o">:=</span> <span class="nx">crc32</span><span class="p">.</span><span class="nf">NewIEEE</span><span class="p">()</span>
       	<span class="nx">check</span><span class="p">.</span><span class="nf">Write</span><span class="p">(</span><span class="nx">header</span><span class="p">[</span><span class="mi">4</span><span class="p">:])</span>
       	<span class="nx">check</span><span class="p">.</span><span class="nf">Write</span><span class="p">(</span><span class="nx">command</span><span class="p">)</span>

       	<span class="k">if</span> <span class="nx">crc</span> <span class="o">!=</span> <span class="nx">check</span><span class="p">.</span><span class="nf">Sum32</span><span class="p">()</span> <span class="p">{</span>
       		<span class="k">return</span> <span class="nx">errInvalidChecksum</span>
       	<span class="p">}</span>

       	<span class="nx">e</span><span class="p">.</span><span class="nx">Term</span> <span class="p">=</span> <span class="nx">binary</span><span class="p">.</span><span class="nx">LittleEndian</span><span class="p">.</span><span class="nf">Uint64</span><span class="p">(</span><span class="nx">header</span><span class="p">[</span><span class="mi">4</span><span class="p">:</span><span class="mi">12</span><span class="p">])</span>
       	<span class="nx">e</span><span class="p">.</span><span class="nx">Index</span> <span class="p">=</span> <span class="nx">binary</span><span class="p">.</span><span class="nx">LittleEndian</span><span class="p">.</span><span class="nf">Uint64</span><span class="p">(</span><span class="nx">header</span><span class="p">[</span><span class="mi">12</span><span class="p">:</span><span class="mi">20</span><span class="p">])</span>
       	<span class="nx">e</span><span class="p">.</span><span class="nx">Command</span> <span class="p">=</span> <span class="nx">command</span>

       	<span class="k">return</span> <span class="kc">nil</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<h3 id="peers-go">Peers.go</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span><span class="lnt">177
</span><span class="lnt">178
</span><span class="lnt">179
</span><span class="lnt">180
</span><span class="lnt">181
</span><span class="lnt">182
</span><span class="lnt">183
</span><span class="lnt">184
</span><span class="lnt">185
</span><span class="lnt">186
</span><span class="lnt">187
</span><span class="lnt">188
</span><span class="lnt">189
</span><span class="lnt">190
</span><span class="lnt">191
</span><span class="lnt">192
</span><span class="lnt">193
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="kd">var</span> <span class="p">(</span>
	<span class="nx">errTimeout</span> <span class="p">=</span> <span class="nx">errors</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span><span class="s">&#34;timeout&#34;</span><span class="p">)</span>
<span class="p">)</span>
<span class="c1">// peers为节点的一个抽象，对外提供了一些访问接口，
</span><span class="c1">// 需要注意的地方是peers的序列化
</span><span class="c1"></span><span class="kd">type</span> <span class="nx">Peer</span> <span class="kd">interface</span> <span class="p">{</span>
  	<span class="c1">// 返回server标示
</span><span class="c1"></span>	<span class="nf">id</span><span class="p">()</span> <span class="kt">uint64</span>
  	<span class="c1">// 日志追加接口
</span><span class="c1"></span>	<span class="nf">callAppendEntries</span><span class="p">(</span><span class="nx">appendEntries</span><span class="p">)</span> <span class="nx">appendEntriesResponse</span>
  	<span class="c1">// 投票选举接口
</span><span class="c1"></span>	<span class="nf">callRequestVote</span><span class="p">(</span><span class="nx">requestVote</span><span class="p">)</span> <span class="nx">requestVoteResponse</span>
  	<span class="c1">// 命令调用
</span><span class="c1"></span>	<span class="nf">callCommand</span><span class="p">([]</span><span class="kt">byte</span><span class="p">,</span> <span class="kd">chan</span><span class="o">&lt;-</span> <span class="p">[]</span><span class="kt">byte</span><span class="p">)</span> <span class="kt">error</span>
  	<span class="c1">// 集群配置变化接口
</span><span class="c1"></span>	<span class="nf">callSetConfiguration</span><span class="p">(</span><span class="o">...</span><span class="nx">Peer</span><span class="p">)</span> <span class="kt">error</span>
<span class="p">}</span>

<span class="c1">// localPeer is the simplest kind of peer, mapped to a server in the
</span><span class="c1">// same process-space. Useful for testing and demonstration; not so
</span><span class="c1">// useful for networks of independent processes.
</span><span class="c1">// 本地local peers，用于测试，不用经过网络
</span><span class="c1"></span><span class="kd">type</span> <span class="nx">localPeer</span> <span class="kd">struct</span> <span class="p">{</span>
	<span class="nx">server</span> <span class="o">*</span><span class="nx">Server</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">newLocalPeer</span><span class="p">(</span><span class="nx">server</span> <span class="o">*</span><span class="nx">Server</span><span class="p">)</span> <span class="o">*</span><span class="nx">localPeer</span> <span class="p">{</span> <span class="k">return</span> <span class="o">&amp;</span><span class="nx">localPeer</span><span class="p">{</span><span class="nx">server</span><span class="p">}</span> <span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">p</span> <span class="o">*</span><span class="nx">localPeer</span><span class="p">)</span> <span class="nf">id</span><span class="p">()</span> <span class="kt">uint64</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">p</span><span class="p">.</span><span class="nx">server</span><span class="p">.</span><span class="nx">id</span> <span class="p">}</span>

<span class="c1">// 追加日志
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">p</span> <span class="o">*</span><span class="nx">localPeer</span><span class="p">)</span> <span class="nf">callAppendEntries</span><span class="p">(</span><span class="nx">ae</span> <span class="nx">appendEntries</span><span class="p">)</span> <span class="nx">appendEntriesResponse</span> <span class="p">{</span>
	<span class="k">return</span> <span class="nx">p</span><span class="p">.</span><span class="nx">server</span><span class="p">.</span><span class="nf">appendEntries</span><span class="p">(</span><span class="nx">ae</span><span class="p">)</span>
<span class="p">}</span>

<span class="c1">// 投票选举
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">p</span> <span class="o">*</span><span class="nx">localPeer</span><span class="p">)</span> <span class="nf">callRequestVote</span><span class="p">(</span><span class="nx">rv</span> <span class="nx">requestVote</span><span class="p">)</span> <span class="nx">requestVoteResponse</span> <span class="p">{</span>
	<span class="k">return</span> <span class="nx">p</span><span class="p">.</span><span class="nx">server</span><span class="p">.</span><span class="nf">requestVote</span><span class="p">(</span><span class="nx">rv</span><span class="p">)</span>
<span class="p">}</span>

<span class="c1">// 命令
</span><span class="c1">// 实际调用为Leader
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">p</span> <span class="o">*</span><span class="nx">localPeer</span><span class="p">)</span> <span class="nf">callCommand</span><span class="p">(</span><span class="nx">cmd</span> <span class="p">[]</span><span class="kt">byte</span><span class="p">,</span> <span class="nx">response</span> <span class="kd">chan</span><span class="o">&lt;-</span> <span class="p">[]</span><span class="kt">byte</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
	<span class="k">return</span> <span class="nx">p</span><span class="p">.</span><span class="nx">server</span><span class="p">.</span><span class="nf">Command</span><span class="p">(</span><span class="nx">cmd</span><span class="p">,</span> <span class="nx">response</span><span class="p">)</span>
<span class="p">}</span>

<span class="c1">// 设置配置
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">p</span> <span class="o">*</span><span class="nx">localPeer</span><span class="p">)</span> <span class="nf">callSetConfiguration</span><span class="p">(</span><span class="nx">peers</span> <span class="o">...</span><span class="nx">Peer</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
	<span class="k">return</span> <span class="nx">p</span><span class="p">.</span><span class="nx">server</span><span class="p">.</span><span class="nf">SetConfiguration</span><span class="p">(</span><span class="nx">peers</span><span class="o">...</span><span class="p">)</span>
<span class="p">}</span>

<span class="c1">// requestVoteTimeout issues the requestVote to the given peer.
</span><span class="c1">// If no response is received before timeout, an error is returned.
</span><span class="c1">// 投票
</span><span class="c1"></span><span class="kd">func</span> <span class="nf">requestVoteTimeout</span><span class="p">(</span><span class="nx">p</span> <span class="nx">Peer</span><span class="p">,</span> <span class="nx">rv</span> <span class="nx">requestVote</span><span class="p">,</span> <span class="nx">timeout</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Duration</span><span class="p">)</span> <span class="p">(</span><span class="nx">requestVoteResponse</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">c</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">(</span><span class="kd">chan</span> <span class="nx">requestVoteResponse</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
	<span class="k">go</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span> <span class="nx">c</span> <span class="o">&lt;-</span> <span class="nx">p</span><span class="p">.</span><span class="nf">callRequestVote</span><span class="p">(</span><span class="nx">rv</span><span class="p">)</span> <span class="p">}()</span>

	<span class="k">select</span> <span class="p">{</span>
	<span class="k">case</span> <span class="nx">resp</span> <span class="o">:=</span> <span class="o">&lt;-</span><span class="nx">c</span><span class="p">:</span>
		<span class="k">return</span> <span class="nx">resp</span><span class="p">,</span> <span class="kc">nil</span>
	<span class="k">case</span> <span class="o">&lt;-</span><span class="nx">time</span><span class="p">.</span><span class="nf">After</span><span class="p">(</span><span class="nx">timeout</span><span class="p">):</span>
		<span class="k">return</span> <span class="nx">requestVoteResponse</span><span class="p">{},</span> <span class="nx">errTimeout</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="c1">// peerMap is a collection of Peer interfaces. It provides some convenience
</span><span class="c1">// functions for actions that should apply to multiple Peers.
</span><span class="c1"></span><span class="kd">type</span> <span class="nx">peerMap</span> <span class="kd">map</span><span class="p">[</span><span class="kt">uint64</span><span class="p">]</span><span class="nx">Peer</span>

<span class="c1">// makePeerMap constructs a peerMap from a list of peers.
</span><span class="c1"></span><span class="kd">func</span> <span class="nf">makePeerMap</span><span class="p">(</span><span class="nx">peers</span> <span class="o">...</span><span class="nx">Peer</span><span class="p">)</span> <span class="nx">peerMap</span> <span class="p">{</span>
	<span class="nx">pm</span> <span class="o">:=</span> <span class="nx">peerMap</span><span class="p">{}</span>
	<span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">peer</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">peers</span> <span class="p">{</span>
		<span class="nx">pm</span><span class="p">[</span><span class="nx">peer</span><span class="p">.</span><span class="nf">id</span><span class="p">()]</span> <span class="p">=</span> <span class="nx">peer</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nx">pm</span>
<span class="p">}</span>

<span class="c1">// explodePeerMap converts a peerMap into a slice of peers.
</span><span class="c1"></span><span class="kd">func</span> <span class="nf">explodePeerMap</span><span class="p">(</span><span class="nx">pm</span> <span class="nx">peerMap</span><span class="p">)</span> <span class="p">[]</span><span class="nx">Peer</span> <span class="p">{</span>
	<span class="nx">a</span> <span class="o">:=</span> <span class="p">[]</span><span class="nx">Peer</span><span class="p">{}</span>
	<span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">peer</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">pm</span> <span class="p">{</span>
		<span class="nx">a</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">peer</span><span class="p">)</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nx">a</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">pm</span> <span class="nx">peerMap</span><span class="p">)</span> <span class="nf">except</span><span class="p">(</span><span class="nx">id</span> <span class="kt">uint64</span><span class="p">)</span> <span class="nx">peerMap</span> <span class="p">{</span>
	<span class="nx">except</span> <span class="o">:=</span> <span class="nx">peerMap</span><span class="p">{}</span>
	<span class="k">for</span> <span class="nx">id0</span><span class="p">,</span> <span class="nx">peer</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">pm</span> <span class="p">{</span>
		<span class="k">if</span> <span class="nx">id0</span> <span class="o">==</span> <span class="nx">id</span> <span class="p">{</span>
			<span class="k">continue</span>
		<span class="p">}</span>
		<span class="nx">except</span><span class="p">[</span><span class="nx">id0</span><span class="p">]</span> <span class="p">=</span> <span class="nx">peer</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nx">except</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">pm</span> <span class="nx">peerMap</span><span class="p">)</span> <span class="nf">count</span><span class="p">()</span> <span class="kt">int</span> <span class="p">{</span> <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="nx">pm</span><span class="p">)</span> <span class="p">}</span>

<span class="c1">// 法定人数
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">pm</span> <span class="nx">peerMap</span><span class="p">)</span> <span class="nf">quorum</span><span class="p">()</span> <span class="kt">int</span> <span class="p">{</span>
	<span class="k">switch</span> <span class="nx">n</span> <span class="o">:=</span> <span class="nb">len</span><span class="p">(</span><span class="nx">pm</span><span class="p">);</span> <span class="nx">n</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span>
		<span class="k">return</span> <span class="mi">1</span>
	<span class="k">default</span><span class="p">:</span>
		<span class="k">return</span> <span class="p">(</span><span class="nx">n</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="c1">// requestVotes sends the passed requestVote RPC to every peer in Peers. It
</span><span class="c1">// forwards responses along the returned requestVoteResponse channel. It makes
</span><span class="c1">// the RPCs with a timeout of BroadcastInterval * 2 (chosen arbitrarily). Peers
</span><span class="c1">// that don&#39;t respond within the timeout are retried forever. The retry loop
</span><span class="c1">// stops only when all peers have responded, or a Cancel signal is sent via the
</span><span class="c1">// returned canceler.
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">pm</span> <span class="nx">peerMap</span><span class="p">)</span> <span class="nf">requestVotes</span><span class="p">(</span><span class="nx">r</span> <span class="nx">requestVote</span><span class="p">)</span> <span class="p">(</span><span class="kd">chan</span> <span class="nx">voteResponseTuple</span><span class="p">,</span> <span class="nx">canceler</span><span class="p">)</span> <span class="p">{</span>
	<span class="c1">// &#34;[A server entering the candidate stage] issues requestVote RPCs in
</span><span class="c1"></span>	<span class="c1">// parallel to each of the other servers in the cluster. If the candidate
</span><span class="c1"></span>	<span class="c1">// receives no response for an RPC, it reissues the RPC repeatedly until a
</span><span class="c1"></span>	<span class="c1">// response arrives or the election concludes.&#34;
</span><span class="c1"></span>
	<span class="c1">// construct the channels we&#39;ll return
</span><span class="c1"></span>	<span class="nx">abortChan</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">(</span><span class="kd">chan</span> <span class="kd">struct</span><span class="p">{})</span>
	<span class="nx">tupleChan</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">(</span><span class="kd">chan</span> <span class="nx">voteResponseTuple</span><span class="p">)</span>

	<span class="k">go</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
		<span class="c1">// We loop until all Peers have given us a response.
</span><span class="c1"></span>		<span class="c1">// Track which Peers have responded.
</span><span class="c1"></span>		<span class="nx">respondedAlready</span> <span class="o">:=</span> <span class="nx">peerMap</span><span class="p">{}</span> <span class="c1">// none yet
</span><span class="c1"></span>
		<span class="k">for</span> <span class="p">{</span>
			<span class="nx">notYetResponded</span> <span class="o">:=</span> <span class="nf">disjoint</span><span class="p">(</span><span class="nx">pm</span><span class="p">,</span> <span class="nx">respondedAlready</span><span class="p">)</span>
			<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nx">notYetResponded</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="p">{</span>
				<span class="k">return</span> <span class="c1">// done
</span><span class="c1"></span>			<span class="p">}</span>

			<span class="c1">// scatter
</span><span class="c1"></span>			<span class="nx">tupleChan0</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">(</span><span class="kd">chan</span> <span class="nx">voteResponseTuple</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="nx">notYetResponded</span><span class="p">))</span>
			<span class="k">for</span> <span class="nx">id</span><span class="p">,</span> <span class="nx">peer</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">notYetResponded</span> <span class="p">{</span>
				<span class="k">go</span> <span class="kd">func</span><span class="p">(</span><span class="nx">id</span> <span class="kt">uint64</span><span class="p">,</span> <span class="nx">peer</span> <span class="nx">Peer</span><span class="p">)</span> <span class="p">{</span>
					<span class="nx">resp</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">requestVoteTimeout</span><span class="p">(</span><span class="nx">peer</span><span class="p">,</span> <span class="nx">r</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="nf">maximumElectionTimeout</span><span class="p">())</span>
					<span class="nx">tupleChan0</span> <span class="o">&lt;-</span> <span class="nx">voteResponseTuple</span><span class="p">{</span><span class="nx">id</span><span class="p">,</span> <span class="nx">resp</span><span class="p">,</span> <span class="nx">err</span><span class="p">}</span>
				<span class="p">}(</span><span class="nx">id</span><span class="p">,</span> <span class="nx">peer</span><span class="p">)</span>
			<span class="p">}</span>

			<span class="c1">// gather
</span><span class="c1"></span>			<span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="p">&lt;</span> <span class="nb">cap</span><span class="p">(</span><span class="nx">tupleChan0</span><span class="p">);</span> <span class="nx">i</span><span class="o">++</span> <span class="p">{</span>
				<span class="k">select</span> <span class="p">{</span>
				<span class="k">case</span> <span class="nx">t</span> <span class="o">:=</span> <span class="o">&lt;-</span><span class="nx">tupleChan0</span><span class="p">:</span>
					<span class="k">if</span> <span class="nx">t</span><span class="p">.</span><span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
						<span class="k">continue</span> <span class="c1">// will need to retry
</span><span class="c1"></span>					<span class="p">}</span>
					<span class="nx">respondedAlready</span><span class="p">[</span><span class="nx">t</span><span class="p">.</span><span class="nx">id</span><span class="p">]</span> <span class="p">=</span> <span class="kc">nil</span> <span class="c1">// set membership semantics
</span><span class="c1"></span>					<span class="nx">tupleChan</span> <span class="o">&lt;-</span> <span class="nx">t</span>

				<span class="k">case</span> <span class="o">&lt;-</span><span class="nx">abortChan</span><span class="p">:</span>
					<span class="k">return</span> <span class="c1">// give up
</span><span class="c1"></span>				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}()</span>

	<span class="k">return</span> <span class="nx">tupleChan</span><span class="p">,</span> <span class="nf">cancel</span><span class="p">(</span><span class="nx">abortChan</span><span class="p">)</span>
<span class="p">}</span>

<span class="c1">// 选举应答
</span><span class="c1"></span><span class="kd">type</span> <span class="nx">voteResponseTuple</span> <span class="kd">struct</span> <span class="p">{</span>
	<span class="nx">id</span>       <span class="kt">uint64</span>
	<span class="nx">response</span> <span class="nx">requestVoteResponse</span>
	<span class="nx">err</span>      <span class="kt">error</span>
<span class="p">}</span>

<span class="kd">type</span> <span class="nx">canceler</span> <span class="kd">interface</span> <span class="p">{</span>
	<span class="nf">Cancel</span><span class="p">()</span>
<span class="p">}</span>

<span class="kd">type</span> <span class="nx">cancel</span> <span class="kd">chan</span> <span class="kd">struct</span><span class="p">{}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">c</span> <span class="nx">cancel</span><span class="p">)</span> <span class="nf">Cancel</span><span class="p">()</span> <span class="p">{</span> <span class="nb">close</span><span class="p">(</span><span class="nx">c</span><span class="p">)</span> <span class="p">}</span>

<span class="c1">// 过滤peers
</span><span class="c1"></span><span class="kd">func</span> <span class="nf">disjoint</span><span class="p">(</span><span class="nx">all</span><span class="p">,</span> <span class="nx">except</span> <span class="nx">peerMap</span><span class="p">)</span> <span class="nx">peerMap</span> <span class="p">{</span>
	<span class="nx">d</span> <span class="o">:=</span> <span class="nx">peerMap</span><span class="p">{}</span>
	<span class="k">for</span> <span class="nx">id</span><span class="p">,</span> <span class="nx">peer</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">all</span> <span class="p">{</span>
		<span class="k">if</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">ok</span> <span class="o">:=</span> <span class="nx">except</span><span class="p">[</span><span class="nx">id</span><span class="p">];</span> <span class="nx">ok</span> <span class="p">{</span>
			<span class="k">continue</span>
		<span class="p">}</span>
		<span class="nx">d</span><span class="p">[</span><span class="nx">id</span><span class="p">]</span> <span class="p">=</span> <span class="nx">peer</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nx">d</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<h3 id="server-go">server.go</h3>

<p>这是最重要的一个逻辑</p>

<p><img src="http://laohanlinux.github.io/images/img/raft-consensus-1.png" alt="" /></p>

<p>节点配置变更</p>

<p><img src="http://laohanlinux.github.io/images/img/raft-state.png" alt="" /></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="lnt">   1
</span><span class="lnt">   2
</span><span class="lnt">   3
</span><span class="lnt">   4
</span><span class="lnt">   5
</span><span class="lnt">   6
</span><span class="lnt">   7
</span><span class="lnt">   8
</span><span class="lnt">   9
</span><span class="lnt">  10
</span><span class="lnt">  11
</span><span class="lnt">  12
</span><span class="lnt">  13
</span><span class="lnt">  14
</span><span class="lnt">  15
</span><span class="lnt">  16
</span><span class="lnt">  17
</span><span class="lnt">  18
</span><span class="lnt">  19
</span><span class="lnt">  20
</span><span class="lnt">  21
</span><span class="lnt">  22
</span><span class="lnt">  23
</span><span class="lnt">  24
</span><span class="lnt">  25
</span><span class="lnt">  26
</span><span class="lnt">  27
</span><span class="lnt">  28
</span><span class="lnt">  29
</span><span class="lnt">  30
</span><span class="lnt">  31
</span><span class="lnt">  32
</span><span class="lnt">  33
</span><span class="lnt">  34
</span><span class="lnt">  35
</span><span class="lnt">  36
</span><span class="lnt">  37
</span><span class="lnt">  38
</span><span class="lnt">  39
</span><span class="lnt">  40
</span><span class="lnt">  41
</span><span class="lnt">  42
</span><span class="lnt">  43
</span><span class="lnt">  44
</span><span class="lnt">  45
</span><span class="lnt">  46
</span><span class="lnt">  47
</span><span class="lnt">  48
</span><span class="lnt">  49
</span><span class="lnt">  50
</span><span class="lnt">  51
</span><span class="lnt">  52
</span><span class="lnt">  53
</span><span class="lnt">  54
</span><span class="lnt">  55
</span><span class="lnt">  56
</span><span class="lnt">  57
</span><span class="lnt">  58
</span><span class="lnt">  59
</span><span class="lnt">  60
</span><span class="lnt">  61
</span><span class="lnt">  62
</span><span class="lnt">  63
</span><span class="lnt">  64
</span><span class="lnt">  65
</span><span class="lnt">  66
</span><span class="lnt">  67
</span><span class="lnt">  68
</span><span class="lnt">  69
</span><span class="lnt">  70
</span><span class="lnt">  71
</span><span class="lnt">  72
</span><span class="lnt">  73
</span><span class="lnt">  74
</span><span class="lnt">  75
</span><span class="lnt">  76
</span><span class="lnt">  77
</span><span class="lnt">  78
</span><span class="lnt">  79
</span><span class="lnt">  80
</span><span class="lnt">  81
</span><span class="lnt">  82
</span><span class="lnt">  83
</span><span class="lnt">  84
</span><span class="lnt">  85
</span><span class="lnt">  86
</span><span class="lnt">  87
</span><span class="lnt">  88
</span><span class="lnt">  89
</span><span class="lnt">  90
</span><span class="lnt">  91
</span><span class="lnt">  92
</span><span class="lnt">  93
</span><span class="lnt">  94
</span><span class="lnt">  95
</span><span class="lnt">  96
</span><span class="lnt">  97
</span><span class="lnt">  98
</span><span class="lnt">  99
</span><span class="lnt"> 100
</span><span class="lnt"> 101
</span><span class="lnt"> 102
</span><span class="lnt"> 103
</span><span class="lnt"> 104
</span><span class="lnt"> 105
</span><span class="lnt"> 106
</span><span class="lnt"> 107
</span><span class="lnt"> 108
</span><span class="lnt"> 109
</span><span class="lnt"> 110
</span><span class="lnt"> 111
</span><span class="lnt"> 112
</span><span class="lnt"> 113
</span><span class="lnt"> 114
</span><span class="lnt"> 115
</span><span class="lnt"> 116
</span><span class="lnt"> 117
</span><span class="lnt"> 118
</span><span class="lnt"> 119
</span><span class="lnt"> 120
</span><span class="lnt"> 121
</span><span class="lnt"> 122
</span><span class="lnt"> 123
</span><span class="lnt"> 124
</span><span class="lnt"> 125
</span><span class="lnt"> 126
</span><span class="lnt"> 127
</span><span class="lnt"> 128
</span><span class="lnt"> 129
</span><span class="lnt"> 130
</span><span class="lnt"> 131
</span><span class="lnt"> 132
</span><span class="lnt"> 133
</span><span class="lnt"> 134
</span><span class="lnt"> 135
</span><span class="lnt"> 136
</span><span class="lnt"> 137
</span><span class="lnt"> 138
</span><span class="lnt"> 139
</span><span class="lnt"> 140
</span><span class="lnt"> 141
</span><span class="lnt"> 142
</span><span class="lnt"> 143
</span><span class="lnt"> 144
</span><span class="lnt"> 145
</span><span class="lnt"> 146
</span><span class="lnt"> 147
</span><span class="lnt"> 148
</span><span class="lnt"> 149
</span><span class="lnt"> 150
</span><span class="lnt"> 151
</span><span class="lnt"> 152
</span><span class="lnt"> 153
</span><span class="lnt"> 154
</span><span class="lnt"> 155
</span><span class="lnt"> 156
</span><span class="lnt"> 157
</span><span class="lnt"> 158
</span><span class="lnt"> 159
</span><span class="lnt"> 160
</span><span class="lnt"> 161
</span><span class="lnt"> 162
</span><span class="lnt"> 163
</span><span class="lnt"> 164
</span><span class="lnt"> 165
</span><span class="lnt"> 166
</span><span class="lnt"> 167
</span><span class="lnt"> 168
</span><span class="lnt"> 169
</span><span class="lnt"> 170
</span><span class="lnt"> 171
</span><span class="lnt"> 172
</span><span class="lnt"> 173
</span><span class="lnt"> 174
</span><span class="lnt"> 175
</span><span class="lnt"> 176
</span><span class="lnt"> 177
</span><span class="lnt"> 178
</span><span class="lnt"> 179
</span><span class="lnt"> 180
</span><span class="lnt"> 181
</span><span class="lnt"> 182
</span><span class="lnt"> 183
</span><span class="lnt"> 184
</span><span class="lnt"> 185
</span><span class="lnt"> 186
</span><span class="lnt"> 187
</span><span class="lnt"> 188
</span><span class="lnt"> 189
</span><span class="lnt"> 190
</span><span class="lnt"> 191
</span><span class="lnt"> 192
</span><span class="lnt"> 193
</span><span class="lnt"> 194
</span><span class="lnt"> 195
</span><span class="lnt"> 196
</span><span class="lnt"> 197
</span><span class="lnt"> 198
</span><span class="lnt"> 199
</span><span class="lnt"> 200
</span><span class="lnt"> 201
</span><span class="lnt"> 202
</span><span class="lnt"> 203
</span><span class="lnt"> 204
</span><span class="lnt"> 205
</span><span class="lnt"> 206
</span><span class="lnt"> 207
</span><span class="lnt"> 208
</span><span class="lnt"> 209
</span><span class="lnt"> 210
</span><span class="lnt"> 211
</span><span class="lnt"> 212
</span><span class="lnt"> 213
</span><span class="lnt"> 214
</span><span class="lnt"> 215
</span><span class="lnt"> 216
</span><span class="lnt"> 217
</span><span class="lnt"> 218
</span><span class="lnt"> 219
</span><span class="lnt"> 220
</span><span class="lnt"> 221
</span><span class="lnt"> 222
</span><span class="lnt"> 223
</span><span class="lnt"> 224
</span><span class="lnt"> 225
</span><span class="lnt"> 226
</span><span class="lnt"> 227
</span><span class="lnt"> 228
</span><span class="lnt"> 229
</span><span class="lnt"> 230
</span><span class="lnt"> 231
</span><span class="lnt"> 232
</span><span class="lnt"> 233
</span><span class="lnt"> 234
</span><span class="lnt"> 235
</span><span class="lnt"> 236
</span><span class="lnt"> 237
</span><span class="lnt"> 238
</span><span class="lnt"> 239
</span><span class="lnt"> 240
</span><span class="lnt"> 241
</span><span class="lnt"> 242
</span><span class="lnt"> 243
</span><span class="lnt"> 244
</span><span class="lnt"> 245
</span><span class="lnt"> 246
</span><span class="lnt"> 247
</span><span class="lnt"> 248
</span><span class="lnt"> 249
</span><span class="lnt"> 250
</span><span class="lnt"> 251
</span><span class="lnt"> 252
</span><span class="lnt"> 253
</span><span class="lnt"> 254
</span><span class="lnt"> 255
</span><span class="lnt"> 256
</span><span class="lnt"> 257
</span><span class="lnt"> 258
</span><span class="lnt"> 259
</span><span class="lnt"> 260
</span><span class="lnt"> 261
</span><span class="lnt"> 262
</span><span class="lnt"> 263
</span><span class="lnt"> 264
</span><span class="lnt"> 265
</span><span class="lnt"> 266
</span><span class="lnt"> 267
</span><span class="lnt"> 268
</span><span class="lnt"> 269
</span><span class="lnt"> 270
</span><span class="lnt"> 271
</span><span class="lnt"> 272
</span><span class="lnt"> 273
</span><span class="lnt"> 274
</span><span class="lnt"> 275
</span><span class="lnt"> 276
</span><span class="lnt"> 277
</span><span class="lnt"> 278
</span><span class="lnt"> 279
</span><span class="lnt"> 280
</span><span class="lnt"> 281
</span><span class="lnt"> 282
</span><span class="lnt"> 283
</span><span class="lnt"> 284
</span><span class="lnt"> 285
</span><span class="lnt"> 286
</span><span class="lnt"> 287
</span><span class="lnt"> 288
</span><span class="lnt"> 289
</span><span class="lnt"> 290
</span><span class="lnt"> 291
</span><span class="lnt"> 292
</span><span class="lnt"> 293
</span><span class="lnt"> 294
</span><span class="lnt"> 295
</span><span class="lnt"> 296
</span><span class="lnt"> 297
</span><span class="lnt"> 298
</span><span class="lnt"> 299
</span><span class="lnt"> 300
</span><span class="lnt"> 301
</span><span class="lnt"> 302
</span><span class="lnt"> 303
</span><span class="lnt"> 304
</span><span class="lnt"> 305
</span><span class="lnt"> 306
</span><span class="lnt"> 307
</span><span class="lnt"> 308
</span><span class="lnt"> 309
</span><span class="lnt"> 310
</span><span class="lnt"> 311
</span><span class="lnt"> 312
</span><span class="lnt"> 313
</span><span class="lnt"> 314
</span><span class="lnt"> 315
</span><span class="lnt"> 316
</span><span class="lnt"> 317
</span><span class="lnt"> 318
</span><span class="lnt"> 319
</span><span class="lnt"> 320
</span><span class="lnt"> 321
</span><span class="lnt"> 322
</span><span class="lnt"> 323
</span><span class="lnt"> 324
</span><span class="lnt"> 325
</span><span class="lnt"> 326
</span><span class="lnt"> 327
</span><span class="lnt"> 328
</span><span class="lnt"> 329
</span><span class="lnt"> 330
</span><span class="lnt"> 331
</span><span class="lnt"> 332
</span><span class="lnt"> 333
</span><span class="lnt"> 334
</span><span class="lnt"> 335
</span><span class="lnt"> 336
</span><span class="lnt"> 337
</span><span class="lnt"> 338
</span><span class="lnt"> 339
</span><span class="lnt"> 340
</span><span class="lnt"> 341
</span><span class="lnt"> 342
</span><span class="lnt"> 343
</span><span class="lnt"> 344
</span><span class="lnt"> 345
</span><span class="lnt"> 346
</span><span class="lnt"> 347
</span><span class="lnt"> 348
</span><span class="lnt"> 349
</span><span class="lnt"> 350
</span><span class="lnt"> 351
</span><span class="lnt"> 352
</span><span class="lnt"> 353
</span><span class="lnt"> 354
</span><span class="lnt"> 355
</span><span class="lnt"> 356
</span><span class="lnt"> 357
</span><span class="lnt"> 358
</span><span class="lnt"> 359
</span><span class="lnt"> 360
</span><span class="lnt"> 361
</span><span class="lnt"> 362
</span><span class="lnt"> 363
</span><span class="lnt"> 364
</span><span class="lnt"> 365
</span><span class="lnt"> 366
</span><span class="lnt"> 367
</span><span class="lnt"> 368
</span><span class="lnt"> 369
</span><span class="lnt"> 370
</span><span class="lnt"> 371
</span><span class="lnt"> 372
</span><span class="lnt"> 373
</span><span class="lnt"> 374
</span><span class="lnt"> 375
</span><span class="lnt"> 376
</span><span class="lnt"> 377
</span><span class="lnt"> 378
</span><span class="lnt"> 379
</span><span class="lnt"> 380
</span><span class="lnt"> 381
</span><span class="lnt"> 382
</span><span class="lnt"> 383
</span><span class="lnt"> 384
</span><span class="lnt"> 385
</span><span class="lnt"> 386
</span><span class="lnt"> 387
</span><span class="lnt"> 388
</span><span class="lnt"> 389
</span><span class="lnt"> 390
</span><span class="lnt"> 391
</span><span class="lnt"> 392
</span><span class="lnt"> 393
</span><span class="lnt"> 394
</span><span class="lnt"> 395
</span><span class="lnt"> 396
</span><span class="lnt"> 397
</span><span class="lnt"> 398
</span><span class="lnt"> 399
</span><span class="lnt"> 400
</span><span class="lnt"> 401
</span><span class="lnt"> 402
</span><span class="lnt"> 403
</span><span class="lnt"> 404
</span><span class="lnt"> 405
</span><span class="lnt"> 406
</span><span class="lnt"> 407
</span><span class="lnt"> 408
</span><span class="lnt"> 409
</span><span class="lnt"> 410
</span><span class="lnt"> 411
</span><span class="lnt"> 412
</span><span class="lnt"> 413
</span><span class="lnt"> 414
</span><span class="lnt"> 415
</span><span class="lnt"> 416
</span><span class="lnt"> 417
</span><span class="lnt"> 418
</span><span class="lnt"> 419
</span><span class="lnt"> 420
</span><span class="lnt"> 421
</span><span class="lnt"> 422
</span><span class="lnt"> 423
</span><span class="lnt"> 424
</span><span class="lnt"> 425
</span><span class="lnt"> 426
</span><span class="lnt"> 427
</span><span class="lnt"> 428
</span><span class="lnt"> 429
</span><span class="lnt"> 430
</span><span class="lnt"> 431
</span><span class="lnt"> 432
</span><span class="lnt"> 433
</span><span class="lnt"> 434
</span><span class="lnt"> 435
</span><span class="lnt"> 436
</span><span class="lnt"> 437
</span><span class="lnt"> 438
</span><span class="lnt"> 439
</span><span class="lnt"> 440
</span><span class="lnt"> 441
</span><span class="lnt"> 442
</span><span class="lnt"> 443
</span><span class="lnt"> 444
</span><span class="lnt"> 445
</span><span class="lnt"> 446
</span><span class="lnt"> 447
</span><span class="lnt"> 448
</span><span class="lnt"> 449
</span><span class="lnt"> 450
</span><span class="lnt"> 451
</span><span class="lnt"> 452
</span><span class="lnt"> 453
</span><span class="lnt"> 454
</span><span class="lnt"> 455
</span><span class="lnt"> 456
</span><span class="lnt"> 457
</span><span class="lnt"> 458
</span><span class="lnt"> 459
</span><span class="lnt"> 460
</span><span class="lnt"> 461
</span><span class="lnt"> 462
</span><span class="lnt"> 463
</span><span class="lnt"> 464
</span><span class="lnt"> 465
</span><span class="lnt"> 466
</span><span class="lnt"> 467
</span><span class="lnt"> 468
</span><span class="lnt"> 469
</span><span class="lnt"> 470
</span><span class="lnt"> 471
</span><span class="lnt"> 472
</span><span class="lnt"> 473
</span><span class="lnt"> 474
</span><span class="lnt"> 475
</span><span class="lnt"> 476
</span><span class="lnt"> 477
</span><span class="lnt"> 478
</span><span class="lnt"> 479
</span><span class="lnt"> 480
</span><span class="lnt"> 481
</span><span class="lnt"> 482
</span><span class="lnt"> 483
</span><span class="lnt"> 484
</span><span class="lnt"> 485
</span><span class="lnt"> 486
</span><span class="lnt"> 487
</span><span class="lnt"> 488
</span><span class="lnt"> 489
</span><span class="lnt"> 490
</span><span class="lnt"> 491
</span><span class="lnt"> 492
</span><span class="lnt"> 493
</span><span class="lnt"> 494
</span><span class="lnt"> 495
</span><span class="lnt"> 496
</span><span class="lnt"> 497
</span><span class="lnt"> 498
</span><span class="lnt"> 499
</span><span class="lnt"> 500
</span><span class="lnt"> 501
</span><span class="lnt"> 502
</span><span class="lnt"> 503
</span><span class="lnt"> 504
</span><span class="lnt"> 505
</span><span class="lnt"> 506
</span><span class="lnt"> 507
</span><span class="lnt"> 508
</span><span class="lnt"> 509
</span><span class="lnt"> 510
</span><span class="lnt"> 511
</span><span class="lnt"> 512
</span><span class="lnt"> 513
</span><span class="lnt"> 514
</span><span class="lnt"> 515
</span><span class="lnt"> 516
</span><span class="lnt"> 517
</span><span class="lnt"> 518
</span><span class="lnt"> 519
</span><span class="lnt"> 520
</span><span class="lnt"> 521
</span><span class="lnt"> 522
</span><span class="lnt"> 523
</span><span class="lnt"> 524
</span><span class="lnt"> 525
</span><span class="lnt"> 526
</span><span class="lnt"> 527
</span><span class="lnt"> 528
</span><span class="lnt"> 529
</span><span class="lnt"> 530
</span><span class="lnt"> 531
</span><span class="lnt"> 532
</span><span class="lnt"> 533
</span><span class="lnt"> 534
</span><span class="lnt"> 535
</span><span class="lnt"> 536
</span><span class="lnt"> 537
</span><span class="lnt"> 538
</span><span class="lnt"> 539
</span><span class="lnt"> 540
</span><span class="lnt"> 541
</span><span class="lnt"> 542
</span><span class="lnt"> 543
</span><span class="lnt"> 544
</span><span class="lnt"> 545
</span><span class="lnt"> 546
</span><span class="lnt"> 547
</span><span class="lnt"> 548
</span><span class="lnt"> 549
</span><span class="lnt"> 550
</span><span class="lnt"> 551
</span><span class="lnt"> 552
</span><span class="lnt"> 553
</span><span class="lnt"> 554
</span><span class="lnt"> 555
</span><span class="lnt"> 556
</span><span class="lnt"> 557
</span><span class="lnt"> 558
</span><span class="lnt"> 559
</span><span class="lnt"> 560
</span><span class="lnt"> 561
</span><span class="lnt"> 562
</span><span class="lnt"> 563
</span><span class="lnt"> 564
</span><span class="lnt"> 565
</span><span class="lnt"> 566
</span><span class="lnt"> 567
</span><span class="lnt"> 568
</span><span class="lnt"> 569
</span><span class="lnt"> 570
</span><span class="lnt"> 571
</span><span class="lnt"> 572
</span><span class="lnt"> 573
</span><span class="lnt"> 574
</span><span class="lnt"> 575
</span><span class="lnt"> 576
</span><span class="lnt"> 577
</span><span class="lnt"> 578
</span><span class="lnt"> 579
</span><span class="lnt"> 580
</span><span class="lnt"> 581
</span><span class="lnt"> 582
</span><span class="lnt"> 583
</span><span class="lnt"> 584
</span><span class="lnt"> 585
</span><span class="lnt"> 586
</span><span class="lnt"> 587
</span><span class="lnt"> 588
</span><span class="lnt"> 589
</span><span class="lnt"> 590
</span><span class="lnt"> 591
</span><span class="lnt"> 592
</span><span class="lnt"> 593
</span><span class="lnt"> 594
</span><span class="lnt"> 595
</span><span class="lnt"> 596
</span><span class="lnt"> 597
</span><span class="lnt"> 598
</span><span class="lnt"> 599
</span><span class="lnt"> 600
</span><span class="lnt"> 601
</span><span class="lnt"> 602
</span><span class="lnt"> 603
</span><span class="lnt"> 604
</span><span class="lnt"> 605
</span><span class="lnt"> 606
</span><span class="lnt"> 607
</span><span class="lnt"> 608
</span><span class="lnt"> 609
</span><span class="lnt"> 610
</span><span class="lnt"> 611
</span><span class="lnt"> 612
</span><span class="lnt"> 613
</span><span class="lnt"> 614
</span><span class="lnt"> 615
</span><span class="lnt"> 616
</span><span class="lnt"> 617
</span><span class="lnt"> 618
</span><span class="lnt"> 619
</span><span class="lnt"> 620
</span><span class="lnt"> 621
</span><span class="lnt"> 622
</span><span class="lnt"> 623
</span><span class="lnt"> 624
</span><span class="lnt"> 625
</span><span class="lnt"> 626
</span><span class="lnt"> 627
</span><span class="lnt"> 628
</span><span class="lnt"> 629
</span><span class="lnt"> 630
</span><span class="lnt"> 631
</span><span class="lnt"> 632
</span><span class="lnt"> 633
</span><span class="lnt"> 634
</span><span class="lnt"> 635
</span><span class="lnt"> 636
</span><span class="lnt"> 637
</span><span class="lnt"> 638
</span><span class="lnt"> 639
</span><span class="lnt"> 640
</span><span class="lnt"> 641
</span><span class="lnt"> 642
</span><span class="lnt"> 643
</span><span class="lnt"> 644
</span><span class="lnt"> 645
</span><span class="lnt"> 646
</span><span class="lnt"> 647
</span><span class="lnt"> 648
</span><span class="lnt"> 649
</span><span class="lnt"> 650
</span><span class="lnt"> 651
</span><span class="lnt"> 652
</span><span class="lnt"> 653
</span><span class="lnt"> 654
</span><span class="lnt"> 655
</span><span class="lnt"> 656
</span><span class="lnt"> 657
</span><span class="lnt"> 658
</span><span class="lnt"> 659
</span><span class="lnt"> 660
</span><span class="lnt"> 661
</span><span class="lnt"> 662
</span><span class="lnt"> 663
</span><span class="lnt"> 664
</span><span class="lnt"> 665
</span><span class="lnt"> 666
</span><span class="lnt"> 667
</span><span class="lnt"> 668
</span><span class="lnt"> 669
</span><span class="lnt"> 670
</span><span class="lnt"> 671
</span><span class="lnt"> 672
</span><span class="lnt"> 673
</span><span class="lnt"> 674
</span><span class="lnt"> 675
</span><span class="lnt"> 676
</span><span class="lnt"> 677
</span><span class="lnt"> 678
</span><span class="lnt"> 679
</span><span class="lnt"> 680
</span><span class="lnt"> 681
</span><span class="lnt"> 682
</span><span class="lnt"> 683
</span><span class="lnt"> 684
</span><span class="lnt"> 685
</span><span class="lnt"> 686
</span><span class="lnt"> 687
</span><span class="lnt"> 688
</span><span class="lnt"> 689
</span><span class="lnt"> 690
</span><span class="lnt"> 691
</span><span class="lnt"> 692
</span><span class="lnt"> 693
</span><span class="lnt"> 694
</span><span class="lnt"> 695
</span><span class="lnt"> 696
</span><span class="lnt"> 697
</span><span class="lnt"> 698
</span><span class="lnt"> 699
</span><span class="lnt"> 700
</span><span class="lnt"> 701
</span><span class="lnt"> 702
</span><span class="lnt"> 703
</span><span class="lnt"> 704
</span><span class="lnt"> 705
</span><span class="lnt"> 706
</span><span class="lnt"> 707
</span><span class="lnt"> 708
</span><span class="lnt"> 709
</span><span class="lnt"> 710
</span><span class="lnt"> 711
</span><span class="lnt"> 712
</span><span class="lnt"> 713
</span><span class="lnt"> 714
</span><span class="lnt"> 715
</span><span class="lnt"> 716
</span><span class="lnt"> 717
</span><span class="lnt"> 718
</span><span class="lnt"> 719
</span><span class="lnt"> 720
</span><span class="lnt"> 721
</span><span class="lnt"> 722
</span><span class="lnt"> 723
</span><span class="lnt"> 724
</span><span class="lnt"> 725
</span><span class="lnt"> 726
</span><span class="lnt"> 727
</span><span class="lnt"> 728
</span><span class="lnt"> 729
</span><span class="lnt"> 730
</span><span class="lnt"> 731
</span><span class="lnt"> 732
</span><span class="lnt"> 733
</span><span class="lnt"> 734
</span><span class="lnt"> 735
</span><span class="lnt"> 736
</span><span class="lnt"> 737
</span><span class="lnt"> 738
</span><span class="lnt"> 739
</span><span class="lnt"> 740
</span><span class="lnt"> 741
</span><span class="lnt"> 742
</span><span class="lnt"> 743
</span><span class="lnt"> 744
</span><span class="lnt"> 745
</span><span class="lnt"> 746
</span><span class="lnt"> 747
</span><span class="lnt"> 748
</span><span class="lnt"> 749
</span><span class="lnt"> 750
</span><span class="lnt"> 751
</span><span class="lnt"> 752
</span><span class="lnt"> 753
</span><span class="lnt"> 754
</span><span class="lnt"> 755
</span><span class="lnt"> 756
</span><span class="lnt"> 757
</span><span class="lnt"> 758
</span><span class="lnt"> 759
</span><span class="lnt"> 760
</span><span class="lnt"> 761
</span><span class="lnt"> 762
</span><span class="lnt"> 763
</span><span class="lnt"> 764
</span><span class="lnt"> 765
</span><span class="lnt"> 766
</span><span class="lnt"> 767
</span><span class="lnt"> 768
</span><span class="lnt"> 769
</span><span class="lnt"> 770
</span><span class="lnt"> 771
</span><span class="lnt"> 772
</span><span class="lnt"> 773
</span><span class="lnt"> 774
</span><span class="lnt"> 775
</span><span class="lnt"> 776
</span><span class="lnt"> 777
</span><span class="lnt"> 778
</span><span class="lnt"> 779
</span><span class="lnt"> 780
</span><span class="lnt"> 781
</span><span class="lnt"> 782
</span><span class="lnt"> 783
</span><span class="lnt"> 784
</span><span class="lnt"> 785
</span><span class="lnt"> 786
</span><span class="lnt"> 787
</span><span class="lnt"> 788
</span><span class="lnt"> 789
</span><span class="lnt"> 790
</span><span class="lnt"> 791
</span><span class="lnt"> 792
</span><span class="lnt"> 793
</span><span class="lnt"> 794
</span><span class="lnt"> 795
</span><span class="lnt"> 796
</span><span class="lnt"> 797
</span><span class="lnt"> 798
</span><span class="lnt"> 799
</span><span class="lnt"> 800
</span><span class="lnt"> 801
</span><span class="lnt"> 802
</span><span class="lnt"> 803
</span><span class="lnt"> 804
</span><span class="lnt"> 805
</span><span class="lnt"> 806
</span><span class="lnt"> 807
</span><span class="lnt"> 808
</span><span class="lnt"> 809
</span><span class="lnt"> 810
</span><span class="lnt"> 811
</span><span class="lnt"> 812
</span><span class="lnt"> 813
</span><span class="lnt"> 814
</span><span class="lnt"> 815
</span><span class="lnt"> 816
</span><span class="lnt"> 817
</span><span class="lnt"> 818
</span><span class="lnt"> 819
</span><span class="lnt"> 820
</span><span class="lnt"> 821
</span><span class="lnt"> 822
</span><span class="lnt"> 823
</span><span class="lnt"> 824
</span><span class="lnt"> 825
</span><span class="lnt"> 826
</span><span class="lnt"> 827
</span><span class="lnt"> 828
</span><span class="lnt"> 829
</span><span class="lnt"> 830
</span><span class="lnt"> 831
</span><span class="lnt"> 832
</span><span class="lnt"> 833
</span><span class="lnt"> 834
</span><span class="lnt"> 835
</span><span class="lnt"> 836
</span><span class="lnt"> 837
</span><span class="lnt"> 838
</span><span class="lnt"> 839
</span><span class="lnt"> 840
</span><span class="lnt"> 841
</span><span class="lnt"> 842
</span><span class="lnt"> 843
</span><span class="lnt"> 844
</span><span class="lnt"> 845
</span><span class="lnt"> 846
</span><span class="lnt"> 847
</span><span class="lnt"> 848
</span><span class="lnt"> 849
</span><span class="lnt"> 850
</span><span class="lnt"> 851
</span><span class="lnt"> 852
</span><span class="lnt"> 853
</span><span class="lnt"> 854
</span><span class="lnt"> 855
</span><span class="lnt"> 856
</span><span class="lnt"> 857
</span><span class="lnt"> 858
</span><span class="lnt"> 859
</span><span class="lnt"> 860
</span><span class="lnt"> 861
</span><span class="lnt"> 862
</span><span class="lnt"> 863
</span><span class="lnt"> 864
</span><span class="lnt"> 865
</span><span class="lnt"> 866
</span><span class="lnt"> 867
</span><span class="lnt"> 868
</span><span class="lnt"> 869
</span><span class="lnt"> 870
</span><span class="lnt"> 871
</span><span class="lnt"> 872
</span><span class="lnt"> 873
</span><span class="lnt"> 874
</span><span class="lnt"> 875
</span><span class="lnt"> 876
</span><span class="lnt"> 877
</span><span class="lnt"> 878
</span><span class="lnt"> 879
</span><span class="lnt"> 880
</span><span class="lnt"> 881
</span><span class="lnt"> 882
</span><span class="lnt"> 883
</span><span class="lnt"> 884
</span><span class="lnt"> 885
</span><span class="lnt"> 886
</span><span class="lnt"> 887
</span><span class="lnt"> 888
</span><span class="lnt"> 889
</span><span class="lnt"> 890
</span><span class="lnt"> 891
</span><span class="lnt"> 892
</span><span class="lnt"> 893
</span><span class="lnt"> 894
</span><span class="lnt"> 895
</span><span class="lnt"> 896
</span><span class="lnt"> 897
</span><span class="lnt"> 898
</span><span class="lnt"> 899
</span><span class="lnt"> 900
</span><span class="lnt"> 901
</span><span class="lnt"> 902
</span><span class="lnt"> 903
</span><span class="lnt"> 904
</span><span class="lnt"> 905
</span><span class="lnt"> 906
</span><span class="lnt"> 907
</span><span class="lnt"> 908
</span><span class="lnt"> 909
</span><span class="lnt"> 910
</span><span class="lnt"> 911
</span><span class="lnt"> 912
</span><span class="lnt"> 913
</span><span class="lnt"> 914
</span><span class="lnt"> 915
</span><span class="lnt"> 916
</span><span class="lnt"> 917
</span><span class="lnt"> 918
</span><span class="lnt"> 919
</span><span class="lnt"> 920
</span><span class="lnt"> 921
</span><span class="lnt"> 922
</span><span class="lnt"> 923
</span><span class="lnt"> 924
</span><span class="lnt"> 925
</span><span class="lnt"> 926
</span><span class="lnt"> 927
</span><span class="lnt"> 928
</span><span class="lnt"> 929
</span><span class="lnt"> 930
</span><span class="lnt"> 931
</span><span class="lnt"> 932
</span><span class="lnt"> 933
</span><span class="lnt"> 934
</span><span class="lnt"> 935
</span><span class="lnt"> 936
</span><span class="lnt"> 937
</span><span class="lnt"> 938
</span><span class="lnt"> 939
</span><span class="lnt"> 940
</span><span class="lnt"> 941
</span><span class="lnt"> 942
</span><span class="lnt"> 943
</span><span class="lnt"> 944
</span><span class="lnt"> 945
</span><span class="lnt"> 946
</span><span class="lnt"> 947
</span><span class="lnt"> 948
</span><span class="lnt"> 949
</span><span class="lnt"> 950
</span><span class="lnt"> 951
</span><span class="lnt"> 952
</span><span class="lnt"> 953
</span><span class="lnt"> 954
</span><span class="lnt"> 955
</span><span class="lnt"> 956
</span><span class="lnt"> 957
</span><span class="lnt"> 958
</span><span class="lnt"> 959
</span><span class="lnt"> 960
</span><span class="lnt"> 961
</span><span class="lnt"> 962
</span><span class="lnt"> 963
</span><span class="lnt"> 964
</span><span class="lnt"> 965
</span><span class="lnt"> 966
</span><span class="lnt"> 967
</span><span class="lnt"> 968
</span><span class="lnt"> 969
</span><span class="lnt"> 970
</span><span class="lnt"> 971
</span><span class="lnt"> 972
</span><span class="lnt"> 973
</span><span class="lnt"> 974
</span><span class="lnt"> 975
</span><span class="lnt"> 976
</span><span class="lnt"> 977
</span><span class="lnt"> 978
</span><span class="lnt"> 979
</span><span class="lnt"> 980
</span><span class="lnt"> 981
</span><span class="lnt"> 982
</span><span class="lnt"> 983
</span><span class="lnt"> 984
</span><span class="lnt"> 985
</span><span class="lnt"> 986
</span><span class="lnt"> 987
</span><span class="lnt"> 988
</span><span class="lnt"> 989
</span><span class="lnt"> 990
</span><span class="lnt"> 991
</span><span class="lnt"> 992
</span><span class="lnt"> 993
</span><span class="lnt"> 994
</span><span class="lnt"> 995
</span><span class="lnt"> 996
</span><span class="lnt"> 997
</span><span class="lnt"> 998
</span><span class="lnt"> 999
</span><span class="lnt">1000
</span><span class="lnt">1001
</span><span class="lnt">1002
</span><span class="lnt">1003
</span><span class="lnt">1004
</span><span class="lnt">1005
</span><span class="lnt">1006
</span><span class="lnt">1007
</span><span class="lnt">1008
</span><span class="lnt">1009
</span><span class="lnt">1010
</span><span class="lnt">1011
</span><span class="lnt">1012
</span><span class="lnt">1013
</span><span class="lnt">1014
</span><span class="lnt">1015
</span><span class="lnt">1016
</span><span class="lnt">1017
</span><span class="lnt">1018
</span><span class="lnt">1019
</span><span class="lnt">1020
</span><span class="lnt">1021
</span><span class="lnt">1022
</span><span class="lnt">1023
</span><span class="lnt">1024
</span><span class="lnt">1025
</span><span class="lnt">1026
</span><span class="lnt">1027
</span><span class="lnt">1028
</span><span class="lnt">1029
</span><span class="lnt">1030
</span><span class="lnt">1031
</span><span class="lnt">1032
</span><span class="lnt">1033
</span><span class="lnt">1034
</span><span class="lnt">1035
</span><span class="lnt">1036
</span><span class="lnt">1037
</span><span class="lnt">1038
</span><span class="lnt">1039
</span><span class="lnt">1040
</span><span class="lnt">1041
</span><span class="lnt">1042
</span><span class="lnt">1043
</span><span class="lnt">1044
</span><span class="lnt">1045
</span><span class="lnt">1046
</span><span class="lnt">1047
</span><span class="lnt">1048
</span><span class="lnt">1049
</span><span class="lnt">1050
</span><span class="lnt">1051
</span><span class="lnt">1052
</span><span class="lnt">1053
</span><span class="lnt">1054
</span><span class="lnt">1055
</span><span class="lnt">1056
</span><span class="lnt">1057
</span><span class="lnt">1058
</span><span class="lnt">1059
</span><span class="lnt">1060
</span><span class="lnt">1061
</span><span class="lnt">1062
</span><span class="lnt">1063
</span><span class="lnt">1064
</span><span class="lnt">1065
</span><span class="lnt">1066
</span><span class="lnt">1067
</span><span class="lnt">1068
</span><span class="lnt">1069
</span><span class="lnt">1070
</span><span class="lnt">1071
</span><span class="lnt">1072
</span><span class="lnt">1073
</span><span class="lnt">1074
</span><span class="lnt">1075
</span><span class="lnt">1076
</span><span class="lnt">1077
</span><span class="lnt">1078
</span><span class="lnt">1079
</span><span class="lnt">1080
</span><span class="lnt">1081
</span><span class="lnt">1082
</span><span class="lnt">1083
</span><span class="lnt">1084
</span><span class="lnt">1085
</span><span class="lnt">1086
</span><span class="lnt">1087
</span><span class="lnt">1088
</span><span class="lnt">1089
</span><span class="lnt">1090
</span><span class="lnt">1091
</span><span class="lnt">1092
</span><span class="lnt">1093
</span><span class="lnt">1094
</span><span class="lnt">1095
</span><span class="lnt">1096
</span><span class="lnt">1097
</span><span class="lnt">1098
</span><span class="lnt">1099
</span><span class="lnt">1100
</span><span class="lnt">1101
</span><span class="lnt">1102
</span><span class="lnt">1103
</span><span class="lnt">1104
</span><span class="lnt">1105
</span><span class="lnt">1106
</span><span class="lnt">1107
</span><span class="lnt">1108
</span><span class="lnt">1109
</span><span class="lnt">1110
</span><span class="lnt">1111
</span><span class="lnt">1112
</span><span class="lnt">1113
</span><span class="lnt">1114
</span><span class="lnt">1115
</span><span class="lnt">1116
</span><span class="lnt">1117
</span><span class="lnt">1118
</span><span class="lnt">1119
</span><span class="lnt">1120
</span><span class="lnt">1121
</span><span class="lnt">1122
</span><span class="lnt">1123
</span><span class="lnt">1124
</span><span class="lnt">1125
</span><span class="lnt">1126
</span><span class="lnt">1127
</span><span class="lnt">1128
</span><span class="lnt">1129
</span><span class="lnt">1130
</span><span class="lnt">1131
</span><span class="lnt">1132
</span><span class="lnt">1133
</span><span class="lnt">1134
</span><span class="lnt">1135
</span><span class="lnt">1136
</span><span class="lnt">1137
</span><span class="lnt">1138
</span><span class="lnt">1139
</span><span class="lnt">1140
</span><span class="lnt">1141
</span><span class="lnt">1142
</span><span class="lnt">1143
</span><span class="lnt">1144
</span><span class="lnt">1145
</span><span class="lnt">1146
</span><span class="lnt">1147
</span><span class="lnt">1148
</span><span class="lnt">1149
</span><span class="lnt">1150
</span><span class="lnt">1151
</span><span class="lnt">1152
</span><span class="lnt">1153
</span><span class="lnt">1154
</span><span class="lnt">1155
</span><span class="lnt">1156
</span><span class="lnt">1157
</span><span class="lnt">1158
</span><span class="lnt">1159
</span><span class="lnt">1160
</span><span class="lnt">1161
</span><span class="lnt">1162
</span><span class="lnt">1163
</span><span class="lnt">1164
</span><span class="lnt">1165
</span><span class="lnt">1166
</span><span class="lnt">1167
</span><span class="lnt">1168
</span><span class="lnt">1169
</span><span class="lnt">1170
</span><span class="lnt">1171
</span><span class="lnt">1172
</span><span class="lnt">1173
</span><span class="lnt">1174
</span><span class="lnt">1175
</span><span class="lnt">1176
</span><span class="lnt">1177
</span><span class="lnt">1178
</span><span class="lnt">1179
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="c1">// 角色分类  
</span><span class="c1"></span><span class="kd">const</span> <span class="p">(</span>
	<span class="nx">follower</span>  <span class="p">=</span> <span class="s">&#34;Follower&#34;</span>
	<span class="nx">candidate</span> <span class="p">=</span> <span class="s">&#34;Candidate&#34;</span>
	<span class="nx">leader</span>    <span class="p">=</span> <span class="s">&#34;Leader&#34;</span>
<span class="p">)</span>

<span class="kd">const</span> <span class="p">(</span>
	<span class="nx">unknownLeader</span> <span class="p">=</span> <span class="mi">0</span>
	<span class="nx">noVote</span>        <span class="p">=</span> <span class="mi">0</span>
<span class="p">)</span>

<span class="c1">// 选举时间随机范围[MinimumElectionTimeoutMS, maximumElectionTimeoutMS]
</span><span class="c1"></span><span class="kd">var</span> <span class="p">(</span>
	<span class="nx">MinimumElectionTimeoutMS</span> <span class="kt">int32</span> <span class="p">=</span> <span class="mi">250</span>

	<span class="nx">maximumElectionTimeoutMS</span> <span class="p">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="nx">MinimumElectionTimeoutMS</span>
<span class="p">)</span>

<span class="kd">var</span> <span class="p">(</span>
	<span class="nx">errNotLeader</span>             <span class="p">=</span> <span class="nx">errors</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span><span class="s">&#34;not the leader&#34;</span><span class="p">)</span>
	<span class="nx">errUnknownLeader</span>         <span class="p">=</span> <span class="nx">errors</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span><span class="s">&#34;unknown leader&#34;</span><span class="p">)</span>
	<span class="nx">errDeposed</span>               <span class="p">=</span> <span class="nx">errors</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span><span class="s">&#34;deposed during replication&#34;</span><span class="p">)</span>
	<span class="nx">errAppendE</span><span class="err">#</span><span class="mo">00</span><span class="mi">8000</span><span class="nx">ntriesRejected</span> <span class="p">=</span> <span class="nx">errors</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span><span class="s">&#34;appendEntries RPC rejected&#34;</span><span class="p">)</span>
	<span class="nx">errReplicationFailed</span>     <span class="p">=</span> <span class="nx">errors</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span><span class="s">&#34;command replication failed (but will keep retrying)&#34;</span><span class="p">)</span>
	<span class="nx">errOutOfSync</span>             <span class="p">=</span> <span class="nx">errors</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span><span class="s">&#34;out of sync&#34;</span><span class="p">)</span>
	<span class="nx">errAlreadyRunning</span>        <span class="p">=</span> <span class="nx">errors</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span><span class="s">&#34;already running&#34;</span><span class="p">)</span>
<span class="p">)</span>

<span class="c1">// 重置选举时间
</span><span class="c1"></span><span class="kd">func</span> <span class="nf">resetElectionTimeoutMS</span><span class="p">(</span><span class="nx">newMin</span><span class="p">,</span> <span class="nx">newMax</span> <span class="kt">int</span><span class="p">)</span> <span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="kt">int</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">oldMin</span> <span class="o">:=</span> <span class="nx">atomic</span><span class="p">.</span><span class="nf">LoadInt32</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">MinimumElectionTimeoutMS</span><span class="p">)</span>
	<span class="nx">oldMax</span> <span class="o">:=</span> <span class="nx">atomic</span><span class="p">.</span><span class="nf">LoadInt32</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">maximumElectionTimeoutMS</span><span class="p">)</span>
	<span class="nx">atomic</span><span class="p">.</span><span class="nf">StoreInt32</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">MinimumElectionTimeoutMS</span><span class="p">,</span> <span class="nb">int32</span><span class="p">(</span><span class="nx">newMin</span><span class="p">))</span>
	<span class="nx">atomic</span><span class="p">.</span><span class="nf">StoreInt32</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">maximumElectionTimeoutMS</span><span class="p">,</span> <span class="nb">int32</span><span class="p">(</span><span class="nx">newMax</span><span class="p">))</span>
	<span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="nx">oldMin</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="nx">oldMax</span><span class="p">)</span>
<span class="p">}</span>

<span class="c1">// minimumElectionTimeout returns the current minimum election timeout.
</span><span class="c1"></span><span class="kd">func</span> <span class="nf">minimumElectionTimeout</span><span class="p">()</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Duration</span> <span class="p">{</span>
	<span class="k">return</span> <span class="nx">time</span><span class="p">.</span><span class="nf">Duration</span><span class="p">(</span><span class="nx">MinimumElectionTimeoutMS</span><span class="p">)</span> <span class="o">*</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Millisecond</span>
<span class="p">}</span>

<span class="c1">// maximumElectionTimeout returns the current maximum election time.
</span><span class="c1"></span><span class="kd">func</span> <span class="nf">maximumElectionTimeout</span><span class="p">()</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Duration</span> <span class="p">{</span>
	<span class="k">return</span> <span class="nx">time</span><span class="p">.</span><span class="nf">Duration</span><span class="p">(</span><span class="nx">maximumElectionTimeoutMS</span><span class="p">)</span> <span class="o">*</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Millisecond</span>
<span class="p">}</span>

<span class="c1">// 选举时间随机函数
</span><span class="c1"></span><span class="kd">func</span> <span class="nf">electionTimeout</span><span class="p">()</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Duration</span> <span class="p">{</span>
	<span class="nx">n</span> <span class="o">:=</span> <span class="nx">rand</span><span class="p">.</span><span class="nf">Intn</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="nx">maximumElectionTimeoutMS</span> <span class="o">-</span> <span class="nx">MinimumElectionTimeoutMS</span><span class="p">))</span>
	<span class="nx">d</span> <span class="o">:=</span> <span class="nb">int</span><span class="p">(</span><span class="nx">MinimumElectionTimeoutMS</span><span class="p">)</span> <span class="o">+</span> <span class="nx">n</span>
	<span class="k">return</span> <span class="nx">time</span><span class="p">.</span><span class="nf">Duration</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="o">*</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Millisecond</span>
<span class="p">}</span>

<span class="c1">// broadcastInterval returns the interval between heartbeats (AppendEntry RPCs)
</span><span class="c1">// broadcast from the leader. It is the minimum election timeout / 10, as
</span><span class="c1">// dictated by the spec: BroadcastInterval &lt;&lt; ElectionTimeout &lt;&lt; MTBF.
</span><span class="c1">// 广播时间，用于Leader发送心跳广播，这个时间应小于选举时间；否则，非Leader节点会产生选举操作
</span><span class="c1"></span><span class="kd">func</span> <span class="nf">broadcastInterval</span><span class="p">()</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Duration</span> <span class="p">{</span>
	<span class="nx">d</span> <span class="o">:=</span> <span class="nx">MinimumElectionTimeoutMS</span> <span class="o">/</span> <span class="mi">10</span>
	<span class="k">return</span> <span class="nx">time</span><span class="p">.</span><span class="nf">Duration</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="o">*</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Millisecond</span>
<span class="p">}</span>

<span class="c1">// protectedString is just a string protected by a mutex.
</span><span class="c1"></span><span class="kd">type</span> <span class="nx">protectedString</span> <span class="kd">struct</span> <span class="p">{</span>
	<span class="nx">sync</span><span class="p">.</span><span class="nx">RWMutex</span>
	<span class="nx">value</span> <span class="kt">string</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">s</span> <span class="o">*</span><span class="nx">protectedString</span><span class="p">)</span> <span class="nf">Get</span><span class="p">()</span> <span class="kt">string</span> <span class="p">{</span>
	<span class="nx">s</span><span class="p">.</span><span class="nf">RLock</span><span class="p">()</span>
	<span class="k">defer</span> <span class="nx">s</span><span class="p">.</span><span class="nf">RUnlock</span><span class="p">()</span>
	<span class="k">return</span> <span class="nx">s</span><span class="p">.</span><span class="nx">value</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">s</span> <span class="o">*</span><span class="nx">protectedString</span><span class="p">)</span> <span class="nf">Set</span><span class="p">(</span><span class="nx">value</span> <span class="kt">string</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">s</span><span class="p">.</span><span class="nf">Lock</span><span class="p">()</span>
	<span class="k">defer</span> <span class="nx">s</span><span class="p">.</span><span class="nf">Unlock</span><span class="p">()</span>
	<span class="nx">s</span><span class="p">.</span><span class="nx">value</span> <span class="p">=</span> <span class="nx">value</span>
<span class="p">}</span>

<span class="c1">// protectedBool is just a bool protected by a mutex.
</span><span class="c1"></span><span class="kd">type</span> <span class="nx">protectedBool</span> <span class="kd">struct</span> <span class="p">{</span>
	<span class="nx">sync</span><span class="p">.</span><span class="nx">RWMutex</span>
	<span class="nx">value</span> <span class="kt">bool</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">s</span> <span class="o">*</span><span class="nx">protectedBool</span><span class="p">)</span> <span class="nf">Get</span><span class="p">()</span> <span class="kt">bool</span> <span class="p">{</span>
	<span class="nx">s</span><span class="p">.</span><span class="nf">RLock</span><span class="p">()</span>
	<span class="k">defer</span> <span class="nx">s</span><span class="p">.</span><span class="nf">RUnlock</span><span class="p">()</span>
	<span class="k">return</span> <span class="nx">s</span><span class="p">.</span><span class="nx">value</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">s</span> <span class="o">*</span><span class="nx">protectedBool</span><span class="p">)</span> <span class="nf">Set</span><span class="p">(</span><span class="nx">value</span> <span class="kt">bool</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">s</span><span class="p">.</span><span class="nf">Lock</span><span class="p">()</span>
	<span class="k">defer</span> <span class="nx">s</span><span class="p">.</span><span class="nf">Unlock</span><span class="p">()</span>
	<span class="nx">s</span><span class="p">.</span><span class="nx">value</span> <span class="p">=</span> <span class="nx">value</span>
<span class="p">}</span>

<span class="c1">// Server is the agent that performs all of the Raft protocol logic.
</span><span class="c1">// In a typical application, each running process that wants to be part of
</span><span class="c1">// the distributed state machine will contain a server component.
</span><span class="c1"></span><span class="kd">type</span> <span class="nx">Server</span> <span class="kd">struct</span> <span class="p">{</span>
	<span class="nx">id</span>      <span class="kt">uint64</span> <span class="c1">// id of this server
</span><span class="c1"></span>    <span class="c1">// 节点状态
</span><span class="c1"></span>	<span class="nx">state</span>   <span class="o">*</span><span class="nx">protectedString</span>
    <span class="c1">// 节点运行状态
</span><span class="c1"></span>	<span class="nx">running</span> <span class="o">*</span><span class="nx">protectedBool</span>
    <span class="c1">// Leader节点标示
</span><span class="c1"></span>	<span class="nx">leader</span>  <span class="kt">uint64</span> 
    <span class="c1">// 当前节点任期号
</span><span class="c1"></span>	<span class="nx">term</span>    <span class="kt">uint64</span> <span class="c1">// &#34;current term number, which increases monotonically&#34;
</span><span class="c1"></span>    <span class="c1">// 0表示，当前节点还有投出自己的票;
</span><span class="c1"></span>    <span class="c1">// 非零表示节点已经投票了，值是获票者的标示ID
</span><span class="c1"></span>	<span class="nx">vote</span>    <span class="kt">uint64</span> <span class="c1">// who we voted for this term, if applicable
</span><span class="c1"></span>	<span class="nx">log</span>     <span class="o">*</span><span class="nx">raftLog</span>
	<span class="nx">config</span>  <span class="o">*</span><span class="nx">configuration</span>

    <span class="c1">// 追加日志信道
</span><span class="c1"></span>	<span class="nx">appendEntriesChan</span> <span class="kd">chan</span> <span class="nx">appendEntriesTuple</span>
  	<span class="c1">// 投票信道
</span><span class="c1"></span>	<span class="nx">requestVoteChan</span>   <span class="kd">chan</span> <span class="nx">requestVoteTuple</span>
  	<span class="c1">// 命令信道
</span><span class="c1"></span>	<span class="nx">commandChan</span>       <span class="kd">chan</span> <span class="nx">commandTuple</span>
  	<span class="c1">// 配置修改信道
</span><span class="c1"></span>	<span class="nx">configurationChan</span> <span class="kd">chan</span> <span class="nx">configurationTuple</span>

  	<span class="c1">// 选举信道
</span><span class="c1"></span>	<span class="nx">electionTick</span> <span class="o">&lt;-</span><span class="kd">chan</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Time</span>
  	<span class="c1">// 退出信道
</span><span class="c1"></span>	<span class="nx">quit</span>         <span class="kd">chan</span> <span class="kd">chan</span> <span class="kd">struct</span><span class="p">{}</span>
<span class="p">}</span>

<span class="c1">// 状态机函数
</span><span class="c1">// 该函数不可并发执行，否则就达不到一致性状态机的效果(执行时间不要超过选举时间)
</span><span class="c1"></span>
<span class="c1">// 正常来说，只有&#34;共识&#34;达成的时候，才会调用该函数，然后返回给客户端
</span><span class="c1">// 但是，在这里为了简化实现，&#34;共识“算法是放在后台任务操作的，客户端发送命令单Leader时，Leader马上
</span><span class="c1">// 应答客户端，并没有等”共识算法“的共识结果
</span><span class="c1"></span><span class="kd">type</span> <span class="nx">ApplyFunc</span> <span class="kd">func</span><span class="p">(</span><span class="nx">commitIndex</span> <span class="kt">uint64</span><span class="p">,</span> <span class="nx">cmd</span> <span class="p">[]</span><span class="kt">byte</span><span class="p">)</span> <span class="p">[]</span><span class="kt">byte</span>

<span class="c1">// 初始化节点
</span><span class="c1">// 1. 构建日志 2.初始化为&#34;follower&#34;角色 3.leader为&#34;unknown&#34;
</span><span class="c1"></span><span class="kd">func</span> <span class="nf">NewServer</span><span class="p">(</span><span class="nx">id</span> <span class="kt">uint64</span><span class="p">,</span> <span class="nx">store</span> <span class="nx">io</span><span class="p">.</span><span class="nx">ReadWriter</span><span class="p">,</span> <span class="nx">a</span> <span class="nx">ApplyFunc</span><span class="p">)</span> <span class="o">*</span><span class="nx">Server</span> <span class="p">{</span>
	<span class="k">if</span> <span class="nx">id</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="p">{</span>
		<span class="nb">panic</span><span class="p">(</span><span class="s">&#34;server id must be &gt; 0&#34;</span><span class="p">)</span>
	<span class="p">}</span>

	<span class="c1">// 5.2 Leader election: &#34;the latest term this server has seen is persisted,
</span><span class="c1"></span>	<span class="c1">// and is initialized to 0 on first boot.&#34;
</span><span class="c1"></span>	<span class="nx">log</span> <span class="o">:=</span> <span class="nf">newRaftLog</span><span class="p">(</span><span class="nx">store</span><span class="p">,</span> <span class="nx">a</span><span class="p">)</span>
	<span class="nx">latestTerm</span> <span class="o">:=</span> <span class="nx">log</span><span class="p">.</span><span class="nf">lastTerm</span><span class="p">()</span>

	<span class="nx">s</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">Server</span><span class="p">{</span>
		<span class="nx">id</span><span class="p">:</span>      <span class="nx">id</span><span class="p">,</span>
		<span class="nx">state</span><span class="p">:</span>   <span class="o">&amp;</span><span class="nx">protectedString</span><span class="p">{</span><span class="nx">value</span><span class="p">:</span> <span class="nx">follower</span><span class="p">},</span> <span class="c1">// &#34;when servers start up they begin as followers&#34;
</span><span class="c1"></span>		<span class="nx">running</span><span class="p">:</span> <span class="o">&amp;</span><span class="nx">protectedBool</span><span class="p">{</span><span class="nx">value</span><span class="p">:</span> <span class="kc">false</span><span class="p">},</span>
		<span class="nx">leader</span><span class="p">:</span>  <span class="nx">unknownLeader</span><span class="p">,</span> <span class="c1">// unknown at startup
</span><span class="c1"></span>		<span class="nx">log</span><span class="p">:</span>     <span class="nx">log</span><span class="p">,</span>
		<span class="nx">term</span><span class="p">:</span>    <span class="nx">latestTerm</span><span class="p">,</span>
		<span class="nx">config</span><span class="p">:</span>  <span class="nf">newConfiguration</span><span class="p">(</span><span class="nx">peerMap</span><span class="p">{}),</span>

		<span class="nx">appendEntriesChan</span><span class="p">:</span> <span class="nb">make</span><span class="p">(</span><span class="kd">chan</span> <span class="nx">appendEntriesTuple</span><span class="p">),</span>
		<span class="nx">requestVoteChan</span><span class="p">:</span>   <span class="nb">make</span><span class="p">(</span><span class="kd">chan</span> <span class="nx">requestVoteTuple</span><span class="p">),</span>
		<span class="nx">commandChan</span><span class="p">:</span>       <span class="nb">make</span><span class="p">(</span><span class="kd">chan</span> <span class="nx">commandTuple</span><span class="p">),</span>
		<span class="nx">configurationChan</span><span class="p">:</span> <span class="nb">make</span><span class="p">(</span><span class="kd">chan</span> <span class="nx">configurationTuple</span><span class="p">),</span>

		<span class="nx">electionTick</span><span class="p">:</span> <span class="kc">nil</span><span class="p">,</span>
		<span class="nx">quit</span><span class="p">:</span>         <span class="nb">make</span><span class="p">(</span><span class="kd">chan</span> <span class="kd">chan</span> <span class="kd">struct</span><span class="p">{}),</span>
	<span class="p">}</span>
	<span class="nx">s</span><span class="p">.</span><span class="nf">resetElectionTimeout</span><span class="p">()</span>
	<span class="k">return</span> <span class="nx">s</span>
<span class="p">}</span>

<span class="kd">type</span> <span class="nx">configurationTuple</span> <span class="kd">struct</span> <span class="p">{</span>
	<span class="nx">Peers</span> <span class="p">[]</span><span class="nx">Peer</span>
	<span class="nx">Err</span>   <span class="kd">chan</span> <span class="kt">error</span>
<span class="p">}</span>

<span class="c1">// 设置配置
</span><span class="c1">// 1. 服务启动时，先设置配置
</span><span class="c1">// 2. 集群变更时，设置配置
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">s</span> <span class="o">*</span><span class="nx">Server</span><span class="p">)</span> <span class="nf">SetConfiguration</span><span class="p">(</span><span class="nx">peers</span> <span class="o">...</span><span class="nx">Peer</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
    <span class="c1">// 节点刚启动
</span><span class="c1"></span>	<span class="k">if</span> <span class="p">!</span><span class="nx">s</span><span class="p">.</span><span class="nx">running</span><span class="p">.</span><span class="nf">Get</span><span class="p">()</span> <span class="p">{</span>
		<span class="nx">s</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nf">directSet</span><span class="p">(</span><span class="nf">makePeerMap</span><span class="p">(</span><span class="nx">peers</span><span class="o">...</span><span class="p">))</span>
		<span class="k">return</span> <span class="kc">nil</span>
	<span class="p">}</span>

	<span class="nx">err</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">(</span><span class="kd">chan</span> <span class="kt">error</span><span class="p">)</span>
    <span class="c1">// 节点已经启动了
</span><span class="c1"></span>	<span class="nx">s</span><span class="p">.</span><span class="nx">configurationChan</span> <span class="o">&lt;-</span> <span class="nx">configurationTuple</span><span class="p">{</span><span class="nx">peers</span><span class="p">,</span> <span class="nx">err</span><span class="p">}</span>
	<span class="k">return</span> <span class="o">&lt;-</span><span class="nx">err</span>
<span class="p">}</span>

<span class="c1">// Start triggers the server to begin communicating with its peers.
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">s</span> <span class="o">*</span><span class="nx">Server</span><span class="p">)</span> <span class="nf">Start</span><span class="p">()</span> <span class="p">{</span>
	<span class="k">go</span> <span class="nx">s</span><span class="p">.</span><span class="nf">loop</span><span class="p">()</span>
<span class="p">}</span>

<span class="c1">// Stop terminates the server. Stopped servers should not be restarted.
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">s</span> <span class="o">*</span><span class="nx">Server</span><span class="p">)</span> <span class="nf">Stop</span><span class="p">()</span> <span class="p">{</span>
	<span class="nx">q</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">(</span><span class="kd">chan</span> <span class="kd">struct</span><span class="p">{})</span>
	<span class="nx">s</span><span class="p">.</span><span class="nx">quit</span> <span class="o">&lt;-</span> <span class="nx">q</span>
	<span class="o">&lt;-</span><span class="nx">q</span>
	<span class="nx">s</span><span class="p">.</span><span class="nf">logGeneric</span><span class="p">(</span><span class="s">&#34;server stopped&#34;</span><span class="p">)</span>
<span class="p">}</span>

<span class="c1">// 命令元组
</span><span class="c1"></span><span class="kd">type</span> <span class="nx">commandTuple</span> <span class="kd">struct</span> <span class="p">{</span>
  	<span class="c1">// 命令内容
</span><span class="c1"></span>	<span class="nx">Command</span>         <span class="p">[]</span><span class="kt">byte</span>
  	<span class="c1">// 命令信道
</span><span class="c1"></span>	<span class="nx">CommandResponse</span> <span class="kd">chan</span><span class="o">&lt;-</span> <span class="p">[]</span><span class="kt">byte</span>
	<span class="nx">Err</span>             <span class="kd">chan</span> <span class="kt">error</span>
<span class="p">}</span>

<span class="c1">// 命令接口
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">s</span> <span class="o">*</span><span class="nx">Server</span><span class="p">)</span> <span class="nf">Command</span><span class="p">(</span><span class="nx">cmd</span> <span class="p">[]</span><span class="kt">byte</span><span class="p">,</span> <span class="nx">response</span> <span class="kd">chan</span><span class="o">&lt;-</span> <span class="p">[]</span><span class="kt">byte</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
	<span class="nx">err</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">(</span><span class="kd">chan</span> <span class="kt">error</span><span class="p">)</span>
	<span class="nx">s</span><span class="p">.</span><span class="nx">commandChan</span> <span class="o">&lt;-</span> <span class="nx">commandTuple</span><span class="p">{</span><span class="nx">cmd</span><span class="p">,</span> <span class="nx">response</span><span class="p">,</span> <span class="nx">err</span><span class="p">}</span>
	<span class="k">return</span> <span class="o">&lt;-</span><span class="nx">err</span>
<span class="p">}</span>

<span class="c1">// 日志追加
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">s</span> <span class="o">*</span><span class="nx">Server</span><span class="p">)</span> <span class="nf">appendEntries</span><span class="p">(</span><span class="nx">ae</span> <span class="nx">appendEntries</span><span class="p">)</span> <span class="nx">appendEntriesResponse</span> <span class="p">{</span>
	<span class="nx">t</span> <span class="o">:=</span> <span class="nx">appendEntriesTuple</span><span class="p">{</span>
		<span class="nx">Request</span><span class="p">:</span>  <span class="nx">ae</span><span class="p">,</span>
		<span class="nx">Response</span><span class="p">:</span> <span class="nb">make</span><span class="p">(</span><span class="kd">chan</span> <span class="nx">appendEntriesResponse</span><span class="p">),</span>
	<span class="p">}</span>
	<span class="nx">s</span><span class="p">.</span><span class="nx">appendEntriesChan</span> <span class="o">&lt;-</span> <span class="nx">t</span>
	<span class="k">return</span> <span class="o">&lt;-</span><span class="nx">t</span><span class="p">.</span><span class="nx">Response</span>
<span class="p">}</span>

<span class="c1">// 投票
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">s</span> <span class="o">*</span><span class="nx">Server</span><span class="p">)</span> <span class="nf">requestVote</span><span class="p">(</span><span class="nx">rv</span> <span class="nx">requestVote</span><span class="p">)</span> <span class="nx">requestVoteResponse</span> <span class="p">{</span>
	<span class="nx">t</span> <span class="o">:=</span> <span class="nx">requestVoteTuple</span><span class="p">{</span>
		<span class="nx">Request</span><span class="p">:</span>  <span class="nx">rv</span><span class="p">,</span>
		<span class="nx">Response</span><span class="p">:</span> <span class="nb">make</span><span class="p">(</span><span class="kd">chan</span> <span class="nx">requestVoteResponse</span><span class="p">),</span>
	<span class="p">}</span>
	<span class="nx">s</span><span class="p">.</span><span class="nx">requestVoteChan</span> <span class="o">&lt;-</span> <span class="nx">t</span>
	<span class="k">return</span> <span class="o">&lt;-</span><span class="nx">t</span><span class="p">.</span><span class="nx">Response</span>
<span class="p">}</span>

<span class="c1">//                                  times out,
</span><span class="c1">//                                 new election
</span><span class="c1">//     |                             .-----.
</span><span class="c1">//     |                             |     |
</span><span class="c1">//     v         times out,          |     v     receives votes from
</span><span class="c1">// +----------+  starts election  +-----------+  majority of servers  +--------+
</span><span class="c1">// | Follower |------------------&gt;| Candidate |----------------------&gt;| Leader |
</span><span class="c1">// +----------+                   +-----------+                       +--------+
</span><span class="c1">//     ^ ^                              |                                 |
</span><span class="c1">//     | |    discovers current leader  |                                 |
</span><span class="c1">//     | |                 or new term  |                                 |
</span><span class="c1">//     | &#39;------------------------------&#39;                                 |
</span><span class="c1">//     |                                                                  |
</span><span class="c1">//     |                               discovers server with higher term  |
</span><span class="c1">//     &#39;------------------------------------------------------------------&#39;
</span><span class="c1">//
</span><span class="c1">//
</span><span class="c1"></span>
<span class="kd">func</span> <span class="p">(</span><span class="nx">s</span> <span class="o">*</span><span class="nx">Server</span><span class="p">)</span> <span class="nf">loop</span><span class="p">()</span> <span class="p">{</span>
	<span class="nx">s</span><span class="p">.</span><span class="nx">running</span><span class="p">.</span><span class="nf">Set</span><span class="p">(</span><span class="kc">true</span><span class="p">)</span>
	<span class="k">for</span> <span class="nx">s</span><span class="p">.</span><span class="nx">running</span><span class="p">.</span><span class="nf">Get</span><span class="p">()</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="nx">state</span> <span class="o">:=</span> <span class="nx">s</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nf">Get</span><span class="p">();</span> <span class="nx">state</span> <span class="p">{</span>
		<span class="k">case</span> <span class="nx">follower</span><span class="p">:</span>
			<span class="nx">s</span><span class="p">.</span><span class="nf">followerSelect</span><span class="p">()</span>
		<span class="k">case</span> <span class="nx">candidate</span><span class="p">:</span>
			<span class="nx">s</span><span class="p">.</span><span class="nf">candidateSelect</span><span class="p">()</span>
		<span class="k">case</span> <span class="nx">leader</span><span class="p">:</span>
			<span class="nx">s</span><span class="p">.</span><span class="nf">leaderSelect</span><span class="p">()</span>
		<span class="k">default</span><span class="p">:</span>
			<span class="nb">panic</span><span class="p">(</span><span class="nx">fmt</span><span class="p">.</span><span class="nf">Sprintf</span><span class="p">(</span><span class="s">&#34;unknown Server State &#39;%s&#39;&#34;</span><span class="p">,</span> <span class="nx">state</span><span class="p">))</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">s</span> <span class="o">*</span><span class="nx">Server</span><span class="p">)</span> <span class="nf">resetElectionTimeout</span><span class="p">()</span> <span class="p">{</span>
	<span class="nx">s</span><span class="p">.</span><span class="nx">electionTick</span> <span class="p">=</span> <span class="nx">time</span><span class="p">.</span><span class="nf">NewTimer</span><span class="p">(</span><span class="nf">electionTimeout</span><span class="p">()).</span><span class="nx">C</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">s</span> <span class="o">*</span><span class="nx">Server</span><span class="p">)</span> <span class="nf">logGeneric</span><span class="p">(</span><span class="nx">format</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">args</span> <span class="o">...</span><span class="kd">interface</span><span class="p">{})</span> <span class="p">{</span>
	<span class="nx">prefix</span> <span class="o">:=</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Sprintf</span><span class="p">(</span><span class="s">&#34;id=%d term=%d state=%s: &#34;</span><span class="p">,</span> <span class="nx">s</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span> <span class="nx">s</span><span class="p">.</span><span class="nx">term</span><span class="p">,</span> <span class="nx">s</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nf">Get</span><span class="p">())</span>
	<span class="nx">log</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="nx">prefix</span><span class="o">+</span><span class="nx">format</span><span class="p">,</span> <span class="nx">args</span><span class="o">...</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">s</span> <span class="o">*</span><span class="nx">Server</span><span class="p">)</span> <span class="nf">logAppendEntriesResponse</span><span class="p">(</span><span class="nx">req</span> <span class="nx">appendEntries</span><span class="p">,</span> <span class="nx">resp</span> <span class="nx">appendEntriesResponse</span><span class="p">,</span> <span class="nx">stepDown</span> <span class="kt">bool</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">s</span><span class="p">.</span><span class="nf">logGeneric</span><span class="p">(</span>
		<span class="s">&#34;got appendEntries, sz=%d leader=%d prevIndex/Term=%d/%d commitIndex=%d: responded with success=%v (reason=&#39;%s&#39;) stepDown=%v&#34;</span><span class="p">,</span>
		<span class="nb">len</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">Entries</span><span class="p">),</span>
		<span class="nx">req</span><span class="p">.</span><span class="nx">LeaderID</span><span class="p">,</span>
		<span class="nx">req</span><span class="p">.</span><span class="nx">PrevLogIndex</span><span class="p">,</span>
		<span class="nx">req</span><span class="p">.</span><span class="nx">PrevLogTerm</span><span class="p">,</span>
		<span class="nx">req</span><span class="p">.</span><span class="nx">CommitIndex</span><span class="p">,</span>
		<span class="nx">resp</span><span class="p">.</span><span class="nx">Success</span><span class="p">,</span>
		<span class="nx">resp</span><span class="p">.</span><span class="nx">reason</span><span class="p">,</span>
		<span class="nx">stepDown</span><span class="p">,</span>
	<span class="p">)</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">s</span> <span class="o">*</span><span class="nx">Server</span><span class="p">)</span> <span class="nf">logRequestVoteResponse</span><span class="p">(</span><span class="nx">req</span> <span class="nx">requestVote</span><span class="p">,</span> <span class="nx">resp</span> <span class="nx">requestVoteResponse</span><span class="p">,</span> <span class="nx">stepDown</span> <span class="kt">bool</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">s</span><span class="p">.</span><span class="nf">logGeneric</span><span class="p">(</span>
		<span class="s">&#34;got RequestVote, candidate=%d: responded with granted=%v (reason=&#39;%s&#39;) stepDown=%v&#34;</span><span class="p">,</span>
		<span class="nx">req</span><span class="p">.</span><span class="nx">CandidateID</span><span class="p">,</span>
		<span class="nx">resp</span><span class="p">.</span><span class="nx">VoteGranted</span><span class="p">,</span>
		<span class="nx">resp</span><span class="p">.</span><span class="nx">reason</span><span class="p">,</span>
		<span class="nx">stepDown</span><span class="p">,</span>
	<span class="p">)</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">s</span> <span class="o">*</span><span class="nx">Server</span><span class="p">)</span> <span class="nf">handleQuit</span><span class="p">(</span><span class="nx">q</span> <span class="kd">chan</span> <span class="kd">struct</span><span class="p">{})</span> <span class="p">{</span>
	<span class="nx">s</span><span class="p">.</span><span class="nf">logGeneric</span><span class="p">(</span><span class="s">&#34;got quit signal&#34;</span><span class="p">)</span>
	<span class="nx">s</span><span class="p">.</span><span class="nx">running</span><span class="p">.</span><span class="nf">Set</span><span class="p">(</span><span class="kc">false</span><span class="p">)</span>
	<span class="nb">close</span><span class="p">(</span><span class="nx">q</span><span class="p">)</span>
<span class="p">}</span>

<span class="c1">// 命令转发
</span><span class="c1">// 如果当前节点不是Leader节点，并且已存在Leader节点，则其会以&#34;代理“的角色，将命令转发至Leader节点
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">s</span> <span class="o">*</span><span class="nx">Server</span><span class="p">)</span> <span class="nf">forwardCommand</span><span class="p">(</span><span class="nx">t</span> <span class="nx">commandTuple</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">switch</span> <span class="nx">s</span><span class="p">.</span><span class="nx">leader</span> <span class="p">{</span>
	<span class="k">case</span> <span class="nx">unknownLeader</span><span class="p">:</span>
		<span class="nx">s</span><span class="p">.</span><span class="nf">logGeneric</span><span class="p">(</span><span class="s">&#34;got command, but don&#39;t know leader&#34;</span><span class="p">)</span>
		<span class="nx">t</span><span class="p">.</span><span class="nx">Err</span> <span class="o">&lt;-</span> <span class="nx">errUnknownLeader</span>

	<span class="k">case</span> <span class="nx">s</span><span class="p">.</span><span class="nx">id</span><span class="p">:</span> <span class="c1">// I am the leader
</span><span class="c1"></span>		<span class="nb">panic</span><span class="p">(</span><span class="s">&#34;impossible state in forwardCommand&#34;</span><span class="p">)</span>

	<span class="k">default</span><span class="p">:</span>
		<span class="nx">leader</span><span class="p">,</span> <span class="nx">ok</span> <span class="o">:=</span> <span class="nx">s</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="nx">s</span><span class="p">.</span><span class="nx">leader</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">!</span><span class="nx">ok</span> <span class="p">{</span>
			<span class="nb">panic</span><span class="p">(</span><span class="s">&#34;invalid state in peers&#34;</span><span class="p">)</span>
		<span class="p">}</span>
		<span class="nx">s</span><span class="p">.</span><span class="nf">logGeneric</span><span class="p">(</span><span class="s">&#34;got command, forwarding to leader (%d)&#34;</span><span class="p">,</span> <span class="nx">s</span><span class="p">.</span><span class="nx">leader</span><span class="p">)</span>
		<span class="c1">// We&#39;re blocking our {follower,candidate}Select function in the
</span><span class="c1"></span>		<span class="c1">// receive-command branch. If we continue to block while forwarding
</span><span class="c1"></span>		<span class="c1">// the command, the leader won&#39;t be able to get a response from us!
</span><span class="c1"></span>		<span class="k">go</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span> <span class="nx">t</span><span class="p">.</span><span class="nx">Err</span> <span class="o">&lt;-</span> <span class="nx">leader</span><span class="p">.</span><span class="nf">callCommand</span><span class="p">(</span><span class="nx">t</span><span class="p">.</span><span class="nx">Command</span><span class="p">,</span> <span class="nx">t</span><span class="p">.</span><span class="nx">CommandResponse</span><span class="p">)</span> <span class="p">}()</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="c1">// 配置变更
</span><span class="c1">// 转发规则和命令转发一样
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">s</span> <span class="o">*</span><span class="nx">Server</span><span class="p">)</span> <span class="nf">forwardConfiguration</span><span class="p">(</span><span class="nx">t</span> <span class="nx">configurationTuple</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">switch</span> <span class="nx">s</span><span class="p">.</span><span class="nx">leader</span> <span class="p">{</span>
	<span class="k">case</span> <span class="nx">unknownLeader</span><span class="p">:</span>
		<span class="nx">s</span><span class="p">.</span><span class="nf">logGeneric</span><span class="p">(</span><span class="s">&#34;got configuration, but don&#39;t know leader&#34;</span><span class="p">)</span>
		<span class="nx">t</span><span class="p">.</span><span class="nx">Err</span> <span class="o">&lt;-</span> <span class="nx">errUnknownLeader</span>

	<span class="k">case</span> <span class="nx">s</span><span class="p">.</span><span class="nx">id</span><span class="p">:</span> <span class="c1">// I am the leader
</span><span class="c1"></span>		<span class="nb">panic</span><span class="p">(</span><span class="s">&#34;impossible state in forwardConfiguration&#34;</span><span class="p">)</span>

	<span class="k">default</span><span class="p">:</span>
		<span class="nx">leader</span><span class="p">,</span> <span class="nx">ok</span> <span class="o">:=</span> <span class="nx">s</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="nx">s</span><span class="p">.</span><span class="nx">leader</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">!</span><span class="nx">ok</span> <span class="p">{</span>
			<span class="nb">panic</span><span class="p">(</span><span class="s">&#34;invalid state in peers&#34;</span><span class="p">)</span>
		<span class="p">}</span>
		<span class="nx">s</span><span class="p">.</span><span class="nf">logGeneric</span><span class="p">(</span><span class="s">&#34;got configuration, forwarding to leader (%d)&#34;</span><span class="p">,</span> <span class="nx">s</span><span class="p">.</span><span class="nx">leader</span><span class="p">)</span>
		<span class="k">go</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span> <span class="nx">t</span><span class="p">.</span><span class="nx">Err</span> <span class="o">&lt;-</span> <span class="nx">leader</span><span class="p">.</span><span class="nf">callSetConfiguration</span><span class="p">(</span><span class="nx">t</span><span class="p">.</span><span class="nx">Peers</span><span class="o">...</span><span class="p">)</span> <span class="p">}()</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="c1">// follower 节点逻辑
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">s</span> <span class="o">*</span><span class="nx">Server</span><span class="p">)</span> <span class="nf">followerSelect</span><span class="p">()</span> <span class="p">{</span>
	<span class="k">for</span> <span class="p">{</span>
		<span class="k">select</span> <span class="p">{</span>
		<span class="k">case</span> <span class="nx">q</span> <span class="o">:=</span> <span class="o">&lt;-</span><span class="nx">s</span><span class="p">.</span><span class="nx">quit</span><span class="p">:</span>
			<span class="nx">s</span><span class="p">.</span><span class="nf">handleQuit</span><span class="p">(</span><span class="nx">q</span><span class="p">)</span>
			<span class="k">return</span>
		<span class="c1">// 命令转发
</span><span class="c1"></span>		<span class="k">case</span> <span class="nx">t</span> <span class="o">:=</span> <span class="o">&lt;-</span><span class="nx">s</span><span class="p">.</span><span class="nx">commandChan</span><span class="p">:</span>
			<span class="nx">s</span><span class="p">.</span><span class="nf">forwardCommand</span><span class="p">(</span><span class="nx">t</span><span class="p">)</span>
		<span class="c1">// 集群变更转发
</span><span class="c1"></span>		<span class="k">case</span> <span class="nx">t</span> <span class="o">:=</span> <span class="o">&lt;-</span><span class="nx">s</span><span class="p">.</span><span class="nx">configurationChan</span><span class="p">:</span>
			<span class="nx">s</span><span class="p">.</span><span class="nf">forwardConfiguration</span><span class="p">(</span><span class="nx">t</span><span class="p">)</span>
		<span class="c1">// Leader选举
</span><span class="c1"></span>		<span class="k">case</span> <span class="o">&lt;-</span><span class="nx">s</span><span class="p">.</span><span class="nx">electionTick</span><span class="p">:</span>
			<span class="c1">// 5.2 Leader election: &#34;A follower increments its current term and
</span><span class="c1"></span>			<span class="c1">// transitions to candidate state.&#34;
</span><span class="c1"></span>			<span class="k">if</span> <span class="nx">s</span><span class="p">.</span><span class="nx">config</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
				<span class="nx">s</span><span class="p">.</span><span class="nf">logGeneric</span><span class="p">(</span><span class="s">&#34;election timeout, but no configuration: ignoring&#34;</span><span class="p">)</span>
				<span class="nx">s</span><span class="p">.</span><span class="nf">resetElectionTimeout</span><span class="p">()</span>
				<span class="k">continue</span>
			<span class="p">}</span>
			<span class="nx">s</span><span class="p">.</span><span class="nf">logGeneric</span><span class="p">(</span><span class="s">&#34;election timeout, becoming candidate&#34;</span><span class="p">)</span>
          	<span class="c1">// 提高自己的任期号
</span><span class="c1"></span>			<span class="nx">s</span><span class="p">.</span><span class="nx">term</span><span class="o">++</span>
          	<span class="c1">// 投票置为空
</span><span class="c1"></span>			<span class="nx">s</span><span class="p">.</span><span class="nx">vote</span> <span class="p">=</span> <span class="nx">noVote</span>
          	<span class="c1">// Leader 
</span><span class="c1"></span>			<span class="nx">s</span><span class="p">.</span><span class="nx">leader</span> <span class="p">=</span> <span class="nx">unknownLeader</span>
          	<span class="c1">// 设置节点角色为&#34;候选人&#34;
</span><span class="c1"></span>			<span class="nx">s</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nf">Set</span><span class="p">(</span><span class="nx">candidate</span><span class="p">)</span>
          	<span class="c1">// 重置选举时间，防止马上再次出发选举
</span><span class="c1"></span>			<span class="nx">s</span><span class="p">.</span><span class="nf">resetElectionTimeout</span><span class="p">()</span>
			<span class="k">return</span>
        <span class="c1">// 日志追加(除了客户端请求，leader的心跳也会出发这个行为)
</span><span class="c1"></span>		<span class="k">case</span> <span class="nx">t</span> <span class="o">:=</span> <span class="o">&lt;-</span><span class="nx">s</span><span class="p">.</span><span class="nx">appendEntriesChan</span><span class="p">:</span>
			<span class="k">if</span> <span class="nx">s</span><span class="p">.</span><span class="nx">leader</span> <span class="o">==</span> <span class="nx">unknownLeader</span> <span class="p">{</span>
				<span class="nx">s</span><span class="p">.</span><span class="nx">leader</span> <span class="p">=</span> <span class="nx">t</span><span class="p">.</span><span class="nx">Request</span><span class="p">.</span><span class="nx">LeaderID</span>
				<span class="nx">s</span><span class="p">.</span><span class="nf">logGeneric</span><span class="p">(</span><span class="s">&#34;discovered Leader %d&#34;</span><span class="p">,</span> <span class="nx">s</span><span class="p">.</span><span class="nx">leader</span><span class="p">)</span>
			<span class="p">}</span>
          	<span class="c1">// 处理日志最佳操作
</span><span class="c1"></span>			<span class="nx">resp</span><span class="p">,</span> <span class="nx">stepDown</span> <span class="o">:=</span> <span class="nx">s</span><span class="p">.</span><span class="nf">handleAppendEntries</span><span class="p">(</span><span class="nx">t</span><span class="p">.</span><span class="nx">Request</span><span class="p">)</span>
			<span class="nx">s</span><span class="p">.</span><span class="nf">logAppendEntriesResponse</span><span class="p">(</span><span class="nx">t</span><span class="p">.</span><span class="nx">Request</span><span class="p">,</span> <span class="nx">resp</span><span class="p">,</span> <span class="nx">stepDown</span><span class="p">)</span>
			<span class="nx">t</span><span class="p">.</span><span class="nx">Response</span> <span class="o">&lt;-</span> <span class="nx">resp</span>
          	<span class="c1">// 如果节点已经脱离了当前的集群，需要跟新Leader地址
</span><span class="c1"></span>			<span class="k">if</span> <span class="nx">stepDown</span> <span class="p">{</span>
				<span class="c1">// stepDown as a Follower means just to reset the leader
</span><span class="c1"></span>				<span class="k">if</span> <span class="nx">s</span><span class="p">.</span><span class="nx">leader</span> <span class="o">!=</span> <span class="nx">unknownLeader</span> <span class="p">{</span>
					<span class="nx">s</span><span class="p">.</span><span class="nf">logGeneric</span><span class="p">(</span><span class="s">&#34;abandoning old leader=%d&#34;</span><span class="p">,</span> <span class="nx">s</span><span class="p">.</span><span class="nx">leader</span><span class="p">)</span>
				<span class="p">}</span>
				<span class="nx">s</span><span class="p">.</span><span class="nf">logGeneric</span><span class="p">(</span><span class="s">&#34;following new leader=%d&#34;</span><span class="p">,</span> <span class="nx">t</span><span class="p">.</span><span class="nx">Request</span><span class="p">.</span><span class="nx">LeaderID</span><span class="p">)</span>
				<span class="nx">s</span><span class="p">.</span><span class="nx">leader</span> <span class="p">=</span> <span class="nx">t</span><span class="p">.</span><span class="nx">Request</span><span class="p">.</span><span class="nx">LeaderID</span>
			<span class="p">}</span>
		<span class="c1">// 选举
</span><span class="c1"></span>		<span class="k">case</span> <span class="nx">t</span> <span class="o">:=</span> <span class="o">&lt;-</span><span class="nx">s</span><span class="p">.</span><span class="nx">requestVoteChan</span><span class="p">:</span>
          	<span class="c1">// 选举处理
</span><span class="c1"></span>			<span class="nx">resp</span><span class="p">,</span> <span class="nx">stepDown</span> <span class="o">:=</span> <span class="nx">s</span><span class="p">.</span><span class="nf">handleRequestVote</span><span class="p">(</span><span class="nx">t</span><span class="p">.</span><span class="nx">Request</span><span class="p">)</span>
			<span class="nx">s</span><span class="p">.</span><span class="nf">logRequestVoteResponse</span><span class="p">(</span><span class="nx">t</span><span class="p">.</span><span class="nx">Request</span><span class="p">,</span> <span class="nx">resp</span><span class="p">,</span> <span class="nx">stepDown</span><span class="p">)</span>
			<span class="nx">t</span><span class="p">.</span><span class="nx">Response</span> <span class="o">&lt;-</span> <span class="nx">resp</span>
          	<span class="c1">// 如果落后于当前节点了，把当前的Leader修改为&#34;unkownleader&#34;，等待讯据成功后，进行切换
</span><span class="c1"></span>			<span class="k">if</span> <span class="nx">stepDown</span> <span class="p">{</span>
				<span class="c1">// stepDown as a Follower means just to reset the leader
</span><span class="c1"></span>				<span class="k">if</span> <span class="nx">s</span><span class="p">.</span><span class="nx">leader</span> <span class="o">!=</span> <span class="nx">unknownLeader</span> <span class="p">{</span>
					<span class="nx">s</span><span class="p">.</span><span class="nf">logGeneric</span><span class="p">(</span><span class="s">&#34;abandoning old leader=%d&#34;</span><span class="p">,</span> <span class="nx">s</span><span class="p">.</span><span class="nx">leader</span><span class="p">)</span>
				<span class="p">}</span>
				<span class="nx">s</span><span class="p">.</span><span class="nf">logGeneric</span><span class="p">(</span><span class="s">&#34;new leader unknown&#34;</span><span class="p">)</span>
				<span class="nx">s</span><span class="p">.</span><span class="nx">leader</span> <span class="p">=</span> <span class="nx">unknownLeader</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="c1">// 候选状态
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">s</span> <span class="o">*</span><span class="nx">Server</span><span class="p">)</span> <span class="nf">candidateSelect</span><span class="p">()</span> <span class="p">{</span>
	<span class="k">if</span> <span class="nx">s</span><span class="p">.</span><span class="nx">leader</span> <span class="o">!=</span> <span class="nx">unknownLeader</span> <span class="p">{</span>
		<span class="nb">panic</span><span class="p">(</span><span class="s">&#34;known leader when entering candidateSelect&#34;</span><span class="p">)</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="nx">s</span><span class="p">.</span><span class="nx">vote</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">{</span>
		<span class="nb">panic</span><span class="p">(</span><span class="s">&#34;existing vote when entering candidateSelect&#34;</span><span class="p">)</span>
	<span class="p">}</span>

	<span class="c1">// &#34;[A server entering the candidate stage] issues requestVote RPCs in
</span><span class="c1"></span>	<span class="c1">// parallel to each of the other servers in the cluster. If the candidate
</span><span class="c1"></span>	<span class="c1">// receives no response for an RPC, it reissues the RPC repeatedly until a
</span><span class="c1"></span>	<span class="c1">// response arrives or the election concludes.&#34;
</span><span class="c1"></span>	<span class="c1">// 发起选举RPC
</span><span class="c1"></span>	<span class="nx">requestVoteResponses</span><span class="p">,</span> <span class="nx">canceler</span> <span class="o">:=</span> <span class="nx">s</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nf">allPeers</span><span class="p">().</span><span class="nf">except</span><span class="p">(</span><span class="nx">s</span><span class="p">.</span><span class="nx">id</span><span class="p">).</span><span class="nf">requestVotes</span><span class="p">(</span><span class="nx">requestVote</span><span class="p">{</span>
		<span class="nx">Term</span><span class="p">:</span>         <span class="nx">s</span><span class="p">.</span><span class="nx">term</span><span class="p">,</span>
		<span class="nx">CandidateID</span><span class="p">:</span>  <span class="nx">s</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span>
		<span class="nx">LastLogIndex</span><span class="p">:</span> <span class="nx">s</span><span class="p">.</span><span class="nx">log</span><span class="p">.</span><span class="nf">lastIndex</span><span class="p">(),</span>
		<span class="nx">LastLogTerm</span><span class="p">:</span>  <span class="nx">s</span><span class="p">.</span><span class="nx">log</span><span class="p">.</span><span class="nf">lastTerm</span><span class="p">(),</span>
	<span class="p">})</span>
	<span class="k">defer</span> <span class="nx">canceler</span><span class="p">.</span><span class="nf">Cancel</span><span class="p">()</span>

	<span class="c1">// Set up vote tallies (plus, vote for myself)
</span><span class="c1"></span>	<span class="nx">votes</span> <span class="o">:=</span> <span class="kd">map</span><span class="p">[</span><span class="kt">uint64</span><span class="p">]</span><span class="kt">bool</span><span class="p">{</span><span class="nx">s</span><span class="p">.</span><span class="nx">id</span><span class="p">:</span> <span class="kc">true</span><span class="p">}</span>
	<span class="nx">s</span><span class="p">.</span><span class="nx">vote</span> <span class="p">=</span> <span class="nx">s</span><span class="p">.</span><span class="nx">id</span>
	<span class="nx">s</span><span class="p">.</span><span class="nf">logGeneric</span><span class="p">(</span><span class="s">&#34;term=%d election started (configuration state %s)&#34;</span><span class="p">,</span> <span class="nx">s</span><span class="p">.</span><span class="nx">term</span><span class="p">,</span> <span class="nx">s</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">state</span><span class="p">)</span>

	<span class="c1">// 如果已经达到了选举“共识”，则成功选举
</span><span class="c1"></span>	<span class="k">if</span> <span class="nx">s</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nf">pass</span><span class="p">(</span><span class="nx">votes</span><span class="p">)</span> <span class="p">{</span>
		<span class="nx">s</span><span class="p">.</span><span class="nf">logGeneric</span><span class="p">(</span><span class="s">&#34;I immediately won the election&#34;</span><span class="p">)</span>
		<span class="nx">s</span><span class="p">.</span><span class="nx">leader</span> <span class="p">=</span> <span class="nx">s</span><span class="p">.</span><span class="nx">id</span>
		<span class="nx">s</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nf">Set</span><span class="p">(</span><span class="nx">leader</span><span class="p">)</span>
		<span class="nx">s</span><span class="p">.</span><span class="nx">vote</span> <span class="p">=</span> <span class="nx">noVote</span>
		<span class="k">return</span>
	<span class="p">}</span>

	<span class="c1">// &#34;A candidate continues in this state until one of three things happens:
</span><span class="c1"></span>	<span class="c1">// (a) it wins the election, (b) another server establishes itself as
</span><span class="c1"></span>	<span class="c1">// leader, or (c) a period of time goes by with no winner.&#34;
</span><span class="c1"></span>	<span class="k">for</span> <span class="p">{</span>
		<span class="k">select</span> <span class="p">{</span>
		<span class="k">case</span> <span class="nx">q</span> <span class="o">:=</span> <span class="o">&lt;-</span><span class="nx">s</span><span class="p">.</span><span class="nx">quit</span><span class="p">:</span>
			<span class="nx">s</span><span class="p">.</span><span class="nf">handleQuit</span><span class="p">(</span><span class="nx">q</span><span class="p">)</span>
			<span class="k">return</span>
		<span class="c1">// 命令转发
</span><span class="c1"></span>		<span class="k">case</span> <span class="nx">t</span> <span class="o">:=</span> <span class="o">&lt;-</span><span class="nx">s</span><span class="p">.</span><span class="nx">commandChan</span><span class="p">:</span>
			<span class="nx">s</span><span class="p">.</span><span class="nf">forwardCommand</span><span class="p">(</span><span class="nx">t</span><span class="p">)</span>
		<span class="c1">// 配置更新转发，注意和Leader的不同
</span><span class="c1"></span>		<span class="k">case</span> <span class="nx">t</span> <span class="o">:=</span> <span class="o">&lt;-</span><span class="nx">s</span><span class="p">.</span><span class="nx">configurationChan</span><span class="p">:</span>
			<span class="nx">s</span><span class="p">.</span><span class="nf">forwardConfiguration</span><span class="p">(</span><span class="nx">t</span><span class="p">)</span>
		<span class="c1">// 收到选举的应答
</span><span class="c1"></span>		<span class="k">case</span> <span class="nx">t</span> <span class="o">:=</span> <span class="o">&lt;-</span><span class="nx">requestVoteResponses</span><span class="p">:</span>
			<span class="nx">s</span><span class="p">.</span><span class="nf">logGeneric</span><span class="p">(</span><span class="s">&#34;got vote: id=%d term=%d granted=%v&#34;</span><span class="p">,</span> <span class="nx">t</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span> <span class="nx">t</span><span class="p">.</span><span class="nx">response</span><span class="p">.</span><span class="nx">Term</span><span class="p">,</span> <span class="nx">t</span><span class="p">.</span><span class="nx">response</span><span class="p">.</span><span class="nx">VoteGranted</span><span class="p">)</span>
			<span class="c1">// &#34;A candidate wins the election if it receives votes from a
</span><span class="c1"></span>			<span class="c1">// majority of servers in the full cluster for the same term.&#34;
</span><span class="c1"></span>          	<span class="c1">// 本节点落后于其他几点
</span><span class="c1"></span>			<span class="k">if</span> <span class="nx">t</span><span class="p">.</span><span class="nx">response</span><span class="p">.</span><span class="nx">Term</span> <span class="p">&gt;</span> <span class="nx">s</span><span class="p">.</span><span class="nx">term</span> <span class="p">{</span>
				<span class="nx">s</span><span class="p">.</span><span class="nf">logGeneric</span><span class="p">(</span><span class="s">&#34;got vote from future term (%d&gt;%d); abandoning election&#34;</span><span class="p">,</span> <span class="nx">t</span><span class="p">.</span><span class="nx">response</span><span class="p">.</span><span class="nx">Term</span><span class="p">,</span> <span class="nx">s</span><span class="p">.</span><span class="nx">term</span><span class="p">)</span>
				<span class="nx">s</span><span class="p">.</span><span class="nx">leader</span> <span class="p">=</span> <span class="nx">unknownLeader</span>
				<span class="nx">s</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nf">Set</span><span class="p">(</span><span class="nx">follower</span><span class="p">)</span>
				<span class="nx">s</span><span class="p">.</span><span class="nx">vote</span> <span class="p">=</span> <span class="nx">noVote</span>
				<span class="k">return</span> <span class="c1">// lose
</span><span class="c1"></span>			<span class="p">}</span>
          	<span class="c1">// 收到了&#34;落后&#34;当前节点的应答，忽略掉它
</span><span class="c1"></span>			<span class="k">if</span> <span class="nx">t</span><span class="p">.</span><span class="nx">response</span><span class="p">.</span><span class="nx">Term</span> <span class="p">&lt;</span> <span class="nx">s</span><span class="p">.</span><span class="nx">term</span> <span class="p">{</span>
				<span class="nx">s</span><span class="p">.</span><span class="nf">logGeneric</span><span class="p">(</span><span class="s">&#34;got vote from past term (%d&lt;%d); ignoring&#34;</span><span class="p">,</span> <span class="nx">t</span><span class="p">.</span><span class="nx">response</span><span class="p">.</span><span class="nx">Term</span><span class="p">,</span> <span class="nx">s</span><span class="p">.</span><span class="nx">term</span><span class="p">)</span>
				<span class="k">break</span>
			<span class="p">}</span>
          	
          	<span class="c1">// 收到赞同票
</span><span class="c1"></span>			<span class="k">if</span> <span class="nx">t</span><span class="p">.</span><span class="nx">response</span><span class="p">.</span><span class="nx">VoteGranted</span> <span class="p">{</span>
				<span class="nx">s</span><span class="p">.</span><span class="nf">logGeneric</span><span class="p">(</span><span class="s">&#34;%d voted for me&#34;</span><span class="p">,</span> <span class="nx">t</span><span class="p">.</span><span class="nx">id</span><span class="p">)</span>
				<span class="nx">votes</span><span class="p">[</span><span class="nx">t</span><span class="p">.</span><span class="nx">id</span><span class="p">]</span> <span class="p">=</span> <span class="kc">true</span>
			<span class="p">}</span>
			<span class="c1">// &#34;Once a candidate wins an election, it becomes leader.&#34;
</span><span class="c1"></span>          	<span class="c1">// “共识”达成
</span><span class="c1"></span>			<span class="k">if</span> <span class="nx">s</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nf">pass</span><span class="p">(</span><span class="nx">votes</span><span class="p">)</span> <span class="p">{</span>
				<span class="nx">s</span><span class="p">.</span><span class="nf">logGeneric</span><span class="p">(</span><span class="s">&#34;I won the election&#34;</span><span class="p">)</span>
				<span class="nx">s</span><span class="p">.</span><span class="nx">leader</span> <span class="p">=</span> <span class="nx">s</span><span class="p">.</span><span class="nx">id</span>
				<span class="nx">s</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nf">Set</span><span class="p">(</span><span class="nx">leader</span><span class="p">)</span>
				<span class="nx">s</span><span class="p">.</span><span class="nx">vote</span> <span class="p">=</span> <span class="nx">noVote</span>
				<span class="k">return</span> <span class="c1">// win
</span><span class="c1"></span>			<span class="p">}</span>
          <span class="c1">// 收到日志追加(在这里，心跳也当做日志追加的方式发送)
</span><span class="c1"></span>		<span class="k">case</span> <span class="nx">t</span> <span class="o">:=</span> <span class="o">&lt;-</span><span class="nx">s</span><span class="p">.</span><span class="nx">appendEntriesChan</span><span class="p">:</span>
			<span class="c1">// &#34;While waiting for votes, a candidate may receive an
</span><span class="c1"></span>			<span class="c1">// appendEntries RPC from another server claiming to be leader.
</span><span class="c1"></span>			<span class="c1">// If the leader&#39;s term (included in its RPC) is at least as
</span><span class="c1"></span>			<span class="c1">// large as the candidate&#39;s current term, then the candidate
</span><span class="c1"></span>			<span class="c1">// recognizes the leader as legitimate and steps down, meaning
</span><span class="c1"></span>			<span class="c1">// that it returns to follower state.&#34;
</span><span class="c1"></span>            <span class="c1">// 处理日志
</span><span class="c1"></span>			<span class="nx">resp</span><span class="p">,</span> <span class="nx">stepDown</span> <span class="o">:=</span> <span class="nx">s</span><span class="p">.</span><span class="nf">handleAppendEntries</span><span class="p">(</span><span class="nx">t</span><span class="p">.</span><span class="nx">Request</span><span class="p">)</span>
			<span class="nx">s</span><span class="p">.</span><span class="nf">logAppendEntriesResponse</span><span class="p">(</span><span class="nx">t</span><span class="p">.</span><span class="nx">Request</span><span class="p">,</span> <span class="nx">resp</span><span class="p">,</span> <span class="nx">stepDown</span><span class="p">)</span>
			<span class="nx">t</span><span class="p">.</span><span class="nx">Response</span> <span class="o">&lt;-</span> <span class="nx">resp</span>
          	<span class="c1">// candidate节点落后于Leader节点
</span><span class="c1"></span>			<span class="k">if</span> <span class="nx">stepDown</span> <span class="p">{</span>
				<span class="nx">s</span><span class="p">.</span><span class="nf">logGeneric</span><span class="p">(</span><span class="s">&#34;after an appendEntries, stepping down to Follower (leader=%d)&#34;</span><span class="p">,</span> <span class="nx">t</span><span class="p">.</span><span class="nx">Request</span><span class="p">.</span><span class="nx">LeaderID</span><span class="p">)</span>
				<span class="nx">s</span><span class="p">.</span><span class="nx">leader</span> <span class="p">=</span> <span class="nx">t</span><span class="p">.</span><span class="nx">Request</span><span class="p">.</span><span class="nx">LeaderID</span>
				<span class="nx">s</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nf">Set</span><span class="p">(</span><span class="nx">follower</span><span class="p">)</span>
				<span class="k">return</span> <span class="c1">// lose
</span><span class="c1"></span>			<span class="p">}</span>

        <span class="c1">// 虽然当前节点是candidate节点，但集群中此时可能存在多个candidate节点
</span><span class="c1"></span>		<span class="k">case</span> <span class="nx">t</span> <span class="o">:=</span> <span class="o">&lt;-</span><span class="nx">s</span><span class="p">.</span><span class="nx">requestVoteChan</span><span class="p">:</span>
			<span class="c1">// We can also be defeated by a more recent candidate
</span><span class="c1"></span>			<span class="nx">resp</span><span class="p">,</span> <span class="nx">stepDown</span> <span class="o">:=</span> <span class="nx">s</span><span class="p">.</span><span class="nf">handleRequestVote</span><span class="p">(</span><span class="nx">t</span><span class="p">.</span><span class="nx">Request</span><span class="p">)</span>
			<span class="nx">s</span><span class="p">.</span><span class="nf">logRequestVoteResponse</span><span class="p">(</span><span class="nx">t</span><span class="p">.</span><span class="nx">Request</span><span class="p">,</span> <span class="nx">resp</span><span class="p">,</span> <span class="nx">stepDown</span><span class="p">)</span>
			<span class="nx">t</span><span class="p">.</span><span class="nx">Response</span> <span class="o">&lt;-</span> <span class="nx">resp</span>
			<span class="k">if</span> <span class="nx">stepDown</span> <span class="p">{</span>
              	<span class="c1">// 当前candidate节点落后于集群中已存在的candidate节点，将自己的角色变为follower，
</span><span class="c1"></span>              	<span class="c1">// 并且也会投赞同票
</span><span class="c1"></span>				<span class="nx">s</span><span class="p">.</span><span class="nf">logGeneric</span><span class="p">(</span><span class="s">&#34;after a requestVote, stepping down to Follower (leader unknown)&#34;</span><span class="p">)</span>
				<span class="nx">s</span><span class="p">.</span><span class="nx">leader</span> <span class="p">=</span> <span class="nx">unknownLeader</span>
				<span class="nx">s</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nf">Set</span><span class="p">(</span><span class="nx">follower</span><span class="p">)</span>
				<span class="k">return</span> <span class="c1">// lose
</span><span class="c1"></span>			<span class="p">}</span>
		
        <span class="c1">// 选举
</span><span class="c1"></span>		<span class="k">case</span> <span class="o">&lt;-</span><span class="nx">s</span><span class="p">.</span><span class="nx">electionTick</span><span class="p">:</span>
			<span class="c1">// &#34;The third possible outcome is that a candidate neither wins nor
</span><span class="c1"></span>			<span class="c1">// loses the election: if many followers become candidates at the
</span><span class="c1"></span>			<span class="c1">// same time, votes could be split so that no candidate obtains a
</span><span class="c1"></span>			<span class="c1">// majority. When this happens, each candidate will start a new
</span><span class="c1"></span>			<span class="c1">// election by incrementing its term and initiating another round of
</span><span class="c1"></span>			<span class="c1">// requestVote RPCs.&#34;
</span><span class="c1"></span>			<span class="nx">s</span><span class="p">.</span><span class="nf">logGeneric</span><span class="p">(</span><span class="s">&#34;election ended with no winner; incrementing term and trying again&#34;</span><span class="p">)</span>
			<span class="nx">s</span><span class="p">.</span><span class="nf">resetElectionTimeout</span><span class="p">()</span>
			<span class="nx">s</span><span class="p">.</span><span class="nx">term</span><span class="o">++</span>
			<span class="nx">s</span><span class="p">.</span><span class="nx">vote</span> <span class="p">=</span> <span class="nx">noVote</span>
			<span class="k">return</span> <span class="c1">// draw
</span><span class="c1"></span>		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="c1">// Leader 保存的Follower节点的所有最新同步条目
</span><span class="c1"></span><span class="kd">type</span> <span class="nx">nextIndex</span> <span class="kd">struct</span> <span class="p">{</span>
	<span class="nx">sync</span><span class="p">.</span><span class="nx">RWMutex</span>
	<span class="nx">m</span> <span class="kd">map</span><span class="p">[</span><span class="kt">uint64</span><span class="p">]</span><span class="kt">uint64</span> <span class="c1">// followerId: nextIndex
</span><span class="c1"></span><span class="p">}</span>

<span class="kd">func</span> <span class="nf">newNextIndex</span><span class="p">(</span><span class="nx">pm</span> <span class="nx">peerMap</span><span class="p">,</span> <span class="nx">defaultNextIndex</span> <span class="kt">uint64</span><span class="p">)</span> <span class="o">*</span><span class="nx">nextIndex</span> <span class="p">{</span>
	<span class="nx">ni</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">nextIndex</span><span class="p">{</span>
		<span class="nx">m</span><span class="p">:</span> <span class="kd">map</span><span class="p">[</span><span class="kt">uint64</span><span class="p">]</span><span class="kt">uint64</span><span class="p">{},</span>
	<span class="p">}</span>
	<span class="k">for</span> <span class="nx">id</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">pm</span> <span class="p">{</span>
		<span class="nx">ni</span><span class="p">.</span><span class="nx">m</span><span class="p">[</span><span class="nx">id</span><span class="p">]</span> <span class="p">=</span> <span class="nx">defaultNextIndex</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nx">ni</span>
<span class="p">}</span>

<span class="c1">// 找出已经同步Follower的最小日志
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">ni</span> <span class="o">*</span><span class="nx">nextIndex</span><span class="p">)</span> <span class="nf">bestIndex</span><span class="p">()</span> <span class="kt">uint64</span> <span class="p">{</span>
	<span class="nx">ni</span><span class="p">.</span><span class="nf">RLock</span><span class="p">()</span>
	<span class="k">defer</span> <span class="nx">ni</span><span class="p">.</span><span class="nf">RUnlock</span><span class="p">()</span>

	<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nx">ni</span><span class="p">.</span><span class="nx">m</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="p">{</span>
		<span class="k">return</span> <span class="mi">0</span>
	<span class="p">}</span>

	<span class="nx">i</span> <span class="o">:=</span> <span class="nb">uint64</span><span class="p">(</span><span class="nx">math</span><span class="p">.</span><span class="nx">MaxUint64</span><span class="p">)</span>
	<span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">nextIndex</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">ni</span><span class="p">.</span><span class="nx">m</span> <span class="p">{</span>
		<span class="k">if</span> <span class="nx">nextIndex</span> <span class="p">&lt;</span> <span class="nx">i</span> <span class="p">{</span>
			<span class="nx">i</span> <span class="p">=</span> <span class="nx">nextIndex</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nx">i</span>
<span class="p">}</span>

<span class="c1">// 返回节点(id)最新的同步日志
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">ni</span> <span class="o">*</span><span class="nx">nextIndex</span><span class="p">)</span> <span class="nf">prevLogIndex</span><span class="p">(</span><span class="nx">id</span> <span class="kt">uint64</span><span class="p">)</span> <span class="kt">uint64</span> <span class="p">{</span>
	<span class="nx">ni</span><span class="p">.</span><span class="nf">RLock</span><span class="p">()</span>
	<span class="k">defer</span> <span class="nx">ni</span><span class="p">.</span><span class="nf">RUnlock</span><span class="p">()</span>
	<span class="k">if</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">ok</span> <span class="o">:=</span> <span class="nx">ni</span><span class="p">.</span><span class="nx">m</span><span class="p">[</span><span class="nx">id</span><span class="p">];</span> <span class="p">!</span><span class="nx">ok</span> <span class="p">{</span>
		<span class="nb">panic</span><span class="p">(</span><span class="nx">fmt</span><span class="p">.</span><span class="nf">Sprintf</span><span class="p">(</span><span class="s">&#34;peer %d not found&#34;</span><span class="p">,</span> <span class="nx">id</span><span class="p">))</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nx">ni</span><span class="p">.</span><span class="nx">m</span><span class="p">[</span><span class="nx">id</span><span class="p">]</span>
<span class="p">}</span>

<span class="c1">// 自减节点(id)的最新同步日志，用于同步失败时的回滚
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">ni</span> <span class="o">*</span><span class="nx">nextIndex</span><span class="p">)</span> <span class="nf">decrement</span><span class="p">(</span><span class="nx">id</span> <span class="kt">uint64</span><span class="p">,</span> <span class="nx">prev</span> <span class="kt">uint64</span><span class="p">)</span> <span class="p">(</span><span class="kt">uint64</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">ni</span><span class="p">.</span><span class="nf">Lock</span><span class="p">()</span>
	<span class="k">defer</span> <span class="nx">ni</span><span class="p">.</span><span class="nf">Unlock</span><span class="p">()</span>

	<span class="nx">i</span><span class="p">,</span> <span class="nx">ok</span> <span class="o">:=</span> <span class="nx">ni</span><span class="p">.</span><span class="nx">m</span><span class="p">[</span><span class="nx">id</span><span class="p">]</span>
	<span class="k">if</span> <span class="p">!</span><span class="nx">ok</span> <span class="p">{</span>
		<span class="nb">panic</span><span class="p">(</span><span class="nx">fmt</span><span class="p">.</span><span class="nf">Sprintf</span><span class="p">(</span><span class="s">&#34;peer %d not found&#34;</span><span class="p">,</span> <span class="nx">id</span><span class="p">))</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="nx">i</span> <span class="o">!=</span> <span class="nx">prev</span> <span class="p">{</span>
		<span class="k">return</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">errOutOfSync</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="nx">i</span> <span class="p">&gt;</span> <span class="mi">0</span> <span class="p">{</span>
		<span class="nx">ni</span><span class="p">.</span><span class="nx">m</span><span class="p">[</span><span class="nx">id</span><span class="p">]</span><span class="o">--</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nx">ni</span><span class="p">.</span><span class="nx">m</span><span class="p">[</span><span class="nx">id</span><span class="p">],</span> <span class="kc">nil</span>
<span class="p">}</span>

<span class="c1">// 更新节点(id)的同步日志
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">ni</span> <span class="o">*</span><span class="nx">nextIndex</span><span class="p">)</span> <span class="nf">set</span><span class="p">(</span><span class="nx">id</span><span class="p">,</span> <span class="nx">index</span><span class="p">,</span> <span class="nx">prev</span> <span class="kt">uint64</span><span class="p">)</span> <span class="p">(</span><span class="kt">uint64</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">ni</span><span class="p">.</span><span class="nf">Lock</span><span class="p">()</span>
	<span class="k">defer</span> <span class="nx">ni</span><span class="p">.</span><span class="nf">Unlock</span><span class="p">()</span>

	<span class="nx">i</span><span class="p">,</span> <span class="nx">ok</span> <span class="o">:=</span> <span class="nx">ni</span><span class="p">.</span><span class="nx">m</span><span class="p">[</span><span class="nx">id</span><span class="p">]</span>
	<span class="k">if</span> <span class="p">!</span><span class="nx">ok</span> <span class="p">{</span>
		<span class="nb">panic</span><span class="p">(</span><span class="nx">fmt</span><span class="p">.</span><span class="nf">Sprintf</span><span class="p">(</span><span class="s">&#34;peer %d not found&#34;</span><span class="p">,</span> <span class="nx">id</span><span class="p">))</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="nx">i</span> <span class="o">!=</span> <span class="nx">prev</span> <span class="p">{</span>
		<span class="k">return</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">errOutOfSync</span>
	<span class="p">}</span>

	<span class="nx">ni</span><span class="p">.</span><span class="nx">m</span><span class="p">[</span><span class="nx">id</span><span class="p">]</span> <span class="p">=</span> <span class="nx">index</span>
	<span class="k">return</span> <span class="nx">index</span><span class="p">,</span> <span class="kc">nil</span>
<span class="p">}</span>

<span class="c1">// 心跳、复制命令都会用到该函数，flush是同步的，如果对端节点不可达，则阻塞
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">s</span> <span class="o">*</span><span class="nx">Server</span><span class="p">)</span> <span class="nf">flush</span><span class="p">(</span><span class="nx">peer</span> <span class="nx">Peer</span><span class="p">,</span> <span class="nx">ni</span> <span class="o">*</span><span class="nx">nextIndex</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
	<span class="nx">peerID</span> <span class="o">:=</span> <span class="nx">peer</span><span class="p">.</span><span class="nf">id</span><span class="p">()</span>
	<span class="c1">// Leader的任期号
</span><span class="c1"></span>	<span class="nx">currentTerm</span> <span class="o">:=</span> <span class="nx">s</span><span class="p">.</span><span class="nx">term</span>
	<span class="c1">// 节点(peer)的最新同步索引
</span><span class="c1"></span>	<span class="nx">prevLogIndex</span> <span class="o">:=</span> <span class="nx">ni</span><span class="p">.</span><span class="nf">prevLogIndex</span><span class="p">(</span><span class="nx">peerID</span><span class="p">)</span>
	<span class="c1">// 检索出peers节点落后于Leader几点的日志条目，然后进行同步
</span><span class="c1"></span>	<span class="nx">entries</span><span class="p">,</span> <span class="nx">prevLogTerm</span> <span class="o">:=</span> <span class="nx">s</span><span class="p">.</span><span class="nx">log</span><span class="p">.</span><span class="nf">entriesAfter</span><span class="p">(</span><span class="nx">prevLogIndex</span><span class="p">)</span>
	<span class="c1">// 获取Leader committed的最新索引
</span><span class="c1"></span>	<span class="nx">commitIndex</span> <span class="o">:=</span> <span class="nx">s</span><span class="p">.</span><span class="nx">log</span><span class="p">.</span><span class="nf">getCommitIndex</span><span class="p">()</span>
	<span class="nx">s</span><span class="p">.</span><span class="nf">logGeneric</span><span class="p">(</span><span class="s">&#34;flush to %d: term=%d leaderId=%d prevLogIndex/Term=%d/%d sz=%d commitIndex=%d&#34;</span><span class="p">,</span> <span class="nx">peerID</span><span class="p">,</span> <span class="nx">currentTerm</span><span class="p">,</span> <span class="nx">s</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span> <span class="nx">prevLogIndex</span><span class="p">,</span> <span class="nx">prevLogTerm</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="nx">entries</span><span class="p">),</span> <span class="nx">commitIndex</span><span class="p">)</span>
	
	<span class="c1">// 日志追加RPC
</span><span class="c1"></span>	<span class="nx">resp</span> <span class="o">:=</span> <span class="nx">peer</span><span class="p">.</span><span class="nf">callAppendEntries</span><span class="p">(</span><span class="nx">appendEntries</span><span class="p">{</span>
		<span class="nx">Term</span><span class="p">:</span>         <span class="nx">currentTerm</span><span class="p">,</span>
		<span class="nx">LeaderID</span><span class="p">:</span>     <span class="nx">s</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span>
		<span class="nx">PrevLogIndex</span><span class="p">:</span> <span class="nx">prevLogIndex</span><span class="p">,</span>
		<span class="nx">PrevLogTerm</span><span class="p">:</span>  <span class="nx">prevLogTerm</span><span class="p">,</span>
		<span class="nx">Entries</span><span class="p">:</span>      <span class="nx">entries</span><span class="p">,</span>
		<span class="nx">CommitIndex</span><span class="p">:</span>  <span class="nx">commitIndex</span><span class="p">,</span>
	<span class="p">})</span>

	<span class="k">if</span> <span class="nx">resp</span><span class="p">.</span><span class="nx">Term</span> <span class="p">&gt;</span> <span class="nx">currentTerm</span> <span class="p">{</span>
		<span class="c1">// 应答的节点比当前节点的任期号大，当前的Leader被罢免
</span><span class="c1"></span>		<span class="nx">s</span><span class="p">.</span><span class="nf">logGeneric</span><span class="p">(</span><span class="s">&#34;flush to %d: responseTerm=%d &gt; currentTerm=%d: deposed&#34;</span><span class="p">,</span> <span class="nx">peerID</span><span class="p">,</span> <span class="nx">resp</span><span class="p">.</span><span class="nx">Term</span><span class="p">,</span> <span class="nx">currentTerm</span><span class="p">)</span>
		<span class="k">return</span> <span class="nx">errDeposed</span>
	<span class="p">}</span>

	
	<span class="k">if</span> <span class="p">!</span><span class="nx">resp</span><span class="p">.</span><span class="nx">Success</span> <span class="p">{</span>
		<span class="c1">// 应答失败，可能是leader RPC等待超时，或者出现了网络错误(包括脑裂)，回滚
</span><span class="c1"></span>		<span class="nx">newPrevLogIndex</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">ni</span><span class="p">.</span><span class="nf">decrement</span><span class="p">(</span><span class="nx">peerID</span><span class="p">,</span> <span class="nx">prevLogIndex</span><span class="p">)</span>
		<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
			<span class="nx">s</span><span class="p">.</span><span class="nf">logGeneric</span><span class="p">(</span><span class="s">&#34;flush to %d: while decrementing prevLogIndex: %s&#34;</span><span class="p">,</span> <span class="nx">peerID</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
			<span class="k">return</span> <span class="nx">err</span>
		<span class="p">}</span>
		<span class="nx">s</span><span class="p">.</span><span class="nf">logGeneric</span><span class="p">(</span><span class="s">&#34;flush to %d: rejected; prevLogIndex(%d) becomes %d&#34;</span><span class="p">,</span> <span class="nx">peerID</span><span class="p">,</span> <span class="nx">peerID</span><span class="p">,</span> <span class="nx">newPrevLogIndex</span><span class="p">)</span>
		<span class="k">return</span> <span class="nx">errAppendEntriesRejected</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nx">entries</span><span class="p">)</span> <span class="p">&gt;</span> <span class="mi">0</span> <span class="p">{</span>
		<span class="c1">// 复制成功，更新同步状态
</span><span class="c1"></span>		<span class="nx">newPrevLogIndex</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">ni</span><span class="p">.</span><span class="nf">set</span><span class="p">(</span><span class="nx">peer</span><span class="p">.</span><span class="nf">id</span><span class="p">(),</span> <span class="nx">entries</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="nx">entries</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="nx">Index</span><span class="p">,</span> <span class="nx">prevLogIndex</span><span class="p">)</span>
		<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
			<span class="nx">s</span><span class="p">.</span><span class="nf">logGeneric</span><span class="p">(</span><span class="s">&#34;flush to %d: while moving prevLogIndex forward: %s&#34;</span><span class="p">,</span> <span class="nx">peerID</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
			<span class="k">return</span> <span class="nx">err</span>
		<span class="p">}</span>
		<span class="nx">s</span><span class="p">.</span><span class="nf">logGeneric</span><span class="p">(</span><span class="s">&#34;flush to %d: accepted; prevLogIndex(%d) becomes %d&#34;</span><span class="p">,</span> <span class="nx">peerID</span><span class="p">,</span> <span class="nx">peerID</span><span class="p">,</span> <span class="nx">newPrevLogIndex</span><span class="p">)</span>
		<span class="k">return</span> <span class="kc">nil</span>
	<span class="p">}</span>

	<span class="nx">s</span><span class="p">.</span><span class="nf">logGeneric</span><span class="p">(</span><span class="s">&#34;flush to %d: accepted; prevLogIndex(%d) remains %d&#34;</span><span class="p">,</span> <span class="nx">peerID</span><span class="p">,</span> <span class="nx">peerID</span><span class="p">,</span> <span class="nx">ni</span><span class="p">.</span><span class="nf">prevLogIndex</span><span class="p">(</span><span class="nx">peerID</span><span class="p">))</span>
	<span class="k">return</span> <span class="kc">nil</span>
<span class="p">}</span>

<span class="c1">// Leader并发同步日志
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">s</span> <span class="o">*</span><span class="nx">Server</span><span class="p">)</span> <span class="nf">concurrentFlush</span><span class="p">(</span><span class="nx">pm</span> <span class="nx">peerMap</span><span class="p">,</span> <span class="nx">ni</span> <span class="o">*</span><span class="nx">nextIndex</span><span class="p">,</span> <span class="nx">timeout</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Duration</span><span class="p">)</span> <span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="kt">bool</span><span class="p">)</span> <span class="p">{</span>
	<span class="kd">type</span> <span class="nx">tuple</span> <span class="kd">struct</span> <span class="p">{</span>
		<span class="nx">id</span>  <span class="kt">uint64</span>
		<span class="nx">err</span> <span class="kt">error</span>
	<span class="p">}</span>
	<span class="nx">responses</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">(</span><span class="kd">chan</span> <span class="nx">tuple</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="nx">pm</span><span class="p">))</span>
	<span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">peer</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">pm</span> <span class="p">{</span>
		<span class="k">go</span> <span class="kd">func</span><span class="p">(</span><span class="nx">peer</span> <span class="nx">Peer</span><span class="p">)</span> <span class="p">{</span>
			<span class="nx">errChan</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">(</span><span class="kd">chan</span> <span class="kt">error</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
			<span class="k">go</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span> <span class="nx">errChan</span> <span class="o">&lt;-</span> <span class="nx">s</span><span class="p">.</span><span class="nf">flush</span><span class="p">(</span><span class="nx">peer</span><span class="p">,</span> <span class="nx">ni</span><span class="p">)</span> <span class="p">}()</span>
			<span class="k">go</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span> <span class="nx">time</span><span class="p">.</span><span class="nf">Sleep</span><span class="p">(</span><span class="nx">timeout</span><span class="p">);</span> <span class="nx">errChan</span> <span class="o">&lt;-</span> <span class="nx">errTimeout</span> <span class="p">}()</span>
			<span class="nx">responses</span> <span class="o">&lt;-</span> <span class="nx">tuple</span><span class="p">{</span><span class="nx">peer</span><span class="p">.</span><span class="nf">id</span><span class="p">(),</span> <span class="o">&lt;-</span><span class="nx">errChan</span><span class="p">}</span> <span class="c1">// first responder wins
</span><span class="c1"></span>		<span class="p">}(</span><span class="nx">peer</span><span class="p">)</span>
	<span class="p">}</span>

	<span class="nx">successes</span><span class="p">,</span> <span class="nx">stepDown</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">,</span> <span class="kc">false</span>
	<span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="p">&lt;</span> <span class="nb">cap</span><span class="p">(</span><span class="nx">responses</span><span class="p">);</span> <span class="nx">i</span><span class="o">++</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="nx">t</span> <span class="o">:=</span> <span class="o">&lt;-</span><span class="nx">responses</span><span class="p">;</span> <span class="nx">t</span><span class="p">.</span><span class="nx">err</span> <span class="p">{</span>
		<span class="k">case</span> <span class="kc">nil</span><span class="p">:</span>
			<span class="nx">s</span><span class="p">.</span><span class="nf">logGeneric</span><span class="p">(</span><span class="s">&#34;concurrentFlush: peer %d: OK (prevLogIndex(%d)=%d)&#34;</span><span class="p">,</span> <span class="nx">t</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span> <span class="nx">t</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span> <span class="nx">ni</span><span class="p">.</span><span class="nf">prevLogIndex</span><span class="p">(</span><span class="nx">t</span><span class="p">.</span><span class="nx">id</span><span class="p">))</span>
			<span class="nx">successes</span><span class="o">++</span>
		<span class="k">case</span> <span class="nx">errDeposed</span><span class="p">:</span>
			<span class="c1">// 当前的Leder节点落后于其他节点
</span><span class="c1"></span>			<span class="nx">s</span><span class="p">.</span><span class="nf">logGeneric</span><span class="p">(</span><span class="s">&#34;concurrentFlush: peer %d: deposed!&#34;</span><span class="p">,</span> <span class="nx">t</span><span class="p">.</span><span class="nx">id</span><span class="p">)</span>
			<span class="nx">stepDown</span> <span class="p">=</span> <span class="kc">true</span>
		<span class="k">default</span><span class="p">:</span>
			<span class="nx">s</span><span class="p">.</span><span class="nf">logGeneric</span><span class="p">(</span><span class="s">&#34;concurrentFlush: peer %d: %s (prevLogIndex(%d)=%d)&#34;</span><span class="p">,</span> <span class="nx">t</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span> <span class="nx">t</span><span class="p">.</span><span class="nx">err</span><span class="p">,</span> <span class="nx">t</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span> <span class="nx">ni</span><span class="p">.</span><span class="nf">prevLogIndex</span><span class="p">(</span><span class="nx">t</span><span class="p">.</span><span class="nx">id</span><span class="p">))</span>
			<span class="c1">// nothing to do but log and continue
</span><span class="c1"></span>		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nx">successes</span><span class="p">,</span> <span class="nx">stepDown</span>
<span class="p">}</span>

<span class="c1">// 作为Leader角色运行
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">s</span> <span class="o">*</span><span class="nx">Server</span><span class="p">)</span> <span class="nf">leaderSelect</span><span class="p">()</span> <span class="p">{</span>
	<span class="k">if</span> <span class="nx">s</span><span class="p">.</span><span class="nx">leader</span> <span class="o">!=</span> <span class="nx">s</span><span class="p">.</span><span class="nx">id</span> <span class="p">{</span>
		<span class="nb">panic</span><span class="p">(</span><span class="nx">fmt</span><span class="p">.</span><span class="nf">Sprintf</span><span class="p">(</span><span class="s">&#34;leader (%d) not me (%d) when entering leaderSelect&#34;</span><span class="p">,</span> <span class="nx">s</span><span class="p">.</span><span class="nx">leader</span><span class="p">,</span> <span class="nx">s</span><span class="p">.</span><span class="nx">id</span><span class="p">))</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="nx">s</span><span class="p">.</span><span class="nx">vote</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">{</span>
		<span class="nb">panic</span><span class="p">(</span><span class="nx">fmt</span><span class="p">.</span><span class="nf">Sprintf</span><span class="p">(</span><span class="s">&#34;vote (%d) not zero when entering leaderSelect&#34;</span><span class="p">,</span> <span class="nx">s</span><span class="p">.</span><span class="nx">leader</span><span class="p">))</span>
	<span class="p">}</span>

	<span class="c1">// 5.3 Log replication: &#34;The leader maintains a nextIndex for each follower,
</span><span class="c1"></span>	<span class="c1">// which is the index of the next log entry the leader will send to that
</span><span class="c1"></span>	<span class="c1">// follower. When a leader first comes to power it initializes all nextIndex
</span><span class="c1"></span>	<span class="c1">// values to the index just after the last one in its log.&#34;
</span><span class="c1"></span>	<span class="c1">//
</span><span class="c1"></span>	<span class="c1">// I changed this from lastIndex+1 to simply lastIndex. Every initial
</span><span class="c1"></span>	<span class="c1">// communication from leader to follower was being rejected and we were
</span><span class="c1"></span>	<span class="c1">// doing the decrement. This was just annoying, except if you manage to
</span><span class="c1"></span>	<span class="c1">// sneak in a command before the first heartbeat. Then, it will never get
</span><span class="c1"></span>	<span class="c1">// properly replicated (it seemed).
</span><span class="c1"></span>	
	<span class="c1">// Leader为每个Follower保存了最新的同步日志索引
</span><span class="c1"></span>	<span class="nx">ni</span> <span class="o">:=</span> <span class="nf">newNextIndex</span><span class="p">(</span><span class="nx">s</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nf">allPeers</span><span class="p">().</span><span class="nf">except</span><span class="p">(</span><span class="nx">s</span><span class="p">.</span><span class="nx">id</span><span class="p">),</span> <span class="nx">s</span><span class="p">.</span><span class="nx">log</span><span class="p">.</span><span class="nf">lastIndex</span><span class="p">())</span> <span class="c1">// +1)
</span><span class="c1"></span>
	<span class="nx">flush</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">(</span><span class="kd">chan</span> <span class="kd">struct</span><span class="p">{})</span>
	<span class="nx">heartbeat</span> <span class="o">:=</span> <span class="nx">time</span><span class="p">.</span><span class="nf">NewTicker</span><span class="p">(</span><span class="nf">broadcastInterval</span><span class="p">())</span>
	<span class="k">defer</span> <span class="nx">heartbeat</span><span class="p">.</span><span class="nf">Stop</span><span class="p">()</span>
	<span class="k">go</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
      	<span class="c1">// 发送心跳，除了检测心跳外，还有防止Follower发送选举
</span><span class="c1"></span>		<span class="k">for</span> <span class="nx">_</span> <span class="p">=</span> <span class="k">range</span> <span class="nx">heartbeat</span><span class="p">.</span><span class="nx">C</span> <span class="p">{</span>
			<span class="nx">flush</span> <span class="o">&lt;-</span> <span class="kd">struct</span><span class="p">{}{}</span>
		<span class="p">}</span>
	<span class="p">}()</span>

	<span class="k">for</span> <span class="p">{</span>
		<span class="k">select</span> <span class="p">{</span>
		<span class="k">case</span> <span class="nx">q</span> <span class="o">:=</span> <span class="o">&lt;-</span><span class="nx">s</span><span class="p">.</span><span class="nx">quit</span><span class="p">:</span>
			<span class="nx">s</span><span class="p">.</span><span class="nf">handleQuit</span><span class="p">(</span><span class="nx">q</span><span class="p">)</span>
			<span class="k">return</span>
		<span class="c1">// 收到命令
</span><span class="c1"></span>		<span class="k">case</span> <span class="nx">t</span> <span class="o">:=</span> <span class="o">&lt;-</span><span class="nx">s</span><span class="p">.</span><span class="nx">commandChan</span><span class="p">:</span>
			<span class="c1">// Append the command to our (leader) log
</span><span class="c1"></span>			<span class="nx">s</span><span class="p">.</span><span class="nf">logGeneric</span><span class="p">(</span><span class="s">&#34;got command, appending&#34;</span><span class="p">)</span>
			<span class="nx">currentTerm</span> <span class="o">:=</span> <span class="nx">s</span><span class="p">.</span><span class="nx">term</span>
			<span class="nx">entry</span> <span class="o">:=</span> <span class="nx">logEntry</span><span class="p">{</span>
				<span class="nx">Index</span><span class="p">:</span>           <span class="nx">s</span><span class="p">.</span><span class="nx">log</span><span class="p">.</span><span class="nf">lastIndex</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
				<span class="nx">Term</span><span class="p">:</span>            <span class="nx">currentTerm</span><span class="p">,</span>
				<span class="nx">Command</span><span class="p">:</span>         <span class="nx">t</span><span class="p">.</span><span class="nx">Command</span><span class="p">,</span>
				<span class="nx">commandResponse</span><span class="p">:</span> <span class="nx">t</span><span class="p">.</span><span class="nx">CommandResponse</span><span class="p">,</span>
			<span class="p">}</span>
          	<span class="c1">// 追加日志
</span><span class="c1"></span>			<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">s</span><span class="p">.</span><span class="nx">log</span><span class="p">.</span><span class="nf">appendEntry</span><span class="p">(</span><span class="nx">entry</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
				<span class="nx">t</span><span class="p">.</span><span class="nx">Err</span> <span class="o">&lt;-</span> <span class="nx">err</span>
				<span class="k">continue</span>
			<span class="p">}</span>
			<span class="nx">s</span><span class="p">.</span><span class="nf">logGeneric</span><span class="p">(</span>
				<span class="s">&#34;after append, commitIndex=%d lastIndex=%d lastTerm=%d&#34;</span><span class="p">,</span>
				<span class="nx">s</span><span class="p">.</span><span class="nx">log</span><span class="p">.</span><span class="nf">getCommitIndex</span><span class="p">(),</span>
				<span class="nx">s</span><span class="p">.</span><span class="nx">log</span><span class="p">.</span><span class="nf">lastIndex</span><span class="p">(),</span>
				<span class="nx">s</span><span class="p">.</span><span class="nx">log</span><span class="p">.</span><span class="nf">lastTerm</span><span class="p">(),</span>
			<span class="p">)</span>

			<span class="c1">// Now that the entry is in the log, we can fall back to the
</span><span class="c1"></span>			<span class="c1">// normal flushing mechanism to attempt to replicate the entry
</span><span class="c1"></span>			<span class="c1">// and advance the commit index. We trigger a manual flush as a
</span><span class="c1"></span>			<span class="c1">// convenience, so our caller might get a response a bit sooner.
</span><span class="c1"></span>          	<span class="c1">// 这里将日志同步放到了同步队列就返回给客户端了，正常来说，需要&#34;共识&#34;达成才返回给客户端
</span><span class="c1"></span>			<span class="k">go</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span> <span class="nx">flush</span> <span class="o">&lt;-</span> <span class="kd">struct</span><span class="p">{}{}</span> <span class="p">}()</span>
			<span class="nx">t</span><span class="p">.</span><span class="nx">Err</span> <span class="o">&lt;-</span> <span class="kc">nil</span>
        <span class="c1">// 收到配置变更
</span><span class="c1"></span>		<span class="k">case</span> <span class="nx">t</span> <span class="o">:=</span> <span class="o">&lt;-</span><span class="nx">s</span><span class="p">.</span><span class="nx">configurationChan</span><span class="p">:</span>
			<span class="c1">// Attempt to change our local configuration
</span><span class="c1"></span>			<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">s</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nf">changeTo</span><span class="p">(</span><span class="nf">makePeerMap</span><span class="p">(</span><span class="nx">t</span><span class="p">.</span><span class="nx">Peers</span><span class="o">...</span><span class="p">));</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
				<span class="nx">t</span><span class="p">.</span><span class="nx">Err</span> <span class="o">&lt;-</span> <span class="nx">err</span>
				<span class="k">continue</span>
			<span class="p">}</span>

			<span class="c1">// Serialize the local (C_old,new) configuration
</span><span class="c1"></span>			<span class="nx">encodedConfiguration</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">s</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nf">encode</span><span class="p">()</span>
			<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
				<span class="nx">t</span><span class="p">.</span><span class="nx">Err</span> <span class="o">&lt;-</span> <span class="nx">err</span>
				<span class="k">continue</span>
			<span class="p">}</span>

			<span class="c1">// We&#39;re gonna write+replicate that config via log mechanisms.
</span><span class="c1"></span>			<span class="c1">// Prepare the on-commit callback.
</span><span class="c1"></span>			<span class="nx">entry</span> <span class="o">:=</span> <span class="nx">logEntry</span><span class="p">{</span>
				<span class="nx">Index</span><span class="p">:</span>           <span class="nx">s</span><span class="p">.</span><span class="nx">log</span><span class="p">.</span><span class="nf">lastIndex</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
				<span class="nx">Term</span><span class="p">:</span>            <span class="nx">s</span><span class="p">.</span><span class="nx">term</span><span class="p">,</span>
				<span class="nx">Command</span><span class="p">:</span>         <span class="nx">encodedConfiguration</span><span class="p">,</span>
				<span class="nx">isConfiguration</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
				<span class="nx">committed</span><span class="p">:</span>       <span class="nb">make</span><span class="p">(</span><span class="kd">chan</span> <span class="kt">bool</span><span class="p">),</span>
			<span class="p">}</span>
			<span class="k">go</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
              	<span class="c1">// 当日志被commited时，committed将被回调
</span><span class="c1"></span>				<span class="nx">committed</span> <span class="o">:=</span> <span class="o">&lt;-</span><span class="nx">entry</span><span class="p">.</span><span class="nx">committed</span>
				<span class="k">if</span> <span class="p">!</span><span class="nx">committed</span> <span class="p">{</span>
					<span class="nx">s</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nf">changeAborted</span><span class="p">()</span>
					<span class="k">return</span>
				<span class="p">}</span>
             	<span class="c1">// 日志被committed了，说明其他节点都应用了最新的配置，所以当前的节点配置也需要更新
</span><span class="c1"></span>				<span class="nx">s</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nf">changeCommitted</span><span class="p">()</span>
				<span class="k">if</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">ok</span> <span class="o">:=</span> <span class="nx">s</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nf">allPeers</span><span class="p">()[</span><span class="nx">s</span><span class="p">.</span><span class="nx">id</span><span class="p">];</span> <span class="p">!</span><span class="nx">ok</span> <span class="p">{</span>
                  	<span class="c1">// 当前节点已被新集群剔除
</span><span class="c1"></span>					<span class="nx">s</span><span class="p">.</span><span class="nf">logGeneric</span><span class="p">(</span><span class="s">&#34;leader expelled; shutting down&#34;</span><span class="p">)</span>
					<span class="nx">q</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">(</span><span class="kd">chan</span> <span class="kd">struct</span><span class="p">{})</span>
					<span class="nx">s</span><span class="p">.</span><span class="nx">quit</span> <span class="o">&lt;-</span> <span class="nx">q</span>
                  	<span class="c1">// 节点已退出
</span><span class="c1"></span>					<span class="o">&lt;-</span><span class="nx">q</span>
				<span class="p">}</span>
			<span class="p">}()</span>
          	<span class="c1">// 日志追加
</span><span class="c1"></span>			<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">s</span><span class="p">.</span><span class="nx">log</span><span class="p">.</span><span class="nf">appendEntry</span><span class="p">(</span><span class="nx">entry</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
				<span class="nx">t</span><span class="p">.</span><span class="nx">Err</span> <span class="o">&lt;-</span> <span class="nx">err</span>
				<span class="k">continue</span>
			<span class="p">}</span>

		<span class="k">case</span> <span class="o">&lt;-</span><span class="nx">flush</span><span class="p">:</span>
          	<span class="c1">// 获取需要同步的节点
</span><span class="c1"></span>			<span class="nx">recipients</span> <span class="o">:=</span> <span class="nx">s</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nf">allPeers</span><span class="p">().</span><span class="nf">except</span><span class="p">(</span><span class="nx">s</span><span class="p">.</span><span class="nx">id</span><span class="p">)</span>

			<span class="c1">// Special case: network of 1
</span><span class="c1"></span>			<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nx">recipients</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="p">{</span>
				<span class="nx">ourLastIndex</span> <span class="o">:=</span> <span class="nx">s</span><span class="p">.</span><span class="nx">log</span><span class="p">.</span><span class="nf">lastIndex</span><span class="p">()</span>
				<span class="k">if</span> <span class="nx">ourLastIndex</span> <span class="p">&gt;</span> <span class="mi">0</span> <span class="p">{</span>
					<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">s</span><span class="p">.</span><span class="nx">log</span><span class="p">.</span><span class="nf">commitTo</span><span class="p">(</span><span class="nx">ourLastIndex</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
						<span class="nx">s</span><span class="p">.</span><span class="nf">logGeneric</span><span class="p">(</span><span class="s">&#34;commitTo(%d): %s&#34;</span><span class="p">,</span> <span class="nx">ourLastIndex</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
						<span class="k">continue</span>
					<span class="p">}</span>
					<span class="nx">s</span><span class="p">.</span><span class="nf">logGeneric</span><span class="p">(</span><span class="s">&#34;after commitTo(%d), commitIndex=%d&#34;</span><span class="p">,</span> <span class="nx">ourLastIndex</span><span class="p">,</span> <span class="nx">s</span><span class="p">.</span><span class="nx">log</span><span class="p">.</span><span class="nf">getCommitIndex</span><span class="p">())</span>
				<span class="p">}</span>
				<span class="k">continue</span>
			<span class="p">}</span>

			<span class="c1">// Normal case: network of at-least-2
</span><span class="c1"></span>          	<span class="c1">// 并发同步日志
</span><span class="c1"></span>			<span class="nx">successes</span><span class="p">,</span> <span class="nx">stepDown</span> <span class="o">:=</span> <span class="nx">s</span><span class="p">.</span><span class="nf">concurrentFlush</span><span class="p">(</span><span class="nx">recipients</span><span class="p">,</span> <span class="nx">ni</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="nf">broadcastInterval</span><span class="p">())</span>
			<span class="k">if</span> <span class="nx">stepDown</span> <span class="p">{</span>
              	<span class="c1">// 节点已被卸任
</span><span class="c1"></span>				<span class="nx">s</span><span class="p">.</span><span class="nf">logGeneric</span><span class="p">(</span><span class="s">&#34;deposed during flush&#34;</span><span class="p">)</span>
				<span class="nx">s</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nf">Set</span><span class="p">(</span><span class="nx">follower</span><span class="p">)</span>
				<span class="nx">s</span><span class="p">.</span><span class="nx">leader</span> <span class="p">=</span> <span class="nx">unknownLeader</span>
				<span class="k">return</span>
			<span class="p">}</span>

			<span class="c1">// Only when we know all followers accepted the flush can we
</span><span class="c1"></span>			<span class="c1">// consider incrementing commitIndex and pushing out another
</span><span class="c1"></span>			<span class="c1">// round of flushes.
</span><span class="c1"></span>			<span class="k">if</span> <span class="nx">successes</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="nx">recipients</span><span class="p">)</span> <span class="p">{</span>
              	<span class="c1">// 最小被同步的Index
</span><span class="c1"></span>				<span class="nx">peersBestIndex</span> <span class="o">:=</span> <span class="nx">ni</span><span class="p">.</span><span class="nf">bestIndex</span><span class="p">()</span>
				<span class="nx">ourLastIndex</span> <span class="o">:=</span> <span class="nx">s</span><span class="p">.</span><span class="nx">log</span><span class="p">.</span><span class="nf">lastIndex</span><span class="p">()</span>
				<span class="nx">ourCommitIndex</span> <span class="o">:=</span> <span class="nx">s</span><span class="p">.</span><span class="nx">log</span><span class="p">.</span><span class="nf">getCommitIndex</span><span class="p">()</span>
				<span class="k">if</span> <span class="nx">peersBestIndex</span> <span class="p">&gt;</span> <span class="nx">ourLastIndex</span> <span class="p">{</span>
					<span class="c1">// safety check: we&#39;ve probably been deposed
</span><span class="c1"></span>					<span class="nx">s</span><span class="p">.</span><span class="nf">logGeneric</span><span class="p">(</span><span class="s">&#34;peers&#39; best index %d &gt; our lastIndex %d&#34;</span><span class="p">,</span> <span class="nx">peersBestIndex</span><span class="p">,</span> <span class="nx">ourLastIndex</span><span class="p">)</span>
					<span class="nx">s</span><span class="p">.</span><span class="nf">logGeneric</span><span class="p">(</span><span class="s">&#34;this is crazy, I&#39;m gonna become a follower&#34;</span><span class="p">)</span>
					<span class="nx">s</span><span class="p">.</span><span class="nx">leader</span> <span class="p">=</span> <span class="nx">unknownLeader</span>
					<span class="nx">s</span><span class="p">.</span><span class="nx">vote</span> <span class="p">=</span> <span class="nx">noVote</span>
					<span class="nx">s</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nf">Set</span><span class="p">(</span><span class="nx">follower</span><span class="p">)</span>
					<span class="k">return</span>
				<span class="p">}</span>
				<span class="k">if</span> <span class="nx">peersBestIndex</span> <span class="p">&gt;</span> <span class="nx">ourCommitIndex</span> <span class="p">{</span>
					<span class="c1">// committed Leader Index
</span><span class="c1"></span>                  	<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">s</span><span class="p">.</span><span class="nx">log</span><span class="p">.</span><span class="nf">commitTo</span><span class="p">(</span><span class="nx">peersBestIndex</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
						<span class="nx">s</span><span class="p">.</span><span class="nf">logGeneric</span><span class="p">(</span><span class="s">&#34;commitTo(%d): %s&#34;</span><span class="p">,</span> <span class="nx">peersBestIndex</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
                      	<span class="c1">// 比如某个Follower在同步Index时失败了，
</span><span class="c1"></span>						<span class="k">continue</span> <span class="c1">// oh well, next time?
</span><span class="c1"></span>					<span class="p">}</span>
					
					<span class="k">if</span> <span class="nx">s</span><span class="p">.</span><span class="nx">log</span><span class="p">.</span><span class="nf">getCommitIndex</span><span class="p">()</span> <span class="p">&gt;</span> <span class="nx">ourCommitIndex</span> <span class="p">{</span>
						<span class="c1">// 继续同步日志
</span><span class="c1"></span>						<span class="nx">s</span><span class="p">.</span><span class="nf">logGeneric</span><span class="p">(</span><span class="s">&#34;after commitTo(%d), commitIndex=%d -- queueing another flush&#34;</span><span class="p">,</span> <span class="nx">peersBestIndex</span><span class="p">,</span> <span class="nx">s</span><span class="p">.</span><span class="nx">log</span><span class="p">.</span><span class="nf">getCommitIndex</span><span class="p">())</span>
						<span class="k">go</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span> <span class="nx">flush</span> <span class="o">&lt;-</span> <span class="kd">struct</span><span class="p">{}{}</span> <span class="p">}()</span>
					<span class="p">}</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="c1">// 追加日志， 正常来说，Leader节点是不会受到该命令的，出现这种的可能是集群存在一个新的Leader节点，这命令就是该Leader发送过来的
</span><span class="c1"></span>		<span class="k">case</span> <span class="nx">t</span> <span class="o">:=</span> <span class="o">&lt;-</span><span class="nx">s</span><span class="p">.</span><span class="nx">appendEntriesChan</span><span class="p">:</span>
			<span class="nx">resp</span><span class="p">,</span> <span class="nx">stepDown</span> <span class="o">:=</span> <span class="nx">s</span><span class="p">.</span><span class="nf">handleAppendEntries</span><span class="p">(</span><span class="nx">t</span><span class="p">.</span><span class="nx">Request</span><span class="p">)</span>
			<span class="nx">s</span><span class="p">.</span><span class="nf">logAppendEntriesResponse</span><span class="p">(</span><span class="nx">t</span><span class="p">.</span><span class="nx">Request</span><span class="p">,</span> <span class="nx">resp</span><span class="p">,</span> <span class="nx">stepDown</span><span class="p">)</span>
			<span class="nx">t</span><span class="p">.</span><span class="nx">Response</span> <span class="o">&lt;-</span> <span class="nx">resp</span>
			<span class="k">if</span> <span class="nx">stepDown</span> <span class="p">{</span>
				<span class="nx">s</span><span class="p">.</span><span class="nf">logGeneric</span><span class="p">(</span><span class="s">&#34;after an appendEntries, deposed to Follower (leader=%d)&#34;</span><span class="p">,</span> <span class="nx">t</span><span class="p">.</span><span class="nx">Request</span><span class="p">.</span><span class="nx">LeaderID</span><span class="p">)</span>
				<span class="nx">s</span><span class="p">.</span><span class="nx">leader</span> <span class="p">=</span> <span class="nx">t</span><span class="p">.</span><span class="nx">Request</span><span class="p">.</span><span class="nx">LeaderID</span>
				<span class="nx">s</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nf">Set</span><span class="p">(</span><span class="nx">follower</span><span class="p">)</span>
				<span class="k">return</span> <span class="c1">// deposed
</span><span class="c1"></span>			<span class="p">}</span>
		<span class="c1">// 受到投票请求
</span><span class="c1"></span>		<span class="k">case</span> <span class="nx">t</span> <span class="o">:=</span> <span class="o">&lt;-</span><span class="nx">s</span><span class="p">.</span><span class="nx">requestVoteChan</span><span class="p">:</span>
			<span class="nx">resp</span><span class="p">,</span> <span class="nx">stepDown</span> <span class="o">:=</span> <span class="nx">s</span><span class="p">.</span><span class="nf">handleRequestVote</span><span class="p">(</span><span class="nx">t</span><span class="p">.</span><span class="nx">Request</span><span class="p">)</span>
			<span class="nx">s</span><span class="p">.</span><span class="nf">logRequestVoteResponse</span><span class="p">(</span><span class="nx">t</span><span class="p">.</span><span class="nx">Request</span><span class="p">,</span> <span class="nx">resp</span><span class="p">,</span> <span class="nx">stepDown</span><span class="p">)</span>
			<span class="nx">t</span><span class="p">.</span><span class="nx">Response</span> <span class="o">&lt;-</span> <span class="nx">resp</span>
			<span class="k">if</span> <span class="nx">stepDown</span> <span class="p">{</span>
				<span class="nx">s</span><span class="p">.</span><span class="nf">logGeneric</span><span class="p">(</span><span class="s">&#34;after a requestVote, deposed to Follower (leader unknown)&#34;</span><span class="p">)</span>
				<span class="nx">s</span><span class="p">.</span><span class="nx">leader</span> <span class="p">=</span> <span class="nx">unknownLeader</span>
				<span class="nx">s</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nf">Set</span><span class="p">(</span><span class="nx">follower</span><span class="p">)</span>
				<span class="k">return</span> <span class="c1">// deposed
</span><span class="c1"></span>			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="c1">// handleRequestVote will modify s.term and s.vote, but nothing else.
</span><span class="c1">// stepDown means you need to: s.leader=unknownLeader, s.state.Set(Follower).
</span><span class="c1">// 处理投票
</span><span class="c1">// 可能会修改s.term和s.vote 的值; stepDown意味着需要设置s.leader = unkownLeader, s.state.Set(Follower)
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">s</span> <span class="o">*</span><span class="nx">Server</span><span class="p">)</span> <span class="nf">handleRequestVote</span><span class="p">(</span><span class="nx">rv</span> <span class="nx">requestVote</span><span class="p">)</span> <span class="p">(</span><span class="nx">requestVoteResponse</span><span class="p">,</span> <span class="kt">bool</span><span class="p">)</span> <span class="p">{</span>
	<span class="c1">// Spec is ambiguous here; basing this (loosely!) on benbjohnson&#39;s impl
</span><span class="c1"></span>
	<span class="c1">// If the request is from an old term, reject
</span><span class="c1"></span>	<span class="k">if</span> <span class="nx">rv</span><span class="p">.</span><span class="nx">Term</span> <span class="p">&lt;</span> <span class="nx">s</span><span class="p">.</span><span class="nx">term</span> <span class="p">{</span>
		<span class="k">return</span> <span class="nx">requestVoteResponse</span><span class="p">{</span>
			<span class="nx">Term</span><span class="p">:</span>        <span class="nx">s</span><span class="p">.</span><span class="nx">term</span><span class="p">,</span>
			<span class="nx">VoteGranted</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
			<span class="nx">reason</span><span class="p">:</span>      <span class="nx">fmt</span><span class="p">.</span><span class="nf">Sprintf</span><span class="p">(</span><span class="s">&#34;Term %d &lt; %d&#34;</span><span class="p">,</span> <span class="nx">rv</span><span class="p">.</span><span class="nx">Term</span><span class="p">,</span> <span class="nx">s</span><span class="p">.</span><span class="nx">term</span><span class="p">),</span>
		<span class="p">},</span> <span class="kc">false</span>
	<span class="p">}</span>

	<span class="c1">// If the request is from a newer term, reset our state
</span><span class="c1"></span>	<span class="nx">stepDown</span> <span class="o">:=</span> <span class="kc">false</span>
	<span class="k">if</span> <span class="nx">rv</span><span class="p">.</span><span class="nx">Term</span> <span class="p">&gt;</span> <span class="nx">s</span><span class="p">.</span><span class="nx">term</span> <span class="p">{</span>
		<span class="c1">// 本地节点落后于集群的其他节点，需要更新一下自己的任期号
</span><span class="c1"></span>		<span class="nx">s</span><span class="p">.</span><span class="nf">logGeneric</span><span class="p">(</span><span class="s">&#34;requestVote from newer term (%d): we defer&#34;</span><span class="p">,</span> <span class="nx">rv</span><span class="p">.</span><span class="nx">Term</span><span class="p">)</span>
		<span class="nx">s</span><span class="p">.</span><span class="nx">term</span> <span class="p">=</span> <span class="nx">rv</span><span class="p">.</span><span class="nx">Term</span>
		<span class="nx">s</span><span class="p">.</span><span class="nx">vote</span> <span class="p">=</span> <span class="nx">noVote</span>
		<span class="nx">s</span><span class="p">.</span><span class="nx">leader</span> <span class="p">=</span> <span class="nx">unknownLeader</span>
		<span class="nx">stepDown</span> <span class="p">=</span> <span class="kc">true</span>
	<span class="p">}</span>

	<span class="c1">// Special case: if we&#39;re the leader, and we haven&#39;t been deposed by a more
</span><span class="c1"></span>	<span class="c1">// recent term, then we should always deny the vote
</span><span class="c1"></span>	<span class="k">if</span> <span class="nx">s</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nf">Get</span><span class="p">()</span> <span class="o">==</span> <span class="nx">leader</span> <span class="o">&amp;&amp;</span> <span class="p">!</span><span class="nx">stepDown</span> <span class="p">{</span>
		<span class="c1">// 如果本地节点是Leader，并且又不落后于req 节点，则投反对票
</span><span class="c1"></span>		<span class="k">return</span> <span class="nx">requestVoteResponse</span><span class="p">{</span>
			<span class="nx">Term</span><span class="p">:</span>        <span class="nx">s</span><span class="p">.</span><span class="nx">term</span><span class="p">,</span>
			<span class="nx">VoteGranted</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
			<span class="nx">reason</span><span class="p">:</span>      <span class="s">&#34;already the leader&#34;</span><span class="p">,</span>
		<span class="p">},</span> <span class="nx">stepDown</span>
	<span class="p">}</span>

	<span class="c1">// If we&#39;ve already voted for someone else this term, reject
</span><span class="c1"></span>	<span class="c1">// 如果已经投过票，则投失败票
</span><span class="c1"></span>	<span class="k">if</span> <span class="nx">s</span><span class="p">.</span><span class="nx">vote</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="nx">s</span><span class="p">.</span><span class="nx">vote</span> <span class="o">!=</span> <span class="nx">rv</span><span class="p">.</span><span class="nx">CandidateID</span> <span class="p">{</span>
		<span class="k">if</span> <span class="nx">stepDown</span> <span class="p">{</span>
			<span class="nb">panic</span><span class="p">(</span><span class="s">&#34;impossible state in handleRequestVote&#34;</span><span class="p">)</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="nx">requestVoteResponse</span><span class="p">{</span>
			<span class="nx">Term</span><span class="p">:</span>        <span class="nx">s</span><span class="p">.</span><span class="nx">term</span><span class="p">,</span>
			<span class="nx">VoteGranted</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
			<span class="nx">reason</span><span class="p">:</span>      <span class="nx">fmt</span><span class="p">.</span><span class="nf">Sprintf</span><span class="p">(</span><span class="s">&#34;already cast vote for %d&#34;</span><span class="p">,</span> <span class="nx">s</span><span class="p">.</span><span class="nx">vote</span><span class="p">),</span>
		<span class="p">},</span> <span class="nx">stepDown</span>
	<span class="p">}</span>

	<span class="c1">// If the candidate log isn&#39;t at least as recent as ours, reject
</span><span class="c1"></span>	<span class="k">if</span> <span class="nx">s</span><span class="p">.</span><span class="nx">log</span><span class="p">.</span><span class="nf">lastIndex</span><span class="p">()</span> <span class="p">&gt;</span> <span class="nx">rv</span><span class="p">.</span><span class="nx">LastLogIndex</span> <span class="o">||</span> <span class="nx">s</span><span class="p">.</span><span class="nx">log</span><span class="p">.</span><span class="nf">lastTerm</span><span class="p">()</span> <span class="p">&gt;</span> <span class="nx">rv</span><span class="p">.</span><span class="nx">LastLogTerm</span> <span class="p">{</span>
		<span class="k">return</span> <span class="nx">requestVoteResponse</span><span class="p">{</span>
			<span class="nx">Term</span><span class="p">:</span>        <span class="nx">s</span><span class="p">.</span><span class="nx">term</span><span class="p">,</span>
			<span class="nx">VoteGranted</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
			<span class="nx">reason</span><span class="p">:</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Sprintf</span><span class="p">(</span>
				<span class="s">&#34;our index/term %d/%d &gt; %d/%d&#34;</span><span class="p">,</span>
				<span class="nx">s</span><span class="p">.</span><span class="nx">log</span><span class="p">.</span><span class="nf">lastIndex</span><span class="p">(),</span>
				<span class="nx">s</span><span class="p">.</span><span class="nx">log</span><span class="p">.</span><span class="nf">lastTerm</span><span class="p">(),</span>
				<span class="nx">rv</span><span class="p">.</span><span class="nx">LastLogIndex</span><span class="p">,</span>
				<span class="nx">rv</span><span class="p">.</span><span class="nx">LastLogTerm</span><span class="p">,</span>
			<span class="p">),</span>
		<span class="p">},</span> <span class="nx">stepDown</span>
	<span class="p">}</span>

	<span class="c1">// We passed all the tests: cast vote in favor
</span><span class="c1"></span>	<span class="nx">s</span><span class="p">.</span><span class="nx">vote</span> <span class="p">=</span> <span class="nx">rv</span><span class="p">.</span><span class="nx">CandidateID</span>
	<span class="nx">s</span><span class="p">.</span><span class="nf">resetElectionTimeout</span><span class="p">()</span>
	<span class="k">return</span> <span class="nx">requestVoteResponse</span><span class="p">{</span>
		<span class="nx">Term</span><span class="p">:</span>        <span class="nx">s</span><span class="p">.</span><span class="nx">term</span><span class="p">,</span>
		<span class="nx">VoteGranted</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
	<span class="p">},</span> <span class="nx">stepDown</span>
<span class="p">}</span>

<span class="c1">// handleAppendEntries will modify s.term and s.vote, but nothing else.
</span><span class="c1">// stepDown means you need to: s.leader=r.LeaderID, s.state.Set(Follower).
</span><span class="c1">// 追加日志，需要注意的是，handleAppendEntries也会修改s.term和s.vote
</span><span class="c1">// stepDown也会修改s.Leader, s,state
</span><span class="c1">// 需要注意的是，本地节点的state不同时，其行为也是不用的
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">s</span> <span class="o">*</span><span class="nx">Server</span><span class="p">)</span> <span class="nf">handleAppendEntries</span><span class="p">(</span><span class="nx">r</span> <span class="nx">appendEntries</span><span class="p">)</span> <span class="p">(</span><span class="nx">appendEntriesResponse</span><span class="p">,</span> <span class="kt">bool</span><span class="p">)</span> <span class="p">{</span>
	<span class="c1">// Spec is ambiguous here; basing this on benbjohnson&#39;s impl
</span><span class="c1"></span>
	<span class="c1">// Maybe a nicer way to handle this is to define explicit handler functions
</span><span class="c1"></span>	<span class="c1">// for each Server state. Then, we won&#39;t try to hide too much logic (i.e.
</span><span class="c1"></span>	<span class="c1">// too many protocol rules) in one code path.
</span><span class="c1"></span>
	<span class="c1">// If the request is from an old term, reject
</span><span class="c1"></span>	<span class="k">if</span> <span class="nx">r</span><span class="p">.</span><span class="nx">Term</span> <span class="p">&lt;</span> <span class="nx">s</span><span class="p">.</span><span class="nx">term</span> <span class="p">{</span>
		<span class="k">return</span> <span class="nx">appendEntriesResponse</span><span class="p">{</span>
			<span class="nx">Term</span><span class="p">:</span>    <span class="nx">s</span><span class="p">.</span><span class="nx">term</span><span class="p">,</span>
			<span class="nx">Success</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
			<span class="nx">reason</span><span class="p">:</span>  <span class="nx">fmt</span><span class="p">.</span><span class="nf">Sprintf</span><span class="p">(</span><span class="s">&#34;Term %d &lt; %d&#34;</span><span class="p">,</span> <span class="nx">r</span><span class="p">.</span><span class="nx">Term</span><span class="p">,</span> <span class="nx">s</span><span class="p">.</span><span class="nx">term</span><span class="p">),</span>
		<span class="p">},</span> <span class="kc">false</span>
	<span class="p">}</span>

	<span class="c1">// If the request is from a newer term, reset our state
</span><span class="c1"></span>	<span class="nx">stepDown</span> <span class="o">:=</span> <span class="kc">false</span>
	<span class="k">if</span> <span class="nx">r</span><span class="p">.</span><span class="nx">Term</span> <span class="p">&gt;</span> <span class="nx">s</span><span class="p">.</span><span class="nx">term</span> <span class="p">{</span>
		<span class="nx">s</span><span class="p">.</span><span class="nx">term</span> <span class="p">=</span> <span class="nx">r</span><span class="p">.</span><span class="nx">Term</span>
		<span class="nx">s</span><span class="p">.</span><span class="nx">vote</span> <span class="p">=</span> <span class="nx">noVote</span>
		<span class="nx">stepDown</span> <span class="p">=</span> <span class="kc">true</span>
	<span class="p">}</span>

	<span class="c1">// Special case for candidates: &#34;While waiting for votes, a candidate may
</span><span class="c1"></span>	<span class="c1">// receive an appendEntries RPC from another server claiming to be leader.
</span><span class="c1"></span>	<span class="c1">// If the leader’s term (included in its RPC) is at least as large as the
</span><span class="c1"></span>	<span class="c1">// candidate’s current term, then the candidate recognizes the leader as
</span><span class="c1"></span>	<span class="c1">// legitimate and steps down, meaning that it returns to follower state.&#34;
</span><span class="c1"></span>	<span class="k">if</span> <span class="nx">s</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nf">Get</span><span class="p">()</span> <span class="o">==</span> <span class="nx">candidate</span> <span class="o">&amp;&amp;</span> <span class="nx">r</span><span class="p">.</span><span class="nx">LeaderID</span> <span class="o">!=</span> <span class="nx">s</span><span class="p">.</span><span class="nx">leader</span> <span class="o">&amp;&amp;</span> <span class="nx">r</span><span class="p">.</span><span class="nx">Term</span> <span class="o">&gt;=</span> <span class="nx">s</span><span class="p">.</span><span class="nx">term</span> <span class="p">{</span>
		<span class="nx">s</span><span class="p">.</span><span class="nx">term</span> <span class="p">=</span> <span class="nx">r</span><span class="p">.</span><span class="nx">Term</span>
		<span class="nx">s</span><span class="p">.</span><span class="nx">vote</span> <span class="p">=</span> <span class="nx">noVote</span>
		<span class="nx">stepDown</span> <span class="p">=</span> <span class="kc">true</span>
	<span class="p">}</span>

	<span class="c1">// In any case, reset our election timeout
</span><span class="c1"></span>	<span class="nx">s</span><span class="p">.</span><span class="nf">resetElectionTimeout</span><span class="p">()</span>

	<span class="c1">// Reject if log doesn&#39;t contain a matching previous entry
</span><span class="c1"></span>	<span class="c1">// 如果{PreLogIndex, PreLogTerm} 不是最新的条目，则失败
</span><span class="c1"></span>	<span class="c1">// [{1, 2},{1, 3},		{1,4},{1,5},{1,6}] =&gt; {1,5} =&gt; [{1, 2},{1, 3},		{1,4},{1,5}]
</span><span class="c1"></span>	<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">s</span><span class="p">.</span><span class="nx">log</span><span class="p">.</span><span class="nf">ensureLastIs</span><span class="p">(</span><span class="nx">r</span><span class="p">.</span><span class="nx">PrevLogIndex</span><span class="p">,</span> <span class="nx">r</span><span class="p">.</span><span class="nx">PrevLogTerm</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="k">return</span> <span class="nx">appendEntriesResponse</span><span class="p">{</span>
			<span class="nx">Term</span><span class="p">:</span>    <span class="nx">s</span><span class="p">.</span><span class="nx">term</span><span class="p">,</span>
			<span class="nx">Success</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
			<span class="nx">reason</span><span class="p">:</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Sprintf</span><span class="p">(</span>
				<span class="s">&#34;while ensuring last log entry had index=%d term=%d: error: %s&#34;</span><span class="p">,</span>
				<span class="nx">r</span><span class="p">.</span><span class="nx">PrevLogIndex</span><span class="p">,</span>
				<span class="nx">r</span><span class="p">.</span><span class="nx">PrevLogTerm</span><span class="p">,</span>
				<span class="nx">err</span><span class="p">,</span>
			<span class="p">),</span>
		<span class="p">},</span> <span class="nx">stepDown</span>
	<span class="p">}</span>

	<span class="c1">// Process the entries
</span><span class="c1"></span>	<span class="k">for</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">entry</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">r</span><span class="p">.</span><span class="nx">Entries</span> <span class="p">{</span>
		<span class="c1">// Configuration changes requre special preprocessing
</span><span class="c1"></span>		<span class="kd">var</span> <span class="nx">pm</span> <span class="nx">peerMap</span>
		<span class="c1">// 处理配置
</span><span class="c1"></span>		<span class="k">if</span> <span class="nx">entry</span><span class="p">.</span><span class="nx">isConfiguration</span> <span class="p">{</span>
			<span class="nx">commandBuf</span> <span class="o">:=</span> <span class="nx">bytes</span><span class="p">.</span><span class="nf">NewBuffer</span><span class="p">(</span><span class="nx">entry</span><span class="p">.</span><span class="nx">Command</span><span class="p">)</span>
			<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">gob</span><span class="p">.</span><span class="nf">NewDecoder</span><span class="p">(</span><span class="nx">commandBuf</span><span class="p">).</span><span class="nf">Decode</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">pm</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
				<span class="nb">panic</span><span class="p">(</span><span class="s">&#34;gob decode of peers failed&#34;</span><span class="p">)</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="nx">s</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nf">Get</span><span class="p">()</span> <span class="o">==</span> <span class="nx">leader</span> <span class="p">{</span>
				<span class="c1">// TODO should we instead just ignore this entry?
</span><span class="c1"></span>				<span class="k">return</span> <span class="nx">appendEntriesResponse</span><span class="p">{</span>
					<span class="nx">Term</span><span class="p">:</span>    <span class="nx">s</span><span class="p">.</span><span class="nx">term</span><span class="p">,</span>
					<span class="nx">Success</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
					<span class="nx">reason</span><span class="p">:</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Sprintf</span><span class="p">(</span>
						<span class="s">&#34;AppendEntry %d/%d failed (configuration): %s&#34;</span><span class="p">,</span>
						<span class="nx">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span>
						<span class="nb">len</span><span class="p">(</span><span class="nx">r</span><span class="p">.</span><span class="nx">Entries</span><span class="p">),</span>
						<span class="s">&#34;Leader shouldn&#39;t receive configurations via appendEntries&#34;</span><span class="p">,</span>
					<span class="p">),</span>
				<span class="p">},</span> <span class="nx">stepDown</span>
			<span class="p">}</span>

			<span class="c1">// Expulsion recognition
</span><span class="c1"></span>			<span class="k">if</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">ok</span> <span class="o">:=</span> <span class="nx">pm</span><span class="p">[</span><span class="nx">s</span><span class="p">.</span><span class="nx">id</span><span class="p">];</span> <span class="p">!</span><span class="nx">ok</span> <span class="p">{</span>
				<span class="nx">entry</span><span class="p">.</span><span class="nx">committed</span> <span class="p">=</span> <span class="nb">make</span><span class="p">(</span><span class="kd">chan</span> <span class="kt">bool</span><span class="p">)</span>
				<span class="k">go</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
					<span class="k">if</span> <span class="o">&lt;-</span><span class="nx">entry</span><span class="p">.</span><span class="nx">committed</span> <span class="p">{</span>
						<span class="nx">s</span><span class="p">.</span><span class="nf">logGeneric</span><span class="p">(</span><span class="s">&#34;non-leader expelled; shutting down&#34;</span><span class="p">)</span>
						<span class="nx">q</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">(</span><span class="kd">chan</span> <span class="kd">struct</span><span class="p">{})</span>
						<span class="nx">s</span><span class="p">.</span><span class="nx">quit</span> <span class="o">&lt;-</span> <span class="nx">q</span>
						<span class="o">&lt;-</span><span class="nx">q</span>
					<span class="p">}</span>
				<span class="p">}()</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="c1">// Append entry to the log
</span><span class="c1"></span>		<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">s</span><span class="p">.</span><span class="nx">log</span><span class="p">.</span><span class="nf">appendEntry</span><span class="p">(</span><span class="nx">entry</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
			<span class="k">return</span> <span class="nx">appendEntriesResponse</span><span class="p">{</span>
				<span class="nx">Term</span><span class="p">:</span>    <span class="nx">s</span><span class="p">.</span><span class="nx">term</span><span class="p">,</span>
				<span class="nx">Success</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
				<span class="nx">reason</span><span class="p">:</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Sprintf</span><span class="p">(</span>
					<span class="s">&#34;AppendEntry %d/%d failed: %s&#34;</span><span class="p">,</span>
					<span class="nx">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span>
					<span class="nb">len</span><span class="p">(</span><span class="nx">r</span><span class="p">.</span><span class="nx">Entries</span><span class="p">),</span>
					<span class="nx">err</span><span class="p">,</span>
				<span class="p">),</span>
			<span class="p">},</span> <span class="nx">stepDown</span>
		<span class="p">}</span>

		<span class="c1">// &#34;Once a given server adds the new configuration entry to its log, it
</span><span class="c1"></span>		<span class="c1">// uses that configuration for all future decisions (it does not wait
</span><span class="c1"></span>		<span class="c1">// for the entry to become committed).&#34;
</span><span class="c1"></span>		<span class="k">if</span> <span class="nx">entry</span><span class="p">.</span><span class="nx">isConfiguration</span> <span class="p">{</span>
			<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">s</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nf">directSet</span><span class="p">(</span><span class="nx">pm</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
				<span class="k">return</span> <span class="nx">appendEntriesResponse</span><span class="p">{</span>
					<span class="nx">Term</span><span class="p">:</span>    <span class="nx">s</span><span class="p">.</span><span class="nx">term</span><span class="p">,</span>
					<span class="nx">Success</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
					<span class="nx">reason</span><span class="p">:</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Sprintf</span><span class="p">(</span>
						<span class="s">&#34;AppendEntry %d/%d failed (configuration): %s&#34;</span><span class="p">,</span>
						<span class="nx">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span>
						<span class="nb">len</span><span class="p">(</span><span class="nx">r</span><span class="p">.</span><span class="nx">Entries</span><span class="p">),</span>
						<span class="nx">err</span><span class="p">,</span>
					<span class="p">),</span>
				<span class="p">},</span> <span class="nx">stepDown</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="c1">// Commit up to the commit index.
</span><span class="c1"></span>	<span class="c1">//
</span><span class="c1"></span>	<span class="c1">// &lt; ptrb&gt; ongardie: if the new leader sends a 0-entry appendEntries
</span><span class="c1"></span>	<span class="c1">//  with lastIndex=5 commitIndex=4, to a follower that has lastIndex=5
</span><span class="c1"></span>	<span class="c1">//  commitIndex=5 -- in my impl, this fails, because commitIndex is too
</span><span class="c1"></span>	<span class="c1">//  small. shouldn&#39;t be?
</span><span class="c1"></span>	<span class="c1">// &lt;@ongardie&gt; ptrb: i don&#39;t think that should fail
</span><span class="c1"></span>	<span class="c1">// &lt;@ongardie&gt; there are 4 ways an appendEntries request can fail: (1)
</span><span class="c1"></span>	<span class="c1">//  network drops packet (2) caller has stale term (3) would leave gap in
</span><span class="c1"></span>	<span class="c1">//  the recipient&#39;s log (4) term of entry preceding the new entries doesn&#39;t
</span><span class="c1"></span>	<span class="c1">//  match the term at the same index on the recipient
</span><span class="c1"></span>	<span class="c1">// 
</span><span class="c1"></span>	<span class="c1">// 出现这种情况的原因可能是本地节点运行到committed逻辑的时候出现了问题，或者说应答给Leader时，网络出现了问题等等。
</span><span class="c1"></span>	<span class="c1">// 这些情况都会造成数据不同步的情况，也就是本地节点的commiitted情况和Leader节点保存的Follower(本地节点)不一致
</span><span class="c1"></span>	<span class="k">if</span> <span class="nx">r</span><span class="p">.</span><span class="nx">CommitIndex</span> <span class="p">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="nx">r</span><span class="p">.</span><span class="nx">CommitIndex</span> <span class="p">&gt;</span> <span class="nx">s</span><span class="p">.</span><span class="nx">log</span><span class="p">.</span><span class="nf">getCommitIndex</span><span class="p">()</span> <span class="p">{</span>
		<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">s</span><span class="p">.</span><span class="nx">log</span><span class="p">.</span><span class="nf">commitTo</span><span class="p">(</span><span class="nx">r</span><span class="p">.</span><span class="nx">CommitIndex</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
			<span class="k">return</span> <span class="nx">appendEntriesResponse</span><span class="p">{</span>
				<span class="nx">Term</span><span class="p">:</span>    <span class="nx">s</span><span class="p">.</span><span class="nx">term</span><span class="p">,</span>
				<span class="nx">Success</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
				<span class="nx">reason</span><span class="p">:</span>  <span class="nx">fmt</span><span class="p">.</span><span class="nf">Sprintf</span><span class="p">(</span><span class="s">&#34;CommitTo(%d) failed: %s&#34;</span><span class="p">,</span> <span class="nx">r</span><span class="p">.</span><span class="nx">CommitIndex</span><span class="p">,</span> <span class="nx">err</span><span class="p">),</span>
			<span class="p">},</span> <span class="nx">stepDown</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="c1">// all good
</span><span class="c1"></span>	<span class="k">return</span> <span class="nx">appendEntriesResponse</span><span class="p">{</span>
		<span class="nx">Term</span><span class="p">:</span>    <span class="nx">s</span><span class="p">.</span><span class="nx">term</span><span class="p">,</span>
		<span class="nx">Success</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
	<span class="p">},</span> <span class="nx">stepDown</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<h3 id="configuration-go">configuration.go</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span><span class="lnt">177
</span><span class="lnt">178
</span><span class="lnt">179
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="kd">var</span> <span class="p">(</span>
       	<span class="nx">errConfigurationAlreadyChanging</span> <span class="p">=</span> <span class="nx">errors</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span><span class="s">&#34;configuration already changing&#34;</span><span class="p">)</span>
<span class="p">)</span>

<span class="kd">const</span> <span class="p">(</span>
       	<span class="nx">cOld</span>    <span class="p">=</span> <span class="s">&#34;C_old&#34;</span>
       	<span class="nx">cOldNew</span> <span class="p">=</span> <span class="s">&#34;C_old,new&#34;</span>
<span class="p">)</span>

<span class="c1">// configuration represents the sets of peers and behaviors required to
</span><span class="c1">// implement joint-consensus.
</span><span class="c1"></span><span class="kd">type</span> <span class="nx">configuration</span> <span class="kd">struct</span> <span class="p">{</span>
       	<span class="nx">sync</span><span class="p">.</span><span class="nx">RWMutex</span>
       	<span class="nx">state</span>     <span class="kt">string</span>
       	<span class="c1">// 老配置
</span><span class="c1"></span>       	<span class="nx">cOldPeers</span> <span class="nx">peerMap</span>
       	<span class="c1">// 新配置-》用于过度
</span><span class="c1"></span>       	<span class="nx">cNewPeers</span> <span class="nx">peerMap</span>
<span class="p">}</span>

<span class="c1">// newConfiguration returns a new configuration in stable (C_old) state based
</span><span class="c1">// on the passed peers.
</span><span class="c1"></span><span class="kd">func</span> <span class="nf">newConfiguration</span><span class="p">(</span><span class="nx">pm</span> <span class="nx">peerMap</span><span class="p">)</span> <span class="o">*</span><span class="nx">configuration</span> <span class="p">{</span>
       	<span class="k">return</span> <span class="o">&amp;</span><span class="nx">configuration</span><span class="p">{</span>
       		<span class="nx">state</span><span class="p">:</span>     <span class="nx">cOld</span><span class="p">,</span> <span class="c1">// start in a stable state,
</span><span class="c1"></span>       		<span class="nx">cOldPeers</span><span class="p">:</span> <span class="nx">pm</span><span class="p">,</span>   <span class="c1">// with only C_old
</span><span class="c1"></span>       	<span class="p">}</span>
<span class="p">}</span>

<span class="c1">// directSet is used when bootstrapping, and when receiving a replicated
</span><span class="c1">// configuration from a leader. It directly sets the configuration to the
</span><span class="c1">// passed peers. It&#39;s assumed this is called on a non-leader, and therefore
</span><span class="c1">// requires no consistency dance.
</span><span class="c1">// 配置变更
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">configuration</span><span class="p">)</span> <span class="nf">directSet</span><span class="p">(</span><span class="nx">pm</span> <span class="nx">peerMap</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
       	<span class="nx">c</span><span class="p">.</span><span class="nf">Lock</span><span class="p">()</span>
       	<span class="k">defer</span> <span class="nx">c</span><span class="p">.</span><span class="nf">Unlock</span><span class="p">()</span>

       	<span class="nx">c</span><span class="p">.</span><span class="nx">cOldPeers</span> <span class="p">=</span> <span class="nx">pm</span>
       	<span class="nx">c</span><span class="p">.</span><span class="nx">cNewPeers</span> <span class="p">=</span> <span class="nx">peerMap</span><span class="p">{}</span>
       	<span class="nx">c</span><span class="p">.</span><span class="nx">state</span> <span class="p">=</span> <span class="nx">cOld</span>
       	<span class="k">return</span> <span class="kc">nil</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">configuration</span><span class="p">)</span> <span class="nf">get</span><span class="p">(</span><span class="nx">id</span> <span class="kt">uint64</span><span class="p">)</span> <span class="p">(</span><span class="nx">Peer</span><span class="p">,</span> <span class="kt">bool</span><span class="p">)</span> <span class="p">{</span>
       	<span class="nx">c</span><span class="p">.</span><span class="nf">RLock</span><span class="p">()</span>
       	<span class="k">defer</span> <span class="nx">c</span><span class="p">.</span><span class="nf">RUnlock</span><span class="p">()</span>

       	<span class="k">if</span> <span class="nx">peer</span><span class="p">,</span> <span class="nx">ok</span> <span class="o">:=</span> <span class="nx">c</span><span class="p">.</span><span class="nx">cOldPeers</span><span class="p">[</span><span class="nx">id</span><span class="p">];</span> <span class="nx">ok</span> <span class="p">{</span>
       		<span class="k">return</span> <span class="nx">peer</span><span class="p">,</span> <span class="kc">true</span>
       	<span class="p">}</span>
       	<span class="k">if</span> <span class="nx">peer</span><span class="p">,</span> <span class="nx">ok</span> <span class="o">:=</span> <span class="nx">c</span><span class="p">.</span><span class="nx">cNewPeers</span><span class="p">[</span><span class="nx">id</span><span class="p">];</span> <span class="nx">ok</span> <span class="p">{</span>
       		<span class="k">return</span> <span class="nx">peer</span><span class="p">,</span> <span class="kc">true</span>
       	<span class="p">}</span>
       	<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="kc">false</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">configuration</span><span class="p">)</span> <span class="nf">encode</span><span class="p">()</span> <span class="p">([]</span><span class="kt">byte</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
       	<span class="nx">buf</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">bytes</span><span class="p">.</span><span class="nx">Buffer</span><span class="p">{}</span>
       	<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">gob</span><span class="p">.</span><span class="nf">NewEncoder</span><span class="p">(</span><span class="nx">buf</span><span class="p">).</span><span class="nf">Encode</span><span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nf">allPeers</span><span class="p">());</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
       		<span class="k">return</span> <span class="p">[]</span><span class="kt">byte</span><span class="p">{},</span> <span class="nx">err</span>
       	<span class="p">}</span>
       	<span class="k">return</span> <span class="nx">buf</span><span class="p">.</span><span class="nf">Bytes</span><span class="p">(),</span> <span class="kc">nil</span>
<span class="p">}</span>

<span class="c1">// allPeers returns the union set of all peers in the configuration.
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">configuration</span><span class="p">)</span> <span class="nf">allPeers</span><span class="p">()</span> <span class="nx">peerMap</span> <span class="p">{</span>
       	<span class="nx">c</span><span class="p">.</span><span class="nf">RLock</span><span class="p">()</span>
       	<span class="k">defer</span> <span class="nx">c</span><span class="p">.</span><span class="nf">RUnlock</span><span class="p">()</span>

       	<span class="nx">union</span> <span class="o">:=</span> <span class="nx">peerMap</span><span class="p">{}</span>
       	<span class="k">for</span> <span class="nx">id</span><span class="p">,</span> <span class="nx">peer</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">c</span><span class="p">.</span><span class="nx">cOldPeers</span> <span class="p">{</span>
       		<span class="nx">union</span><span class="p">[</span><span class="nx">id</span><span class="p">]</span> <span class="p">=</span> <span class="nx">peer</span>
       	<span class="p">}</span>
       	<span class="k">for</span> <span class="nx">id</span><span class="p">,</span> <span class="nx">peer</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">c</span><span class="p">.</span><span class="nx">cNewPeers</span> <span class="p">{</span>
       		<span class="nx">union</span><span class="p">[</span><span class="nx">id</span><span class="p">]</span> <span class="p">=</span> <span class="nx">peer</span>
       	<span class="p">}</span>
       	<span class="k">return</span> <span class="nx">union</span>
<span class="p">}</span>

<span class="c1">// pass returns true if the votes represented by the votes map are sufficient
</span><span class="c1">// to constitute a quorum. pass respects C_old,new requirements, which dictate
</span><span class="c1">// that any request must receive a majority from both C_old and C_new to pass.
</span><span class="c1">// 共识判断
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">configuration</span><span class="p">)</span> <span class="nf">pass</span><span class="p">(</span><span class="nx">votes</span> <span class="kd">map</span><span class="p">[</span><span class="kt">uint64</span><span class="p">]</span><span class="kt">bool</span><span class="p">)</span> <span class="kt">bool</span> <span class="p">{</span>
       	<span class="nx">c</span><span class="p">.</span><span class="nf">RLock</span><span class="p">()</span>
       	<span class="k">defer</span> <span class="nx">c</span><span class="p">.</span><span class="nf">RUnlock</span><span class="p">()</span>

       	<span class="c1">// Count the votes
</span><span class="c1"></span>       	<span class="nx">cOldHave</span><span class="p">,</span> <span class="nx">cOldRequired</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">c</span><span class="p">.</span><span class="nx">cOldPeers</span><span class="p">.</span><span class="nf">quorum</span><span class="p">()</span>
       	<span class="k">for</span> <span class="nx">id</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">c</span><span class="p">.</span><span class="nx">cOldPeers</span> <span class="p">{</span>
       		<span class="k">if</span> <span class="nx">votes</span><span class="p">[</span><span class="nx">id</span><span class="p">]</span> <span class="p">{</span>
       			<span class="nx">cOldHave</span><span class="o">++</span>
       		<span class="p">}</span>
       		<span class="k">if</span> <span class="nx">cOldHave</span> <span class="o">&gt;=</span> <span class="nx">cOldRequired</span> <span class="p">{</span>
       			<span class="k">break</span>
       		<span class="p">}</span>
       	<span class="p">}</span>

       	<span class="c1">// If we&#39;ve already failed, we can stop here
</span><span class="c1"></span>       	<span class="k">if</span> <span class="nx">cOldHave</span> <span class="p">&lt;</span> <span class="nx">cOldRequired</span> <span class="p">{</span>
       		<span class="k">return</span> <span class="kc">false</span>
       	<span class="p">}</span>

       	<span class="c1">// C_old passes: if we&#39;re in C_old, we pass
</span><span class="c1"></span>       	<span class="k">if</span> <span class="nx">c</span><span class="p">.</span><span class="nx">state</span> <span class="o">==</span> <span class="nx">cOld</span> <span class="p">{</span>
       		<span class="k">return</span> <span class="kc">true</span>
       	<span class="p">}</span>

       	<span class="c1">// Not in C_old, so make sure we have some peers in C_new
</span><span class="c1"></span>       	<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">cNewPeers</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="p">{</span>
       		<span class="nb">panic</span><span class="p">(</span><span class="nx">fmt</span><span class="p">.</span><span class="nf">Sprintf</span><span class="p">(</span><span class="s">&#34;configuration state &#39;%s&#39;, but no C_new peers&#34;</span><span class="p">,</span> <span class="nx">c</span><span class="p">.</span><span class="nx">state</span><span class="p">))</span>
       	<span class="p">}</span>

       	<span class="c1">// Since we&#39;re in C_old,new, we need to also pass C_new to pass overall.
</span><span class="c1"></span>       	<span class="c1">// It&#39;s important that we range through C_new and check our votes map, and
</span><span class="c1"></span>       	<span class="c1">// not the other way around: if a server casts a vote but doesn&#39;t exist in
</span><span class="c1"></span>       	<span class="c1">// a particular configuration, that vote should not be counted.
</span><span class="c1"></span>       	<span class="nx">cNewHave</span><span class="p">,</span> <span class="nx">cNewRequired</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">c</span><span class="p">.</span><span class="nx">cNewPeers</span><span class="p">.</span><span class="nf">quorum</span><span class="p">()</span>
       	<span class="k">for</span> <span class="nx">id</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">c</span><span class="p">.</span><span class="nx">cNewPeers</span> <span class="p">{</span>
       		<span class="k">if</span> <span class="nx">votes</span><span class="p">[</span><span class="nx">id</span><span class="p">]</span> <span class="p">{</span>
       			<span class="nx">cNewHave</span><span class="o">++</span>
       		<span class="p">}</span>
       		<span class="k">if</span> <span class="nx">cNewHave</span> <span class="o">&gt;=</span> <span class="nx">cNewRequired</span> <span class="p">{</span>
       			<span class="k">break</span>
       		<span class="p">}</span>
       	<span class="p">}</span>

       	<span class="k">return</span> <span class="nx">cNewHave</span> <span class="o">&gt;=</span> <span class="nx">cNewRequired</span>
<span class="p">}</span>

<span class="c1">// 配置变更准备, prepare-change
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">configuration</span><span class="p">)</span> <span class="nf">changeTo</span><span class="p">(</span><span class="nx">pm</span> <span class="nx">peerMap</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
       	<span class="nx">c</span><span class="p">.</span><span class="nf">Lock</span><span class="p">()</span>
       	<span class="k">defer</span> <span class="nx">c</span><span class="p">.</span><span class="nf">Unlock</span><span class="p">()</span>

       	<span class="k">if</span> <span class="nx">c</span><span class="p">.</span><span class="nx">state</span> <span class="o">!=</span> <span class="nx">cOld</span> <span class="p">{</span>
       		<span class="k">return</span> <span class="nx">errConfigurationAlreadyChanging</span>
       	<span class="p">}</span>

       	<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">cNewPeers</span><span class="p">)</span> <span class="p">&gt;</span> <span class="mi">0</span> <span class="p">{</span>
       		<span class="nb">panic</span><span class="p">(</span><span class="nx">fmt</span><span class="p">.</span><span class="nf">Sprintf</span><span class="p">(</span><span class="s">&#34;configuration ChangeTo in state &#39;%s&#39;, but have C_new peers already&#34;</span><span class="p">,</span> <span class="nx">c</span><span class="p">.</span><span class="nx">state</span><span class="p">))</span>
       	<span class="p">}</span>

       	<span class="nx">c</span><span class="p">.</span><span class="nx">cNewPeers</span> <span class="p">=</span> <span class="nx">pm</span>
       	<span class="nx">c</span><span class="p">.</span><span class="nx">state</span> <span class="p">=</span> <span class="nx">cOldNew</span>
       	<span class="k">return</span> <span class="kc">nil</span>
<span class="p">}</span>

<span class="c1">// 提交变更逻辑
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">configuration</span><span class="p">)</span> <span class="nf">changeCommitted</span><span class="p">()</span> <span class="p">{</span>
       	<span class="nx">c</span><span class="p">.</span><span class="nf">Lock</span><span class="p">()</span>
       	<span class="k">defer</span> <span class="nx">c</span><span class="p">.</span><span class="nf">Unlock</span><span class="p">()</span>

       	<span class="k">if</span> <span class="nx">c</span><span class="p">.</span><span class="nx">state</span> <span class="o">!=</span> <span class="nx">cOldNew</span> <span class="p">{</span>
       		<span class="nb">panic</span><span class="p">(</span><span class="s">&#34;configuration ChangeCommitted, but not in C_old,new&#34;</span><span class="p">)</span>
       	<span class="p">}</span>

       	<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">cNewPeers</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="p">{</span>
       		<span class="nb">panic</span><span class="p">(</span><span class="s">&#34;configuration ChangeCommitted, but C_new peers are empty&#34;</span><span class="p">)</span>
       	<span class="p">}</span>

       	<span class="nx">c</span><span class="p">.</span><span class="nx">cOldPeers</span> <span class="p">=</span> <span class="nx">c</span><span class="p">.</span><span class="nx">cNewPeers</span>
       	<span class="nx">c</span><span class="p">.</span><span class="nx">cNewPeers</span> <span class="p">=</span> <span class="nx">peerMap</span><span class="p">{}</span>
       	<span class="nx">c</span><span class="p">.</span><span class="nx">state</span> <span class="p">=</span> <span class="nx">cOld</span>
<span class="p">}</span>

<span class="c1">// 中断变更
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">configuration</span><span class="p">)</span> <span class="nf">changeAborted</span><span class="p">()</span> <span class="p">{</span>
       	<span class="nx">c</span><span class="p">.</span><span class="nf">Lock</span><span class="p">()</span>
       	<span class="k">defer</span> <span class="nx">c</span><span class="p">.</span><span class="nf">Unlock</span><span class="p">()</span>

       	<span class="k">if</span> <span class="nx">c</span><span class="p">.</span><span class="nx">state</span> <span class="o">!=</span> <span class="nx">cOldNew</span> <span class="p">{</span>
       		<span class="nb">panic</span><span class="p">(</span><span class="s">&#34;configuration ChangeAborted, but not in C_old,new&#34;</span><span class="p">)</span>
       	<span class="p">}</span>

       	<span class="nx">c</span><span class="p">.</span><span class="nx">cNewPeers</span> <span class="p">=</span> <span class="nx">peerMap</span><span class="p">{}</span>
       	<span class="nx">c</span><span class="p">.</span><span class="nx">state</span> <span class="p">=</span> <span class="nx">cOld</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<h1 id="demo">Demo</h1>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="kn">package</span> <span class="nx">main</span>

<span class="kn">import</span> <span class="p">(</span>
       	<span class="s">&#34;bytes&#34;</span>
       	<span class="s">&#34;fmt&#34;</span>
       	<span class="s">&#34;hash/fnv&#34;</span>
       	<span class="s">&#34;net/http&#34;</span>
       	<span class="s">&#34;net/url&#34;</span>
       	<span class="s">&#34;time&#34;</span>

       	<span class="s">&#34;github.com/peterbourgon/raft&#34;</span>
<span class="p">)</span>

<span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
       	<span class="nx">a</span> <span class="o">:=</span> <span class="kd">func</span><span class="p">(</span><span class="nx">idx</span> <span class="kt">uint64</span><span class="p">,</span> <span class="nx">cmd</span> <span class="p">[]</span><span class="kt">byte</span><span class="p">)</span> <span class="p">[]</span><span class="kt">byte</span> <span class="p">{</span>
       		<span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;%d, apply function: %s\n&#34;</span><span class="p">,</span> <span class="nx">idx</span><span class="p">,</span> <span class="nx">cmd</span><span class="p">)</span>
       		<span class="k">return</span> <span class="nx">cmd</span>
       	<span class="p">}</span>

       	<span class="nx">mustParseURL</span> <span class="o">:=</span> <span class="kd">func</span><span class="p">(</span><span class="nx">rawURL</span> <span class="kt">string</span><span class="p">)</span> <span class="o">*</span><span class="nx">url</span><span class="p">.</span><span class="nx">URL</span> <span class="p">{</span>
       		<span class="nx">u</span><span class="p">,</span> <span class="nx">_</span> <span class="o">:=</span> <span class="nx">url</span><span class="p">.</span><span class="nf">Parse</span><span class="p">(</span><span class="nx">rawURL</span><span class="p">)</span>
       		<span class="nx">u</span><span class="p">.</span><span class="nx">Path</span> <span class="p">=</span> <span class="s">&#34;&#34;</span>
       		<span class="k">return</span> <span class="nx">u</span>
       	<span class="p">}</span>
       	<span class="nx">mustNewHTTPPeer</span> <span class="o">:=</span> <span class="kd">func</span><span class="p">(</span><span class="nx">u</span> <span class="o">*</span><span class="nx">url</span><span class="p">.</span><span class="nx">URL</span><span class="p">)</span> <span class="nx">raft</span><span class="p">.</span><span class="nx">Peer</span> <span class="p">{</span>
       		<span class="nx">p</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">raft</span><span class="p">.</span><span class="nf">NewHTTPPeer</span><span class="p">(</span><span class="nx">u</span><span class="p">)</span>
       		<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
       			<span class="nb">panic</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
       		<span class="p">}</span>
       		<span class="k">return</span> <span class="nx">p</span>
       	<span class="p">}</span>
       	<span class="nx">peersAddr</span> <span class="o">:=</span> <span class="p">[]</span><span class="kt">string</span><span class="p">{</span>
       		<span class="s">&#34;127.0.0.1:7090&#34;</span><span class="p">,</span>
       		<span class="s">&#34;127.0.0.1:7091&#34;</span><span class="p">,</span>
       		<span class="s">&#34;127.0.0.1:7092&#34;</span><span class="p">,</span>
       		<span class="s">&#34;127.0.0.1:7093&#34;</span><span class="p">,</span>
       		<span class="s">&#34;127.0.0.1:7094&#34;</span><span class="p">}</span>
       	<span class="kd">var</span> <span class="nx">ss</span> <span class="p">[]</span><span class="o">*</span><span class="nx">raft</span><span class="p">.</span><span class="nx">Server</span>
       	<span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">addr</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">peersAddr</span> <span class="p">{</span>
       		<span class="nx">hash</span> <span class="o">:=</span> <span class="nx">fnv</span><span class="p">.</span><span class="nf">New64</span><span class="p">()</span>
       		<span class="nx">hash</span><span class="p">.</span><span class="nf">Write</span><span class="p">([]</span><span class="nb">byte</span><span class="p">(</span><span class="nx">addr</span><span class="p">))</span>
       		<span class="nx">id</span> <span class="o">:=</span> <span class="nx">hash</span><span class="p">.</span><span class="nf">Sum64</span><span class="p">()</span>
       		<span class="nx">hash</span><span class="p">.</span><span class="nf">Reset</span><span class="p">()</span>
       		<span class="nx">s</span> <span class="o">:=</span> <span class="nx">raft</span><span class="p">.</span><span class="nf">NewServer</span><span class="p">(</span><span class="nx">id</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">bytes</span><span class="p">.</span><span class="nx">Buffer</span><span class="p">{},</span> <span class="nx">a</span><span class="p">)</span>
       		<span class="nx">mux</span> <span class="o">:=</span> <span class="nx">http</span><span class="p">.</span><span class="nf">NewServeMux</span><span class="p">()</span>
       		<span class="nx">raft</span><span class="p">.</span><span class="nf">HTTPTransport</span><span class="p">(</span><span class="nx">mux</span><span class="p">,</span> <span class="nx">s</span><span class="p">)</span>
       		<span class="k">go</span> <span class="kd">func</span><span class="p">(</span><span class="nx">addr</span> <span class="kt">string</span><span class="p">)</span> <span class="p">{</span>
       			<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">http</span><span class="p">.</span><span class="nf">ListenAndServe</span><span class="p">(</span><span class="nx">addr</span><span class="p">,</span> <span class="nx">mux</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
       				<span class="nb">panic</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
       			<span class="p">}</span>
       		<span class="p">}(</span><span class="nx">addr</span><span class="p">)</span>
       		<span class="nx">ss</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">ss</span><span class="p">,</span> <span class="nx">s</span><span class="p">)</span>
       	<span class="p">}</span>
       	<span class="nx">time</span><span class="p">.</span><span class="nf">Sleep</span><span class="p">(</span><span class="nx">time</span><span class="p">.</span><span class="nx">Second</span><span class="p">)</span>
       	<span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">s</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">ss</span> <span class="p">{</span>
       		<span class="nx">s</span><span class="p">.</span><span class="nf">SetConfiguration</span><span class="p">(</span>
       			<span class="nf">mustNewHTTPPeer</span><span class="p">(</span><span class="nf">mustParseURL</span><span class="p">(</span><span class="s">&#34;http://127.0.0.1:7090&#34;</span><span class="p">)),</span>
       			<span class="nf">mustNewHTTPPeer</span><span class="p">(</span><span class="nf">mustParseURL</span><span class="p">(</span><span class="s">&#34;http://127.0.0.1:7091&#34;</span><span class="p">)),</span>
       			<span class="nf">mustNewHTTPPeer</span><span class="p">(</span><span class="nf">mustParseURL</span><span class="p">(</span><span class="s">&#34;http://127.0.0.1:7092&#34;</span><span class="p">)),</span>
       			<span class="nf">mustNewHTTPPeer</span><span class="p">(</span><span class="nf">mustParseURL</span><span class="p">(</span><span class="s">&#34;http://127.0.0.1:7093&#34;</span><span class="p">)),</span>
       			<span class="nf">mustNewHTTPPeer</span><span class="p">(</span><span class="nf">mustParseURL</span><span class="p">(</span><span class="s">&#34;http://127.0.0.1:7094&#34;</span><span class="p">)),</span>
       		<span class="p">)</span>
       		<span class="nx">s</span><span class="p">.</span><span class="nf">Start</span><span class="p">()</span>
       	<span class="p">}</span>

       	<span class="k">for</span> <span class="p">{</span>
       		<span class="nx">cmd</span> <span class="o">:=</span> <span class="p">[]</span><span class="nb">byte</span><span class="p">(</span><span class="nx">time</span><span class="p">.</span><span class="nf">Now</span><span class="p">().</span><span class="nf">String</span><span class="p">())</span>
       		<span class="nx">cmdChan</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">(</span><span class="kd">chan</span> <span class="p">[]</span><span class="kt">byte</span><span class="p">)</span>
       		<span class="k">go</span> <span class="nx">ss</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nf">Command</span><span class="p">(</span><span class="nx">cmd</span><span class="p">,</span> <span class="nx">cmdChan</span><span class="p">)</span>
       		<span class="o">&lt;-</span><span class="nx">cmdChan</span>
       		<span class="nx">time</span><span class="p">.</span><span class="nf">Sleep</span><span class="p">(</span><span class="nx">time</span><span class="p">.</span><span class="nx">Millisecond</span> <span class="o">*</span> <span class="mi">500</span><span class="p">)</span>
       	<span class="p">}</span>

       	<span class="nx">time</span><span class="p">.</span><span class="nf">Sleep</span><span class="p">(</span><span class="nx">time</span><span class="p">.</span><span class="nx">Hour</span><span class="p">)</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<p><em>Run</em></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-sh" data-lang="sh"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-sh" data-lang="sh">» go run raft-server.go <span class="m">2</span>&gt;/dev/null     
<span class="m">1</span>, apply <span class="k">function</span>: <span class="m">2017</span>-09-11 <span class="m">11</span>:41:13.668460404 +0800 CST
<span class="m">1</span>, apply <span class="k">function</span>: <span class="m">2017</span>-09-11 <span class="m">11</span>:41:13.668460404 +0800 CST
<span class="m">1</span>, apply <span class="k">function</span>: <span class="m">2017</span>-09-11 <span class="m">11</span>:41:13.668460404 +0800 CST
<span class="m">1</span>, apply <span class="k">function</span>: <span class="m">2017</span>-09-11 <span class="m">11</span>:41:13.668460404 +0800 CST
<span class="m">1</span>, apply <span class="k">function</span>: <span class="m">2017</span>-09-11 <span class="m">11</span>:41:13.668460404 +0800 CST
<span class="m">2</span>, apply <span class="k">function</span>: <span class="m">2017</span>-09-11 <span class="m">11</span>:41:14.169165702 +0800 CST
<span class="m">2</span>, apply <span class="k">function</span>: <span class="m">2017</span>-09-11 <span class="m">11</span>:41:14.169165702 +0800 CST
<span class="m">2</span>, apply <span class="k">function</span>: <span class="m">2017</span>-09-11 <span class="m">11</span>:41:14.169165702 +0800 CST
<span class="m">2</span>, apply <span class="k">function</span>: <span class="m">2017</span>-09-11 <span class="m">11</span>:41:14.169165702 +0800 CST
<span class="m">2</span>, apply <span class="k">function</span>: <span class="m">2017</span>-09-11 <span class="m">11</span>:41:14.169165702 +0800 CST
<span class="m">3</span>, apply <span class="k">function</span>: <span class="m">2017</span>-09-11 <span class="m">11</span>:41:14.670873193 +0800 CST
<span class="m">3</span>, apply <span class="k">function</span>: <span class="m">2017</span>-09-11 <span class="m">11</span>:41:14.670873193 +0800 CST
<span class="m">3</span>, apply <span class="k">function</span>: <span class="m">2017</span>-09-11 <span class="m">11</span>:41:14.670873193 +0800 CST
<span class="m">3</span>, apply <span class="k">function</span>: <span class="m">2017</span>-09-11 <span class="m">11</span>:41:14.670873193 +0800 CST
<span class="m">3</span>, apply <span class="k">function</span>: <span class="m">2017</span>-09-11 <span class="m">11</span>:41:14.670873193 +0800 CST
<span class="m">4</span>, apply <span class="k">function</span>: <span class="m">2017</span>-09-11 <span class="m">11</span>:41:15.171741805 +0800 CST
<span class="m">4</span>, apply <span class="k">function</span>: <span class="m">2017</span>-09-11 <span class="m">11</span>:41:15.171741805 +0800 CST
<span class="m">4</span>, apply <span class="k">function</span>: <span class="m">2017</span>-09-11 <span class="m">11</span>:41:15.171741805 +0800 CST
<span class="m">4</span>, apply <span class="k">function</span>: <span class="m">2017</span>-09-11 <span class="m">11</span>:41:15.171741805 +0800 CST
<span class="m">4</span>, apply <span class="k">function</span>: <span class="m">2017</span>-09-11 <span class="m">11</span>:41:15.171741805 +0800 CST
<span class="m">5</span>, apply <span class="k">function</span>: <span class="m">2017</span>-09-11 <span class="m">11</span>:41:15.673498401 +0800 CST
<span class="m">5</span>, apply <span class="k">function</span>: <span class="m">2017</span>-09-11 <span class="m">11</span>:41:15.673498401 +0800 CST
<span class="m">5</span>, apply <span class="k">function</span>: <span class="m">2017</span>-09-11 <span class="m">11</span>:41:15.673498401 +0800 CST
<span class="m">5</span>, apply <span class="k">function</span>: <span class="m">2017</span>-09-11 <span class="m">11</span>:41:15.673498401 +0800 CST
<span class="m">5</span>, apply <span class="k">function</span>: <span class="m">2017</span>-09-11 <span class="m">11</span>:41:15.673498401 +0800 CST
<span class="m">6</span>, apply <span class="k">function</span>: <span class="m">2017</span>-09-11 <span class="m">11</span>:41:16.175658603 +0800 CST
<span class="m">6</span>, apply <span class="k">function</span>: <span class="m">2017</span>-09-11 <span class="m">11</span>:41:16.175658603 +0800 CST
<span class="m">6</span>, apply <span class="k">function</span>: <span class="m">2017</span>-09-11 <span class="m">11</span>:41:16.175658603 +0800 CST
<span class="m">6</span>, apply <span class="k">function</span>: <span class="m">2017</span>-09-11 <span class="m">11</span>:41:16.175658603 +0800 CST
<span class="m">6</span>, apply <span class="k">function</span>: <span class="m">2017</span>-09-11 <span class="m">11</span>:41:16.175658603 +0800 CST
<span class="m">7</span>, apply <span class="k">function</span>: <span class="m">2017</span>-09-11 <span class="m">11</span>:41:16.677758823 +0800 CST</code></pre></td></tr></table>
</div>
</div>
    </div>

    <div class="post-copyright">
  <p class="copyright-item">
    <span class="item-title">Author</span>
    <span class="item-content">Rg</span>
  </p>
  <p class="copyright-item">
    <span class="item-title">LastMod</span>
    <span class="item-content">
        2017-09-11
        
    </span>
  </p>
  
  
</div>
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/raft/">raft</a>
          <a href="/tags/raft-source-analyse/">raft source analyse</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/2019/03/03/go%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">go内存管理</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        <a class="next" href="/2017/03/12/200%E8%A1%8C%E5%8C%BA%E5%9D%97/">
            <span class="next-text nav-default">200行区块链</span>
            <span class="next-text nav-mobile">Next</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        <div id="gitalk-container"></div>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js" crossorigin="anonymous"></script>
    <script type="text/javascript">
      var gitalk = new Gitalk({
        id: '2017-09-11 12:08:30 \x2b0000 UTC',
        title: 'raft源码分析',
        clientID: '88e50f263d090b13460f',
        clientSecret: 'f1007eb6cff0af3b461be3a4b73d808ab7058a21',
        repo: 'blog',
        owner: 'laohanlinux',
        admin: ['laohanlinux'],
        body: decodeURI(location.href)
      });
      gitalk.render('gitalk-container');
    </script>
    <noscript>Please enable JavaScript to view the <a href="https://github.com/gitalk/gitalk">comments powered by gitalk.</a></noscript>

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
      <a href="mailto:daimaldd@email.com" class="iconfont icon-email" title="email"></a>
      <a href="https://github.com/laohanlinux" class="iconfont icon-github" title="github"></a>
  <a href="https://laohanlinux.github.io/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2014 - 
    2019
    <span class="heart">
      <i class="iconfont icon-heart"></i>
    </span>
    <span class="author">Rg</span>
  </span>
</div>
    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script>
<script type="text/javascript" src="/dist/even.26188efa.min.js"></script>








</body>
</html>
